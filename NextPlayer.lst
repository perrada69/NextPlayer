# file opened: NextPlayer.asm
    1 0000
    2 0000                            DEVICE ZXSPECTRUMNEXT
    3 0000              			  ;OPT reset --zxnext --syntax=abfw
    4 0000                            slot 3
    5 0000
    6 0000                            org #6000
    7 6000              CHARS         equ  15616-256
    8 6000              mystak        equ  24575         ;ar bi trary value picked to be be low
    9 6000                                              ;BFE0h and above 4000h
   10 6000              staksto       equ  24575         ;some where to put BA SIC's stack
   11 6000                                              ;pointer
   12 6000              bankm         equ  #5B5C         ;sys tem vari able that holds the
   13 6000                                              ;last value out put to 7FFDh
   14 6000              port1         equ  #7FFD         ;ad dress of ROM/RAM switch ing port
   15 6000                                              ;in I/O map
   16 6000              catbuff       equ  #8000         ;some where for DOS to put its catalog
   17 6000              dos_catalog   equ  #011E         ;the DOS routine to call
   18 6000 00 00 00...  filename 	  ds   15
   19 600F              typ 		  equ $-4
   20 600F              pocetpolozek	equ 231
   21 600F 00           virtmem			defb 0
   22 6010              maxlen			equ 128
   23 6010              maxline 		equ 37
   24 6010 00 00        save_allfiles	defw 0
   25 6012
   26 6012              ReadNextReg:
   27 6012                  ; reads nextreg in A into A (does modify currently selected NextReg on I/O port)
   28 6012 C5               push    bc
   29 6013 01 3B 24         ld      bc,#243B
   30 6016 ED 79            out     (c),a
   31 6018 04               inc     b       ; bc = TBBLUE_REGISTER_ACCESS_P_253B
   32 6019 ED 78            in      a,(c)   ; read desired NextReg state
   33 601B C1               pop     bc
   34 601C C9               ret
   35 601D
   36 601D FB           INPUT 	ei
   37 601E 22 37 60     		ld (INPOS+1),hl ;ulož adresu začátku pro další použití
   38 6021 21 00 5B     		ld hl,23296 ;do HL adresa editační oblasti
   39 6024 DD 44        		ld b,hx ;do B délka editační oblasti
   40 6026 36 20        IN1 	ld (hl),32 ;a nyní celou editační
   41 6028 23           		inc hl ;zónu vyplníme mezerami
   42 6029 10 FB        		djnz IN1 ;na konec editační zóny
   43 602B 70           		ld (hl),b ;přijde 0
   44 602C FD CB 01 AE  		res 5,(iy+1) ;signál není stisknuta klávesa
   45 6030 AF           		xor a ;nastav kurzor
   46 6031 32 40 60     		ld (CURSOR+1),a ;na začátek editační zóny
   47 6034 DD 44        IN2 	ld b,hx ;nyní celou editační zónu
   48 6036 21 00 00     INPOS 	ld hl,0 ;vytiskneme, nastav
   49 6039 22 12 61     		ld (PPOS+1),hl ;tiskovou pozici
   50 603C 21 00 5B     		ld hl,23296 ;začínáme od začátku
   51 603F 0E 00        CURSOR 	ld c,0 ;do C polohu kurzoru
   52 6041 7D           IN3 	ld a,l ;testuj spodní byte adresy
   53 6042 B9           		cp c ;v případe rovnosti
   54 6043 3E 3E        		ld a,">" ;dej do A kód kurzoru
   55 6045 CC 08 61     		call z,CHAR ;a vytiskni ho
   56 6048 7E           		ld a,(hl) ;vytiskni znak
   57 6049 CD 08 61     		call CHAR ;z editační zóny
   58 604C 23           		inc hl ;a posun se pro další
   59 604D 10 F2        		djnz IN3 ;opakuj se všemi znaky
   60 604F 7D           		ld a,l ;kurzor také může
   61 6050 B9           		cp c ;být až za posledním
   62 6051 3E BC        		ld a,"<"+128 ;znakem, pak bude
   63 6053 CC 08 61     		call z,CHAR ;na řádku vypadat jinak
   64 6056 CD B7 60     		call INKEY ;přečti si kód klávesy
   65 6059 FE 07        		cp 7 ;testuj EDIT (Caps Shift + 1)
   66 605B C8           		ret z ;a případně se vrať zpátky
   67 605C FE 0D        		cp 13 ;testuj ENTER a případné odskoč
   68 605E C8           		ret z  ;jp z,INPCLEAR ;na smazání řádku z obrazovky
   69 605F
   70 605F 21 34 60     		ld hl,IN2 ;na zásobník ulož adresu IN2, sem
   71 6062 E5           		push hl ;se bude nyní program vracet
   72 6063 21 40 60     		ld hl,CURSOR+1 ;do HL vlož adresu pozice kurzoru
   73 6066 FE 08        		cp 8 ;testuj kurzor doleva
   74 6068 28 24        		jr z,CURSLEFT ;odskoč
   75 606A FE 09        		cp 9 ;kurzor doprava
   76 606C 28 25        		jr z,CURSRGHT
   77 606E FE 0C        		cp 12 ;delete (správně BACKSPACE)
   78 6070 28 2E        		jr z,BCKSPACE
   79 6072 FE C7        		cp 199 ;znak <= (funkce DELETE)
   80 6074 28 23        		jr z,DELETE
   81 6076 FE 20        		cp 32 ;nyní zbývají
   82 6078 D8           		ret c ;obyčejné znaky,
   83 6079 FE 80        		cp 128 ;odfiltruj
   84 607B D0           		ret nc ;netisknutelné znaky
   85 607C 08           		ex af,af' ;a kód přesuň do A'
   86 607D 7E           		ld a,(hl) ;testuj, zda není kurzor
   87 607E DD BC        		cp hx ;na konci řádku,
   88 6080 D0           		ret nc ;když ano, tak se vrať
   89 6081 34           		inc (hl) ;posuň kurzor doprava
   90 6082 6E           		ld l,(hl) ;do HL vlož adresu,
   91 6083 2D           		dec l ;na kterou bude znak
   92 6084 26 5B        		ld h,23296/256 ;uložen
   93 6086 7E           INS 	ld a,(hl) ;přečti původní znak
   94 6087 B7           		or a ;a testuj konec řádku
   95 6088 C8           		ret z ;případně se vrať
   96 6089 08           		ex af,af' ;přehoď původní a nový znak
   97 608A 77           		ld (hl),a ;a nový zapiš, pro další znak
   98 608B 23           		inc hl ;bude novým znakem předchozí
   99 608C 18 F8        		jr INS ;znak, opakuj posun znaku až do konce
  100 608E 7E           CURSLEFT ld a,(hl) ;přečti polohu kurzoru
  101 608F B7           		or a ;a v případe, že je na levém okraji
  102 6090 C8           		ret z ;tak se vrať a nic nedělej
  103 6091 35           		dec (hl) ;posuň kurzor doleva a vrať se na IN2
  104 6092 C9           		ret
  105 6093 7E           CURSRGHT ld a,(hl) ;přečti polohu kurzoru
  106 6094 DD BC        		cp hx ;a když je na konci řádku
  107 6096 D0           		ret nc ;tak se vrať
  108 6097 34           		inc (hl) ;jinak posuň kurzor doprava a vrať se
  109 6098 C9           		ret ;vrať se na IN2
  110 6099 7E           DELETE 	ld a,(hl) ;na konci
  111 609A DD BC        		cp hx ;editační zóny
  112 609C C8           		ret z ;DELETE nepracuje
  113 609D 3C           		inc a ;jinak uprav polohu
  114 609E 18 04        		jr BCK2 ;a pokračuj společnou částí
  115 60A0 7E           BCKSPACE ld a,(hl) ;BACKSPACE naopak
  116 60A1 B7           		or a ;nepracuje na začátku
  117 60A2 C8           		ret z ;editační zóny
  118 60A3 35           		dec (hl) ;posuň kurzor vlevo
  119 60A4 6F           BCK2 	ld l,a ;společná část,
  120 60A5 26 5B        		ld h,23296/256 ;která zajišťuje
  121 60A7 5D           		ld e,l ;přesunutí následujících
  122 60A8 54           		ld d,h ;znaků na uvolněné místo
  123 60A9 1D           		dec e ;po smazaném znaku
  124 60AA
  125 60AA 7E           DEL2 	ld a,(hl) ;vlastní přesun
  126 60AB ED A0        		ldi ;je prováděn instrukcí
  127 60AD B7           		or a ;LDI dokud není přenesena 0,
  128 60AE 20 FA        		jr nz,DEL2 ;která signalizuje konec zóny
  129 60B0 EB           		ex de,hl ;na poslední pozici,
  130 60B1 2B           		dec hl ;která se nyní uvolnila,
  131 60B2 36 20        		ld (hl)," " ;je zapsána mezera
  132 60B4 C9           		ret ;návrat na IN2
  133 60B5 00 00        delka_souboru	defw 0
  134 60B7 76           INKEY 	halt
  135 60B8 AF           		xor  a
  136 60B9 32 DF 60              ld   (aLAST_KEY+1),a
  137 60BC FB           		ei
  138 60BD 76           		 halt
  139 60BE
  140 60BE              ahl0
  141 60BE CD 6F 74     		 call KEYSCAN
  142 60C1
  143 60C1 7B           		 ld   a,e
  144 60C2 3C                    inc  a
  145 60C3 28 F2                 jr   z,INKEY
  146 60C5 7A                    ld   a,d
  147 60C6 21 A0 74              ld   hl,SYMTAB
  148 60C9 FE 18                 cp   $18
  149 60CB 28 0A                 jr   z,aHLSM2
  150 60CD 21 C8 74              ld   hl,CAPSTAB
  151 60D0 FE 27                 cp   $27
  152 60D2 28 03                 jr   z,aHLSM2
  153 60D4 21 EF 74              ld   hl,NORMTAB
  154 60D7 16 00        aHLSM2    ld   d,0
  155 60D9 19                    add  hl,de
  156 60DA 7E                    ld   a,(hl)
  157 60DB B7                    or   a
  158 60DC 28 D9                 jr   z,INKEY
  159 60DE
  160 60DE 06 00        aLAST_KEY ld   b,0
  161 60E0 B8                    cp   b
  162 60E1 28 05                 jr   z,aSEDI_KEY
  163 60E3
  164 60E3 06 03                 ld   b,3
  165 60E5 76           aLOOP_LST halt
  166 60E6 10 FD                 djnz aLOOP_LST
  167 60E8              aSEDI_KEY
  168 60E8 32 DF 60              ld   (aLAST_KEY+1),a
  169 60EB F5           		push af
  170 60EC CD 17 75     		call beepk
  171 60EF F1           		pop af
  172 60F0 C9           		ret
  173 60F1
  174 60F1 ED 5B 37 60  INPCLEAR ld de,(INPOS+1) ;do DE pixelová pozice
  175 60F5 0E 08        		ld c,8 ;16 pixelových řádků na výšku
  176 60F7 DD 44        INPC2 	ld b,hx ;do B délka řádku
  177 60F9 04           		inc b ;plus 1 za kurzor
  178 60FA AF           		xor a ;vynuluj A
  179 60FB D5           		push de ;ulož adresu začátku řádku
  180 60FC 12           INPC3 	ld (de),a ;vymaž byty
  181 60FD 13           		inc de ;v pixelovém
  182 60FE 10 FC        		djnz INPC3 ;řádku
  183 6100 D1           		pop de ;obnov adresu počátku
  184 6101
  185 6101 CD B8 7A     		call DOWNDE ;a posuň se na další řádek
  186 6104 0D           		dec c ;odečti jedničku
  187 6105 20 F0        		jr nz,INPC2 ;a zbývají-li řádky, opakuj
  188 6107 C9           		ret
  189 6108
  190 6108 D9           CHAR 	exx
  191 6109 87           		add a,a
  192 610A 6F           		ld l,a
  193 610B 9F           		sbc a,a
  194 610C 4F           		ld c,a
  195 610D 26 0F        		ld h,15
  196 610F 29           		add hl,hl
  197 6110 29           		add hl,hl
  198 6111 11 00 40     PPOS 	ld de,16384
  199 6114 D5           		push de
  200 6115 06 08        		ld b,8
  201 6117 7E           CHAR2 	ld a,(hl)
  202 6118              		;rrca
  203 6118 B6           		or (hl)
  204 6119 A9           		xor c
  205 611A 12           		ld (de),a
  206 611B CD B8 7A     		call DOWNDE
  207 611E 23           		inc hl
  208 611F 10 F6        		djnz CHAR2
  209 6121 D1           		pop de
  210 6122 1C           		inc e
  211 6123 7B           		ld a,e
  212 6124 E6 1F        		and 31
  213 6126 20 0C        		jr nz,CHAR3
  214 6128 1D           		dec e
  215 6129 7B           		ld a,e ; posun na další tiskovou pozici
  216 612A E6 E0        		and %11100000
  217 612C 5F           		ld e,a
  218 612D 06 10        		ld b,16
  219 612F CD B8 7A     CHAR4 	call DOWNDE
  220 6132 10 FB        		djnz CHAR4
  221 6134 ED 53 12 61  CHAR3 	ld (PPOS+1),de
  222 6138 D9           		exx
  223 6139 C9           		ret
  224 613A
  225 613A              ; DE .... vstup hledaneho retezce
  226 613A              ; HL .... vstup textu,kde budeme hledat
  227 613A              ; Výstup:
  228 613A              		; Z ... nalezeno
  229 613A              		; C .. nenalezeno
  230 613A ED 53 65 61  search		ld (search0+1),de
  231 613E              search1
  232 613E
  233 613E 1A           			ld a,(de)
  234 613F FE 61        			cp "a"
  235 6141 38 08        			jr c,search_next
  236 6143 FE 7A        			cp "z"
  237 6145 30 04        			jr nc,search_next
  238 6147 B7           			or a
  239 6148 DE 20        			sbc a,32
  240 614A 12           			ld (de),a
  241 614B              search_next
  242 614B 7E           			ld a,(hl)
  243 614C FE 61        			cp "a"
  244 614E 38 08        			jr c,search_next2
  245 6150 FE 7A        			cp "z"
  246 6152 30 04        			jr nc,search_next2
  247 6154 B7           			or a
  248 6155 DE 20        			sbc a,32
  249 6157 77           			ld (hl),a
  250 6158              search_next2
  251 6158
  252 6158 1A           			ld a,(de)
  253 6159 EE 20        			xor 32
  254 615B C8           			ret z		;konec, nasli jsme retezec
  255 615C
  256 615C 7E           			ld a,(hl)
  257 615D B7           			or a
  258 615E 28 0E        			jr z,konec_textu
  259 6160
  260 6160 1A           			ld a,(de)
  261 6161              			; res 5,a
  262 6161              			; res 5,(hl)
  263 6161 AE           			xor (hl)
  264 6162 28 06        			jr z,search_jo
  265 6164 11 00 00     search0		ld de,0
  266 6167 23           			inc hl
  267 6168 18 D4        			jr search1
  268 616A 23           search_jo	inc hl
  269 616B 13           			inc de
  270 616C 18 D0        			jr search1
  271 616E
  272 616E 3E 01        konec_textu ld a,1		;nastav nz - nic jsme nenasli
  273 6170 B7           			or a
  274 6171 C9           			ret
  275 6172
  276 6172              SF
  277 6172              searchfile
  278 6172 ED 53 82 61  			ld (ssearch0+1),de
  279 6176 1A           			ld a,(de)
  280 6177 B7           			or a
  281 6178 C8           			ret z		;konec, nasli jsme retezec
  282 6179
  283 6179 7E           			ld a,(hl)
  284 617A B7           			or a
  285 617B 28 0E        			jr z,skonec_textu
  286 617D
  287 617D 1A           			ld a,(de)
  288 617E AE           			xor (hl)
  289 617F 28 06        			jr z,ssearch_jo
  290 6181 11 00 00     ssearch0		ld de,0
  291 6184 23           			inc hl
  292 6185 18 EB        			jr searchfile
  293 6187 23           ssearch_jo	inc hl
  294 6188 13           			inc de
  295 6189 18 E7        			jr searchfile
  296 618B
  297 618B
  298 618B 3E 01        skonec_textu ld a,1		;nastav nz - nic jsme nenasli
  299 618D B7           			or a
  300 618E C9           			ret
  301 618F
  302 618F
  303 618F
  304 618F
  305 618F
  306 618F
  307 618F
  308 618F
  309 618F
  310 618F              ; Porovnava dva reteze o delce 3 byty.
  311 618F              ; Vstup:
  312 618F              			; HL ... adresa prvniho retezce
  313 618F              			; DE ... adresa druheho retezce
  314 618F              ; Vystup:
  315 618F              			; Z ... souhlasí
  316 618F              			; NZ .. nesouhlasí
  317 618F              compare
  318 618F 1A           			ld a,(de)
  319 6190 CB BE        			res 7,(hl)
  320 6192 AE           			xor (hl)
  321 6193 C0           			ret nz
  322 6194 23           			inc hl
  323 6195 13           			inc de
  324 6196 1A           			ld a,(de)
  325 6197 CB BE        			res 7,(hl)
  326 6199 AE           			xor (hl)
  327 619A C0           			ret nz
  328 619B 23           			inc hl
  329 619C 13           			inc de
  330 619D 1A           			ld a,(de)
  331 619E CB BE        			res 7,(hl)
  332 61A0 AE           			xor (hl)
  333 61A1 C9           			ret
  334 61A2
  335 61A2              CountMemory
  336 61A2 11 AE 0B     			ld de,13*(pocetpolozek-1)
  337 61A5 21 00 80     Count11		ld hl,catbuff
  338 61A8 19           			add hl,de
  339 61A9 22 A6 61     			ld (Count11+1),hl
  340 61AC
  341 61AC C9           			ret
  342 61AD
  343 61AD 00 00        savehl		defw 0
  344 61AF 00 00        saveix		defw 0
  345 61B1              ESXDOS      MACRO service?
  345 61B1 ~              push hl
  345 61B1 ~              pop ix
  345 61B1 ~              rst $08
  345 61B1 ~              db service?
  345 61B1                ENDM    ; copies HL into IX
  346 61B1
  347 61B1              ; Read NextReg into A (does modify A, and NextReg selected on the I/O port)
  348 61B1              ; is not optimized for speed + restores BC
  349 61B1                  MACRO NEXTREG2A register?
  350 61B1 ~                    ld     a,register?
  351 61B1 ~                    call   ReadNextReg
  352 61B1                  ENDM
  353 61B1
  354 61B1 50 6C 65 61  txtWait		defb	"Please wait:",0
  354 61B5 73 65 20 77
  354 61B9 61 69 74 3A
  354 61BD 00
  355 61BE 4D 61 69 6E  txtShrek	defb	"Main program: Shrek/MB Maniax",0
  355 61C2 20 70 72 6F
  355 61C6 67 72 61 6D
  355 61CA 3A 20 53 68
  355 61CE 72 65 6B 2F
  355 61D2 4D 42 20 4D
  355 61D6 61 6E 69 61
  355 61DA 78 00
  356 61DC 41 59 20 70  txtBorik	defb 	"AY play rutines: mborik/SinDiKat",0
  356 61E0 6C 61 79 20
  356 61E4 72 75 74 69
  356 61E8 6E 65 73 3A
  356 61EC 20 6D 62 6F
  356 61F0 72 69 6B 2F
  356 61F4 53 69 6E 44
  356 61F8 69 4B 61 74
  356 61FC 00
  357 61FD 42 69 67 20  txtThanks	defb	"Big thanks: ped7g, z00m, Logout",0
  357 6201 74 68 61 6E
  357 6205 6B 73 3A 20
  357 6209 70 65 64 37
  357 620D 67 2C 20 7A
  357 6211 30 30 6D 2C
  357 6215 20 4C 6F 67
  357 6219 6F 75 74 00
  358 621D 30 2E 36 00  txtVersion	defb 	"0.6",0
  359 6221 F3           demo:       di
  360 6222
  361 6222              F_OPEN                      equ $9A
  362 6222              FA_READ                     equ $01
  363 6222              F_READ                      equ $9D
  364 6222              F_CLOSE                     equ $9B
  365 6222              M_GETERR                    equ $93
  366 6222              next_register_select equ $243b
  367 6222              nxr_peripheral2 equ $06
  368 6222
  369 6222
  370 6222 21 00 58     			ld hl,22528
  371 6225 11 01 58                 ld de,22529
  372 6228 3E 07        			ld a,7
  373 622A 77                       ld (hl),a
  374 622B 01 FF 02                 ld bc,767
  375 622E ED B0                    ldir
  376 6230 21 22 BE     			ld hl,screen
  377 6233 11 00 40     			ld de,16384
  378 6236 01 00 08     			ld bc,2048
  379 6239 ED B0        			ldir
  380 623B 11 22 48     			ld de,18464+2
  381 623E 21 B1 61     			ld hl,txtWait
  382 6241 CD CD 7A     			call print
  383 6244 21 42 48     			ld hl, 18496+2
  384 6247 01 1C 04     			ld   bc,4*256+28
  385 624A 3E 05        			ld   a,%00000101
  386 624C CD F0 76     			call RAMECEK
  387 624F
  388 624F 11 64 48     			ld de,18528+4
  389 6252 21 A6 6C     			ld hl,txtStart
  390 6255 CD CD 7A     			call print
  391 6258
  392 6258 11 43 50     			ld de,20544+3
  393 625B 21 BE 61     			ld hl,txtShrek
  394 625E CD CD 7A     			call print
  395 6261 11 63 50     			ld de,20576+3
  396 6264 21 DC 61     			ld hl,txtBorik
  397 6267 CD CD 7A     			call print
  398 626A 11 83 50     			ld de,20608+3
  399 626D 21 FD 61     			ld hl,txtThanks
  400 6270 CD CD 7A     			call print
  401 6273
  402 6273 11 7C 40     			ld de,16480+28
  403 6276 21 1D 62     			ld hl,txtVersion
  404 6279 CD CD 7A     			call print
  405 627C
  406 627C 21 00 00     			ld hl,0
  407 627F 11 78 48     			ld de,18528+24
  408 6282 ED 53 FD 64  			ld (NUMPOS+1),de
  409 6286 CD CA 64     			call DEC16
  410 6289 00 14        			defw 20*256
  411 628B
  412 628B 21 4D 5A     			ld hl,22528+13 + 32*18
  413 628E 06 0F        			ld b,15
  414 6290 36 47        podbarvi	ld (hl),%01000111
  415 6292 23           			inc hl
  416 6293 10 FB        			djnz podbarvi
  417 6295
  418 6295 21 6F 5A     			ld hl,22528+15 + 32*19
  419 6298 06 0F        			ld b,15
  420 629A 36 47        podbarvi1	ld (hl),%01000111
  421 629C 23           			inc hl
  422 629D 10 FB        			djnz podbarvi1
  423 629F
  424 629F 21 8B 5A     			ld hl,22528+11 + 32*20
  425 62A2 06 0F        			ld b,15
  426 62A4 36 47        podbarvi2	ld (hl),%01000111
  427 62A6 23           			inc hl
  428 62A7 10 FB        			djnz podbarvi2
  429 62A9
  430 62A9 21 00 58     			ld hl,22528
  431 62AC 06 80        			ld b,32*4
  432 62AE 36 47        podbarvi3	ld (hl),%01000111
  433 62B0 23           			inc hl
  434 62B1 10 FB        			djnz podbarvi3
  435 62B3
  436 62B3 01 3B 12     			ld bc,$123b
  437 62B6                          ;nextreg #03,1
  438 62B6 ED 91 07 03  			nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
  439 62BA
  440 62BA CD 2A 65     			call BUFF83
  441 62BD
  442 62BD ED 73 FF 5F              ld (staksto),sp   ;save BASIC's stack pointer
  443 62C1 01 FD 7F                 ld bc,port1       ;the horizontal ROM switch/RAM
  444 62C4                                              ;switch I/O ad dress
  445 62C4 3A 5C 5B                 ld a,(bankm)      ;sys tem vari able that holds cur rent
  446 62C7                                              ;switch state
  447 62C7 CB A7                    res 4,a           ;move right to left in hor i zon tal
  448 62C9                                              ;ROM switch (3 to 2)
  449 62C9
  450 62C9 F6 07                      or 7              ;switch in RAM page 7
  451 62CB 32 5C 5B                   ld (bankm),a      ;must keep sys tem vari able up to
  452 62CE                            	                  ;date (very im por tant)
  453 62CE ED 79                      out (c),a         ;make the switch
  454 62D0
  455 62D0 31 FF 5F     			  ld sp,mystak      ;make sure stack is above 4000h and
  456 62D3                                              ;be low BFE0h
  457 62D3 FB                         ei                ;in ter rupts can now be en abled
  458 62D4
  459 62D4 21 00 80                   ld hl,catbuff     ;some where for DOS to put the cata
  460 62D7                                              ;log
  461 62D7 11 01 80                   ld de,catbuff+1   ;
  462 62DA 01 00 04                   ld bc,1024        ;max i mum (for +3DOS) is ac tu ally
  463 62DD                                              ;64x13+13 = 845
  464 62DD 36 00                      ld (hl),0
  465 62DF ED B0                      ldir              ;make sure at least first en try is
  466 62E1 11 00 80                   ld de,catbuff     ;the lo ca tion to be filled with the
  467 62E4              NextDirItem
  468 62E4 06 E7                      ld b,pocetpolozek ;the num ber of en tries in the
  469 62E6                                              ;buffer
  470 62E6 0E 04                      ld c,%100            ;include sys tem files in the cata
  471 62E8 21 37 66                   ld hl,stardstar   ;the file name ("*.*")
  472 62EB CD 1E 01                   call dos_catalog  ;call the DOS en try
  473 62EE
  474 62EE 22 AD 61                   ld (savehl),hl
  475 62F1 DD 22 AF 61  			  ld (saveix),ix
  476 62F5 78           			  ld a,b
  477 62F6 FE E7        			  cp pocetpolozek
  478 62F8 F5           			  push af
  479 62F9
  480 62F9 2A F3 79     			  ld hl,(ALLFILES)
  481 62FC 58           			  ld e,b
  482 62FD 16 00        			  ld d,0
  483 62FF 19           			  add hl,de
  484 6300 2B           			  dec hl
  485 6301 22 F3 79     			  ld (ALLFILES),hl
  486 6304
  487 6304 E5           			push hl
  488 6305 D5           			push de
  489 6306 C5           			push bc
  490 6307
  491 6307
  492 6307 2A 19 65     			ld hl,(dirNum)
  493 630A 19           			add	hl,de
  494 630B 2B           			dec hl
  495 630C 22 19 65     			ld 	(dirNum),hl
  496 630F 11 78 48     			ld de,18528+24
  497 6312 ED 53 FD 64  			ld (NUMPOS+1),de
  498 6316 76           			halt
  499 6317 CD CA 64     			call DEC16
  500 631A 00 14        			defw 20*256
  501 631C C1           			pop bc
  502 631D D1           			pop de
  503 631E E1           			pop hl
  504 631F
  505 631F
  506 631F 3A F2 79     			  ld a,(FILES)
  507 6322 80           			  add a,b
  508 6323 3D           			  dec a
  509 6324 32 F2 79     			  ld (FILES),a
  510 6327 F1           			  pop af
  511 6328 38 15        			  jr c,cont
  512 632A              nezapisuj
  513 632A 78           			  ld a,b
  514 632B B7           			  or a
  515 632C 28 11        			  jr z,cont
  516 632E
  517 632E 3A 0F 60     			  ld a,(virtmem)
  518 6331 FE 04        			  cp 4
  519 6333 28 0A        			  jr z,cont
  520 6335
  521 6335 CD A2 61     			  call CountMemory
  522 6338 EB           			  ex de,hl
  523 6339 21 0F 60     			  ld hl,virtmem
  524 633C 34           			  inc (hl)
  525 633D 18 A5        			  jr NextDirItem
  526 633F              cont
  527 633F F5                         push af           ;save flags and pos si ble er ror num
  528 6340                                              ;ber re turned by DOS
  529 6340
  530 6340
  531 6340 2A 19 65     			ld hl,(dirNum)
  532 6343 11 78 48     			ld de,18528+24
  533 6346 ED 53 FD 64  			ld (NUMPOS+1),de
  534 634A 76           			halt
  535 634B CD CA 64     			call DEC16
  536 634E 00 14        			defw 20*256
  537 6350
  538 6350
  539 6350 E1                         pop hl
  540 6351 22 3D 66                   ld (dosret),hl    ;put it where it can be seen from
  541 6354                                              ; NextBASIC
  542 6354 48                         ld c,b            ;move num ber of files in cat a log to
  543 6355                                              ;low byte of BC
  544 6355 06 00                      ld b,0            ;this will be re turned in NextBASIC
  545 6357
  546 6357 F3                         di                ;about to ROM/RAM switch so be
  547 6358                                              ;care ful
  548 6358 C5                         push bc           ;save num ber of files
  549 6359 01 FD 7F                   ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
  550 635C                                              ;switch
  551 635C 3A 5C 5B                   ld a,(bankm)      ;get cur rent switch state
  552 635F
  553 635F
  554 635F CB E7                      set 4,a           ;move left to right (ROM 2 to ROM
  555 6361                                              ;3)
  556 6361 E6 F8                      and #F8           ;also want RAM page 0
  557 6363 32 5C 5B                   ld (bankm),a      ;up date the sys tem vari able (very
  558 6366                                              ;im por tant)
  559 6366 ED 79                      out (c),a         ;make the switch
  560 6368 C1                         pop bc            ;get back the saved num ber of files
  561 6369 0B                         dec bc
  562 636A
  563 636A ED 7B FF 5F                ld sp,(staksto)   ;put NextBASIC's stack back
  564 636E
  565 636E CD 2A 65     			 call BUFF83
  566 6371 21 0D 80     			 ld hl,catbuff+13
  567 6374 ED 5B F3 79  			 ld de,(ALLFILES)
  568 6378 D5           testovani	 push de
  569 6379 E5           			 push hl
  570 637A DD E1        			 pop ix
  571 637C DD E5        			 push ix
  572 637E DD CB 07 7E  			 bit 7,(ix+7)
  573 6382
  574 6382 20 53        			 jr nz,souhlasi
  575 6384
  576 6384 11 08 00     			 ld de,8
  577 6387 19           			 add hl,de		;v HL je začátek přípony souboru
  578 6388
  579 6388 E5           			 push hl
  580 6389 11 99 73     			 ld de,PT2
  581 638C CD 8F 61     			 call compare
  582 638F E1           			 pop hl
  583 6390 28 45        			 jr z,souhlasi
  584 6392
  585 6392 E5           			 push hl
  586 6393 11 9C 73     			 ld de,PT3
  587 6396 CD 8F 61     			 call compare
  588 6399 E1           			 pop hl
  589 639A 28 3B        			 jr z,souhlasi
  590 639C
  591 639C 11 9F 73     			 ld de,SQT
  592 639F E5           			 push hl
  593 63A0 CD 8F 61     			 call compare
  594 63A3 E1           			 pop hl
  595 63A4 28 31        			 jr z,souhlasi
  596 63A6
  597 63A6 11 A2 73     			 ld de,STC
  598 63A9 E5           			 push hl
  599 63AA CD 8F 61     			 call compare
  600 63AD E1           			 pop hl
  601 63AE 28 27        			 jr z,souhlasi
  602 63B0
  603 63B0 11 A5 73      			 ld de,STP
  604 63B3 E5           			 push hl
  605 63B4 CD 8F 61     			 call compare
  606 63B7 E1           			 pop hl
  607 63B8 28 1D        			 jr z,souhlasi
  608 63BA
  609 63BA D1           			 pop de
  610 63BB D5           			 push de		;v de mame zacatek jmena souboru
  611 63BC 62           			 ld h,d
  612 63BD 6B           			 ld l,e
  613 63BE ED 34 0D 00  			 add hl,13		;vynechana jedna polozka
  614 63C2 01 FC 3F     			 ld bc,1260*13
  615 63C5 ED B0        			 ldir
  616 63C7
  617 63C7 2A F3 79     			 ld hl,(ALLFILES)
  618 63CA 2B           			 dec hl
  619 63CB 22 F3 79     			 ld (ALLFILES),hl
  620 63CE E1           			 pop hl
  621 63CF D1           			 pop de
  622 63D0 1B           			 dec de
  623 63D1 7A           			 ld a,d
  624 63D2 B3           			 or e
  625 63D3 20 A3        			 jr nz,testovani
  626 63D5 18 0B        			 jr skon
  627 63D7              souhlasi
  628 63D7 E1           			 pop hl
  629 63D8 11 0D 00     			 ld de,13
  630 63DB 19           			 add hl,de
  631 63DC D1           			 pop de
  632 63DD 1B           			 dec de
  633 63DE 7A           			 ld a,d
  634 63DF B3           			 or e
  635 63E0 20 96        			 jr nz,testovani
  636 63E2              skon
  637 63E2
  638 63E2 2A F3 79     			ld hl,(ALLFILES)
  639 63E5 22 10 60     			ld (save_allfiles),hl
  640 63E8 11 84 48     			 ld de,18560+4
  641 63EB 21 8D 6C     			 ld hl,txtLFNinfo
  642 63EE CD CD 7A     			 call print
  643 63F1 CD D0 6C     			 call getAllLFN
  644 63F4 CD FD 6D     			 call GETDIR
  645 63F7 21 00 40     			 ld hl,16384
  646 63FA 11 01 40     			 ld de,16385
  647 63FD 01 FF 17     			 ld bc,6143
  648 6400 AF           			 xor a
  649 6401 77           			 ld (hl),a
  650 6402 ED B0        			 ldir
  651 6404
  652 6404 CD 3B 65     			 call NOBUFF83
  653 6407 CD C2 77                  call kresli
  654 640A CD 35 7A                  call INIROLL
  655 640D
  656 640D 21 0D 80     			 ld hl,catbuff+#d
  657 6410 CD E3 78                  call WRFILES      ;vypis soubory
  658 6413 11 2F 48     			 ld de,18464+15
  659 6416 21 25 7F     			 ld hl,txtcurrentfile
  660 6419 CD CD 7A     			 call print
  661 641C
  662 641C 11 0F 48     			 ld de,18432+15
  663 641F 21 1A 7F     			 ld hl,txtallfiles
  664 6422 CD CD 7A     			 call print
  665 6425
  666 6425 CD 1B 65     			call LFNWINDOW
  667 6428 CD BA 65     			call LFNPRINT
  668 642B 21 41 BD     			ld hl,LFNNAME + maxline
  669 642E 36 00        			ld (hl),0
  670 6430 21 1C BD     			ld hl,LFNNAME
  671 6433 11 C2 50     			ld de,20672+2
  672 6436 CD CD 7A     			call print
  673 6439
  674 6439
  675 6439 11 4F 50     			ld de,20544+15
  676 643C 21 AA 6F     			ld hl,lfndir
  677 643F CD CD 7A     			call print
  678 6442 11 52 50     			ld de,20544+15+3
  679 6445 21 E9 6D     			ld hl,NAZEVADRESARE
  680 6448 CD CD 7A     			call print
  681 644B
  682 644B ED 91 07 00              nextreg #07,0             ;3,5MHz
  683 644F
  684 644F ED 91 57 18  			nextreg $57,24		;Nastrankuj od C000 player
  685 6453              HLSMYC0
  686 6453 2A DB 75     		ld hl,(apos_all)
  687 6456 23           		inc hl
  688 6457 11 3A 48     		ld de,18464+15+11
  689 645A ED 53 FD 64  		ld (NUMPOS+1),de
  690 645E CD CA 64     		call DEC16
  691 6461 00 14        		defw 20*256
  692 6463
  693 6463 2A F3 79     		ld hl,(ALLFILES)
  694 6466 11 1A 48     		ld de,18432+15+11
  695 6469 ED 53 FD 64  		ld (NUMPOS+1),de
  696 646D CD CA 64     		call DEC16
  697 6470 00 14        		defw 20*256
  698 6472
  699 6472 AF                    xor  a
  700 6473 32 A4 64              ld   (LAST_KEY+1),a
  701 6476 FB           		 ei
  702 6477 76           		 halt
  703 6478
  704 6478 3A A8 73     		 ld a,(endsong)
  705 647B B7           		 or a
  706 647C 28 05        		 jr z,hl0
  707 647E 32 A4 64     		 ld (LAST_KEY+1),a
  708 6481 18 2A        		 jr SEDI_KEY
  709 6483              hl0
  710 6483 CD 6F 74     		 call KEYSCAN
  711 6486
  712 6486 7B           		 ld   a,e
  713 6487 3C                    inc  a
  714 6488 28 C9                 jr   z,HLSMYC0
  715 648A 7A                    ld   a,d
  716 648B 21 A0 74              ld   hl,SYMTAB
  717 648E FE 18                 cp   $18
  718 6490 28 0A                 jr   z,HLSM2
  719 6492 21 C8 74              ld   hl,CAPSTAB
  720 6495 FE 27                 cp   $27
  721 6497 28 03                 jr   z,HLSM2
  722 6499 21 EF 74              ld   hl,NORMTAB
  723 649C 16 00        HLSM2    ld   d,0
  724 649E 19                    add  hl,de
  725 649F 7E                    ld   a,(hl)
  726 64A0 B7                    or   a
  727 64A1 28 B0                 jr   z,HLSMYC0
  728 64A3
  729 64A3 06 00        LAST_KEY ld   b,0
  730 64A5 B8                    cp   b
  731 64A6 28 05                 jr   z,SEDI_KEY
  732 64A8
  733 64A8 06 01                 ld   b,1
  734 64AA 76           LOOP_LST halt
  735 64AB 10 FD                 djnz LOOP_LST
  736 64AD
  737 64AD              SEDI_KEY
  738 64AD 32 A4 64              ld   (LAST_KEY+1),a
  739 64B0
  740 64B0
  741 64B0 32 3F 66     	     ld (KEY),a
  742 64B3
  743 64B3 CD 17 75     		call beepk
  744 64B6 CD 40 66     		call CH_FILE
  745 64B9 18 98        		jr   HLSMYC0
  746 64BB
  747 64BB FB                    ei
  748 64BC 18 FE        konec    jr konec
  749 64BE
  750 64BE
  751 64BE
  752 64BE C9                    ret
  753 64BF
  754 64BF
  755 64BF 00 00 00...  NUM      ds 11
  756 64CA 0E 20        DEC16    ld   c,' '
  757 64CC FD 21 BF 64  DEC16X   ld   iy,NUM
  758 64D0 11 F0 D8              ld   de,-10000
  759 64D3 CD 02 65              call BN1
  760 64D6 11 18 FC              ld   de,-1000
  761 64D9 CD 02 65              call BN1
  762 64DC 11 9C FF     DEC8_3   ld   de,-100
  763 64DF CD 02 65              call BN1
  764 64E2 1E F6                 ld   e,-10
  765 64E4 CD 02 65              call BN1
  766 64E7 1E FF                 ld   e,-1
  767 64E9 0E 30                 ld   c,'0'
  768 64EB CD 02 65              call BN1
  769 64EE FD 36 00 00  DEC32SP  ld   (iy+0),0
  770 64F2 E3                    ex   (sp),hl
  771 64F3 5E                    ld   e,(hl)
  772 64F4 23                    inc  hl
  773 64F5 56                    ld   d,(hl)
  774 64F6 23                    inc  hl
  775 64F7 E3                    ex   (sp),hl
  776 64F8 EB                    ex   de,hl
  777 64F9 21 BF 64              ld   hl,NUM
  778 64FC 11 91 48     NUMPOS	 ld   de,18562+15
  779 64FF C3 CD 7A              jp   print
  780 6502
  781 6502 3E 2F        BN1      ld   a,'0'-1
  782 6504 19           BN4      add  hl,de
  783 6505 3C                    inc  a
  784 6506 38 FC                 jr   c,BN4
  785 6508 ED 52        BN2      sbc  hl,de
  786 650A FE 30                 cp   '0'
  787 650C 28 02                 jr   z,BN3
  788 650E 01 30                 db 1,'0'
  789 6510 79           BN3      ld   a,c
  790 6511 B7                    or   a
  791 6512 C8                    ret  z
  792 6513 FD 77 00              ld   (iy+0),a
  793 6516 FD 23                 inc  iy
  794 6518 C9                    ret
  795 6519
  796 6519 00 00        dirNum	 defw 0
  797 651B
  798 651B              LFNWINDOW
  799 651B 21 A0 50     		ld hl, 20640
  800 651E 01 20 03     		ld   bc,3*256+32
  801 6521 3E 07                ld   a,%00000111
  802 6523 CD F0 76     		call RAMECEK
  803 6526 C9           		ret
  804 6527
  805 6527              setspace
  806 6527 36 20        		ld (hl),32
  807 6529 C9           		ret
  808 652A
  809 652A
  810 652A
  811 652A              ;Nastránkuj buffer s daty adresáře
  812 652A              BUFF83
  813 652A ED 91 54 14  			nextreg $54,20
  814 652E ED 91 55 15  			nextreg $55,21
  815 6532 ED 91 56 16  			nextreg $56,22
  816 6536 ED 91 57 17  			nextreg $57,23
  817 653A C9           			ret
  818 653B
  819 653B              NOBUFF83
  820 653B ED 91 54 04  			nextreg $54,04
  821 653F ED 91 55 05  			nextreg $55,05
  822 6543 ED 91 56 00  			nextreg $56,00
  823 6547 ED 91 57 01  			nextreg $57,01
  824 654B C9           			ret
  825 654C
  826 654C
  827 654C              ; Input: HL = Dividend, C = Divisor, A = 0
  828 654C              ; Output: HL = Quotient, A = Remainder
  829 654C AF           deleno		xor a
  830 654D 06 10        			ld b,16
  831 654F              de
  832 654F 29           			add	hl,hl
  833 6550 17           			rla
  834 6551 B9           			cp	c
  835 6552 38 02        			jr	c,de1
  836 6554 91           			sub	c
  837 6555 2C           			inc	l
  838 6556 10 F7        de1			djnz de
  839 6558 C9           			ret
  840 6559
  841 6559 00 00        addrlfn		dw 0
  842 655B
  843 655B              FINDLFN
  844 655B B7           			or a
  845 655C 11 3F 00     			ld de,63
  846 655F ED 52        			sbc hl,de
  847 6561 19           			add hl,de
  848 6562 38 08        			jr c,prvni
  849 6564 0E 3F        			ld c,63
  850 6566 AF           			xor a
  851 6567 CD 4C 65     			call deleno
  852 656A 18 03        		    jr oddeleno
  853 656C 7D           prvni		ld a,l
  854 656D 2E 00        			ld l,0
  855 656F
  856 656F F5           oddeleno	push af
  857 6570 3E 18        			ld a,24
  858 6572 85           			add a,l
  859 6573 ED 92 57     			nextreg $57,a
  860 6576 C1           			pop bc
  861 6577 11 80 00     			ld de,maxlen
  862 657A 78           			ld a,b
  863 657B B7           			or a
  864 657C 21 00 E0     			ld hl,$e000
  865 657F 28 03        			jr z,prvnizaznam
  866 6581              lll
  867 6581 19           			add hl,de
  868 6582 10 FD        			djnz lll
  869 6584
  870 6584              prvnizaznam
  871 6584 22 59 65     			ld (addrlfn),hl
  872 6587 11 1C BD     			ld de,LFNNAME
  873 658A 06 80        			ld b,maxlen
  874 658C              popop
  875 658C 7E           			ld a,(hl)
  876 658D FE FF        			cp 255
  877 658F 28 05        			jr z,kon
  878 6591 12           			ld (de),a
  879 6592 23           			inc hl
  880 6593 13           			inc de
  881 6594 10 F6        			djnz popop
  882 6596              kon
  883 6596 21 1C BD     			ld hl,LFNNAME
  884 6599 06 28        			ld b,40
  885 659B              F22222
  886 659B 7E           			ld a,(hl)
  887 659C FE FF        			cp 255
  888 659E CC 27 65     			call z,setspace
  889 65A1 23           			inc hl
  890 65A2 10 F7        			djnz F22222
  891 65A4 21 1C BD     lfnend		ld hl,LFNNAME
  892 65A7 21 DE 50     lfn_1		ld hl,28 + 20672+2
  893 65AA 22 C7 7A     			ld (maxpos),hl
  894 65AD 21 01 51     lfn_2		ld hl,63 + 20672+2
  895 65B0 22 C9 7A     			ld (maxpos2),hl
  896 65B3
  897 65B3 11 C2 50     lfnat		ld de,20672+2
  898 65B6 21 1C BD     			ld hl,LFNNAME
  899 65B9 C9           			ret
  900 65BA
  901 65BA              LFNPRINT
  902 65BA 21 1C BD     			ld hl,LFNNAME
  903 65BD 11 1D BD     			ld de,LFNNAME + 1
  904 65C0 3E 20        			ld a,32
  905 65C2 77           			ld (hl),a
  906 65C3 01 A4 00     			ld bc,164
  907 65C6 ED B0        			ldir
  908 65C8              stop
  909 65C8 2A DB 75     			ld hl,(apos_all)
  910 65CB
  911 65CB CD 5B 65     			call FINDLFN
  912 65CE
  913 65CE
  914 65CE              			;call p6b
  915 65CE ED 91 57 01  			nextreg $57,01
  916 65D2 C9           			ret
  917 65D3
  918 65D3 00           by1			defb  %00000000
  919 65D4 7E           			defb  %01111110
  920 65D5 6A           			defb  %01101010
  921 65D6 56           			defb  %01010110
  922 65D7 6A           			defb  %01101010
  923 65D8 56           			defb  %01010110
  924 65D9 7E           			defb  %01111110
  925 65DA 00           			defb  %00000000
  926 65DB
  927 65DB 00           			defb  %00000000
  928 65DC 7E           			defb  %01111110
  929 65DD 6A           			defb  %01101010
  930 65DE 56           			defb  %01010110
  931 65DF 6A           			defb  %01101010
  932 65E0 56           			defb  %01010110
  933 65E1 7E           			defb  %01111110
  934 65E2 00           			defb  %00000000
  935 65E3
  936 65E3 00           			defb  %00000000
  937 65E4 7E           			defb  %01111110
  938 65E5 6A           			defb  %01101010
  939 65E6 56           			defb  %01010110
  940 65E7 6A           			defb  %01101010
  941 65E8 56           			defb  %01010110
  942 65E9 7E           			defb  %01111110
  943 65EA 00           			defb  %00000000
  944 65EB
  945 65EB D5           pozadi		  push de
  946 65EC 06 08        			  ld b,8
  947 65EE C5           kr1			  push bc
  948 65EF D5           			  push de
  949 65F0 01 10 00     			  ld bc,16
  950 65F3 21 16 66     			  ld hl,byte16
  951 65F6 ED B0        			  ldir
  952 65F8 E1           			  pop hl
  953 65F9 CD C7 7B     			  call downhl
  954 65FC EB           			  ex de,hl
  955 65FD
  956 65FD C1           			  pop bc
  957 65FE 10 EE        			  djnz  kr1
  958 6600
  959 6600 D1           			  pop de
  960 6601 06 08        			  ld b,8
  961 6603 C5           kr2			  push bc
  962 6604 D5           			  push de
  963 6605 01 10 00     			  ld bc,16
  964 6608 21 35 66     			  ld hl,abyte16
  965 660B ED B8        			  lddr
  966 660D E1           			  pop hl
  967 660E CD C7 7B     			  call downhl
  968 6611 EB           			  ex de,hl
  969 6612
  970 6612 C1           			  pop bc
  971 6613 10 EE        			  djnz  kr2
  972 6615 C9           			  ret
  973 6616
  974 6616
  975 6616
  976 6616 FF           byte16	defb	%11111111
  977 6617 FE           byte15	defb	%11111110
  978 6618 FC           byte14	defb	%11111100
  979 6619 F8           byte13	defb	%11111000
  980 661A F0           byte12	defb	%11110000
  981 661B E1           byte11	defb	%11100001
  982 661C C3           byte10	defb	%11000011
  983 661D 87           byte9	defb	%10000111
  984 661E 1F           byte8	defb	%00011111
  985 661F 0F           byte7	defb	%00001111
  986 6620 07           byte6	defb	%00000111
  987 6621 07           byte5	defb	%00000111
  988 6622 03           byte4	defb	%00000011
  989 6623 01           byte3	defb	%00000001
  990 6624 01           byte2	defb	%00000001
  991 6625 00           byte1	defb	%00000000
  992 6626
  993 6626 00           abyte1	defb	%00000000
  994 6627 01           abyte2	defb	%00000001
  995 6628 01           abyte3	defb	%00000001
  996 6629 03           abyte4	defb	%00000011
  997 662A 07           abyte5	defb	%00000111
  998 662B 07           abyte6	defb	%00000111
  999 662C 0F           abyte7	defb	%00001111
 1000 662D 1F           abyte8	defb	%00011111
 1001 662E 87           abyte9	defb	%10000111
 1002 662F C3           abyte10	defb	%11000011
 1003 6630 E1           abyte11	defb	%11100001
 1004 6631 F0           abyte12	defb	%11110000
 1005 6632 F8           abyte13	defb	%11111000
 1006 6633 FC           abyte14	defb	%11111100
 1007 6634 FE           abyte15	defb	%11111110
 1008 6635 FF           abyte16	defb	%11111111
 1009 6636 00           outputdir	defb 0
 1010 6637              stardstar:
 1011 6637 2A 2E 3F 3F                defb "*.???",#FF
 1011 663B 3F FF
 1012 663D              dosret:
 1013 663D 00 00                      defw 0
 1014 663F
 1015 663F 00           KEY      defb 0
 1016 6640              CH_FILE
 1017 6640
 1018 6640 3A 3F 66              ld   a,(KEY)
 1019 6643 FE 71                 cp   "q"
 1020 6645 CA 30 75              jp   z,UP
 1021 6648 FE 0B                 cp   11
 1022 664A CA 30 75              jp   z,UP
 1023 664D FE 73        		 cp "s"
 1024 664F CA C7 66     		 jp z,hledej
 1025 6652 FE 72        		 cp "r"
 1026 6654 CA 95 6D     		 jp z,reload
 1027 6657 FE 61                 cp   "a"
 1028 6659 CA 91 75              jp   z,DOWN
 1029 665C FE 0A                 cp   10
 1030 665E CA 91 75              jp   z,DOWN
 1031 6661 FE 09        		 cp 9
 1032 6663 CA 1A 6A     		 jp z,right
 1033 6666 FE 08        		 cp 8
 1034 6668 CA 8C 69     		 jp z,left
 1035 666B FE 0D                 cp   13
 1036 666D CA 70 71              jp   z,FIRE
 1037 6670 FE 20        		 cp 32
 1038 6672 CA 6D 71     		 jp z,nextsong
 1039 6675 C9                    ret
 1040 6676 53 65 61 72  txtFilter defb "Search:           ",0
 1040 667A 63 68 3A 20
 1040 667E 20 20 20 20
 1040 6682 20 20 20 20
 1040 6686 20 20 00
 1041 6689 00 00        savepoc defw 0
 1042 668B 00 00        actadr	defw 0
 1043 668D 00 00        h1		defw 0
 1044 668F 53 65 61 72  txtFind defb "Search songs.",0
 1044 6693 63 68 20 73
 1044 6697 6F 6E 67 73
 1044 669B 2E 00
 1045 669D 4F 6E 6C 79  txtFind2 defb "Only chars, without spaces.",0
 1045 66A1 20 63 68 61
 1045 66A5 72 73 2C 20
 1045 66A9 77 69 74 68
 1045 66AD 6F 75 74 20
 1045 66B1 73 70 61 63
 1045 66B5 65 73 2E 00
 1046 66B9 46 6F 75 6E  txtFinded defb "Found:",0
 1046 66BD 64 3A 00
 1047 66C0 4C 65 66 74  txtLeft defb "Left: ",0
 1047 66C4 3A 20 00
 1048 66C7 CD 41 74     hledej	call savescr
 1049 66CA 21 00 00     		ld hl,0
 1050 66CD 22 59 67     		ld (nalezeno+1),hl
 1051 66D0 21 00 00     		ld hl,0
 1052 66D3 22 8D 67     		ld (pozice+1),hl
 1053 66D6 2A F3 79     		ld hl,(ALLFILES)
 1054 66D9 22 89 66     		ld (savepoc),hl
 1055 66DC 21 0D 80     		ld hl,catbuff+#d
 1056 66DF 22 8B 66     		ld (actadr),hl
 1057 66E2
 1058 66E2 21 20 48     		ld   hl,18464
 1059 66E5 01 20 08             ld   bc,8*256+32
 1060 66E8 3E 07                ld   a,%00000111
 1061 66EA CD F0 76             call RAMECEK
 1062 66ED
 1063 66ED 11 41 48     		ld de,18496+1
 1064 66F0 21 8F 66     		ld hl,txtFind
 1065 66F3 CD CD 7A     		call print
 1066 66F6
 1067 66F6 11 61 48     		ld de,18528+1
 1068 66F9 21 9D 66     		ld hl,txtFind2
 1069 66FC CD CD 7A     		call print
 1070 66FF
 1071 66FF 21 00 00     		ld hl,0
 1072 6702 22 8D 67     		ld (pozice+1),hl
 1073 6705 22 8D 66     		ld (h1),hl
 1074 6708
 1075 6708 21 A1 59     		ld hl,13*32+22528+1
 1076 670B 06 1D        		ld b,29
 1077 670D 36 68        po		ld (hl),01101000b
 1078 670F 23           		inc hl
 1079 6710 10 FB        		djnz po
 1080 6712
 1081 6712 DD 26 1C     		ld hx,28 ;délka vstupu
 1082 6715 21 A1 48     		ld hl,18592+1 ;adresa na obrazovce
 1083 6718 CD 1D 60     		call INPUT ;volej vstupní podprogram
 1084 671B FE 07        		cp 7 ;testuj EDIT
 1085 671D CA 07 69     		jp z,end_hledej
 1086 6720 21 00 5B     		ld hl,23296
 1087 6723 11 7E 66     		ld de,txtFilter + 8
 1088 6726 01 0A 00     		ld bc,10
 1089 6729 ED B0        		ldir
 1090 672B 11 6F 50     		ld de,20576+15
 1091 672E 21 76 66     		ld hl,txtFilter
 1092 6731 CD CD 7A     		call print
 1093 6734
 1094 6734
 1095 6734 11 C1 48     		ld de,18624+1
 1096 6737 21 B9 66     		ld hl,txtFinded
 1097 673A CD CD 7A     		call print
 1098 673D
 1099 673D 11 E1 48     		ld de,18656+1
 1100 6740 21 C0 66     		ld hl,txtLeft
 1101 6743 CD CD 7A     		call print
 1102 6746
 1103 6746              ssss
 1104 6746 ED 91 07 03  			nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 1105 674A CD 2A 65     			call BUFF83
 1106 674D 21 0D 80     			ld hl,catbuff+13; + 26 ;vynechej první dvě položky
 1107 6750
 1108 6750 ED 5B F3 79  			ld de,(ALLFILES)
 1109 6754 D5           htestovani	push de
 1110 6755 E5           			push hl
 1111 6756
 1112 6756 E5           			push hl
 1113 6757 D5           			push de
 1114 6758
 1115 6758 21 00 00     nalezeno	ld hl,0
 1116 675B 11 C5 48     			ld de,18624+5	;pozice ve VideoRam
 1117 675E ED 53 FD 64  			ld (NUMPOS+1),de
 1118 6762
 1119 6762 CD CA 64     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
 1120 6765 00 14        			defw 20*256
 1121 6767
 1122 6767 2A 8D 66     			ld hl,(h1)
 1123 676A 23           			inc hl
 1124 676B 22 8D 66     			ld (h1),hl
 1125 676E
 1126 676E 2A F3 79     			ld hl,(ALLFILES)
 1127 6771 11 E5 48     			ld de,18656+5	;pozice ve VideoRam
 1128 6774 ED 53 FD 64  			ld (NUMPOS+1),de
 1129 6778 CD CA 64     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
 1130 677B 00 14        			defw 20*256
 1131 677D
 1132 677D
 1133 677D 21 1C BD     			ld hl,LFNNAME
 1134 6780 11 1D BD     			ld de,LFNNAME+1
 1135 6783 AF           			xor  a
 1136 6784 77           			ld (hl),a
 1137 6785 01 80 00     			ld bc,128
 1138 6788 ED B0        			ldir
 1139 678A D1           			pop de
 1140 678B E1           			pop hl
 1141 678C 21 00 00     pozice		ld hl,0
 1142 678F E5           			push hl
 1143 6790 CD 5B 65     			call FINDLFN
 1144 6793 E1           			pop hl
 1145 6794 23           			inc hl
 1146 6795 22 8D 67     			ld (pozice+1),hl
 1147 6798 11 00 5B     			ld de,23296
 1148 679B 21 1C BD     			ld hl,LFNNAME
 1149 679E CD 3A 61     			call search
 1150 67A1 28 14        			jr z,hsouhlasi
 1151 67A3              			; pop de
 1152 67A3              			; push de		;v de mame zacatek jmena souboru
 1153 67A3
 1154 67A3              			; ld h,d
 1155 67A3              			; ld l,e
 1156 67A3              			; add hl,13		;vynechana jedna polozka
 1157 67A3
 1158 67A3              			; ld hl,(actadr)
 1159 67A3              			; ex de,hl
 1160 67A3
 1161 67A3              			; ld bc,13	;1260*13
 1162 67A3              			; ldir
 1163 67A3
 1164 67A3 2A F3 79     			ld hl,(ALLFILES)
 1165 67A6 2B           			dec hl
 1166 67A7 22 F3 79     			ld (ALLFILES),hl
 1167 67AA E1           			pop hl
 1168 67AB 11 0D 00     			ld de,13
 1169 67AE 19           			add hl,de
 1170 67AF D1           			pop de
 1171 67B0 1B           			dec de
 1172 67B1 7A           			ld a,d
 1173 67B2 B3           			or e
 1174 67B3 20 9F        			jr nz,htestovani
 1175 67B5 18 3D        			jr hkon
 1176 67B7 2A 59 67     hsouhlasi	ld hl,(nalezeno+1)
 1177 67BA 23           			inc hl
 1178 67BB 22 59 67     			ld (nalezeno+1),hl
 1179 67BE
 1180 67BE 2A 8B 66     			ld hl,(actadr)
 1181 67C1 11 78 68     			ld de,vymenafile
 1182 67C4 01 0D 00     			ld bc,13
 1183 67C7 ED B0        			ldir				;ulož soubor, co bude vymazany
 1184 67C9
 1185 67C9 2A 8B 66     			ld hl,(actadr)
 1186 67CC D1           			pop de
 1187 67CD D5           			push de
 1188 67CE EB           			ex de,hl
 1189 67CF 01 0D 00     			ld bc,13
 1190 67D2 ED B0        			ldir			;nahrad
 1191 67D4
 1192 67D4 D1           			pop de
 1193 67D5 D5           			push de
 1194 67D6 21 78 68     			ld hl,vymenafile
 1195 67D9 01 0D 00     			ld bc,13
 1196 67DC ED B0        			ldir
 1197 67DE
 1198 67DE 2A 8B 66     			ld hl,(actadr)
 1199 67E1 11 0D 00     			ld de,13
 1200 67E4 19           			add hl,de
 1201 67E5 22 8B 66     			ld (actadr),hl
 1202 67E8
 1203 67E8 E1           			 pop hl
 1204 67E9 11 0D 00     			 ld de,13
 1205 67EC 19           			 add hl,de
 1206 67ED D1           			 pop de
 1207 67EE 1B           			 dec de
 1208 67EF 7A           			 ld a,d
 1209 67F0 B3           			 or e
 1210 67F1 C2 54 67     			 jp nz,htestovani
 1211 67F4              hkon
 1212 67F4 CD FD 6D     			 call GETDIR
 1213 67F7 2A F3 79     			 ld hl,(ALLFILES)
 1214 67FA
 1215 67FA 7C           			 ld a,h
 1216 67FB B5           			 or l
 1217 67FC CA 85 68     			 jp z,nula
 1218 67FF 21 C5 48     			 ld hl,18624+5
 1219 6802 22 0A 6D     			 ld (lfnpos+1),hl
 1220 6805 CD D0 6C     			 call getAllLFN
 1221 6808 21 98 48     			 ld hl,18560+24
 1222 680B 22 0A 6D     			 ld (lfnpos+1),hl
 1223 680E
 1224 680E 21 00 00     			 ld hl,0
 1225 6811 22 DB 75     			 ld (apos_all),hl
 1226 6814 AF           			 xor a
 1227 6815 32 31 75     			 ld (POS_F + 1),a
 1228 6818
 1229 6818
 1230 6818 21 0D 80     			 ld hl,catbuff+#d
 1231 681B 22 F9 78     		     ld (WRBUFF+1),hl
 1232 681E CD C2 77     			 call kresli
 1233 6821
 1234 6821
 1235 6821              			;call loadscr
 1236 6821 21 20 40     		    ld   hl,16416
 1237 6824 01 0E 14     		    ld   bc,20*256+14
 1238 6827 3E 0F        		    ld   a,%00001111
 1239 6829 CD F0 76     		    call RAMECEK
 1240 682C CD 2A 65     			 call BUFF83
 1241 682F CD E3 78     			call WRFILES
 1242 6832 11 2F 48     			ld de,18464+15
 1243 6835 21 25 7F     			ld hl,txtcurrentfile
 1244 6838 CD CD 7A     			call print
 1245 683B
 1246 683B 11 0F 48     			ld de,18432+15
 1247 683E 21 1A 7F     			ld hl,txtallfiles
 1248 6841 CD CD 7A     			call print
 1249 6844 11 6F 50     			ld de,20576+15
 1250 6847 21 76 66     			ld hl,txtFilter
 1251 684A CD CD 7A     			call print
 1252 684D              TISK
 1253 684D 11 4F 50     			ld de,20544+15
 1254 6850 21 AA 6F     			ld hl,lfndir
 1255 6853 CD CD 7A     			call print
 1256 6856 11 52 50     			ld de,20544+15+3
 1257 6859 21 E9 6D     			ld hl,NAZEVADRESARE
 1258 685C CD CD 7A     			call print
 1259 685F
 1260 685F CD 1B 65     			call LFNWINDOW
 1261 6862 CD BA 65     			call LFNPRINT
 1262 6865 21 41 BD     			ld hl,LFNNAME + maxline
 1263 6868 36 00        			ld (hl),0
 1264 686A 21 1C BD     			ld hl,LFNNAME
 1265 686D 11 C2 50     			ld de,20672+2
 1266 6870 CD CD 7A     			call print
 1267 6873
 1268 6873
 1269 6873 ED 91 07 00   			 nextreg #07,0			;3,5 MHz
 1270 6877
 1271 6877 C9           			 ret
 1272 6878 00 00 00...  vymenafile	ds 13
 1273 6885              nula
 1274 6885 21 40 48             ld   hl,18496
 1275 6888 01 20 06             ld   bc,6*256+32
 1276 688B 3E 07                ld   a,%00000111
 1277 688D CD F0 76             call RAMECEK
 1278 6890
 1279 6890
 1280 6890 11 6A 48     		ld   de,18562+8-32
 1281 6893 21 C4 68          	ld hl,nulatxt
 1282 6896 CD CD 7A             call print
 1283 6899
 1284 6899              		; ld   de,18560+7
 1285 6899                   	; ld hl,reloadtxt
 1286 6899                      ; call print
 1287 6899
 1288 6899 11 C6 48     		ld   de,18624+6
 1289 689C 21 EC 68          	ld hl,presstxt
 1290 689F CD CD 7A             call print
 1291 68A2
 1292 68A2 2A 89 66     		ld hl,(savepoc)
 1293 68A5 22 F3 79     		ld (ALLFILES),hl
 1294 68A8 76           nula1	halt
 1295 68A9 AF           		XOR A ;test keyboard
 1296 68AA DB FE        		IN A,(#FE)
 1297 68AC 2F           		CPL
 1298 68AD E6 0F        		AND 15
 1299 68AF 28 F7        		JR Z,nula1
 1300 68B1 AF           		XOR A ;test keyboard
 1301 68B2 DB FE        		IN A,(#FE)
 1302 68B4 2F           		CPL
 1303 68B5 E6 0F        		AND 15
 1304 68B7 28 EF        		JR Z,nula1
 1305 68B9
 1306 68B9 CD 55 74     		call loadscr
 1307 68BC ED 91 07 00  		nextreg #07,0			;3,5 MHz
 1308 68C0 C9           		ret
 1309 68C1 C3 95 6D     		jp reload
 1310 68C4
 1311 68C4 4E 6F 74 68  nulatxt defb "Nothing found!",0
 1311 68C8 69 6E 67 20
 1311 68CC 66 6F 75 6E
 1311 68D0 64 21 00
 1312 68D3 49 20 6D 75  reloadtxt defb "I must reload directory!",0
 1312 68D7 73 74 20 72
 1312 68DB 65 6C 6F 61
 1312 68DF 64 20 64 69
 1312 68E3 72 65 63 74
 1312 68E7 6F 72 79 21
 1312 68EB 00
 1313 68EC 50 72 65 73  presstxt defb "Press any key to continue.",0
 1313 68F0 73 20 61 6E
 1313 68F4 79 20 6B 65
 1313 68F8 79 20 74 6F
 1313 68FC 20 63 6F 6E
 1313 6900 74 69 6E 75
 1313 6904 65 2E 00
 1314 6907 CD 55 74     end_hledej 	 call loadscr		;návrat pomocí klávesy EDIT
 1315 690A C9           			 ret
 1316 690B 00 00 00...  templfn		ds	129
 1317 698C              ;Posunutí o stránku výše - šipka doleva
 1318 698C              left
 1319 698C 2A DB 75     		ld hl,(apos_all)
 1320 698F 7C           		ld a,h
 1321 6990 B5           		or l
 1322 6991 C8           		ret z  			;skončí, pokud jsme na nultém souboru
 1323 6992
 1324 6992 3A 31 75     		ld a,(POS_F+1)
 1325 6995 B7           		or a
 1326 6996 28 32        		jr z,next_page_left
 1327 6998
 1328 6998 3A 31 75     		ld a,(POS_F+1)
 1329 699B 0E 0F                ld  c,%00001111
 1330 699D CD F6 79             call KURZOR			;smaž kurzor
 1331 69A0
 1332 69A0 3A 31 75     		ld a,(POS_F+1)
 1333 69A3 5F           		ld e,a
 1334 69A4 16 00        		ld d,0
 1335 69A6 2A DB 75     		ld hl,(apos_all)
 1336 69A9 B7           		or a
 1337 69AA ED 52        		sbc hl,de
 1338 69AC 22 DB 75     		ld (apos_all),hl
 1339 69AF AF           		xor a
 1340 69B0 32 31 75     		ld (POS_F+1),a
 1341 69B3 0E 17                ld   c,%00010111
 1342 69B5 CD F6 79             call KURZOR
 1343 69B8 CD BA 65     		call LFNPRINT
 1344 69BB 21 41 BD     		ld hl,LFNNAME + maxline
 1345 69BE 36 00        		ld (hl),0
 1346 69C0 21 1C BD     		ld hl,LFNNAME
 1347 69C3 11 C2 50     		ld de,20672+2
 1348 69C6 CD CD 7A     		call print
 1349 69C9
 1350 69C9 C9           		ret
 1351 69CA
 1352 69CA
 1353 69CA              next_page_left
 1354 69CA
 1355 69CA 2A DB 75     		ld hl,(apos_all)
 1356 69CD 11 11 00     		ld de,17
 1357 69D0 B7           		or a
 1358 69D1 ED 52        		sbc hl,de
 1359 69D3 38 24        		jr c,next_left1		;méně než 17
 1360 69D5 22 DB 75     		ld (apos_all),hl
 1361 69D8 06 0D        		ld b,13
 1362 69DA CD C4 6C     		call mull
 1363 69DD 11 0D 80     		ld de,catbuff+13
 1364 69E0 19           		add hl,de
 1365 69E1 22 F9 78     		ld (WRBUFF+1),hl
 1366 69E4 CD E3 78     		call WRFILES
 1367 69E7 CD BA 65     		call LFNPRINT
 1368 69EA 21 41 BD     		ld hl,LFNNAME + maxline
 1369 69ED 36 00        		ld (hl),0
 1370 69EF 21 1C BD     		ld hl,LFNNAME
 1371 69F2 11 C2 50     		ld de,20672+2
 1372 69F5 CD CD 7A     		call print
 1373 69F8
 1374 69F8
 1375 69F8 C9           		ret
 1376 69F9              next_left1
 1377 69F9 21 00 00     		ld hl,0
 1378 69FC 22 DB 75     		ld (apos_all),hl
 1379 69FF 21 0D 80     		ld hl,catbuff+13
 1380 6A02 22 F9 78     		ld (WRBUFF+1),hl
 1381 6A05 CD E3 78     		call WRFILES
 1382 6A08 CD BA 65     		call LFNPRINT
 1383 6A0B 21 41 BD     		ld hl,LFNNAME + maxline
 1384 6A0E 36 00        		ld (hl),0
 1385 6A10 21 1C BD     		ld hl,LFNNAME
 1386 6A13 11 C2 50     		ld de,20672+2
 1387 6A16 CD CD 7A     		call print
 1388 6A19
 1389 6A19 C9           		ret
 1390 6A1A
 1391 6A1A              ; Posunutí o stránku níž - šipka doprava
 1392 6A1A              right
 1393 6A1A 2A F3 79     		ld hl,(ALLFILES)
 1394 6A1D 2B           		dec hl
 1395 6A1E
 1396 6A1E 1E 11        		ld e,17
 1397 6A20 16 00        		ld d,0
 1398 6A22 B7           		or a
 1399 6A23 ED 52        		sbc hl,de
 1400 6A25 19           		add hl,de
 1401 6A26 DA 62 6C     		jp c,posledni
 1402 6A29
 1403 6A29 3A 31 75     		ld a,(POS_F+1)
 1404 6A2C FE 11        		cp 17
 1405 6A2E CA FA 6B     		jp z,next_page
 1406 6A31
 1407 6A31 3A 31 75     		ld  a,(POS_F+1)		;na konec stránky
 1408 6A34 F5           		push af
 1409 6A35 0E 0F                ld  c,%00001111
 1410 6A37 CD F6 79             call KURZOR
 1411 6A3A 3E 11        		ld a,17
 1412 6A3C 32 31 75     		ld (POS_F+1),a
 1413 6A3F 2A DB 75     		ld hl,(apos_all)
 1414 6A42 C1           		pop bc
 1415 6A43 F5           		push af
 1416 6A44 3E 11        		ld a,17
 1417 6A46 B7           		or a
 1418 6A47 98           		sbc a,b
 1419 6A48 5F           		ld e,a
 1420 6A49 16 00        		ld d,0
 1421 6A4B 19           		add hl,de
 1422 6A4C 22 DB 75     		ld (apos_all),hl
 1423 6A4F 0E 17                ld   c,%00010111
 1424 6A51 F1           		pop af
 1425 6A52 CD F6 79             call KURZOR
 1426 6A55 CD BA 65     		call LFNPRINT
 1427 6A58 21 41 BD     		ld hl,LFNNAME + maxline
 1428 6A5B 36 00        		ld (hl),0
 1429 6A5D 21 1C BD     		ld hl,LFNNAME
 1430 6A60 11 C2 50     		ld de,20672+2
 1431 6A63 CD CD 7A     		call print
 1432 6A66
 1433 6A66 C9           		ret
 1434 6A67
 1435 6A67
 1436 6A67              reload_dir
 1437 6A67
 1438 6A67 F3           			di
 1439 6A68 CD 2A 65     			call BUFF83
 1440 6A6B 21 00 80     			ld hl,#8000
 1441 6A6E 11 01 80     			ld de,#8001
 1442 6A71 01 00 04     			ld bc,1024
 1443 6A74 AF           			xor a
 1444 6A75 77           			ld (hl),a
 1445 6A76 ED B0        			ldir
 1446 6A78
 1447 6A78 01 FD 7F     			ld bc,port1       ;the horizontal ROM switch/RAM
 1448 6A7B                                              ;switch I/O ad dress
 1449 6A7B 3A 5C 5B                 ld a,(bankm)      ;sys tem vari able that holds cur rent
 1450 6A7E                                              ;switch state
 1451 6A7E CB A7                    res 4,a           ;move right to left in hor i zon tal
 1452 6A80                                              ;ROM switch (3 to 2)
 1453 6A80
 1454 6A80 F6 07                      or 7              ;switch in RAM page 7
 1455 6A82 32 5C 5B                   ld (bankm),a      ;must keep sys tem vari able up to
 1456 6A85                            	                  ;date (very im por tant)
 1457 6A85 ED 79                      out (c),a         ;make the switch
 1458 6A87
 1459 6A87                                             ;be low BFE0h
 1460 6A87 FB                         ei                ;in ter rupts can now be en abled
 1461 6A88
 1462 6A88 21 00 80                   ld hl,catbuff     ;some where for DOS to put the cata
 1463 6A8B                                              ;log
 1464 6A8B 11 01 80                   ld de,catbuff+1   ;
 1465 6A8E 01 00 04                   ld bc,1024        ;max i mum (for +3DOS) is ac tu ally
 1466 6A91                                              ;64x13+13 = 845
 1467 6A91 36 00                      ld (hl),0
 1468 6A93 ED B0                      ldir              ;make sure at least first en try is
 1469 6A95 11 00 80                   ld de,catbuff     ;the lo ca tion to be filled with the
 1470 6A98              aNextDirItem
 1471 6A98 06 E7                      ld b,pocetpolozek ;the num ber of en tries in the
 1472 6A9A                                              ;buffer
 1473 6A9A 0E 04                      ld c,%100            ;include sys tem files in the cata
 1474 6A9C 21 37 66                   ld hl,stardstar   ;the file name ("*.*")
 1475 6A9F CD 1E 01                   call dos_catalog  ;call the DOS en try
 1476 6AA2              NEXT0
 1477 6AA2 22 AD 61                   ld (savehl),hl
 1478 6AA5 DD 22 AF 61  			  ld (saveix),ix
 1479 6AA9 78           			  ld a,b
 1480 6AAA FE E7        			  cp pocetpolozek
 1481 6AAC F5           			  push af
 1482 6AAD
 1483 6AAD 2A F3 79     			  ld hl,(ALLFILES)
 1484 6AB0 58           			  ld e,b
 1485 6AB1 16 00        			  ld d,0
 1486 6AB3 19           			  add hl,de
 1487 6AB4 2B           			  dec hl
 1488 6AB5 22 F3 79     			  ld (ALLFILES),hl
 1489 6AB8
 1490 6AB8 E5           			push hl
 1491 6AB9 D5           			push de
 1492 6ABA C5           			push bc
 1493 6ABB
 1494 6ABB
 1495 6ABB 2A 19 65     			ld hl,(dirNum)
 1496 6ABE 19           			add	hl,de
 1497 6ABF 2B           			dec hl
 1498 6AC0 22 19 65     			ld 	(dirNum),hl
 1499 6AC3 11 78 48     			ld de,18528+24
 1500 6AC6 ED 53 FD 64  			ld (NUMPOS+1),de
 1501 6ACA
 1502 6ACA CD CA 64     			call DEC16
 1503 6ACD 00 14        			defw 20*256
 1504 6ACF C1           			pop bc
 1505 6AD0 D1           			pop de
 1506 6AD1 E1           			pop hl
 1507 6AD2
 1508 6AD2
 1509 6AD2 3A F2 79     			  ld a,(FILES)
 1510 6AD5 80           			  add a,b
 1511 6AD6 3D           			  dec a
 1512 6AD7 32 F2 79     			  ld (FILES),a
 1513 6ADA F1           			  pop af
 1514 6ADB 38 15        			  jr c,acont
 1515 6ADD
 1516 6ADD 78           			  ld a,b
 1517 6ADE B7           			  or a
 1518 6ADF 28 11        			  jr z,acont
 1519 6AE1
 1520 6AE1 3A 0F 60     			  ld a,(virtmem)
 1521 6AE4 FE 04        			  cp 4
 1522 6AE6 28 0A        			  jr z,acont
 1523 6AE8
 1524 6AE8 CD A2 61     			  call CountMemory
 1525 6AEB EB           			  ex de,hl
 1526 6AEC 21 0F 60     			ld hl,virtmem
 1527 6AEF 34           			inc (hl)
 1528 6AF0 18 A6        			jr aNextDirItem
 1529 6AF2              acont
 1530 6AF2 F5                       push af
 1531 6AF3
 1532 6AF3 2A 19 65     			ld hl,(dirNum)
 1533 6AF6 11 78 48     			ld de,18528+24
 1534 6AF9 ED 53 FD 64  			ld (NUMPOS+1),de
 1535 6AFD 76           			halt
 1536 6AFE CD CA 64     			call DEC16
 1537 6B01 00 14        			defw 20*256
 1538 6B03
 1539 6B03 E1                         pop hl
 1540 6B04 22 3D 66                   ld (dosret),hl    ;put it where it can be seen from
 1541 6B07                                              ; NextBASIC
 1542 6B07 48                         ld c,b            ;move num ber of files in cat a log to
 1543 6B08                                              ;low byte of BC
 1544 6B08 06 00                      ld b,0            ;this will be re turned in NextBASIC
 1545 6B0A
 1546 6B0A F3                         di                ;about to ROM/RAM switch so be
 1547 6B0B                                              ;care ful
 1548 6B0B C5                         push bc           ;save num ber of files
 1549 6B0C 01 FD 7F                   ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 1550 6B0F                                              ;switch
 1551 6B0F 3A 5C 5B                   ld a,(bankm)      ;get cur rent switch state
 1552 6B12
 1553 6B12
 1554 6B12 CB E7                      set 4,a           ;move left to right (ROM 2 to ROM
 1555 6B14                                              ;3)
 1556 6B14 E6 F8                      and #F8           ;also want RAM page 0
 1557 6B16 32 5C 5B                   ld (bankm),a      ;up date the sys tem vari able (very
 1558 6B19                                              ;im por tant)
 1559 6B19 ED 79                      out (c),a         ;make the switch
 1560 6B1B C1                         pop bc            ;get back the saved num ber of files
 1561 6B1C 0B                         dec bc
 1562 6B1D
 1563 6B1D
 1564 6B1D
 1565 6B1D CD 2A 65     			 call BUFF83
 1566 6B20              JKJK
 1567 6B20 21 0D 80     			 ld hl,catbuff+13
 1568 6B23 ED 5B F3 79  			 ld de,(ALLFILES)
 1569 6B27 ED 53 10 60  			 ld (save_allfiles),de
 1570 6B2B              ;			 dec de
 1571 6B2B D5           atestovani	 push de
 1572 6B2C E5           			 push hl
 1573 6B2D DD E1        			 pop ix
 1574 6B2F DD E5        			 push ix
 1575 6B31 DD CB 07 7E  			 bit 7,(ix+7)
 1576 6B35              ;			 pop hl
 1577 6B35 20 53        			 jr nz,asouhlasi
 1578 6B37
 1579 6B37 11 08 00     			 ld de,8
 1580 6B3A 19           			 add hl,de		;v HL je začátek přípony souboru
 1581 6B3B E5           			 push hl
 1582 6B3C 11 99 73     			 ld de,PT2
 1583 6B3F CD 8F 61     			 call compare
 1584 6B42 E1           			 pop hl
 1585 6B43 28 45        			 jr z,asouhlasi
 1586 6B45 E5           			 push hl
 1587 6B46 11 9C 73     			 ld de,PT3
 1588 6B49 CD 8F 61     			 call compare
 1589 6B4C E1           			 pop hl
 1590 6B4D 28 3B        			 jr z,asouhlasi
 1591 6B4F 11 9F 73     			 ld de,SQT
 1592 6B52 E5           			 push hl
 1593 6B53 CD 8F 61     			 call compare
 1594 6B56 E1           			 pop hl
 1595 6B57 28 31        			 jr z,asouhlasi
 1596 6B59
 1597 6B59 11 A2 73     			 ld de,STC
 1598 6B5C E5           			 push hl
 1599 6B5D CD 8F 61     			 call compare
 1600 6B60 E1           			 pop hl
 1601 6B61 28 27        			 jr z,asouhlasi
 1602 6B63
 1603 6B63 11 A5 73      			 ld de,STP
 1604 6B66 E5           			 push hl
 1605 6B67 CD 8F 61     			 call compare
 1606 6B6A E1           			 pop hl
 1607 6B6B 28 1D        			 jr z,asouhlasi
 1608 6B6D
 1609 6B6D D1           			 pop de
 1610 6B6E D5           			 push de		;v de mame zacatek jmena souboru
 1611 6B6F 62           			 ld h,d
 1612 6B70 6B           			 ld l,e
 1613 6B71 ED 34 0D 00  			 add hl,13		;vynechana jedna polozka
 1614 6B75 01 36 2E     			 ld bc,910*13
 1615 6B78 ED B0        			 ldir
 1616 6B7A
 1617 6B7A 2A F3 79     			 ld hl,(ALLFILES)
 1618 6B7D 2B           			 dec hl
 1619 6B7E 22 F3 79     			 ld (ALLFILES),hl
 1620 6B81 E1           			 pop hl
 1621 6B82 D1           			 pop de
 1622 6B83 1B           			 dec de
 1623 6B84 7A           			 ld a,d
 1624 6B85 B3           			 or e
 1625 6B86 20 A3        			 jr nz,atestovani
 1626 6B88 18 0B        			 jr askon
 1627 6B8A              asouhlasi
 1628 6B8A E1           			 pop hl
 1629 6B8B 11 0D 00     			 ld de,13
 1630 6B8E 19           			 add hl,de
 1631 6B8F D1           			 pop de
 1632 6B90 1B           			 dec de
 1633 6B91 7A           			 ld a,d
 1634 6B92 B3           			 or e
 1635 6B93 20 96        			 jr nz,atestovani
 1636 6B95 FB           askon		ei
 1637 6B96
 1638 6B96 11 84 48     			 ld de,18560+4
 1639 6B99 21 8D 6C     			 ld hl,txtLFNinfo
 1640 6B9C CD CD 7A     			 call print
 1641 6B9F CD D0 6C     			 call getAllLFN
 1642 6BA2 CD FD 6D     			call GETDIR
 1643 6BA5 21 00 40     			 ld hl,16384
 1644 6BA8 11 01 40     			 ld de,16385
 1645 6BAB 01 FF 17     			 ld bc,6143
 1646 6BAE AF           			 xor a
 1647 6BAF 77           			 ld (hl),a
 1648 6BB0 ED B0        			 ldir
 1649 6BB2
 1650 6BB2 CD 3B 65     			 call NOBUFF83
 1651 6BB5
 1652 6BB5 CD C2 77                  call kresli
 1653 6BB8
 1654 6BB8 21 0D 80     			 ld hl,catbuff+#d
 1655 6BBB 22 F9 78     		     ld (WRBUFF+1),hl
 1656 6BBE
 1657 6BBE CD E3 78                  call WRFILES      ;vypis soubory
 1658 6BC1 11 2F 48     			 ld de,18464+15
 1659 6BC4 21 25 7F     			 ld hl,txtcurrentfile
 1660 6BC7 CD CD 7A     			 call print
 1661 6BCA
 1662 6BCA 11 0F 48     			 ld de,18432+15
 1663 6BCD 21 1A 7F     			 ld hl,txtallfiles
 1664 6BD0 CD CD 7A     			 call print
 1665 6BD3
 1666 6BD3
 1667 6BD3 11 4F 50     			ld de,20544+15
 1668 6BD6 21 AA 6F     			ld hl,lfndir
 1669 6BD9 CD CD 7A     			call print
 1670 6BDC 11 52 50     			ld de,20544+15+3
 1671 6BDF 21 E9 6D     			ld hl,NAZEVADRESARE
 1672 6BE2 CD CD 7A     			call print
 1673 6BE5
 1674 6BE5
 1675 6BE5 CD 1B 65     			call LFNWINDOW
 1676 6BE8 CD BA 65     			call LFNPRINT
 1677 6BEB 21 41 BD     			ld hl,LFNNAME + maxline
 1678 6BEE 36 00        			ld (hl),0
 1679 6BF0 21 1C BD     			ld hl,LFNNAME
 1680 6BF3 11 C2 50     			ld de,20672+2
 1681 6BF6 CD CD 7A     			call print
 1682 6BF9
 1683 6BF9 C9           		ret
 1684 6BFA
 1685 6BFA
 1686 6BFA              next_page
 1687 6BFA 2A DB 75     		ld hl,(apos_all)
 1688 6BFD 23           		inc hl
 1689 6BFE              		;test jestli už není víc souborů
 1690 6BFE
 1691 6BFE EB           		ex de,hl			;de ... aktualni pozice začátku výpisu
 1692 6BFF 2A F3 79     		ld hl,(ALLFILES)	;hl ... pocet souboru
 1693 6C02 D5           		push de
 1694 6C03 11 12 00     		ld de,18			;odečti počet na jednu stránku
 1695 6C06 B7           		or a
 1696 6C07 ED 52        		sbc hl,de			;hl ... počet souborů - 18
 1697 6C09 D1           		pop de				;de ... aktuální pozice
 1698 6C0A B7           		or a
 1699 6C0B ED 52        		sbc hl,de
 1700 6C0D 30 10        		jr nc, next2
 1701 6C0F 2A F3 79     		ld hl,(ALLFILES)
 1702 6C12 B7           		or a
 1703 6C13 11 11 00     		ld de,17
 1704 6C16 ED 52        		sbc hl,de
 1705 6C18 3E 01        		ld a,1
 1706 6C1A 32 61 6C     		ld (maxfile),a
 1707 6C1D 18 08        		jr next3
 1708 6C1F              next2
 1709 6C1F 2A DB 75     		ld hl,(apos_all)
 1710 6C22 23           		inc hl
 1711 6C23 AF           		xor a
 1712 6C24 32 61 6C     		ld (maxfile),a
 1713 6C27              next3
 1714 6C27 06 0D        		ld b,13
 1715 6C29 CD C4 6C     		call mull
 1716 6C2C 11 00 80     		ld de,catbuff ;+13
 1717 6C2F 19           		add hl,de
 1718 6C30 22 F9 78     		ld (WRBUFF+1),hl
 1719 6C33 CD E3 78     		call WRFILES
 1720 6C36 3A 61 6C     		ld a,(maxfile)
 1721 6C39 B7           		or a
 1722 6C3A 20 0C        		jr nz,next4
 1723 6C3C 2A DB 75     		ld hl,(apos_all)
 1724 6C3F 11 11 00     		ld de,17
 1725 6C42 19           		add hl,de
 1726 6C43 22 DB 75     		ld (apos_all),hl
 1727 6C46 18 07        		jr next5
 1728 6C48 2A F3 79     next4	ld hl,(ALLFILES)
 1729 6C4B 2B           		dec hl
 1730 6C4C 22 DB 75     		ld (apos_all),hl
 1731 6C4F CD BA 65     next5	call LFNPRINT
 1732 6C52 21 41 BD     		ld hl,LFNNAME + maxline
 1733 6C55 36 00        		ld (hl),0
 1734 6C57 21 1C BD     		ld hl,LFNNAME
 1735 6C5A 11 C2 50     		ld de,20672+2
 1736 6C5D CD CD 7A     		call print
 1737 6C60
 1738 6C60 C9           		ret
 1739 6C61 00           maxfile	db 0
 1740 6C62              posledni					;méně souborů než 17
 1741 6C62 3A 31 75     	     ld  a,(POS_F+1)
 1742 6C65 0E 0F                 ld  c,%00001111
 1743 6C67 CD F6 79              call KURZOR
 1744 6C6A 2A F3 79     		 ld hl,(ALLFILES)
 1745 6C6D 2B           		 dec hl
 1746 6C6E 7D           		 ld a,l
 1747 6C6F 32 31 75     		 ld (POS_F+1),a
 1748 6C72
 1749 6C72 22 DB 75     		 ld (apos_all),hl
 1750 6C75 0E 17                 ld   c,%00010111
 1751 6C77 CD F6 79              call KURZOR
 1752 6C7A CD BA 65     		 call LFNPRINT
 1753 6C7D 21 41 BD     		ld hl,LFNNAME + maxline
 1754 6C80 36 00        		ld (hl),0
 1755 6C82 21 1C BD     		ld hl,LFNNAME
 1756 6C85 11 C2 50     		ld de,20672+2
 1757 6C88 CD CD 7A     		call print
 1758 6C8B
 1759 6C8B C9           		 ret
 1760 6C8C
 1761 6C8C
 1762 6C8C              right1
 1763 6C8C
 1764 6C8C
 1765 6C8C C9           		ret
 1766 6C8D
 1767 6C8D 47 65 74 74  txtLFNinfo defb "Getting LFN information:",0
 1767 6C91 69 6E 67 20
 1767 6C95 4C 46 4E 20
 1767 6C99 69 6E 66 6F
 1767 6C9D 72 6D 61 74
 1767 6CA1 69 6F 6E 3A
 1767 6CA5 00
 1768 6CA6 52 65 61 64  txtStart   defb "Reading files in directory:",0
 1768 6CAA 69 6E 67 20
 1768 6CAE 66 69 6C 65
 1768 6CB2 73 20 69 6E
 1768 6CB6 20 64 69 72
 1768 6CBA 65 63 74 6F
 1768 6CBE 72 79 3A 00
 1769 6CC2              ;Nacte LFN vsech souboru nahranych v pameti
 1770 6CC2
 1771 6CC2 00 00        numLoop		defw 0
 1772 6CC4
 1773 6CC4
 1774 6CC4
 1775 6CC4              ; Násobení HL x B
 1776 6CC4              ; Vysledek HL
 1777 6CC4 55           mull		ld d,l		;vynásob spodní byty
 1778 6CC5 58           			ld e,b		;
 1779 6CC6 ED 30        			mul d,e		;vysledek je v de
 1780 6CC8 EB           			ex de,hl	;vysledek je v hl
 1781 6CC9 58           			ld e,b		;násobitel do e
 1782 6CCA ED 30        			mul d,e		;vynásob
 1783 6CCC 7B           			ld a,e		;do akumulátoru hoď výsledek (spodní byte)
 1784 6CCD 84           			add a,h
 1785 6CCE 67           			ld h,a		;konečný výsledek je v HL
 1786 6CCF C9           			ret
 1787 6CD0
 1788 6CD0              ; Tato rutina naplní banky ZX Next LFN jmény souborů,
 1789 6CD0              ; o délce 128bytů.
 1790 6CD0 FB           getAllLFN	ei
 1791 6CD1 21 00 00     			ld hl,0
 1792 6CD4 22 C2 6C     			ld (numLoop),hl
 1793 6CD7 21 00 E0     			ld hl,#e000
 1794 6CDA 22 32 6D     			ld (InBuff+1),hl
 1795 6CDD 3E 18        			ld a,24
 1796 6CDF 32 2D 6D     			ld (Page+1),a
 1797 6CE2 CD 41 74     			call savescr
 1798 6CE5
 1799 6CE5 CD 2A 65     			call BUFF83
 1800 6CE8 21 0D 80     			ld hl,catbuff+#d
 1801 6CEB 11 86 6D     			ld de,bufftmp
 1802 6CEE 01 0D 00     			ld bc,13
 1803 6CF1 ED B0        			ldir
 1804 6CF3 CD 3B 65     			call NOBUFF83
 1805 6CF6
 1806 6CF6 21 0D 80     			ld hl,catbuff+#d
 1807 6CF9 22 84 6D     			ld (tmpname),hl
 1808 6CFC ED 4B F3 79  			ld bc,(ALLFILES)
 1809 6D00 C5           LFN1		push bc
 1810 6D01 FB           			ei
 1811 6D02
 1812 6D02 2A C2 6C     			ld hl,(numLoop)
 1813 6D05 23           			inc hl
 1814 6D06 22 C2 6C     			ld 	(numLoop),hl
 1815 6D09 11 98 48     lfnpos			ld de,18560+24	;pozice ve VideoRam
 1816 6D0C ED 53 FD 64  			ld (NUMPOS+1),de
 1817 6D10 CD CA 64     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
 1818 6D13 00 14        			defw 20*256
 1819 6D15 F3           			di				;zakaž přerušení, jinak bude problém, nemáme nastránkovanou ZX Rom
 1820 6D16
 1821 6D16 D9           			exx
 1822 6D17              BFN
 1823 6D17 11 86 6D     BufferName	ld de,bufftmp			;jmeno souboru
 1824 6D1A 21 37 66     			ld hl,stardstar
 1825 6D1D DD 2A AD 61  			ld ix,(savehl)
 1826 6D21 01 1C BD     			ld bc,LFNNAME
 1827 6D24 D9           			exx
 1828 6D25 0E 07        			ld c,7
 1829 6D27 11 B7 01     			ld de,$01b7
 1830 6D2A CF           			rst 8			;služba EsxDosu, která volá službu +3Dosu (zjištění LFN konkrétního souboru)
 1831 6D2B 94           			defb M_P3DOS
 1832 6D2C 3E 18        Page		ld a,24
 1833 6D2E ED 92 57     			nextreg $57,a	;nastrankuj stranku s volnymi daty
 1834 6D31
 1835 6D31 11 00 E0     InBuff		ld de,#e000		;ukazatel na pamet v bufferu
 1836 6D34 21 1C BD     			ld hl,LFNNAME	;buffer pro LFN
 1837 6D37 01 80 00     			ld bc,maxlen		;ulož 64 bytů
 1838 6D3A ED B0        			ldir
 1839 6D3C
 1840 6D3C CD 2A 65     			call BUFF83
 1841 6D3F 2A 84 6D     			ld hl,(tmpname)	;přesuň se na další položku v adresáři
 1842 6D42 11 0D 00     			ld de,13
 1843 6D45 19           			add hl,de
 1844 6D46 22 84 6D     			ld (tmpname),hl	;a ulož adresu, kde se nachází
 1845 6D49 11 86 6D     			ld de,bufftmp
 1846 6D4C 01 0D 00     			ld bc,13
 1847 6D4F ED B0        			ldir
 1848 6D51
 1849 6D51 CD 3B 65     			call NOBUFF83
 1850 6D54
 1851 6D54 3A 2D 6D     			ld a,(Page+1)
 1852 6D57 ED 92 57     			nextreg $57,a
 1853 6D5A
 1854 6D5A 2A 32 6D     			ld hl,(InBuff+1)		;vypočti další adresu v bance ZX Next, kam budu ukládat
 1855 6D5D 11 80 00     			ld de,maxlen
 1856 6D60 19           			add hl,de
 1857 6D61 22 32 6D     			ld (InBuff+1),hl
 1858 6D64
 1859 6D64 11 7F FF     			ld de,#FFFF-128
 1860 6D67 B7           			or a
 1861 6D68 ED 52        			sbc hl,de
 1862 6D6A 38 0A        			jr c,contin
 1863 6D6C 21 2D 6D     			ld hl,Page+1
 1864 6D6F 34           			inc (hl)
 1865 6D70 21 00 E0     			ld hl,#e000
 1866 6D73 22 32 6D     			ld (InBuff+1),hl
 1867 6D76 C1           contin		pop bc				;zopakuj to pro všechny soubory, které máme načtené...
 1868 6D77 0B           			dec bc
 1869 6D78 78           			ld a,b
 1870 6D79 B1           			or c
 1871 6D7A 20 84        			jr nz,LFN1
 1872 6D7C
 1873 6D7C ED 91 57 01  			nextreg $57,1			;vráť zpátky stránku, kde se nachází data pro player
 1874 6D80 CD 55 74     			call loadscr			;obnov obrazovku
 1875 6D83 C9           			ret
 1876 6D84 00 00        tmpname		ds 2
 1877 6D86              BFT
 1878 6D86 00 00 00...  bufftmp		ds 15
 1879 6D95              M_P3DOS	equ $94
 1880 6D95              reload
 1881 6D95 ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 1882 6D99 21 42 48     		ld hl, 18496+2
 1883 6D9C 01 1C 04     		ld   bc,4*256+28
 1884 6D9F 3E 05        		ld   a,%00000101
 1885 6DA1 CD F0 76     		call RAMECEK
 1886 6DA4
 1887 6DA4 11 64 48     		ld de,18528+4
 1888 6DA7 21 A6 6C     		ld hl,txtStart
 1889 6DAA CD CD 7A     		call print
 1890 6DAD
 1891 6DAD 21 00 00     		ld hl,0
 1892 6DB0 22 F3 79     		ld (ALLFILES),hl
 1893 6DB3 22 19 65     		ld (dirNum),hl
 1894 6DB6 22 DB 75     		ld (apos_all),hl
 1895 6DB9 AF           		xor a
 1896 6DBA 32 31 75     		ld (POS_F+1),a
 1897 6DBD 32 0F 60     		ld (virtmem),a
 1898 6DC0 21 00 80     		ld hl,catbuff
 1899 6DC3 22 A6 61     		ld (Count11+1),hl
 1900 6DC6              		; ld hl,(save_allfiles)
 1901 6DC6              		; ld (ALLFILES),hl
 1902 6DC6 CD 67 6A     		call reload_dir
 1903 6DC9              		; ld de,18560+4
 1904 6DC9              			 ; ld hl,txtLFNinfo
 1905 6DC9              			 ; call print
 1906 6DC9              			 ; call getAllLFN
 1907 6DC9
 1908 6DC9              			 ; ld hl,16384
 1909 6DC9              			 ; ld de,16385
 1910 6DC9              			 ; ld bc,6143
 1911 6DC9              			 ; xor a
 1912 6DC9              			 ; ld (hl),a
 1913 6DC9              			 ; ldir
 1914 6DC9
 1915 6DC9
 1916 6DC9              			; call NOBUFF83
 1917 6DC9                           ; call kresli
 1918 6DC9
 1919 6DC9              			 ; ld hl,catbuff+#d
 1920 6DC9              		     ; ld (WRBUFF+1),hl
 1921 6DC9
 1922 6DC9                           ; call WRFILES      ;vypis soubory
 1923 6DC9              			 ; ld de,18464+15
 1924 6DC9              			 ; ld hl,txtcurrentfile
 1925 6DC9              			 ; call print
 1926 6DC9
 1927 6DC9              			 ; ld de,18432+15
 1928 6DC9              			 ; ld hl,txtallfiles
 1929 6DC9              			 ; call print
 1930 6DC9
 1931 6DC9              			; call LFNWINDOW
 1932 6DC9              			; call LFNPRINT
 1933 6DC9              			; ld hl,LFNNAME + maxline
 1934 6DC9              			; ld (hl),0
 1935 6DC9              			; ld hl,LFNNAME
 1936 6DC9              			; ld de,20672+2
 1937 6DC9              			; call print
 1938 6DC9
 1939 6DC9 ED 91 07 00  		nextreg #07,0             ;3,5 Mhz
 1940 6DCD C9           		ret
 1941 6DCE 00 00 00...  DIRNAME	defs 13
 1942 6DDB FF           		defb 255
 1943 6DDC 43 3A FF     DIRTMP  defb "C:",255
 1944 6DDF 00 00 00...  		ds 10
 1945 6DE9 00 00 00...  NAZEVADRESARE	ds 20
 1946 6DFD              GETDIR
 1947 6DFD 21 DC 6D     		ld hl,DIRTMP
 1948 6E00 11 0E BD     		ld de,modstart
 1949 6E03 01 04 00     		ld bc,4
 1950 6E06 ED B0        		ldir
 1951 6E08
 1952 6E08 01 FD 7F     		ld bc,port1
 1953 6E0B 3A 5C 5B             ld a,(bankm)      ;sys tem vari able that holds cur rent
 1954 6E0E CB A7                res 4,a           ;move right to left in hor i zon tal
 1955 6E10 F6 07                or 7              ;switch in RAM page 7
 1956 6E12 32 5C 5B             ld (bankm),a      ;must keep sys tem vari able up to
 1957 6E15 ED 79                out (c),a         ;make the switch
 1958 6E17
 1959 6E17 3E 01        		ld a,1				;get path
 1960 6E19 21 0E BD     		ld hl,modstart
 1961 6E1C CD B1 01     		call $01b1
 1962 6E1F
 1963 6E1F 38 04        		jr c,ok1
 1964 6E21 3E 02        EEEE	ld a,2
 1965 6E23 D3 FE        		out (254),a
 1966 6E25
 1967 6E25 01 FD 7F     ok1		ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 1968 6E28 3A 5C 5B             ld a,(bankm)      ;get cur rent switch state
 1969 6E2B CB E7                set 4,a           ;move left to right (ROM 2 to ROM
 1970 6E2D E6 F8                and #F8           ;also want RAM page 0
 1971 6E2F 32 5C 5B             ld (bankm),a      ;up date the sys tem vari able (very
 1972 6E32 ED 79                out (c),a         ;make the switch
 1973 6E34
 1974 6E34 21 0E BD     		ld hl,modstart
 1975 6E37 01 00 04     		ld bc,1024
 1976 6E3A 3E FF        		ld a,#ff
 1977 6E3C ED B1        		cpir
 1978 6E3E              AAA
 1979 6E3E 2B           		dec hl
 1980 6E3F 2B           		dec hl
 1981 6E40 2B           		dec hl
 1982 6E41
 1983 6E41 E5           		push hl
 1984 6E42 21 D2 6F     		ld hl,DIRBUFF
 1985 6E45 11 D3 6F     		ld de,DIRBUFF+1
 1986 6E48 01 0D 00     		ld bc,13
 1987 6E4B 3E 20        		ld a,32
 1988 6E4D 77           		ld (hl),a
 1989 6E4E ED B0        		ldir
 1990 6E50 E1           		pop hl
 1991 6E51
 1992 6E51
 1993 6E51 7E           pr1		ld a,(hl)
 1994 6E52 FE 2F        		cp "/"
 1995 6E54 28 08        		jr z,pr0
 1996 6E56 FE 3A        		cp ":"
 1997 6E58 CA AF 6F     		jp z,root
 1998 6E5B
 1999 6E5B 2B           		dec hl
 2000 6E5C 18 F3        		jr pr1
 2001 6E5E
 2002 6E5E
 2003 6E5E 23           pr0		inc hl
 2004 6E5F
 2005 6E5F 11 D2 6F     		ld de,DIRBUFF
 2006 6E62 06 08        		ld b,8
 2007 6E64              presun
 2008 6E64 7E           		ld a,(hl)
 2009 6E65 FE 2F        		cp "/"
 2010 6E67 28 05        		jr z,prk
 2011 6E69 12           		ld (de),a
 2012 6E6A 13           		inc de
 2013 6E6B 23           		inc hl
 2014 6E6C 10 F6        		djnz presun
 2015 6E6E
 2016 6E6E              prk
 2017 6E6E
 2018 6E6E 21 D2 6F     		ld hl,DIRBUFF
 2019 6E71 01 07 00     		ld bc,7
 2020 6E74 3E 2E        		ld a,"."
 2021 6E76
 2022 6E76 ED B1        		cpir
 2023 6E78 20 1E        		jr nz,PRK2
 2024 6E7A E5           		push hl
 2025 6E7B 11 DA 6F     		ld de,DIRBUFF+8
 2026 6E7E 01 04 00     		ld bc,4
 2027 6E81 ED B0        		ldir
 2028 6E83              PRK0
 2029 6E83 E1           		pop hl				;adresa s teckou v HL
 2030 6E84 2B           		dec hl
 2031 6E85 E5           		push hl
 2032 6E86 EB           		ex de,hl			;je v DE
 2033 6E87 21 D9 6F     		ld hl,DIRBUFF+7		;az kam
 2034 6E8A B7           		or a
 2035 6E8B ED 52        		sbc hl,de
 2036 6E8D E5           		push hl
 2037 6E8E C1           		pop bc				;počet bytu
 2038 6E8F E1           		pop hl
 2039 6E90 54           		ld d,h
 2040 6E91 5D           		ld e,l
 2041 6E92 13           		inc de
 2042 6E93 3E 20        		ld a,32
 2043 6E95 77           		ld (hl),a
 2044 6E96 ED B0        		ldir
 2045 6E98
 2046 6E98              PRK2
 2047 6E98 AF           		xor a
 2048 6E99 21 DD 6F     		ld hl,DIRBUFF+11
 2049 6E9C 77           		ld (hl),a
 2050 6E9D 23           		inc hl
 2051 6E9E 77           		ld (hl),a
 2052 6E9F 23           		inc hl
 2053 6EA0 77           		ld (hl),a
 2054 6EA1 23           		inc hl
 2055 6EA2 77           		ld (hl),a
 2056 6EA3 21 D9 6F     		ld hl,DIRBUFF+7
 2057 6EA6 CB FE        		set 7,(hl)
 2058 6EA8
 2059 6EA8 21 A7 6F     		ld hl,parrent
 2060 6EAB 22 7F 6F     		ld (goto+1),hl
 2061 6EAE              		;call gotodir
 2062 6EAE
 2063 6EAE 01 FD 7F     		ld bc,port1
 2064 6EB1 3A 5C 5B             ld a,(bankm)
 2065 6EB4 CB A7                res 4,a
 2066 6EB6 F6 07                or 7
 2067 6EB8 32 5C 5B             ld (bankm),a
 2068 6EBB ED 79                out (c),a
 2069 6EBD
 2070 6EBD AF           		xor a
 2071 6EBE 21 A7 6F     		ld hl,parrent
 2072 6EC1 CD B1 01     		call $01b1				;skoc do nadrizeneho adresare
 2073 6EC4
 2074 6EC4 ED 91 54 16  		nextreg $54,22
 2075 6EC8 ED 91 55 17  		nextreg $55,23
 2076 6ECC 21 00 80     		ld hl,32768
 2077 6ECF 22 D7 6E     		ld (FF+1),hl
 2078 6ED2 AF           		xor a
 2079 6ED3 32 0F 60     		ld (virtmem),a
 2080 6ED6
 2081 6ED6
 2082 6ED6
 2083 6ED6 11 00 80     FF		ld de,32768
 2084 6ED9 06 E7                ld b,pocetpolozek
 2085 6EDB 21 37 66             ld hl,stardstar
 2086 6EDE 0E 04        		ld c,%100
 2087 6EE0 CD 1E 01     		call dos_catalog
 2088 6EE3 3E E7        		ld a,pocetpolozek
 2089 6EE5 A8           		xor b
 2090 6EE6 20 15        		jr nz,PRK4
 2091 6EE8 2A D7 6E     		ld hl,(FF+1)
 2092 6EEB 11 BB 0B     		ld de,pocetpolozek*13
 2093 6EEE 19           		add hl,de
 2094 6EEF 22 D7 6E     		ld (FF+1),hl
 2095 6EF2 21 0F 60     		ld hl,virtmem
 2096 6EF5 34           		inc (hl)
 2097 6EF6 7E           		ld a,(hl)
 2098 6EF7 EE 04        		xor 4
 2099 6EF9 28 02        		jr z,PRK4
 2100 6EFB 18 D9        		jr FF
 2101 6EFD
 2102 6EFD              PRK4
 2103 6EFD 11 D2 6F     		ld de,DIRBUFF			;jmeno souboru
 2104 6F00 21 37 66     		ld hl,stardstar
 2105 6F03 DD 2A AD 61  		ld ix,(savehl)
 2106 6F07 01 1C BD     		ld bc,LFNNAME
 2107 6F0A CD B7 01     		call	$01b7
 2108 6F0D
 2109 6F0D              						;skoc zpatky do adresare
 2110 6F0D 21 D9 6F     		ld hl,DIRBUFF+7
 2111 6F10 CB BE        		res 7,(hl)
 2112 6F12 3E FF        		ld a,255
 2113 6F14 32 DD 6F     		ld (DIRBUFF+11),a
 2114 6F17 21 D2 6F     		ld hl,DIRBUFF
 2115 6F1A AF           		xor a
 2116 6F1B CD B1 01     		call $01b1
 2117 6F1E
 2118 6F1E              		; ld hl,32768
 2119 6F1E              		; ld (FF2+1),hl
 2120 6F1E
 2121 6F1E              ;FF2	ld de,32768
 2122 6F1E                      ; ld b,pocetpolozek
 2123 6F1E                      ; ld hl,stardstar
 2124 6F1E              		; ld c,%101
 2125 6F1E                      ; call dos_catalog  ;call the DOS en try
 2126 6F1E              		; ld a,pocetpolozek
 2127 6F1E              		; xor b
 2128 6F1E              		; jr nz,PRK40
 2129 6F1E              		; ld hl,(FF+1)
 2130 6F1E              		; ld de,pocetpolozek*13
 2131 6F1E              		; add hl,de
 2132 6F1E              		; ld (FF2+1),hl
 2133 6F1E              		; jr FF2
 2134 6F1E              ; PRK40
 2135 6F1E
 2136 6F1E 01 FD 7F     		ld bc,port1
 2137 6F21 3A 5C 5B             ld a,(bankm)
 2138 6F24 CB E7                set 4,a
 2139 6F26 E6 F8                and #F8
 2140 6F28 32 5C 5B             ld (bankm),a
 2141 6F2B ED 79                out (c),a
 2142 6F2D              PRK5
 2143 6F2D 21 1C BD     		ld hl,LFNNAME
 2144 6F30 01 80 00     		ld bc,128
 2145 6F33 3E FF        		ld a,#ff
 2146 6F35 ED B1        		cpir
 2147 6F37 2B           		dec hl
 2148 6F38 36 00        		ld (hl),0
 2149 6F3A AF           		xor a
 2150 6F3B 32 2B BD     		ld (LFNNAME+15),a
 2151 6F3E 11 4F 50     		ld de,20544+15
 2152 6F41 21 AA 6F     		ld hl,lfndir
 2153 6F44 CD CD 7A     		call print
 2154 6F47 3E 20        		ld a,32
 2155 6F49 32 1B BD     		ld (LFNNAME-1),a
 2156 6F4C 11 52 50     		ld de,20544+15+3
 2157 6F4F 21 1B BD     		ld hl,LFNNAME-1
 2158 6F52              		;call print
 2159 6F52
 2160 6F52 21 1B BD     		ld hl,LFNNAME-1
 2161 6F55 11 E9 6D     		ld de,NAZEVADRESARE
 2162 6F58 01 14 00     		ld bc,20
 2163 6F5B ED B0        		ldir
 2164 6F5D
 2165 6F5D 21 D2 6F     		ld hl,DIRBUFF
 2166 6F60 22 7F 6F     		ld (goto+1),hl
 2167 6F63 3E FF        		ld a,255
 2168 6F65 32 DD 6F     		ld (DIRBUFF+11),a
 2169 6F68 21 D9 6F     		ld hl,DIRBUFF+7
 2170 6F6B CB BE        		res 7,(hl)
 2171 6F6D              ;		call gotodir
 2172 6F6D
 2173 6F6D C9           		ret
 2174 6F6E              GOTODIR
 2175 6F6E              gotodir
 2176 6F6E 01 FD 7F     		ld bc,port1
 2177 6F71 3A 5C 5B             ld a,(bankm)
 2178 6F74 CB A7                res 4,a
 2179 6F76 F6 07                or 7
 2180 6F78 32 5C 5B             ld (bankm),a
 2181 6F7B ED 79                out (c),a
 2182 6F7D
 2183 6F7D AF           		xor a
 2184 6F7E 21 A7 6F     goto	ld hl,parrent
 2185 6F81 CD B1 01     		call $01b1
 2186 6F84
 2187 6F84 38 04        		jr c,gok
 2188 6F86 3E 02        		ld a,2
 2189 6F88 D3 FE        		out (254),a
 2190 6F8A 01 FD 7F     gok		ld bc,port1
 2191 6F8D 3A 5C 5B             ld a,(bankm)
 2192 6F90 CB E7                set 4,a
 2193 6F92 E6 F8                and #F8
 2194 6F94 32 5C 5B             ld (bankm),a
 2195 6F97 ED 79                out (c),a
 2196 6F99 C9           		ret
 2197 6F9A
 2198 6F9A 41 7E 31 20  testpolozky defb "A~1    ",#a0,"POP",0,0
 2198 6F9E 20 20 20 A0
 2198 6FA2 50 4F 50 00
 2198 6FA6 00
 2199 6FA7
 2200 6FA7 2E 2E FF     parrent 	defb 	"..",#ff
 2201 6FAA
 2202 6FAA 44 69 72 3A  lfndir		defb "Dir:", 0
 2202 6FAE 00
 2203 6FAF              root
 2204 6FAF 3E 20        		ld a,32
 2205 6FB1 32 1C BD     		ld (LFNNAME),a
 2206 6FB4 3E 2F        		ld a,"/"
 2207 6FB6 32 1D BD     		ld (LFNNAME+1),a
 2208 6FB9 AF           		xor a
 2209 6FBA 32 1E BD     		ld (LFNNAME+2),a
 2210 6FBD 11 4F 50     		ld de,20544+15
 2211 6FC0 21 AA 6F     		ld hl,lfndir
 2212 6FC3 CD CD 7A     		call print
 2213 6FC6 21 1C BD     		ld hl,LFNNAME
 2214 6FC9 11 E9 6D     		ld de,NAZEVADRESARE
 2215 6FCC 01 14 00     		ld bc,20
 2216 6FCF ED B0        		ldir
 2217 6FD1 C9           		ret
 2218 6FD2 00 00 00...  DIRBUFF	ds 15
 2219 6FE1              CHANGEDIR
 2220 6FE1 ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 2221 6FE5
 2222 6FE5
 2223 6FE5 E5           		push hl
 2224 6FE6 21 42 48     		ld hl, 18496+2
 2225 6FE9 01 1C 04     		ld   bc,4*256+28
 2226 6FEC 3E 05        		ld   a,%00000101
 2227 6FEE CD F0 76     		call RAMECEK
 2228 6FF1
 2229 6FF1 11 64 48     		 ld de,18528+4
 2230 6FF4 21 A6 6C     		 ld hl,txtStart
 2231 6FF7 CD CD 7A     		 call print
 2232 6FFA
 2233 6FFA 21 00 00     		ld hl,0
 2234 6FFD 22 F3 79     		ld (ALLFILES),hl
 2235 7000 22 19 65     		ld (dirNum),hl
 2236 7003 22 DB 75     		ld (apos_all),hl
 2237 7006 AF           		xor a
 2238 7007 32 31 75     		ld (POS_F+1),a
 2239 700A 32 0F 60     		ld (virtmem),a
 2240 700D 21 00 80     		ld hl,catbuff
 2241 7010 22 A6 61     		ld (Count11+1),hl
 2242 7013 21 00 00     		ld hl,0
 2243 7016 22 F3 79     		ld (ALLFILES),hl
 2244 7019
 2245 7019 E1           		pop hl
 2246 701A CD 2A 65     		call BUFF83
 2247 701D DD 21 CE 6D  		ld ix,DIRNAME
 2248 7021 06 0D        		ld b,13
 2249 7023 7E           chngdir1 ld a,(hl)
 2250 7024 CB BF        		res 7,a
 2251 7026 B7           		or a
 2252 7027 20 02        		jr nz,chng
 2253 7029 3E 20        		ld a,32
 2254 702B DD 77 00     chng	ld (ix+0),a
 2255 702E 23           		inc hl
 2256 702F DD 23        		inc ix
 2257 7031 10 F0        		djnz chngdir1
 2258 7033              STOP
 2259 7033
 2260 7033 21 D9 6D     		ld hl,DIRNAME+11
 2261 7036 7E           chng2	ld a,(hl)
 2262 7037 FE 20        		cp 32
 2263 7039 20 03        		jr nz,zap
 2264 703B 2B           		dec hl
 2265 703C 18 F8        		jr chng2
 2266 703E 3E FF        zap		ld a,255
 2267 7040 23           		inc hl
 2268 7041 77           		ld (hl),a
 2269 7042 01 FD 7F     		ld bc,port1
 2270 7045 3A 5C 5B             ld a,(bankm)      ;sys tem vari able that holds cur rent
 2271 7048 CB A7                res 4,a           ;move right to left in hor i zon tal
 2272 704A F6 07                or 7              ;switch in RAM page 7
 2273 704C 32 5C 5B             ld (bankm),a      ;must keep sys tem vari able up to
 2274 704F ED 79                out (c),a         ;make the switch
 2275 7051
 2276 7051 AF           		xor a 			;change path
 2277 7052 21 CE 6D     		ld hl,DIRNAME
 2278 7055              AAAA
 2279 7055 CD B1 01     		call $01b1
 2280 7058
 2281 7058 38 04        		jr c,ok
 2282 705A 3E 02        ERROR	ld a,2
 2283 705C D3 FE        		out (254),a
 2284 705E
 2285 705E 01 FD 7F     ok			ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 2286 7061 3A 5C 5B                 ld a,(bankm)      ;get cur rent switch state
 2287 7064 CB E7                    set 4,a           ;move left to right (ROM 2 to ROM
 2288 7066 E6 F8                    and #F8           ;also want RAM page 0
 2289 7068 32 5C 5B                 ld (bankm),a      ;up date the sys tem vari able (very
 2290 706B ED 79                    out (c),a         ;make the switch
 2291 706D CD 67 6A     			call reload_dir
 2292 7070              ;			call GETDIR
 2293 7070 ED 91 07 00  			nextreg #07,0
 2294 7074 C9           			ret
 2295 7075 43 6F 6E 66  txtsetup	defb "Configuration",0
 2295 7079 69 67 75 72
 2295 707D 61 74 69 6F
 2295 7081 6E 00
 2296 7083 53 74 65 72  txtstereo	defb "Stereo:      ACB  /  ABC",0
 2296 7087 65 6F 3A 20
 2296 708B 20 20 20 20
 2296 708F 20 41 43 42
 2296 7093 20 20 2F 20
 2296 7097 20 41 42 43
 2296 709B 00
 2297 709C 53 6F 75 6E  txtchip		defb "Sound chip:  AY   /   YM",0
 2297 70A0 64 20 63 68
 2297 70A4 69 70 3A 20
 2297 70A8 20 41 59 20
 2297 70AC 20 20 2F 20
 2297 70B0 20 20 59 4D
 2297 70B4 00
 2298 70B5
 2299 70B5 43 6F 6E 74  txthelp0	defb "Controls:",0
 2299 70B9 72 6F 6C 73
 2299 70BD 3A 00
 2300 70BF 42 72 65 61  txthelp1	defb "Break: stop play | Space: next song",0
 2300 70C3 6B 3A 20 73
 2300 70C7 74 6F 70 20
 2300 70CB 70 6C 61 79
 2300 70CF 20 7C 20 53
 2300 70D3 70 61 63 65
 2300 70D7 3A 20 6E 65
 2300 70DB 78 74 20 73
 2300 70DF 6F 6E 67 00
 2301 70E3 20 20 41 3A  txthelp2	defb "  A: AY | Y: YM | C: ACB | B: ABC  ",0
 2301 70E7 20 41 59 20
 2301 70EB 7C 20 59 3A
 2301 70EF 20 59 4D 20
 2301 70F3 7C 20 43 3A
 2301 70F7 20 41 43 42
 2301 70FB 20 7C 20 42
 2301 70FF 3A 20 41 42
 2301 7103 43 20 20 00
 2302 7107
 2303 7107              vyrazni		equ 01000111b
 2304 7107
 2305 7107              showsetup
 2306 7107              			NEXTREG2A 06
 2306 7107 3E 06       >        ld     a,06
 2306 7109 CD 12 60    >        call   ReadNextReg
 2307 710C CB 47        			bit 0,a 		;AY
 2308 710E 20 16        			jr nz,sAY
 2309 7110
 2310 7110
 2311 7110 3E 47        			ld a,vyrazni
 2312 7112 21 95 58     			ld hl,22528+32*4 + 21
 2313 7115 77           			ld (hl),a
 2314 7116 23           			inc hl
 2315 7117 77           			ld (hl),a
 2316 7118 23           			inc hl
 2317 7119 77           			ld (hl),a
 2318 711A
 2319 711A 3E 01        			ld   a,%00000001
 2320 711C 21 8F 58     			ld hl,22528+32*4 + 15
 2321 711F 77           			ld (hl),a
 2322 7120 23           			inc hl
 2323 7121 77           			ld (hl),a
 2324 7122 23           			inc hl
 2325 7123 77           			ld (hl),a
 2326 7124
 2327 7124 18 14        			jr stereo
 2328 7126              sAY
 2329 7126 3E 01        			ld a,%00000001
 2330 7128 21 95 58     			ld hl,22528+32*4 + 21
 2331 712B 77           			ld (hl),a
 2332 712C 23           			inc hl
 2333 712D 77           			ld (hl),a
 2334 712E 23           			inc hl
 2335 712F 77           			ld (hl),a
 2336 7130
 2337 7130 3E 47        			ld   a,vyrazni
 2338 7132 21 8F 58     			ld hl,22528+32*4 + 15
 2339 7135 77           			ld (hl),a
 2340 7136 23           			inc hl
 2341 7137 77           			ld (hl),a
 2342 7138 23           			inc hl
 2343 7139 77           			ld (hl),a
 2344 713A              stereo
 2345 713A
 2346 713A              			NEXTREG2A 08
 2346 713A 3E 08       >        ld     a,08
 2346 713C CD 12 60    >        call   ReadNextReg
 2347 713F CB 6F        			bit 5,a
 2348 7141 20 15        			jr nz,sACB
 2349 7143 3E 47        			ld a,vyrazni
 2350 7145 21 75 58     			ld hl,22528+32*3 + 21
 2351 7148 77           			ld (hl),a
 2352 7149 23           			inc hl
 2353 714A 77           			ld (hl),a
 2354 714B 23           			inc hl
 2355 714C 77           			ld (hl),a
 2356 714D
 2357 714D 3E 01        			ld   a,%00000001
 2358 714F 21 6F 58     			ld hl,22528+32*3 + 15
 2359 7152 77           			ld (hl),a
 2360 7153 23           			inc hl
 2361 7154 77           			ld (hl),a
 2362 7155 23           			inc hl
 2363 7156 77           			ld (hl),a
 2364 7157 C9           			ret
 2365 7158
 2366 7158              sACB
 2367 7158 3E 01        			ld a,%00000001
 2368 715A 21 75 58     			ld hl,22528+32*3 + 21
 2369 715D 77           			ld (hl),a
 2370 715E 23           			inc hl
 2371 715F 77           			ld (hl),a
 2372 7160 23           			inc hl
 2373 7161 77           			ld (hl),a
 2374 7162
 2375 7162 3E 47        			ld   a,vyrazni
 2376 7164 21 6F 58     			ld hl,22528+32*3 + 15
 2377 7167 77           			ld (hl),a
 2378 7168 23           			inc hl
 2379 7169 77           			ld (hl),a
 2380 716A 23           			inc hl
 2381 716B 77           			ld (hl),a
 2382 716C
 2383 716C C9           			ret
 2384 716D
 2385 716D              ;Skok na další skladbu
 2386 716D              nextsong
 2387 716D CD 91 75     		 call DOWN
 2388 7170
 2389 7170              ;Stisk klávesy ENTER.
 2390 7170              FIRE
 2391 7170 ED 91 07 03  		 nextreg #07,3
 2392 7174 CD 41 74     		 call savescr
 2393 7177 3A 31 75     		 ld a,(POS_F+1)
 2394 717A 5F           		 ld e,a
 2395 717B 16 00        		 ld d,0
 2396 717D 2A DB 75     		ld hl,(apos_all)
 2397 7180 19           		add hl,de
 2398 7181 7D           		ld a,l
 2399 7182 B4           		or h
 2400 7183 21 0D 80      	    ld hl,catbuff+#D
 2401 7186 28 11        		jr z,F1
 2402 7188
 2403 7188 2A DB 75     		ld hl,(apos_all)
 2404 718B 44           		ld b,h
 2405 718C 4D           		ld c,l
 2406 718D
 2407 718D 11 0D 00     		ld de,13
 2408 7190 21 0D 80       	    ld hl,catbuff+#D
 2409 7193 19           F0 		add hl,de
 2410 7194 0B           		dec bc
 2411 7195 79           		ld a,c
 2412 7196 B0           		or b
 2413 7197 20 FA        		jr nz,F0
 2414 7199              F1
 2415 7199 E5           		push hl
 2416 719A DD E1        		pop ix
 2417 719C CD 2A 65     		call BUFF83
 2418 719F DD CB 07 7E  		bit 7,(ix+7)
 2419 71A3
 2420 71A3 C2 E1 6F     		jp nz,CHANGEDIR
 2421 71A6 E5           		push hl
 2422 71A7 21 40 48             ld   hl,18496
 2423 71AA 01 20 07             ld   bc,7*256+32
 2424 71AD 3E 07                ld   a,%00000111
 2425 71AF CD F0 76             call RAMECEK
 2426 71B2 21 00 50     		ld   hl,20480
 2427 71B5 01 20 04             ld   bc,4*256+32
 2428 71B8 3E 05                ld   a,%00000101
 2429 71BA CD F0 76             call RAMECEK
 2430 71BD
 2431 71BD 21 25 40     		ld   hl,16416+5
 2432 71C0 01 16 05             ld   bc,5*256+22
 2433 71C3 3E 07                ld   a,%00000111
 2434 71C5 CD F0 76             call RAMECEK
 2435 71C8
 2436 71C8 21 C1 40     		ld   hl,16576+1
 2437 71CB 01 1E 04             ld   bc,4*256+30
 2438 71CE 3E 05                ld   a,%00000101
 2439 71D0 CD F0 76             call RAMECEK
 2440 71D3
 2441 71D3              		; ld de,16576+3
 2442 71D3              		; ld hl,txthelp0
 2443 71D3              		; call print
 2444 71D3 11 E3 40     		ld de,16608+3
 2445 71D6 21 BF 70     		ld hl,txthelp1
 2446 71D9 CD CD 7A     		call print
 2447 71DC 11 03 48     		ld de,18432+3
 2448 71DF 21 E3 70     		ld hl,txthelp2
 2449 71E2 CD CD 7A     		call print
 2450 71E5
 2451 71E5
 2452 71E5
 2453 71E5 21 E2 58     		ld hl,22528 + 32*7 + 2
 2454 71E8 3E 07        		ld a,7
 2455 71EA 77           		ld (hl),a
 2456 71EB 23           		inc hl
 2457 71EC 77           		ld (hl),a
 2458 71ED 23           		inc hl
 2459 71EE 77           		ld (hl),a
 2460 71EF 23           		inc hl
 2461 71F0 77           		ld (hl),a
 2462 71F1 23           		inc hl
 2463 71F2 77           		ld (hl),a
 2464 71F3 23           		inc hl
 2465 71F4 77           		ld (hl),a
 2466 71F5 21 F1 58     		ld hl,22528 + 32*7 + 17
 2467 71F8 3E 07        		ld a,7
 2468 71FA 77           		ld (hl),a
 2469 71FB 23           		inc hl
 2470 71FC 77           		ld (hl),a
 2471 71FD 23           		inc hl
 2472 71FE 77           		ld (hl),a
 2473 71FF 23           		inc hl
 2474 7200 77           		ld (hl),a
 2475 7201 23           		inc hl
 2476 7202 77           		ld (hl),a
 2477 7203
 2478 7203 21 04 59     		ld hl,22528 + 32*8 + 4
 2479 7206 3E 07        		ld a,7
 2480 7208 77           		ld (hl),a
 2481 7209 23           		inc hl
 2482 720A 77           		ld (hl),a
 2483 720B
 2484 720B 21 0A 59     		ld hl,22528 + 32*8 + 10
 2485 720E 3E 07        		ld a,7
 2486 7210 77           		ld (hl),a
 2487 7211 23           		inc hl
 2488 7212 77           		ld (hl),a
 2489 7213
 2490 7213 21 10 59     		ld hl,22528 + 32*8 + 16
 2491 7216 3E 07        		ld a,7
 2492 7218 77           		ld (hl),a
 2493 7219 23           		inc hl
 2494 721A 77           		ld (hl),a
 2495 721B
 2496 721B 21 16 59     		ld hl,22528 + 32*8 + 22
 2497 721E 3E 07        		ld a,7
 2498 7220 77           		ld (hl),a
 2499 7221 23           		inc hl
 2500 7222 77           		ld (hl),a
 2501 7223
 2502 7223
 2503 7223 11 46 40     		ld de,16448+6
 2504 7226 21 75 70     		ld hl,txtsetup
 2505 7229 CD CD 7A     		call print
 2506 722C 21 46 58     		ld hl,22528+32*2 + 6
 2507 722F 3E 05        		ld a,101b
 2508 7231              		;ld a,255
 2509 7231 77           		ld (hl),a
 2510 7232 23           		inc hl
 2511 7233 77           		ld (hl),a
 2512 7234 23           		inc hl
 2513 7235 77           		ld (hl),a
 2514 7236 23           		inc hl
 2515 7237 77           		ld (hl),a
 2516 7238 23           		inc hl
 2517 7239 77           		ld (hl),a
 2518 723A 23           		inc hl
 2519 723B 77           		ld (hl),a
 2520 723C 23           		inc hl
 2521 723D 77           		ld (hl),a
 2522 723E 23           		inc hl
 2523 723F 77           		ld (hl),a
 2524 7240 23           		inc hl
 2525 7241 77           		ld (hl),a
 2526 7242 23           		inc hl
 2527 7243 77           		ld (hl),a
 2528 7244 11 66 40     		ld de,16480+6
 2529 7247 21 83 70     		ld hl,txtstereo
 2530 724A CD CD 7A     		call print
 2531 724D
 2532 724D 11 86 40     		ld de,16512+6
 2533 7250 21 9C 70     		ld hl,txtchip
 2534 7253 CD CD 7A     		call print
 2535 7256
 2536 7256 CD 07 71     		call showsetup
 2537 7259
 2538 7259
 2539 7259 21 41 5A     		ld hl,22528+32*18+1
 2540 725C 54           		ld d,h
 2541 725D 5D           		ld e,l
 2542 725E 13           		inc de
 2543 725F 3E 07        		ld a,7
 2544 7261 77           		ld (hl),a
 2545 7262 01 1C 00     		ld bc, 28
 2546 7265 ED B0        		ldir
 2547 7267
 2548 7267
 2549 7267                      ; ld   hl,18592+2
 2550 7267              		; ld (lfnat+1),hl
 2551 7267              		; ld hl,28 + 18592+2
 2552 7267              		; ld (lfn_1 + 1),hl
 2553 7267              		; ld hl,28 + 18624+21
 2554 7267              		; ld (lfn_2 + 1),hl
 2555 7267              		; ld hl,LFNNAME+128
 2556 7267              		; ld (lfnend+1),hl
 2557 7267              		; ld hl,4
 2558 7267              		; ld (odskok+1),hl
 2559 7267
 2560 7267
 2561 7267 CD BA 65     		call LFNPRINT
 2562 726A
 2563 726A 21 68 73     		ld hl,tmp
 2564 726D 11 69 73     		ld de,tmp+1
 2565 7270 AF           		xor a
 2566 7271 77           		ld (hl),a
 2567 7272 01 30 00     		ld bc,48
 2568 7275 ED B0        		ldir
 2569 7277
 2570 7277 21 1C BD     		ld hl,LFNNAME
 2571 727A 11 68 73     		ld de,tmp
 2572 727D 01 25 00     		ld bc,maxline
 2573 7280 ED B0        		ldir
 2574 7282
 2575 7282 11 82 48     		ld de,18560+2
 2576 7285 21 68 73     		ld hl,tmp
 2577 7288 CD CD 7A     		call print
 2578 728B              ;**************************
 2579 728B 21 68 73     		ld hl,tmp
 2580 728E 11 69 73     		ld de,tmp+1
 2581 7291 AF           		xor a
 2582 7292 77           		ld (hl),a
 2583 7293 01 30 00     		ld bc,48
 2584 7296 ED B0        		ldir
 2585 7298
 2586 7298 21 41 BD     		ld hl,LFNNAME+maxline
 2587 729B 11 68 73     		ld de,tmp
 2588 729E 01 25 00     		ld bc,maxline
 2589 72A1 ED B0        		ldir
 2590 72A3
 2591 72A3 11 A2 48     		ld de,18592+2
 2592 72A6 21 68 73     		ld hl,tmp
 2593 72A9 CD CD 7A     		call print
 2594 72AC              ;****************************
 2595 72AC 21 68 73     		ld hl,tmp
 2596 72AF 11 69 73     		ld de,tmp+1
 2597 72B2 AF           		xor a
 2598 72B3 77           		ld (hl),a
 2599 72B4 01 30 00     		ld bc,48
 2600 72B7 ED B0        		ldir
 2601 72B9
 2602 72B9 21 66 BD     		ld hl,LFNNAME+maxline+maxline
 2603 72BC 11 68 73     		ld de,tmp
 2604 72BF 01 25 00     		ld bc,maxline
 2605 72C2 ED B0        		ldir
 2606 72C4
 2607 72C4 11 C2 48     		ld de,18624+2
 2608 72C7 21 68 73     		ld hl,tmp
 2609 72CA CD CD 7A     		call print
 2610 72CD
 2611 72CD
 2612 72CD 21 81 59     		ld hl,12*32+22528+1
 2613 72D0 11 82 59     		ld de,12*32+22528+2
 2614 72D3 01 1D 00     		ld bc,29
 2615 72D6 36 47        		ld (hl),%01000111
 2616 72D8 ED B0        		ldir
 2617 72DA 21 A1 59     		ld hl,13*32+22528+1
 2618 72DD 11 A2 59     		ld de,13*32+22528+2
 2619 72E0 01 1D 00     		ld bc,29
 2620 72E3 36 47        		ld (hl),%01000111
 2621 72E5 ED B0        		ldir
 2622 72E7
 2623 72E7 21 C1 59     		ld hl,14*32+22528+1
 2624 72EA 11 C2 59     		ld de,14*32+22528+2
 2625 72ED 01 1D 00     		ld bc,29
 2626 72F0 36 47        		ld (hl),%01000111
 2627 72F2 ED B0        		ldir
 2628 72F4
 2629 72F4
 2630 72F4
 2631 72F4 11 C2 50     		ld de,20672+2
 2632 72F7 ED 53 B4 65  		ld (lfnat+1),de
 2633 72FB 21 DE 50     		ld hl,28 + 20672+2
 2634 72FE 22 A8 65     		ld (lfn_1 + 1),hl
 2635 7301 21 E3 50     		ld hl,33 + 20672+2
 2636 7304 22 AE 65     		ld (lfn_2 + 1),hl
 2637 7307 21 41 BD     		ld hl,LFNNAME+37
 2638 730A 22 A5 65     		ld (lfnend+1),hl
 2639 730D D1           		pop de				; v DE je nazev souboru
 2640 730E CD 98 79             call NOWRMOD
 2641 7311
 2642 7311 11 6B 48     		ld   de,18560+8-32+3
 2643 7314 21 0C 7F          	ld hl,text
 2644 7317
 2645 7317 CD CD 7A             call print
 2646 731A
 2647 731A CD C5 73     		call LOADFile
 2648 731D
 2649 731D ED 91 57 01  		nextreg $57,1
 2650 7321
 2651 7321 21 09 60     		ld hl,filename+9
 2652 7324 11 99 73     		ld de,PT2
 2653 7327 CD 8F 61     		call compare
 2654 732A CA EC 98     		jp z,playmusic
 2655 732D
 2656 732D 21 09 60     		ld hl,filename+9
 2657 7330 11 9C 73     		ld de,PT3
 2658 7333 CD 8F 61     		call compare
 2659 7336 CA EC 98     		jp z,playmusic
 2660 7339
 2661 7339 21 09 60     		ld hl,filename+9
 2662 733C 11 9F 73     		ld de,SQT
 2663 733F CD 8F 61     		call compare
 2664 7342 CA 39 92     		jp z,SQTPLAY
 2665 7345
 2666 7345 21 09 60     		ld hl,filename+9
 2667 7348 11 A2 73     		ld de,STC
 2668 734B CD 8F 61     		call compare
 2669 734E CA B1 90     		jp z,STCPLAY
 2670 7351
 2671 7351 21 09 60     		ld hl,filename+9
 2672 7354 11 A5 73     		ld de,STP
 2673 7357 CD 8F 61     		call compare
 2674 735A CA 62 91     		jp z,STPPLAY
 2675 735D
 2676 735D
 2677 735D
 2678 735D
 2679 735D 3E 20        		ld a,32
 2680 735F 21 A8 73     		ld hl,endsong
 2681 7362 77           		ld (hl),a
 2682 7363              ;		jp playmusic
 2683 7363              navrat
 2684 7363 76           		halt
 2685 7364 CD 55 74     		call loadscr
 2686 7367 C9                   ret
 2687 7368 00 00 00...  tmp     ds 49
 2688 7399 50 54 32     PT2 	defb "PT2"
 2689 739C 50 54 33     PT3		defb "PT3"
 2690 739F 53 51 54     SQT		defb "SQT"
 2691 73A2 53 54 43     STC		defb "STC"
 2692 73A5 53 54 50     STP		defb "STP"
 2693 73A8 00           endsong	defb 0
 2694 73A9 50 6C 61 73  Loading defb "Plase wait, loading file...",0
 2694 73AD 65 20 77 61
 2694 73B1 69 74 2C 20
 2694 73B5 6C 6F 61 64
 2694 73B9 69 6E 67 20
 2694 73BD 66 69 6C 65
 2694 73C1 2E 2E 2E 00
 2695 73C5              ; Nahrání souboru pomocí EsxDos služeb. Rutina nemá žádný vstup,
 2696 73C5              ; vše si zjišťuje z proměnných (na adrese filename je již připravený název souboru)
 2697 73C5              LOADFile
 2698 73C5 ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 2699 73C9 21 A0 50     		ld hl, 20640
 2700 73CC 01 20 03     		ld   bc,3*256+32
 2701 73CF 3E 02                ld   a,%00000010
 2702 73D1 CD F0 76     		call RAMECEK
 2703 73D4
 2704 73D4 11 C2 50     		ld de,20672+2
 2705 73D7 21 A9 73     		ld hl,Loading
 2706 73DA CD CD 7A     		call print
 2707 73DD 06 01        		ld      b,FA_READ
 2708 73DF 3E 2A                ld      a,'*'
 2709 73E1 21 00 60             ld      hl,filename
 2710 73E4                      ESXDOS  F_OPEN
 2710 73E4 E5          >  push hl
 2710 73E5 DD E1       >  pop ix
 2710 73E7 CF          >  rst $08
 2710 73E8 9A          >  db F_OPEN
 2711 73E9 32 23 74     		ld (fread+1),a
 2712 73EC
 2713 73EC 21 0E BD     		ld hl,modstart
 2714 73EF 11 0F BD     		ld de,modstart+1
 2715 73F2 01 20 56     		ld bc,22048
 2716 73F5 3E FF        		ld a,255
 2717 73F7 77           		ld (hl),a
 2718 73F8 ED B0        		ldir
 2719 73FA
 2720 73FA
 2721 73FA
 2722 73FA 21 0E BD             ld      hl,modstart
 2723 73FD 01 20 56             ld      bc,22048
 2724 7400 CD 22 74             call    fread
 2725 7403 CD 19 74     		call 	fclose
 2726 7406
 2727 7406
 2728 7406 21 76 FF     		ld hl,modstart + 17000
 2729 7409
 2730 7409              hledej_konec_souboru
 2731 7409 7E           		ld a,(hl)
 2732 740A FE FF        		cp 255
 2733 740C 20 03        		jr nz,nasel
 2734 740E 2B           		dec hl
 2735 740F 18 F8        		jr hledej_konec_souboru
 2736 7411
 2737 7411 22 B5 60     nasel	ld (delka_souboru),hl
 2738 7414
 2739 7414 ED 91 07 00  		nextreg #07,0             ;28MHz - jen kvůli načítání (rychlost)
 2740 7418 C9           		ret
 2741 7419              fclose
 2742 7419 3A 23 74             ld      a,(fread+1)
 2743 741C                      ESXDOS  F_CLOSE
 2743 741C E5          >  push hl
 2743 741D DD E1       >  pop ix
 2743 741F CF          >  rst $08
 2743 7420 9B          >  db F_CLOSE
 2744 7421 C9                   ret
 2745 7422              fread:
 2746 7422 3E 01                ld a,1
 2747 7424                      ESXDOS  F_READ
 2747 7424 E5          >  push hl
 2747 7425 DD E1       >  pop ix
 2747 7427 CF          >  rst $08
 2747 7428 9D          >  db F_READ
 2748 7429 D0                   ret  nc
 2749 742A
 2750 742A
 2751 742A              fileError:
 2752 742A F5                   push    af
 2753 742B E6 07                and     7
 2754 742D D3 FE                out     (254),a
 2755 742F F1                   pop     af
 2756 7430 06 01                ld      b,1
 2757 7432 11 22 C6             ld      de,esxError
 2758 7435                      ESXDOS  M_GETERR
 2758 7435 E5          >  push hl
 2758 7436 DD E1       >  pop ix
 2758 7438 CF          >  rst $08
 2758 7439 93          >  db M_GETERR
 2759 743A 21 22 C6             ld      hl,esxError
 2760 743D C3 69 74             jp      customErrorToBasic
 2761 7440
 2762 7440
 2763 7440              switchLayer2Off:
 2764 7440 C9                   ret
 2765 7441
 2766 7441
 2767 7441              ;Uloží obrazovku do banky 19 ZX Next. Ukládají se spodní dvě třetiny obrazovky,
 2768 7441              ;a celé atributy. Banka 19 se stránkuje od adresy $e000
 2769 7441              savescr
 2770 7441 ED 91 57 13  		nextreg $57,19				;Stránka na uložení VideoRam
 2771 7445 21 00 40     		ld hl,16384
 2772 7448 11 00 E0     		ld de,bufscr
 2773 744B 01 00 1B     		ld bc,6912
 2774 744E ED B0        		ldir
 2775 7450 ED 91 57 01  		nextreg $57,1				;Nastránkuj zpátky
 2776 7454 C9           		ret
 2777 7455
 2778 7455              ;Obnovení spodních dvou třetin obrazovky z 19 stárnky ZX Next.
 2779 7455              loadscr
 2780 7455 ED 91 57 13  		nextreg $57,19
 2781 7459 21 00 E0     		ld hl,bufscr
 2782 745C 11 00 40     		ld de,16384
 2783 745F 01 00 1B     		ld bc,6912
 2784 7462 ED B0        		ldir
 2785 7464 ED 91 57 01  		nextreg $57,1
 2786 7468 C9           		ret
 2787 7469
 2788 7469              customErrorToBasic: ; HL = message with |80 last char
 2789 7469 3E 01        		ld a,1
 2790 746B D3 FE        		out (254),a
 2791 746D C9           		ret
 2792 746E 00           keysound db 0				;key sound 0= yes,1= no, klavesnicove echo
 2793 746F              ;KeyScan od Busyho z MRSu
 2794 746F 2E 2F        KEYSCAN  ld   l,47			;testovani klavesnice
 2795 7471 11 FF FF              ld   de,65535
 2796 7474 01 FE FE              ld   bc,65278
 2797 7477 ED 78        KEYLINE  in   a,(c)
 2798 7479 2F                    cpl
 2799 747A E6 1F                 and  31
 2800 747C 28 0E                 jr   z,KEYDONE
 2801 747E 67                    ld   h,a
 2802 747F 7D                    ld   a,l
 2803 7480 14           KEY3KEYS inc  d
 2804 7481 C0                    ret  nz
 2805 7482 D6 08        KEYBITS  sub  8
 2806 7484 CB 3C                 srl  h
 2807 7486 30 FA                 jr   nc,KEYBITS
 2808 7488 53                    ld   d,e
 2809 7489 5F                    ld   e,a
 2810 748A 20 F4                 jr   nz,KEY3KEYS
 2811 748C 2D           KEYDONE  dec  l
 2812 748D CB 00                 rlc  b
 2813 748F 38 E6                 jr   c,KEYLINE
 2814 7491 7A                    ld   a,d
 2815 7492 3C                    inc  a
 2816 7493 C8                    ret  z
 2817 7494 FE 28                 cp   40
 2818 7496 C8                    ret  z
 2819 7497 FE 19                 cp   25
 2820 7499 C8                    ret  z
 2821 749A 7B                    ld   a,e
 2822 749B 5A                    ld   e,d
 2823 749C 57                    ld   d,a
 2824 749D FE 18                 cp   24
 2825 749F C9                    ret
 2826 74A0
 2827 74A0 2A 5E 5B 26  SYMTAB   db "*^[&%>}/"
 2827 74A4 25 3E 7D 2F
 2828 74A8 2C 2D 5D 27           db ",-]'$<{?"
 2828 74AC 24 3C 7B 3F
 2829 74B0 2E 2B 7F 28           db ".+($"
 2829 74B4 24
 2830 74B5 C8                    db 200
 2831 74B6 2F 20                 db '/',' '
 2832 74B8 00                    db 0
 2833 74B9 3D 3B 29 40           db "=;)@"
 2834 74BD C9                    db 201
 2835 74BE 7C 3A                 db "|:"
 2836 74C0 20 0D 22              db 32,13,34
 2837 74C3 5F 21                 db "_!"
 2838 74C5 C7                    db 199
 2839 74C6 7E 00                 db "~",0
 2840 74C8
 2841 74C8 42 48 59     CAPSTAB  db "BHY"
 2842 74CB 0A 08                 db 10,8
 2843 74CD 54 47 56              db "TGV"
 2844 74D0 4E 4A 55              db "NJU"
 2845 74D3 0B 05                 db 11,5
 2846 74D5 52 46 43              db "RFC"
 2847 74D8 4D 4B 49              db "MKI"
 2848 74DB 09 04                 db 9,4
 2849 74DD 45 44 58              db "EDX"
 2850 74E0 02                    db 2
 2851 74E1 4C 4F                 db "LO"
 2852 74E3 0F 06                 db 15,6
 2853 74E5 57 53 5A              db "WSZ"
 2854 74E8 01 0D 50              db 1,13,"P"
 2855 74EB 0C 07                 db 12,7
 2856 74ED 51 41                 db "QA"
 2857 74EF
 2858 74EF 62 68 79 36  NORMTAB  db "bhy65tgv"
 2858 74F3 35 74 67 76
 2859 74F7 6E 6A 75 37           db "nju74rfc"
 2859 74FB 34 72 66 63
 2860 74FF 6D 6B 69 38           db "mki83edx"
 2860 7503 33 65 64 78
 2861 7507 00                    db 0
 2862 7508 6C 6F 39 32           db "lo92wsz"
 2862 750C 77 73 7A
 2863 750F 20 0D                 db 32,13
 2864 7511 70 30 31 71           db "p01qa"
 2864 7515 61
 2865 7516 00                    db 0
 2866 7517
 2867 7517 3A 6E 74     beepk		ld a,(keysound)		;Busyho nahradni rutina,kratsi
 2868 751A B7           		or a
 2869 751B C0           		ret nz
 2870 751C 3A 2F 75     		ld a,(BORDER)
 2871 751F 5F           		ld e,a
 2872 7520 06 10        		ld b,$10
 2873 7522 80           		add a,b
 2874 7523              ;		ld a,$10+border
 2875 7523 D3 FE        		out ($fe),a
 2876 7525 06 1C        		ld b,$1c
 2877 7527 10 FE        beepk1		djnz beepk1
 2878 7529 3E 08        		ld a,$08
 2879 752B 83           		add a,e
 2880 752C              ;		ld a,$08+border
 2881 752C D3 FE        		out ($fe),a
 2882 752E C9           		ret
 2883 752F 00           BORDER   db 0				;okraj
 2884 7530
 2885 7530              ;Pohyb nahoru - na pozici kurzoru se používa 16bitové číslo,
 2886 7530              ;takže maximální počet souboru je omezen, ale prakticky se k
 2887 7530              ;němu ani nepřiblížíme.
 2888 7530              ;Při scrolování se vypisuje jen spodní řádek, jinak se volá
 2889 7530              ;rutinka ROLLDOWN, která provede scroll o 8 pixelů dolů. Je to rychlejší,
 2890 7530              ;než vypisovat všechny soubory znova.
 2891 7530              UP
 2892 7530 3E 00        POS_F    ld a,0
 2893 7532 B7           		 or a
 2894 7533 CA 68 75     		 jp z,UP1
 2895 7536 2A DB 75     		 ld hl,(apos_all)
 2896 7539 7C           		 ld a,h
 2897 753A B5                    or   l
 2898 753B CA 68 75              jp   z,UP1
 2899 753E 0E 0F                 ld   c,%00001111
 2900 7540 3A 31 75     		 ld a,(POS_F+1)
 2901 7543 CD F6 79              call KURZOR
 2902 7546 2A DB 75     		 ld hl,(apos_all)
 2903 7549 2B                    dec  hl
 2904 754A 22 DB 75              ld   (apos_all),hl
 2905 754D
 2906 754D 3D           		 dec a
 2907 754E 32 31 75     		 ld (POS_F+1),a
 2908 7551 0E 17                 ld   c,%00010111
 2909 7553 CD F6 79              call KURZOR
 2910 7556 CD BA 65     		 call LFNPRINT
 2911 7559 21 41 BD      		ld hl,LFNNAME + maxline
 2912 755C 36 00        		ld (hl),0
 2913 755E 21 1C BD     		ld hl,LFNNAME
 2914 7561 11 C2 50     		ld de,20672+2
 2915 7564 CD CD 7A     		call print
 2916 7567
 2917 7567 C9                    ret
 2918 7568
 2919 7568              UP1
 2920 7568 3E 00        POS_ALL  ld   a,0
 2921 756A                       ;or   a
 2922 756A                       ;ret  z
 2923 756A                       ;dec  a
 2924 756A                       ;ld   (POS_ALL+1),a
 2925 756A 2A DB 75     		 ld hl,(apos_all)
 2926 756D 7D           		 ld a,l
 2927 756E B4           		 or h
 2928 756F C8           		 ret z
 2929 7570 2B           		 dec hl
 2930 7571 22 DB 75     		 ld (apos_all),hl
 2931 7574 F5                    push af
 2932 7575 CD 85 7A              call ROLLDOWN
 2933 7578 F1                    pop  af
 2934 7579 21 41 40              ld   hl,16448+1
 2935 757C CD 0E 7A              call PRN_F
 2936 757F CD BA 65     		 call LFNPRINT
 2937 7582 21 41 BD     		ld hl,LFNNAME + maxline
 2938 7585 36 00        		ld (hl),0
 2939 7587 21 1C BD     		ld hl,LFNNAME
 2940 758A 11 C2 50     		ld de,20672+2
 2941 758D CD CD 7A     		call print
 2942 7590
 2943 7590 C9                    ret
 2944 7591              DOWN
 2945 7591 2A F3 79     		ld hl,(ALLFILES)
 2946 7594 2B           		dec hl
 2947 7595
 2948 7595 1E 11        		ld e,17
 2949 7597 16 00        		ld d,0
 2950 7599 B7           		or a
 2951 759A ED 52        		sbc hl,de
 2952 759C 4D           		ld c,l
 2953 759D DA A2 75     		jp c,D1
 2954 75A0 0E 11        		ld c,17
 2955 75A2
 2956 75A2              D1
 2957 75A2 3A 31 75              ld   a,(POS_F+1)
 2958 75A5 B9                    cp   c
 2959 75A6 CA DD 75              jp   z,DOWN1
 2960 75A9 5F           		 ld e,a
 2961 75AA 16 00        		 ld d,0
 2962 75AC 2A F3 79     		 ld hl,(ALLFILES)
 2963 75AF 2B           		 dec hl
 2964 75B0 B7           		 or a
 2965 75B1 ED 52        		 sbc hl,de
 2966 75B3 C8           		 ret z
 2967 75B4 0E 0F                 ld   c,%00001111
 2968 75B6 CD F6 79              call KURZOR
 2969 75B9
 2970 75B9 3C                    inc  a
 2971 75BA 32 31 75              ld   (POS_F+1),a
 2972 75BD 2A DB 75     		 ld hl,(apos_all)
 2973 75C0 23           		 inc hl
 2974 75C1 22 DB 75     		 ld (apos_all),hl
 2975 75C4 0E 17                 ld   c,%00010111
 2976 75C6 CD F6 79              call KURZOR
 2977 75C9
 2978 75C9 CD BA 65     		 call LFNPRINT
 2979 75CC 21 41 BD     		ld hl,LFNNAME + maxline
 2980 75CF 36 00        		ld (hl),0
 2981 75D1 21 1C BD     		ld hl,LFNNAME
 2982 75D4 11 C2 50     		ld de,20672+2
 2983 75D7 CD CD 7A     		call print
 2984 75DA
 2985 75DA C9                    ret
 2986 75DB
 2987 75DB 00 00        apos_all defw 0
 2988 75DD              DOWN1
 2989 75DD 2A DB 75            	ld hl,(apos_all)
 2990 75E0              		;dec hl
 2991 75E0 EB           		ex de,hl
 2992 75E1 2A F3 79     		ld hl,(ALLFILES)
 2993 75E4 2B           		dec hl
 2994 75E5 EB           		ex de,hl
 2995 75E6 B7           		or a
 2996 75E7 ED 52        		sbc hl,de
 2997 75E9 C8           		ret z			;maximum souboru
 2998 75EA
 2999 75EA 2A DB 75             ld hl,(apos_all)
 3000 75ED              		;dec hl
 3001 75ED EB           		ex de,hl
 3002 75EE 2A F3 79     		ld hl,(ALLFILES)
 3003 75F1 2B           		dec hl
 3004 75F2 EB           		ex de,hl
 3005 75F3 B7           		or a
 3006 75F4 ED 52        		sbc hl,de
 3007 75F6
 3008 75F6 EB           		ex de,hl
 3009 75F7 2A DB 75     		ld hl,(apos_all)
 3010 75FA
 3011 75FA B7           		or a
 3012 75FB ED 52        		sbc hl,de
 3013 75FD C8           		ret z
 3014 75FE
 3015 75FE 3A 69 75              ld   a,(POS_ALL+1)
 3016 7601 3C                    inc  a
 3017 7602 32 69 75              ld   (POS_ALL+1),a
 3018 7605 2A DB 75     		 ld hl,(apos_all)
 3019 7608 23           		 inc hl
 3020 7609 22 DB 75     		 ld (apos_all),hl
 3021 760C F5                    push af
 3022 760D CD 7F 7A              call ROLLUP
 3023 7610 F1                    pop  af
 3024 7611 4F                    ld   c,a
 3025 7612 3A 31 75              ld   a,(POS_F+1)
 3026 7615 81                    add  a,c
 3027 7616 21 61 50              ld   hl,20576+1
 3028 7619 CD 0E 7A              call PRN_F
 3029 761C CD BA 65     		 call LFNPRINT
 3030 761F 21 41 BD     		ld hl,LFNNAME + maxline
 3031 7622 36 00        		ld (hl),0
 3032 7624 21 1C BD     		ld hl,LFNNAME
 3033 7627 11 C2 50     		ld de,20672+2
 3034 762A CD CD 7A     		call print
 3035 762D
 3036 762D C9                    ret
 3037 762E
 3038 762E              ;Font na vykreslování rámečků
 3039 762E              SPECFNT
 3040 762E 00 7F                 defw 32512
 3041 7630 7F 75                 defw 30079
 3042 7632 60 70                 defw 28768
 3043 7634 60 70                 defw 28768
 3044 7636
 3045 7636 00 FF                 defw 65280
 3046 7638 FF 55                 defw 22015
 3047 763A 00 00                 defw 0
 3048 763C 00 00                 defw 0
 3049 763E
 3050 763E 00 FE                 defw 65024
 3051 7640 FE 56                 defw 22270
 3052 7642 0E 06                 defw 1550
 3053 7644 0E 06                 defw 1550
 3054 7646
 3055 7646 60 70                 defw 28768
 3056 7648 60 70                 defw 28768
 3057 764A 60 70                 defw 28768
 3058 764C 60 70                 defw 28768
 3059 764E
 3060 764E 00 00                 defw 0
 3061 7650 00 00                 defw 0
 3062 7652 00 00                 defw 0
 3063 7654 00 00                 defw 0
 3064 7656
 3065 7656 0E 06                 defw 1550
 3066 7658 0E 06                 defw 1550
 3067 765A 0E 06                 defw 1550
 3068 765C 0E 06                 defw 1550
 3069 765E
 3070 765E 60 70                 defw 28768
 3071 7660 6A 7F                 defw 32618
 3072 7662 7F 75                 defw 30079
 3073 7664 60 70                 defw 28768
 3074 7666
 3075 7666 00 00                 defw 0
 3076 7668 AA FF                 defw 65450
 3077 766A FF 55                 defw 22015
 3078 766C 00 00                 defw 0
 3079 766E
 3080 766E 0E 06                 defw 1550
 3081 7670 AE FE                 defw 65198
 3082 7672 FE 56                 defw 22270
 3083 7674 0E 06                 defw 1550
 3084 7676
 3085 7676 60 70                 defw 28768
 3086 7678 60 70                 defw 28768
 3087 767A 6A 7F                 defw 32618
 3088 767C 7F 00                 defw 127
 3089 767E
 3090 767E 00 00                 defw 0
 3091 7680 00 00                 defw 0
 3092 7682 AA FF                 defw 65450
 3093 7684 FF 00                 defw 255
 3094 7686
 3095 7686 0E 06                 defw 1550
 3096 7688 0E 06                 defw 1550
 3097 768A AE FE                 defw 65198
 3098 768C FE 00                 defw 254
 3099 768E
 3100 768E 00 55 00 55           defb 0,85,0,85,0,85,0
 3100 7692 00 55 00
 3101 7695 00                    defb 0
 3102 7696
 3103 7696              DOWNHL
 3104 7696 24                    inc  h
 3105 7697 7C                    ld   a,h
 3106 7698 E6 07                 and  7
 3107 769A C0                    ret  nz
 3108 769B 7D                    ld   a,l
 3109 769C C6 20                 add  a,32
 3110 769E 6F                    ld   l,a
 3111 769F 7C                    ld   a,h
 3112 76A0 D8                    ret  c
 3113 76A1 D6 08                 sub  8
 3114 76A3 67                    ld   h,a
 3115 76A4 C9                    ret
 3116 76A5
 3117 76A5
 3118 76A5              DOWNH
 3119 76A5 7D                    ld   a,l
 3120 76A6 C6 20                 add  a,32
 3121 76A8 6F                    ld   l,a
 3122 76A9 7C                    ld   a,h
 3123 76AA D0                    ret  nc
 3124 76AB C6 08                 add  a,2048/256
 3125 76AD 67                    ld   h,a
 3126 76AE C9                    ret
 3127 76AF
 3128 76AF              ;Rutinka na vypsání jednoho znaku 8bitovým fontem.
 3129 76AF              ; Vstup:
 3130 76AF              			; A ... znak
 3131 76AF              			; Pozice se určuje návěstím P_AT
 3132 76AF              PRINT
 3133 76AF D9                    exx
 3134 76B0 6F                    ld   l,a
 3135 76B1 26 00                 ld   h,0
 3136 76B3 29                    add  hl,hl
 3137 76B4 29                    add  hl,hl
 3138 76B5 29                    add  hl,hl
 3139 76B6 01 00 3C     FNT      ld   bc,CHARS
 3140 76B9 09                    add  hl,bc
 3141 76BA 11 00 40     P_AT     ld   de,16384
 3142 76BD
 3143 76BD D5                    push de
 3144 76BE 7E                    ld   a,(hl)
 3145 76BF
 3146 76BF 12                    ld   (de),a
 3147 76C0 23                    inc  hl
 3148 76C1 14                    inc  d
 3149 76C2 7E                    ld   a,(hl)
 3150 76C3 12                    ld   (de),a
 3151 76C4 23                    inc  hl
 3152 76C5 14                    inc  d
 3153 76C6 7E                    ld   a,(hl)
 3154 76C7 12                    ld   (de),a
 3155 76C8 23                    inc  hl
 3156 76C9 14                    inc  d
 3157 76CA 7E                    ld   a,(hl)
 3158 76CB 12                    ld   (de),a
 3159 76CC 23                    inc  hl
 3160 76CD 14                    inc  d
 3161 76CE 7E                    ld   a,(hl)
 3162 76CF 12                    ld   (de),a
 3163 76D0 23                    inc  hl
 3164 76D1 14                    inc  d
 3165 76D2 7E                    ld   a,(hl)
 3166 76D3 12                    ld   (de),a
 3167 76D4 23                    inc  hl
 3168 76D5 14                    inc  d
 3169 76D6 7E                    ld   a,(hl)
 3170 76D7 12                    ld   (de),a
 3171 76D8 23                    inc  hl
 3172 76D9 14                    inc  d
 3173 76DA 7E                    ld   a,(hl)
 3174 76DB 12                    ld   (de),a
 3175 76DC D1                    pop  de
 3176 76DD
 3177 76DD 1C                    inc  e
 3178 76DE 20 0A                 jr   nz,CHAR1B
 3179 76E0 7A                    ld   a,d
 3180 76E1 C6 08                 add  a,8
 3181 76E3 57                    ld   d,a
 3182 76E4 FE 58                 cp   88
 3183 76E6 38 02                 jr   c,CHAR1B
 3184 76E8 16 40                 ld   d,64
 3185 76EA ED 53 BB 76  CHAR1B   ld   (P_AT+1),de
 3186 76EE D9                    exx
 3187 76EF C9                    ret
 3188 76F0
 3189 76F0              ; Vykreslení rámečku
 3190 76F0              ; Vstup:
 3191 76F0              				;hl=adrvrm
 3192 76F0              				;bc,vyska * 256 + sirka
 3193 76F0              				;a=barva
 3194 76F0              RAMECEK
 3195 76F0 F5                    push af
 3196 76F1 E5                    push hl
 3197 76F2 C5                    push bc
 3198 76F3 22 BB 76              ld   (P_AT+1),hl
 3199 76F6
 3200 76F6 0D                    dec  c
 3201 76F7 0D                    dec  c
 3202 76F8 E5                    push hl
 3203 76F9 21 2E 76              ld   hl,SPECFNT
 3204 76FC 22 B7 76              ld   (FNT+1),hl
 3205 76FF C5                    push bc
 3206 7700
 3207 7700 3E 00                 ld   a,0
 3208 7702 CD AF 76              call PRINT
 3209 7705 41                    ld   b,c
 3210 7706 3E 01        RAM1     ld   a,1
 3211 7708 CD AF 76              call PRINT
 3212 770B 10 F9                 djnz RAM1
 3213 770D 3E 02                 ld   a,2
 3214 770F CD AF 76              call PRINT
 3215 7712 C1                    pop  bc
 3216 7713 E1                    pop  hl
 3217 7714 05                    dec  b
 3218 7715 05                    dec  b
 3219 7716 CD A5 76              call DOWNH
 3220 7719 22 BB 76              ld   (P_AT+1),hl
 3221 771C              RAM3
 3222 771C E5                    push hl
 3223 771D C5                    push bc
 3224 771E 3E 03                 ld   a,3
 3225 7720 CD AF 76              call PRINT
 3226 7723 41                    ld   b,c
 3227 7724 3E 04        RAM2     ld   a,4
 3228 7726 CD AF 76              call PRINT
 3229 7729 10 F9                 djnz RAM2
 3230 772B 3E 05                 ld   a,5
 3231 772D CD AF 76              call PRINT
 3232 7730 C1                    pop  bc
 3233 7731 E1                    pop  hl
 3234 7732 CD A5 76              call DOWNH
 3235 7735 22 BB 76              ld   (P_AT+1),hl
 3236 7738 10 E2                 djnz RAM3
 3237 773A
 3238 773A 3E 09                 ld   a,9
 3239 773C CD AF 76              call PRINT
 3240 773F 41                    ld   b,c
 3241 7740 3E 0A        RAM4     ld   a,10
 3242 7742 CD AF 76              call PRINT
 3243 7745 10 F9                 djnz RAM4
 3244 7747 3E 0B                 ld   a,11
 3245 7749 CD AF 76              call PRINT
 3246 774C
 3247 774C 21 00 3C              ld   hl,CHARS
 3248 774F 22 B7 76              ld   (FNT+1),hl
 3249 7752
 3250 7752 C1                    pop  bc
 3251 7753 E1                    pop  hl
 3252 7754 7C                    ld   a,h
 3253 7755 D6 40                 sub  64
 3254 7757 0F                    rrca
 3255 7758 0F                    rrca
 3256 7759 0F                    rrca
 3257 775A E6 03                 and  3
 3258 775C C6 58                 add  a,88
 3259 775E 67                    ld   h,a
 3260 775F
 3261 775F 0D                    dec  c
 3262 7760
 3263 7760 F1                    pop  af
 3264 7761
 3265 7761
 3266 7761 C5           ATRR     push bc
 3267 7762 E5                    push hl
 3268 7763 54                    ld   d,h
 3269 7764 5D                    ld   e,l
 3270 7765 1C                    inc  e
 3271 7766 06 00                 ld   b,0
 3272 7768 77                    ld   (hl),a
 3273 7769 ED B0                 ldir
 3274 776B E1                    pop  hl
 3275 776C 11 20 00              ld   de,32
 3276 776F 19                    add  hl,de
 3277 7770 C1                    pop  bc
 3278 7771 10 EE                 djnz ATRR
 3279 7773
 3280 7773 C9                    ret
 3281 7774
 3282 7774 43 75 72 73  tcursor defb "Cursors: move",0
 3282 7778 6F 72 73 3A
 3282 777C 20 6D 6F 76
 3282 7780 65 00
 3283 7782 45 6E 74 65  tenter defb "Enter: play song",0
 3283 7786 72 3A 20 70
 3283 778A 6C 61 79 20
 3283 778E 73 6F 6E 67
 3283 7792 00
 3284 7793 53 70 61 63  tspace defb "Space: play next",0
 3284 7797 65 3A 20 70
 3284 779B 6C 61 79 20
 3284 779F 6E 65 78 74
 3284 77A3 00
 3285 77A4 53 3A 20 73  tsearch defb "S: search",0
 3285 77A8 65 61 72 63
 3285 77AC 68 00
 3286 77AE 52 3A 20 72  treload defb "R: reload directory",0
 3286 77B2 65 6C 6F 61
 3286 77B6 64 20 64 69
 3286 77BA 72 65 63 74
 3286 77BE 6F 72 79 00
 3287 77C2
 3288 77C2              ; Nakreslí všechny okna potřebné pro NextPlayer
 3289 77C2              kresli:
 3290 77C2
 3291 77C2
 3292 77C2 21 20 40     		  ld   hl,16416
 3293 77C5 01 0E 14     		  ld   bc,20*256+14
 3294 77C8 3E 0F        		  ld   a,%00001111
 3295 77CA CD F0 76     		  call RAMECEK
 3296 77CD
 3297 77CD 21 EE 40     		  ld   hl,16608+14
 3298 77D0 01 12 0E     		  ld   bc,14*256+18
 3299 77D3 3E 0F        		  ld   a,%00001111
 3300 77D5 CD F0 76     		  call RAMECEK
 3301 77D8
 3302 77D8 21 2E 40     		  ld   hl,16416+14
 3303 77DB 01 12 06     		  ld   bc,6*256+18
 3304 77DE 3E 07        		  ld   a,%00000111
 3305 77E0 CD F0 76     		  call RAMECEK
 3306 77E3
 3307 77E3
 3308 77E3
 3309 77E3
 3310 77E3 21 01 40     		  ld   hl,16384+1
 3311 77E6 11 C1 78     		  ld   de,TEXT1
 3312 77E9 CD DD 79     		  call TEXT
 3313 77EC
 3314 77EC 11 0E 40     		  ld   de,16384+ 14
 3315 77EF 21 CC 78     		  ld   hl,nnext
 3316 77F2 CD CD 7A     		  call print
 3317 77F5 21 0E 58     		ld hl,22528+14
 3318 77F8 3E 05        		ld a,5
 3319 77FA 06 11        		ld b,17
 3320 77FC 77           kk		ld (hl),a
 3321 77FD 23           		inc hl
 3322 77FE 10 FC        		djnz kk
 3323 7800
 3324 7800 21 4F 40              ld   hl,16448+15
 3325 7803 11 8A 78              ld   de,Versionn
 3326 7806 EB           		 ex de,hl
 3327 7807 CD CD 7A              call print
 3328 780A 21 6F 40              ld   hl,16480+15
 3329 780D 11 97 78              ld   de,Cursors
 3330 7810 EB                    ex de,hl
 3331 7811 CD CD 7A     		 call print
 3332 7814 21 8F 40              ld   hl,16512+15
 3333 7817 11 99 78              ld   de,Play
 3334 781A EB                    ex de,hl
 3335 781B CD CD 7A     		 call print
 3336 781E 21 AF 40              ld   hl,16544+15
 3337 7821 11 AD 78              ld   de,NextPlay
 3338 7824 EB                    ex de,hl
 3339 7825 CD CD 7A     		 call print
 3340 7828
 3341 7828 21 6F 48              ld   hl,18528+15
 3342 782B 11 74 77              ld   de,tcursor
 3343 782E EB                    ex de,hl
 3344 782F CD CD 7A     		 call print
 3345 7832 21 8F 48              ld   hl,18560+15
 3346 7835 11 82 77              ld   de,tenter
 3347 7838 EB                    ex de,hl
 3348 7839 CD CD 7A     		 call print
 3349 783C 21 AF 48              ld   hl,18592+15
 3350 783F 11 93 77              ld   de,tspace
 3351 7842 EB                    ex de,hl
 3352 7843 CD CD 7A     		 call print
 3353 7846 21 CF 48              ld   hl,18624+15
 3354 7849 11 A4 77              ld   de,tsearch
 3355 784C EB                    ex de,hl
 3356 784D CD CD 7A     		 call print
 3357 7850 21 EF 48              ld   hl,18656+15
 3358 7853 11 AE 77              ld   de,treload
 3359 7856 EB                    ex de,hl
 3360 7857 CD CD 7A     		 call print
 3361 785A 3E 0D        		ld a,00001101b
 3362 785C
 3363 785C 21 6F 59     		ld hl,11*32+22528 + 15
 3364 785F 06 0E        		ld b,14
 3365 7861 77           		ld (hl),a
 3366 7862 23           		inc hl
 3367 7863 10 FC        		djnz $-2
 3368 7865
 3369 7865 21 8F 59     		ld hl,12*32+22528 + 15
 3370 7868 06 0E        		ld b,14
 3371 786A 77           		ld (hl),a
 3372 786B 23           		inc hl
 3373 786C 10 FC        		djnz $-2
 3374 786E
 3375 786E 21 AF 59     		ld hl,13*32+22528 + 15
 3376 7871 06 0E        		ld b,14
 3377 7873 77           		ld (hl),a
 3378 7874 23           		inc hl
 3379 7875 10 FC        		djnz $-2
 3380 7877
 3381 7877 21 CF 59     		ld hl,14*32+22528 + 15
 3382 787A 06 0E        		ld b,14
 3383 787C 77           		ld (hl),a
 3384 787D 23           		inc hl
 3385 787E 10 FC        		djnz $-2
 3386 7880
 3387 7880 21 EF 59     		ld hl,15*32+22528 + 15
 3388 7883 06 0F        		ld b,15
 3389 7885 77           		ld (hl),a
 3390 7886 23           		inc hl
 3391 7887 10 FC        		djnz $-2
 3392 7889
 3393 7889
 3394 7889 C9                         ret
 3395 788A
 3396 788A 56 65 72 73  Versionn  defb "Version: 0.6",0
 3396 788E 69 6F 6E 3A
 3396 7892 20 30 2E 36
 3396 7896 00
 3397 7897 20 00        Cursors defb " ",0
 3398 7899 4D 61 69 6E  Play    defb "Main program: Shrek",0
 3398 789D 20 70 72 6F
 3398 78A1 67 72 61 6D
 3398 78A5 3A 20 53 68
 3398 78A9 72 65 6B 00
 3399 78AD 41 59 20 72  NextPlay defb "AY routines: mborik",0
 3399 78B1 6F 75 74 69
 3399 78B5 6E 65 73 3A
 3399 78B9 20 6D 62 6F
 3399 78BD 72 69 6B 00
 3400 78C1 4E 65 78 74  TEXT1    defb "NextPlayer",0
 3400 78C5 50 6C 61 79
 3400 78C9 65 72 00
 3401 78CC
 3402 78CC 20 20 66 6F  nnext    defb "  for ZX Spectrum Next",0
 3402 78D0 72 20 5A 58
 3402 78D4 20 53 70 65
 3402 78D8 63 74 72 75
 3402 78DC 6D 20 4E 65
 3402 78E0 78 74 00
 3403 78E3
 3404 78E3
 3405 78E3
 3406 78E3              WRFILES
 3407 78E3 CD 2A 65     		 call BUFF83
 3408 78E6 2A F3 79              ld   hl,(ALLFILES)
 3409 78E9 7D           		 ld a,l
 3410 78EA 11 12 00     		 ld de,18
 3411 78ED B7                    or a
 3412 78EE ED 52        		 sbc hl,de
 3413 78F0 38 02                 jr   c,WRF4
 3414 78F2 3E 12                 ld   a,18
 3415 78F4 47           WRF4     ld   b,a
 3416 78F5 21 41 40              ld   hl,16448+1
 3417 78F8 11 0D 80     WRBUFF   ld   de,catbuff+#D
 3418 78FB
 3419 78FB C5           WRF2     push bc
 3420 78FC E5                    push hl
 3421 78FD 22 BB 76              ld   (P_AT+1),hl
 3422 7900
 3423 7900 1A                    ld   a,(de)
 3424 7901 FE 20                 cp   32
 3425 7903 28 1A                 jr   z,ENDP
 3426 7905 CD 2B 79              call WRMOD
 3427 7908
 3428 7908 21 F5 79              ld   hl,POC
 3429 790B 34                    inc  (hl)
 3430 790C E1                    pop  hl
 3431 790D CD A5 76              call DOWNH
 3432 7910 C1                    pop  bc
 3433 7911 10 E8                 djnz WRF2
 3434 7913              E2
 3435 7913 3A 31 75              ld   a,(POS_F+1)
 3436 7916 0E 17                 ld   c,%00010111
 3437 7918 CD F6 79              call KURZOR
 3438 791B CD 3B 65     		 call NOBUFF83
 3439 791E C9                    ret
 3440 791F
 3441 791F E1           ENDP     pop  hl
 3442 7920 C1                    pop  bc
 3443 7921 21 F5 79              ld   hl,POC
 3444 7924 7E                    ld   a,(hl)
 3445 7925 32 F2 79              ld   (FILES),a
 3446 7928 18 E9                 jr   E2
 3447 792A 00           dir		 defb 0
 3448 792B              WRMOD
 3449 792B
 3450 792B
 3451 792B
 3452 792B              		 ;původni WRMOD
 3453 792B D5           		 push de
 3454 792C 21 07 00     		 ld hl,7
 3455 792F 19           		 add hl,de
 3456 7930 CB 7E        		 bit 7,(hl)
 3457 7932 28 07        		 jr z,neni_adr
 3458 7934 3E 01        		 ld a,1
 3459 7936 32 2A 79     		 ld (dir),a
 3460 7939 18 04        		 jr je_dir
 3461 793B AF           neni_adr xor a
 3462 793C 32 2A 79     		 ld (dir),a
 3463 793F              je_dir
 3464 793F D1           		 pop de
 3465 7940 DD 21 00 60  		 ld ix,filename
 3466 7944 06 08                 ld   b,8
 3467 7946 1A           WRF1     ld   a,(de)
 3468 7947 B7                    or   a
 3469 7948 28 30                 jr   z,WWR
 3470 794A DD 77 00     		 ld (ix+0),a
 3471 794D DD 23        		 inc ix
 3472 794F CB BF        		 res 7,a
 3473 7951 CD AF 76              call PRINT
 3474 7954 13                    inc  de
 3475 7955 10 EF                 djnz WRF1
 3476 7957 3A 2A 79     		 ld a,(dir)
 3477 795A B7           		 or a
 3478 795B 20 1F        		 jr nz,wwrdir
 3479 795D 3E 2E        		 ld a,"."
 3480 795F DD 77 00     		 ld (ix+0),a
 3481 7962 DD 23        		 inc ix
 3482 7964 CD AF 76     		 call PRINT
 3483 7967 06 03        		 ld b,3
 3484 7969 1A           wrf2	 ld a,(de)
 3485 796A CB BF        		 res 7,a
 3486 796C DD 77 00     		 ld (ix+0),a
 3487 796F DD 23        		 inc ix
 3488 7971
 3489 7971 CD AF 76     		 call PRINT
 3490 7974 13           		 inc de
 3491 7975 10 F2        		 djnz wrf2
 3492 7977 13           		 inc de
 3493 7978 13           		 inc de
 3494 7979 C9                    ret
 3495 797A              WWR
 3496 797A 13                    inc  de
 3497 797B C9                    ret
 3498 797C
 3499 797C              wwrdir
 3500 797C D5           		push de
 3501 797D 3E 20        		ld a,32
 3502 797F CD AF 76     		call PRINT
 3503 7982 3E 44        		ld a,"D"
 3504 7984 CD AF 76     		call PRINT
 3505 7987 3E 49        		ld a,"I"
 3506 7989 CD AF 76     		call PRINT
 3507 798C 3E 52        		ld a,"R"
 3508 798E CD AF 76     		call PRINT
 3509 7991 D1           		pop de
 3510 7992
 3511 7992 13           		inc de
 3512 7993 13           		inc de
 3513 7994 13           		inc de
 3514 7995 13           		inc de
 3515 7996              		;inc de
 3516 7996 13           		inc de
 3517 7997 C9           		ret
 3518 7998
 3519 7998 CD 2A 65     NOWRMOD	 call BUFF83
 3520 799B DD 21 00 60  		 ld ix,filename
 3521 799F 06 08                 ld   b,8
 3522 79A1 1A           aWRF1     ld   a,(de)
 3523 79A2 B7                    or   a
 3524 79A3 28 22                 jr   z,aWWR
 3525 79A5 DD 77 00     		 ld (ix+0),a
 3526 79A8 DD 23        		 inc ix
 3527 79AA                       ;call PRINT
 3528 79AA 13                    inc  de
 3529 79AB 10 F4                 djnz aWRF1
 3530 79AD 3E 2E        		 ld a,"."
 3531 79AF DD 77 00     		 ld (ix+0),a
 3532 79B2 DD 23        		 inc ix
 3533 79B4
 3534 79B4              ;		 call PRINT
 3535 79B4 06 03        		 ld b,3
 3536 79B6 1A           awrf2	 ld a,(de)
 3537 79B7 CB BF        		 res 7,a
 3538 79B9 DD 77 00     		 ld (ix+0),a
 3539 79BC DD 23        		 inc ix
 3540 79BE
 3541 79BE              ;		 call PRINT
 3542 79BE 13           		 inc de
 3543 79BF 10 F5        		 djnz awrf2
 3544 79C1 13           		 inc de
 3545 79C2 13           		 inc de
 3546 79C3 CD 3B 65              call NOBUFF83
 3547 79C6 C9           		 ret
 3548 79C7              aWWR
 3549 79C7 13                    inc  de
 3550 79C8 CD 3B 65     		 call NOBUFF83
 3551 79CB C9                    ret
 3552 79CC
 3553 79CC
 3554 79CC              S_TEXT
 3555 79CC 01 2E 76              ld   bc,SPECFNT
 3556 79CF ED 43 B7 76           ld   (FNT+1),bc
 3557 79D3 CD DD 79              call TEXT
 3558 79D6 21 00 3C              ld   hl,CHARS
 3559 79D9 22 B7 76              ld   (FNT+1),hl
 3560 79DC C9                    ret
 3561 79DD              TEXT
 3562 79DD 22 BB 76              ld   (P_AT+1),hl
 3563 79E0 EB                    ex   de,hl
 3564 79E1              TEX1
 3565 79E1 7E                    ld   a,(hl)
 3566 79E2 B7                    or   a
 3567 79E3 C8                    ret  z
 3568 79E4 CB 7F        		 bit 7,a
 3569 79E6 CB BF        		 res 7,a
 3570 79E8 C2 AF 76     		 jp nz,PRINT
 3571 79EB CD AF 76              call PRINT
 3572 79EE 23                    inc  hl
 3573 79EF 18 F0                 jr   TEX1
 3574 79F1 C9                    ret
 3575 79F2 00           FILES    defb 0
 3576 79F3 00 00        ALLFILES defb 0,0
 3577 79F5 00           POC      defb 0
 3578 79F6
 3579 79F6              KURZOR
 3580 79F6 F5                    push af
 3581 79F7 87                    add  a,a
 3582 79F8 87                    add  a,a
 3583 79F9 87                    add  a,a
 3584 79FA 6F                    ld   l,a
 3585 79FB 26 00                 ld   h,0
 3586 79FD 29                    add  hl,hl
 3587 79FE 29                    add  hl,hl
 3588 79FF 11 41 58              ld   de,22528+64+1
 3589 7A02 19                    add  hl,de
 3590 7A03 5D                    ld   e,l
 3591 7A04 54                    ld   d,h
 3592 7A05 13                    inc  de
 3593 7A06 71                    ld   (hl),c
 3594 7A07 01 0B 00              ld   bc,11
 3595 7A0A ED B0                 ldir
 3596 7A0C F1                    pop  af
 3597 7A0D C9                    ret
 3598 7A0E
 3599 7A0E              PRN_F
 3600 7A0E CD 2A 65     		 call BUFF83
 3601 7A11 22 BB 76              ld   (P_AT+1),hl
 3602 7A14 2A DB 75     		 ld hl,(apos_all)
 3603 7A17
 3604 7A17 7D           		 ld a,l
 3605 7A18 B4           		 or h
 3606 7A19 EB           		 ex de,hl
 3607 7A1A 21 0D 80     		 ld hl,catbuff+#d
 3608 7A1D 28 0E        		 jr z,F12
 3609 7A1F 21 00 80     		 ld hl,catbuff
 3610 7A22 42           		 ld b,d
 3611 7A23 4B           		 ld c,e
 3612 7A24 11 0D 00     		 ld de,13
 3613 7A27 19           F02      add hl,de
 3614 7A28
 3615 7A28 78           		 ld a,b
 3616 7A29 B1           		 or c
 3617 7A2A 0B           		 dec bc
 3618 7A2B 20 FA        		 jr nz,F02
 3619 7A2D              F12
 3620 7A2D EB                    ex   de,hl
 3621 7A2E CD 2B 79              call WRMOD
 3622 7A31 CD 3B 65     		 call NOBUFF83
 3623 7A34 C9                    ret
 3624 7A35
 3625 7A35
 3626 7A35 ED 91 57 12  INIROLL  nextreg $57,18
 3627 7A39 06 88                 ld   b,17*8
 3628 7A3B 21 20 E2              ld   hl,UPDATA
 3629 7A3E              IR1
 3630 7A3E 11 61 40     INI1     ld   de,16480+1
 3631 7A41 73                    ld   (hl),e
 3632 7A42 23                    inc  hl
 3633 7A43 72                    ld   (hl),d
 3634 7A44 23                    inc  hl
 3635 7A45 CD B8 7A              call DOWNDE
 3636 7A48 ED 53 3F 7A           ld   (INI1+1),de
 3637 7A4C
 3638 7A4C 11 41 40     INI2     ld   de,16448+1
 3639 7A4F 73                    ld   (hl),e
 3640 7A50 23                    inc  hl
 3641 7A51 72                    ld   (hl),d
 3642 7A52 23                    inc  hl
 3643 7A53 CD B8 7A              call DOWNDE
 3644 7A56 ED 53 4D 7A           ld   (INI2+1),de
 3645 7A5A 10 E2                 djnz IR1
 3646 7A5C
 3647 7A5C 06 88                 ld   b,17*8
 3648 7A5E 21 1F E2              ld   hl,UPDATA-1
 3649 7A61              IR2
 3650 7A61 11 61 40     INI12    ld   de,16480+1
 3651 7A64 72                    ld   (hl),d
 3652 7A65 2B                    dec  hl
 3653 7A66 73                    ld   (hl),e
 3654 7A67 2B                    dec  hl
 3655 7A68 CD B8 7A              call DOWNDE
 3656 7A6B ED 53 62 7A           ld   (INI12+1),de
 3657 7A6F
 3658 7A6F 11 41 40     INI22    ld   de,16448+1
 3659 7A72 72                    ld   (hl),d
 3660 7A73 2B                    dec  hl
 3661 7A74 73                    ld   (hl),e
 3662 7A75 2B                    dec  hl
 3663 7A76 CD B8 7A              call DOWNDE
 3664 7A79 ED 53 70 7A           ld   (INI22+1),de
 3665 7A7D 10 E2                 djnz IR2
 3666 7A7F
 3667 7A7F              ROLLUP
 3668 7A7F
 3669 7A7F 21 20 E2              ld   hl,UPDATA
 3670 7A82 C3 88 7A              jp   ROLL
 3671 7A85              ROLLDOWN
 3672 7A85 21 00 E0              ld   hl,DOWNDATA
 3673 7A88 ED 91 57 12  ROLL	 nextreg $57,18
 3674 7A8C ED 73 B1 7A           ld   (SP_ST+1),sp
 3675 7A90 F9                    ld   sp,hl
 3676 7A91 3E 88                 ld   a,8*17
 3677 7A93              ROLL1
 3678 7A93 E1                    pop  hl
 3679 7A94 D1                    pop  de
 3680 7A95
 3681 7A95 ED A0                 ldi
 3682 7A97 ED A0                 ldi
 3683 7A99 ED A0                 ldi
 3684 7A9B ED A0                 ldi
 3685 7A9D ED A0                 ldi
 3686 7A9F ED A0                 ldi
 3687 7AA1 ED A0                 ldi
 3688 7AA3 ED A0                 ldi
 3689 7AA5 ED A0                 ldi
 3690 7AA7 ED A0                 ldi
 3691 7AA9 ED A0                 ldi
 3692 7AAB ED A0                 ldi
 3693 7AAD
 3694 7AAD 3D                    dec  a
 3695 7AAE 20 E3                 jr   nz,ROLL1
 3696 7AB0
 3697 7AB0 31 00 00     SP_ST    ld   sp,0
 3698 7AB3 ED 91 57 01  		 nextreg $57,1				;Stránka na uložení VideoRam
 3699 7AB7 C9                    ret
 3700 7AB8
 3701 7AB8              DOWNDE
 3702 7AB8 14                    inc  d
 3703 7AB9 7A                    ld   a,d
 3704 7ABA E6 07                 and  7
 3705 7ABC C0                    ret  nz
 3706 7ABD 7B                    ld   a,e
 3707 7ABE C6 20                 add  a,32
 3708 7AC0 5F                    ld   e,a
 3709 7AC1 7A                    ld   a,d
 3710 7AC2 D8                    ret  c
 3711 7AC3 D6 08                 sub  8
 3712 7AC5 57                    ld   d,a
 3713 7AC6 C9                    ret
 3714 7AC7 00 00        maxpos	defw 0
 3715 7AC9 00 00        maxpos2 defw 0
 3716 7ACB 00           pp		defb 0
 3717 7ACC 00           pp_a	defb 0
 3718 7ACD E5           print:	push hl
 3719 7ACE D5           		push de
 3720 7ACF 21 37 00     		ld hl,55
 3721 7AD2 19           		add hl,de
 3722 7AD3
 3723 7AD3 22 C7 7A     		ld (maxpos),hl
 3724 7AD6 11 21 00     		ld de,33
 3725 7AD9 19           		add hl,de
 3726 7ADA 22 C9 7A     		ld (maxpos2),hl
 3727 7ADD D1           		pop de
 3728 7ADE E1           		pop hl
 3729 7ADF              ;		ld	de,printpos
 3730 7ADF ED 53 DD 7E  p6b		ld	(pos),de
 3731 7AE3 AF           		xor	a
 3732 7AE4 32 DF 7E     		ld	(roll),a
 3733 7AE7
 3734 7AE7              print1:
 3735 7AE7 E5           		push hl
 3736 7AE8 2A C7 7A     		ld hl,(maxpos)
 3737 7AEB B7                   or a
 3738 7AEC ED 5B DD 7E  		ld de,(pos)
 3739 7AF0 ED 52        		sbc hl,de
 3740 7AF2 20 07        		jr nz,pophl
 3741 7AF4 21 08 00     odskok	ld hl,8
 3742 7AF7 19           		add hl,de
 3743 7AF8 22 DD 7E     		ld (pos),hl
 3744 7AFB
 3745 7AFB
 3746 7AFB              pophl
 3747 7AFB 2A DD 7E     		ld hl,(pos)
 3748 7AFE ED 5B C9 7A  		ld de,(maxpos2)
 3749 7B02 B7           		or a
 3750 7B03 ED 52        		sbc hl,de
 3751 7B05 20 02        		jr nz, pophl2
 3752 7B07 E1           		pop hl
 3753 7B08 C9           		ret
 3754 7B09              pophl2
 3755 7B09 E1           		pop hl
 3756 7B0A E5           		push	hl
 3757 7B0B 7E           		ld	a,(hl)
 3758 7B0C E6 7F        		and	127
 3759 7B0E B7           		or a
 3760 7B0F 20 02        		jr nz,ppp1
 3761 7B11
 3762 7B11 3E 20        		ld a,32
 3763 7B13              ppp1
 3764 7B13 CD 41 7B     		call	ascii
 3765 7B16 3A DF 7E     		ld	a,(roll)
 3766 7B19 3C           		inc	a
 3767 7B1A FE 01        		cp	1
 3768 7B1C CC 39 7B     		call	z,print2
 3769 7B1F FE 02        		cp	2
 3770 7B21 CC 39 7B     		call	z,print2
 3771 7B24 FE 04        		cp	4
 3772 7B26 20 05        		jr	nz,print3
 3773 7B28 3E 00        		ld	a,0
 3774 7B2A CD 39 7B     		call	print2
 3775 7B2D              print3:
 3776 7B2D 32 DF 7E     		ld	(roll),a
 3777 7B30 E1           		pop	hl
 3778 7B31 E5           		push hl
 3779 7B32 7E           		ld a,(hl)
 3780 7B33 B7           		or a
 3781 7B34 E1           		pop hl
 3782 7B35 23           		inc	hl
 3783 7B36 C8           		ret	z
 3784 7B37 18 AE        		jr	print1
 3785 7B39
 3786 7B39              print2:
 3787 7B39 2A DD 7E     		ld	hl,(pos)
 3788 7B3C 23           		inc	hl
 3789 7B3D 22 DD 7E     		ld	(pos),hl
 3790 7B40 C9           		ret
 3791 7B41
 3792 7B41              ascii:
 3793 7B41 01 DD 7B     		ld	bc,font
 3794 7B44 C5           		push	bc
 3795 7B45 D6 20        		sub	32
 3796 7B47 5F           		ld	e,a
 3797 7B48 16 00        		ld	d,0
 3798 7B4A 06 08        		ld	b,8
 3799 7B4C 21 00 00     		ld	hl,0
 3800 7B4F              x8:
 3801 7B4F 19           		add	hl,de
 3802 7B50 10 FD        		djnz	x8
 3803 7B52 C1           		pop	bc
 3804 7B53 09           		add	hl,bc
 3805 7B54 ED 5B DD 7E  		ld	de,(pos)
 3806 7B58 EB           		ex	de,hl
 3807 7B59              asci0:
 3808 7B59 3A DF 7E     		ld	a,(roll)
 3809 7B5C FE 03        		cp	3
 3810 7B5E 28 40        		jr	z,roll3
 3811 7B60 FE 02        		cp	2
 3812 7B62 28 1E        		jr	z,roll2
 3813 7B64 FE 01        		cp	1
 3814 7B66 28 04        		jr	z,roll1
 3815 7B68              roll0:
 3816 7B68 CD B0 7B     		call	asci1
 3817 7B6B C9           		ret
 3818 7B6C
 3819 7B6C              roll1:
 3820 7B6C 06 08        		ld	b,8
 3821 7B6E              rol1_1:
 3822 7B6E 1A           		ld	a,(de)
 3823 7B6F CB 27        		sla	a
 3824 7B71 0E 00        		ld	c,0
 3825 7B73 CB 11        		rl	c
 3826 7B75 CB 27        		sla	a
 3827 7B77 CB 11        		rl	c
 3828 7B79 C5           		push	bc
 3829 7B7A CD BB 7B     		call	asci2
 3830 7B7D C1           		pop	bc
 3831 7B7E 13           		inc	de
 3832 7B7F 10 ED        		djnz	rol1_1
 3833 7B81 C9           		ret
 3834 7B82
 3835 7B82              roll2:
 3836 7B82 06 08        		ld	b,8
 3837 7B84              rol2_1:
 3838 7B84 1A           		ld	a,(de)
 3839 7B85 CB 27        		sla	a
 3840 7B87 0E 00        		ld	c,0
 3841 7B89 CB 11        		rl	c
 3842 7B8B CB 27        		sla	a
 3843 7B8D CB 11        		rl	c
 3844 7B8F CB 27        		sla	a
 3845 7B91 CB 11        		rl	c
 3846 7B93 CB 27        		sla	a
 3847 7B95 CB 11        		rl	c
 3848 7B97 C5           		push	bc
 3849 7B98 CD BB 7B     		call	asci2
 3850 7B9B C1           		pop	bc
 3851 7B9C 13           		inc	de
 3852 7B9D 10 E5        		djnz	rol2_1
 3853 7B9F C9           		ret
 3854 7BA0
 3855 7BA0              roll3:
 3856 7BA0 06 08        		ld	b,8
 3857 7BA2              rol3_1:
 3858 7BA2 1A           		ld	a,(de)
 3859 7BA3 CB 3F        		srl	a
 3860 7BA5 CB 3F        		srl	a
 3861 7BA7 C5           		push	bc
 3862 7BA8 CD C5 7B     		call	asci3
 3863 7BAB C1           		pop	bc
 3864 7BAC 13           		inc	de
 3865 7BAD 10 F3        		djnz	rol3_1
 3866 7BAF C9           		ret
 3867 7BB0
 3868 7BB0              asci1:
 3869 7BB0 06 08        		ld	b,8
 3870 7BB2              asc1:
 3871 7BB2 1A           		ld	a,(de)
 3872 7BB3 77           		ld	(hl),a
 3873 7BB4 13           		inc	de
 3874 7BB5 CD C7 7B     		call	downhl
 3875 7BB8 10 F8        		djnz	asc1
 3876 7BBA C9           		ret
 3877 7BBB
 3878 7BBB              asci2:
 3879 7BBB 77           		ld	(hl),a
 3880 7BBC 79           		ld	a,c
 3881 7BBD 2B           		dec	hl
 3882 7BBE B6           		or	(hl)
 3883 7BBF 77           		ld	(hl),a
 3884 7BC0 23           		inc	hl
 3885 7BC1 CD C7 7B     		call	downhl
 3886 7BC4 C9           		ret
 3887 7BC5
 3888 7BC5              asci3:
 3889 7BC5 B6           		or	(hl)
 3890 7BC6 77           		ld	(hl),a
 3891 7BC7
 3892 7BC7              downhl:
 3893 7BC7 24           		inc	h
 3894 7BC8 7C           		ld	a,h
 3895 7BC9 E6 07        		and	7
 3896 7BCB C0           		ret	nz
 3897 7BCC 7D           		ld	a,l
 3898 7BCD C6 20        		add	a,32
 3899 7BCF 6F           		ld	l,a
 3900 7BD0 7C           		ld	a,h
 3901 7BD1 38 03        		jr	c,down2
 3902 7BD3 D6 08        		sub	8
 3903 7BD5 67           		ld	h,a
 3904 7BD6              down2:
 3905 7BD6 FE 58        		cp	88
 3906 7BD8 D8           		ret	c
 3907 7BD9 21 40 00     		ld	hl,64
 3908 7BDC C9           		ret
 3909 7BDD
 3910 7BDD              ;5-bit font
 3911 7BDD              font:
 3912 7BDD 00 00 00 00  		db	$00, $00, $00, $00, $00, $00, $00, $00
 3912 7BE1 00 00 00 00
 3913 7BE5 00 20 20 20  		db	$00, $20, $20, $20, $20, $00, $20, $00
 3913 7BE9 20 00 20 00
 3914 7BED 00 50 50 00  		db	$00, $50, $50, $00, $00, $00, $00, $00
 3914 7BF1 00 00 00 00
 3915 7BF5 00 50 F8 50  		db	$00, $50, $F8, $50, $50, $F8, $50, $00
 3915 7BF9 50 F8 50 00
 3916 7BFD 00 20 F8 A0  		db	$00, $20, $F8, $A0, $F8, $28, $F8, $20
 3916 7C01 F8 28 F8 20
 3917 7C05 00 40 A8 50  		db	$00, $40, $A8, $50, $20, $50, $A8, $10
 3917 7C09 20 50 A8 10
 3918 7C0D 00 20 50 20  		db	$00, $20, $50, $20, $68, $90, $68, $00
 3918 7C11 68 90 68 00
 3919 7C15 00 10 20 00  		db	$00, $10, $20, $00, $00, $00, $00, $00
 3919 7C19 00 00 00 00
 3920 7C1D 00 08 10 10  		db	$00, $08, $10, $10, $10, $10, $08, $00
 3920 7C21 10 10 08 00
 3921 7C25 00 40 20 20  		db	$00, $40, $20, $20, $20, $20, $40, $00
 3921 7C29 20 20 40 00
 3922 7C2D 00 00 50 20  		db	$00, $00, $50, $20, $F8, $20, $50, $00
 3922 7C31 F8 20 50 00
 3923 7C35 00 00 20 20  		db	$00, $00, $20, $20, $F8, $20, $20, $00
 3923 7C39 F8 20 20 00
 3924 7C3D 00 00 00 00  		db	$00, $00, $00, $00, $00, $10, $10, $20
 3924 7C41 00 10 10 20
 3925 7C45 00 00 00 00  		db	$00, $00, $00, $00, $78, $00, $00, $00
 3925 7C49 78 00 00 00
 3926 7C4D 00 00 00 00  		db	$00, $00, $00, $00, $00, $30, $30, $00
 3926 7C51 00 30 30 00
 3927 7C55 00 00 08 10  		db	$00, $00, $08, $10, $20, $40, $80, $00
 3927 7C59 20 40 80 00
 3928 7C5D 00 70 98 A8  		db	$00, $70, $98, $A8, $A8, $C8, $70, $00
 3928 7C61 A8 C8 70 00
 3929 7C65 00 60 A0 20  		db	$00, $60, $A0, $20, $20, $20, $F8, $00
 3929 7C69 20 20 F8 00
 3930 7C6D 00 70 88 08  		db	$00, $70, $88, $08, $70, $80, $F8, $00
 3930 7C71 70 80 F8 00
 3931 7C75 00 70 88 30  		db	$00, $70, $88, $30, $08, $88, $70, $00
 3931 7C79 08 88 70 00
 3932 7C7D 00 10 30 50  		db	$00, $10, $30, $50, $90, $F8, $10, $00
 3932 7C81 90 F8 10 00
 3933 7C85 00 F8 80 F0  		db	$00, $F8, $80, $F0, $08, $88, $70, $00
 3933 7C89 08 88 70 00
 3934 7C8D 00 70 80 F0  		db	$00, $70, $80, $F0, $88, $88, $70, $00
 3934 7C91 88 88 70 00
 3935 7C95 00 F8 08 10  		db	$00, $F8, $08, $10, $20, $40, $40, $00
 3935 7C99 20 40 40 00
 3936 7C9D 00 70 88 70  		db	$00, $70, $88, $70, $88, $88, $70, $00
 3936 7CA1 88 88 70 00
 3937 7CA5 00 70 88 88  		db	$00, $70, $88, $88, $78, $08, $70, $00
 3937 7CA9 78 08 70 00
 3938 7CAD 00 00 00 20  		db	$00, $00, $00, $20, $00, $00, $20, $00
 3938 7CB1 00 00 20 00
 3939 7CB5 00 00 20 00  		db	$00, $00, $20, $00, $00, $20, $20, $40
 3939 7CB9 00 20 20 40
 3940 7CBD 00 00 08 10  		db	$00, $00, $08, $10, $20, $10, $08, $00
 3940 7CC1 20 10 08 00
 3941 7CC5 00 00 00 78  		db	$00, $00, $00, $78, $00, $78, $00, $00
 3941 7CC9 00 78 00 00
 3942 7CCD 00 00 20 10  		db	$00, $00, $20, $10, $08, $10, $20, $00
 3942 7CD1 08 10 20 00
 3943 7CD5 00 70 88 10  		db	$00, $70, $88, $10, $20, $00, $20, $00
 3943 7CD9 20 00 20 00
 3944 7CDD 00 70 08 68  		db	$00, $70, $08, $68, $A8, $A8, $70, $00
 3944 7CE1 A8 A8 70 00
 3945 7CE5 00 70 88 88  		db	$00, $70, $88, $88, $F8, $88, $88, $00
 3945 7CE9 F8 88 88 00
 3946 7CED 00 F0 88 F0  		db	$00, $F0, $88, $F0, $88, $88, $F0, $00
 3946 7CF1 88 88 F0 00
 3947 7CF5 00 70 88 80  		db	$00, $70, $88, $80, $80, $88, $70, $00
 3947 7CF9 80 88 70 00
 3948 7CFD 00 E0 90 88  		db	$00, $E0, $90, $88, $88, $90, $E0, $00
 3948 7D01 88 90 E0 00
 3949 7D05 00 F8 80 F0  		db	$00, $F8, $80, $F0, $80, $80, $F8, $00
 3949 7D09 80 80 F8 00
 3950 7D0D 00 F8 80 F0  		db	$00, $F8, $80, $F0, $80, $80, $80, $00
 3950 7D11 80 80 80 00
 3951 7D15 00 70 88 80  		db	$00, $70, $88, $80, $B8, $88, $70, $00
 3951 7D19 B8 88 70 00
 3952 7D1D 00 88 88 F8  		db	$00, $88, $88, $F8, $88, $88, $88, $00
 3952 7D21 88 88 88 00
 3953 7D25 00 F8 20 20  		db	$00, $F8, $20, $20, $20, $20, $F8, $00
 3953 7D29 20 20 F8 00
 3954 7D2D 00 08 08 08  		db	$00, $08, $08, $08, $88, $88, $70, $00
 3954 7D31 88 88 70 00
 3955 7D35 00 90 A0 C0  		db	$00, $90, $A0, $C0, $A0, $90, $88, $00
 3955 7D39 A0 90 88 00
 3956 7D3D 00 80 80 80  		db	$00, $80, $80, $80, $80, $80, $F8, $00
 3956 7D41 80 80 F8 00
 3957 7D45 00 88 D8 A8  		db	$00, $88, $D8, $A8, $88, $88, $88, $00
 3957 7D49 88 88 88 00
 3958 7D4D 00 88 C8 A8  		db	$00, $88, $C8, $A8, $98, $88, $88, $00
 3958 7D51 98 88 88 00
 3959 7D55 00 70 88 88  		db	$00, $70, $88, $88, $88, $88, $70, $00
 3959 7D59 88 88 70 00
 3960 7D5D 00 F0 88 88  		db	$00, $F0, $88, $88, $F0, $80, $80, $00
 3960 7D61 F0 80 80 00
 3961 7D65 00 70 88 88  		db	$00, $70, $88, $88, $A8, $98, $70, $00
 3961 7D69 A8 98 70 00
 3962 7D6D 00 F0 88 88  		db	$00, $F0, $88, $88, $F0, $90, $88, $00
 3962 7D71 F0 90 88 00
 3963 7D75 00 70 80 70  		db	$00, $70, $80, $70, $08, $88, $70, $00
 3963 7D79 08 88 70 00
 3964 7D7D 00 F8 20 20  		db	$00, $F8, $20, $20, $20, $20, $20, $00
 3964 7D81 20 20 20 00
 3965 7D85 00 88 88 88  		db	$00, $88, $88, $88, $88, $88, $70, $00
 3965 7D89 88 88 70 00
 3966 7D8D 00 88 88 88  		db	$00, $88, $88, $88, $88, $50, $20, $00
 3966 7D91 88 50 20 00
 3967 7D95 00 88 88 88  		db	$00, $88, $88, $88, $88, $A8, $50, $00
 3967 7D99 88 A8 50 00
 3968 7D9D 00 88 50 20  		db	$00, $88, $50, $20, $20, $50, $88, $00
 3968 7DA1 20 50 88 00
 3969 7DA5 00 88 50 20  		db	$00, $88, $50, $20, $20, $20, $20, $00
 3969 7DA9 20 20 20 00
 3970 7DAD 00 F8 08 30  		db	$00, $F8, $08, $30, $40, $80, $F8, $00
 3970 7DB1 40 80 F8 00
 3971 7DB5 00 38 20 20  		db	$00, $38, $20, $20, $20, $20, $38, $00
 3971 7DB9 20 20 38 00
 3972 7DBD 00 00 80 40  		db	$00, $00, $80, $40, $20, $10, $08, $00
 3972 7DC1 20 10 08 00
 3973 7DC5 00 70 10 10  		db	$00, $70, $10, $10, $10, $10, $70, $00
 3973 7DC9 10 10 70 00
 3974 7DCD 00 20 70 A8  		db	$00, $20, $70, $A8, $20, $20, $20, $00
 3974 7DD1 20 20 20 00
 3975 7DD5 00 00 00 00  		db	$00, $00, $00, $00, $00, $00, $00, $FC
 3975 7DD9 00 00 00 FC
 3976 7DDD 00 30 48 E0  		db	$00, $30, $48, $E0, $40, $40, $F8, $00
 3976 7DE1 40 40 F8 00
 3977 7DE5 00 00 70 08  		db	$00, $00, $70, $08, $78, $88, $78, $00
 3977 7DE9 78 88 78 00
 3978 7DED 00 80 80 F0  		db	$00, $80, $80, $F0, $88, $88, $F0, $00
 3978 7DF1 88 88 F0 00
 3979 7DF5 00 00 38 40  		db	$00, $00, $38, $40, $40, $40, $38, $00
 3979 7DF9 40 40 38 00
 3980 7DFD 00 08 08 78  		db	$00, $08, $08, $78, $88, $88, $78, $00
 3980 7E01 88 88 78 00
 3981 7E05 00 00 70 88  		db	$00, $00, $70, $88, $F0, $80, $78, $00
 3981 7E09 F0 80 78 00
 3982 7E0D 00 30 40 60  		db	$00, $30, $40, $60, $40, $40, $40, $00
 3982 7E11 40 40 40 00
 3983 7E15 00 00 78 88  		db	$00, $00, $78, $88, $88, $78, $08, $70
 3983 7E19 88 78 08 70
 3984 7E1D 00 80 80 F0  		db	$00, $80, $80, $F0, $88, $88, $88, $00
 3984 7E21 88 88 88 00
 3985 7E25 00 20 00 60  		db	$00, $20, $00, $60, $20, $20, $70, $00
 3985 7E29 20 20 70 00
 3986 7E2D 00 08 00 08  		db	$00, $08, $00, $08, $08, $08, $48, $30
 3986 7E31 08 08 48 30
 3987 7E35 00 40 50 60  		db	$00, $40, $50, $60, $60, $50, $48, $00
 3987 7E39 60 50 48 00
 3988 7E3D 00 40 40 40  		db	$00, $40, $40, $40, $40, $40, $30, $00
 3988 7E41 40 40 30 00
 3989 7E45 00 00 D0 A8  		db	$00, $00, $D0, $A8, $A8, $A8, $A8, $00
 3989 7E49 A8 A8 A8 00
 3990 7E4D 00 00 F0 88  		db	$00, $00, $F0, $88, $88, $88, $88, $00
 3990 7E51 88 88 88 00
 3991 7E55 00 00 70 88  		db	$00, $00, $70, $88, $88, $88, $70, $00
 3991 7E59 88 88 70 00
 3992 7E5D 00 00 F0 88  		db	$00, $00, $F0, $88, $88, $F0, $80, $80
 3992 7E61 88 F0 80 80
 3993 7E65 00 00 78 88  		db	$00, $00, $78, $88, $88, $78, $08, $08
 3993 7E69 88 78 08 08
 3994 7E6D 00 00 38 40  		db	$00, $00, $38, $40, $40, $40, $40, $00
 3994 7E71 40 40 40 00
 3995 7E75 00 00 70 80  		db	$00, $00, $70, $80, $70, $08, $F0, $00
 3995 7E79 70 08 F0 00
 3996 7E7D 00 20 70 20  		db	$00, $20, $70, $20, $20, $20, $18, $00
 3996 7E81 20 20 18 00
 3997 7E85 00 00 88 88  		db	$00, $00, $88, $88, $88, $88, $70, $00
 3997 7E89 88 88 70 00
 3998 7E8D 00 00 88 88  		db	$00, $00, $88, $88, $50, $50, $20, $00
 3998 7E91 50 50 20 00
 3999 7E95 00 00 88 A8  		db	$00, $00, $88, $A8, $A8, $A8, $50, $00
 3999 7E99 A8 A8 50 00
 4000 7E9D 00 00 88 50  		db	$00, $00, $88, $50, $20, $50, $88, $00
 4000 7EA1 20 50 88 00
 4001 7EA5 00 00 88 88  		db	$00, $00, $88, $88, $88, $78, $08, $70
 4001 7EA9 88 78 08 70
 4002 7EAD 00 00 F8 10  		db	$00, $00, $F8, $10, $20, $40, $F8, $00
 4002 7EB1 20 40 F8 00
 4003 7EB5 00 38 20 C0  		db	$00, $38, $20, $C0, $20, $20, $38, $00
 4003 7EB9 20 20 38 00
 4004 7EBD 00 10 10 10  		db	$00, $10, $10, $10, $10, $10, $10, $00
 4004 7EC1 10 10 10 00
 4005 7EC5 00 E0 20 18  		db	$00, $E0, $20, $18, $20, $20, $E0, $00
 4005 7EC9 20 20 E0 00
 4006 7ECD 00 28 50 00  		db	$00, $28, $50, $00, $00, $00, $00, $00
 4006 7ED1 00 00 00 00
 4007 7ED5 00 78 84 B4  		db	$00, $78, $84, $B4, $B4, $84, $78, $00
 4007 7ED9 B4 84 78 00
 4008 7EDD
 4009 7EDD 00 00        pos:		dw	0
 4010 7EDF 00           roll:		db	0
 4011 7EE0 00 00 00...  txtbuf:		ds	44
 4012 7F0C
 4013 7F0C              text:
 4014 7F0C 4E 6F 77 20  		db	"Now playing: ",0
 4014 7F10 70 6C 61 79
 4014 7F14 69 6E 67 3A
 4014 7F18 20 00
 4015 7F1A 41 6C 6C 20  txtallfiles db "All files:",0
 4015 7F1E 66 69 6C 65
 4015 7F22 73 3A 00
 4016 7F25 50 6F 73 69  txtcurrentfile db "Position:",0
 4016 7F29 74 69 6F 6E
 4016 7F2D 3A 00
 4017 7F2F
 4018 7F2F              DOWNDATA equ $e000
 4019 7F2F              UPDATA   equ DOWNDATA + 4*8*17
 4020 7F2F              bufscr equ $e000
 4021 7F2F              KKK
 4022 7F2F
 4023 7F2F              			org #9000
 4024 9000 00 00 00...  txtbuff    ds 100
 4025 9064
 4026 9064              			module key
 4027 9064
 4028 9064              check
 4029 9064              ahl0
 4030 9064 CD 6F 74     		 call KEYSCAN
 4031 9067
 4032 9067 7B           		 ld   a,e
 4033 9068 3C                    inc  a
 4034 9069 C8                    ret z
 4035 906A 7A                    ld   a,d
 4036 906B 21 A0 74              ld   hl,SYMTAB
 4037 906E FE 18                 cp   $18
 4038 9070 28 0A                 jr   z,aHLSM2
 4039 9072 21 C8 74              ld   hl,CAPSTAB
 4040 9075 FE 27                 cp   $27
 4041 9077 28 03                 jr   z,aHLSM2
 4042 9079 21 EF 74              ld   hl,NORMTAB
 4043 907C 16 00        aHLSM2    ld   d,0
 4044 907E 19                    add  hl,de
 4045 907F 7E                    ld   a,(hl)
 4046 9080 B7                    or   a
 4047 9081 C8                    ret z
 4048 9082
 4049 9082 06 00        aLAST_KEY ld   b,0
 4050 9084 B8                    cp   b
 4051 9085 28 00                 jr   z,aSEDI_KEY
 4052 9087
 4053 9087              aSEDI_KEY
 4054 9087 32 83 90              ld   (aLAST_KEY+1),a
 4055 908A F5           		push af
 4056 908B              		;call beepk
 4057 908B F1           		pop af
 4058 908C C9           		ret
 4059 908D              			endmodule
 4060 908D
 4061 908D
 4062 908D              infosong
 4063 908D E5           			push hl
 4064 908E 21 00 90     			ld hl,txtbuff
 4065 9091 11 01 90     			ld de,txtbuff+1
 4066 9094 01 63 00     			ld bc,99
 4067 9097 3E 20        			ld a,32
 4068 9099 77           			ld (hl),a
 4069 909A ED B0        			ldir
 4070 909C E1           			pop hl
 4071 909D
 4072 909D 11 00 90     			ld de,txtbuff
 4073 90A0 06 5A        			ld b,90
 4074 90A2 7E           i1			ld a,(hl)
 4075 90A3 FE 20        			cp 32
 4076 90A5 D8           			ret c
 4077 90A6 FE 80        			cp 128
 4078 90A8 D0           			ret nc
 4079 90A9 12           			ld (de),a
 4080 90AA 13           			inc de
 4081 90AB 23           			inc hl
 4082 90AC 10 F4        			djnz i1
 4083 90AE C9           			ret
 4084 90AF
 4085 90AF 00           pocitadlo	defb 0
 4086 90B0 00           ACBhlas		defb 0
 4087 90B1
 4088 90B1 F3           STCPLAY	di
 4089 90B2
 4090 90B2 21 A0 50     			ld hl,20640
 4091 90B5 11 D3 65     			ld de,by1
 4092 90B8 06 18        			ld b,8*3
 4093 90BA D5           sappp        push de
 4094 90BB C5           			push bc
 4095 90BC E5           			push hl
 4096 90BD 06 20        			ld b,32
 4097 90BF 1A           sappp0		ld a,(de)
 4098 90C0 77           			ld (hl),a
 4099 90C1 23           			inc hl
 4100 90C2 10 FB        			djnz sappp0
 4101 90C4 E1           			pop hl
 4102 90C5 C1           			pop bc
 4103 90C6 D1           			pop de
 4104 90C7
 4105 90C7 CD C7 7B     			call downhl
 4106 90CA 13           			inc de
 4107 90CB 10 ED        			djnz sappp
 4108 90CD
 4109 90CD
 4110 90CD              			; ld de,18464+15
 4111 90CD              			; ld hl,txtcurrentfile
 4112 90CD              			; call print
 4113 90CD
 4114 90CD              			; ld de,18432+15
 4115 90CD              			; ld hl,txtallfiles
 4116 90CD              			; call print
 4117 90CD
 4118 90CD
 4119 90CD              		; ld hl,(apos_all)
 4120 90CD              		; inc hl
 4121 90CD              		; ld de,18464+15+11
 4122 90CD              		; ld (NUMPOS+1),de
 4123 90CD              		; call DEC16
 4124 90CD              		; defw 20*256
 4125 90CD
 4126 90CD              		; ld hl,(ALLFILES)
 4127 90CD              		; ld de,18432+15+11
 4128 90CD              		; ld (NUMPOS+1),de
 4129 90CD              		; call DEC16
 4130 90CD              		; defw 20*256
 4131 90CD 3E 00        		ld a,0
 4132 90CF 21 A8 73     		ld hl,endsong
 4133 90D2 77           		ld (hl),a
 4134 90D3
 4135 90D3
 4136 90D3
 4137 90D3 21 15 BD     		ld hl,modstart + 7
 4138 90D6 CD 8D 90     		call infosong
 4139 90D9 21 00 90     		ld hl,txtbuff
 4140 90DC AF           		xor a
 4141 90DD 32 12 90     		ld (txtbuff+18),a
 4142 90E0 11 21 50             ld de,20512+1
 4143 90E3 CD CD 7A     		call print
 4144 90E6
 4145 90E6
 4146 90E6 CD CC A4     		call	stc.music_init
 4147 90E9 FB           .sloop	ei
 4148 90EA 76           		halt
 4149 90EB
 4150 90EB E5           		push hl
 4151 90EC D5           		push de
 4152 90ED C5           		push bc
 4153 90EE
 4154 90EE 21 B0 90     		ld hl,ACBhlas
 4155 90F1 AF           		xor a
 4156 90F2 77           		ld (hl),a
 4157 90F3
 4158 90F3 21 A0 5A     		 ld   hl,23200;Vymazání
 4159 90F6 11 A1 5A              ld   de,23201;předešlého
 4160 90F9 01 60 00              ld   bc,96   ;zobrazení.
 4161 90FC 70                    ld   (hl),b
 4162 90FD ED B0                 ldir
 4163 90FF
 4164 90FF 3E 08                 ld   a,8     ;A teď nové
 4165 9101 21 B0 5A              ld   hl,23216;zobrazení.
 4166 9104 11 AF 5A              ld   de,23215;Kanál A.
 4167 9107 CD A8 98              call ATR
 4168 910A
 4169 910A 3E 0A                 ld   a,10    ;Kanál C.
 4170 910C 21 D0 5A              ld   hl,23248
 4171 910F 11 CF 5A              ld   de,23247
 4172 9112 CD A8 98              call ATR
 4173 9115
 4174 9115 3E 09                 ld   a,9     ;Kanál B.
 4175 9117 21 F0 5A              ld   hl,23280
 4176 911A 11 EF 5A              ld   de,23279
 4177 911D CD A8 98              call ATR
 4178 9120
 4179 9120
 4180 9120 3A B0 90     		 ld a,(ACBhlas)
 4181 9123 B7           		 or a
 4182 9124 28 07        		 jr z,.s1
 4183 9126 21 AF 90     		 ld hl,pocitadlo
 4184 9129 AF           		 xor a
 4185 912A 77           		 ld (hl),a
 4186 912B 18 04        		 jr .s2
 4187 912D 21 AF 90     .s1		 ld hl,pocitadlo
 4188 9130 34           		 inc (hl)
 4189 9131              .s2
 4190 9131
 4191 9131 CD CE 98     		call keysetup
 4192 9134 C1           		pop bc
 4193 9135 D1           		pop de
 4194 9136 E1           		pop hl
 4195 9137
 4196 9137 CD A4 A5     		call	stc.music_play
 4197 913A AF           		xor a
 4198 913B 3A 5F 9A             ld a,(klavesa)
 4199 913E FE 01                cp 1
 4200 9140 28 18        		jr z,sakoneca
 4201 9142 FE 20        		cp 32
 4202 9144 28 0E        		jr z,.s3
 4203 9146 3A AF 90     		ld a,(pocitadlo)
 4204 9149 EE 64        		xor 100
 4205 914B 28 07        		jr z,.s3
 4206 914D 3A 26 A2     		ld a,(music_setup)
 4207 9150 CB 7F        		bit 7,a
 4208 9152 28 95        		jr z,.sloop
 4209 9154
 4210 9154 3E 20        .s3		ld a,32
 4211 9156 21 A8 73     		ld hl,endsong
 4212 9159 77           		ld (hl),a
 4213 915A F5           sakoneca	push af
 4214 915B
 4215 915B CD C2 A1     		call music_mute
 4216 915E F1           		pop af
 4217 915F C3 63 73     		jp navrat
 4218 9162
 4219 9162
 4220 9162
 4221 9162 F3           STPPLAY		di
 4222 9163
 4223 9163 21 A0 50     			ld hl,20640
 4224 9166 11 D3 65     			ld de,by1
 4225 9169 06 18        			ld b,8*3
 4226 916B D5           stappp        push de
 4227 916C C5           			push bc
 4228 916D E5           			push hl
 4229 916E 06 20        			ld b,32
 4230 9170 1A           stappp0		ld a,(de)
 4231 9171 77           			ld (hl),a
 4232 9172 23           			inc hl
 4233 9173 10 FB        			djnz stappp0
 4234 9175 E1           			pop hl
 4235 9176 C1           			pop bc
 4236 9177 D1           			pop de
 4237 9178
 4238 9178 CD C7 7B     			call downhl
 4239 917B 13           			inc de
 4240 917C 10 ED        			djnz stappp
 4241 917E
 4242 917E
 4243 917E              			; ld de,18464+15
 4244 917E              			; ld hl,txtcurrentfile
 4245 917E              			; call print
 4246 917E
 4247 917E              			; ld de,18432+15
 4248 917E              			; ld hl,txtallfiles
 4249 917E              			; call print
 4250 917E
 4251 917E
 4252 917E              		; ld hl,(apos_all)
 4253 917E              		; inc hl
 4254 917E              		; ld de,18464+15+11
 4255 917E              		; ld (NUMPOS+1),de
 4256 917E              		; call DEC16
 4257 917E              		; defw 20*256
 4258 917E
 4259 917E              		; ld hl,(ALLFILES)
 4260 917E              		; ld de,18432+15+11
 4261 917E              		; ld (NUMPOS+1),de
 4262 917E              		; call DEC16
 4263 917E              		; defw 20*256
 4264 917E 3E 00        		ld a,0
 4265 9180 21 A8 73     		ld hl,endsong
 4266 9183 77           		ld (hl),a
 4267 9184
 4268 9184
 4269 9184
 4270 9184 21 34 BD     		ld hl,modstart + 11 + 27
 4271 9187 CD 8D 90     		call infosong
 4272 918A 21 00 90     		ld hl,txtbuff
 4273 918D AF           		xor a
 4274 918E 32 50 90     		ld (txtbuff+80),a
 4275 9191
 4276 9191 21 68 73     		ld hl,tmp
 4277 9194 11 69 73     		ld de,tmp+1
 4278 9197 AF           		xor a
 4279 9198 77           		ld (hl),a
 4280 9199 01 30 00     		ld bc,48
 4281 919C ED B0        		ldir
 4282 919E
 4283 919E 21 00 90     		ld hl,txtbuff
 4284 91A1 11 68 73     		ld de,tmp
 4285 91A4 01 19 00     		ld bc,25
 4286 91A7 ED B0        		ldir
 4287 91A9 21 68 73     		ld hl,tmp
 4288 91AC 11 21 50             ld de,20512+1
 4289 91AF CD CD 7A     		call print
 4290 91B2
 4291 91B2
 4292 91B2
 4293 91B2
 4294 91B2
 4295 91B2 CD 4F B5     		call	stp.music_init
 4296 91B5 FB           .astloop	ei
 4297 91B6 76           		halt
 4298 91B7
 4299 91B7 E5           		push hl
 4300 91B8 D5           		push de
 4301 91B9 C5           		push bc
 4302 91BA
 4303 91BA 21 B0 90     		ld hl,ACBhlas
 4304 91BD AF           		xor a
 4305 91BE 77           		ld (hl),a
 4306 91BF
 4307 91BF 21 A0 5A     		 ld   hl,23200;Vymazání
 4308 91C2 11 A1 5A              ld   de,23201;předešlého
 4309 91C5 01 60 00              ld   bc,96   ;zobrazení.
 4310 91C8 70                    ld   (hl),b
 4311 91C9 ED B0                 ldir
 4312 91CB
 4313 91CB 3E 08                 ld   a,8     ;A teď nové
 4314 91CD 21 B0 5A              ld   hl,23216;zobrazení.
 4315 91D0 11 AF 5A              ld   de,23215;Kanál A.
 4316 91D3 CD A8 98              call ATR
 4317 91D6
 4318 91D6 3E 0A                 ld   a,10    ;Kanál C.
 4319 91D8 21 D0 5A              ld   hl,23248
 4320 91DB 11 CF 5A              ld   de,23247
 4321 91DE CD A8 98              call ATR
 4322 91E1
 4323 91E1 3E 09                 ld   a,9     ;Kanál B.
 4324 91E3 21 F0 5A              ld   hl,23280
 4325 91E6 11 EF 5A              ld   de,23279
 4326 91E9 CD A8 98              call ATR
 4327 91EC CD CE 98      		 call keysetup
 4328 91EF
 4329 91EF 3A B0 90     		 ld a,(ACBhlas)
 4330 91F2 B7           		 or a
 4331 91F3 28 07        		 jr z,.st1
 4332 91F5 21 AF 90     		 ld hl,pocitadlo
 4333 91F8 AF           		 xor a
 4334 91F9 77           		 ld (hl),a
 4335 91FA 18 04        		 jr .st2
 4336 91FC 21 AF 90     .st1		 ld hl,pocitadlo
 4337 91FF 34           		 inc (hl)
 4338 9200              .st2
 4339 9200 C1           		pop bc
 4340 9201 D1           		pop de
 4341 9202 E1           		pop hl
 4342 9203
 4343 9203 CD 86 B6     		call	stp.music_play
 4344 9206 AF           		xor a
 4345 9207 3A 5F 9A             ld a,(klavesa)
 4346 920A FE 01                cp	1
 4347 920C 28 18        		jr z,stakoneca
 4348 920E FE 20        		cp 32
 4349 9210 28 0E        		jr z,.st3
 4350 9212
 4351 9212 3A AF 90     		ld a,(pocitadlo)
 4352 9215 EE 64        		xor 100
 4353 9217 28 07        		jr z,.st3
 4354 9219 3A 26 A2     		ld a,(music_setup)
 4355 921C CB 7F        		bit 7,a
 4356 921E 28 95        		jr z,.astloop
 4357 9220
 4358 9220 3E 20        .st3		ld a,32
 4359 9222 21 A8 73     		ld hl,endsong
 4360 9225 77           		ld (hl),a
 4361 9226 F5           stakoneca	push af
 4362 9227
 4363 9227 CD 97 A6     		call stc.music_mute
 4364 922A F1           		pop af
 4365 922B C3 63 73     		jp navrat
 4366 922E
 4367 922E
 4368 922E 53 51 20 54  sqt_txt	defb "SQ Tracker", 0
 4368 9232 72 61 63 6B
 4368 9236 65 72 00
 4369 9239 F3           SQTPLAY	di
 4370 923A
 4371 923A 21 A0 50     			ld hl,20640
 4372 923D 11 D3 65     			ld de,by1
 4373 9240 06 18        			ld b,8*3
 4374 9242 D5           appp        push de
 4375 9243 C5           			push bc
 4376 9244 E5           			push hl
 4377 9245 06 20        			ld b,32
 4378 9247 1A           appp0		ld a,(de)
 4379 9248 77           			ld (hl),a
 4380 9249 23           			inc hl
 4381 924A 10 FB        			djnz appp0
 4382 924C E1           			pop hl
 4383 924D C1           			pop bc
 4384 924E D1           			pop de
 4385 924F
 4386 924F CD C7 7B     			call downhl
 4387 9252 13           			inc de
 4388 9253 10 ED        			djnz appp
 4389 9255
 4390 9255
 4391 9255              			; ld de,18464+15
 4392 9255              			; ld hl,txtcurrentfile
 4393 9255              			; call print
 4394 9255
 4395 9255              			; ld de,18432+15
 4396 9255              			; ld hl,txtallfiles
 4397 9255              			; call print
 4398 9255
 4399 9255
 4400 9255              		; ld hl,(apos_all)
 4401 9255              		; inc hl
 4402 9255              		; ld de,18464+15+11
 4403 9255              		; ld (NUMPOS+1),de
 4404 9255              		; call DEC16
 4405 9255              		; defw 20*256
 4406 9255
 4407 9255              		; ld hl,(ALLFILES)
 4408 9255              		; ld de,18432+15+11
 4409 9255              		; ld (NUMPOS+1),de
 4410 9255              		; call DEC16
 4411 9255              		; defw 20*256
 4412 9255 3E 00        		ld a,0
 4413 9257 21 A8 73     		ld hl,endsong
 4414 925A 77           		ld (hl),a
 4415 925B
 4416 925B 21 2E 92     		ld hl,sqt_txt
 4417 925E 11 21 50             ld de,20512+1
 4418 9261 CD CD 7A     		call print
 4419 9264
 4420 9264
 4421 9264 CD E1 92     		call	SQ_INIT
 4422 9267 FB           .loop	ei
 4423 9268 76           		halt
 4424 9269
 4425 9269 E5           		push hl
 4426 926A D5           		push de
 4427 926B C5           		push bc
 4428 926C 21 A0 5A     		 ld   hl,23200;Vymazání
 4429 926F 11 A1 5A              ld   de,23201;předešlého
 4430 9272 01 60 00              ld   bc,96   ;zobrazení.
 4431 9275 70                    ld   (hl),b
 4432 9276 ED B0                 ldir
 4433 9278
 4434 9278
 4435 9278 AF           		 xor a
 4436 9279 21 B0 90     		 ld hl,ACBhlas
 4437 927C 77           		 ld (hl),a
 4438 927D
 4439 927D 3E 08                 ld   a,8     ;A teď nové
 4440 927F 21 B0 5A              ld   hl,23216;zobrazení.
 4441 9282 11 AF 5A              ld   de,23215;Kanál A.
 4442 9285 CD A8 98              call ATR
 4443 9288
 4444 9288 3E 0A                 ld   a,10    ;Kanál C.
 4445 928A 21 D0 5A              ld   hl,23248
 4446 928D 11 CF 5A              ld   de,23247
 4447 9290 CD A8 98              call ATR
 4448 9293
 4449 9293 3E 09                 ld   a,9     ;Kanál B.
 4450 9295 21 F0 5A              ld   hl,23280
 4451 9298 11 EF 5A              ld   de,23279
 4452 929B CD A8 98              call ATR
 4453 929E
 4454 929E
 4455 929E 3A B0 90     		 ld a,(ACBhlas)
 4456 92A1 B7           		 or a
 4457 92A2 28 07        		 jr z,.as1
 4458 92A4 21 AF 90     		 ld hl,pocitadlo
 4459 92A7 AF           		 xor a
 4460 92A8 77           		 ld (hl),a
 4461 92A9 18 04        		 jr .as2
 4462 92AB 21 AF 90     .as1	 ld hl,pocitadlo
 4463 92AE 34           		 inc (hl)
 4464 92AF              .as2
 4465 92AF
 4466 92AF CD CE 98      		call keysetup
 4467 92B2 C1           		pop bc
 4468 92B3 D1           		pop de
 4469 92B4 E1           		pop hl
 4470 92B5
 4471 92B5 CD 44 93     		call	SQ_PLAY
 4472 92B8 AF           		xor a
 4473 92B9 3A 5F 9A             ld a,(klavesa)
 4474 92BC FE 01        		cp 1
 4475 92BE 28 18        		jr z,akoneca
 4476 92C0 FE 20        		cp 32
 4477 92C2 28 0E        		jr z,.as3
 4478 92C4
 4479 92C4 3A AF 90     		ld a,(pocitadlo)
 4480 92C7 EE 64        		xor 100
 4481 92C9 28 07        		jr z,.as3
 4482 92CB 3A E0 92     		ld a,(SQ_STATUS)
 4483 92CE CB 7F        		bit 7,a
 4484 92D0 28 95        		jr z,.loop
 4485 92D2 3E 20        .as3	ld a,32
 4486 92D4 21 A8 73     		ld hl,endsong
 4487 92D7 77           		ld (hl),a
 4488 92D8 F5           akoneca	push af
 4489 92D9
 4490 92D9 CD C2 A1     		call music_mute
 4491 92DC F1           		pop af
 4492 92DD C3 63 73     		jp navrat
 4493 92E0              		;jr	.loop
 4494 92E0
 4495 92E0
 4496 92E0              ; Povodny player generovany SQ-Linkerom doplneny o GLOBVOL,
 4497 92E0              ; tj. moznost globalneho utlmenia ~ © 2009 mborik/RM-TEAM.
 4498 92E0              ; Upravene na prehravanie SQT suborov, ktorym je potrebne
 4499 92E0              ; na zaciatku relokovat absolutne adresy, dalej bol doplneny
 4500 92E0              ; stavovy bajt podobny aky ma moj PT3 player, cize je mozne
 4501 92E0              ; song neopakovat, alebo fadeoutovat © 2020 mborik/SinDiKat.
 4502 92E0
 4503 92E0              ; Stavovy bajt prehravaca:
 4504 92E0              ; bit.0 nastav ak nechces ziaden looping
 4505 92E0              ; bit.1 nastav ak chces, aby nastal postupny fadeout po par sekundach
 4506 92E0              ; bit.7 sa nastavi vzdy, po odohrati vsetkych pozicii alebo po fadeoute
 4507 92E0              ; ...v jednoduchosti:	2 - fadeout after loop
 4508 92E0              ;			1 - no loop
 4509 92E0              ;			0 - loop forever
 4510 92E0 02           SQ_STATUS:	db	2
 4511 92E1
 4512 92E1              SQ_INIT:
 4513 92E1 ED 5B 10 BD  		ld	de,(RELOC_BASE)		; nacitame prvy offset, z ktoreho
 4514 92E5 21 18 BD     		ld	hl,BUFFER+10		; po odpocitani skutocnej adresy dat
 4515 92E8 AF           		xor	a			; bez 10 bajtov ziskavame offset,
 4516 92E9 ED 52        		sbc	hl,de			; ktorym musime relokovat vsetky
 4517 92EB E5           		push	hl			; absolutne ukazovatele v datach muziky
 4518 92EC ED 5B 1A BD  		ld	de,(RELOC_ENDPTR)
 4519 92F0 19           		add	hl,de
 4520 92F1 C1           		pop	bc
 4521 92F2 2B           RELOCATOR:	dec	hl
 4522 92F3 56           		ld	d,(hl)
 4523 92F4 2B           		dec	hl
 4524 92F5 5E           		ld	e,(hl)
 4525 92F6 EB           		ex	de,hl
 4526 92F7 09           		add	hl,bc
 4527 92F8 EB           		ex	de,hl
 4528 92F9 73           		ld	(hl),e
 4529 92FA 23           		inc	hl
 4530 92FB 72           		ld	(hl),d
 4531 92FC 2B           		dec	hl
 4532 92FD 7D           		ld	a,l
 4533 92FE D6 10        		sub	RELOC_BASE % 256
 4534 9300 20 F0        		jr	nz,RELOCATOR
 4535 9302 32 74 93      	    ld      (CHKFADEOUT+1),a
 4536 9305 32 A4 93             ld      (GLOBVOL+1),a
 4537 9308 3D           		dec	a
 4538 9309 32 65 94     		ld	(SQ_REST+1),a		; resetujem detektor konca skladby
 4539 930C 3E 02        		ld a,2
 4540 930E 32 E0 92     		ld (SQ_STATUS),a
 4541 9311 3E 08        		ld	a,8			; inicializacia prehravaca
 4542 9313 32 4F 98     		ld	(CHNZ1),a
 4543 9316 32 6C 98     		ld	(CHNZ2),a
 4544 9319 32 89 98     		ld	(CHNZ3),a
 4545 931C 01 01 01     		ld	bc,$0101
 4546 931F CD D2 94     		call	SQ_REND1
 4547 9322 2A 16 BD     CHN_INIT: 	ld	hl,(I_POSITIONS)
 4548 9325 DD 21 4F 98  		ld	ix,CHNZ1
 4549 9329 CD 10 94     		call	SQ_I9
 4550 932C CD 09 94     		call	SQ_I
 4551 932F CD 09 94     		call	SQ_I
 4552 9332 11 3F 07     SQ_STOP:	ld	de,#073F		; AY registre 7-12 nastav na uplne ticho
 4553 9335 CD E1 93     CHN_INILOOP:	call	OUT1
 4554 9338 1E 00        		ld	e,0
 4555 933A 14           		inc	d
 4556 933B 7A           		ld	a,d
 4557 933C FE 0C        		cp	12
 4558 933E 20 F5        		jr	nz,CHN_INILOOP
 4559 9340 C9           		ret
 4560 9341
 4561 9341 34           SQ_DEADEND:	inc	(hl)			; prehravanie skoncilo, SQ_PLAY je mrtve
 4562 9342 18 EE        		jr	SQ_STOP
 4563 9344
 4564 9344 21 A6 98     SQ_PLAY:	ld	hl,SQ_SYS
 4565 9347 35           		dec	(hl)
 4566 9348 20 29        		jr	nz,CHKFADEOUT
 4567 934A 36 00        SQ_PLAYSPEED:	ld	(hl),0
 4568 934C 23           		inc	hl
 4569 934D 35           		dec	(hl)
 4570 934E 7E           		ld	a,(hl)
 4571 934F B7           		or	a
 4572 9350 CC 64 94     		call	z,SQ_REST
 4573 9353 FE 04        		cp	4
 4574 9355 DC 09 94     		call	c,SQ_I
 4575 9358
 4576 9358 DD 21 4F 98  SQ_PP		ld	ix,CHNZ1
 4577 935C 0E 24        		ld	c,36
 4578 935E CD DC 94     		call	SQ_P
 4579 9361 DD 21 6C 98  		ld	ix,CHNZ2
 4580 9365 0E 12        		ld	c,18
 4581 9367 CD DC 94     		call	SQ_P
 4582 936A DD 21 89 98  		ld	ix,CHNZ3
 4583 936E 0E 09        		ld	c,9
 4584 9370 CD DC 94     		call	SQ_P
 4585 9373
 4586 9373 3E 00        CHKFADEOUT:	ld	a,0			; kontrola, ci fadeoutujeme
 4587 9375 B7           		or	a
 4588 9376 28 48        		jr	z,SQ_C
 4589 9378 3A E0 92     		ld	a,(SQ_STATUS)
 4590 937B CB 7F        		bit	7,a
 4591 937D 20 C2        		jr	nz,SQ_DEADEND
 4592 937F
 4593 937F 3E 00        COUNTFADEOUT:	ld	a,0
 4594 9381 3D           		dec	a
 4595 9382 32 80 93     		ld	(COUNTFADEOUT+1),a
 4596 9385 20 1C        		jr	nz,GLOBVOL
 4597 9387 3A A4 93     		ld	a,(GLOBVOL+1)
 4598 938A 3C           		inc	a
 4599 938B FE 10        		cp	16
 4600 938D 28 5C        		jr	z,RESETFADEOUT
 4601 938F 32 A4 93     		ld	(GLOBVOL+1),a
 4602 9392 3E 00        DIVFADEOUT:	ld	a,0
 4603 9394 CB 3F        		srl	a
 4604 9396 6F           		ld	l,a
 4605 9397 CB 3D        		srl	l
 4606 9399 85           		add	a,l
 4607 939A 20 01        		jr	nz,DIVFADEOUT1
 4608 939C 3C           		inc	a
 4609 939D 32 80 93     DIVFADEOUT1:	ld	(COUNTFADEOUT+1),a
 4610 93A0 32 93 93     		ld	(DIVFADEOUT+1),a
 4611 93A3
 4612 93A3 3E 00        GLOBVOL:	ld	a,0			; global attenuation
 4613 93A5 32 5A 98     		ld	(CHNZ1+11),a		; pre vsetky kanaly
 4614 93A8 32 77 98     		ld	(CHNZ2+11),a
 4615 93AB 32 94 98     		ld	(CHNZ3+11),a
 4616 93AE CB 5F        		bit	3,a			; dosiahla hodnota attenuation
 4617 93B0 28 0E        		jr	z,SQ_C			; cislo vacsie ako 8?
 4618 93B2 21 4F 98     		ld	hl,CHNZ1		; tak je nutne upravit sq-flagy,
 4619 93B5 11 1D 00     		ld	de,CHZL 		; aby sa prestali prehravat hw obalky
 4620 93B8 0E 03        		ld	c,3			; vo vsetkych troch kanaloch
 4621 93BA CB 86        GLOBVOL1:	res	0,(hl)			; vynulovanim nulteho bytu
 4622 93BC 19           		add	hl,de
 4623 93BD 0D           		dec	c
 4624 93BE 20 FA        		jr	nz,GLOBVOL1
 4625 93C0
 4626 93C0 AF           SQ_C:		xor	a			; vynuluje mixer register
 4627 93C1 6F           		ld	l,a
 4628 93C2 67           		ld	h,a
 4629 93C3 22 D4 93     		ld	(SQ_N+1),hl
 4630 93C6 DD 21 4F 98  		ld	ix,CHNZ1		; postupne prechadza kanalmi
 4631 93CA CD A6 96     		call	SQ_R
 4632 93CD CD A6 96     		call	SQ_R
 4633 93D0 CD A6 96     		call	SQ_R
 4634 93D3
 4635 93D3 01 00 00     SQ_N:		ld	bc,0			; nastavenie mixer registra
 4636 93D6 78           		ld	a,b			; B = sumove generatory pre ABC
 4637 93D7 17           		rla				; C = tonove generatory pre ABC
 4638 93D8 17           		rla
 4639 93D9 17           		rla
 4640 93DA B1           		or	c
 4641 93DB 2F           		cpl				; potom sa bity komplementuju
 4642 93DC F6 00        SQ_OFF: 	or	0
 4643 93DE 5F           		ld	e,a
 4644 93DF 16 07        		ld	d,7			; a posielaju na register 7 AY
 4645 93E1 01 FD FF     OUT1:		ld	bc,$FFFD
 4646 93E4 ED 51        		out	(c),d
 4647 93E6 06 BF        		ld	b,$BF
 4648 93E8 ED 59        		out	(c),e
 4649 93EA C9           		ret
 4650 93EB
 4651 93EB 21 FF FF     RESETFADEOUT:	ld	hl,-1
 4652 93EE 22 A6 98     		ld	(SQ_SYS),hl
 4653 93F1 21 E0 92     		ld	hl,SQ_STATUS
 4654 93F4 CB FE        		set	7,(hl)
 4655 93F6 AF           		xor	a
 4656 93F7 01           		db	1 ; ld bc,NN namiesto ld a,N
 4657 93F8
 4658 93F8 3E 30        ENABLEFADE:	ld	a,48
 4659 93FA 21 74 93     FORCEFADE:	ld	hl,CHKFADEOUT+1
 4660 93FD 34           		inc	(hl)
 4661 93FE 32 80 93     		ld	(COUNTFADEOUT+1),a
 4662 9401 32 93 93     		ld	(DIVFADEOUT+1),a
 4663 9404 2F           		cpl
 4664 9405 32 65 94     		ld	(SQ_REST+1),a
 4665 9408 C9           		ret
 4666 9409
 4667 9409 21 00 00     SQ_I:		ld	hl,0
 4668 940C DD 21 4F 98  SQ_I1:		ld	ix,CHNZ1
 4669 9410 7E           SQ_I9:		ld	a,(hl)
 4670 9411 B7           		or	a
 4671 9412 20 06        		jr	nz,SQ_I3
 4672 9414 32 65 94     		ld	(SQ_REST+1),a		; oznac, ze pri najblizsom patterne
 4673 9417 2A 18 BD     		ld	hl,(I_REPEAT)		; budeme testovat fadeout alebo noloop
 4674 941A 46           SQ_I3:		ld	b,(hl)
 4675 941B CB 10        		rl	b
 4676 941D DD CB 00 AE  		res	5,(ix+0)
 4677 9421 30 04        		jr	nc,SQ_I4
 4678 9423 DD CB 00 EE  		set	5,(ix+0)
 4679 9427 23           SQ_I4:		inc	hl
 4680 9428 7E           		ld	a,(hl)
 4681 9429 E6 0F        		and	15
 4682 942B DD 77 1A     		ld	(ix+26),a
 4683 942E 7E           		ld	a,(hl)
 4684 942F E6 F0        		and	240
 4685 9431 1F           		rra
 4686 9432 1F           		rra
 4687 9433 1F           		rra
 4688 9434 1F           		rra
 4689 9435 FE 09        		cp	9
 4690 9437 38 03        		jr	c,ZBR
 4691 9439 D6 09        		sub	9
 4692 943B 2F           		cpl
 4693 943C DD 77 18     ZBR:		ld	(ix+24),a
 4694 943F 23           		inc	hl
 4695 9440 22 0A 94     		ld	(SQ_I+1),hl
 4696 9443 68           		ld	l,b
 4697 9444 26 00        		ld	h,0
 4698 9446 ED 5B 14 BD  		ld	de,(I_PATTERNS)
 4699 944A 19           		add	hl,de
 4700 944B 5E           		ld	e,(hl)
 4701 944C 23           		inc	hl
 4702 944D 56           		ld	d,(hl)
 4703 944E 13           		inc	de
 4704 944F DD 73 16     		ld	(ix+22),e
 4705 9452 DD 72 17     		ld	(ix+23),d
 4706 9455 11 1D 00     		ld	de,CHZL
 4707 9458 DD 19        		add	ix,de
 4708 945A DD 22 0E 94  		ld	(SQ_I1+2),ix
 4709 945E C9           		ret
 4710 945F
 4711 945F CD EB 93     SQ_NOFADE:	call	RESETFADEOUT
 4712 9462 F1           		pop	af
 4713 9463 C9           		ret
 4714 9464
 4715 9464 3E FF        SQ_REST:	ld	a,-1
 4716 9466 B7           		or	a
 4717 9467 20 0C        		jr	nz,SQ_REST0
 4718 9469 3A E0 92     		ld	a,(SQ_STATUS)
 4719 946C 0F           		rrca			; bit 0. nastaveny = koniec
 4720 946D 38 F0        		jr	c,SQ_NOFADE
 4721 946F 0F           		rrca			; bit 1. nastaveny = fadeout
 4722 9470 30 03        		jr	nc,SQ_REST0
 4723 9472 CD F8 93     		call	ENABLEFADE
 4724 9475 3A 69 98     SQ_REST0:	ld	a,(CHNZ1+26)
 4725 9478 32 5A 98     		ld	(CHNZ1+11),a
 4726 947B 3A 86 98     		ld	a,(CHNZ2+26)
 4727 947E 32 77 98     		ld	(CHNZ2+11),a
 4728 9481 3A A3 98     		ld	a,(CHNZ3+26)
 4729 9484 32 94 98     		ld	(CHNZ3+11),a
 4730 9487 2A 65 98     		ld	hl,(CHNZ1+22)
 4731 948A 2B           		dec	hl
 4732 948B 46           		ld	b,(hl)
 4733 948C 23           		inc	hl
 4734 948D 22 61 98     		ld	(CHNZ1+18),hl
 4735 9490 2A 82 98     		ld	hl,(CHNZ2+22)
 4736 9493 22 7E 98     		ld	(CHNZ2+18),hl
 4737 9496 2A 9F 98     		ld	hl,(CHNZ3+22)
 4738 9499 22 9B 98     		ld	(CHNZ3+18),hl
 4739 949C 2A 67 98     		ld	hl,(CHNZ1+24)
 4740 949F 22 63 98     		ld	(CHNZ1+20),hl
 4741 94A2 2A 84 98     		ld	hl,(CHNZ2+24)
 4742 94A5 22 80 98     		ld	(CHNZ2+20),hl
 4743 94A8 2A A1 98     		ld	hl,(CHNZ3+24)
 4744 94AB 22 9D 98     		ld	(CHNZ3+20),hl
 4745 94AE 2A 0A 94     		ld	hl,(SQ_I+1)
 4746 94B1 4E           		ld	c,(hl)
 4747 94B2 23           		inc	hl
 4748 94B3 22 0A 94     		ld	(SQ_I+1),hl
 4749 94B6 21 4F 98     		ld	hl,CHNZ1
 4750 94B9 22 0E 94     		ld	(SQ_I1+2),hl
 4751 94BC 3E 03        		ld	a,3
 4752 94BE 16 00        		ld	d,0
 4753 94C0 CB A6        SQ_REST1:	res	4,(hl)
 4754 94C2 CB 6E        		bit	5,(hl)
 4755 94C4 28 02        		jr	z,SQ_REST2
 4756 94C6 CB E6        		set	4,(hl)
 4757 94C8 1E 15        SQ_REST2:	ld	e,21
 4758 94CA 19           		add	hl,de
 4759 94CB 72           		ld	(hl),d
 4760 94CC 1E 08        		ld	e,CHZL-21
 4761 94CE 19           		add	hl,de
 4762 94CF 3D           		dec	a
 4763 94D0 20 EE        		jr	nz,SQ_REST1
 4764 94D2 ED 43 A6 98  SQ_REND1:	ld	(SQ_SYS),bc
 4765 94D6 79           		ld	a,c
 4766 94D7 32 4B 93     SQ_REND2:	ld	(SQ_PLAYSPEED+1),a
 4767 94DA 78           		ld	a,b
 4768 94DB C9           		ret
 4769 94DC
 4770 94DC DD 7E 15     SQ_P:		ld	a,(ix+21)
 4771 94DF B7           		or	a
 4772 94E0 28 0A        		jr	z,Y01
 4773 94E2 DD 35 15     		dec	(ix+21)
 4774 94E5 DD CB 00 7E  		bit	7,(ix+0)
 4775 94E9 20 3E        		jr	nz,Y33
 4776 94EB C9           		ret
 4777 94EC
 4778 94EC DD 5E 12     Y01:		ld	e,(ix+18)
 4779 94EF DD 56 13     		ld	d,(ix+19)
 4780 94F2 DD CB 00 F6  		set	6,(ix+0)
 4781 94F6 DD CB 00 BE  		res	7,(ix+0)
 4782 94FA 1A           		ld	a,(de)
 4783 94FB 13           		inc	de
 4784 94FC CB 7F        		bit	7,a
 4785 94FE 28 4D        		jr	z,Y02
 4786 9500
 4787 9500 DD 73 12     Y05:		ld	(ix+18),e
 4788 9503 DD 72 13     		ld	(ix+19),d
 4789 9506 47           		ld	b,a
 4790 9507 CB 77        		bit	6,a
 4791 9509 28 0C        		jr	z,Y60
 4792 950B
 4793 950B 1B           		dec	de
 4794 950C DD 73 1B     		ld	(ix+27),e
 4795 950F DD 72 1C     		ld	(ix+28),d
 4796 9512 E6 1F        Y34:		and	31
 4797 9514 C3 40 96     		jp	SQ_SMP
 4798 9517
 4799 9517 CB 6F        Y60:		bit	5,a
 4800 9519 20 21        		jr	nz,Y06
 4801 951B
 4802 951B E6 0F        		and	15
 4803 951D CB 60        		bit	4,b
 4804 951F 28 02        		jr	z,Y07
 4805 9521 ED 44        		neg
 4806 9523 DD 86 0C     Y07:		add	a,(ix+12)
 4807 9526 DD 77 0C     		ld	(ix+12),a
 4808 9529 DD 5E 1B     Y33:		ld	e,(ix+27)
 4809 952C DD 56 1C     		ld	d,(ix+28)
 4810 952F DD CB 00 B6  		res	6,(ix+0)
 4811 9533 1A           		ld	a,(de)
 4812 9534 CB 7F        		bit	7,a
 4813 9536 20 DA        		jr	nz,Y34
 4814 9538 13           		inc	de
 4815 9539 C3 1B 96     		jp	SMP_ORN
 4816 953C
 4817 953C E6 0F        Y06:		and	15
 4818 953E DD 77 15     		ld	(ix+21),a
 4819 9541 CB 60        		bit	4,b
 4820 9543 C8           		ret	z
 4821 9544 B7           		or	a
 4822 9545 28 E2        		jr	z,Y33
 4823 9547 DD CB 00 FE  		set	7,(ix+0)
 4824 954B 18 DC        		jr	Y33
 4825 954D
 4826 954D FE 60        Y02:		cp	96
 4827 954F DA 01 96     		jp	c,Y03
 4828 9552 D6 60        		sub	96
 4829 9554 FE 0F        		cp	15
 4830 9556 38 11        		jr	c,Y04
 4831 9558
 4832 9558 21 DD 93     		ld	hl,SQ_OFF+1
 4833 955B 47           		ld	b,a
 4834 955C 7E           		ld	a,(hl)
 4835 955D B1           		or	c
 4836 955E 77           		ld	(hl),a
 4837 955F DD CB 00 DE  		set	3,(ix+0)
 4838 9563 78           		ld	a,b
 4839 9564 D6 0F        		sub	15
 4840 9566 CA 14 96     		jp	z,Z26
 4841 9569
 4842 9569 3D           Y04:		dec	a
 4843 956A EB           		ex	de,hl
 4844 956B 4E           		ld	c,(hl)
 4845 956C 23           		inc	hl
 4846 956D DD CB 00 76  		bit	6,(ix+0)
 4847 9571 28 0A        		jr	z,Y69
 4848 9573 DD 75 12     		ld	(ix+18),l
 4849 9576 DD 74 13     		ld	(ix+19),h
 4850 9579 DD CB 00 B6  		res	6,(ix+0)
 4851 957D FE 08        Y69:		cp	8
 4852 957F 38 11        		jr	c,Z38
 4853 9581 DD CB 00 C6  		set	0,(ix+0)
 4854 9585 69           		ld	l,c
 4855 9586 5F           		ld	e,a
 4856 9587 16 0D        		ld	d,13
 4857 9589 CD E1 93     		call	OUT1
 4858 958C 16 0B        		ld	d,11
 4859 958E 5D           		ld	e,l
 4860 958F C3 E1 93     		jp	OUT1
 4861 9592
 4862 9592 FE 06        Z38:		cp	6			; channel volume set
 4863 9594 30 4F        		jr	nc,Z36
 4864 9596 DD CB 00 66  		bit	4,(ix+0)
 4865 959A C8           		ret	z
 4866 959B B7           		or	a
 4867 959C 20 07        		jr	nz,Z31
 4868 959E 79           		ld	a,c
 4869 959F E6 0F        SQ_V:		and	15
 4870 95A1 DD 77 0B     		ld	(ix+11),a
 4871 95A4 C9           		ret
 4872 95A5
 4873 95A5 3D           Z31:		dec	a			; channel volume slide
 4874 95A6 20 06        		jr	nz,Z32
 4875 95A8 79           		ld	a,c
 4876 95A9 DD 86 0B     		add	a,(ix+11)
 4877 95AC 18 F1        		jr	SQ_V
 4878 95AE
 4879 95AE 3D           Z32:		dec	a			; global volume set
 4880 95AF 20 0B        		jr	nz,Z33
 4881 95B1 79           		ld	a,c
 4882 95B2 32 5A 98     		ld	(CHNZ1+11),a
 4883 95B5 32 77 98     		ld	(CHNZ2+11),a
 4884 95B8 32 94 98     		ld	(CHNZ3+11),a
 4885 95BB C9           		ret
 4886 95BC
 4887 95BC 3D           Z33:		dec	a			; global volume slide
 4888 95BD 20 11        		jr	nz,Z34
 4889 95BF 06 03        		ld	b,3
 4890 95C1 11 1D 00     		ld	de,CHZL
 4891 95C4 21 5A 98     		ld	hl,CHNZ1+11
 4892 95C7 7E           Z33_2:		ld	a,(hl)
 4893 95C8 81           		add	a,c
 4894 95C9 E6 0F        		and	15
 4895 95CB 77           		ld	(hl),a
 4896 95CC 19           		add	hl,de
 4897 95CD 10 F8        		djnz	Z33_2
 4898 95CF C9           		ret
 4899 95D0
 4900 95D0 21 A6 98     Z34:		ld	hl,SQ_SYS		; speed set
 4901 95D3 3D           		dec	a
 4902 95D4 20 0B        		jr	nz,Z35
 4903 95D6 79           		ld	a,c
 4904 95D7 E6 1F        SQ_S:		and	31
 4905 95D9 20 02        		jr	nz,SQ_Z
 4906 95DB 3E 20        		ld	a,32
 4907 95DD 77           SQ_Z:		ld	(hl),a
 4908 95DE C3 D7 94     		jp	SQ_REND2
 4909 95E1
 4910 95E1 7E           Z35:		ld	a,(hl)			; speed slide
 4911 95E2 81           		add	a,c
 4912 95E3 18 F2        		jr	SQ_S
 4913 95E5
 4914 95E5 D6 06        Z36:		sub	6
 4915 95E7 06 00        		ld	b,0
 4916 95E9 79           		ld	a,c
 4917 95EA 48           		ld	c,b
 4918 95EB 20 03        		jr	nz,Z37
 4919 95ED 05           		dec	b
 4920 95EE ED 44        		neg
 4921 95F0 DD CB 00 D6  Z37:		set	2,(ix+0)
 4922 95F4 DD 71 0D     		ld	(ix+13),c
 4923 95F7 DD 71 0E     		ld	(ix+14),c
 4924 95FA DD 77 0F     		ld	(ix+15),a
 4925 95FD DD 70 10     		ld	(ix+16),b
 4926 9600 C9           		ret
 4927 9601
 4928 9601 DD 77 0C     Y03:		ld	(ix+12),a
 4929 9604 1B           		dec	de
 4930 9605 DD 73 1B     		ld	(ix+27),e
 4931 9608 DD 72 1C     		ld	(ix+28),d
 4932 960B 13           		inc	de
 4933 960C CD 1B 96     		call	SMP_ORN
 4934 960F DD CB 00 76  		bit	6,(ix+0)
 4935 9613 C8           		ret	z
 4936 9614 DD 73 12     Z26:		ld	(ix+18),e
 4937 9617 DD 72 13     		ld	(ix+19),d
 4938 961A C9           		ret
 4939 961B
 4940 961B 1A           SMP_ORN:	ld	a,(de)
 4941 961C 13           		inc	de
 4942 961D CB 7F        		bit	7,a
 4943 961F 28 1C        		jr	z,SMP_ORN9
 4944 9621 47           		ld	b,a
 4945 9622 1F           		rra
 4946 9623 E6 1F        		and	31
 4947 9625 C4 40 96     		call	nz,SQ_SMP
 4948 9628 CB 70        		bit	6,b
 4949 962A C8           		ret	z
 4950 962B 1A           		ld	a,(de)
 4951 962C E6 F0        		and	240
 4952 962E CB 18        		rr	b
 4953 9630 1F           		rra
 4954 9631 1F           		rra
 4955 9632 1F           		rra
 4956 9633 CB 3F        		srl	a
 4957 9635 C4 71 96     		call	nz,SQ_ORN
 4958 9638 1A           		ld	a,(de)
 4959 9639 13           		inc	de
 4960 963A E6 0F        		and	15
 4961 963C C8           		ret	z
 4962 963D C3 69 95     SMP_ORN9:	jp	Y04
 4963 9640
 4964 9640 C5           SQ_SMP: 	push	bc
 4965 9641 87           		add	a,a
 4966 9642 4F           		ld	c,a
 4967 9643 06 00        		ld	b,0
 4968 9645 DD 7E 00     		ld	a,(ix+0)
 4969 9648 E6 F0        		and	%11110000
 4970 964A DD 77 00     		ld	(ix+0),a
 4971 964D 2A 10 BD     		ld	hl,(I_SAMPLES)
 4972 9650 09           		add	hl,bc
 4973 9651 4E           		ld	c,(hl)
 4974 9652 23           		inc	hl
 4975 9653 46           		ld	b,(hl)
 4976 9654 DD E5        		push	ix
 4977 9656 E1           		pop	hl
 4978 9657 23           		inc	hl
 4979 9658 71           		ld	(hl),c
 4980 9659 23           		inc	hl
 4981 965A 70           		ld	(hl),b
 4982 965B 03           		inc	bc
 4983 965C 03           		inc	bc
 4984 965D 23           		inc	hl
 4985 965E 71           		ld	(hl),c
 4986 965F 23           		inc	hl
 4987 9660 70           		ld	(hl),b
 4988 9661 23           		inc	hl
 4989 9662 36 20        		ld	(hl),32
 4990 9664 23           		inc	hl
 4991 9665 22 7D 96     		ld	(SQ_NXT+1),hl
 4992 9668 C1           		pop	bc
 4993 9669 21 DD 93     		ld	hl,SQ_OFF+1
 4994 966C 7E           		ld	a,(hl)
 4995 966D B1           		or	c
 4996 966E A9           		xor	c
 4997 966F 77           		ld	(hl),a
 4998 9670 C9           		ret
 4999 9671
 5000 9671 87           SQ_ORN: 	add	a,a
 5001 9672 4F           		ld	c,a
 5002 9673 06 00        		ld	b,0
 5003 9675 2A 12 BD     		ld	hl,(I_ORNAMENTS)
 5004 9678 09           		add	hl,bc
 5005 9679 4E           		ld	c,(hl)
 5006 967A 23           		inc	hl
 5007 967B 46           		ld	b,(hl)
 5008 967C 21 00 00     SQ_NXT: 	ld	hl,0
 5009 967F 71           		ld	(hl),c
 5010 9680 23           		inc	hl
 5011 9681 70           		ld	(hl),b
 5012 9682 23           		inc	hl
 5013 9683 03           		inc	bc
 5014 9684 03           		inc	bc
 5015 9685 71           		ld	(hl),c
 5016 9686 23           		inc	hl
 5017 9687 70           		ld	(hl),b
 5018 9688 23           		inc	hl
 5019 9689 36 20        		ld	(hl),32
 5020 968B DD CB 00 CE  		set	1,(ix+0)
 5021 968F C9           		ret
 5022 9690
 5023 9690 21 D4 93     OUT2:		ld	hl,SQ_N+1		; podla carry nastavi v SQ_N
 5024 9693 CB 16        		rl	(hl)			; tonovy generator, sumovy off
 5025 9695 23           		inc	hl			; potom vytiahne cislo kanalu
 5026 9696 CB 16        		rl	(hl)
 5027 9698 DD 7E 11     		ld	a,(ix+17)
 5028 969B C6 08        		add	a,8			; pripocita k nemu 8
 5029 969D ED 79        		out	(c),a			; tj. volume registre AY
 5030 969F 06 BF        		ld	b,$BF
 5031 96A1 ED 59        		out	(c),e			; a posle hodnotu v E
 5032 96A3 C3 BC 97     		jp	SQ_ZCH
 5033 96A6
 5034 96A6 DD 6E 03     SQ_R:		ld	l,(ix+3)
 5035 96A9 DD 66 04     		ld	h,(ix+4)
 5036 96AC 01 FD FF     		ld	bc,$FFFD
 5037 96AF DD 56 00     		ld	d,(ix+0)
 5038 96B2 1E 00        		ld	e,0
 5039 96B4 CB 5A        		bit	3,d			; ak sa nema nic hrat, umlcat
 5040 96B6 20 D8        		jr	nz,OUT2
 5041 96B8 7E           		ld	a,(hl)
 5042 96B9 E6 0F        		and	15
 5043 96BB C2 C7 96     		jp	nz,SQ_R1
 5044 96BE CB 42        		bit	0,d			; ak sa ma hrat obalka, nastav
 5045 96C0 28 0B        		jr	z,SQ_R2
 5046 96C2 1E 10        		ld	e,16
 5047 96C4 C3 CD 96     		jp	SQ_R2
 5048 96C7
 5049 96C7 DD 96 0B     SQ_R1:		sub	(ix+11) 		; od hlasitosti z sa odpocita
 5050 96CA 38 01        		jr	c,SQ_R2 		; global volume nastavenie
 5051 96CC 5F           		ld	e,a
 5052 96CD
 5053 96CD DD 7E 11     SQ_R2:		ld	a,(ix+17)		; vytiahne sa cislo kanalu
 5054 96D0 C6 08        		add	a,8			; pripocita sa 8 cim sa dostnem
 5055 96D2 ED 79        		out	(c),a			; na registre hlasitosi AY
 5056 96D4 06 BF        		ld	b,$BF
 5057 96D6 ED 59        		out	(c),e
 5058 96D8 7E           		ld	a,(hl)
 5059 96D9 23           		inc	hl
 5060 96DA E6 F0        		and	240			; vytiahujem sumove data
 5061 96DC 1F           		rra
 5062 96DD 1F           		rra
 5063 96DE 1F           		rra
 5064 96DF 16 06        		ld	d,6
 5065 96E1 5E           		ld	e,(hl)
 5066 96E2 CB 13        		rl	e
 5067 96E4 CB 6E        		bit	5,(hl)			; zistujem, ci budeme sumiet
 5068 96E6 28 0A        		jr	z,SQ_ZNN
 5069 96E8 CE 00        		adc	a,0
 5070 96EA 06 FF        		ld	b,$FF
 5071 96EC ED 51        		out	(c),d
 5072 96EE 06 BF        		ld	b,$BF
 5073 96F0 ED 79        		out	(c),a
 5074 96F2 7B           SQ_ZNN:		ld	a,e
 5075 96F3 17           		rla
 5076 96F4 EB           		ex	de,hl
 5077 96F5 21 D4 93     		ld	hl,SQ_N+1		; nastavime v SQ_N stavy oboch
 5078 96F8 CB 16        		rl	(hl)			; generatorov (sum/ton) pre ch.
 5079 96FA 23           		inc	hl
 5080 96FB 17           		rla
 5081 96FC CB 16        		rl	(hl)
 5082 96FE EB           		ex	de,hl
 5083 96FF 7E           		ld	a,(hl)			; vypocitavanie frekvencie...
 5084 9700 E6 1F        		and	31
 5085 9702 57           		ld	d,a
 5086 9703 23           		inc	hl
 5087 9704 5E           		ld	e,(hl)
 5088 9705 23           		inc	hl
 5089 9706 D5           		push	de
 5090 9707 16 00        		ld	d,0
 5091 9709 DD 35 05     		dec	(ix+5)
 5092 970C C2 2D 97     		jp	nz,FQ_2
 5093 970F DD 6E 01     		ld	l,(ix+1)
 5094 9712 DD 66 02     		ld	h,(ix+2)
 5095 9715 7E           		ld	a,(hl)
 5096 9716 23           		inc	hl
 5097 9717 FE 20        		cp	32
 5098 9719 4E           		ld	c,(hl)
 5099 971A 23           		inc	hl
 5100 971B 20 08        		jr	nz,FQ_1
 5101 971D DD CB 00 DE  		set	3,(ix+0)
 5102 9721 DD CB 00 8E  		res	1,(ix+0)
 5103 9725 47           FQ_1:		ld	b,a
 5104 9726 87           		add	a,a
 5105 9727 80           		add	a,b
 5106 9728 5F           		ld	e,a
 5107 9729 19           		add	hl,de
 5108 972A DD 71 05     		ld	(ix+5),c
 5109 972D DD 75 03     FQ_2:		ld	(ix+3),l
 5110 9730 DD 74 04     		ld	(ix+4),h
 5111 9733 DD 7E 0C     		ld	a,(ix+12)
 5112 9736 DD CB 00 4E  		bit	1,(ix+0)
 5113 973A 28 2A        		jr	z,FQ_5
 5114 973C DD 6E 08     		ld	l,(ix+8)
 5115 973F DD 66 09     		ld	h,(ix+9)
 5116 9742 86           		add	a,(hl)
 5117 9743 23           		inc	hl
 5118 9744 DD 35 0A     		dec	(ix+10)
 5119 9747 C2 60 97     		jp	nz,FQ_4
 5120 974A 08           		ex	af,af'
 5121 974B DD 6E 06     		ld	l,(ix+6)
 5122 974E DD 66 07     		ld	h,(ix+7)
 5123 9751 7E           		ld	a,(hl)
 5124 9752 23           		inc	hl
 5125 9753 FE 20        		cp	32
 5126 9755 58           		ld	e,b
 5127 9756 28 02        		jr	z,FQ_3
 5128 9758 4E           		ld	c,(hl)
 5129 9759 5F           		ld	e,a
 5130 975A 23           FQ_3:		inc	hl
 5131 975B 19           		add	hl,de
 5132 975C DD 71 0A     		ld	(ix+10),c
 5133 975F 08           		ex	af,af'
 5134 9760 DD 75 08     FQ_4:		ld	(ix+8),l
 5135 9763 DD 74 09     		ld	(ix+9),h
 5136 9766 DD 86 14     FQ_5:		add	a,(ix+20)
 5137 9769 FE 2D        		cp	45
 5138 976B 30 0B        		jr	nc,FQ_6
 5139 976D 87           		add	a,a
 5140 976E 5F           		ld	e,a
 5141 976F 21 C2 97     		ld	hl,FRQ2
 5142 9772 19           		add	hl,de
 5143 9773 56           		ld	d,(hl)
 5144 9774 23           		inc	hl
 5145 9775 C3 7D 97     		jp	FQ_7
 5146 9778
 5147 9778 21 EF 97     FQ_6:		ld	hl,FRQ1-45
 5148 977B 5F           		ld	e,a
 5149 977C 19           		add	hl,de
 5150 977D 5E           FQ_7:		ld	e,(hl)
 5151 977E EB           		ex	de,hl
 5152 977F D1           		pop	de			; ...frekvenciu mame,
 5153 9780 CB 62        		bit	4,d			; bude este fine-tuning?
 5154 9782 CB A2        		res	4,d
 5155 9784 28 02        		jr	z,FQ_9
 5156 9786 19           		add	hl,de
 5157 9787 01           		db	1 ; ld bc,NN namiesto sbc hl,de
 5158 9788 ED 52        FQ_9:		sbc	hl,de
 5159 978A DD CB 00 56  		bit	2,(ix+0)
 5160 978E 28 16        		jr	z,OUT9
 5161 9790 DD 4E 0D     		ld	c,(ix+13)
 5162 9793 DD 46 0E     		ld	b,(ix+14)
 5163 9796 09           		add	hl,bc
 5164 9797 EB           		ex	de,hl
 5165 9798 DD 6E 0F     		ld	l,(ix+15)
 5166 979B DD 66 10     		ld	h,(ix+16)
 5167 979E 09           		add	hl,bc
 5168 979F DD 75 0D     		ld	(ix+13),l
 5169 97A2 DD 74 0E     		ld	(ix+14),h
 5170 97A5 EB           		ex	de,hl
 5171 97A6
 5172 97A6 DD 7E 11     OUT9:		ld	a,(ix+17)		; vytiahi cislo kanalu
 5173 97A9 87           		add	a,a			; vynasob dvoma
 5174 97AA 01 FD FF     		ld	bc,$FFFD		; a naprogramuj freq tonu
 5175 97AD ED 79        		out	(c),a
 5176 97AF 06 BF        		ld	b,$BF
 5177 97B1 ED 69        		out	(c),l
 5178 97B3 3C           		inc	a
 5179 97B4 06 FF        		ld	b,$FF
 5180 97B6 ED 79        		out	(c),a
 5181 97B8 06 BF        		ld	b,$BF
 5182 97BA ED 61        		out	(c),h
 5183 97BC 11 1D 00     SQ_ZCH: 	ld	de,CHZL 		; prejdi s IX na dalsi kanal
 5184 97BF DD 19        		add	ix,de
 5185 97C1 C9           		ret
 5186 97C2
 5187 97C2 0D 5D 0C 9C  FRQ2:		db	13,93,12,156
 5188 97C6 0B E7 0B 3C  		db	11,231,11,60
 5189 97CA 0A 9B 0A 02  		db	10,155,10,2,9,115
 5189 97CE 09 73
 5190 97D0 08 EB 08 6B  		db	8,235,8,107,7,242
 5190 97D4 07 F2
 5191 97D6 07 80 07 14  		db	7,128,7,20,6,174
 5191 97DA 06 AE
 5192 97DC 06 4E 05 F4  		db	6,78,5,244,5,158
 5192 97E0 05 9E
 5193 97E2 05 4F 05 01  		db	5,79,5,1,4,185
 5193 97E6 04 B9
 5194 97E8 04 75 04 35  		db	4,117,4,53,3,249
 5194 97EC 03 F9
 5195 97EE 03 C0 03 8A  		db	3,192,3,138,3,87
 5195 97F2 03 57
 5196 97F4 03 27 02 FA  		db	3,39,2,250,2,207
 5196 97F8 02 CF
 5197 97FA 02 A7 02 81  		db	2,167,2,129,2,93
 5197 97FE 02 5D
 5198 9800 02 3B 02 1B  		db	2,59,2,27,1,252
 5198 9804 01 FC
 5199 9806 01 E0 01 C5  		db	1,224,1,197,1,172
 5199 980A 01 AC
 5200 980C 01 94 01 7D  		db	1,148,1,125,1,104
 5200 9810 01 68
 5201 9812 01 53 01 40  		db	1,83,1,64
 5202 9816 01 2E 01 1D  		db	1,46,1,29,1,13
 5202 981A 01 0D
 5203 981C
 5204 981C FE F0 E2 D6  FRQ1:		db	254,240,226,214
 5205 9820 CA BE B4 AA  		db	202,190,180,170
 5206 9824 A0 97 8F 87  		db	160,151,143,135
 5207 9828 7F 78 71 6B  		db	127,120,113,107
 5208 982C 65 5F 5A 55  		db	101,95,90,85,80
 5208 9830 50
 5209 9831 4C 47 43 40  		db	76,71,67,64,60,57
 5209 9835 3C 39
 5210 9837 35 32 30 2D  		db	53,50,48,45,42,40
 5210 983B 2A 28
 5211 983D 26 24 22 20  		db	38,36,34,32,30,28
 5211 9841 1E 1C
 5212 9843 1B 19 18 16  		db	27,25,24,22,21,20
 5212 9847 15 14
 5213 9849 13 12 11 10  		db	19,18,17,16,15,14
 5213 984D 0F 0E
 5214 984F
 5215 984F 00           CHNZ1:	db	0
 5216 9850 00 00 00 00  		dw	0,0,0,0,0,0,0,0
 5216 9854 00 00 00 00
 5216 9858 00 00 00 00
 5216 985C 00 00 00 00
 5217 9860 02 00 00 00  		dw	2,0,0,0,0,0
 5217 9864 00 00 00 00
 5217 9868 00 00 00 00
 5218 986C 00           CHNZ2:	db	0
 5219 986D 00 00 00 00  		dw	0,0,0,0,0,0,0,0
 5219 9871 00 00 00 00
 5219 9875 00 00 00 00
 5219 9879 00 00 00 00
 5220 987D 01 00 00 00  		dw	1,0,0,0,0,0
 5220 9881 00 00 00 00
 5220 9885 00 00 00 00
 5221 9889 00           CHNZ3:	db	0
 5222 988A 00 00 00 00  		dw	0,0,0,0,0,0,0,0
 5222 988E 00 00 00 00
 5222 9892 00 00 00 00
 5222 9896 00 00 00 00
 5223 989A 00 00 00 00  		dw	0,0,0,0,0,0
 5223 989E 00 00 00 00
 5223 98A2 00 00 00 00
 5224 98A6
 5225 98A6 01 01        SQ_SYS: 	dw	#0101
 5226 98A8
 5227 98A8              CHZL:		equ	CHNZ2-CHNZ1	; offset medzi kanalmi
 5228 98A8
 5229 98A8
 5230 98A8              ;universal pt2 and pt3 player for zx spectrum and msx
 5231 98A8              ;(c)2004-2005 s.v.bulba <vorobey@mail.khstu.ru>
 5232 98A8              ;http://bulba.at.kz
 5233 98A8
 5234 98A8              ;release number
 5235 98A8              release equ "0"
 5236 98A8
 5237 98A8              ;conditional assembly
 5238 98A8              ;1) version of rout (zx or msx standards)
 5239 98A8              zx equ 1
 5240 98A8              msx equ 0
 5241 98A8              ;2) current position counter at (start+11)
 5242 98A8              curposcounter equ 1
 5243 98A8              ;3) allow channels allocation bits at (start+10)
 5244 98A8              acbbac equ 1
 5245 98A8              ;4) allow loop checking and disabling
 5246 98A8              loopchecker equ 1
 5247 98A8              ;5) insert official identificator
 5248 98A8              id equ 1
 5249 98A8
 5250 98A8              ATR
 5251 98A8 01 FD FF              ld   bc,AY   ;Přečtení hlasitosti
 5252 98AB ED 79                 out  (c),a   ;z AY
 5253 98AD ED 78                 in   a,(c)
 5254 98AF E5           		 push hl
 5255 98B0 F5           		 push af
 5256 98B1 21 B0 90     		 ld hl,ACBhlas
 5257 98B4 B6           		 or (hl)
 5258 98B5 77           		 ld (hl),a
 5259 98B6 F1           		 pop af
 5260 98B7 E1           		 pop hl
 5261 98B8              		;	out (254),a
 5262 98B8 FE 10                 cp   16      ;Test překročení
 5263 98BA 38 02                 jr  c,ATR3      ;maximální hlast.
 5264 98BC 3E 0F        		 ld a,15
 5265 98BE B7           ATR3     or   a
 5266 98BF C8                    ret  z
 5267 98C0 47                    ld   b,a     ;Uschování hlast.
 5268 98C1 B7                    or a
 5269 98C2 1F                    rra          ;Výpočet barvy
 5270 98C3 38 02                 jr   c,ATR2  ;atributu.
 5271 98C5 CB F7                 set  6,a     ;Nastavení jasu.
 5272 98C7              ATR2
 5273 98C7 77                    ld   (hl),a  ;Vykreslení
 5274 98C8 12                    ld   (de),a  ;atributové čáry.
 5275 98C9 23                    inc  hl      ;Opakuje se
 5276 98CA 1B                    dec  de      ;tolikrát, kolik
 5277 98CB 10 FA                 djnz ATR2    ;je hlasitost.
 5278 98CD C9                    ret
 5279 98CE
 5280 98CE              AY       equ  65533
 5281 98CE
 5282 98CE
 5283 98CE              keysetup
 5284 98CE CD 64 90     		call key.check
 5285 98D1
 5286 98D1 32 5F 9A     		ld (klavesa),a
 5287 98D4 FE 61        		cp "a"
 5288 98D6 CC 47 9A     		call z,setAY
 5289 98D9 FE 79        		cp "y"
 5290 98DB CC 54 9A     		call z,setYM
 5291 98DE FE 62        		cp "b"
 5292 98E0 CC 3C 9A     		call z,ABC
 5293 98E3 FE 63        		cp "c"
 5294 98E5 CC 31 9A     		call z,ACB
 5295 98E8 CD 07 71     		call showsetup
 5296 98EB C9           		ret
 5297 98EC
 5298 98EC              playmusic
 5299 98EC 21 A0 50     			ld hl,20640
 5300 98EF 11 D3 65     			ld de,by1
 5301 98F2 06 18        			ld b,8*3
 5302 98F4 D5           ppp         push de
 5303 98F5 C5           			push bc
 5304 98F6 E5           			push hl
 5305 98F7 06 20        			ld b,32
 5306 98F9 1A           ppp0		ld a,(de)
 5307 98FA 77           			ld (hl),a
 5308 98FB 23           			inc hl
 5309 98FC 10 FB        			djnz ppp0
 5310 98FE E1           			pop hl
 5311 98FF C1           			pop bc
 5312 9900 D1           			pop de
 5313 9901
 5314 9901 CD C7 7B     			call downhl
 5315 9904 13           			inc de
 5316 9905 10 ED        			djnz ppp
 5317 9907
 5318 9907
 5319 9907
 5320 9907              			; ld de,18464+15
 5321 9907              			; ld hl,txtcurrentfile
 5322 9907              			; call print
 5323 9907
 5324 9907              			; ld de,18432+15
 5325 9907              			; ld hl,txtallfiles
 5326 9907              			; call print
 5327 9907
 5328 9907
 5329 9907              		; ld hl,(apos_all)
 5330 9907              		; inc hl
 5331 9907              		; ld de,18464+15+11
 5332 9907              		; ld (NUMPOS+1),de
 5333 9907              		; call DEC16
 5334 9907              		; defw 20*256
 5335 9907
 5336 9907              		; ld hl,(ALLFILES)
 5337 9907              		; ld de,18432+15+11
 5338 9907              		; ld (NUMPOS+1),de
 5339 9907              		; call DEC16
 5340 9907              		; defw 20*256
 5341 9907
 5342 9907
 5343 9907
 5344 9907 AF           		xor a
 5345 9908 32 A8 73     		ld (endsong),a
 5346 990B 3A 0B 60     		ld a,(typ)
 5347 990E FE 33        		cp "3"
 5348 9910 20 09        		jr nz,pp0
 5349 9912 3E 01        		ld a,%00000001
 5350 9914 32 63 A9     		ld (VTPL.SETUP),a
 5351 9917 3E 01                ld a,1 ;pt2,abc,looped
 5352 9919 18 07        	    jr pp1
 5353 991B              pp0
 5354 991B 3E 03        		ld a,%00000011
 5355 991D 32 63 A9     		ld (VTPL.SETUP),a
 5356 9920 3E 02        		ld a,2
 5357 9922              pp1
 5358 9922
 5359 9922 F5           		push af
 5360 9923 FE 02        		cp 2
 5361 9925 20 05        		jr nz,pt3
 5362 9927 21 73 BD     		ld hl,modstart + 101
 5363 992A 18 03        		jr pt2
 5364 992C 21 2C BD     pt3		ld hl,modstart + 30
 5365 992F              pt2
 5366 992F CD 8D 90     		call infosong
 5367 9932 21 00 90     		ld hl,txtbuff
 5368 9935 AF           		xor a
 5369 9936 32 50 90     		ld (txtbuff+80),a
 5370 9939
 5371 9939 21 68 73     		ld hl,tmp
 5372 993C 11 69 73     		ld de,tmp+1
 5373 993F AF           		xor a
 5374 9940 77           		ld (hl),a
 5375 9941 01 30 00     		ld bc,48
 5376 9944 ED B0        		ldir
 5377 9946
 5378 9946 21 00 90     		ld hl,txtbuff
 5379 9949 11 68 73     		ld de,tmp
 5380 994C 01 21 00     		ld bc,maxline-4
 5381 994F ED B0        		ldir
 5382 9951 21 68 73     		ld hl,tmp
 5383 9954 11 21 50             ld de,20512+1
 5384 9957 CD CD 7A     		call print
 5385 995A
 5386 995A 21 68 73     		ld hl,tmp
 5387 995D 11 69 73     		ld de,tmp+1
 5388 9960 AF           		xor a
 5389 9961 77           		ld (hl),a
 5390 9962 01 30 00     		ld bc,48
 5391 9965 ED B0        		ldir
 5392 9967
 5393 9967 21 21 90     		ld hl,txtbuff + maxline-4
 5394 996A 11 68 73     		ld de,tmp
 5395 996D 01 25 00     		ld bc,maxline
 5396 9970 ED B0        		ldir
 5397 9972 21 68 73     		ld hl,tmp
 5398 9975 11 41 50             ld de,20512+1 + 32
 5399 9978 CD CD 7A     		call print
 5400 997B F1           		pop af
 5401 997C
 5402 997C 2A B5 60     		ld hl,(delka_souboru)
 5403 997F              DELKA
 5404 997F E5           		push hl
 5405 9980 7E           		ld a,(hl)
 5406 9981 FE 53        		cp "S"
 5407 9983 20 1C        		jr nz,normalni_pt3
 5408 9985 2B           		dec hl
 5409 9986 7E           		ld a,(hl)
 5410 9987 FE 54        		cp "T"
 5411 9989 20 16        		jr nz,normalni_pt3
 5412 998B 2B           		dec hl
 5413 998C 7E           		ld a,(hl)
 5414 998D FE 32        		cp "2"
 5415 998F 20 10        		jr nz,normalni_pt3
 5416 9991 2B           		dec hl
 5417 9992 7E           		ld a,(hl)
 5418 9993 FE 30        		cp "0"
 5419 9995 20 0A        		jr nz,normalni_pt3
 5420 9997 3A 63 A9     		ld a,(VTPL.SETUP)
 5421 999A F6 10        		or %00010000
 5422 999C 32 63 A9     		ld (VTPL.SETUP),a
 5423 999F 18 02        		jr pokrvdet
 5424 99A1
 5425 99A1
 5426 99A1              normalni_pt3
 5427 99A1              		;ld (VTPL.SETUP),a
 5428 99A1 18 00        		jr pokrvdet
 5429 99A3              pokrvdet
 5430 99A3 E1           		pop hl
 5431 99A4 B7           		or a
 5432 99A5 11 0B 00     		ld de,11
 5433 99A8 ED 52        		sbc hl,de
 5434 99AA
 5435 99AA 7E           		ld a,(hl)
 5436 99AB 23           		inc hl
 5437 99AC 66           		ld h,(hl)
 5438 99AD 6F           		ld l,a
 5439 99AE
 5440 99AE 11 0E BD     		ld de,songdata
 5441 99B1 19           		add hl,de
 5442 99B2 EB           		ex de,hl		;v DE máme druhou skladbu
 5443 99B3
 5444 99B3              		;CALL music_init
 5445 99B3
 5446 99B3 21 0E BD     		ld hl,songdata
 5447 99B6 CD 9A A9     		call VTPL.INIT
 5448 99B9
 5449 99B9 FB           		EI
 5450 99BA 76           LOOP	HALT
 5451 99BB
 5452 99BB
 5453 99BB E5           		push hl
 5454 99BC D5           		push de
 5455 99BD C5           		push bc
 5456 99BE
 5457 99BE 21 A0 5A     		 ld   hl,23200;Vymazání
 5458 99C1 11 A1 5A              ld   de,23201;předešlého
 5459 99C4 01 60 00              ld   bc,96   ;zobrazení.
 5460 99C7 70                    ld   (hl),b
 5461 99C8 ED B0                 ldir
 5462 99CA
 5463 99CA AF           		 xor a
 5464 99CB 21 B0 90     		 ld hl,ACBhlas
 5465 99CE 77           		 ld (hl),a
 5466 99CF
 5467 99CF 3E 08                 ld   a,8     ;A teď nové
 5468 99D1 21 B0 5A              ld   hl,23216;zobrazení.
 5469 99D4 11 AF 5A              ld   de,23215;Kanál A.
 5470 99D7 CD A8 98              call ATR
 5471 99DA
 5472 99DA 3E 0A                 ld   a,10    ;Kanál C.
 5473 99DC 21 D0 5A              ld   hl,23248
 5474 99DF 11 CF 5A              ld   de,23247
 5475 99E2 CD A8 98              call ATR
 5476 99E5
 5477 99E5 3E 09                 ld   a,9     ;Kanál B.
 5478 99E7 21 F0 5A              ld   hl,23280
 5479 99EA 11 EF 5A              ld   de,23279
 5480 99ED CD A8 98              call ATR
 5481 99F0
 5482 99F0 3A B0 90     		 ld a,(ACBhlas)
 5483 99F3 B7           		 or a
 5484 99F4 28 07        		 jr z,.s1
 5485 99F6 21 AF 90     		 ld hl,pocitadlo
 5486 99F9 AF           		 xor a
 5487 99FA 77           		 ld (hl),a
 5488 99FB 18 04        		 jr .s2
 5489 99FD 21 AF 90     .s1		 ld hl,pocitadlo
 5490 9A00 34           		 inc (hl)
 5491 9A01              .s2
 5492 9A01
 5493 9A01 CD CE 98     		call keysetup
 5494 9A04 C1           		pop bc
 5495 9A05 D1           		pop de
 5496 9A06 E1           		pop hl
 5497 9A07
 5498 9A07 CD BD B1     		CALL VTPL.PLAY
 5499 9A0A 3A 5F 9A     		ld a,(klavesa)
 5500 9A0D FE 01        		cp 1
 5501 9A0F 28 18        		jr z,koneca
 5502 9A11 FE 20        		cp 32
 5503 9A13 28 0E        		jr z,.s3
 5504 9A15 3A AF 90     		ld a,(pocitadlo)
 5505 9A18 EE 64        		xor 100
 5506 9A1A 28 07        		jr z,.s3
 5507 9A1C
 5508 9A1C
 5509 9A1C 3A 26 A2     		ld a,(music_setup)
 5510 9A1F CB 7F        		bit 7,a
 5511 9A21 28 97        		JR z,LOOP
 5512 9A23 3E 20        .s3		ld a,32
 5513 9A25 21 A8 73     		ld hl,endsong
 5514 9A28 77           		ld (hl),a
 5515 9A29 F5           koneca	push af
 5516 9A2A
 5517 9A2A CD 88 A9     		call VTPL.MUTE
 5518 9A2D F1           		pop af
 5519 9A2E C3 63 73     		jp navrat
 5520 9A31
 5521 9A31
 5522 9A31              ACB
 5523 9A31              		NEXTREG2A 08
 5523 9A31 3E 08       >        ld     a,08
 5523 9A33 CD 12 60    >        call   ReadNextReg
 5524 9A36 F6 20        		or #20
 5525 9A38 ED 92 08     		nextreg 08,a
 5526 9A3B
 5527 9A3B C9           		ret
 5528 9A3C              ABC
 5529 9A3C              		NEXTREG2A 08
 5529 9A3C 3E 08       >        ld     a,08
 5529 9A3E CD 12 60    >        call   ReadNextReg
 5530 9A41 E6 DF        		and 0xDF
 5531 9A43 ED 92 08     		nextreg 08,a
 5532 9A46
 5533 9A46 C9           		ret
 5534 9A47
 5535 9A47              setAY
 5536 9A47              		NEXTREG2A 06
 5536 9A47 3E 06       >        ld     a,06
 5536 9A49 CD 12 60    >        call   ReadNextReg
 5537 9A4C E6 FC        		and #FC
 5538 9A4E F6 01        		or #1
 5539 9A50 ED 92 06     		nextreg 06,a
 5540 9A53 C9           		ret
 5541 9A54
 5542 9A54              setYM
 5543 9A54              		NEXTREG2A 06
 5543 9A54 3E 06       >        ld     a,06
 5543 9A56 CD 12 60    >        call   ReadNextReg
 5544 9A59 E6 FC        		and #FC
 5545 9A5B ED 92 06     		nextreg 06,a
 5546 9A5E C9           		ret
 5547 9A5F
 5548 9A5F              KLAVESA
 5549 9A5F 00           klavesa defb 0
 5550 9A60              tona    equ 0
 5551 9A60              tonb    equ 2
 5552 9A60              tonc    equ 4
 5553 9A60              noise   equ 6
 5554 9A60              mixer   equ 7
 5555 9A60              ampla   equ 8
 5556 9A60              amplb   equ 9
 5557 9A60              amplc   equ 10
 5558 9A60              env     equ 11
 5559 9A60              envtp   equ 13
 5560 9A60
 5561 9A60              ;       struct  chp
 5562 9A60              ;reset group
 5563 9A60              chp_psinor      equ 0
 5564 9A60              chp_psinsm      equ 1
 5565 9A60              chp_cramsl      equ 2
 5566 9A60              chp_crnssl      equ 3
 5567 9A60              chp_crensl      equ 4
 5568 9A60              chp_tslcnt      equ 5
 5569 9A60              chp_crtnsl      equ 6
 5570 9A60              chp_tnacc       equ 8
 5571 9A60              chp_conoff      equ 10
 5572 9A60              ;reset group
 5573 9A60
 5574 9A60              chp_onoffd      equ 11
 5575 9A60
 5576 9A60              ;ix for ptdecod here (+12)
 5577 9A60              chp_offond      equ 12
 5578 9A60              chp_ornptr      equ 13
 5579 9A60              chp_samptr      equ 15
 5580 9A60              chp_nntskp      equ 17
 5581 9A60              chp_note        equ 18
 5582 9A60              chp_sltont      equ 19
 5583 9A60              chp_env_en      equ 20
 5584 9A60              chp_flags       equ 21
 5585 9A60               ;enabled - 0,simplegliss - 2
 5586 9A60              chp_tnsldl      equ 22
 5587 9A60              chp_tslstp      equ 23
 5588 9A60              chp_tndelt      equ 25
 5589 9A60              chp_ntskcn      equ 27
 5590 9A60              chp_volume      equ 28
 5591 9A60              ;       ends
 5592 9A60              chp     equ 29
 5593 9A60
 5594 9A60              ;entry and other points
 5595 9A60              ;start initialize playing of module at mdladdr
 5596 9A60              ;start+3 initialization with module address in hl
 5597 9A60              ;start+5 play one quark
 5598 9A60              ;start+8 mute
 5599 9A60              ;start+10 setup and status flags
 5600 9A60              ;start+11 current position value (byte) (optional)
 5601 9A60              ;first 12 values of tone tables (packed)
 5602 9A60
 5603 9A60
 5604 9A60 21 0E BD     music_init:	ld	hl,MDLADDR
 5605 9A63 E5           music_init0:	push	hl
 5606 9A64 01 40 00     		ld	bc,#40			; look for "by" identifier
 5607 9A67 09           		add	hl,bc
 5608 9A68 7E           		ld	a,(hl)
 5609 9A69 FE 79        		cp	'y'
 5610 9A6B 2B           		dec	hl
 5611 9A6C 7E           		ld	a,(hl)
 5612 9A6D E1           		pop	hl
 5613 9A6E 28 09        		jr	z,pt3fmt_init
 5614 9A70 FE 62        		cp	'b'
 5615 9A72 28 05        		jr	z,pt3fmt_init
 5616 9A74 7E           		ld	a,(hl)			; and first byte of PT2 is delay
 5617 9A75 B9           		cp	c				; compared to PT3 text identifier
 5618 9A76 DA EC 9A     		jp	c,pt2fmt_init
 5619 9A79
 5620 9A79 CD 55 9C     pt3fmt_init	call	setmodaddr
 5621 9A7C E5           		push	hl
 5622 9A7D 11 64 00     		ld	de,100
 5623 9A80 19           		add	hl,de
 5624 9A81 7E           		ld	a,(hl)
 5625 9A82 32 2A A1     		ld	(delay),a
 5626 9A85 E5           		push	hl
 5627 9A86 DD E1        		pop	ix
 5628 9A88 19           		add	hl,de
 5629 9A89 22 C0 A0     		ld	(CrPsPtr+1),hl
 5630 9A8C DD 5E 02     		ld	e,(ix+2)
 5631 9A8F 19           		add	hl,de
 5632 9A90 23           		inc	hl
 5633 9A91 22 CB A0     		ld	(LPosPtr+1),hl
 5634 9A94 D1           		pop	de
 5635 9A95 DD 6E 03     		ld	l,(ix+3)
 5636 9A98 DD 66 04     		ld	h,(ix+4)
 5637 9A9B 19           		add	hl,de
 5638 9A9C 22 DA A0     		ld	(PatsPtr+1),hl
 5639 9A9F 21 A9 00     		ld	hl,#A9
 5640 9AA2 19           		add	hl,de
 5641 9AA3 22 D2 9E     		ld	(OrnPtrs+1),hl
 5642 9AA6 21 69 00     		ld	hl,#69
 5643 9AA9 19           		add	hl,de
 5644 9AAA 22 E8 9E     		ld	(SamPtrs+1),hl
 5645 9AAD
 5646 9AAD DD 7E A9     		ld	a,(ix-87)		; extract version number
 5647 9AB0 D6 30        		sub	'0'
 5648 9AB2 38 04        		jr	c,l20
 5649 9AB4 FE 0A        		cp	10
 5650 9AB6 38 02        		jr	c,l21
 5651 9AB8 3E 06        l20:		ld	a,6
 5652 9ABA 32 28 9E     l21:		ld	(Version+1),a
 5653 9ABD F5           		push	af
 5654 9ABE FE 04        		cp	4
 5655 9AC0 DD 7E FF     		ld	a,(ix-1) ; tone table number
 5656 9AC3 17           		rla
 5657 9AC4 E6 07        		and	7
 5658 9AC6 F5           		push	af
 5659 9AC7
 5660 9AC7 21 18 1F     		ld	hl,#18 + ((smp_-SamCnv-2) << 8)	; jr smp_
 5661 9ACA 22 6D 9F     		ld	(SamCnv),hl
 5662 9ACD 3E BA        		ld	a,#BA				; cp d
 5663 9ACF 32 38 9F     		ld	(OrnCP),a
 5664 9AD2 32 64 9F     		ld	(SamCP),a
 5665 9AD5 3E 7B        		ld	a,#7B				; ld a,e
 5666 9AD7 32 3B 9F     		ld	(OrnLD),a
 5667 9ADA 32 67 9F     		ld	(SamLD),a
 5668 9ADD 3E 87        		ld	a,#87				; add a,a
 5669 9ADF 32 5E 9F     		ld	(SamClc2),a
 5670 9AE2 21 00 00     		ld	hl,0
 5671 9AE5 11 77 A2     		ld	de,PT3_EmptySmpOrn
 5672 9AE8 3E 3F        		ld	a,pt3pattdc-ptdecode-2
 5673 9AEA 18 62        		jr	ptx_initcommon
 5674 9AEC
 5675 9AEC 32 2A A1     pt2fmt_init:	ld	(delay),a
 5676 9AEF E5           		push	hl
 5677 9AF0 E5           		push	hl
 5678 9AF1 E5           		push	hl
 5679 9AF2 23           		inc	hl
 5680 9AF3 23           		inc	hl
 5681 9AF4 7E           		ld	a,(hl)
 5682 9AF5 23           		inc	hl
 5683 9AF6 22 E8 9E     		ld	(SamPtrs+1),hl
 5684 9AF9 5E           		ld	e,(hl)
 5685 9AFA 23           		inc	hl
 5686 9AFB 56           		ld	d,(hl)
 5687 9AFC E1           		pop	hl
 5688 9AFD A7           		and	a
 5689 9AFE ED 52        		sbc	hl,de
 5690 9B00 CD 55 9C     		call	setmodaddr
 5691 9B03 E1           		pop	hl
 5692 9B04 11 43 00     		ld	de,67
 5693 9B07 19           		add	hl,de
 5694 9B08 22 D2 9E     		ld	(OrnPtrs+1),hl
 5695 9B0B 1E 20        		ld	e,32
 5696 9B0D 19           		add	hl,de
 5697 9B0E 4E           		ld	c,(hl)
 5698 9B0F 23           		inc	hl
 5699 9B10 46           		ld	b,(hl)
 5700 9B11 1E 1E        		ld	e,30
 5701 9B13 19           		add	hl,de
 5702 9B14 22 C0 A0     		ld	(CrPsPtr+1),hl
 5703 9B17 5F           		ld	e,a
 5704 9B18 23           		inc	hl
 5705 9B19
 5706 9B19 19           		add	hl,de
 5707 9B1A 22 CB A0     		ld	(LPosPtr+1),hl
 5708 9B1D E1           		pop	hl
 5709 9B1E 09           		add	hl,bc
 5710 9B1F 22 DA A0     		ld	(PatsPtr+1),hl
 5711 9B22 3E 05        		ld	a,5
 5712 9B24 32 28 9E     		ld	(Version+1),a
 5713 9B27 F5           		push	af
 5714 9B28 3E 02        		ld	a,2
 5715 9B2A F5           		push	af
 5716 9B2B 21 CB 51     		ld	hl,$51CB			; bit 2,c
 5717 9B2E 22 6D 9F     		ld	(SamCnv),hl
 5718 9B31 3E BB        		ld	a,$BB				; cp e
 5719 9B33 32 38 9F     		ld	(OrnCP),a
 5720 9B36 32 64 9F     		ld	(SamCP),a
 5721 9B39 3E 7A        		ld	a,$7A				; ld a,d
 5722 9B3B 32 3B 9F     		ld	(OrnLD),a
 5723 9B3E 32 67 9F     		ld	(SamLD),a
 5724 9B41 3E 80        		ld	a,$80				; add a,b
 5725 9B43 32 5E 9F     		ld	(SamClc2),a
 5726 9B46 21 87 86     		ld	hl,$8687			; add a,a,(hl)
 5727 9B49 11 2B A3     		ld	de,PT2_EmptySmpOrn
 5728 9B4C 3E 87        		ld	a,pt2pattdc-ptdecode-2
 5729 9B4E
 5730 9B4E 22 D3 A0     ptx_initcommon:	ld	(PsCalc),hl
 5731 9B51 32 34 9D     		ld	(ptdecode+1),a
 5732 9B54 D5           		push	de
 5733 9B55
 5734 9B55              ; note table data depacker
 5735 9B55 11 7A A2     		ld	de,T_PACK
 5736 9B58 01 7D A3     		ld	bc,T1_+(2*49)-1
 5737 9B5B 1A           tp_0:		ld	a,(de)
 5738 9B5C 13           		inc	de
 5739 9B5D FE 1E        		cp	15*2
 5740 9B5F 30 06        		jr	nc,tp_1
 5741 9B61 67           		ld	h,a
 5742 9B62 1A           		ld	a,(de)
 5743 9B63 6F           		ld	l,a
 5744 9B64 13           		inc	de
 5745 9B65 18 07        		jr	tp_2
 5746 9B67 D5           tp_1:		push	de
 5747 9B68 16 00        		ld	d,0
 5748 9B6A 5F           		ld	e,a
 5749 9B6B 19           		add	hl,de
 5750 9B6C 19           		add	hl,de
 5751 9B6D D1           		pop	de
 5752 9B6E 7C           tp_2:		ld	a,h
 5753 9B6F 02           		ld	(bc),a
 5754 9B70 0B           		dec	bc
 5755 9B71 7D           		ld	a,l
 5756 9B72 02           		ld	(bc),a
 5757 9B73 0B           		dec	bc
 5758 9B74 D6 F0        		sub	low (#F8*2)
 5759 9B76 20 E3        		jr	nz,tp_0
 5760 9B78
 5761 9B78 32 2F A0     		ld	(GlobalAttn+1),a
 5762 9B7B 32 E4 A1     		ld	(chkfadeout+1),a
 5763 9B7E 21 26 A2     		ld	hl,music_setup
 5764 9B81 CB BE        		res	7,(hl)
 5765 9B83
 5766 9B83 21 AF A2     		ld	hl,VARS
 5767 9B86 77           		ld	(hl),a
 5768 9B87 11 B0 A2     		ld	de,VARS+1
 5769 9B8A 01 6C 00     		ld	bc,VAR0END-VARS-1
 5770 9B8D ED B0        		ldir
 5771 9B8F 23           		inc	hl
 5772 9B90 22 B5 A0     		ld	(AdInPtA+1),hl		; ptr to zero
 5773 9B93 3C           		inc	a
 5774 9B94 32 06 A3     		ld	(DelyCnt),a
 5775 9B97 21 01 F0     		ld	hl,#F001	; H - CHP.Volume, L - CHP.NtSkCn
 5776 9B9A 22 CA A2     		ld	(ChanA+CHP.NtSkCn),hl
 5777 9B9D 22 E7 A2     		ld	(ChanB+CHP.NtSkCn),hl
 5778 9BA0 22 04 A3     		ld	(ChanC+CHP.NtSkCn),hl
 5779 9BA3 E1           		pop	hl
 5780 9BA4 22 BC A2     		ld	(ChanA+CHP.OrnPtr),hl	; ornament 0 is "0,1,0"
 5781 9BA7 22 D9 A2     		ld	(ChanB+CHP.OrnPtr),hl	; in all versions from
 5782 9BAA 22 F6 A2     		ld	(ChanC+CHP.OrnPtr),hl	; 3.xx to 3.6x and VTII
 5783 9BAD F1           		pop	af
 5784 9BAE
 5785 9BAE              ;NoteTableCreator (c) Ivan Roshin
 5786 9BAE              ;A - NoteTableNumber*2+VersionForNoteTable
 5787 9BAE              ;	xx1b - 3.xx..3.4r
 5788 9BAE              ;	xx0b - 3.4x..3.6x - VortexTracker II
 5789 9BAE
 5790 9BAE 21 27 A2     		ld	hl,nt_data
 5791 9BB1 D5           		push	de
 5792 9BB2 50           		ld	d,b
 5793 9BB3 87           		add	a,a
 5794 9BB4 5F           		ld	e,a
 5795 9BB5 19           		add	hl,de
 5796 9BB6 5E           		ld	e,(hl)
 5797 9BB7 23           		inc	hl
 5798 9BB8 CB 3B        		srl	e
 5799 9BBA 9F           		sbc	a,a
 5800 9BBB E6 A7        		and	#A7	; #00 (NOP) or #A7 (AND A)
 5801 9BBD 32 E3 9B     		ld	(l3),a
 5802 9BC0 EB           		ex	de,hl
 5803 9BC1 C1           		pop	bc	; bc = T1_
 5804 9BC2 09           		add	hl,bc
 5805 9BC3 1A           		ld	a,(de)
 5806 9BC4 C6 37        		add	a,low T_
 5807 9BC6 4F           		ld	c,a
 5808 9BC7 CE A2        		adc	a,high T_
 5809 9BC9 91           		sub	c
 5810 9BCA 47           		ld	b,a
 5811 9BCB C5           		push	bc
 5812 9BCC 11 0C A4     		ld	de,NT_
 5813 9BCF D5           		push	de
 5814 9BD0 06 0C        		ld	b,12
 5815 9BD2 C5           l1:		push	bc
 5816 9BD3 4E           		ld	c,(hl)
 5817 9BD4 23           		inc	hl
 5818 9BD5 E5           		push	hl
 5819 9BD6 46           		ld	b,(hl)
 5820 9BD7 D5           		push	de
 5821 9BD8 EB           		ex	de,hl
 5822 9BD9 11 17 00     		ld	de,#17
 5823 9BDC DD 26 08     		ld	xh,8
 5824 9BDF CB 38        l2:		srl	b
 5825 9BE1 CB 19        		rr	c
 5826 9BE3 19           l3:		add	hl,de	; will be replaced by AND A or NOP apparently
 5827 9BE4 79           		ld	a,c
 5828 9BE5 8A           		adc	a,d
 5829 9BE6 77           		ld	(hl),a
 5830 9BE7 23           		inc	hl
 5831 9BE8 78           		ld	a,b
 5832 9BE9 8A           		adc	a,d
 5833 9BEA 77           		ld	(hl),a
 5834 9BEB 19           		add	hl,de
 5835 9BEC DD 25        		dec	xh
 5836 9BEE 20 EF        		jr	nz,l2
 5837 9BF0
 5838 9BF0 D1           		pop	de
 5839 9BF1 13           		inc	de
 5840 9BF2 13           		inc	de
 5841 9BF3 E1           		pop	hl
 5842 9BF4 23           		inc	hl
 5843 9BF5 C1           		pop	bc
 5844 9BF6 10 DA        		djnz	l1
 5845 9BF8
 5846 9BF8 E1           		pop	hl
 5847 9BF9 D1           		pop	de
 5848 9BFA 7B           		ld	a,e
 5849 9BFB FE 43        		cp	low TCOLD_1
 5850 9BFD 20 05        		jr	nz,corr_1
 5851 9BFF 3E FD        		ld	a,#FD
 5852 9C01 32 3A A4     		ld	(NT_+#002E),a
 5853 9C04 1A           corr_1:		ld	a,(de)
 5854 9C05 A7           		and	a
 5855 9C06 28 11        		jr	z,tc_exit
 5856 9C08 1F           		rra
 5857 9C09 F5           		push	af
 5858 9C0A 87           		add	a,a
 5859 9C0B 4F           		ld	c,a
 5860 9C0C 09           		add	hl,bc
 5861 9C0D F1           		pop	af
 5862 9C0E 30 02        		jr	nc,corr_2
 5863 9C10 35           		dec	(hl)
 5864 9C11 35           		dec	(hl)
 5865 9C12 34           corr_2:		inc	(hl)
 5866 9C13 A7           		and	a
 5867 9C14 ED 42        		sbc	hl,bc
 5868 9C16 13           		inc	de
 5869 9C17 18 EB        		jr	corr_1
 5870 9C19 F1           tc_exit:	pop	af
 5871 9C1A
 5872 9C1A              ; VolTableCreator (c) Ivan Roshin
 5873 9C1A              ; A - VersionForVolumeTable
 5874 9C1A              ;	(0..4 - v3.xx .. v3.4x
 5875 9C1A              ;	(5..  - v2.x, v3.5x .. v3.6x (VT2) .. v3.7)
 5876 9C1A
 5877 9C1A FE 05        		cp	5
 5878 9C1C 21 11 00     		ld	hl,17
 5879 9C1F 54           		ld	d,h
 5880 9C20 5C           		ld	e,h
 5881 9C21 3E 17        		ld	a,#17
 5882 9C23 30 03        		jr	nc,m1
 5883 9C25 2D           		dec	l
 5884 9C26 5D           		ld	e,l
 5885 9C27 AF           		xor	a
 5886 9C28 32 37 9C     m1:		ld	(m2),a
 5887 9C2B DD 21 1C A3  		ld	ix,VT_+16
 5888 9C2F 0E 10        		ld	c,16
 5889 9C31 E5           initloop2:	push	hl
 5890 9C32 19           		add	hl,de
 5891 9C33 EB           		ex	de,hl
 5892 9C34 ED 62        		sbc	hl,hl
 5893 9C36 7D           initloop1:	ld	a,l
 5894 9C37 7D           m2:		ld	a,l
 5895 9C38 7C           		ld	a,h
 5896 9C39 CE 00        		adc	a,0
 5897 9C3B DD 77 00     		ld	(ix+0),a
 5898 9C3E DD 23        		inc	ix
 5899 9C40 19           		add	hl,de
 5900 9C41 0C           		inc	c
 5901 9C42 79           		ld	a,c
 5902 9C43 E6 0F        		and	15
 5903 9C45 20 EF        		jr	nz,initloop1
 5904 9C47 E1           		pop	hl
 5905 9C48 7B           		ld	a,e
 5906 9C49 FE 77        		cp	#77
 5907 9C4B 20 01        		jr	nz,m3
 5908 9C4D 1C           		inc	e
 5909 9C4E 79           m3:		ld	a,c
 5910 9C4F A7           		and	a
 5911 9C50 20 DF        		jr	nz,initloop2
 5912 9C52 C3 90 A1     		jp	rout_a0
 5913 9C55
 5914 9C55 22 DE A0     setmodaddr:	ld	(modaddr+1),hl
 5915 9C58 22 EF 9E     		ld	(mdaddr1+1),hl
 5916 9C5B 22 D9 9E     		ld	(mdaddr2+1),hl
 5917 9C5E C9           		ret
 5918 9C5F
 5919 9C5F              ; PT2 pattern decoder ---------------------------------------------------------
 5920 9C5F CD E3 9E     pd2_sam		call	setsam
 5921 9C62 18 5A        		jr	pd2_loop
 5922 9C64
 5923 9C64 DD 77 08     pd2_eoff	ld	(ix-12+CHP.Env_En),a
 5924 9C67 18 55        		jr	pd2_loop
 5925 9C69
 5926 9C69 DD 36 08 10  pd2_env		ld	(ix-12+CHP.Env_En),16
 5927 9C6D 32 19 A3     		ld	(AYREGS+AR_EnvTp),a
 5928 9C70 0A           		ld	a,(bc)
 5929 9C71 03           		inc	bc
 5930 9C72 6F           		ld	l,a
 5931 9C73 0A           		ld	a,(bc)
 5932 9C74 03           		inc	bc
 5933 9C75 67           		ld	h,a
 5934 9C76 22 1A A3     		ld	(EnvBase),hl
 5935 9C79 18 43        		jr	pd2_loop
 5936 9C7B
 5937 9C7B CD CA 9E     pd2_orn		call	setorn
 5938 9C7E 18 3E        		jr	pd2_loop
 5939 9C80
 5940 9C80 3C           pd2_skip	inc	a
 5941 9C81 DD 77 05     		ld	(ix-12+CHP.NNtSkp),a
 5942 9C84 18 38        		jr	pd2_loop
 5943 9C86
 5944 9C86 0F           pd2_vol		rrca
 5945 9C87 0F           		rrca
 5946 9C88 0F           		rrca
 5947 9C89 0F           		rrca
 5948 9C8A DD 77 10     		ld	(ix-12+CHP.Volume),a
 5949 9C8D 18 2F        		jr	pd2_loop
 5950 9C8F
 5951 9C8F CD A5 9E     pd2_del		call	c_delay
 5952 9C92 18 2A        		jr	pd2_loop
 5953 9C94
 5954 9C94 DD CB 09 D6  pd2_glis	set	2,(ix-12+CHP.Flags)
 5955 9C98 3C           		inc	a
 5956 9C99 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
 5957 9C9C DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 5958 9C9F 0A           		ld	a,(bc)
 5959 9CA0 03           		inc	bc
 5960 9CA1 DD 77 0B     		ld	(ix-12+CHP.TSlStp),a
 5961 9CA4 87           		add	a,a
 5962 9CA5 9F           		sbc	a,a
 5963 9CA6 DD 77 0C     		ld	(ix-12+CHP.TSlStp+1),a
 5964 9CA9 37           		scf
 5965 9CAA 18 11        		jr	pd2_loop2
 5966 9CAC
 5967 9CAC DD CB 09 96  pd2_port:	res	2,(ix-12+CHP.Flags)
 5968 9CB0 0A           		ld	a,(bc)
 5969 9CB1 03           		inc	bc
 5970 9CB2 03           		inc	bc		; ignoring precalc delta to right sound
 5971 9CB3 03           		inc	bc
 5972 9CB4 37           		scf
 5973 9CB5 18 06        		jr	pd2_loop2
 5974 9CB7
 5975 9CB7 DD 77 F9     pd2_stop:	ld	(ix-12+CHP.TSlCnt),a
 5976 9CBA 18 02        		jr	pd2_loop
 5977 9CBC
 5978 9CBC A7           pt2pattdc:	and	a
 5979 9CBD 08           pd2_loop2:	ex	af,af'
 5980 9CBE 0A           pd2_loop:	ld	a,(bc)
 5981 9CBF 03           		inc	bc
 5982 9CC0 C6 20        		add	a,$20
 5983 9CC2 28 2F        		jr	z,pd2_rel
 5984 9CC4 38 99        		jr	c,pd2_sam
 5985 9CC6 C6 60        		add	a,96
 5986 9CC8 38 2E        		jr	c,pd2_note
 5987 9CCA 3C           		inc	a
 5988 9CCB 28 97        		jr	z,pd2_eoff
 5989 9CCD C6 0F        		add	a,15
 5990 9CCF CA D7 9D     		jp	z,pd_fin
 5991 9CD2 38 95        		jr	c,pd2_env
 5992 9CD4 C6 10        		add	a,$10
 5993 9CD6 38 A3        		jr	c,pd2_orn
 5994 9CD8 C6 40        		add	a,$40
 5995 9CDA 38 A4        		jr	c,pd2_skip
 5996 9CDC C6 10        		add	a,$10
 5997 9CDE 38 A6        		jr	c,pd2_vol
 5998 9CE0 3C           		inc	a
 5999 9CE1 28 AC        		jr	z,pd2_del
 6000 9CE3 3C           		inc	a
 6001 9CE4 28 AE        		jr	z,pd2_glis
 6002 9CE6 3C           		inc	a
 6003 9CE7 28 C3        		jr	z,pd2_port
 6004 9CE9 3C           		inc	a
 6005 9CEA 28 CB        		jr	z,pd2_stop
 6006 9CEC 0A           		ld	a,(bc)
 6007 9CED 03           		inc	bc
 6008 9CEE DD 77 F7     		ld	(ix-12+CHP.CrNsSl),a
 6009 9CF1 18 CB        		jr	pd2_loop
 6010 9CF3
 6011 9CF3 DD 77 09     pd2_rel:	ld	(ix-12+CHP.Flags),a
 6012 9CF6 18 2C        		jr	pd2_exit
 6013 9CF8
 6014 9CF8 6F           pd2_note:	ld	l,a
 6015 9CF9 DD 7E 06     		ld	a,(ix-12+CHP.Note)
 6016 9CFC 32 11 9E     		ld	(PrNote+1),a
 6017 9CFF DD 75 06     		ld	(ix-12+CHP.Note),l
 6018 9D02 AF           		xor	a
 6019 9D03 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6020 9D06 DD CB 09 C6  		set	0,(ix-12+CHP.Flags)
 6021 9D0A 08           		ex	af,af'
 6022 9D0B 30 16        		jr	nc,pd2_noglis
 6023 9D0D DD CB 09 56  		bit	2,(ix-12+CHP.Flags)
 6024 9D11 20 0C        		jr	nz,pd2_noport
 6025 9D13 32 37 9E     		ld	(LoStep+1),a
 6026 9D16 87           		add	a,a
 6027 9D17 9F           		sbc	a,a
 6028 9D18 08           		ex	af,af'
 6029 9D19 67           		ld	h,a
 6030 9D1A 6F           		ld	l,a
 6031 9D1B 3C           		inc	a
 6032 9D1C CD F2 9D     		call	setport
 6033 9D1F DD 36 F9 01  pd2_noport:	ld	(ix-12+CHP.TSlCnt),1
 6034 9D23 AF           pd2_noglis:	xor	a
 6035 9D24
 6036 9D24 DD 77 F5     pd2_exit:	ld	(ix-12+CHP.PsInSm),a
 6037 9D27 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6038 9D2A DD 77 FA     		ld	(ix-12+CHP.CrTnSl),a
 6039 9D2D DD 77 FB     		ld	(ix-12+CHP.CrTnSl+1),a
 6040 9D30 C3 D7 9D     		jp	pd_fin
 6041 9D33
 6042 9D33
 6043 9D33 18 3F        ptdecode:	jr	pt3pattdc		; patter decoder fork
 6044 9D35
 6045 9D35              ; PT3 pattern decoder ---------------------------------------------------------
 6046 9D35 DD 36 08 00  PD_OrSm:	ld	(ix-12+CHP.Env_En),0
 6047 9D39 CD CA 9E     		call	setorn
 6048 9D3C 0A           pd_sam_:	ld	a,(bc)
 6049 9D3D 03           		inc	bc
 6050 9D3E 0F           		rrca
 6051 9D3F CD E3 9E     pd_sam:		call	setsam
 6052 9D42 18 3F        		jr	pd_loop
 6053 9D44
 6054 9D44 0F           pd_vol:		rrca
 6055 9D45 0F           		rrca
 6056 9D46 0F           		rrca
 6057 9D47 0F           		rrca
 6058 9D48 DD 77 10     		ld	(ix-12+CHP.Volume),a
 6059 9D4B 18 39        		jr	pd_lp2
 6060 9D4D
 6061 9D4D DD 77 08     pd_eoff:	ld	(ix-12+CHP.Env_En),a
 6062 9D50 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6063 9D53 18 31        		jr	pd_lp2
 6064 9D55
 6065 9D55 3D           pd_SorE:	dec	a
 6066 9D56 20 07        		jr	nz,pd_env
 6067 9D58 0A           		ld	a,(bc)
 6068 9D59 03           		inc	bc
 6069 9D5A DD 77 05     		ld	(ix-12+CHP.NNtSkp),a
 6070 9D5D 18 27        		jr	pd_lp2
 6071 9D5F
 6072 9D5F CD AE 9E     pd_env:		call	setenv
 6073 9D62 18 22        		jr	pd_lp2
 6074 9D64
 6075 9D64 CD CA 9E     pd_orn:		call	setorn
 6076 9D67 18 1A        		jr	pd_loop
 6077 9D69
 6078 9D69 DD 77 08     pd_esam:	ld	(ix-12+CHP.Env_En),a
 6079 9D6C DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6080 9D6F C4 AE 9E     		call	nz,setenv
 6081 9D72 18 C8        		jr	pd_sam_
 6082 9D74
 6083 9D74 DD 7E 06     pt3pattdc:	ld	a,(ix-12+CHP.Note)
 6084 9D77 32 11 9E     		ld	(PrNote+1),a
 6085 9D7A DD 6E FA     		ld	l,(ix-12+CHP.CrTnSl)
 6086 9D7D DD 66 FB     		ld	h,(ix-12+CHP.CrTnSl+1)
 6087 9D80 22 2E 9E     		ld	(PrSlide+1),hl
 6088 9D83
 6089 9D83 11 10 20     pd_loop:	ld	de,#2010
 6090 9D86 0A           pd_lp2:		ld	a,(bc)
 6091 9D87 03           		inc	bc
 6092 9D88 83           		add	a,e
 6093 9D89 38 AA        		jr	c,PD_OrSm
 6094 9D8B 82           		add	a,d
 6095 9D8C 28 49        		jr	z,pd_fin
 6096 9D8E 38 AF        		jr	c,pd_sam
 6097 9D90 83           		add	a,e
 6098 9D91 28 25        		jr	z,pd_rel
 6099 9D93 38 AF        		jr	c,pd_vol
 6100 9D95 83           		add	a,e
 6101 9D96 28 B5        		jr	z,pd_eoff
 6102 9D98 38 BB        		jr	c,pd_SorE
 6103 9D9A C6 60        		add	a,#60
 6104 9D9C 38 20        		jr	c,pd_note
 6105 9D9E 83           		add	a,e
 6106 9D9F 38 C3        		jr	c,pd_orn
 6107 9DA1 82           		add	a,d
 6108 9DA2 38 0F        		jr	c,pd_nois
 6109 9DA4 83           		add	a,e
 6110 9DA5 38 C2        		jr	c,pd_esam
 6111 9DA7 87           		add	a,a
 6112 9DA8 5F           		ld	e,a
 6113 9DA9 21 19 7E     		ld	hl,spccoms-#20E0
 6114 9DAC 19           		add	hl,de
 6115 9DAD 5E           		ld	e,(hl)
 6116 9DAE 23           		inc	hl
 6117 9DAF 56           		ld	d,(hl)
 6118 9DB0 D5           		push	de
 6119 9DB1 18 D0        		jr	pd_loop
 6120 9DB3
 6121 9DB3 32 0A A3     pd_nois:	ld	(Ns_base),a
 6122 9DB6 18 CE        		jr	pd_lp2
 6123 9DB8
 6124 9DB8 DD CB 09 86  pd_rel:		res	0,(ix-12+CHP.Flags)
 6125 9DBC 18 08        		jr	pd_res
 6126 9DBE
 6127 9DBE DD 77 06     pd_note:	ld	(ix-12+CHP.Note),a
 6128 9DC1 DD CB 09 C6  		set	0,(ix-12+CHP.Flags)
 6129 9DC5 AF           		xor	a
 6130 9DC6 ED 73 D5 9D  pd_res:		ld	(pdsp_+1),sp
 6131 9DCA DD F9        		ld	sp,ix
 6132 9DCC 67           		ld	h,a
 6133 9DCD 6F           		ld	l,a
 6134 9DCE E5           		push	hl
 6135 9DCF E5           		push	hl
 6136 9DD0 E5           		push	hl
 6137 9DD1 E5           		push	hl
 6138 9DD2 E5           		push	hl
 6139 9DD3 E5           		push	hl
 6140 9DD4 31 31 31     pdsp_:		ld	sp,#3131
 6141 9DD7 DD 7E 05     pd_fin:		ld	a,(ix-12+CHP.NNtSkp)
 6142 9DDA DD 77 0F     		ld	(ix-12+CHP.NtSkCn),a
 6143 9DDD C9           		ret
 6144 9DDE
 6145 9DDE 0A           c_portm:	ld	a,(bc)
 6146 9DDF 03           		inc	bc
 6147 9DE0 03           		inc	bc	; skip precalculated tone delta
 6148 9DE1 03           		inc	bc	; (because cannot be right after pt3 compilation)
 6149 9DE2 08           		ex	af,af'
 6150 9DE3 0A           		ld	a,(bc)	; signed tone step
 6151 9DE4 03           		inc	bc
 6152 9DE5 32 37 9E     		ld	(LoStep+1),a
 6153 9DE8 0A           		ld	a,(bc)
 6154 9DE9 03           		inc	bc
 6155 9DEA A7           		and	a
 6156 9DEB 08           		ex	af,af'
 6157 9DEC DD 6E FA     		ld	l,(ix-12+CHP.CrTnSl)
 6158 9DEF DD 66 FB     		ld	h,(ix-12+CHP.CrTnSl+1)
 6159 9DF2
 6160 9DF2              ; Set portamento variables
 6161 9DF2              ; A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 6162 9DF2 DD CB 09 96  setport		res	2,(ix-12+CHP.Flags)
 6163 9DF6 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
 6164 9DF9 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6165 9DFC E5           		push	hl
 6166 9DFD 11 0C A4     		ld	de,NT_
 6167 9E00 DD 7E 06     		ld	a,(ix-12+CHP.Note)
 6168 9E03 DD 77 07     		ld	(ix-12+CHP.SlToNt),a
 6169 9E06 87           		add	a,a
 6170 9E07 6F           		ld	l,a
 6171 9E08 26 00        		ld	h,0
 6172 9E0A 19           		add	hl,de
 6173 9E0B 7E           		ld	a,(hl)
 6174 9E0C 23           		inc	hl
 6175 9E0D 66           		ld	h,(hl)
 6176 9E0E 6F           		ld	l,a
 6177 9E0F E5           		push	hl
 6178 9E10 3E 3E        PrNote:		ld	a,#3E
 6179 9E12 DD 77 06     		ld	(ix-12+CHP.Note),a
 6180 9E15 87           		add	a,a
 6181 9E16 6F           		ld	l,a
 6182 9E17 26 00        		ld	h,0
 6183 9E19 19           		add	hl,de
 6184 9E1A 5E           		ld	e,(hl)
 6185 9E1B 23           		inc	hl
 6186 9E1C 56           		ld	d,(hl)
 6187 9E1D E1           		pop	hl
 6188 9E1E ED 52        		sbc	hl,de
 6189 9E20 DD 75 0D     		ld	(ix-12+CHP.TnDelt),l
 6190 9E23 DD 74 0E     		ld	(ix-12+CHP.TnDelt+1),h
 6191 9E26 D1           		pop	de
 6192 9E27 3E 3E        Version:	ld	a,#3E
 6193 9E29 FE 06        		cp	6
 6194 9E2B 38 09        		jr	c,LoStep	; old 3xxx for PT v3.5-
 6195 9E2D 11 11 11     PrSlide:	ld	de,#1111
 6196 9E30 DD 73 FA     		ld	(ix-12+CHP.CrTnSl),e
 6197 9E33 DD 72 FB     		ld	(ix-12+CHP.CrTnSl+1),d
 6198 9E36 3E 00        LoStep:		ld	a,0		; signed tone step
 6199 9E38 08           		ex	af,af'
 6200 9E39 28 01        		jr	z,nosig
 6201 9E3B EB           		ex	de,hl
 6202 9E3C ED 52        nosig:		sbc	hl,de
 6203 9E3E F2 46 9E     		jp	p,set_stp
 6204 9E41 2F           		cpl
 6205 9E42 08           		ex	af,af'
 6206 9E43 ED 44        		neg
 6207 9E45 08           		ex	af,af'
 6208 9E46 DD 77 0C     set_stp:	ld	(ix-12+CHP.TSlStp+1),a
 6209 9E49 08           		ex	af,af'
 6210 9E4A DD 77 0B     		ld	(ix-12+CHP.TSlStp),a
 6211 9E4D DD 36 FE 00  		ld	(ix-12+CHP.COnOff),0
 6212 9E51 C9           		ret
 6213 9E52
 6214 9E52 DD CB 09 D6  c_gliss:	set	2,(ix-12+CHP.Flags)
 6215 9E56 0A           		ld	a,(bc)
 6216 9E57 03           		inc	bc
 6217 9E58 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
 6218 9E5B A7           		and	a
 6219 9E5C 20 07        		jr	nz,gl36
 6220 9E5E 3A 28 9E     		ld	a,(Version+1) ;AlCo PT3.7+
 6221 9E61 FE 07        		cp	7
 6222 9E63 9F           		sbc	a,a
 6223 9E64 3C           		inc	a
 6224 9E65 DD 77 F9     gl36:		ld	(ix-12+CHP.TSlCnt),a
 6225 9E68 0A           		ld	a,(bc)
 6226 9E69 03           		inc	bc
 6227 9E6A 08           		ex	af,af'
 6228 9E6B 0A           		ld	a,(bc)
 6229 9E6C 03           		inc	bc
 6230 9E6D 18 D7        		jr	set_stp
 6231 9E6F
 6232 9E6F 0A           c_smpos:	ld	a,(bc)
 6233 9E70 03           		inc	bc
 6234 9E71 DD 77 F5     		ld	(ix-12+CHP.PsInSm),a
 6235 9E74 C9           		ret
 6236 9E75
 6237 9E75 0A           c_orpos:	ld	a,(bc)
 6238 9E76 03           		inc	bc
 6239 9E77 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6240 9E7A C9           		ret
 6241 9E7B
 6242 9E7B 0A           c_vibrt:	ld	a,(bc)
 6243 9E7C 03           		inc	bc
 6244 9E7D DD 77 FF     		ld	(ix-12+CHP.OnOffD),a
 6245 9E80 DD 77 FE     		ld	(ix-12+CHP.COnOff),a
 6246 9E83 0A           		ld	a,(bc)
 6247 9E84 03           		inc	bc
 6248 9E85 DD 77 00     		ld	(ix-12+CHP.OffOnD),a
 6249 9E88 AF           		xor	a
 6250 9E89 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6251 9E8C DD 77 FA     		ld	(ix-12+CHP.CrTnSl),a
 6252 9E8F DD 77 FB     		ld	(ix-12+CHP.CrTnSl+1),a
 6253 9E92 C9           		ret
 6254 9E93
 6255 9E93 0A           c_engls:	ld	a,(bc)
 6256 9E94 03           		inc	bc
 6257 9E95 32 86 A1     		ld	(Env_Del+1),a
 6258 9E98 32 09 A3     		ld	(CurEDel),a
 6259 9E9B 0A           		ld	a,(bc)
 6260 9E9C 03           		inc	bc
 6261 9E9D 6F           		ld	l,a
 6262 9E9E 0A           		ld	a,(bc)
 6263 9E9F 03           		inc	bc
 6264 9EA0 67           		ld	h,a
 6265 9EA1 22 89 A1     		ld	(ESldAdd+1),hl
 6266 9EA4 C9           		ret
 6267 9EA5
 6268 9EA5 0A           c_delay:	ld	a,(bc)
 6269 9EA6 03           		inc	bc
 6270 9EA7 32 2A A1     		ld	(delay),a
 6271 9EAA 32 06 A3     		ld	(DelyCnt),a ; bugfix by Lee_dC
 6272 9EAD C9           		ret
 6273 9EAE
 6274 9EAE DD 73 08     setenv:		ld	(ix-12+CHP.Env_En),e
 6275 9EB1 32 19 A3     		ld	(AYREGS+AR_EnvTp),a
 6276 9EB4 0A           		ld	a,(bc)
 6277 9EB5 03           		inc	bc
 6278 9EB6 67           		ld	h,a
 6279 9EB7 0A           		ld	a,(bc)
 6280 9EB8 03           		inc	bc
 6281 9EB9 6F           		ld	l,a
 6282 9EBA 22 1A A3     		ld	(EnvBase),hl
 6283 9EBD AF           		xor	a
 6284 9EBE DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6285 9EC1 32 09 A3     		ld	(CurEDel),a
 6286 9EC4 67           		ld	h,a
 6287 9EC5 6F           		ld	l,a
 6288 9EC6 22 07 A3     		ld	(CurESld),hl
 6289 9EC9 C9           c_nop:		ret
 6290 9ECA
 6291 9ECA 87           setorn:		add	a,a
 6292 9ECB 5F           		ld	e,a
 6293 9ECC 16 00        		ld	d,0
 6294 9ECE DD 72 F4     		ld	(ix-12+CHP.PsInOr),d
 6295 9ED1 21 21 21     OrnPtrs:	ld	hl,#2121
 6296 9ED4 19           		add	hl,de
 6297 9ED5 5E           		ld	e,(hl)
 6298 9ED6 23           		inc	hl
 6299 9ED7 56           		ld	d,(hl)
 6300 9ED8 21 21 21     mdaddr2:	ld	hl,#2121
 6301 9EDB 19           		add	hl,de
 6302 9EDC DD 75 01     		ld	(ix-12+CHP.OrnPtr),l
 6303 9EDF DD 74 02     		ld	(ix-12+CHP.OrnPtr+1),h
 6304 9EE2 C9           		ret
 6305 9EE3
 6306 9EE3 87           setsam:		add	a,a
 6307 9EE4 5F           		ld	e,a
 6308 9EE5 16 00        		ld	d,0
 6309 9EE7 21 21 21     SamPtrs:	ld	hl,#2121
 6310 9EEA 19           		add	hl,de
 6311 9EEB 5E           		ld	e,(hl)
 6312 9EEC 23           		inc	hl
 6313 9EED 56           		ld	d,(hl)
 6314 9EEE 21 21 21     mdaddr1:	ld	hl,#2121
 6315 9EF1 19           		add	hl,de
 6316 9EF2 DD 75 03     		ld	(ix-12+CHP.SamPtr),l
 6317 9EF5 DD 74 04     		ld	(ix-12+CHP.SamPtr+1),h
 6318 9EF8 C9           		ret
 6319 9EF9
 6320 9EF9              ; all 16 addresses filled to protect from broken pt3 modules
 6321 9EF9 C9 9E        spccoms:	dw	c_nop
 6322 9EFB 52 9E        		dw	c_gliss
 6323 9EFD DE 9D        		dw	c_portm
 6324 9EFF 6F 9E        		dw	c_smpos
 6325 9F01 75 9E        		dw	c_orpos
 6326 9F03 7B 9E        		dw	c_vibrt
 6327 9F05 C9 9E        		dw	c_nop
 6328 9F07 C9 9E        		dw	c_nop
 6329 9F09 93 9E        		dw	c_engls
 6330 9F0B A5 9E        		dw	c_delay
 6331 9F0D C9 9E        		dw	c_nop
 6332 9F0F C9 9E        		dw	c_nop
 6333 9F11 C9 9E        		dw	c_nop
 6334 9F13 C9 9E        		dw	c_nop
 6335 9F15 C9 9E        		dw	c_nop
 6336 9F17 C9 9E        		dw	c_nop
 6337 9F19
 6338 9F19 AF           chregs:		xor	a
 6339 9F1A 32 16 A3     		ld	(Ampl),a
 6340 9F1D DD CB 15 46  		bit	0,(ix+CHP.Flags)
 6341 9F21 E5           		push	hl
 6342 9F22 CA 76 A0     		jp	z,ch_exit
 6343 9F25 ED 73 B3 9F  		ld	(csp_+1),sp
 6344 9F29 DD 6E 0D     		ld	l,(ix+CHP.OrnPtr)
 6345 9F2C DD 66 0E     		ld	h,(ix+CHP.OrnPtr+1)
 6346 9F2F F9           		ld	sp,hl
 6347 9F30 D1           		pop	de
 6348 9F31 67           		ld	h,a
 6349 9F32 DD 7E 00     		ld	a,(ix+CHP.PsInOr)
 6350 9F35 6F           		ld	l,a
 6351 9F36 39           		add	hl,sp
 6352 9F37 3C           		inc	a			; PT2	| PT3
 6353 9F38 BA           OrnCP:		cp	d			; cp e	| cp d
 6354 9F39 38 01        		jr	c,ch_orps
 6355 9F3B 7B           OrnLD:		ld	a,e			; a,d	| a,e
 6356 9F3C DD 77 00     ch_orps:	ld	(ix+CHP.PsInOr),a
 6357 9F3F DD 7E 12     		ld	a,(ix+CHP.Note)
 6358 9F42 86           		add	a,(hl)
 6359 9F43 F2 47 9F     		jp	p,ch_ntp
 6360 9F46 AF           		xor	a
 6361 9F47 FE 60        ch_ntp:		cp	96
 6362 9F49 38 02        		jr	c,ch_nok
 6363 9F4B 3E 5F        		ld	a,95
 6364 9F4D 87           ch_nok:		add	a,a
 6365 9F4E 08           		ex	af,af'
 6366 9F4F DD 6E 0F     		ld	l,(ix+CHP.SamPtr)
 6367 9F52 DD 66 10     		ld	h,(ix+CHP.SamPtr+1)
 6368 9F55 F9           		ld	sp,hl
 6369 9F56 D1           		pop	de
 6370 9F57 26 00        		ld	h,0
 6371 9F59 DD 7E 01     		ld	a,(ix+CHP.PsInSm)
 6372 9F5C 47           		ld	b,a
 6373 9F5D 87           		add	a,a			; PT2	| PT3
 6374 9F5E 87           SamClc2:	add	a,a			; a,b	| a,a
 6375 9F5F 6F           		ld	l,a
 6376 9F60 39           		add	hl,sp
 6377 9F61 F9           		ld	sp,hl
 6378 9F62 78           		ld	a,b
 6379 9F63 3C           		inc	a
 6380 9F64 BA           SamCP:		cp	d			; cp e	| cp d
 6381 9F65 38 01        		jr	c,ch_smps
 6382 9F67 7B           SamLD:		ld	a,e			; a,d	| a,e
 6383 9F68 DD 77 01     ch_smps:	ld	(ix+CHP.PsInSm),a
 6384 9F6B C1           		pop	bc
 6385 9F6C E1           		pop	hl
 6386 9F6D              						; PT2     | PT3
 6387 9F6D 18 1F        SamCnv:		jr	smp_			; bit 2,c | jr smp_
 6388 9F6F
 6389 9F6F 60           		ld	h,b			; Convert PT2 sample to PT3
 6390 9F70 20 06        		jr	nz,SamCnv1
 6391 9F72 EB           		ex	de,hl
 6392 9F73 A7           		and	a
 6393 9F74 ED 62        		sbc	hl,hl
 6394 9F76 ED 52        		sbc	hl,de
 6395 9F78 51           SamCnv1:	ld	d,c
 6396 9F79 CB 19        		rr	c
 6397 9F7B 9F           		sbc	a,a
 6398 9F7C 2F           		cpl
 6399 9F7D E6 3E        		and	#3E
 6400 9F7F CB 19        		rr	c
 6401 9F81 CB 18        		rr	b
 6402 9F83 A1           		and	c
 6403 9F84 4F           		ld	c,a
 6404 9F85 78           		ld	a,b
 6405 9F86 1F           		rra
 6406 9F87 1F           		rra
 6407 9F88 CB 1A        		rr	d
 6408 9F8A 1F           		rra
 6409 9F8B E6 9F        		and	#9F
 6410 9F8D 47           		ld	b,a
 6411 9F8E
 6412 9F8E DD 5E 08     smp_:		ld	e,(ix+CHP.TnAcc)
 6413 9F91 DD 56 09     		ld	d,(ix+CHP.TnAcc+1)
 6414 9F94 19           		add	hl,de
 6415 9F95 CB 70        		bit	6,b
 6416 9F97 28 06        		jr	z,ch_noac
 6417 9F99 DD 75 08     		ld	(ix+CHP.TnAcc),l
 6418 9F9C DD 74 09     		ld	(ix+CHP.TnAcc+1),h
 6419 9F9F EB           ch_noac:	ex	de,hl
 6420 9FA0 08           		ex	af,af'
 6421 9FA1 6F           		ld	l,a
 6422 9FA2 26 00        		ld	h,0
 6423 9FA4 31 0C A4     		ld	sp,NT_
 6424 9FA7 39           		add	hl,sp
 6425 9FA8 F9           		ld	sp,hl
 6426 9FA9 E1           		pop	hl
 6427 9FAA 19           		add	hl,de
 6428 9FAB DD 5E 06     		ld	e,(ix+CHP.CrTnSl)
 6429 9FAE DD 56 07     		ld	d,(ix+CHP.CrTnSl+1)
 6430 9FB1 19           		add	hl,de
 6431 9FB2 31 31 31     csp_:		ld	sp,#3131
 6432 9FB5 E3           		ex	(sp),hl
 6433 9FB6 AF           		xor	a
 6434 9FB7 DD B6 05     		or	(ix+CHP.TSlCnt)
 6435 9FBA 28 3E        		jr	z,ch_amp
 6436 9FBC DD 35 05     		dec	(ix+CHP.TSlCnt)
 6437 9FBF 20 39        		jr	nz,ch_amp
 6438 9FC1 DD 7E 16     		ld	a,(ix+CHP.TnSlDl)
 6439 9FC4 DD 77 05     		ld	(ix+CHP.TSlCnt),a
 6440 9FC7 DD 6E 17     		ld	l,(ix+CHP.TSlStp)
 6441 9FCA DD 66 18     		ld	h,(ix+CHP.TSlStp+1)
 6442 9FCD 7C           		ld	a,h
 6443 9FCE 19           		add	hl,de
 6444 9FCF DD 75 06     		ld	(ix+CHP.CrTnSl),l
 6445 9FD2 DD 74 07     		ld	(ix+CHP.CrTnSl+1),h
 6446 9FD5 DD CB 15 56  		bit	2,(ix+CHP.Flags)
 6447 9FD9 20 1F        		jr	nz,ch_amp
 6448 9FDB DD 5E 19     		ld	e,(ix+CHP.TnDelt)
 6449 9FDE DD 56 1A     		ld	d,(ix+CHP.TnDelt+1)
 6450 9FE1 A7           		and	a
 6451 9FE2 28 01        		jr	z,ch_stpp
 6452 9FE4 EB           		ex	de,hl
 6453 9FE5 ED 52        ch_stpp:	sbc	hl,de
 6454 9FE7 FA FA 9F     		jp	m,ch_amp
 6455 9FEA DD 7E 13     		ld	a,(ix+CHP.SlToNt)
 6456 9FED DD 77 12     		ld	(ix+CHP.Note),a
 6457 9FF0 AF           		xor	a
 6458 9FF1 DD 77 05     		ld	(ix+CHP.TSlCnt),a
 6459 9FF4 DD 77 06     		ld	(ix+CHP.CrTnSl),a
 6460 9FF7 DD 77 07     		ld	(ix+CHP.CrTnSl+1),a
 6461 9FFA DD 7E 02     ch_amp:		ld	a,(ix+CHP.CrAmSl)
 6462 9FFD CB 79        		bit	7,c
 6463 9FFF 28 13        		jr	z,ch_noam
 6464 A001 CB 71        		bit	6,c
 6465 A003 28 07        		jr	z,ch_amin
 6466 A005 FE 0F        		cp	15
 6467 A007 28 0B        		jr	z,ch_noam
 6468 A009 3C           		inc	a
 6469 A00A 18 05        		jr	ch_svam
 6470 A00C FE F1        ch_amin:	cp	-15
 6471 A00E 28 04        		jr	z,ch_noam
 6472 A010 3D           		dec	a
 6473 A011 DD 77 02     ch_svam:	ld	(ix+CHP.CrAmSl),a
 6474 A014 6F           ch_noam:	ld	l,a
 6475 A015 78           		ld	a,b
 6476 A016 E6 0F        		and	15
 6477 A018 85           		add	a,l
 6478 A019 F2 1D A0     		jp	p,ch_apos
 6479 A01C AF           		xor	a
 6480 A01D FE 10        ch_apos:	cp	16
 6481 A01F 38 02        		jr	c,ch_vol
 6482 A021 3E 0F        		ld	a,15
 6483 A023 DD B6 1C     ch_vol:		or	(ix+CHP.Volume)
 6484 A026 6F           		ld	l,a
 6485 A027 26 00        		ld	h,0
 6486 A029 11 0C A3     		ld	de,VT_
 6487 A02C 19           		add	hl,de
 6488 A02D 5E           		ld	e,(hl)
 6489 A02E 3E 00        GlobalAttn:	ld	a,0		; GLOBAL ATTENUATION
 6490 A030 FE 08        		cp	8		; if value of attenuation is higher
 6491 A032 38 02        		jr	c,ch_globvol	; then this value we will stop
 6492 A034 CB C1        		set	0,c		; also envelopes (bit.0 in flags)...
 6493 A036 93           ch_globvol:	sub	e
 6494 A037 38 01        		jr	c,ch_env
 6495 A039 AF           		xor	a
 6496 A03A ED 44        ch_env:		neg
 6497 A03C CB 41        		bit	0,c
 6498 A03E 20 03        		jr	nz,ch_noen
 6499 A040 DD B6 14     		or	(ix+CHP.Env_En)
 6500 A043 32 16 A3     ch_noen:	ld	(Ampl),a
 6501 A046 CB 78        		bit	7,b
 6502 A048 79           		ld	a,c
 6503 A049 28 19        		jr	z,no_ensl
 6504 A04B 17           		rla
 6505 A04C 17           		rla
 6506 A04D CB 2F        		sra	a
 6507 A04F CB 2F        		sra	a
 6508 A051 CB 2F        		sra	a
 6509 A053 DD 86 04     		add	a,(ix+CHP.CrEnSl)
 6510 A056 CB 68        		bit	5,b
 6511 A058 28 03        		jr	z,no_enac
 6512 A05A DD 77 04     		ld	(ix+CHP.CrEnSl),a
 6513 A05D 21 6A A1     no_enac:	ld	hl,AddToEn+1
 6514 A060 86           		add	a,(hl)
 6515 A061 77           		ld	(hl),a
 6516 A062 18 0E        		jr	ch_mix
 6517 A064
 6518 A064 1F           no_ensl:	rra
 6519 A065 DD 86 03     		add	a,(ix+CHP.CrNsSl)
 6520 A068 32 0B A3     		ld	(AddToNs),a
 6521 A06B CB 68        		bit	5,b
 6522 A06D 28 03        		jr	z,ch_mix
 6523 A06F DD 77 03     		ld	(ix+CHP.CrNsSl),a
 6524 A072 78           ch_mix:		ld	a,b
 6525 A073 1F           		rra
 6526 A074 E6 48        		and	#48
 6527 A076 21 13 A3     ch_exit:	ld	hl,AYREGS+AR_Mixer
 6528 A079 B6           		or	(hl)
 6529 A07A 0F           		rrca
 6530 A07B 77           		ld	(hl),a
 6531 A07C E1           		pop	hl
 6532 A07D AF           		xor	a
 6533 A07E DD B6 0A     		or	(ix+CHP.COnOff)
 6534 A081 C8           		ret	z
 6535 A082 DD 35 0A     		dec	(ix+CHP.COnOff)
 6536 A085 C0           		ret	nz
 6537 A086 DD AE 15     		xor	(ix+CHP.Flags)
 6538 A089 DD 77 15     		ld	(ix+CHP.Flags),a
 6539 A08C 1F           		rra
 6540 A08D DD 7E 0B     		ld	a,(ix+CHP.OnOffD)
 6541 A090 38 03        		jr	c,ch_ondl
 6542 A092 DD 7E 0C     		ld	a,(ix+CHP.OffOnD)
 6543 A095 DD 77 0A     ch_ondl:	ld	(ix+CHP.COnOff),a
 6544 A098 C9           		ret
 6545 A099
 6546 A099              ;------------------------------------------------------------------------------
 6547 A099 AF           music_play:	xor	a
 6548 A09A 32 6A A1     		ld	(AddToEn+1),a
 6549 A09D 32 13 A3     		ld	(AYREGS+AR_Mixer),a
 6550 A0A0 3D           		dec	a
 6551 A0A1 32 19 A3     		ld	(AYREGS+AR_EnvTp),a
 6552 A0A4 21 06 A3     		ld	hl,DelyCnt
 6553 A0A7 35           		dec	(hl)
 6554 A0A8 C2 2E A1     		jp	nz,pl2
 6555 A0AB CD E3 A1     		call	chkfadeout
 6556 A0AE 21 CA A2     		ld	hl,ChanA+CHP.NtSkCn
 6557 A0B1 35           		dec	(hl)
 6558 A0B2 20 4D        		jr	nz,pl1b
 6559 A0B4 01 01 01     AdInPtA:	ld	bc,#0101
 6560 A0B7 0A           		ld	a,(bc)
 6561 A0B8 A7           		and	a
 6562 A0B9 20 3B        		jr	nz,pl1a
 6563 A0BB 57           		ld	d,a
 6564 A0BC 32 0A A3     		ld	(Ns_base),a
 6565 A0BF 21 21 21     CrPsPtr:	ld	hl,#2121
 6566 A0C2 23           		inc	hl
 6567 A0C3 7E           		ld	a,(hl)
 6568 A0C4 3C           		inc	a
 6569 A0C5 20 08        		jr	nz,plnlp
 6570 A0C7 CD AD A1     		call	checklp
 6571 A0CA 21 21 21     LPosPtr:	ld	hl,#2121
 6572 A0CD 7E           		ld	a,(hl)
 6573 A0CE 3C           		inc	a
 6574 A0CF 22 C0 A0     plnlp:		ld	(CrPsPtr+1),hl
 6575 A0D2 3D           		dec	a			; PT2		PT3
 6576 A0D3 00           PsCalc:		nop				; add a,a	nop
 6577 A0D4 00           		nop				; add a,(hl)	nop
 6578 A0D5 87           		add	a,a
 6579 A0D6 5F           		ld	e,a
 6580 A0D7 CB 12        		rl	d
 6581 A0D9 21 21 21     PatsPtr:	ld	hl,#2121
 6582 A0DC 19           		add	hl,de
 6583 A0DD 11 11 11     modaddr:	ld	de,#1111
 6584 A0E0 ED 73 F4 A0  		ld	(psp_+1),sp
 6585 A0E4 F9           		ld	sp,hl
 6586 A0E5 E1           		pop	hl
 6587 A0E6 19           		add	hl,de
 6588 A0E7 44           		ld	b,h
 6589 A0E8 4D           		ld	c,l
 6590 A0E9 E1           		pop	hl
 6591 A0EA 19           		add	hl,de
 6592 A0EB 22 0C A1     		ld	(AdInPtB+1),hl
 6593 A0EE E1           		pop	hl
 6594 A0EF 19           		add	hl,de
 6595 A0F0 22 20 A1     		ld	(AdInPtC+1),hl
 6596 A0F3 31 31 31     psp_:		ld	sp,#3131
 6597 A0F6 DD 21 BB A2  pl1a:		ld	ix,ChanA+12
 6598 A0FA CD 33 9D     		call	ptdecode
 6599 A0FD ED 43 B5 A0  		ld	(AdInPtA+1),bc
 6600 A101
 6601 A101 21 E7 A2     pl1b:		ld	hl,ChanB+CHP.NtSkCn
 6602 A104 35           		dec	(hl)
 6603 A105 20 0E        		jr	nz,pl1c
 6604 A107 DD 21 D8 A2  		ld	ix,ChanB+12
 6605 A10B 01 01 01     AdInPtB:	ld	bc,#0101
 6606 A10E CD 33 9D     		call	ptdecode
 6607 A111 ED 43 0C A1  		ld	(AdInPtB+1),bc
 6608 A115
 6609 A115 21 04 A3     pl1c:		ld	hl,ChanC+CHP.NtSkCn
 6610 A118 35           		dec	(hl)
 6611 A119 20 0E        		jr	nz,pl1d
 6612 A11B DD 21 F5 A2  		ld	ix,ChanC+12
 6613 A11F 01 01 01     AdInPtC:	ld	bc,#0101
 6614 A122 CD 33 9D     		call	ptdecode
 6615 A125 ED 43 20 A1  		ld	(AdInPtC+1),bc
 6616 A129              delay:		equ	$+1
 6617 A129 3E 3E        pl1d:		ld	a,#3E
 6618 A12B 32 06 A3     		ld	(DelyCnt),a
 6619 A12E DD 21 AF A2  pl2:		ld	ix,ChanA
 6620 A132 2A 0C A3     		ld	hl,(AYREGS+AR_TonA)
 6621 A135 CD 19 9F     		call	chregs
 6622 A138 22 0C A3     		ld	(AYREGS+AR_TonA),hl
 6623 A13B
 6624 A13B 3A 16 A3     		ld	a,(Ampl)
 6625 A13E 32 14 A3     		ld	(AYREGS+AR_AmplA),a
 6626 A141 DD 21 CC A2  		ld	ix,ChanB
 6627 A145 2A 0E A3     		ld	hl,(AYREGS+AR_TonB)
 6628 A148 CD 19 9F     		call	chregs
 6629 A14B 22 0E A3     		ld	(AYREGS+AR_TonB),hl
 6630 A14E
 6631 A14E 3A 16 A3     		ld	a,(Ampl)
 6632 A151 32 15 A3     		ld	(AYREGS+AR_AmplB),a
 6633 A154 DD 21 E9 A2  		ld	ix,ChanC
 6634 A158 2A 10 A3     		ld	hl,(AYREGS+AR_TonC)
 6635 A15B CD 19 9F     		call	chregs
 6636 A15E 22 10 A3     		ld	(AYREGS+AR_TonC),hl
 6637 A161
 6638 A161 2A 0A A3     		ld	hl,(Ns_base) ; read together with AddToNs
 6639 A164 7C           		ld	a,h
 6640 A165 85           		add	a,l
 6641 A166 32 12 A3     		ld	(AYREGS+AR_Noise),a
 6642 A169
 6643 A169 3E 3E        AddToEn:	ld	a,#3E
 6644 A16B 5F           		ld	e,a
 6645 A16C 87           		add	a,a
 6646 A16D 9F           		sbc	a,a
 6647 A16E 57           		ld	d,a
 6648 A16F 2A 1A A3     		ld	hl,(EnvBase)
 6649 A172 19           		add	hl,de
 6650 A173 ED 5B 07 A3  		ld	de,(CurESld)
 6651 A177 19           		add	hl,de
 6652 A178 22 17 A3     		ld	(AYREGS+AR_Env),hl
 6653 A17B
 6654 A17B AF           		xor	a
 6655 A17C 21 09 A3     		ld	hl,CurEDel
 6656 A17F B6           		or	(hl)
 6657 A180 28 0E        		jr	z,rout_a0
 6658 A182 35           		dec	(hl)
 6659 A183 20 0A        		jr	nz,rout
 6660 A185 3E 3E        Env_Del:	ld	a,#3E
 6661 A187 77           		ld	(hl),a
 6662 A188 21 21 21     ESldAdd:	ld	hl,#2121
 6663 A18B 19           		add	hl,de
 6664 A18C 22 07 A3     		ld	(CurESld),hl
 6665 A18F
 6666 A18F AF           rout:		xor	a
 6667 A190 11 BF FF     rout_a0:	ld	de,#FFBF
 6668 A193 01 FD FF     		ld	bc,#FFFD
 6669 A196 21 0C A3     		ld	hl,AYREGS
 6670 A199 ED 79        lout:		out	(c),a
 6671 A19B 43           		ld	b,e
 6672 A19C ED A3        		outi
 6673 A19E 42           		ld	b,d
 6674 A19F 3C           		inc	a
 6675 A1A0 FE 0D        		cp	#0D
 6676 A1A2 20 F5        		jr	nz,lout
 6677 A1A4 ED 79        		out	(c),a
 6678 A1A6 7E           		ld	a,(hl)
 6679 A1A7 A7           		and	a
 6680 A1A8 F8           		ret	m
 6681 A1A9 43           		ld	b,e
 6682 A1AA ED 79        		out	(c),a
 6683 A1AC C9           		ret
 6684 A1AD
 6685 A1AD 21 26 A2     checklp:	ld	hl,music_setup
 6686 A1B0 CB 4E        		bit	1,(hl)
 6687 A1B2 20 19        		jr	nz,enablefade
 6688 A1B4 CB 46        		bit	0,(hl)
 6689 A1B6 C8           		ret	z
 6690 A1B7
 6691 A1B7 CB FE        noloop:		set	7,(hl)
 6692 A1B9 E1           deadend:	pop	hl
 6693 A1BA 21 06 A3     		ld	hl,DelyCnt
 6694 A1BD 34           		inc	(hl)
 6695 A1BE 21 CA A2     		ld	hl,ChanA+CHP.NtSkCn
 6696 A1C1 34           		inc	(hl)
 6697 A1C2
 6698 A1C2 AF           music_mute:	xor	a
 6699 A1C3 67           		ld	h,a
 6700 A1C4 6F           		ld	l,a
 6701 A1C5 32 14 A3     		ld	(AYREGS+AR_AmplA),a
 6702 A1C8 22 15 A3     		ld	(AYREGS+AR_AmplB),hl
 6703 A1CB 18 C3        		jr	rout_a0
 6704 A1CD
 6705 A1CD 3E 30        enablefade:	ld	a,48
 6706 A1CF 21 E4 A1     forcefade:	ld	hl,chkfadeout+1
 6707 A1D2 34           		inc	(hl)
 6708 A1D3 2A C0 A0     		ld	hl,(CrPsPtr+1)
 6709 A1D6 22 12 A2     		ld	(resetfadeout+1),hl
 6710 A1D9 ED 43 18 A2  		ld	(resetfadeout1+1),bc
 6711 A1DD 32 EE A1     		ld	(countfadeout+1),a
 6712 A1E0 32 00 A2     		ld	(divfadeout+1),a
 6713 A1E3
 6714 A1E3 3E 00        chkfadeout:	ld	a,0
 6715 A1E5 B7           		or	a
 6716 A1E6 C8           		ret	z
 6717 A1E7 3A 26 A2     		ld	a,(music_setup)
 6718 A1EA 07           		rlca
 6719 A1EB 38 CC        		jr	c,deadend
 6720 A1ED 3E 3E        countfadeout:	ld	a,#3E
 6721 A1EF 3D           		dec	a
 6722 A1F0 32 EE A1     		ld	(countfadeout+1),a
 6723 A1F3 C0           		ret	nz
 6724 A1F4 3A 2F A0     		ld	a,(GlobalAttn+1)
 6725 A1F7 3C           		inc	a
 6726 A1F8 FE 10        		cp	16
 6727 A1FA 28 15        		jr	z,resetfadeout
 6728 A1FC 32 2F A0     		ld	(GlobalAttn+1),a
 6729 A1FF 3E 3E        divfadeout:	ld	a,#3E
 6730 A201 CB 3F        		srl	a
 6731 A203 6F           		ld	l,a
 6732 A204 CB 3D        		srl	l
 6733 A206 85           		add	a,l
 6734 A207 20 01        		jr	nz,divfadeout1
 6735 A209 3C           		inc	a
 6736 A20A 32 EE A1     divfadeout1:	ld	(countfadeout+1),a
 6737 A20D 32 00 A2     		ld	(divfadeout+1),a
 6738 A210 C9           		ret
 6739 A211
 6740 A211 21 21 21     resetfadeout:	ld	hl,#2121
 6741 A214 22 C0 A0     		ld	(CrPsPtr+1),hl
 6742 A217 21 21 21     resetfadeout1:	ld	hl,#2121
 6743 A21A 22 B5 A0     		ld	(AdInPtA+1),hl
 6744 A21D AF           		xor	a
 6745 A21E 32 CA A2     		ld	(ChanA+CHP.NtSkCn),a
 6746 A221 21 26 A2     		ld	hl,music_setup
 6747 A224 18 91        		jr	noloop
 6748 A226
 6749 A226
 6750 A226              ; bit.0 if you want to play without looping
 6751 A226              ; bit.1 if you play looped but fadeout after few seconds
 6752 A226              ; bit.7 is set each time when loop is passed
 6753 A226              ; ...or simplified:	2 - fadeout after loop
 6754 A226              ;			1 - no loop
 6755 A226              ;			0 - loop forever
 6756 A226 02           music_setup:	db	2
 6757 A227
 6758 A227
 6759 A227              ;------------------------------------------------------------------------------
 6760 A227              ; note table data
 6761 A227 64           nt_data:	db	(T_NEW_0-T1_)*2
 6762 A228 2A           		db	TCNEW_0-T_
 6763 A229 65           		db	(T_OLD_0-T1_)*2+1
 6764 A22A 00           		db	TCOLD_0-T_
 6765 A22B 01           		db	(T_NEW_1-T1_)*2+1
 6766 A22C 0C           		db	TCNEW_1-T_
 6767 A22D 01           		db	(T_OLD_1-T1_)*2+1
 6768 A22E 0C           		db	TCOLD_1-T_
 6769 A22F 94           		db	(T_NEW_2-T1_)*2
 6770 A230 35           		db	TCNEW_2-T_
 6771 A231 30           		db	(T_OLD_2-T1_)*2
 6772 A232 0E           		db	TCOLD_2-T_
 6773 A233 60           		db	(T_NEW_3-T1_)*2
 6774 A234 20           		db	TCNEW_3-T_
 6775 A235 60           		db	(T_OLD_3-T1_)*2
 6776 A236 21           		db	TCOLD_3-T_
 6777 A237              T_
 6778 A237
 6779 A237 01 05 09 0B  TCOLD_0		db	#00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
 6779 A23B 0D 0F 13 15
 6780 A23F 19 25 3D 00  		db	#18+1,#24+1,#3C+1,0
 6781 A243 5D 00        TCOLD_1		db	#5C+1,0
 6782 A245 31 37 4D 53  TCOLD_2		db	#30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
 6782 A249 5F 71 82 8C
 6782 A24D 9C
 6783 A24E 9E A0 A6 A8  		db	#9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
 6783 A252 AA AC AE AE
 6783 A256 00
 6784 A257 57           TCNEW_3		db	#56+1
 6785 A258 1F 23 25 29  TCOLD_3		db	#1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
 6785 A25C 2D 2F 33 BF
 6785 A260 00
 6786 A261 1D 21 23 27  TCNEW_0		db	#1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
 6786 A265 2B 2D 31 55
 6787 A269 BD BF 00     		db	#BC+1,#BE+1,0
 6788 A26C              TCNEW_1		equ	TCOLD_1
 6789 A26C 1B 21 25 29  TCNEW_2		db	#1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
 6789 A270 2B 3B 4D 5F
 6790 A274 BB BD BF 00  		db	#BA+1,#BC+1,#BE+1,0
 6791 A278
 6792 A278              PT3_EmptySmpOrn	equ	$-1
 6793 A278 01 00        		db	1,0 ;#90 ; delete #90 if you don't need default sample
 6794 A27A
 6795 A27A              PT2_EmptySmpOrn	equ	VT_+31 ; 1,0,0 sequence
 6796 A27A
 6797 A27A              ; first 12 values of tone tables (packed)
 6798 A27A 0D D8        T_PACK		db	high (#06EC*2), low (#06EC*2)
 6799 A27C 69           		db	#0755-#06EC
 6800 A27D 70           		db	#07C5-#0755
 6801 A27E 76           		db	#083B-#07C5
 6802 A27F 7D           		db	#08B8-#083B
 6803 A280 85           		db	#093D-#08B8
 6804 A281 8D           		db	#09CA-#093D
 6805 A282 95           		db	#0A5F-#09CA
 6806 A283 9D           		db	#0AFC-#0A5F
 6807 A284 A8           		db	#0BA4-#0AFC
 6808 A285 B1           		db	#0C55-#0BA4
 6809 A286 BB           		db	#0D10-#0C55
 6810 A287 0C DA        		db	high (#066D*2), low (#066D*2)
 6811 A289 62           		db	#06CF-#066D
 6812 A28A 68           		db	#0737-#06CF
 6813 A28B 6D           		db	#07A4-#0737
 6814 A28C 75           		db	#0819-#07A4
 6815 A28D 7B           		db	#0894-#0819
 6816 A28E 83           		db	#0917-#0894
 6817 A28F 8A           		db	#09A1-#0917
 6818 A290 92           		db	#0A33-#09A1
 6819 A291 9C           		db	#0ACF-#0A33
 6820 A292 A4           		db	#0B73-#0ACF
 6821 A293 AF           		db	#0C22-#0B73
 6822 A294 B8           		db	#0CDA-#0C22
 6823 A295 0E 08        		db	high (#0704*2), low (#0704*2)
 6824 A297 6A           		db	#076E-#0704
 6825 A298 72           		db	#07E0-#076E
 6826 A299 78           		db	#0858-#07E0
 6827 A29A 7E           		db	#08D6-#0858
 6828 A29B 86           		db	#095C-#08D6
 6829 A29C 90           		db	#09EC-#095C
 6830 A29D 96           		db	#0A82-#09EC
 6831 A29E A0           		db	#0B22-#0A82
 6832 A29F AA           		db	#0BCC-#0B22
 6833 A2A0 B4           		db	#0C80-#0BCC
 6834 A2A1 BE           		db	#0D3E-#0C80
 6835 A2A2 0F C0        		db	high (#07E0*2), low (#07E0*2)
 6836 A2A4 78           		db	#0858-#07E0
 6837 A2A5 88           		db	#08E0-#0858
 6838 A2A6 80           		db	#0960-#08E0
 6839 A2A7 90           		db	#09F0-#0960
 6840 A2A8 98           		db	#0A88-#09F0
 6841 A2A9 A0           		db	#0B28-#0A88
 6842 A2AA B0           		db	#0BD8-#0B28
 6843 A2AB A8           		db	#0C80-#0BD8
 6844 A2AC E0           		db	#0D60-#0C80
 6845 A2AD B0           		db	#0E10-#0D60
 6846 A2AE E8           		db	#0EF8-#0E10
 6847 A2AF
 6848 A2AF              ; channel data offsets
 6849 A2AF              	struct CHP
 6850 A2AF ~            PsInOr		byte
 6851 A2AF ~            PsInSm		byte
 6852 A2AF ~            CrAmSl		byte
 6853 A2AF ~            CrNsSl		byte
 6854 A2AF ~            CrEnSl		byte
 6855 A2AF ~            TSlCnt		byte
 6856 A2AF ~            CrTnSl		word
 6857 A2AF ~            TnAcc		word
 6858 A2AF ~            COnOff		byte
 6859 A2AF ~            OnOffD		byte
 6860 A2AF ~            OffOnD		byte	; IX for PTDECOD here (+12)
 6861 A2AF ~            OrnPtr		word
 6862 A2AF ~            SamPtr		word
 6863 A2AF ~            NNtSkp		byte
 6864 A2AF ~            Note		byte
 6865 A2AF ~            SlToNt		byte
 6866 A2AF ~            Env_En		byte
 6867 A2AF ~            Flags		byte
 6868 A2AF ~            TnSlDl		byte	; Enabled - 0, SimpleGliss - 2
 6869 A2AF ~            TSlStp		word
 6870 A2AF ~            TnDelt		word
 6871 A2AF ~            NtSkCn		byte
 6872 A2AF ~            Volume		byte
 6873 A2AF              	ends
 6874 A2AF
 6875 A2AF              AR_TonA		equ	0	; word 1
 6876 A2AF              AR_TonB		equ	2	; word 1
 6877 A2AF              AR_TonC		equ	4	; word 1
 6878 A2AF              AR_Noise	equ	6	; byte 1
 6879 A2AF              AR_Mixer	equ	7	; byte 1
 6880 A2AF              AR_AmplA	equ	8	; byte 1
 6881 A2AF              AR_AmplB	equ	9	; byte 1
 6882 A2AF              AR_AmplC	equ	10	; byte 1
 6883 A2AF              AR_Env		equ	11	; word 1
 6884 A2AF              AR_EnvTp	equ	13	; byte 1
 6885 A2AF              AR_Size		equ	14
 6886 A2AF
 6887 A2AF
 6888 A2AF              ;------------------------------------------------------------------------------
 6889 A2AF              ; variables are 541 bytes long
 6890 A2AF              VARS
 6891 A2AF 00 00 00...  ChanA		ds	29
 6892 A2CC 00 00 00...  ChanB		ds	29
 6893 A2E9 00 00 00...  ChanC		ds	29
 6894 A306
 6895 A306
 6896 A306              ; GlobalVars
 6897 A306 00           DelyCnt		db	0
 6898 A307 00 00        CurESld		dw	0
 6899 A309 00           CurEDel		db	0
 6900 A30A 00           Ns_base		db	0
 6901 A30B 00           AddToNs		db	0
 6902 A30C
 6903 A30C              AYREGS		equ	$
 6904 A30C              Ampl		equ	AYREGS+AR_AmplC
 6905 A30C
 6906 A30C 00 00 00...  VT_		ds	256		; Volume Table
 6907 A40C 00 00 00...  NT_		ds	192		; Note Table
 6908 A4CC
 6909 A4CC              EnvBase		equ	VT_+14
 6910 A4CC              T1_		equ	VT_+16		; Tone tables data depacked here
 6911 A4CC              T_OLD_1		equ	T1_
 6912 A4CC              T_OLD_2		equ	T_OLD_1+24
 6913 A4CC              T_OLD_3		equ	T_OLD_2+24
 6914 A4CC              T_OLD_0		equ	T_OLD_3+2
 6915 A4CC              T_NEW_0		equ	T_OLD_0
 6916 A4CC              T_NEW_1		equ	T_OLD_1
 6917 A4CC              T_NEW_2		equ	T_NEW_0+24
 6918 A4CC              T_NEW_3		equ	T_OLD_3
 6919 A4CC
 6920 A4CC              VAR0END		equ	T1_		; init zeroes from VARS to VAR0END-1
 6921 A4CC              VARSEND		equ	$
 6922 A4CC
 6923 A4CC
 6924 A4CC
 6925 A4CC              		module stc
 6926 A4CC
 6927 A4CC 21 0E BD     music_init:	ld	hl,songdata
 6928 A4CF 7E           music_init0:	ld	a,(hl)
 6929 A4D0 32 62 A8     		ld	(speed),a
 6930 A4D3 22 47 A5     		ld	(module_addr+1),hl
 6931 A4D6 23           		inc	hl
 6932 A4D7 CD 41 A5     		call	add_offset
 6933 A4DA 1A           		ld	a,(de)
 6934 A4DB 13           		inc	de
 6935 A4DC 3C           		inc	a
 6936 A4DD 32 64 A8     		ld	(song_length),a
 6937 A4E0 ED 53 5A A8  		ld	(positions),de
 6938 A4E4 CD 41 A5     		call	add_offset
 6939 A4E7 ED 53 5C A8  		ld	(ornaments),de
 6940 A4EB D5           		push	de
 6941 A4EC CD 41 A5     		call	add_offset
 6942 A4EF ED 53 5E A8  		ld	(patterns),de
 6943 A4F3 21 1B 00     		ld	hl,HEADLEN
 6944 A4F6 CD 46 A5     		call	module_addr
 6945 A4F9 EB           		ex	de,hl
 6946 A4FA 22 60 A8     		ld	(samples),hl
 6947 A4FD 21 6B A8     		ld	hl,empty_pattern
 6948 A500 22 65 A8     		ld	(chn1_pattptr),hl
 6949 A503 23           		inc	hl
 6950 A504 11 6D A8     		ld	de,CHN1+1
 6951 A507 01 1F 00     		ld	bc,VARSLEN
 6952 A50A 70           		ld	(hl),b
 6953 A50B ED B0        		ldir
 6954 A50D E1           		pop	hl
 6955 A50E 01 21 00     		ld	bc,ORNALEN
 6956 A511 AF           		xor	a
 6957 A512 CD 3C A5     		call	scan_until
 6958 A515 32 B6 A7     		ld	(apply_volenv+1),a
 6959 A518 32 2D A8     		ld	(chkfadeout+1),a
 6960 A51B 3D           		dec	a
 6961 A51C 32 75 A8     		ld	(CHN1+CHP.SmpCnt),a
 6962 A51F 32 7F A8     		ld	(CHN2+CHP.SmpCnt),a
 6963 A522 32 89 A8     		ld	(CHN3+CHP.SmpCnt),a
 6964 A525 3E 01        		ld	a,1
 6965 A527 32 63 A8     		ld	(tempo_cnt),a
 6966 A52A 23           		inc	hl
 6967 A52B 22 73 A8     		ld	(CHN1+CHP.OrnPtr),hl
 6968 A52E 22 7D A8     		ld	(CHN2+CHP.OrnPtr),hl
 6969 A531 22 87 A8     		ld	(CHN3+CHP.OrnPtr),hl
 6970 A534 21 26 A2     		ld	hl,music_setup
 6971 A537 CB BE        		res	7,(hl)
 6972 A539 C3 97 A6     		jp	music_mute
 6973 A53C
 6974 A53C BE           scan_until:	cp	(hl)
 6975 A53D C8           		ret	z
 6976 A53E 09           		add	hl,bc
 6977 A53F 18 FB        		jr	scan_until
 6978 A541
 6979 A541 5E           add_offset:	ld	e,(hl)
 6980 A542 23           		inc	hl
 6981 A543 56           		ld	d,(hl)
 6982 A544 23           		inc	hl
 6983 A545 EB           		ex	de,hl
 6984 A546 01 00 00     module_addr:	ld	bc,0
 6985 A549 09           		add	hl,bc
 6986 A54A EB           		ex	de,hl
 6987 A54B C9           		ret
 6988 A54C
 6989 A54C 3A 8A A8     new_position:	ld	a,(current_pos)
 6990 A54F 4F           		ld	c,a
 6991 A550 21 64 A8     		ld	hl,song_length
 6992 A553 BE           		cp	(hl)
 6993 A554 38 0F        		jr	c,.continue
 6994 A556 21 26 A2     		ld	hl,music_setup
 6995 A559 CB 4E        		bit	1,(hl)
 6996 A55B C4 21 A8     		call	nz,enablefade
 6997 A55E CB 46        		bit	0,(hl)
 6998 A560 C2 09 A8     		jp	nz,noloop
 6999 A563 AF           		xor	a
 7000 A564 4F           		ld	c,a
 7001 A565 3C           .continue:	inc	a
 7002 A566 32 8A A8     		ld	(current_pos),a
 7003 A569 69           		ld	l,c
 7004 A56A 26 00        		ld	h,0
 7005 A56C 29           		add	hl,hl
 7006 A56D ED 5B 5A A8  		ld	de,(positions)
 7007 A571 19           		add	hl,de
 7008 A572 4E           		ld	c,(hl)
 7009 A573 23           		inc	hl
 7010 A574 7E           		ld	a,(hl)
 7011 A575 32 EB A7     		ld	(get_frequency+1),a
 7012 A578 79           		ld	a,c
 7013 A579 2A 5E A8     		ld	hl,(patterns)
 7014 A57C 01 07 00     		ld	bc,PATTLEN
 7015 A57F CD 3C A5     		call	scan_until
 7016 A582 23           		inc	hl
 7017 A583 CD 41 A5     		call	add_offset
 7018 A586 ED 53 65 A8  		ld	(chn1_pattptr),de
 7019 A58A CD 41 A5     		call	add_offset
 7020 A58D ED 53 67 A8  		ld	(chn2_pattptr),de
 7021 A591 CD 41 A5     		call	add_offset
 7022 A594 ED 53 69 A8  		ld	(chn3_pattptr),de
 7023 A598 C9           		ret
 7024 A599
 7025 A599 DD 35 04     adv_patt_step:	dec	(ix+CHP.PatStpCnt)
 7026 A59C F0           		ret	p
 7027 A59D DD 7E 01     		ld	a,(ix+CHP.PatStep)
 7028 A5A0 DD 77 04     		ld	(ix+CHP.PatStpCnt),a
 7029 A5A3 C9           		ret
 7030 A5A4
 7031 A5A4              ;------------------------------------------------------------------------------
 7032 A5A4 3A 63 A8     music_play:	ld	a,(tempo_cnt)
 7033 A5A7 3D           		dec	a
 7034 A5A8 32 63 A8     		ld	(tempo_cnt),a
 7035 A5AB 20 47        		jr	nz,playback
 7036 A5AD 3A 62 A8     		ld	a,(speed)
 7037 A5B0 32 63 A8     		ld	(tempo_cnt),a
 7038 A5B3
 7039 A5B3 DD 21 6C A8  .chn1:		ld	ix,CHN1
 7040 A5B7 CD 99 A5     		call	adv_patt_step
 7041 A5BA F2 CE A5     		jp	p,.chn2
 7042 A5BD 2A 65 A8     		ld	hl,(chn1_pattptr)
 7043 A5C0 7E           		ld	a,(hl)
 7044 A5C1 3C           		inc	a
 7045 A5C2 CC 4C A5     		call	z,new_position
 7046 A5C5 2A 65 A8     		ld	hl,(chn1_pattptr)
 7047 A5C8 CD D9 A6     		call	read_pattern
 7048 A5CB 22 65 A8     		ld	(chn1_pattptr),hl
 7049 A5CE
 7050 A5CE DD 21 76 A8  .chn2:		ld	ix,CHN2
 7051 A5D2 CD 99 A5     		call	adv_patt_step
 7052 A5D5 F2 E1 A5     		jp	p,.chn3
 7053 A5D8 2A 67 A8     		ld	hl,(chn2_pattptr)
 7054 A5DB CD D9 A6     		call	read_pattern
 7055 A5DE 22 67 A8     		ld	(chn2_pattptr),hl
 7056 A5E1
 7057 A5E1 DD 21 80 A8  .chn3:		ld	ix,CHN3
 7058 A5E5 CD 99 A5     		call	adv_patt_step
 7059 A5E8 F2 F4 A5     		jp	p,playback
 7060 A5EB 2A 69 A8     		ld	hl,(chn3_pattptr)
 7061 A5EE CD D9 A6     		call	read_pattern
 7062 A5F1 22 69 A8     		ld	(chn3_pattptr),hl
 7063 A5F4
 7064 A5F4              ;------------------------------------------------------------------------------
 7065 A5F4 CD 2C A8     playback:	call	chkfadeout
 7066 A5F7 DD 21 6C A8  		ld	ix,CHN1
 7067 A5FB CD 40 A7     		call	adv_sample
 7068 A5FE 79           		ld	a,c
 7069 A5FF 32 E3 A7     		ld	(sample_index+1),a
 7070 A602 CD 74 A7     		call	read_sample
 7071 A605 79           		ld	a,c
 7072 A606 B0           		or	b
 7073 A607 0F           		rrca
 7074 A608 32 92 A8     		ld	(AYREGS+AR.Mixer),a
 7075 A60B DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7076 A60E 3C           		inc	a
 7077 A60F 28 09        		jr	z,.chn2
 7078 A611 CD AD A7     		call	set_noise
 7079 A614 CD D9 A7     		call	get_tone
 7080 A617 22 8B A8     		ld	(AYREGS+AR.TonA),hl
 7081 A61A
 7082 A61A 21 93 A8     .chn2:		ld	hl,AYREGS+AR.AmplA
 7083 A61D CD B5 A7     		call	apply_volenv
 7084 A620 DD 21 76 A8  		ld	ix,CHN2
 7085 A624 CD 40 A7     		call	adv_sample
 7086 A627 DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7087 A62A 3C           		inc	a
 7088 A62B 28 18        		jr	z,.chn3
 7089 A62D 79           		ld	a,c
 7090 A62E 32 E3 A7     		ld	(sample_index+1),a
 7091 A631 CD 74 A7     		call	read_sample
 7092 A634 3A 92 A8     		ld	a,(AYREGS+AR.Mixer)
 7093 A637 B1           		or	c
 7094 A638 B0           		or	b
 7095 A639 32 92 A8     		ld	(AYREGS+AR.Mixer),a
 7096 A63C CD AD A7     		call	set_noise
 7097 A63F CD D9 A7     		call	get_tone
 7098 A642 22 8D A8     		ld	(AYREGS+AR.TonB),hl
 7099 A645
 7100 A645 21 94 A8     .chn3:		ld	hl,AYREGS+AR.AmplB
 7101 A648 CD B5 A7     		call	apply_volenv
 7102 A64B DD 21 80 A8  		ld	ix,CHN3
 7103 A64F CD 40 A7     		call	adv_sample
 7104 A652 DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7105 A655 3C           		inc	a
 7106 A656 28 1C        		jr	z,.finish
 7107 A658 79           		ld	a,c
 7108 A659 32 E3 A7     		ld	(sample_index+1),a
 7109 A65C CD 74 A7     		call	read_sample
 7110 A65F 3A 92 A8     		ld	a,(AYREGS+AR.Mixer)
 7111 A662 CB 01        		rlc	c
 7112 A664 CB 00        		rlc	b
 7113 A666 B0           		or	b
 7114 A667 B1           		or	c
 7115 A668 32 92 A8     		ld	(AYREGS+AR.Mixer),a
 7116 A66B CD AD A7     		call	set_noise
 7117 A66E CD D9 A7     		call	get_tone
 7118 A671 22 8F A8     		ld	(AYREGS+AR.TonC),hl
 7119 A674
 7120 A674 21 95 A8     .finish:	ld	hl,AYREGS+AR.AmplC
 7121 A677 CD B5 A7     		call	apply_volenv
 7122 A67A
 7123 A67A 21 98 A8     outay:		ld	hl,AYREGS+AR.EnvSh
 7124 A67D AF           		xor	a
 7125 A67E B6           		or	(hl)
 7126 A67F 3E 0D        		ld	a,AR.EnvSh
 7127 A681 20 05        		jr	nz,.fillregs
 7128 A683 D6 03        		sub	3
 7129 A685 2B           		dec	hl
 7130 A686 2B           		dec	hl
 7131 A687 2B           		dec	hl
 7132 A688 01 FD FF     .fillregs:	ld	bc,#FFFD
 7133 A68B ED 79        .loop:		out	(c),a
 7134 A68D CB B0        		res	6,b
 7135 A68F ED AB        		outd
 7136 A691 CB F0        		set	6,b
 7137 A693 3D           		dec	a
 7138 A694 F8           		ret	m
 7139 A695 18 F4        		jr	.loop
 7140 A697
 7141 A697 21 8B A8     music_mute:	ld	hl,AYREGS
 7142 A69A 11 8C A8     		ld	de,AYREGS+1
 7143 A69D 01 07 00     		ld	bc,AR.Mixer
 7144 A6A0 70           		ld	(hl),b
 7145 A6A1 ED B0        		ldir
 7146 A6A3 35           		dec	(hl)
 7147 A6A4 2E 8B        		ld	l,low AYREGS
 7148 A6A6 0E 05        		ld	c,AR.EnvSh-AR.Mixer-1
 7149 A6A8 ED B0        		ldir
 7150 A6AA EB           		ex	hl,de
 7151 A6AB 3E 0D        		ld	a,AR.EnvSh
 7152 A6AD 18 D9        		jr	outay.fillregs
 7153 A6AF
 7154 A6AF DD 77 03     c_note:		ld	(ix+CHP.Note),a
 7155 A6B2 DD 36 02 00  		ld	(ix+CHP.SmpIndex),0
 7156 A6B6 DD 36 09 20  		ld	(ix+CHP.SmpCnt),#20
 7157 A6BA 23           c_empty:	inc	hl
 7158 A6BB C9           		ret
 7159 A6BC
 7160 A6BC D6 60        c_sample:	sub	#60
 7161 A6BE E5           		push	hl
 7162 A6BF 01 63 00     		ld	bc,SAMPLEN
 7163 A6C2 2A 60 A8     		ld	hl,(samples)
 7164 A6C5 CD 3C A5     		call	scan_until
 7165 A6C8 23           		inc	hl
 7166 A6C9 DD 75 05     		ld	(ix+CHP.SmpPtr),l
 7167 A6CC DD 74 06     		ld	(ix+CHP.SmpPtr+1),h
 7168 A6CF E1           		pop	hl
 7169 A6D0 23           		inc	hl
 7170 A6D1 18 06        		jr	read_pattern
 7171 A6D3
 7172 A6D3 23           c_rest:		inc	hl
 7173 A6D4 DD 36 09 FF  c_norept:	ld	(ix+CHP.SmpCnt),-1
 7174 A6D8 C9           		ret
 7175 A6D9
 7176 A6D9 7E           read_pattern:	ld	a,(hl)
 7177 A6DA FE 60        		cp	#60		; note
 7178 A6DC 38 D1        		jr	c,c_note
 7179 A6DE FE 70        		cp	#70		; sample
 7180 A6E0 38 DA        		jr	c,c_sample
 7181 A6E2 FE 80        		cp	#80		; ornament
 7182 A6E4 38 1B        		jr	c,c_ornament
 7183 A6E6 28 EB        		jr	z,c_rest	; rest
 7184 A6E8 FE 81        		cp	#81		; empty
 7185 A6EA 28 CE        		jr	z,c_empty
 7186 A6EC FE 82        		cp	#82		; ornament off
 7187 A6EE 28 0F        		jr	z,c_ornoff
 7188 A6F0 FE 8F        		cp	#8F		; envelope
 7189 A6F2 38 28        		jr	c,c_envelope
 7190 A6F4 D6 A1        		sub	#A1		; speed
 7191 A6F6 DD 77 04     		ld	(ix+CHP.PatStpCnt),a
 7192 A6F9 DD 77 01     		ld	(ix+CHP.PatStep),a
 7193 A6FC 23           		inc	hl
 7194 A6FD 18 DA        		jr	read_pattern
 7195 A6FF
 7196 A6FF AF           c_ornoff:	xor	a
 7197 A700 01           		db	1 ; ld bc,* (skip next instruction)
 7198 A701 D6 70        c_ornament:	sub	#70
 7199 A703 E5           c_ornament0:	push	hl
 7200 A704 01 21 00     		ld	bc,ORNALEN
 7201 A707 2A 5C A8     		ld	hl,(ornaments)
 7202 A70A CD 3C A5     		call	scan_until
 7203 A70D 23           		inc	hl
 7204 A70E DD 75 07     		ld	(ix+CHP.OrnPtr),l
 7205 A711 DD 74 08     		ld	(ix+CHP.OrnPtr+1),h
 7206 A714 DD 36 00 00  		ld	(ix+CHP.EnvState),0
 7207 A718 E1           		pop	hl
 7208 A719 23           		inc	hl
 7209 A71A 18 BD        		jr	read_pattern
 7210 A71C
 7211 A71C D6 80        c_envelope:	sub	#80
 7212 A71E 32 98 A8     		ld	(AYREGS+AR.EnvSh),a
 7213 A721 23           		inc	hl
 7214 A722 7E           		ld	a,(hl)
 7215 A723 23           		inc	hl
 7216 A724 32 96 A8     		ld	(AYREGS+AR.Env),a
 7217 A727 DD 36 00 01  		ld	(ix+CHP.EnvState),1
 7218 A72B E5           		push	hl
 7219 A72C AF           		xor	a
 7220 A72D 01 21 00     		ld	bc,ORNALEN
 7221 A730 2A 5C A8     		ld	hl,(ornaments)
 7222 A733 CD 3C A5     		call	scan_until
 7223 A736 23           		inc	hl
 7224 A737 DD 75 07     		ld	(ix+CHP.OrnPtr),l
 7225 A73A DD 74 08     		ld	(ix+CHP.OrnPtr+1),h
 7226 A73D E1           		pop	hl
 7227 A73E 18 99        		jr	read_pattern
 7228 A740
 7229 A740 DD 7E 09     adv_sample:	ld	a,(ix+CHP.SmpCnt)
 7230 A743 3C           		inc	a
 7231 A744 C8           		ret	z
 7232 A745 3D           		dec	a
 7233 A746 3D           		dec	a
 7234 A747 DD 77 09     		ld	(ix+CHP.SmpCnt),a
 7235 A74A F5           		push	af
 7236 A74B DD 7E 02     		ld	a,(ix+CHP.SmpIndex)
 7237 A74E 4F           		ld	c,a
 7238 A74F 3C           		inc	a
 7239 A750 E6 1F        		and	#1F
 7240 A752 DD 77 02     		ld	(ix+CHP.SmpIndex),a
 7241 A755 F1           		pop	af
 7242 A756 C0           		ret	nz
 7243 A757 DD 5E 05     		ld	e,(ix+CHP.SmpPtr)
 7244 A75A DD 56 06     		ld	d,(ix+CHP.SmpPtr+1)
 7245 A75D 21 60 00     		ld	hl,#60	; offset to sample metadata
 7246 A760 19           		add	hl,de
 7247 A761 7E           		ld	a,(hl)
 7248 A762 3D           		dec	a
 7249 A763 FA D4 A6     		jp	m,c_norept
 7250 A766 4F           		ld	c,a	; repeat sample
 7251 A767 3C           		inc	a
 7252 A768 E6 1F        		and	#1F
 7253 A76A DD 77 02     		ld	(ix+CHP.SmpIndex),a
 7254 A76D 23           		inc	hl
 7255 A76E 7E           		ld	a,(hl)
 7256 A76F 3C           		inc	a
 7257 A770 DD 77 09     		ld	(ix+CHP.SmpCnt),a
 7258 A773 C9           		ret
 7259 A774
 7260 A774 16 00        read_sample:	ld	d,0
 7261 A776 5F           		ld	e,a
 7262 A777 87           		add	a,a
 7263 A778 83           		add	a,e
 7264 A779 5F           		ld	e,a
 7265 A77A DD 6E 05     		ld	l,(ix+CHP.SmpPtr)
 7266 A77D DD 66 06     		ld	h,(ix+CHP.SmpPtr+1)
 7267 A780 19           		add	hl,de
 7268 A781 23           		inc	hl
 7269 A782 7E           		ld	a,(hl)
 7270 A783 CB 7F        		bit	7,a
 7271 A785 0E 10        		ld	c,#10
 7272 A787 20 01        		jr	nz,.no_noise
 7273 A789 4A           		ld	c,d
 7274 A78A CB 77        .no_noise:	bit	6,a
 7275 A78C 06 02        		ld	b,2
 7276 A78E 20 01        		jr	nz,.no_tone
 7277 A790 42           		ld	b,d
 7278 A791 23           .no_tone:	inc	hl
 7279 A792 5E           		ld	e,(hl)
 7280 A793 2B           		dec	hl
 7281 A794 2B           		dec	hl
 7282 A795 56           		ld	d,(hl)
 7283 A796 6F           		ld	l,a
 7284 A797 E6 1F        		and	#1F
 7285 A799 67           		ld	h,a
 7286 A79A 7A           		ld	a,d
 7287 A79B F5           		push	af
 7288 A79C E6 F0        		and	#F0
 7289 A79E 0F           		rrca
 7290 A79F 0F           		rrca
 7291 A7A0 0F           		rrca
 7292 A7A1 0F           		rrca
 7293 A7A2 57           		ld	d,a
 7294 A7A3 F1           		pop	af
 7295 A7A4 E6 0F        		and	#0F
 7296 A7A6 CB 6D        		bit	5,l
 7297 A7A8 6F           		ld	l,a
 7298 A7A9 C8           		ret	z
 7299 A7AA CB E2        		set	4,d
 7300 A7AC C9           		ret
 7301 A7AD
 7302 A7AD 79           set_noise:	ld	a,c
 7303 A7AE B7           		or	a
 7304 A7AF C0           		ret	nz
 7305 A7B0 7C           		ld	a,h
 7306 A7B1 32 91 A8     		ld	(AYREGS+AR.Noise),a
 7307 A7B4 C9           		ret
 7308 A7B5
 7309 A7B5 1E 00        apply_volenv:	ld	e,0		; GLOBAL ATTENUATION
 7310 A7B7 93           		sub	e
 7311 A7B8 30 01        		jr	nc,.set
 7312 A7BA AF           		xor	a
 7313 A7BB 77           .set		ld	(hl),a		; if value of attenuation is higher
 7314 A7BC CB 5F        		bit	3,a		; then 8 we will stop also envelopes...
 7315 A7BE C8           		ret	z
 7316 A7BF
 7317 A7BF DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7318 A7C2 3C           		inc	a
 7319 A7C3 C8           		ret	z
 7320 A7C4 DD 7E 00     		ld	a,(ix+CHP.EnvState)
 7321 A7C7 B7           		or	a
 7322 A7C8 C8           		ret	z
 7323 A7C9 3D           		dec	a
 7324 A7CA 20 06        		jr	nz,.resetshape
 7325 A7CC DD 36 00 02  		ld	(ix+CHP.EnvState),2
 7326 A7D0 18 04        		jr	.setenv
 7327 A7D2
 7328 A7D2 AF           .resetshape:	xor	a
 7329 A7D3 32 98 A8     		ld	(AYREGS+AR.EnvSh),a
 7330 A7D6 CB E6        .setenv:	set	4,(hl)
 7331 A7D8 C9           		ret
 7332 A7D9
 7333 A7D9 7D           get_tone:	ld	a,l
 7334 A7DA F5           		push	af
 7335 A7DB D5           		push	de
 7336 A7DC DD 6E 07     		ld	l,(ix+CHP.OrnPtr)
 7337 A7DF DD 66 08     		ld	h,(ix+CHP.OrnPtr+1)
 7338 A7E2 11 00 00     sample_index:	ld	de,0
 7339 A7E5 19           		add	hl,de
 7340 A7E6 DD 7E 03     		ld	a,(ix+CHP.Note)
 7341 A7E9 86           		add	a,(hl)
 7342 A7EA
 7343 A7EA C6 00        get_frequency:	add	a,0
 7344 A7EC 87           		add	a,a
 7345 A7ED 5F           		ld	e,a
 7346 A7EE 16 00        		ld	d,0
 7347 A7F0 21 99 A8     		ld	hl,freqtable
 7348 A7F3 19           		add	hl,de
 7349 A7F4 5E           		ld	e,(hl)
 7350 A7F5 23           		inc	hl
 7351 A7F6 56           		ld	d,(hl)
 7352 A7F7 EB           		ex	de,hl
 7353 A7F8 D1           		pop	de
 7354 A7F9 F1           		pop	af
 7355 A7FA CB 62        		bit	4,d
 7356 A7FC 28 04        		jr	z,.negative
 7357 A7FE CB A2        		res	4,d
 7358 A800 19           		add	hl,de
 7359 A801 C9           		ret
 7360 A802
 7361 A802 A7           .negative:	and	a
 7362 A803 ED 52        		sbc	hl,de
 7363 A805 C9           		ret
 7364 A806
 7365 A806              ;------------------------------------------------------------------------------
 7366 A806 21 26 A2     resetfadeout:	ld	hl,music_setup
 7367 A809 CB FE        noloop:		set	7,(hl)
 7368 A80B CD 97 A6     		call	music_mute
 7369 A80E E1           deadend:	pop	hl
 7370 A80F AF           		xor	a
 7371 A810 32 63 A8     		ld	(tempo_cnt),a
 7372 A813 3D           		dec	a
 7373 A814 32 75 A8     		ld	(CHN1+CHP.SmpCnt),a
 7374 A817 32 7F A8     		ld	(CHN2+CHP.SmpCnt),a
 7375 A81A 32 89 A8     		ld	(CHN3+CHP.SmpCnt),a
 7376 A81D 32 2D A8     		ld	(chkfadeout+1),a
 7377 A820 C9           		ret
 7378 A821
 7379 A821 3E 30        enablefade:	ld	a,48
 7380 A823 32 2D A8     forcefade:	ld	(chkfadeout+1),a
 7381 A826 32 37 A8     		ld	(countfadeout+1),a
 7382 A829 32 49 A8     		ld	(divfadeout+1),a
 7383 A82C
 7384 A82C 3E 00        chkfadeout:	ld	a,0
 7385 A82E B7           		or	a
 7386 A82F C8           		ret	z
 7387 A830 3A 26 A2     		ld	a,(music_setup)
 7388 A833 07           		rlca
 7389 A834 38 D8        		jr	c,deadend
 7390 A836 3E 00        countfadeout:	ld	a,0
 7391 A838 3D           		dec	a
 7392 A839 32 37 A8     		ld	(countfadeout+1),a
 7393 A83C C0           		ret	nz
 7394 A83D 3A B6 A7     		ld	a,(apply_volenv+1)
 7395 A840 3C           		inc	a
 7396 A841 FE 10        		cp	16
 7397 A843 28 C1        		jr	z,resetfadeout
 7398 A845 32 B6 A7     		ld	(apply_volenv+1),a
 7399 A848 3E 00        divfadeout:	ld	a,0
 7400 A84A CB 3F        		srl	a
 7401 A84C 5F           		ld	e,a
 7402 A84D CB 3B        		srl	e
 7403 A84F 83           		add	a,e
 7404 A850 20 01        		jr	nz,divfadeout1
 7405 A852 3C           		inc	a
 7406 A853 32 37 A8     divfadeout1:	ld	(countfadeout+1),a
 7407 A856 32 49 A8     		ld	(divfadeout+1),a
 7408 A859 C9           		ret
 7409 A85A
 7410 A85A              ;------------------------------------------------------------------------------
 7411 A85A 00 00        positions:	dw	0
 7412 A85C 00 00        ornaments:	dw	0
 7413 A85E 00 00        patterns:	dw	0
 7414 A860 00 00        samples:	dw	0
 7415 A862 00           speed:		db	0
 7416 A863 00           tempo_cnt:	db	0
 7417 A864 00           song_length:	db	0
 7418 A865
 7419 A865 6B A8        chn1_pattptr:	dw	empty_pattern
 7420 A867 6B A8        chn2_pattptr:	dw	empty_pattern
 7421 A869 6B A8        chn3_pattptr:	dw	empty_pattern
 7422 A86B FF           empty_pattern:	db	#FF
 7423 A86C
 7424 A86C              VARS
 7425 A86C 00 00 00...  CHN1:		ds	10
 7426 A876 00 00 00...  CHN2:		ds	10
 7427 A880 00 00 00...  CHN3:		ds	10
 7428 A88A
 7429 A88A 00           current_pos:	db	0
 7430 A88B              @VARSLEN = $ - VARS
 7431 A88B
 7432 A88B 00 00 00...  AYREGS:		ds	14
 7433 A899
 7434 A899              ;------------------------------------------------------------------------------
 7435 A899 F8 0E 10 0E  freqtable:	dw	#0EF8, #0E10, #0D60, #0C80, #0BD8, #0B28, #0A88, #09F0
 7435 A89D 60 0D 80 0C
 7435 A8A1 D8 0B 28 0B
 7435 A8A5 88 0A F0 09
 7436 A8A9 60 09 E0 08  		dw	#0960, #08E0, #0858, #07E0, #077C, #0708, #06B0, #0640
 7436 A8AD 58 08 E0 07
 7436 A8B1 7C 07 08 07
 7436 A8B5 B0 06 40 06
 7437 A8B9 EC 05 94 05  		dw	#05EC, #0594, #0544, #04F8, #04B0, #0470, #042C, #03F0
 7437 A8BD 44 05 F8 04
 7437 A8C1 B0 04 70 04
 7437 A8C5 2C 04 F0 03
 7438 A8C9 BE 03 84 03  		dw	#03BE, #0384, #0358, #0320, #02F6, #02CA, #02A2, #027C
 7438 A8CD 58 03 20 03
 7438 A8D1 F6 02 CA 02
 7438 A8D5 A2 02 7C 02
 7439 A8D9 58 02 38 02  		dw	#0258, #0238, #0216, #01F8, #01DF, #01C2, #01AC, #0190
 7439 A8DD 16 02 F8 01
 7439 A8E1 DF 01 C2 01
 7439 A8E5 AC 01 90 01
 7440 A8E9 7B 01 65 01  		dw	#017B, #0165, #0151, #013E, #012C, #011C, #010B, #00FC
 7440 A8ED 51 01 3E 01
 7440 A8F1 2C 01 1C 01
 7440 A8F5 0B 01 FC 00
 7441 A8F9 EF 00 E1 00  		dw	#00EF, #00E1, #00D6, #00C8, #00BD, #00B2, #00A8, #009F
 7441 A8FD D6 00 C8 00
 7441 A901 BD 00 B2 00
 7441 A905 A8 00 9F 00
 7442 A909 96 00 8E 00  		dw	#0096, #008E, #0085, #007E, #0077, #0070, #006B, #0064
 7442 A90D 85 00 7E 00
 7442 A911 77 00 70 00
 7442 A915 6B 00 64 00
 7443 A919 5E 00 59 00  		dw	#005E, #0059, #0054, #004F, #004B, #0047, #0042, #003F
 7443 A91D 54 00 4F 00
 7443 A921 4B 00 47 00
 7443 A925 42 00 3F 00
 7444 A929 3B 00 38 00  		dw	#003B, #0038, #0035, #0032, #002F, #002C, #002A, #0027
 7444 A92D 35 00 32 00
 7444 A931 2F 00 2C 00
 7444 A935 2A 00 27 00
 7445 A939 25 00 23 00  		dw	#0025, #0023, #0021, #001F, #001D, #001C, #001A, #0019
 7445 A93D 21 00 1F 00
 7445 A941 1D 00 1C 00
 7445 A945 1A 00 19 00
 7446 A949 17 00 16 00  		dw	#0017, #0016, #0015, #0013, #0012, #0011, #0010, #000F
 7446 A94D 15 00 13 00
 7446 A951 12 00 11 00
 7446 A955 10 00 0F 00
 7447 A959
 7448 A959
 7449 A959              ;------------------------------------------------------------------------------
 7450 A959              	struct AR	; AY Registers structure
 7451 A959 ~            TonA		word	; 0
 7452 A959 ~            TonB		word	; 2
 7453 A959 ~            TonC		word	; 4
 7454 A959 ~            Noise		byte	; 6
 7455 A959 ~            Mixer		byte	; 7
 7456 A959 ~            AmplA		byte	; 8
 7457 A959 ~            AmplB		byte	; 9
 7458 A959 ~            AmplC		byte	; 10
 7459 A959 ~            Env		word	; 11
 7460 A959 ~            EnvSh		byte	; 13
 7461 A959              	ends
 7462 A959
 7463 A959              	struct CHP	; channel parameters structure
 7464 A959 ~            EnvState	byte
 7465 A959 ~            PatStep		byte
 7466 A959 ~            SmpIndex	byte
 7467 A959 ~            Note		byte
 7468 A959 ~            PatStpCnt	byte
 7469 A959 ~            SmpPtr		word
 7470 A959 ~            OrnPtr		word
 7471 A959 ~            SmpCnt		byte
 7472 A959              	ends
 7473 A959
 7474 A959              @HEADLEN = 27	; file header length
 7475 A959              @SAMPLEN = 99	; single sample length
 7476 A959              @ORNALEN = 33	; single ornament length
 7477 A959              @PATTLEN = 7	; single pattern record length
 7478 A959
 7479 A959
 7480 A959
 7481 A959              			endmodule
 7482 A959
 7483 A959
 7484 A959              ;***************************
 7485 A959              ;***************************
 7486 A959              ;***************************
 7487 A959              ;***************************
 7488 A959              ;***************************
 7489 A959              ;***************************
 7490 A959              ;***************************
 7491 A959              ;***************************
 7492 A959              ;***************************
 7493 A959              ;***************************
 7494 A959              ;***************************
 7495 A959              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
 7496 A959              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
 7497 A959              ;Specially for AlCo
 7498 A959              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
 7499 A959              	MODULE VTPL
 7500 A959              ;Release number
 7501 A959              Release EQU "0"
 7502 A959              ;Conditional assembly
 7503 A959              ;1) Current position counters at (Vars1+0) and (Vars2+0)
 7504 A959              CurPosCounter=0
 7505 A959              ;2) Allow channels allocation bits at (START+10)
 7506 A959              ACBBAC=0
 7507 A959              ;3) Allow loop checking and disabling
 7508 A959              LoopChecker=1
 7509 A959              ;4) Insert official identificator
 7510 A959              Id=0
 7511 A959              ;5) Set IY for correct return to ZX Basic
 7512 A959              Basic=1
 7513 A959
 7514 A959              ;Features
 7515 A959              ;--------
 7516 A959              ;-Can be compiled at any address (i.e. no need rounding ORG
 7517 A959              ; address).
 7518 A959              ;-Variables (VARS) can be located at any address (not only after
 7519 A959              ; code block).
 7520 A959              ;-INIT subprogram checks PT3-module version and rightly
 7521 A959              ; generates both note and volume tables outside of code block
 7522 A959              ; (in VARS).
 7523 A959              ;-Two portamento (spc. command 3xxx) algorithms (depending of
 7524 A959              ; PT3 module version).
 7525 A959              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
 7526 A959              ; and higher).
 7527 A959              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
 7528 A959              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
 7529 A959              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
 7530 A959              ;-See also notes at the end of this source code.
 7531 A959
 7532 A959              ;Limitations
 7533 A959              ;-----------
 7534 A959              ;-Can run in RAM only (self-modified code is used).
 7535 A959              ;-PT2 position list must be end by #FF marker only.
 7536 A959
 7537 A959              ;Warning!!! PLAY subprogram can crash if no module are loaded
 7538 A959              ;into RAM or INIT subprogram was not called before.
 7539 A959
 7540 A959              ;Call MUTE or INIT one more time to mute sound after stopping
 7541 A959              ;playing
 7542 A959
 7543 A959              ;Test codes (commented)
 7544 A959              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
 7545 A959              ;	LD (START+10),A
 7546 A959              ;	LD HL,#8000 ;Mod1
 7547 A959              ;	LD DE,#A000 ;Mod2 (optional)
 7548 A959              ;	CALL START+3
 7549 A959              ;	EI
 7550 A959              ;_LP	HALT
 7551 A959              ;	CALL START+5
 7552 A959              ;	XOR A
 7553 A959              ;	IN A,(#FE)
 7554 A959              ;	CPL
 7555 A959              ;	AND 15
 7556 A959              ;	JR Z,_LP
 7557 A959              ;	JR START+8
 7558 A959
 7559 A959              TonA	EQU 0
 7560 A959              TonB	EQU 2
 7561 A959              TonC	EQU 4
 7562 A959              Noise	EQU 6
 7563 A959              Mixer	EQU 7
 7564 A959              AmplA	EQU 8
 7565 A959              AmplB	EQU 9
 7566 A959              AmplC	EQU 10
 7567 A959              Env	EQU 11
 7568 A959              EnvTp	EQU 13
 7569 A959
 7570 A959              ;Entry and other points
 7571 A959              ;START initialize playing of modules at MDLADDR (single module)
 7572 A959              ;START+3 initialization with module address in HL and DE (TS)
 7573 A959              ;START+5 play one quark
 7574 A959              ;START+8 mute
 7575 A959              ;START+10 setup and status flags
 7576 A959
 7577 A959              START:
 7578 A959 21 0E BD     	LD HL,songdata ;DE - address of 2nd module for TS
 7579 A95C 18 3C        	JR INIT
 7580 A95E C3 BD B1     	JP PLAY
 7581 A961 18 25        	JR MUTE
 7582 A963 10           SETUP	DB %00010000 ;set bit0, if you want to play without looping
 7583 A964              	     ;(optional);
 7584 A964              	     ;set bit1 for PT2 and reset for PT3 before
 7585 A964              	     ;calling INIT;
 7586 A964              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
 7587 A964              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
 7588 A964              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
 7589 A964              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
 7590 A964              	     ;documented and must be converted to new standard.
 7591 A964              	     ;bit6 is set each time, when loop point of 2nd TS
 7592 A964              	     ;module is passed (optional).
 7593 A964              	     ;bit7 is set each time, when loop point of 1st TS
 7594 A964              	     ;or of single module is passed (optional).
 7595 A964
 7596 A964              ;Identifier
 7597 A964              	IF Id
 7598 A964 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 7599 A964              	ENDIF
 7600 A964
 7601 A964              	IF LoopChecker
 7602 A964 21 63 A9     CHECKLP	LD HL,SETUP
 7603 A967 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 7604 A96B 28 04        	JR Z,CHL1
 7605 A96D CB F6        	SET 6,(HL)
 7606 A96F 18 02        	JR CHL2
 7607 A971 CB FE        CHL1	SET 7,(HL)
 7608 A973 CB 46        CHL2	BIT 0,(HL)
 7609 A975 C8           	RET Z
 7610 A976 E1           	POP HL
 7611 A977 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 7612 A97A FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 7613 A97D AF           	XOR A
 7614 A97E FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 7615 A981 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 7616 A984 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 7617 A987 C9           	RET
 7618 A988              	ENDIF
 7619 A988
 7620 A988 AF           MUTE: XOR A
 7621 A989 67           	LD H,A
 7622 A98A 6F           	LD L,A
 7623 A98B 32 12 B3     	LD (VARS1+VRS.AYREGS+AmplA),A
 7624 A98E 22 13 B3     	LD (VARS1+VRS.AYREGS+AmplB),HL
 7625 A991 32 99 B3     	LD (VARS2+VRS.AYREGS+AmplA),A
 7626 A994 22 9A B3     	LD (VARS2+VRS.AYREGS+AmplB),HL
 7627 A997 C3 D5 B1     	JP ROUT
 7628 A99A
 7629 A99A              INIT:
 7630 A99A              ;HL - AddressOfModule
 7631 A99A              ;DE - AddresOf2ndModule
 7632 A99A D5           	PUSH DE
 7633 A99B E5           	PUSH HL
 7634 A99C 21 90 B2     	LD HL,VARS
 7635 A99F 36 00        	LD (HL),0
 7636 A9A1 11 91 B2     	LD DE,VARS+1
 7637 A9A4 01 0E 01     	LD BC,VAR0END-VARS-1
 7638 A9A7 ED B0        	LDIR
 7639 A9A9 23           	INC HL
 7640 A9AA 22 F3 B2     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 7641 A9AD 22 7A B3     	LD (VARS2+VRS.AdInPtA),HL
 7642 A9B0
 7643 A9B0 E1           	POP HL
 7644 A9B1 FD 21 F5 B2  	LD IY,VARS1+100
 7645 A9B5 3A 63 A9     	LD A,(START+10)
 7646 A9B8 E6 02        	AND 2
 7647 A9BA C2 43 AA     	JP NZ,I_PT2
 7648 A9BD
 7649 A9BD CD 90 AB     	CALL INITPT3
 7650 A9C0 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 7651 A9C3 22 63 AF     	LD (SamCnv),HL
 7652 A9C6 3E BA        	LD A,#BA
 7653 A9C8 32 2E AF     	LD (OrnCP),A
 7654 A9CB 32 5A AF     	LD (SamCP),A
 7655 A9CE 3E 7B        	LD A,#7B
 7656 A9D0 32 31 AF     	LD (OrnLD),A
 7657 A9D3 32 5D AF     	LD (SamLD),A
 7658 A9D6 3E 87        	LD A,#87
 7659 A9D8 32 54 AF     	LD (SamClc2),A
 7660 A9DB E1           	POP HL
 7661 A9DC              	;Use version and ton table of 1st module
 7662 A9DC DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 7663 A9DF D6 30        	SUB #30
 7664 A9E1 38 04        	JR C,L20
 7665 A9E3 FE 0A        	CP 10
 7666 A9E5 38 02        	JR C,L21
 7667 A9E7 3E 06        L20	LD A,6
 7668 A9E9 32 01 AE     L21	LD (Version),A
 7669 A9EC F5           	PUSH AF ;VolTable version
 7670 A9ED FE 04        	CP 4
 7671 A9EF DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 7672 A9F2 17           	RLA
 7673 A9F3 E6 07        	AND 7
 7674 A9F5 F5           	PUSH AF ;NoteTable number
 7675 A9F6
 7676 A9F6 FD 21 7C B3  	LD IY,VARS2+100
 7677 A9FA 3A 63 A9     	LD A,(START+10)
 7678 A9FD E6 30        	AND 48
 7679 A9FF 28 37        	JR Z,NOTS
 7680 AA01 FE 10        	CP 16
 7681 AA03 28 27        	JR Z,TwoPT3s
 7682 AA05 3A 01 AE     	LD A,(Version)
 7683 AA08 FE 07        	CP 7
 7684 AA0A 38 2C        	JR C,NOTS
 7685 AA0C DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 7686 AA0F FE 20        	CP #20
 7687 AA11 28 25        	JR Z,NOTS
 7688 AA13 21 91 B2     	LD HL,VARS1
 7689 AA16 11 18 B3     	LD DE,VARS2
 7690 AA19 01 87 00     	LD BC,VRS
 7691 AA1C ED B0        	LDIR
 7692 AA1E FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 7693 AA22 4F           	LD C,A
 7694 AA23 87           	ADD A,A
 7695 AA24 81           	ADD A,C
 7696 AA25 D6 02        	SUB 2
 7697 AA27 32 C8 B0     	LD (TSSub),A
 7698 AA2A 18 03        	JR AlCoTS_
 7699 AA2C CD 90 AB     TwoPT3s	CALL INITPT3
 7700 AA2F 3E 01        AlCoTS_	LD A,1
 7701 AA31 32 90 B2     	LD (is_ts),A
 7702 AA34 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 7703 AA38
 7704 AA38 01 4D AD     NOTS	LD BC,PT3PD
 7705 AA3B 21 00 00     	LD HL,0
 7706 AA3E 11 58 B2     	LD DE,PT3EMPTYORN
 7707 AA41 18 48        	JR INITCOMMON
 7708 AA43
 7709 AA43 CD C8 AB     I_PT2	CALL INITPT2
 7710 AA46 21 CB 51     	LD HL,#51CB
 7711 AA49 22 63 AF     	LD (SamCnv),HL
 7712 AA4C 3E BB        	LD A,#BB
 7713 AA4E 32 2E AF     	LD (OrnCP),A
 7714 AA51 32 5A AF     	LD (SamCP),A
 7715 AA54 3E 7A        	LD A,#7A
 7716 AA56 32 31 AF     	LD (OrnLD),A
 7717 AA59 32 5D AF     	LD (SamLD),A
 7718 AA5C 3E 80        	LD A,#80
 7719 AA5E 32 54 AF     	LD (SamClc2),A
 7720 AA61 E1           	POP HL
 7721 AA62 3E 05        	LD A,5
 7722 AA64 32 01 AE     	LD (Version),A
 7723 AA67 F5           	PUSH AF
 7724 AA68 3E 02        	LD A,2
 7725 AA6A F5           	PUSH AF
 7726 AA6B
 7727 AA6B 3A 63 A9     	LD A,(START+10)
 7728 AA6E E6 30        	AND 48
 7729 AA70 28 10        	JR Z,NOTS2
 7730 AA72
 7731 AA72 FD 21 7C B3  	LD IY,VARS2+100
 7732 AA76 3E 01        	LD A,1
 7733 AA78 32 90 B2     	LD (is_ts),A
 7734 AA7B FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 7735 AA7F CD C8 AB     	CALL INITPT2
 7736 AA82
 7737 AA82 01 87 AC     NOTS2	LD BC,PT2PD
 7738 AA85 21 87 86     	LD HL,#8687
 7739 AA88 11 AE B3     	LD DE,PT2EMPTYORN
 7740 AA8B
 7741 AA8B              INITCOMMON
 7742 AA8B
 7743 AA8B              	IF Basic
 7744 AA8B FD 21 3A 5C  	LD IY,#5C3A
 7745 AA8F              	ENDIF
 7746 AA8F
 7747 AA8F ED 43 38 AC  	LD (PTDEC),BC
 7748 AA93 22 CA B0     	LD (PsCalc),HL
 7749 AA96 D5           	PUSH DE
 7750 AA97
 7751 AA97              ;note table data depacker
 7752 AA97              ;(c) Ivan Roshin
 7753 AA97 11 5B B2     	LD DE,T_PACK
 7754 AA9A 01 00 B4     	LD BC,T1_+(2*49)-1
 7755 AA9D 1A           TP_0	LD A,(DE)
 7756 AA9E 13           	INC DE
 7757 AA9F FE 1E        	CP 15*2
 7758 AAA1 30 06        	JR NC,TP_1
 7759 AAA3 67           	LD H,A
 7760 AAA4 1A           	LD A,(DE)
 7761 AAA5 6F           	LD L,A
 7762 AAA6 13           	INC DE
 7763 AAA7 18 07        	JR TP_2
 7764 AAA9 D5           TP_1	PUSH DE
 7765 AAAA 16 00        	LD D,0
 7766 AAAC 5F           	LD E,A
 7767 AAAD 19           	ADD HL,DE
 7768 AAAE 19           	ADD HL,DE
 7769 AAAF D1           	POP DE
 7770 AAB0 7C           TP_2	LD A,H
 7771 AAB1 02           	LD (BC),A
 7772 AAB2 0B           	DEC BC
 7773 AAB3 7D           	LD A,L
 7774 AAB4 02           	LD (BC),A
 7775 AAB5 0B           	DEC BC
NextPlayer.asm(7776): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 7776 AAB6 D6 F0        	SUB #F8*2
 7777 AAB8 20 E3        	JR NZ,TP_0
 7778 AABA
 7779 AABA 3C           	INC A
 7780 AABB 32 FE B2     	LD (VARS1+VRS.DelyCnt),A
 7781 AABE 32 85 B3     	LD (VARS2+VRS.DelyCnt),A
 7782 AAC1 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 7783 AAC4 22 AF B2     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 7784 AAC7 22 CC B2     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 7785 AACA 22 E9 B2     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 7786 AACD 22 36 B3     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 7787 AAD0 22 53 B3     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 7788 AAD3 22 70 B3     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 7789 AAD6 E1           	POP HL
 7790 AAD7 22 A1 B2     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 7791 AADA 22 BE B2     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 7792 AADD 22 DB B2     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 7793 AAE0 22 28 B3     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 7794 AAE3 22 45 B3     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 7795 AAE6 22 62 B3     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 7796 AAE9
 7797 AAE9 F1           	POP AF
 7798 AAEA
 7799 AAEA              ;NoteTableCreator (c) Ivan Roshin
 7800 AAEA              ;A - NoteTableNumber*2+VersionForNoteTable
 7801 AAEA              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 7802 AAEA
 7803 AAEA 21 08 B2     	LD HL,NT_DATA
 7804 AAED 16 00        	LD D,0
 7805 AAEF 87           	ADD A,A
 7806 AAF0 5F           	LD E,A
 7807 AAF1 19           	ADD HL,DE
 7808 AAF2 5E           	LD E,(HL)
 7809 AAF3 23           	INC HL
 7810 AAF4 CB 3B        	SRL E
 7811 AAF6 9F           	SBC A,A
 7812 AAF7 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 7813 AAF9 32 21 AB     	LD (L3),A
 7814 AAFC EB           	EX DE,HL
 7815 AAFD 01 9F B3     	LD BC,T1_
 7816 AB00 09           	ADD HL,BC
 7817 AB01
 7818 AB01 1A           	LD A,(DE)
NextPlayer.asm(7819): warning: value 0xB218 is truncated to 8bit value: 0x18
 7819 AB02 C6 18        	ADD A,T_
 7820 AB04 4F           	LD C,A
 7821 AB05 CE B2        	ADC A,T_/256
 7822 AB07 91           	SUB C
 7823 AB08 47           	LD B,A
 7824 AB09 C5           	PUSH BC
 7825 AB0A 11 8F B4     	LD DE,NT_
 7826 AB0D D5           	PUSH DE
 7827 AB0E
 7828 AB0E 06 0C        	LD B,12
 7829 AB10 C5           L1	PUSH BC
 7830 AB11 4E           	LD C,(HL)
 7831 AB12 23           	INC HL
 7832 AB13 E5           	PUSH HL
 7833 AB14 46           	LD B,(HL)
 7834 AB15
 7835 AB15 D5           	PUSH DE
 7836 AB16 EB           	EX DE,HL
 7837 AB17 11 17 00     	LD DE,23
 7838 AB1A DD 26 08     	LD IXH,8
 7839 AB1D
 7840 AB1D CB 38        L2	SRL B
 7841 AB1F CB 19        	RR C
 7842 AB21 19           L3	DB #19	;AND A or NOP
 7843 AB22 79           	LD A,C
 7844 AB23 8A           	ADC A,D	;=ADC 0
 7845 AB24 77           	LD (HL),A
 7846 AB25 23           	INC HL
 7847 AB26 78           	LD A,B
 7848 AB27 8A           	ADC A,D
 7849 AB28 77           	LD (HL),A
 7850 AB29 19           	ADD HL,DE
 7851 AB2A DD 25        	DEC IXH
 7852 AB2C 20 EF        	JR NZ,L2
 7853 AB2E
 7854 AB2E D1           	POP DE
 7855 AB2F 13           	INC DE
 7856 AB30 13           	INC DE
 7857 AB31 E1           	POP HL
 7858 AB32 23           	INC HL
 7859 AB33 C1           	POP BC
 7860 AB34 10 DA        	DJNZ L1
 7861 AB36
 7862 AB36 E1           	POP HL
 7863 AB37 D1           	POP DE
 7864 AB38
 7865 AB38 7B           	LD A,E
NextPlayer.asm(7866): warning: value 0xB224 is truncated to 8bit value: 0x24
 7866 AB39 FE 24        	CP TCOLD_1
 7867 AB3B 20 05        	JR NZ,CORR_1
 7868 AB3D 3E FD        	LD A,#FD
 7869 AB3F 32 BD B4     	LD (NT_+#2E),A
 7870 AB42
 7871 AB42 1A           CORR_1	LD A,(DE)
 7872 AB43 A7           	AND A
 7873 AB44 28 11        	JR Z,TC_EXIT
 7874 AB46 1F           	RRA
 7875 AB47 F5           	PUSH AF
 7876 AB48 87           	ADD A,A
 7877 AB49 4F           	LD C,A
 7878 AB4A 09           	ADD HL,BC
 7879 AB4B F1           	POP AF
 7880 AB4C 30 02        	JR NC,CORR_2
 7881 AB4E 35           	DEC (HL)
 7882 AB4F 35           	DEC (HL)
 7883 AB50 34           CORR_2	INC (HL)
 7884 AB51 A7           	AND A
 7885 AB52 ED 42        	SBC HL,BC
 7886 AB54 13           	INC DE
 7887 AB55 18 EB        	JR CORR_1
 7888 AB57
 7889 AB57              TC_EXIT
 7890 AB57
 7891 AB57 F1           	POP AF
 7892 AB58
 7893 AB58              ;VolTableCreator (c) Ivan Roshin
 7894 AB58              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 7895 AB58              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 7896 AB58
 7897 AB58 FE 05        	CP 5
 7898 AB5A 21 11 00     	LD HL,#11
 7899 AB5D 54           	LD D,H
 7900 AB5E 5C           	LD E,H
 7901 AB5F 3E 17        	LD A,#17
 7902 AB61 30 03        	JR NC,M1
 7903 AB63 2D           	DEC L
 7904 AB64 5D           	LD E,L
 7905 AB65 AF           	XOR A
 7906 AB66 32 77 AB     M1      LD (M2),A
 7907 AB69
 7908 AB69 DD 21 9F B3  	LD IX,VT_+16
 7909 AB6D
 7910 AB6D 0E 0F        	LD C,#F
 7911 AB6F E5           INITV2  PUSH HL
 7912 AB70
 7913 AB70 19           	ADD HL,DE
 7914 AB71 EB           	EX DE,HL
 7915 AB72 ED 62        	SBC HL,HL
 7916 AB74
 7917 AB74 06 10        	LD B,#10
 7918 AB76 7D           INITV1  LD A,L
 7919 AB77 7D           M2      DB #7D
 7920 AB78 7C           	LD A,H
 7921 AB79 CE 00        	ADC A,0
 7922 AB7B DD 77 00     	LD (IX),A
 7923 AB7E DD 23        	INC IX
 7924 AB80 19           	ADD HL,DE
 7925 AB81 10 F3        	DJNZ INITV1
 7926 AB83
 7927 AB83 E1           	POP HL
 7928 AB84 7B           	LD A,E
 7929 AB85 FE 77        	CP #77
 7930 AB87 20 01        	JR NZ,M3
 7931 AB89 1C           	INC E
 7932 AB8A 0D           M3      DEC C
 7933 AB8B 20 E2        	JR NZ,INITV2
 7934 AB8D
 7935 AB8D C3 D5 B1     	JP ROUT
 7936 AB90
 7937 AB90 CD 03 AC     INITPT3	CALL SETMDAD
 7938 AB93 E5           	PUSH HL
 7939 AB94 11 64 00     	LD DE,100
 7940 AB97 19           	ADD HL,DE
 7941 AB98 7E           	LD A,(HL)
 7942 AB99 FD 77 08     	LD (IY-100+VRS.Delay),A
 7943 AB9C E5           	PUSH HL
 7944 AB9D DD E1        	POP IX
 7945 AB9F 19           	ADD HL,DE
 7946 ABA0 CD 11 AC     	CALL SETCPPT
 7947 ABA3 DD 5E 02     	LD E,(IX+102-100)
 7948 ABA6 23           	INC HL
 7949 ABA7
 7950 ABA7              	IF CurPosCounter
 7951 ABA7 ~            	LD (IY-100+VRS.PosSub),L
 7952 ABA7              	ENDIF
 7953 ABA7
 7954 ABA7 19           	ADD HL,DE
 7955 ABA8 CD 18 AC     	CALL SETLPPT
 7956 ABAB D1           	POP DE
 7957 ABAC DD 6E 03     	LD L,(IX+103-100)
 7958 ABAF DD 66 04     	LD H,(IX+104-100)
 7959 ABB2 19           	ADD HL,DE
 7960 ABB3 CD FC AB     	CALL SETPTPT
 7961 ABB6 21 A9 00     	LD HL,169
 7962 ABB9 19           	ADD HL,DE
 7963 ABBA CD 0A AC     	CALL SETORPT
 7964 ABBD 21 69 00     	LD HL,105
 7965 ABC0 19           	ADD HL,DE
 7966 ABC1
 7967 ABC1 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 7968 ABC4 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 7969 ABC7 C9           	RET
 7970 ABC8
 7971 ABC8 7E           INITPT2	LD A,(HL)
 7972 ABC9 FD 77 08     	LD (IY-100+VRS.Delay),A
 7973 ABCC E5           	PUSH HL
 7974 ABCD E5           	PUSH HL
 7975 ABCE E5           	PUSH HL
 7976 ABCF 23           	INC HL
 7977 ABD0 23           	INC HL
 7978 ABD1 7E           	LD A,(HL)
 7979 ABD2 23           	INC HL
 7980 ABD3 CD C1 AB     	CALL SETSMPT
 7981 ABD6 5E           	LD E,(HL)
 7982 ABD7 23           	INC HL
 7983 ABD8 56           	LD D,(HL)
 7984 ABD9 E1           	POP HL
 7985 ABDA A7           	AND A
 7986 ABDB ED 52        	SBC HL,DE
 7987 ABDD CD 03 AC     	CALL SETMDAD
 7988 ABE0 E1           	POP HL
 7989 ABE1 11 43 00     	LD DE,67
 7990 ABE4 19           	ADD HL,DE
 7991 ABE5 CD 0A AC     	CALL SETORPT
 7992 ABE8 1E 20        	LD E,32
 7993 ABEA 19           	ADD HL,DE
 7994 ABEB 4E           	LD C,(HL)
 7995 ABEC 23           	INC HL
 7996 ABED 46           	LD B,(HL)
 7997 ABEE 1E 1E        	LD E,30
 7998 ABF0 19           	ADD HL,DE
 7999 ABF1 CD 11 AC     	CALL SETCPPT
 8000 ABF4 5F           	LD E,A
 8001 ABF5 23           	INC HL
 8002 ABF6
 8003 ABF6              	IF CurPosCounter
 8004 ABF6 ~            	LD (IY-100+VRS.PosSub),L
 8005 ABF6              	ENDIF
 8006 ABF6
 8007 ABF6 19           	ADD HL,DE
 8008 ABF7 CD 18 AC     	CALL SETLPPT
 8009 ABFA E1           	POP HL
 8010 ABFB 09           	ADD HL,BC
 8011 ABFC
 8012 ABFC FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 8013 ABFF FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 8014 AC02 C9           	RET
 8015 AC03
 8016 AC03 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 8017 AC06 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 8018 AC09 C9           	RET
 8019 AC0A
 8020 AC0A FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 8021 AC0D FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 8022 AC10 C9           	RET
 8023 AC11
 8024 AC11 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 8025 AC14 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 8026 AC17 C9           	RET
 8027 AC18
 8028 AC18 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 8029 AC1B FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 8030 AC1E C9           	RET
 8031 AC1F
 8032 AC1F FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 8033 AC22 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 8034 AC25 C9           	RET
 8035 AC26
 8036 AC26 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 8037 AC29 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 8038 AC2C C9           	RET
 8039 AC2D
 8040 AC2D FD E5        GETIX	PUSH IY
 8041 AC2F DD E1        	POP IX
 8042 AC31 DD 19        	ADD IX,DE
 8043 AC33 C9           	RET
 8044 AC34
 8045 AC34 CD 2D AC     PTDECOD CALL GETIX
 8046 AC37              PTDEC	EQU $+1
 8047 AC37 C3 C3 C3     	JP #C3C3
 8048 AC3A
 8049 AC3A              ;PT2 pattern decoder
 8050 AC3A CD D0 AE     PD2_SAM	CALL SETSAM
 8051 AC3D 18 4A        	JR PD2_LOOP
 8052 AC3F
 8053 AC3F DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 8054 AC42 18 45        	JR PD2_LOOP
 8055 AC44
 8056 AC44 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 8057 AC48 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 8058 AC4B 0A           	LD A,(BC)
 8059 AC4C 03           	INC BC
 8060 AC4D 6F           	LD L,A
 8061 AC4E 0A           	LD A,(BC)
 8062 AC4F 03           	INC BC
 8063 AC50 67           	LD H,A
 8064 AC51 CD 1F AC     	CALL SETENBS
 8065 AC54 18 33        	JR PD2_LOOP
 8066 AC56
 8067 AC56 CD B1 AE     PD2_ORN	CALL SETORN
 8068 AC59 18 2E        	JR PD2_LOOP
 8069 AC5B
 8070 AC5B 3C           PD2_SKIP INC A
 8071 AC5C DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 8072 AC5F 18 28        	JR PD2_LOOP
 8073 AC61
 8074 AC61 0F           PD2_VOL	RRCA
 8075 AC62 0F           	RRCA
 8076 AC63 0F           	RRCA
 8077 AC64 0F           	RRCA
 8078 AC65 DD 77 10     	LD (IX-12+CHP.Volume),A
 8079 AC68 18 1F        	JR PD2_LOOP
 8080 AC6A
 8081 AC6A CD 81 AE     PD2_DEL	CALL C_DELAY
 8082 AC6D 18 1A        	JR PD2_LOOP
 8083 AC6F
 8084 AC6F DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 8085 AC73 3C           	INC A
 8086 AC74 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 8087 AC77 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8088 AC7A 0A           	LD A,(BC)
 8089 AC7B 03           	INC BC
 8090 AC7C DD 77 0B             LD (IX-12+CHP.TSlStp),A
 8091 AC7F 87           	ADD A,A
 8092 AC80 9F           	SBC A,A
 8093 AC81 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 8094 AC84 37           	SCF
 8095 AC85 18 01        	JR PD2_LP2
 8096 AC87
 8097 AC87 A7           PT2PD	AND A
 8098 AC88
 8099 AC88 08           PD2_LP2	EX AF,AF'
 8100 AC89
 8101 AC89 0A           PD2_LOOP LD A,(BC)
 8102 AC8A 03           	INC BC
 8103 AC8B C6 20        	ADD A,#20
 8104 AC8D 28 3F        	JR Z,PD2_REL
 8105 AC8F 38 A9        	JR C,PD2_SAM
 8106 AC91 C6 60        	ADD A,96
 8107 AC93 38 3E        	JR C,PD2_NOTE
 8108 AC95 3C           	INC A
 8109 AC96 28 A7        	JR Z,PD2_EOff
 8110 AC98 C6 0F        	ADD A,15
 8111 AC9A CA B0 AD     	JP Z,PD_FIN
 8112 AC9D 38 A5        	JR C,PD2_ENV
 8113 AC9F C6 10        	ADD A,#10
 8114 ACA1 38 B3        	JR C,PD2_ORN
 8115 ACA3 C6 40        	ADD A,#40
 8116 ACA5 38 B4        	JR C,PD2_SKIP
 8117 ACA7 C6 10        	ADD A,#10
 8118 ACA9 38 B6        	JR C,PD2_VOL
 8119 ACAB 3C           	INC A
 8120 ACAC 28 BC        	JR Z,PD2_DEL
 8121 ACAE 3C           	INC A
 8122 ACAF 28 BE        	JR Z,PD2_GLIS
 8123 ACB1 3C           	INC A
 8124 ACB2 28 0A        	JR Z,PD2_PORT
 8125 ACB4 3C           	INC A
 8126 ACB5 28 12        	JR Z,PD2_STOP
 8127 ACB7 0A           	LD A,(BC)
 8128 ACB8 03           	INC BC
 8129 ACB9 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 8130 ACBC 18 CB        	JR PD2_LOOP
 8131 ACBE
 8132 ACBE DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 8133 ACC2 0A           	LD A,(BC)
 8134 ACC3 03           	INC BC
 8135 ACC4 03           	INC BC ;ignoring precalc delta to right sound
 8136 ACC5 03           	INC BC
 8137 ACC6 37           	SCF
 8138 ACC7 18 BF        	JR PD2_LP2
 8139 ACC9
 8140 ACC9 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 8141 ACCC 18 BB        	JR PD2_LOOP
 8142 ACCE
 8143 ACCE DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 8144 ACD1 18 2C        	JR PD2_EXIT
 8145 ACD3
 8146 ACD3 6F           PD2_NOTE LD L,A
 8147 ACD4 DD 7E 06     	LD A,(IX-12+CHP.Note)
 8148 ACD7 32 EA AD     	LD (PrNote+1),A
 8149 ACDA DD 75 06     	LD (IX-12+CHP.Note),L
 8150 ACDD AF           	XOR A
 8151 ACDE DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8152 ACE1 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 8153 ACE5 08           	EX AF,AF'
 8154 ACE6 30 16        	JR NC,NOGLIS2
 8155 ACE8 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 8156 ACEC 20 0C        	JR NZ,NOPORT2
 8157 ACEE 32 10 AE     	LD (LoStep),A
 8158 ACF1 87           	ADD A,A
 8159 ACF2 9F           	SBC A,A
 8160 ACF3 08           	EX AF,AF'
 8161 ACF4 67           	LD H,A
 8162 ACF5 6F           	LD L,A
 8163 ACF6 3C           	INC A
 8164 ACF7 CD CB AD     	CALL SETPORT
 8165 ACFA DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 8166 ACFE AF           NOGLIS2	XOR A
 8167 ACFF
 8168 ACFF
 8169 ACFF DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 8170 AD02 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8171 AD05 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 8172 AD08 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 8173 AD0B C3 B0 AD     	JP PD_FIN
 8174 AD0E
 8175 AD0E              ;PT3 pattern decoder
 8176 AD0E DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 8177 AD12 CD B1 AE     	CALL SETORN
 8178 AD15 0A           PD_SAM_	LD A,(BC)
 8179 AD16 03           	INC BC
 8180 AD17 0F           	RRCA
 8181 AD18
 8182 AD18 CD D0 AE     PD_SAM	CALL SETSAM
 8183 AD1B 18 3F        	JR PD_LOOP
 8184 AD1D
 8185 AD1D 0F           PD_VOL	RRCA
 8186 AD1E 0F           	RRCA
 8187 AD1F 0F           	RRCA
 8188 AD20 0F           	RRCA
 8189 AD21 DD 77 10     	LD (IX-12+CHP.Volume),A
 8190 AD24 18 39        	JR PD_LP2
 8191 AD26
 8192 AD26 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 8193 AD29 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8194 AD2C 18 31        	JR PD_LP2
 8195 AD2E
 8196 AD2E 3D           PD_SorE	DEC A
 8197 AD2F 20 07        	JR NZ,PD_ENV
 8198 AD31 0A           	LD A,(BC)
 8199 AD32 03           	INC BC
 8200 AD33 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 8201 AD36 18 27        	JR PD_LP2
 8202 AD38
 8203 AD38 CD 96 AE     PD_ENV	CALL SETENV
 8204 AD3B 18 22        	JR PD_LP2
 8205 AD3D
 8206 AD3D CD B1 AE     PD_ORN	CALL SETORN
 8207 AD40 18 1A        	JR PD_LOOP
 8208 AD42
 8209 AD42 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 8210 AD45 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8211 AD48 C4 96 AE     	CALL NZ,SETENV
 8212 AD4B 18 C8        	JR PD_SAM_
 8213 AD4D
 8214 AD4D DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 8215 AD50 32 EA AD     	LD (PrNote+1),A
 8216 AD53 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 8217 AD56 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 8218 AD59 22 07 AE     	LD (PrSlide+1),HL
 8219 AD5C
 8220 AD5C 11 10 20     PD_LOOP	LD DE,#2010
 8221 AD5F 0A           PD_LP2	LD A,(BC)
 8222 AD60 03           	INC BC
 8223 AD61 83           	ADD A,E
 8224 AD62 38 AA        	JR C,PD_OrSm
 8225 AD64 82           	ADD A,D
 8226 AD65 28 49        	JR Z,PD_FIN
 8227 AD67 38 AF        	JR C,PD_SAM
 8228 AD69 83           	ADD A,E
 8229 AD6A 28 25        	JR Z,PD_REL
 8230 AD6C 38 AF        	JR C,PD_VOL
 8231 AD6E 83           	ADD A,E
 8232 AD6F 28 B5        	JR Z,PD_EOff
 8233 AD71 38 BB        	JR C,PD_SorE
 8234 AD73 C6 60        	ADD A,96
 8235 AD75 38 20        	JR C,PD_NOTE
 8236 AD77 83           	ADD A,E
 8237 AD78 38 C3        	JR C,PD_ORN
 8238 AD7A 82           	ADD A,D
 8239 AD7B 38 0F        	JR C,PD_NOIS
 8240 AD7D 83           	ADD A,E
 8241 AD7E 38 C2        	JR C,PD_ESAM
 8242 AD80 87           	ADD A,A
 8243 AD81 5F           	LD E,A
NextPlayer.asm(8244): warning: value 0x18E0C is truncated to 16bit value: 0x8E0C
 8244 AD82 21 0C 8E     	LD HL,SPCCOMS+#FF20-#2000
 8245 AD85 19           	ADD HL,DE
 8246 AD86 5E           	LD E,(HL)
 8247 AD87 23           	INC HL
 8248 AD88 56           	LD D,(HL)
 8249 AD89 D5           	PUSH DE
 8250 AD8A 18 D0        	JR PD_LOOP
 8251 AD8C
 8252 AD8C FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 8253 AD8F 18 CE        	JR PD_LP2
 8254 AD91
 8255 AD91 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 8256 AD95 18 08        	JR PD_RES
 8257 AD97
 8258 AD97 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 8259 AD9A DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 8260 AD9E AF           	XOR A
 8261 AD9F
 8262 AD9F ED 73 AE AD  PD_RES	LD (PDSP_+1),SP
 8263 ADA3 DD F9        	LD SP,IX
 8264 ADA5 67           	LD H,A
 8265 ADA6 6F           	LD L,A
 8266 ADA7 E5           	PUSH HL
 8267 ADA8 E5           	PUSH HL
 8268 ADA9 E5           	PUSH HL
 8269 ADAA E5           	PUSH HL
 8270 ADAB E5           	PUSH HL
 8271 ADAC E5           	PUSH HL
 8272 ADAD 31 31 31     PDSP_	LD SP,#3131
 8273 ADB0
 8274 ADB0 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 8275 ADB3 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 8276 ADB6 C9           	RET
 8277 ADB7
 8278 ADB7 0A           C_PORTM LD A,(BC)
 8279 ADB8 03           	INC BC
 8280 ADB9              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 8281 ADB9              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 8282 ADB9 03           	INC BC
 8283 ADBA 03           	INC BC
 8284 ADBB 08           	EX AF,AF'
 8285 ADBC 0A           	LD A,(BC) ;SIGNED TONE STEP
 8286 ADBD 03           	INC BC
 8287 ADBE 32 10 AE     	LD (LoStep),A
 8288 ADC1 0A           	LD A,(BC)
 8289 ADC2 03           	INC BC
 8290 ADC3 A7           	AND A
 8291 ADC4 08           	EX AF,AF'
 8292 ADC5 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 8293 ADC8 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 8294 ADCB
 8295 ADCB              ;Set portamento variables
 8296 ADCB              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 8297 ADCB
 8298 ADCB DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 8299 ADCF DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 8300 ADD2 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8301 ADD5 E5           	PUSH HL
 8302 ADD6 11 8F B4     	LD DE,NT_
 8303 ADD9 DD 7E 06     	LD A,(IX-12+CHP.Note)
 8304 ADDC DD 77 07     	LD (IX-12+CHP.SlToNt),A
 8305 ADDF 87           	ADD A,A
 8306 ADE0 6F           	LD L,A
 8307 ADE1 26 00        	LD H,0
 8308 ADE3 19           	ADD HL,DE
 8309 ADE4 7E           	LD A,(HL)
 8310 ADE5 23           	INC HL
 8311 ADE6 66           	LD H,(HL)
 8312 ADE7 6F           	LD L,A
 8313 ADE8 E5           	PUSH HL
 8314 ADE9 3E 3E        PrNote	LD A,#3E
 8315 ADEB DD 77 06     	LD (IX-12+CHP.Note),A
 8316 ADEE 87           	ADD A,A
 8317 ADEF 6F           	LD L,A
 8318 ADF0 26 00        	LD H,0
 8319 ADF2 19           	ADD HL,DE
 8320 ADF3 5E           	LD E,(HL)
 8321 ADF4 23           	INC HL
 8322 ADF5 56           	LD D,(HL)
 8323 ADF6 E1           	POP HL
 8324 ADF7 ED 52        	SBC HL,DE
 8325 ADF9 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 8326 ADFC DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 8327 ADFF D1           	POP DE
 8328 AE00              Version EQU $+1
 8329 AE00 3E 3E        	LD A,#3E
 8330 AE02 FE 06        	CP 6
 8331 AE04 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 8332 AE06 11 11 11     PrSlide	LD DE,#1111
 8333 AE09 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 8334 AE0C DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 8335 AE0F              LoStep	EQU $+1
 8336 AE0F 3E 3E        OLDPRTM	LD A,#3E
 8337 AE11 08           	EX AF,AF'
 8338 AE12 28 01        	JR Z,NOSIG
 8339 AE14 EB           	EX DE,HL
 8340 AE15 ED 52        NOSIG	SBC HL,DE
 8341 AE17 F2 1F AE     	JP P,SET_STP
 8342 AE1A 2F           	CPL
 8343 AE1B 08           	EX AF,AF'
 8344 AE1C ED 44        	NEG
 8345 AE1E 08           	EX AF,AF'
 8346 AE1F DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 8347 AE22 08           	EX AF,AF'
 8348 AE23 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 8349 AE26 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 8350 AE2A C9           	RET
 8351 AE2B
 8352 AE2B DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 8353 AE2F 0A           	LD A,(BC)
 8354 AE30 03           	INC BC
 8355 AE31 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 8356 AE34 A7           	AND A
 8357 AE35 20 07        	JR NZ,GL36
 8358 AE37 3A 01 AE     	LD A,(Version) ;AlCo PT3.7+
 8359 AE3A FE 07        	CP 7
 8360 AE3C 9F           	SBC A,A
 8361 AE3D 3C           	INC A
 8362 AE3E DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 8363 AE41 0A           	LD A,(BC)
 8364 AE42 03           	INC BC
 8365 AE43 08           	EX AF,AF'
 8366 AE44 0A           	LD A,(BC)
 8367 AE45 03           	INC BC
 8368 AE46 18 D7        	JR SET_STP
 8369 AE48
 8370 AE48 0A           C_SMPOS	LD A,(BC)
 8371 AE49 03           	INC BC
 8372 AE4A DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 8373 AE4D C9           	RET
 8374 AE4E
 8375 AE4E 0A           C_ORPOS	LD A,(BC)
 8376 AE4F 03           	INC BC
 8377 AE50 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8378 AE53 C9           	RET
 8379 AE54
 8380 AE54 0A           C_VIBRT	LD A,(BC)
 8381 AE55 03           	INC BC
 8382 AE56 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 8383 AE59 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 8384 AE5C 0A           	LD A,(BC)
 8385 AE5D 03           	INC BC
 8386 AE5E DD 77 00     	LD (IX-12+CHP.OffOnD),A
 8387 AE61 AF           	XOR A
 8388 AE62 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8389 AE65 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 8390 AE68 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 8391 AE6B C9           	RET
 8392 AE6C
 8393 AE6C 0A           C_ENGLS	LD A,(BC)
 8394 AE6D 03           	INC BC
 8395 AE6E FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 8396 AE71 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 8397 AE74 0A           	LD A,(BC)
 8398 AE75 03           	INC BC
 8399 AE76 6F           	LD L,A
 8400 AE77 0A           	LD A,(BC)
 8401 AE78 03           	INC BC
 8402 AE79 67           	LD H,A
 8403 AE7A FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 8404 AE7D FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 8405 AE80 C9           	RET
 8406 AE81
 8407 AE81 0A           C_DELAY	LD A,(BC)
 8408 AE82 03           	INC BC
 8409 AE83 FD 77 08     	LD (IY-100+VRS.Delay),A
 8410 AE86 21 1A B3     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 8411 AE89 CB 4E        	BIT 1,(HL)
 8412 AE8B C8           	RET Z
 8413 AE8C 32 FD B2     	LD (VARS1+VRS.Delay),A
 8414 AE8F 32 FE B2     	LD (VARS1+VRS.DelyCnt),A
 8415 AE92 32 84 B3     	LD (VARS2+VRS.Delay),A
 8416 AE95 C9           	RET
 8417 AE96
 8418 AE96 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 8419 AE99 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 8420 AE9C 0A           	LD A,(BC)
 8421 AE9D 03           	INC BC
 8422 AE9E 67           	LD H,A
 8423 AE9F 0A           	LD A,(BC)
 8424 AEA0 03           	INC BC
 8425 AEA1 6F           	LD L,A
 8426 AEA2 CD 1F AC     	CALL SETENBS
 8427 AEA5 AF           	XOR A
 8428 AEA6 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8429 AEA9 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 8430 AEAC 67           	LD H,A
 8431 AEAD 6F           	LD L,A
 8432 AEAE C3 26 AC     	JP SETESLD
 8433 AEB1
 8434 AEB1 87           SETORN	ADD A,A
 8435 AEB2 5F           	LD E,A
 8436 AEB3 16 00        	LD D,0
 8437 AEB5 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 8438 AEB8 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 8439 AEBB FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 8440 AEBE 19           	ADD HL,DE
 8441 AEBF 5E           	LD E,(HL)
 8442 AEC0 23           	INC HL
 8443 AEC1 56           	LD D,(HL)
 8444 AEC2 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 8445 AEC5 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 8446 AEC8 19           	ADD HL,DE
 8447 AEC9 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 8448 AECC DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 8449 AECF C9           C_NOP	RET
 8450 AED0
 8451 AED0 87           SETSAM	ADD A,A
 8452 AED1 5F           	LD E,A
 8453 AED2 16 00        	LD D,0
 8454 AED4 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 8455 AED7 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 8456 AEDA 19           	ADD HL,DE
 8457 AEDB 5E           	LD E,(HL)
 8458 AEDC 23           	INC HL
 8459 AEDD 56           	LD D,(HL)
 8460 AEDE FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 8461 AEE1 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 8462 AEE4 19           	ADD HL,DE
 8463 AEE5 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 8464 AEE8 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 8465 AEEB C9           	RET
 8466 AEEC
 8467 AEEC              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 8468 AEEC CF AE        SPCCOMS DW C_NOP
 8469 AEEE 2B AE        	DW C_GLISS
 8470 AEF0 B7 AD        	DW C_PORTM
 8471 AEF2 48 AE        	DW C_SMPOS
 8472 AEF4 4E AE        	DW C_ORPOS
 8473 AEF6 54 AE        	DW C_VIBRT
 8474 AEF8 CF AE        	DW C_NOP
 8475 AEFA CF AE        	DW C_NOP
 8476 AEFC 6C AE        	DW C_ENGLS
 8477 AEFE 81 AE        	DW C_DELAY
 8478 AF00 CF AE        	DW C_NOP
 8479 AF02 CF AE        	DW C_NOP
 8480 AF04 CF AE        	DW C_NOP
 8481 AF06 CF AE        	DW C_NOP
 8482 AF08 CF AE        	DW C_NOP
 8483 AF0A CF AE        	DW C_NOP
 8484 AF0C
 8485 AF0C CD 2D AC     CHREGS	CALL GETIX
 8486 AF0F AF           	XOR A
 8487 AF10 32 4C B1     	LD (Ampl),A
 8488 AF13 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 8489 AF17 E5           	PUSH HL
 8490 AF18 CA 5F B0     	JP Z,CH_EXIT
 8491 AF1B ED 73 A9 AF  	LD (CSP_+1),SP
 8492 AF1F DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 8493 AF22 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
 8494 AF25 F9           	LD SP,HL
 8495 AF26 D1           	POP DE
 8496 AF27 67           	LD H,A
 8497 AF28 DD 7E 00     	LD A,(IX+CHP.PsInOr)
 8498 AF2B 6F           	LD L,A
 8499 AF2C 39           	ADD HL,SP
 8500 AF2D 3C           	INC A
 8501 AF2E              		;PT2	PT3
 8502 AF2E 3C           OrnCP	INC A	;CP E	CP D
 8503 AF2F 38 01        	JR C,CH_ORPS
 8504 AF31 01           OrnLD	DB 1	;LD A,D	LD A,E
 8505 AF32 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
 8506 AF35 DD 7E 12     	LD A,(IX+CHP.Note)
 8507 AF38 86           	ADD A,(HL)
 8508 AF39 F2 3D AF     	JP P,CH_NTP
 8509 AF3C AF           	XOR A
 8510 AF3D FE 60        CH_NTP	CP 96
 8511 AF3F 38 02        	JR C,CH_NOK
 8512 AF41 3E 5F        	LD A,95
 8513 AF43 87           CH_NOK	ADD A,A
 8514 AF44 08           	EX AF,AF'
 8515 AF45 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
 8516 AF48 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
 8517 AF4B F9           	LD SP,HL
 8518 AF4C D1           	POP DE
 8519 AF4D 26 00        	LD H,0
 8520 AF4F DD 7E 01     	LD A,(IX+CHP.PsInSm)
 8521 AF52 47           	LD B,A
 8522 AF53 87           	ADD A,A
 8523 AF54 87           SamClc2	ADD A,A ;or ADD A,B for PT2
 8524 AF55 6F           	LD L,A
 8525 AF56 39           	ADD HL,SP
 8526 AF57 F9           	LD SP,HL
 8527 AF58 78           	LD A,B
 8528 AF59 3C           	INC A
 8529 AF5A              		;PT2	PT3
 8530 AF5A 3C           SamCP	INC A	;CP E	CP D
 8531 AF5B 38 01        	JR C,CH_SMPS
 8532 AF5D 01           SamLD	DB 1	;LD A,D	LD A,E
 8533 AF5E DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
 8534 AF61 C1           	POP BC
 8535 AF62 E1           	POP HL
 8536 AF63
 8537 AF63              ;Convert PT2 sample to PT3
 8538 AF63              		;PT2		PT3
 8539 AF63 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
 8540 AF64 E1           	POP HL
 8541 AF65 60           	LD H,B
 8542 AF66 20 06        	JR NZ,$+8
 8543 AF68 EB           	EX DE,HL
 8544 AF69 A7           	AND A
 8545 AF6A ED 62        	SBC HL,HL
 8546 AF6C ED 52        	SBC HL,DE
 8547 AF6E 51           	LD D,C
 8548 AF6F CB 19        	RR C
 8549 AF71 9F           	SBC A,A
 8550 AF72 2F           	CPL
 8551 AF73 E6 3E        	AND #3E
 8552 AF75 CB 19        	RR C
 8553 AF77 CB 18        	RR B
 8554 AF79 A1           	AND C
 8555 AF7A 4F           	LD C,A
 8556 AF7B 78           	LD A,B
 8557 AF7C 1F           	RRA
 8558 AF7D 1F           	RRA
 8559 AF7E CB 1A        	RR D
 8560 AF80 1F           	RRA
 8561 AF81 E6 9F        	AND #9F
 8562 AF83 47           	LD B,A
 8563 AF84
 8564 AF84 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
 8565 AF87 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
 8566 AF8A 19           	ADD HL,DE
 8567 AF8B CB 70        	BIT 6,B
 8568 AF8D 28 06        	JR Z,CH_NOAC
 8569 AF8F DD 75 08     	LD (IX+CHP.TnAcc),L
 8570 AF92 DD 74 09     	LD (IX+CHP.TnAcc+1),H
 8571 AF95 EB           CH_NOAC EX DE,HL
 8572 AF96 08           	EX AF,AF'
NextPlayer.asm(8573): warning: value 0xB48F is truncated to 8bit value: 0x8F
 8573 AF97 C6 8F        	ADD A,NT_
 8574 AF99 6F           	LD L,A
 8575 AF9A CE B4        	ADC A,NT_/256
 8576 AF9C 95           	SUB L
 8577 AF9D 67           	LD H,A
 8578 AF9E F9           	LD SP,HL
 8579 AF9F E1           	POP HL
 8580 AFA0 19           	ADD HL,DE
 8581 AFA1 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
 8582 AFA4 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
 8583 AFA7 19           	ADD HL,DE
 8584 AFA8 31 31 31     CSP_	LD SP,#3131
 8585 AFAB E3           	EX (SP),HL
 8586 AFAC AF           	XOR A
 8587 AFAD DD B6 05     	OR (IX+CHP.TSlCnt)
 8588 AFB0 28 3E        	JR Z,CH_AMP
 8589 AFB2 DD 35 05     	DEC (IX+CHP.TSlCnt)
 8590 AFB5 20 39        	JR NZ,CH_AMP
 8591 AFB7 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
 8592 AFBA DD 77 05     	LD (IX+CHP.TSlCnt),A
 8593 AFBD DD 6E 17     	LD L,(IX+CHP.TSlStp)
 8594 AFC0 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
 8595 AFC3 7C           	LD A,H
 8596 AFC4 19           	ADD HL,DE
 8597 AFC5 DD 75 06     	LD (IX+CHP.CrTnSl),L
 8598 AFC8 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
 8599 AFCB DD CB 15 56  	BIT 2,(IX+CHP.Flags)
 8600 AFCF 20 1F        	JR NZ,CH_AMP
 8601 AFD1 DD 5E 19     	LD E,(IX+CHP.TnDelt)
 8602 AFD4 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
 8603 AFD7 A7           	AND A
 8604 AFD8 28 01        	JR Z,CH_STPP
 8605 AFDA EB           	EX DE,HL
 8606 AFDB ED 52        CH_STPP SBC HL,DE
 8607 AFDD FA F0 AF     	JP M,CH_AMP
 8608 AFE0 DD 7E 13     	LD A,(IX+CHP.SlToNt)
 8609 AFE3 DD 77 12     	LD (IX+CHP.Note),A
 8610 AFE6 AF           	XOR A
 8611 AFE7 DD 77 05     	LD (IX+CHP.TSlCnt),A
 8612 AFEA DD 77 06     	LD (IX+CHP.CrTnSl),A
 8613 AFED DD 77 07     	LD (IX+CHP.CrTnSl+1),A
 8614 AFF0 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
 8615 AFF3 CB 79        	BIT 7,C
 8616 AFF5 28 13        	JR Z,CH_NOAM
 8617 AFF7 CB 71        	BIT 6,C
 8618 AFF9 28 07        	JR Z,CH_AMIN
 8619 AFFB FE 0F        	CP 15
 8620 AFFD 28 0B        	JR Z,CH_NOAM
 8621 AFFF 3C           	INC A
 8622 B000 18 05        	JR CH_SVAM
 8623 B002 FE F1        CH_AMIN	CP -15
 8624 B004 28 04        	JR Z,CH_NOAM
 8625 B006 3D           	DEC A
 8626 B007 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
 8627 B00A 6F           CH_NOAM	LD L,A
 8628 B00B 78           	LD A,B
 8629 B00C E6 0F        	AND 15
 8630 B00E 85           	ADD A,L
 8631 B00F F2 13 B0     	JP P,CH_APOS
 8632 B012 AF           	XOR A
 8633 B013 FE 10        CH_APOS	CP 16
 8634 B015 38 02        	JR C,CH_VOL
 8635 B017 3E 0F        	LD A,15
 8636 B019 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
NextPlayer.asm(8637): warning: value 0xB38F is truncated to 8bit value: 0x8F
 8637 B01C C6 8F        	ADD A,VT_
 8638 B01E 6F           	LD L,A
 8639 B01F CE B3        	ADC A,VT_/256
 8640 B021 95           	SUB L
 8641 B022 67           	LD H,A
 8642 B023 7E           	LD A,(HL)
 8643 B024 CB 41        CH_ENV	BIT 0,C
 8644 B026 20 03        	JR NZ,CH_NOEN
 8645 B028 DD B6 14     	OR (IX+CHP.Env_En)
 8646 B02B 32 4C B1     CH_NOEN	LD (Ampl),A
 8647 B02E CB 78        	BIT 7,B
 8648 B030 79           	LD A,C
 8649 B031 28 1A        	JR Z,NO_ENSL
 8650 B033 17           	RLA
 8651 B034 17           	RLA
 8652 B035 CB 2F        	SRA A
 8653 B037 CB 2F        	SRA A
 8654 B039 CB 2F        	SRA A
 8655 B03B DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
 8656 B03E CB 68        	BIT 5,B
 8657 B040 28 03        	JR Z,NO_ENAC
 8658 B042 DD 77 04     	LD (IX+CHP.CrEnSl),A
 8659 B045 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
 8660 B048 FD 77 12     	LD (IY-100+VRS.AddToEn),A
 8661 B04B 18 0E        	JR CH_MIX
 8662 B04D 1F           NO_ENSL RRA
 8663 B04E DD 86 03     	ADD A,(IX+CHP.CrNsSl)
 8664 B051 FD 77 11     	LD (IY-100+VRS.AddToNs),A
 8665 B054 CB 68        	BIT 5,B
 8666 B056 28 03        	JR Z,CH_MIX
 8667 B058 DD 77 03     	LD (IX+CHP.CrNsSl),A
 8668 B05B 78           CH_MIX	LD A,B
 8669 B05C 1F           	RRA
 8670 B05D E6 48        	AND #48
 8671 B05F FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
 8672 B062 0F           	RRCA
 8673 B063 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
 8674 B066 E1           	POP HL
 8675 B067 AF           	XOR A
 8676 B068 DD B6 0A     	OR (IX+CHP.COnOff)
 8677 B06B C8           	RET Z
 8678 B06C DD 35 0A     	DEC (IX+CHP.COnOff)
 8679 B06F C0           	RET NZ
 8680 B070 DD AE 15     	XOR (IX+CHP.Flags)
 8681 B073 DD 77 15     	LD (IX+CHP.Flags),A
 8682 B076 1F           	RRA
 8683 B077 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
 8684 B07A 38 03        	JR C,CH_ONDL
 8685 B07C DD 7E 0C     	LD A,(IX+CHP.OffOnD)
 8686 B07F DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
 8687 B082 C9           	RET
 8688 B083
 8689 B083 AF           PLAY_	XOR A
 8690 B084 FD 77 12     	LD (IY-100+VRS.AddToEn),A
 8691 B087 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
 8692 B08A 3D           	DEC A
 8693 B08B FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 8694 B08E FD 35 09     	DEC (IY-100+VRS.DelyCnt)
 8695 B091 C2 39 B1     	JP NZ,PL2
 8696 B094 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
 8697 B097 20 6C        	JR NZ,PL1B
 8698 B099 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
 8699 B09C FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
 8700 B09F 0A           	LD A,(BC)
 8701 B0A0 A7           	AND A
 8702 B0A1 20 56        	JR NZ,PL1A
 8703 B0A3 57           	LD D,A
 8704 B0A4 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
 8705 B0A7 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
 8706 B0AA FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
 8707 B0AD 23           	INC HL
 8708 B0AE 7E           	LD A,(HL)
 8709 B0AF 3C           	INC A
 8710 B0B0 20 0B        	JR NZ,PLNLP
 8711 B0B2
 8712 B0B2              	IF LoopChecker
 8713 B0B2 CD 64 A9     	CALL CHECKLP
 8714 B0B5              	ENDIF
 8715 B0B5
 8716 B0B5 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
 8717 B0B8 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
 8718 B0BB 7E           	LD A,(HL)
 8719 B0BC 3C           	INC A
 8720 B0BD CD 11 AC     PLNLP	CALL SETCPPT
 8721 B0C0 3D           	DEC A
 8722 B0C1 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
 8723 B0C5 28 03        	JR Z,NoAlCo
 8724 B0C7              TSSub	EQU $+1
 8725 B0C7 D6 D6        	SUB #D6
 8726 B0C9 2F           	CPL
 8727 B0CA              NoAlCo
 8728 B0CA              		;PT2		PT3
 8729 B0CA 3D           PsCalc	DEC A	;ADD A,A	NOP
 8730 B0CB 3D           	DEC A	;ADD A,(HL)	NOP
 8731 B0CC 87           	ADD A,A
 8732 B0CD 5F           	LD E,A
 8733 B0CE CB 12        	RL D
 8734 B0D0
 8735 B0D0              	IF CurPosCounter
 8736 B0D0 ~            	LD A,L
 8737 B0D0 ~            	SUB (IY-100+VRS.PosSub)
 8738 B0D0 ~            	LD (IY-100+VRS.CurPos),A
 8739 B0D0              	ENDIF
 8740 B0D0
 8741 B0D0 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
 8742 B0D3 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
 8743 B0D6 19           	ADD HL,DE
 8744 B0D7 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
 8745 B0DA FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
 8746 B0DD ED 73 F7 B0  	LD (PSP_+1),SP
 8747 B0E1 F9           	LD SP,HL
 8748 B0E2 E1           	POP HL
 8749 B0E3 19           	ADD HL,DE
 8750 B0E4 44           	LD B,H
 8751 B0E5 4D           	LD C,L
 8752 B0E6 E1           	POP HL
 8753 B0E7 19           	ADD HL,DE
 8754 B0E8 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
 8755 B0EB FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
 8756 B0EE E1           	POP HL
 8757 B0EF 19           	ADD HL,DE
 8758 B0F0 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
 8759 B0F3 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
 8760 B0F6 31 31 31     PSP_	LD SP,#3131
 8761 B0F9 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
 8762 B0FC CD 34 AC     	CALL PTDECOD
 8763 B0FF FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
 8764 B102 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
 8765 B105
 8766 B105 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
 8767 B108 20 12        	JR NZ,PL1C
 8768 B10A 11 C8 FF     	LD DE,VRS.ChanB+12-100
 8769 B10D FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
 8770 B110 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
 8771 B113 CD 34 AC     	CALL PTDECOD
 8772 B116 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
 8773 B119 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
 8774 B11C
 8775 B11C FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
 8776 B11F 20 12        	JR NZ,PL1D
 8777 B121 11 E5 FF     	LD DE,VRS.ChanC+12-100
 8778 B124 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
 8779 B127 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
 8780 B12A CD 34 AC     	CALL PTDECOD
 8781 B12D FD 71 02     	LD (IY-100+VRS.AdInPtC),C
 8782 B130 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
 8783 B133
 8784 B133 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
 8785 B136 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
 8786 B139
 8787 B139 11 9F FF     PL2	LD DE,VRS.ChanA-100
 8788 B13C FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
 8789 B13F FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
 8790 B142 CD 0C AF     	CALL CHREGS
 8791 B145 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
 8792 B148 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
 8793 B14B              Ampl	EQU $+1
 8794 B14B 3E 3E        	LD A,#3E
 8795 B14D FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 8796 B150 11 BC FF     	LD DE,VRS.ChanB-100
 8797 B153 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
 8798 B156 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
 8799 B159 CD 0C AF     	CALL CHREGS
 8800 B15C FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
 8801 B15F FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
 8802 B162 3A 4C B1     	LD A,(Ampl)
 8803 B165 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 8804 B168 11 D9 FF     	LD DE,VRS.ChanC-100
 8805 B16B FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
 8806 B16E FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
 8807 B171 CD 0C AF     	CALL CHREGS
 8808 B174 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
 8809 B177 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
 8810 B17A 3A 4C B1     	LD A,(Ampl)
 8811 B17D FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 8812 B180
 8813 B180 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
 8814 B183 FD 86 11     	ADD (IY-100+VRS.AddToNs)
 8815 B186 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
 8816 B189
 8817 B189 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
 8818 B18C 5F           	LD E,A
 8819 B18D 87           	ADD A,A
 8820 B18E 9F           	SBC A,A
 8821 B18F 57           	LD D,A
 8822 B190 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
 8823 B193 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
 8824 B196 19           	ADD HL,DE
 8825 B197 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
 8826 B19A FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
 8827 B19D 19           	ADD HL,DE
 8828 B19E FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
 8829 B1A1 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
 8830 B1A4
 8831 B1A4 AF           	XOR A
 8832 B1A5 FD B6 0F     	OR (IY-100+VRS.CurEDel)
 8833 B1A8 C8           	RET Z
 8834 B1A9 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
 8835 B1AC C0           	RET NZ
 8836 B1AD FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
 8837 B1B0 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 8838 B1B3 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
 8839 B1B6 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
 8840 B1B9 19           	ADD HL,DE
 8841 B1BA C3 26 AC     	JP SETESLD
 8842 B1BD
 8843 B1BD FD 21 F5 B2  PLAY    LD IY,VARS1+100
 8844 B1C1 CD 83 B0     	CALL PLAY_
 8845 B1C4 3A 90 B2     	LD A,(is_ts)
 8846 B1C7 A7           	AND A
 8847 B1C8 28 07        	JR Z,PL_nts
 8848 B1CA FD 21 7C B3  	LD IY,VARS2+100
 8849 B1CE CD 83 B0     	CALL PLAY_
 8850 B1D1              PL_nts
 8851 B1D1              	IF Basic
 8852 B1D1 FD 21 3A 5C  	LD IY,#5C3A
 8853 B1D5              	ENDIF
 8854 B1D5
 8855 B1D5 01 FD FF     ROUT	LD BC,#FFFD
 8856 B1D8 3A 90 B2     	LD A,(is_ts)
 8857 B1DB A7           	AND A
 8858 B1DC 28 02        	JR Z,r_nts ;keep old standard
 8859 B1DE ED 41        	OUT (C),B
 8860 B1E0 08           r_nts	EX AF,AF'
 8861 B1E1
 8862 B1E1              	IF ACBBAC
 8863 B1E1 ~            	LD IX,VARS1+VRS.AYREGS
 8864 B1E1              	ELSE
 8865 B1E1 21 0A B3     	LD HL,VARS1+VRS.AYREGS
 8866 B1E4              	ENDIF
 8867 B1E4
 8868 B1E4 CD F0 B1     	CALL ROUT_
 8869 B1E7 08           	EX AF,AF'
 8870 B1E8 C8           	RET Z
 8871 B1E9 42           	LD B,D
 8872 B1EA 2F           	CPL
 8873 B1EB ED 79        	OUT (C),A
 8874 B1ED
 8875 B1ED              	IF ACBBAC
 8876 B1ED ~            	LD IX,VARS2+VRS.AYREGS
 8877 B1ED              	ELSE
 8878 B1ED 21 91 B3     	LD HL,VARS2+VRS.AYREGS
 8879 B1F0              	ENDIF
 8880 B1F0
 8881 B1F0              ROUT_
 8882 B1F0              	IF ACBBAC
 8883 B1F0 ~            	LD A,(SETUP)
 8884 B1F0 ~            	AND 12
 8885 B1F0 ~            	JR Z,ABC
 8886 B1F0 ~            	ADD A,CHTABLE
 8887 B1F0 ~            	LD E,A
 8888 B1F0 ~            	ADC A,CHTABLE/256
 8889 B1F0 ~            	SUB E
 8890 B1F0 ~            	LD D,A
 8891 B1F0 ~            	LD B,0
 8892 B1F0 ~            	PUSH IX
 8893 B1F0 ~            	POP HL
 8894 B1F0 ~            	LD A,(DE)
 8895 B1F0 ~            	INC DE
 8896 B1F0 ~            	LD C,A
 8897 B1F0 ~            	ADD HL,BC
 8898 B1F0 ~            	LD A,(IX+TonB)
 8899 B1F0 ~            	LD C,(HL)
 8900 B1F0 ~            	LD (IX+TonB),C
 8901 B1F0 ~            	LD (HL),A
 8902 B1F0 ~            	INC HL
 8903 B1F0 ~            	LD A,(IX+TonB+1)
 8904 B1F0 ~            	LD C,(HL)
 8905 B1F0 ~            	LD (IX+TonB+1),C
 8906 B1F0 ~            	LD (HL),A
 8907 B1F0 ~            	LD A,(DE)
 8908 B1F0 ~            	INC DE
 8909 B1F0 ~            	LD C,A
 8910 B1F0 ~            	ADD HL,BC
 8911 B1F0 ~            	LD A,(IX+AmplB)
 8912 B1F0 ~            	LD C,(HL)
 8913 B1F0 ~            	LD (IX+AmplB),C
 8914 B1F0 ~            	LD (HL),A
 8915 B1F0 ~            	LD A,(DE)
 8916 B1F0 ~            	INC DE
 8917 B1F0 ~            	LD (RxCA1),A
 8918 B1F0 ~            	XOR 8
 8919 B1F0 ~            	LD (RxCA2),A
 8920 B1F0 ~            	LD A,(DE)
 8921 B1F0 ~            	AND (IX+Mixer)
 8922 B1F0 ~            	LD E,A
 8923 B1F0 ~            	LD A,(IX+Mixer)
 8924 B1F0 ~            RxCA1	DB #E6
 8925 B1F0 ~            	AND %010010
 8926 B1F0 ~            	OR E
 8927 B1F0 ~            	LD E,A
 8928 B1F0 ~            	LD A,(IX+Mixer)
 8929 B1F0 ~            	AND %010010
 8930 B1F0 ~            RxCA2	OR E
 8931 B1F0 ~            	OR E
 8932 B1F0 ~            	LD (IX+Mixer),A
 8933 B1F0 ~            ABC
 8934 B1F0              	ENDIF
 8935 B1F0
 8936 B1F0 AF           	XOR A
 8937 B1F1 11 BF FF     	LD DE,#FFBF
 8938 B1F4
 8939 B1F4              	IF ACBBAC
 8940 B1F4 ~            	LD BC,#FFFD
 8941 B1F4 ~            	PUSH IX
 8942 B1F4 ~            	POP HL
 8943 B1F4              	ENDIF
 8944 B1F4
 8945 B1F4 ED 79        LOUT	OUT (C),A
 8946 B1F6 43           	LD B,E
 8947 B1F7 ED A3        	OUTI
 8948 B1F9 42           	LD B,D
 8949 B1FA 3C           	INC A
 8950 B1FB FE 0D        	CP 13
 8951 B1FD 20 F5        	JR NZ,LOUT
 8952 B1FF ED 79        	OUT (C),A
 8953 B201 7E           	LD A,(HL)
 8954 B202 A7           	AND A
 8955 B203 F8           	RET M
 8956 B204 43           	LD B,E
 8957 B205 ED 79        	OUT (C),A
 8958 B207 C9           	RET
 8959 B208
 8960 B208              	IF ACBBAC
 8961 B208 ~            CHTABLE	EQU $-4
 8962 B208 ~            	DB 4,5,15,%001001,0,7,7,%100100
 8963 B208              	ENDIF
 8964 B208
 8965 B208 64           NT_DATA	DB (T_NEW_0-T1_)*2
 8966 B209 2A           	DB TCNEW_0-T_
 8967 B20A 65           	DB (T_OLD_0-T1_)*2+1
 8968 B20B 00           	DB TCOLD_0-T_
 8969 B20C 01           	DB (T_NEW_1-T1_)*2+1
 8970 B20D 0C           	DB TCNEW_1-T_
 8971 B20E 01           	DB (T_OLD_1-T1_)*2+1
 8972 B20F 0C           	DB TCOLD_1-T_
 8973 B210 94           	DB (T_NEW_2-T1_)*2
 8974 B211 35           	DB TCNEW_2-T_
 8975 B212 30           	DB (T_OLD_2-T1_)*2
 8976 B213 0E           	DB TCOLD_2-T_
 8977 B214 60           	DB (T_NEW_3-T1_)*2
 8978 B215 20           	DB TCNEW_3-T_
 8979 B216 60           	DB (T_OLD_3-T1_)*2
 8980 B217 21           	DB TCOLD_3-T_
 8981 B218
 8982 B218              T_
 8983 B218
 8984 B218 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
 8984 B21C 0D 0F 13 15
 8985 B220 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
 8986 B224 5D 00        TCOLD_1	DB #5C+1,0
 8987 B226 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
 8987 B22A 5F 71 82 8C
 8987 B22E 9C
 8988 B22F 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
 8988 B233 AA AC AE AE
 8988 B237 00
 8989 B238 57           TCNEW_3	DB #56+1
 8990 B239 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
 8990 B23D 2D 2F 33 BF
 8990 B241 00
 8991 B242 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
 8991 B246 2B 2D 31 55
 8992 B24A BD BF 00     	DB #BC+1,#BE+1,0
 8993 B24D              TCNEW_1 EQU TCOLD_1
 8994 B24D 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
 8994 B251 2B 3B 4D 5F
 8995 B255 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
 8996 B259
 8997 B259              PT3EMPTYORN EQU $-1
 8998 B259 01 00        	DB 1,0
 8999 B25B
 9000 B25B              ;first 12 values of tone tables (packed)
 9001 B25B
NextPlayer.asm(9002): warning: value 0xDD8 is truncated to 8bit value: 0xD8
 9002 B25B 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
 9003 B25D 69           	DB #0755-#06EC
 9004 B25E 70           	DB #07C5-#0755
 9005 B25F 76           	DB #083B-#07C5
 9006 B260 7D           	DB #08B8-#083B
 9007 B261 85           	DB #093D-#08B8
 9008 B262 8D           	DB #09CA-#093D
 9009 B263 95           	DB #0A5F-#09CA
 9010 B264 9D           	DB #0AFC-#0A5F
 9011 B265 A8           	DB #0BA4-#0AFC
 9012 B266 B1           	DB #0C55-#0BA4
 9013 B267 BB           	DB #0D10-#0C55
NextPlayer.asm(9014): warning: value 0xCDA is truncated to 8bit value: 0xDA
 9014 B268 0C DA        	DB #066D*2/256,#066D*2
 9015 B26A 62           	DB #06CF-#066D
 9016 B26B 68           	DB #0737-#06CF
 9017 B26C 6D           	DB #07A4-#0737
 9018 B26D 75           	DB #0819-#07A4
 9019 B26E 7B           	DB #0894-#0819
 9020 B26F 83           	DB #0917-#0894
 9021 B270 8A           	DB #09A1-#0917
 9022 B271 92           	DB #0A33-#09A1
 9023 B272 9C           	DB #0ACF-#0A33
 9024 B273 A4           	DB #0B73-#0ACF
 9025 B274 AF           	DB #0C22-#0B73
 9026 B275 B8           	DB #0CDA-#0C22
NextPlayer.asm(9027): warning: value 0xE08 is truncated to 8bit value: 0x08
 9027 B276 0E 08        	DB #0704*2/256,#0704*2
 9028 B278 6A           	DB #076E-#0704
 9029 B279 72           	DB #07E0-#076E
 9030 B27A 78           	DB #0858-#07E0
 9031 B27B 7E           	DB #08D6-#0858
 9032 B27C 86           	DB #095C-#08D6
 9033 B27D 90           	DB #09EC-#095C
 9034 B27E 96           	DB #0A82-#09EC
 9035 B27F A0           	DB #0B22-#0A82
 9036 B280 AA           	DB #0BCC-#0B22
 9037 B281 B4           	DB #0C80-#0BCC
 9038 B282 BE           	DB #0D3E-#0C80
NextPlayer.asm(9039): warning: value 0xFC0 is truncated to 8bit value: 0xC0
 9039 B283 0F C0        	DB #07E0*2/256,#07E0*2
 9040 B285 78           	DB #0858-#07E0
 9041 B286 88           	DB #08E0-#0858
 9042 B287 80           	DB #0960-#08E0
 9043 B288 90           	DB #09F0-#0960
 9044 B289 98           	DB #0A88-#09F0
 9045 B28A A0           	DB #0B28-#0A88
 9046 B28B B0           	DB #0BD8-#0B28
 9047 B28C A8           	DB #0C80-#0BD8
 9048 B28D E0           	DB #0D60-#0C80
 9049 B28E B0           	DB #0E10-#0D60
 9050 B28F E8           	DB #0EF8-#0E10
 9051 B290
 9052 B290              ;vars from here can be stripped
 9053 B290              ;you can move VARS to any other address
 9054 B290
 9055 B290              VARS
 9056 B290
 9057 B290 00           is_ts	DB 0
 9058 B291
 9059 B291              ;ChannelsVars
 9060 B291              	STRUCT	CHP
 9061 B291 ~            ;reset group
 9062 B291 ~            PsInOr	DB 0
 9063 B291 ~            PsInSm	DB 0
 9064 B291 ~            CrAmSl	DB 0
 9065 B291 ~            CrNsSl	DB 0
 9066 B291 ~            CrEnSl	DB 0
 9067 B291 ~            TSlCnt	DB 0
 9068 B291 ~            CrTnSl	DW 0
 9069 B291 ~            TnAcc	DW 0
 9070 B291 ~            COnOff	DB 0
 9071 B291 ~            ;reset group
 9072 B291 ~
 9073 B291 ~            OnOffD	DB 0
 9074 B291 ~
 9075 B291 ~            ;IX for PTDECOD here (+12)
 9076 B291 ~            OffOnD	DB 0
 9077 B291 ~            OrnPtr	DW 0
 9078 B291 ~            SamPtr	DW 0
 9079 B291 ~            NNtSkp	DB 0
 9080 B291 ~            Note	DB 0
 9081 B291 ~            SlToNt	DB 0
 9082 B291 ~            Env_En	DB 0
 9083 B291 ~            Flags	DB 0
 9084 B291 ~             ;Enabled - 0, SimpleGliss - 2
 9085 B291 ~            TnSlDl	DB 0
 9086 B291 ~            TSlStp	DW 0
 9087 B291 ~            TnDelt	DW 0
 9088 B291 ~            NtSkCn	DB 0
 9089 B291 ~            Volume	DB 0
 9090 B291              	ENDS
 9091 B291
 9092 B291              	STRUCT	VRS
 9093 B291 ~
 9094 B291 ~            ;IF not works in STRUCT in SjASM :(
 9095 B291 ~            ;	IF CurPosCounter
 9096 B291 ~            CurPos	DB 0
 9097 B291 ~            PosSub	DB 0
 9098 B291 ~            ;	ENDIF
 9099 B291 ~
 9100 B291 ~            ModNum	DB 0 ;bit0: ChipNum
 9101 B291 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
 9102 B291 ~
 9103 B291 ~            ChanA	DS CHP
 9104 B291 ~            ChanB	DS CHP
 9105 B291 ~            ChanC	DS CHP
 9106 B291 ~
 9107 B291 ~            ;GlobalVars
 9108 B291 ~            MODADDR	DW 0
 9109 B291 ~            OrnPtrs	DW 0
 9110 B291 ~            SamPtrs	DW 0
 9111 B291 ~            PatsPtr	DW 0
 9112 B291 ~            AdInPtA	DW 0
 9113 B291 ~            AdInPtB	DW 0
 9114 B291 ~            AdInPtC	DW 0
 9115 B291 ~            CrPsPtr	DW 0
 9116 B291 ~            LPosPtr	DW 0
 9117 B291 ~            Delay	DB 0
 9118 B291 ~            DelyCnt	DB 0
 9119 B291 ~            ESldAdd	DW 0
 9120 B291 ~            CurESld	DW 0
 9121 B291 ~            Env_Del	DB 0
 9122 B291 ~            CurEDel	DB 0
 9123 B291 ~            Ns_Base	DB 0
 9124 B291 ~            AddToNs	DB 0
 9125 B291 ~            AddToEn	DB 0
 9126 B291 ~            EnvBase	DW 0
 9127 B291 ~            AYREGS	DS 14
 9128 B291              	ENDS
 9129 B291
 9130 B291 00 00 00...  VARS1	DS VRS
 9131 B318 00 00 00...  VARS2	DS VRS
 9132 B39F
 9133 B39F              VT_	EQU $-16
 9134 B39F 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
 9135 B48F
 9136 B48F              T1_	EQU VT_+16 ;Tone tables data depacked here
 9137 B48F
 9138 B48F              T_OLD_1	EQU T1_
 9139 B48F              T_OLD_2	EQU T_OLD_1+24
 9140 B48F              T_OLD_3	EQU T_OLD_2+24
 9141 B48F              T_OLD_0	EQU T_OLD_3+2
 9142 B48F              T_NEW_0	EQU T_OLD_0
 9143 B48F              T_NEW_1	EQU T_OLD_1
 9144 B48F              T_NEW_2	EQU T_NEW_0+24
 9145 B48F              T_NEW_3	EQU T_OLD_3
 9146 B48F
 9147 B48F              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
 9148 B48F
 9149 B48F 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
 9150 B54F
 9151 B54F              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
 9152 B54F
 9153 B54F              VARSEND EQU $
 9154 B54F
 9155 B54F              MDLADDR EQU songdata
 9156 B54F
 9157 B54F              ;Release 0 steps:
 9158 B54F              ;04/21/2007
 9159 B54F              ;Works start (PTxPlay adaptation); first beta.
 9160 B54F              ;04/22/2007
 9161 B54F              ;Job finished; beta-testing.
 9162 B54F              ;04/23/2007
 9163 B54F              ;PT v3.7 TS mode corrected (after AlCo remarks).
 9164 B54F              ;04/29/2007
 9165 B54F              ;Added 1.XX and 2.XX special commands interpretation for PT3
 9166 B54F              ;modules of v3.7+.
 9167 B54F
 9168 B54F              ;Size (minimal build for ZX Spectrum):
 9169 B54F              ;Code block #908 bytes
 9170 B54F              ;Variables #2BF bytes (can be stripped)
 9171 B54F              ;Total size #908+#2BF=#BC7 (3015) bytes
 9172 B54F              	ENDMODULE
 9173 B54F              ;***************************
 9174 B54F              ;***************************
 9175 B54F              ;***************************
 9176 B54F              ;***************************
 9177 B54F              ;***************************
 9178 B54F              ;***************************
 9179 B54F              ;***************************
 9180 B54F              ;***************************
 9181 B54F              ;***************************
 9182 B54F              ;***************************
 9183 B54F
 9184 B54F
 9185 B54F              			module stp
 9186 B54F              @NULL = 0
 9187 B54F              ;------------------------------------------------------------------------------
 9188 B54F 21 0E BD     music_init:		ld	hl,songdata
 9189 B552 22 07 B6     music_init0:	ld	(module_addr+1),hl
 9190 B555 3E FC        		ld	a,#FC
 9191 B557 32 80 BA     		ld	(ChA.smppos+1),a
 9192 B55A 32 F2 BA     		ld	(ChB.smppos+1),a
 9193 B55D 32 67 BB     		ld	(ChC.smppos+1),a
 9194 B560 7E           		ld	a,(hl)
 9195 B561 23           		inc	hl
 9196 B562 32 99 B6     		ld	(speed+1),a
 9197 B565 CD 01 B6     		call	add_offset.de
 9198 B568 7E           		ld	a,(hl)
 9199 B569 32 4E B6     		ld	(song_length+1),a
 9200 B56C 23           		inc	hl
 9201 B56D 7E           		ld	a,(hl)
 9202 B56E 32 5D B6     		ld	(loop_position+1),a
 9203 B571 23           		inc	hl
 9204 B572 22 63 B6     		ld	(positions+1),hl
 9205 B575 CD 00 B6     		call	add_offset
 9206 B578 22 6B B6     		ld	(patterns+1),hl
 9207 B57B E5           		push	hl
 9208 B57C CD 00 B6     		call	add_offset
 9209 B57F 22 17 B9     		ld	(ChA.ornoffs+1),hl
 9210 B582 22 30 B8     		ld	(ChB.ornoffs+1),hl
 9211 B585 22 4B B7     		ld	(ChC.ornoffs+1),hl
 9212 B588 CD 00 B6     		call	add_offset
 9213 B58B 22 BA B8     		ld	(ChA.smpoffs+1),hl
 9214 B58E 22 D3 B7     		ld	(ChB.smpoffs+1),hl
 9215 B591 22 FE B6     		ld	(ChC.smpoffs+1),hl
 9216 B594 EB           		ex	de,hl
 9217 B595 7E           		ld	a,(hl)
 9218 B596 36 00        		ld	(hl),0
 9219 B598 E1           		pop	hl
 9220 B599 B7           		or	a
 9221 B59A 28 0D        		jr	z,.noreloc
 9222 B59C
 9223 B59C CD 01 B6     .relocator:	call	add_offset.de
 9224 B59F EB           		ex	de,hl
 9225 B5A0 2B           		dec	hl
 9226 B5A1 72           		ld	(hl),d
 9227 B5A2 2B           		dec	hl
 9228 B5A3 73           		ld	(hl),e
 9229 B5A4 23           		inc	hl
 9230 B5A5 23           		inc	hl
 9231 B5A6 3D           		dec	a
 9232 B5A7 20 F3        		jr	nz,.relocator
 9233 B5A9
 9234 B5A9 21 FC BC     .noreloc:	ld	hl,empty_pattern
 9235 B5AC 0E 03        		ld	c,3
 9236 B5AE 22 5A B8     		ld	(ChA.datptr+1),hl
 9237 B5B1 22 73 B7     		ld	(ChB.datptr+1),hl
 9238 B5B4 22 A0 B6     		ld	(ChC.datptr+1),hl
 9239 B5B7 67           		ld	h,a
 9240 B5B8 6F           		ld	l,a
 9241 B5B9 22 BA B9     		ld	(ChA.Xportamnt+1),hl
 9242 B5BC 22 76 B9     		ld	(ChB.Xportamnt+1),hl
 9243 B5BF 22 B4 B9     		ld	(ChA.Xpitch+1),hl
 9244 B5C2 22 70 B9     		ld	(ChB.Xpitch+1),hl
 9245 B5C5 32 90 B6     		ld	(ChC.playback+2),a
 9246 B5C8
 9247 B5C8 32 13 BA     		ld	(chkfadeout+1),a
 9248 B5CB 32 29 BA     		ld	(apply_volume+1),a
 9249 B5CE 32 AA BA     		ld	(ChA.attn+1),a
 9250 B5D1 32 1C BB     		ld	(ChB.attn+1),a
 9251 B5D4 32 91 BB     		ld	(ChC.attn+1),a
 9252 B5D7 3D           		dec	a
 9253 B5D8 32 4B B6     		ld	(current_pos+1),a
 9254 B5DB 21 26 A2     		ld	hl,music_setup
 9255 B5DE CB BE        		res	7,(hl)
 9256 B5E0
 9257 B5E0 AF           music_mute:	xor	a
 9258 B5E1 32 CF BB     		ld	(AYREG_EnvSh+1),a
 9259 B5E4 21 01 BD     		ld	hl,AYREG_TonA
 9260 B5E7 06 0D        		ld	b,#0D
 9261 B5E9 77           .loopregs:	ld	(hl),a
 9262 B5EA 23           		inc	hl
 9263 B5EB 10 FC        		djnz	.loopregs
 9264 B5ED 79           		ld	a,c
 9265 B5EE 32 0C BD     		ld	(tempocnt_0),a
 9266 B5F1 01 FD FF     		ld	bc,#FFFD
 9267 B5F4 3E 0C        		ld	a,#0C
 9268 B5F6 ED 79        		out	(c),a
 9269 B5F8 AF           		xor	a
 9270 B5F9 06 BF        		ld	b,#BF
 9271 B5FB ED 79        		out	(c),a
 9272 B5FD C3 C1 BB     		jp	outay
 9273 B600
 9274 B600 EB           add_offset	ex	de,hl
 9275 B601 5E           .de		ld	e,(hl)
 9276 B602 23           		inc	hl
 9277 B603 56           		ld	d,(hl)
 9278 B604 23           		inc	hl
 9279 B605 EB           		ex	de,hl
 9280 B606 01 00 00     module_addr:	ld	bc,0
 9281 B609 09           		add	hl,bc
 9282 B60A C9           		ret
 9283 B60B
 9284 B60B              ; ---------------------------------------------------------------------------
 9285 B60B 21 26 A2     resetfadeout:	ld	hl,music_setup
 9286 B60E CB FE        noloop:		set	7,(hl)
 9287 B610 AF           		xor	a
 9288 B611 32 07 BD     		ld	(AYREG_AmplA),a
 9289 B614 32 08 BD     		ld	(AYREG_AmplB),a
 9290 B617 32 09 BD     		ld	(AYREG_AmplC),a
 9291 B61A 32 CF BB     		ld	(AYREG_EnvSh+1),a
 9292 B61D 3D           		dec	a
 9293 B61E 32 0C BD     		ld	(tempocnt_0),a
 9294 B621 32 13 BA     		ld	(chkfadeout+1),a
 9295 B624 DD 2E 3F     		ld	xl,#3F
 9296 B627 C3 BE BB     		jp	retsp
 9297 B62A
 9298 B62A 3E 30        enablefade:	ld	a,48
 9299 B62C 32 13 BA     forcefade:	ld	(chkfadeout+1),a
 9300 B62F 32 1F BA     		ld	(countfadeout+1),a
 9301 B632 32 52 BA     		ld	(divfadeout+1),a
 9302 B635 AF           		xor	a
 9303 B636 32 29 BA     		ld	(apply_volume+1),a
 9304 B639 18 21        		jr	loop_position
 9305 B63B
 9306 B63B              ; ---------------------------------------------------------------------------
 9307 B63B 2A 73 B7     new_position:	ld	hl,(ChB.datptr+1)
 9308 B63E B6           		or	(hl)
 9309 B63F C2 12 BA     		jp	nz,chkfadeout
 9310 B642 2A A0 B6     		ld	hl,(ChC.datptr+1)
 9311 B645 B6           		or	(hl)
 9312 B646 C2 12 BA     		jp	nz,chkfadeout
 9313 B649 47           		ld	b,a
 9314 B64A 3E 00        current_pos:	ld	a,0
 9315 B64C 3C           		inc	a
 9316 B64D FE 00        song_length:	cp	0
 9317 B64F 20 0D        		jr	nz,song_continue
 9318 B651 21 26 A2     		ld	hl,music_setup
 9319 B654 CB 4E        		bit	1,(hl)
 9320 B656 20 D2        		jr	nz,enablefade
 9321 B658 CB 46        		bit	0,(hl)
 9322 B65A 20 B2        		jr	nz,noloop
 9323 B65C 3E 00        loop_position:	ld	a,0
 9324 B65E 32 4B B6     song_continue:	ld	(current_pos+1),a
 9325 B661 4F           		ld	c,a
 9326 B662
 9327 B662 21 00 00     positions:	ld	hl,NULL
 9328 B665 09           		add	hl,bc
 9329 B666 09           		add	hl,bc
 9330 B667 4E           		ld	c,(hl)
 9331 B668 23           		inc	hl
 9332 B669 7E           		ld	a,(hl)
 9333 B66A
 9334 B66A 21 00 00     patterns:	ld	hl,NULL
 9335 B66D 09           		add	hl,bc
 9336 B66E F9           		ld	sp,hl
 9337 B66F E1           		pop	hl
 9338 B670 22 5A B8     		ld	(ChA.datptr+1),hl
 9339 B673 E1           		pop	hl
 9340 B674 22 73 B7     		ld	(ChB.datptr+1),hl
 9341 B677 E1           		pop	hl
 9342 B678 22 A0 B6     		ld	(ChC.datptr+1),hl
 9343 B67B C6 60        		add	a,#60
 9344 B67D 32 90 B6     		ld	(ChC.playback+2),a
 9345 B680 47           		ld	b,a
 9346 B681 0E F0        		ld	c,#F0
 9347 B683 C3 59 B8     		jp	ChA.datptr
 9348 B686
 9349 B686              ; ----------------------------------------------------------------------------
 9350 B686 F3           music_play:	di
 9351 B687 ED 73 BF BB  		ld	(retsp+1),sp
 9352 B68B 16 00        		ld	d,0
 9353 B68D D9           		exx
 9354 B68E 01 F0 60     ChC.playback:	ld	bc,#60F0
 9355 B691 21 0C BD     		ld	hl,tempocnt_0
 9356 B694 35           		dec	(hl)
 9357 B695 C2 66 B7     		jp	nz,ChB.playback
 9358 B698 36 00        @speed:		ld	(hl),0
 9359 B69A 23           		inc	hl
 9360 B69B 35           		dec	(hl)
 9361 B69C F2 63 B9     		jp	p,ChB.Xsmpptr
 9362 B69F 21 00 00     ChC.datptr:	ld	hl,NULL
 9363 B6A2 B6           		or	(hl)
 9364 B6A3 CA 63 B9     		jp	z,ChB.Xsmpptr
 9365 B6A6 7E           ChC.readpatt:	ld	a,(hl)
 9366 B6A7 23           		inc	hl
 9367 B6A8 FE C0        		cp	#C0
 9368 B6AA 38 0E        		jr	c,ChC.nocmd
 9369 B6AC 91           		sub	c
 9370 B6AD 30 38        		jr	nc,ChC.setvol
 9371 B6AF 91           		sub	c
 9372 B6B0 D2 5B B9     		jp	nc,ChC.nop
 9373 B6B3 91           		sub	c
 9374 B6B4 30 39        		jr	nc,ChC.setrst
 9375 B6B6 91           		sub	c
 9376 B6B7 C3 1D B7     		jp	ChC.setenv
 9377 B6BA
 9378 B6BA D6 80        ChC.nocmd:	sub	#80
 9379 B6BC 30 59        		jr	nc,ChC.setspd
 9380 B6BE 91           		sub	c
 9381 B6BF D2 42 B7     		jp	nc,ChC.setorn
 9382 B6C2 99           		sbc	a,c
 9383 B6C3 30 35        		jr	nc,ChC.setsmp
 9384 B6C5 80           		add	a,b
 9385 B6C6 32 5D BB     		ld	(ChC.note+1),a
 9386 B6C9 22 A0 B6     		ld	(ChC.datptr+1),hl
 9387 B6CC AF           		xor	a
 9388 B6CD 32 67 BB     		ld	(ChC.smppos+1),a
 9389 B6D0 32 4B BB     		ld	(ChC.ornpos+1),a
 9390 B6D3 6F           		ld	l,a
 9391 B6D4 67           		ld	h,a
 9392 B6D5 22 AB BB     		ld	(ChC.pitch+1),hl
 9393 B6D8 C3 5E B9     		jp	ChC.exit
 9394 B6DB
 9395 B6DB 7E           ChC.setport:	ld	a,(hl)
 9396 B6DC 23           		inc	hl
 9397 B6DD 32 AE BB     		ld	(ChC.portamnt+1),a
 9398 B6E0 17           		rla
 9399 B6E1 9F           		sbc	a,a
 9400 B6E2 32 AF BB     		ld	(ChC.portamnt+2),a
 9401 B6E5 18 BF        		jr	ChC.readpatt
 9402 B6E7
 9403 B6E7 28 F2        ChC.setvol:	jr	z,ChC.setport
 9404 B6E9 3D           		dec	a
 9405 B6EA 32 85 BB     		ld	(ChC.volume+1),a
 9406 B6ED 18 B7        		jr	ChC.readpatt
 9407 B6EF
 9408 B6EF 3E FC        ChC.setrst:	ld	a,#FC
 9409 B6F1 32 67 BB     		ld	(ChC.smppos+1),a
 9410 B6F4 22 A0 B6     		ld	(ChC.datptr+1),hl
 9411 B6F7 C3 5E B9     		jp	ChC.exit
 9412 B6FA
 9413 B6FA 87           ChC.setsmp:	add	a,a
 9414 B6FB D9           		exx
 9415 B6FC 5F           		ld	e,a
 9416 B6FD 21 00 00     ChC.smpoffs:	ld	hl,NULL
 9417 B700 19           		add	hl,de
 9418 B701 F9           		ld	sp,hl
 9419 B702 E1           		pop	hl
 9420 B703 7E           		ld	a,(hl)
 9421 B704 87           		add	a,a
 9422 B705 87           		add	a,a
 9423 B706 32 78 BB     		ld	(ChC.smploop+1),a
 9424 B709 23           		inc	hl
 9425 B70A 7E           		ld	a,(hl)
 9426 B70B 87           		add	a,a
 9427 B70C 87           		add	a,a
 9428 B70D 32 74 BB     		ld	(ChC.smplen+1),a
 9429 B710 22 69 BB     		ld	(ChC.smpptr+1),hl
 9430 B713 D9           		exx
 9431 B714 C3 A6 B6     		jp	ChC.readpatt
 9432 B717
 9433 B717 32 5F B9     ChC.setspd:	ld	(ChC.exit+1),a
 9434 B71A C3 A6 B6     		jp	ChC.readpatt
 9435 B71D
 9436 B71D 32 EC B9     ChC.setenv:	ld	(env.shape+1),a
 9437 B720 3E 1F        		ld	a,#1F
 9438 B722 32 97 BB     		ld	(ChC.ampl+1),a
 9439 B725 7E           		ld	a,(hl)
 9440 B726 23           		inc	hl
 9441 B727 32 F1 B9     		ld	(env.period+1),a
 9442 B72A 11 F9 BC     		ld	de,empty_orn
 9443 B72D ED 53 4E BB  		ld	(ChC.ornptr+1),de
 9444 B731 AF           		xor	a
 9445 B732 32 58 BB     		ld	(ChC.ornloop+1),a
 9446 B735 32 AE BB     		ld	(ChC.portamnt+1),a
 9447 B738 32 AF BB     		ld	(ChC.portamnt+2),a
 9448 B73B 3C           		inc	a
 9449 B73C 32 54 BB     		ld	(ChC.ornlen+1),a
 9450 B73F C3 A6 B6     		jp	ChC.readpatt
 9451 B742
 9452 B742 87           ChC.setorn:	add	a,a
 9453 B743 D9           		exx
 9454 B744 5F           		ld	e,a
 9455 B745 3E 0F        		ld	a,#0F
 9456 B747 32 97 BB     		ld	(ChC.ampl+1),a
 9457 B74A 21 00 00     ChC.ornoffs:	ld	hl,NULL
 9458 B74D 19           		add	hl,de
 9459 B74E F9           		ld	sp,hl
 9460 B74F E1           		pop	hl
 9461 B750 7E           		ld	a,(hl)
 9462 B751 32 58 BB     		ld	(ChC.ornloop+1),a
 9463 B754 23           		inc	hl
 9464 B755 7E           		ld	a,(hl)
 9465 B756 32 54 BB     		ld	(ChC.ornlen+1),a
 9466 B759 23           		inc	hl
 9467 B75A 22 4E BB     		ld	(ChC.ornptr+1),hl
 9468 B75D 6A           		ld	l,d
 9469 B75E 62           		ld	h,d
 9470 B75F 22 AE BB     		ld	(ChC.portamnt+1),hl
 9471 B762 D9           		exx
 9472 B763 C3 A6 B6     		jp	ChC.readpatt
 9473 B766
 9474 B766              ; ---------------------------------------------------------------------------
 9475 B766 7E           ChB.playback:	ld	a,(hl)
 9476 B767 3D           		dec	a
 9477 B768 C2 50 B8     		jp	nz,ChA.playback
 9478 B76B 21 0A BD     		ld	hl,tempocnt_2
 9479 B76E 35           		dec	(hl)
 9480 B76F F2 12 BA     		jp	p,chkfadeout
 9481 B772 21 00 00     ChB.datptr:	ld	hl,NULL
 9482 B775 B6           		or	(hl)
 9483 B776 CA 12 BA     		jp	z,chkfadeout
 9484 B779 7E           ChB.readpatt:	ld	a,(hl)
 9485 B77A 23           		inc	hl
 9486 B77B FE C0        		cp	#C0
 9487 B77D 38 0C        		jr	c,ChB.nocmd
 9488 B77F 91           		sub	c
 9489 B780 30 30        		jr	nc,ChB.setvol
 9490 B782 91           		sub	c
 9491 B783 30 35        		jr	nc,ChB.nop
 9492 B785 91           		sub	c
 9493 B786 30 3D        		jr	nc,ChB.setrst
 9494 B788 91           		sub	c
 9495 B789 18 65        		jr	ChB.setenv
 9496 B78B
 9497 B78B D6 80        ChB.nocmd:	sub	#80
 9498 B78D 30 5C        		jr	nc,ChB.setspd
 9499 B78F 91           		sub	c
 9500 B790 D2 27 B8     		jp	nc,ChB.setorn
 9501 B793 99           		sbc	a,c
 9502 B794 30 39        		jr	nc,ChB.setsmp
 9503 B796 80           		add	a,b
 9504 B797 32 9A B9     		ld	(ChB.Xnote+1),a
 9505 B79A 22 73 B7     		ld	(ChB.datptr+1),hl
 9506 B79D AF           		xor	a
 9507 B79E 32 9F B9     		ld	(ChB.Xsmppos+1),a
 9508 B7A1 6F           		ld	l,a
 9509 B7A2 67           		ld	h,a
 9510 B7A3 22 70 B9     		ld	(ChB.Xpitch+1),hl
 9511 B7A6 3E 22        		ld	a,#22
 9512 B7A8 32 72 B9     		ld	(ChB.Xinst1),a
 9513 B7AB 3E 32        		ld	a,#32
 9514 B7AD 32 FC B9     		ld	(ChB.Xinst2),a
 9515 B7B0 18 0B        		jr	ChB.exit
 9516 B7B2
 9517 B7B2 28 66        ChB.setvol:	jr	z,ChB.setport
 9518 B7B4 3D           		dec	a
 9519 B7B5 32 90 B9     		ld	(ChB.Xvolume+1),a
 9520 B7B8 18 BF        		jr	ChB.readpatt
 9521 B7BA
 9522 B7BA 22 73 B7     ChB.nop:	ld	(ChB.datptr+1),hl
 9523 B7BD 3E 00        ChB.exit:	ld	a,0
 9524 B7BF 32 0A BD     		ld	(tempocnt_2),a
 9525 B7C2 C3 12 BA     		jp	chkfadeout
 9526 B7C5
 9527 B7C5 3E FC        ChB.setrst:	ld	a,#FC
 9528 B7C7 32 9F B9     		ld	(ChB.Xsmppos+1),a
 9529 B7CA 22 73 B7     		ld	(ChB.datptr+1),hl
 9530 B7CD 18 EE        		jr	ChB.exit
 9531 B7CF
 9532 B7CF 87           ChB.setsmp:	add	a,a
 9533 B7D0 D9           		exx
 9534 B7D1 5F           		ld	e,a
 9535 B7D2 21 00 00     ChB.smpoffs:	ld	hl,NULL
 9536 B7D5 19           		add	hl,de
 9537 B7D6 F9           		ld	sp,hl
 9538 B7D7 E1           		pop	hl
 9539 B7D8 7E           		ld	a,(hl)
 9540 B7D9 87           		add	a,a
 9541 B7DA 87           		add	a,a
 9542 B7DB 32 8B B9     		ld	(ChB.Xsmploop+1),a
 9543 B7DE 23           		inc	hl
 9544 B7DF 7E           		ld	a,(hl)
 9545 B7E0 87           		add	a,a
 9546 B7E1 87           		add	a,a
 9547 B7E2 32 81 B9     		ld	(ChB.Xsmplen+1),a
 9548 B7E5 22 64 B9     		ld	(ChB.Xsmpptr+1),hl
 9549 B7E8 D9           		exx
 9550 B7E9 18 8E        		jr	ChB.readpatt
 9551 B7EB
 9552 B7EB 32 BE B7     ChB.setspd:	ld	(ChB.exit+1),a
 9553 B7EE 18 89        		jr	ChB.readpatt
 9554 B7F0
 9555 B7F0 32 EC B9     ChB.setenv:	ld	(env.shape+1),a
 9556 B7F3 3E 1F        		ld	a,#1F
 9557 B7F5 32 95 B9     		ld	(ChB.Xampl+1),a
 9558 B7F8 7E           		ld	a,(hl)
 9559 B7F9 23           		inc	hl
 9560 B7FA 32 F1 B9     		ld	(env.period+1),a
 9561 B7FD 11 F9 BC     		ld	de,empty_orn
 9562 B800 ED 53 6A B9  		ld	(ChB.Xornptr+1),de
 9563 B804 3E 22        		ld	a,#22
 9564 B806 32 78 B9     		ld	(ChB.Xinst3),a
 9565 B809 AF           		xor	a
 9566 B80A 32 86 B9     		ld	(ChB.Xornloop+1),a
 9567 B80D 32 76 B9     		ld	(ChB.Xportamnt+1),a
 9568 B810 32 77 B9     		ld	(ChB.Xportamnt+2),a
 9569 B813 3C           		inc	a
 9570 B814 32 7C B9     		ld	(ChB.Xornlen+1),a
 9571 B817 C3 79 B7     		jp	ChB.readpatt
 9572 B81A
 9573 B81A 7E           ChB.setport:	ld	a,(hl)
 9574 B81B 23           		inc	hl
 9575 B81C 32 76 B9     		ld	(ChB.Xportamnt+1),a
 9576 B81F 17           		rla
 9577 B820 9F           		sbc	a,a
 9578 B821 32 77 B9     		ld	(ChB.Xportamnt+2),a
 9579 B824 C3 79 B7     		jp	ChB.readpatt
 9580 B827
 9581 B827 87           ChB.setorn:	add	a,a
 9582 B828 D9           		exx
 9583 B829 5F           		ld	e,a
 9584 B82A 3E 0F        		ld	a,#0F
 9585 B82C 32 95 B9     		ld	(ChB.Xampl+1),a
 9586 B82F 21 00 00     ChB.ornoffs:	ld	hl,NULL
 9587 B832 19           		add	hl,de
 9588 B833 F9           		ld	sp,hl
 9589 B834 E1           		pop	hl
 9590 B835 7E           		ld	a,(hl)
 9591 B836 32 86 B9     		ld	(ChB.Xornloop+1),a
 9592 B839 23           		inc	hl
 9593 B83A 7E           		ld	a,(hl)
 9594 B83B 32 7C B9     		ld	(ChB.Xornlen+1),a
 9595 B83E 23           		inc	hl
 9596 B83F 22 6A B9     		ld	(ChB.Xornptr+1),hl
 9597 B842 6A           		ld	l,d
 9598 B843 62           		ld	h,d
 9599 B844 22 76 B9     		ld	(ChB.Xportamnt+1),hl
 9600 B847 3E 22        		ld	a,#22
 9601 B849 32 78 B9     		ld	(ChB.Xinst3),a
 9602 B84C D9           		exx
 9603 B84D C3 79 B7     		jp	ChB.readpatt
 9604 B850
 9605 B850              ; ---------------------------------------------------------------------------
 9606 B850 3D           ChA.playback:	dec	a
 9607 B851 C2 12 BA     		jp	nz,chkfadeout
 9608 B854 2B           		dec	hl
 9609 B855 35           		dec	(hl)
 9610 B856 F2 12 BA     		jp	p,chkfadeout
 9611 B859 21 00 00     ChA.datptr:	ld	hl,NULL
 9612 B85C B6           		or	(hl)
 9613 B85D CA 3B B6     		jp	z,new_position
 9614 B860 7E           ChA.readpatt:	ld	a,(hl)
 9615 B861 23           		inc	hl
 9616 B862 FE C0        		cp	#C0
 9617 B864 38 0C        		jr	c,ChA.nocmd
 9618 B866 91           		sub	c
 9619 B867 30 30        		jr	nc,ChA.setvol
 9620 B869 91           		sub	c
 9621 B86A 30 35        		jr	nc,ChA.nop
 9622 B86C 91           		sub	c
 9623 B86D 30 3D        		jr	nc,ChA.setrst
 9624 B86F 91           		sub	c
 9625 B870 18 65        		jr	ChA.setenv
 9626 B872
 9627 B872 D6 80        ChA.nocmd:	sub	#80
 9628 B874 30 5C        		jr	nc,ChA.setspd
 9629 B876 91           		sub	c
 9630 B877 D2 0E B9     		jp	nc,ChA.setorn
 9631 B87A 99           		sbc	a,c
 9632 B87B 30 39        		jr	nc,ChA.setsmp
 9633 B87D 80           		add	a,b
 9634 B87E 32 DE B9     		ld	(ChA.Xnote+1),a
 9635 B881 22 5A B8     		ld	(ChA.datptr+1),hl
 9636 B884 AF           		xor	a
 9637 B885 32 E3 B9     		ld	(ChA.Xsmppos+1),a
 9638 B888 6F           		ld	l,a
 9639 B889 67           		ld	h,a
 9640 B88A 22 B4 B9     		ld	(ChA.Xpitch+1),hl
 9641 B88D 3E 22        		ld	a,#22
 9642 B88F 32 B6 B9     		ld	(ChA.Xinst1),a
 9643 B892 3E 32        		ld	a,#32
 9644 B894 32 F9 B9     		ld	(ChA.Xinst2),a
 9645 B897 18 0B        		jr	ChA.exit
 9646 B899
 9647 B899 28 66        ChA.setvol:	jr	z,ChA.setport
 9648 B89B 3D           		dec	a
 9649 B89C 32 D4 B9     		ld	(ChA.Xvolume+1),a
 9650 B89F 18 BF        		jr	ChA.readpatt
 9651 B8A1
 9652 B8A1 22 5A B8     ChA.nop:	ld	(ChA.datptr+1),hl
 9653 B8A4 3E 00        ChA.exit:	ld	a,0
 9654 B8A6 32 0B BD     		ld	(tempocnt_1),a
 9655 B8A9 C3 12 BA     		jp	chkfadeout
 9656 B8AC
 9657 B8AC 3E FC        ChA.setrst:	ld	a,#FC
 9658 B8AE 32 E3 B9     		ld	(ChA.Xsmppos+1),a
 9659 B8B1 22 5A B8     		ld	(ChA.datptr+1),hl
 9660 B8B4 18 EE        		jr	ChA.exit
 9661 B8B6
 9662 B8B6 87           ChA.setsmp:	add	a,a
 9663 B8B7 D9           		exx
 9664 B8B8 5F           		ld	e,a
 9665 B8B9 21 00 00     ChA.smpoffs:	ld	hl,NULL
 9666 B8BC 19           		add	hl,de
 9667 B8BD F9           		ld	sp,hl
 9668 B8BE E1           		pop	hl
 9669 B8BF 7E           		ld	a,(hl)
 9670 B8C0 87           		add	a,a
 9671 B8C1 87           		add	a,a
 9672 B8C2 32 CF B9     		ld	(ChA.Xsmploop+1),a
 9673 B8C5 23           		inc	hl
 9674 B8C6 7E           		ld	a,(hl)
 9675 B8C7 87           		add	a,a
 9676 B8C8 87           		add	a,a
 9677 B8C9 32 C5 B9     		ld	(ChA.Xsmplen+1),a
 9678 B8CC 22 A8 B9     		ld	(ChA.Xsmpptr+1),hl
 9679 B8CF D9           		exx
 9680 B8D0 18 8E        		jr	ChA.readpatt
 9681 B8D2
 9682 B8D2 32 A5 B8     ChA.setspd:	ld	(ChA.exit+1),a
 9683 B8D5 18 89        		jr	ChA.readpatt
 9684 B8D7
 9685 B8D7 32 EC B9     ChA.setenv:	ld	(env.shape+1),a
 9686 B8DA 3E 1F        		ld	a,#1F
 9687 B8DC 32 D9 B9     		ld	(ChA.Xampl+1),a
 9688 B8DF 7E           		ld	a,(hl)
 9689 B8E0 23           		inc	hl
 9690 B8E1 32 F1 B9     		ld	(env.period+1),a
 9691 B8E4 11 F9 BC     		ld	de,empty_orn
 9692 B8E7 ED 53 AE B9  		ld	(ChA.Xornptr+1),de
 9693 B8EB 3E 22        		ld	a,#22
 9694 B8ED 32 BC B9     		ld	(ChA.Xinst3),a
 9695 B8F0 AF           		xor	a
 9696 B8F1 32 CA B9     		ld	(ChA.Xornloop+1),a
 9697 B8F4 32 BA B9     		ld	(ChA.Xportamnt+1),a
 9698 B8F7 32 BB B9     		ld	(ChA.Xportamnt+2),a
 9699 B8FA 3C           		inc	a
 9700 B8FB 32 C0 B9     		ld	(ChA.Xornlen+1),a
 9701 B8FE C3 60 B8     		jp	ChA.readpatt
 9702 B901
 9703 B901 7E           ChA.setport:	ld	a,(hl)
 9704 B902 23           		inc	hl
 9705 B903 32 BA B9     		ld	(ChA.Xportamnt+1),a
 9706 B906 17           		rla
 9707 B907 9F           		sbc	a,a
 9708 B908 32 BB B9     		ld	(ChA.Xportamnt+2),a
 9709 B90B C3 60 B8     		jp	ChA.readpatt
 9710 B90E
 9711 B90E 87           ChA.setorn:	add	a,a
 9712 B90F D9           		exx
 9713 B910 5F           		ld	e,a
 9714 B911 3E 0F        		ld	a,#0F
 9715 B913 32 D9 B9     		ld	(ChA.Xampl+1),a
 9716 B916 21 00 00     ChA.ornoffs:	ld	hl,NULL
 9717 B919 19           		add	hl,de
 9718 B91A F9           		ld	sp,hl
 9719 B91B E1           		pop	hl
 9720 B91C 7E           		ld	a,(hl)
 9721 B91D 32 CA B9     		ld	(ChA.Xornloop+1),a
 9722 B920 23           		inc	hl
 9723 B921 7E           		ld	a,(hl)
 9724 B922 32 C0 B9     		ld	(ChA.Xornlen+1),a
 9725 B925 23           		inc	hl
 9726 B926 22 AE B9     		ld	(ChA.Xornptr+1),hl
 9727 B929 6A           		ld	l,d
 9728 B92A 62           		ld	h,d
 9729 B92B 22 BA B9     		ld	(ChA.Xportamnt+1),hl
 9730 B92E 3E 22        		ld	a,#22
 9731 B930 32 BC B9     		ld	(ChA.Xinst3),a
 9732 B933 D9           		exx
 9733 B934 C3 60 B8     		jp	ChA.readpatt
 9734 B937
 9735 B937              ; ---------------------------------------------------------------------------
 9736 B937 AF           ChA.mute:	xor	a
 9737 B938 32 07 BD     		ld	(AYREG_AmplA),a
 9738 B93B DD 2E 09     		ld	xl,9
 9739 B93E C3 D5 BA     		jp	ChB.ornpos
 9740 B941
 9741 B941 AF           ChB.mute:	xor	a
 9742 B942 32 08 BD     		ld	(AYREG_AmplB),a
 9743 B945 DD 7D        		ld	a,xl
 9744 B947 F6 12        		or	#12
 9745 B949 DD 6F        		ld	xl,a
 9746 B94B C3 4A BB     		jp	ChC.ornpos
 9747 B94E
 9748 B94E AF           ChC.mute:	xor	a
 9749 B94F 32 09 BD     		ld	(AYREG_AmplC),a
 9750 B952 DD 7D        		ld	a,xl
 9751 B954 F6 24        		or	#24
 9752 B956 DD 6F        		ld	xl,a
 9753 B958 C3 BE BB     		jp	retsp
 9754 B95B
 9755 B95B              ; ---------------------------------------------------------------------------
 9756 B95B 22 A0 B6     ChC.nop:	ld	(ChC.datptr+1),hl
 9757 B95E 3E 00        ChC.exit:	ld	a,0
 9758 B960 32 0D BD     		ld	(pattstep_cnt),a
 9759 B963 21 00 00     ChB.Xsmpptr:	ld	hl,NULL
 9760 B966 22 F4 BA     		ld	(ChB.smpptr+1),hl
 9761 B969 21 00 00     ChB.Xornptr:	ld	hl,NULL
 9762 B96C 22 D9 BA     		ld	(ChB.ornptr+1),hl
 9763 B96F 21 00 00     ChB.Xpitch:	ld	hl,NULL
 9764 B972 22 37 BB     ChB.Xinst1:	ld	(ChB.pitch+1),hl
 9765 B975 21 00 00     ChB.Xportamnt:	ld	hl,NULL
 9766 B978 22 3A BB     ChB.Xinst3:	ld	(ChB.portamnt+1),hl
 9767 B97B 3E 00        ChB.Xornlen:	ld	a,0
 9768 B97D 32 DF BA     		ld	(ChB.ornlen+1),a
 9769 B980 3E 00        ChB.Xsmplen:	ld	a,0
 9770 B982 32 FF BA     		ld	(ChB.smplen+1),a
 9771 B985 3E 00        ChB.Xornloop:	ld	a,0
 9772 B987 32 E3 BA     		ld	(ChB.ornloop+1),a
 9773 B98A 3E 00        ChB.Xsmploop:	ld	a,0
 9774 B98C 32 03 BB     		ld	(ChB.smploop+1),a
 9775 B98F 3E 00        ChB.Xvolume:	ld	a,0
 9776 B991 32 10 BB     		ld	(ChB.volume+1),a
 9777 B994 3E 0F        ChB.Xampl:	ld	a,#0F
 9778 B996 32 22 BB     		ld	(ChB.ampl+1),a
 9779 B999 3E 00        ChB.Xnote:	ld	a,0
 9780 B99B 32 E8 BA     		ld	(ChB.note+1),a
 9781 B99E 3E 00        ChB.Xsmppos:	ld	a,0
 9782 B9A0 FE 01        		cp	1
 9783 B9A2 28 03        		jr	z,ChA.Xsmpptr
 9784 B9A4 32 F2 BA     		ld	(ChB.smppos+1),a
 9785 B9A7 21 00 00     ChA.Xsmpptr:	ld	hl,NULL
 9786 B9AA 22 82 BA     		ld	(ChA.smpptr+1),hl
 9787 B9AD 21 00 00     ChA.Xornptr:	ld	hl,NULL
 9788 B9B0 22 67 BA     		ld	(ChA.ornptr+1),hl
 9789 B9B3 21 00 00     ChA.Xpitch:	ld	hl,NULL
 9790 B9B6 22 BB BA     ChA.Xinst1:	ld	(ChA.pitch+1),hl
 9791 B9B9 21 00 00     ChA.Xportamnt:	ld	hl,NULL
 9792 B9BC 22 BE BA     ChA.Xinst3:	ld	(ChA.portamnt+1),hl
 9793 B9BF 3E 00        ChA.Xornlen:	ld	a,0
 9794 B9C1 32 6D BA     		ld	(ChA.ornlen+1),a
 9795 B9C4 3E 00        ChA.Xsmplen:	ld	a,0
 9796 B9C6 32 8D BA     		ld	(ChA.smplen+1),a
 9797 B9C9 3E 00        ChA.Xornloop:	ld	a,0
 9798 B9CB 32 71 BA     		ld	(ChA.ornloop+1),a
 9799 B9CE 3E 00        ChA.Xsmploop:	ld	a,0
 9800 B9D0 32 91 BA     		ld	(ChA.smploop+1),a
 9801 B9D3 3E 00        ChA.Xvolume:	ld	a,0
 9802 B9D5 32 9E BA     		ld	(ChA.volume+1),a
 9803 B9D8 3E 0F        ChA.Xampl:	ld	a,#0F
 9804 B9DA 32 B0 BA     		ld	(ChA.ampl+1),a
 9805 B9DD 3E 00        ChA.Xnote:	ld	a,0
 9806 B9DF 32 76 BA     		ld	(ChA.note+1),a
 9807 B9E2 3E 00        ChA.Xsmppos:	ld	a,0
 9808 B9E4 FE 01        		cp	1
 9809 B9E6 28 03        		jr	z,env.shape
 9810 B9E8 32 80 BA     		ld	(ChA.smppos+1),a
 9811 B9EB 3E 00        env.shape:	ld	a,0
 9812 B9ED 32 CF BB     		ld	(AYREG_EnvSh+1),a
 9813 B9F0 3E 00        env.period:	ld	a,0
 9814 B9F2 32 DD BB     		ld	(AYREG_Env+1),a
 9815 B9F5 AF           		xor	a
 9816 B9F6 32 EC B9     		ld	(env.shape+1),a
 9817 B9F9 32 64 BA     ChA.Xinst2:	ld	(ChA.ornpos+1),a
 9818 B9FC 32 D6 BA     ChB.Xinst2:	ld	(ChB.ornpos+1),a
 9819 B9FF 3C           		inc	a
 9820 BA00 32 E3 B9     		ld	(ChA.Xsmppos+1),a
 9821 BA03 32 F9 B9     		ld	(ChA.Xinst2),a
 9822 BA06 32 9F B9     		ld	(ChB.Xsmppos+1),a
 9823 BA09 32 FC B9     		ld	(ChB.Xinst2),a
 9824 BA0C 32 B6 B9     		ld	(ChA.Xinst1),a
 9825 BA0F 32 72 B9     		ld	(ChB.Xinst1),a
 9826 BA12
 9827 BA12              ; ---------------------------------------------------------------------------
 9828 BA12 3E 00        chkfadeout:	ld	a,0
 9829 BA14 B7           		or	a
 9830 BA15 28 4C        		jr	z,ChA.ornpos
 9831 BA17 3A 26 A2     		ld	a,(music_setup)
 9832 BA1A 07           		rlca
 9833 BA1B DA BE BB     		jp	c,retsp
 9834 BA1E 3E 00        countfadeout:	ld	a,0
 9835 BA20 3D           		dec	a
 9836 BA21 32 1F BA     		ld	(countfadeout+1),a
 9837 BA24 20 3D        		jr	nz,ChA.ornpos
 9838 BA26 1E 10        		ld	e,16
 9839 BA28 3E 00        apply_volume:	ld	a,0
 9840 BA2A 3C           		inc	a
 9841 BA2B BB           		cp	e
 9842 BA2C CA 0B B6     		jp	z,resetfadeout
 9843 BA2F 32 29 BA     		ld	(apply_volume+1),a
 9844 BA32 32 AA BA     		ld	(ChA.attn+1),a
 9845 BA35 32 1C BB     		ld	(ChB.attn+1),a
 9846 BA38 32 91 BB     		ld	(ChC.attn+1),a
 9847 BA3B CB 5F        		bit	3,a			; if value of attenuation
 9848 BA3D 28 12        		jr	z,divfadeout		; hits the 8 we turn off
 9849 BA3F AF           		xor	a			; also hw envelopes
 9850 BA40 32 EC B9     		ld	(env.shape+1),a
 9851 BA43 32 CF BB     		ld	(AYREG_EnvSh+1),a
 9852 BA46 7B           		ld	a,e
 9853 BA47 3D           		dec	a
 9854 BA48 32 B0 BA     		ld	(ChA.ampl+1),a
 9855 BA4B 32 22 BB     		ld	(ChB.ampl+1),a
 9856 BA4E 32 97 BB     		ld	(ChC.ampl+1),a
 9857 BA51 3E 00        divfadeout:	ld	a,0
 9858 BA53 CB 3F        		srl	a
 9859 BA55 5F           		ld	e,a
 9860 BA56 CB 3B        		srl	e
 9861 BA58 83           		add	a,e
 9862 BA59 20 01        		jr	nz,divfadeout1
 9863 BA5B 3C           		inc	a
 9864 BA5C 32 52 BA     divfadeout1:	ld	(divfadeout+1),a
 9865 BA5F 87           		add	a,a
 9866 BA60 32 1F BA     		ld	(countfadeout+1),a
 9867 BA63
 9868 BA63 11 00 00     ChA.ornpos:	ld	de,0
 9869 BA66 21 00 00     ChA.ornptr:	ld	hl,NULL
 9870 BA69 19           		add	hl,de
 9871 BA6A 1C           		inc	e
 9872 BA6B 7B           		ld	a,e
 9873 BA6C FE 00        ChA.ornlen:	cp	0
 9874 BA6E 20 02        		jr	nz,ChA.readorn
 9875 BA70 3E 00        ChA.ornloop:	ld	a,0
 9876 BA72 32 64 BA     ChA.readorn:	ld	(ChA.ornpos+1),a
 9877 BA75 3E 00        ChA.note:	ld	a,0
 9878 BA77 86           		add	a,(hl)
 9879 BA78 87           		add	a,a
 9880 BA79 5F           		ld	e,a
 9881 BA7A 21 39 BC     		ld	hl,freqtable
 9882 BA7D 19           		add	hl,de
 9883 BA7E F9           		ld	sp,hl
 9884 BA7F 3E 00        ChA.smppos:	ld	a,0
 9885 BA81 21 00 00     ChA.smpptr:	ld	hl,NULL
 9886 BA84 3C           		inc	a
 9887 BA85 FA 37 B9     		jp	m,ChA.mute
 9888 BA88 5F           		ld	e,a
 9889 BA89 19           		add	hl,de
 9890 BA8A C6 03        		add	a,3
 9891 BA8C FE 00        ChA.smplen:	cp	0
 9892 BA8E 20 02        		jr	nz,ChA.readsmp
 9893 BA90 3E 00        ChA.smploop:	ld	a,0
 9894 BA92 32 80 BA     ChA.readsmp:	ld	(ChA.smppos+1),a
 9895 BA95 C1           		pop	bc
 9896 BA96 F9           		ld	sp,hl
 9897 BA97 D1           		pop	de
 9898 BA98 26 00        		ld	h,0
 9899 BA9A 7B           		ld	a,e
 9900 BA9B E6 0F        		and	#0F
 9901 BA9D D6 00        ChA.volume:	sub	0
 9902 BA9F 6F           		ld	l,a
 9903 BAA0 3F           		ccf
 9904 BAA1 9F           		sbc	a,a
 9905 BAA2 A5           		and	l
 9906 BAA3 CB 3A        		srl	d
 9907 BAA5 30 02        		jr	nc,ChA.attn
 9908 BAA7 CB E4        		set	4,h
 9909 BAA9 D6 00        ChA.attn:	sub	0
 9910 BAAB 30 01        		jr	nc,ChA.attnn
 9911 BAAD AF           		xor	a
 9912 BAAE B4           ChA.attnn:	or	h
 9913 BAAF E6 00        ChA.ampl:	and	0
 9914 BAB1 32 07 BD     		ld	(AYREG_AmplA),a
 9915 BAB4 7B           		ld	a,e
 9916 BAB5 07           		rlca
 9917 BAB6 38 02        		jr	c,ChA.pitch
 9918 BAB8 DD 62        		ld	xh,d
 9919 BABA 21 00 00     ChA.pitch:	ld	hl,NULL
 9920 BABD 11 00 00     ChA.portamnt:	ld	de,0
 9921 BAC0 19           		add	hl,de
 9922 BAC1 22 BB BA     		ld	(ChA.pitch+1),hl
 9923 BAC4 09           		add	hl,bc
 9924 BAC5 C1           		pop	bc
 9925 BAC6 09           		add	hl,bc
 9926 BAC7 07           		rlca
 9927 BAC8 07           		rlca
 9928 BAC9 07           		rlca
 9929 BACA E6 0F        		and	#0F
 9930 BACC DD 6F        		ld	xl,a
 9931 BACE 7C           		ld	a,h
 9932 BACF E6 0F        		and	#0F
 9933 BAD1 67           		ld	h,a
 9934 BAD2 22 01 BD     		ld	(AYREG_TonA),hl
 9935 BAD5
 9936 BAD5 11 00 00     ChB.ornpos:	ld	de,0
 9937 BAD8 21 00 00     ChB.ornptr:	ld	hl,NULL
 9938 BADB 19           		add	hl,de
 9939 BADC 1C           		inc	e
 9940 BADD 7B           		ld	a,e
 9941 BADE FE 00        ChB.ornlen:	cp	0
 9942 BAE0 20 02        		jr	nz,ChB.readorn
 9943 BAE2 3E 00        ChB.ornloop:	ld	a,0
 9944 BAE4 32 D6 BA     ChB.readorn:	ld	(ChB.ornpos+1),a
 9945 BAE7 3E 00        ChB.note:	ld	a,0
 9946 BAE9 86           		add	a,(hl)
 9947 BAEA 87           		add	a,a
 9948 BAEB 5F           		ld	e,a
 9949 BAEC 21 39 BC     		ld	hl,freqtable
 9950 BAEF 19           		add	hl,de
 9951 BAF0 F9           		ld	sp,hl
 9952 BAF1 3E 00        ChB.smppos:	ld	a,NULL
 9953 BAF3 21 00 00     ChB.smpptr:	ld	hl,NULL
 9954 BAF6 3C           		inc	a
 9955 BAF7 FA 41 B9     		jp	m,ChB.mute
 9956 BAFA 5F           		ld	e,a
 9957 BAFB 19           		add	hl,de
 9958 BAFC C6 03        		add	a,3
 9959 BAFE FE 00        ChB.smplen:	cp	0
 9960 BB00 20 02        		jr	nz,ChB.readsmp
 9961 BB02 3E 00        ChB.smploop:	ld	a,0
 9962 BB04 32 F2 BA     ChB.readsmp:	ld	(ChB.smppos+1),a
 9963 BB07 C1           		pop	bc
 9964 BB08 F9           		ld	sp,hl
 9965 BB09 D1           		pop	de
 9966 BB0A 26 00        		ld	h,0
 9967 BB0C 7B           		ld	a,e
 9968 BB0D E6 0F        		and	#0F
 9969 BB0F D6 00        ChB.volume:	sub	0
 9970 BB11 6F           		ld	l,a
 9971 BB12 3F           		ccf
 9972 BB13 9F           		sbc	a,a
 9973 BB14 A5           		and	l
 9974 BB15 CB 3A        		srl	d
 9975 BB17 30 02        		jr	nc,ChB.attn
 9976 BB19 CB E4        		set	4,h
 9977 BB1B D6 00        ChB.attn:	sub	0
 9978 BB1D 30 01        		jr	nc,ChB.attnn
 9979 BB1F AF           		xor	a
 9980 BB20 B4           ChB.attnn:	or	h
 9981 BB21 E6 00        ChB.ampl:	and	0
 9982 BB23 32 08 BD     		ld	(AYREG_AmplB),a
 9983 BB26 7B           		ld	a,e
 9984 BB27 0F           		rrca
 9985 BB28 0F           		rrca
 9986 BB29 0F           		rrca
 9987 BB2A E6 1E        		and	#1E
 9988 BB2C DD B5        		or	xl
 9989 BB2E DD 6F        		ld	xl,a
 9990 BB30 E6 10        		and	#10
 9991 BB32 20 02        		jr	nz,ChB.pitch
 9992 BB34 DD 62        		ld	xh,d
 9993 BB36 21 00 00     ChB.pitch:	ld	hl,NULL
 9994 BB39 11 00 00     ChB.portamnt:	ld	de,0
 9995 BB3C 19           		add	hl,de
 9996 BB3D 22 37 BB     		ld	(ChB.pitch+1),hl
 9997 BB40 09           		add	hl,bc
 9998 BB41 C1           		pop	bc
 9999 BB42 09           		add	hl,bc
10000 BB43 7C           		ld	a,h
10001 BB44 E6 0F        		and	#0F
10002 BB46 67           		ld	h,a
10003 BB47 22 03 BD     		ld	(AYREG_TonB),hl
10004 BB4A
10005 BB4A 11 00 00     ChC.ornpos:	ld	de,0
10006 BB4D 21 00 00     ChC.ornptr:	ld	hl,NULL
10007 BB50 19           		add	hl,de
10008 BB51 1C           		inc	e
10009 BB52 7B           		ld	a,e
10010 BB53 FE 00        ChC.ornlen:	cp	0
10011 BB55 20 02        		jr	nz,ChC.readorn
10012 BB57 3E 00        ChC.ornloop:	ld	a,0
10013 BB59 32 4B BB     ChC.readorn:	ld	(ChC.ornpos+1),a
10014 BB5C 3E 00        ChC.note:	ld	a,0
10015 BB5E 86           		add	a,(hl)
10016 BB5F 87           		add	a,a
10017 BB60 5F           		ld	e,a
10018 BB61 21 39 BC     		ld	hl,freqtable
10019 BB64 19           		add	hl,de
10020 BB65 F9           		ld	sp,hl
10021 BB66 3E 00        ChC.smppos:	ld	a,0
10022 BB68 21 00 00     ChC.smpptr:	ld	hl,NULL
10023 BB6B 3C           		inc	a
10024 BB6C FA 4E B9     		jp	m,ChC.mute
10025 BB6F 5F           		ld	e,a
10026 BB70 19           		add	hl,de
10027 BB71 C6 03        		add	a,3
10028 BB73 FE 00        ChC.smplen:	cp	0
10029 BB75 20 02        		jr	nz,ChC.readsmp
10030 BB77 3E 00        ChC.smploop:	ld	a,0
10031 BB79 32 67 BB     ChC.readsmp:	ld	(ChC.smppos+1),a
10032 BB7C C1           		pop	bc
10033 BB7D F9           		ld	sp,hl
10034 BB7E D1           		pop	de
10035 BB7F 26 00        		ld	h,0
10036 BB81 7B           		ld	a,e
10037 BB82 E6 0F        		and	#0F
10038 BB84 D6 00        ChC.volume:	sub	0
10039 BB86 6F           		ld	l,a
10040 BB87 3F           		ccf
10041 BB88 9F           		sbc	a,a
10042 BB89 A5           		and	l
10043 BB8A CB 3A        		srl	d
10044 BB8C 30 02        		jr	nc,ChC.attn
10045 BB8E CB E4        		set	4,h
10046 BB90 D6 00        ChC.attn:	sub	0
10047 BB92 30 01        		jr	nc,ChC.attnn
10048 BB94 AF           		xor	a
10049 BB95 B4           ChC.attnn:	or	h
10050 BB96 E6 00        ChC.ampl:	and	0
10051 BB98 32 09 BD     		ld	(AYREG_AmplC),a
10052 BB9B 7B           		ld	a,e
10053 BB9C 0F           		rrca
10054 BB9D 0F           		rrca
10055 BB9E E6 3C        		and	#3C
10056 BBA0 DD B5        		or	xl
10057 BBA2 DD 6F        		ld	xl,a
10058 BBA4 E6 20        		and	#20
10059 BBA6 20 02        		jr	nz,ChC.pitch
10060 BBA8 DD 62        		ld	xh,d
10061 BBAA 21 00 00     ChC.pitch:	ld	hl,NULL
10062 BBAD 11 00 00     ChC.portamnt:	ld	de,0
10063 BBB0 19           		add	hl,de
10064 BBB1 22 AB BB     		ld	(ChC.pitch+1),hl
10065 BBB4 09           		add	hl,bc
10066 BBB5 C1           		pop	bc
10067 BBB6 09           		add	hl,bc
10068 BBB7 7C           		ld	a,h
10069 BBB8 E6 0F        		and	#0F
10070 BBBA 67           		ld	h,a
10071 BBBB 22 05 BD     		ld	(AYREG_TonC),hl
10072 BBBE 31 00 00     @retsp:		ld	sp,0
10073 BBC1
10074 BBC1 21 09 BD     outay:		ld	hl,AYREG_AmplC
10075 BBC4 11 BF FF     		ld	de,#FFBF
10076 BBC7 01 FD FF     		ld	bc,#FFFD
10077 BBCA 3E 0D        		ld	a,#0D
10078 BBCC ED 79        		out	(c),a
10079 BBCE 3E 00        AYREG_EnvSh:	ld	a,0
10080 BBD0 B7           		or	a
10081 BBD1 28 0E        		jr	z,noenvelopes
10082 BBD3 43           		ld	b,e
10083 BBD4 ED 79        		out	(c),a
10084 BBD6
10085 BBD6 3E 0B        		ld	a,#0B
10086 BBD8 42           		ld	b,d
10087 BBD9 ED 79        		out	(c),a
10088 BBDB 43           		ld	b,e
10089 BBDC 3E 00        AYREG_Env:	ld	a,0
10090 BBDE ED 79        		out	(c),a
10091 BBE0 42           		ld	b,d
10092 BBE1
10093 BBE1 3E 0A        noenvelopes:	ld	a,#0A
10094 BBE3 ED 79        		out	(c),a
10095 BBE5 43           		ld	b,e
10096 BBE6 ED AB        		outd
10097 BBE8 3D           		dec	a
10098 BBE9 42           		ld	b,d
10099 BBEA ED 79        		out	(c),a
10100 BBEC 43           		ld	b,e
10101 BBED ED AB        		outd
10102 BBEF 3D           		dec	a
10103 BBF0 42           		ld	b,d
10104 BBF1 ED 79        		out	(c),a
10105 BBF3 43           		ld	b,e
10106 BBF4 ED AB        		outd
10107 BBF6 3D           		dec	a
10108 BBF7 42           		ld	b,d
10109 BBF8 ED 79        		out	(c),a
10110 BBFA 43           		ld	b,e
10111 BBFB DD 7D        		ld	a,xl
10112 BBFD ED 79        		out	(c),a
10113 BBFF 3E 06        		ld	a,6
10114 BC01 42           		ld	b,d
10115 BC02 ED 79        		out	(c),a
10116 BC04 43           		ld	b,e
10117 BC05 DD 7C        		ld	a,xh
10118 BC07 ED 79        		out	(c),a
10119 BC09 3E 05        		ld	a,5
10120 BC0B 42           		ld	b,d
10121 BC0C ED 79        		out	(c),a
10122 BC0E 43           		ld	b,e
10123 BC0F ED AB        		outd
10124 BC11 3D           		dec	a
10125 BC12 42           		ld	b,d
10126 BC13 ED 79        		out	(c),a
10127 BC15 43           		ld	b,e
10128 BC16 ED AB        		outd
10129 BC18 3D           		dec	a
10130 BC19 42           		ld	b,d
10131 BC1A ED 79        		out	(c),a
10132 BC1C 43           		ld	b,e
10133 BC1D ED AB        		outd
10134 BC1F 3D           		dec	a
10135 BC20 42           		ld	b,d
10136 BC21 ED 79        		out	(c),a
10137 BC23 43           		ld	b,e
10138 BC24 ED AB        		outd
10139 BC26 3D           		dec	a
10140 BC27 42           		ld	b,d
10141 BC28 ED 79        		out	(c),a
10142 BC2A 43           		ld	b,e
10143 BC2B ED AB        		outd
10144 BC2D 3D           		dec	a
10145 BC2E 42           		ld	b,d
10146 BC2F ED 79        		out	(c),a
10147 BC31 43           		ld	b,e
10148 BC32 ED AB        		outd
10149 BC34 32 CF BB     		ld	(AYREG_EnvSh+1),a
10150 BC37 FB           		ei
10151 BC38 C9           		ret
10152 BC39
10153 BC39              ;------------------------------------------------------------------------------
10154 BC39 F8 0E 10 0E  freqtable	dw	#0EF8, #0E10, #0D60, #0C80, #0BD8, #0B28, #0A88, #09F0
10154 BC3D 60 0D 80 0C
10154 BC41 D8 0B 28 0B
10154 BC45 88 0A F0 09
10155 BC49 60 09 E0 08  		dw	#0960, #08E0, #0858, #07E0, #077C, #0708, #06B0, #0640
10155 BC4D 58 08 E0 07
10155 BC51 7C 07 08 07
10155 BC55 B0 06 40 06
10156 BC59 EC 05 94 05  		dw	#05EC, #0594, #0544, #04F8, #04B0, #0470, #042C, #03F0
10156 BC5D 44 05 F8 04
10156 BC61 B0 04 70 04
10156 BC65 2C 04 F0 03
10157 BC69 BE 03 84 03  		dw	#03BE, #0384, #0358, #0320, #02F6, #02CA, #02A2, #027C
10157 BC6D 58 03 20 03
10157 BC71 F6 02 CA 02
10157 BC75 A2 02 7C 02
10158 BC79 58 02 38 02  		dw	#0258, #0238, #0216, #01F8, #01DF, #01C2, #01AC, #0190
10158 BC7D 16 02 F8 01
10158 BC81 DF 01 C2 01
10158 BC85 AC 01 90 01
10159 BC89 7B 01 65 01  		dw	#017B, #0165, #0151, #013E, #012C, #011C, #010B, #00FC
10159 BC8D 51 01 3E 01
10159 BC91 2C 01 1C 01
10159 BC95 0B 01 FC 00
10160 BC99 EF 00 E1 00  		dw	#00EF, #00E1, #00D6, #00C8, #00BD, #00B2, #00A8, #009F
10160 BC9D D6 00 C8 00
10160 BCA1 BD 00 B2 00
10160 BCA5 A8 00 9F 00
10161 BCA9 96 00 8E 00  		dw	#0096, #008E, #0085, #007E, #0077, #0070, #006B, #0064
10161 BCAD 85 00 7E 00
10161 BCB1 77 00 70 00
10161 BCB5 6B 00 64 00
10162 BCB9 5E 00 59 00  		dw	#005E, #0059, #0054, #004F, #004B, #0047, #0042, #003F
10162 BCBD 54 00 4F 00
10162 BCC1 4B 00 47 00
10162 BCC5 42 00 3F 00
10163 BCC9 3B 00 38 00  		dw	#003B, #0038, #0035, #0032, #002F, #002C, #002A, #0027
10163 BCCD 35 00 32 00
10163 BCD1 2F 00 2C 00
10163 BCD5 2A 00 27 00
10164 BCD9 25 00 23 00  		dw	#0025, #0023, #0021, #001F, #001D, #001C, #001A, #0019
10164 BCDD 21 00 1F 00
10164 BCE1 1D 00 1C 00
10164 BCE5 1A 00 19 00
10165 BCE9 17 00 16 00  		dw	#0017, #0016, #0015, #0013, #0012, #0011, #0010, #000F
10165 BCED 15 00 13 00
10165 BCF1 12 00 11 00
10165 BCF5 10 00 0F 00
10166 BCF9
10167 BCF9 00 00 00     empty_orn:	db	#00, #00, #00
10168 BCFC 70 80 F1 D0  empty_pattern:	db	#70, #80, #F1, #D0, #00
10168 BD00 00
10169 BD01
10170 BD01 00 00        AYREG_TonA:	dw	0
10171 BD03 00 00        AYREG_TonB:	dw	0
10172 BD05 00 00        AYREG_TonC:	dw	0
10173 BD07 00           AYREG_AmplA:	db	0
10174 BD08 00           AYREG_AmplB:	db	0
10175 BD09 00           AYREG_AmplC:	db	0
10176 BD0A 00           tempocnt_2:	db	0
10177 BD0B 00           tempocnt_1:	db	0
10178 BD0C 00           tempocnt_0:	db	0
10179 BD0D 00           pattstep_cnt:	db	0
10180 BD0E
10181 BD0E              ;-----------------------------------------------------------------------------
10182 BD0E
10183 BD0E              			endmodule
10184 BD0E
10185 BD0E
10186 BD0E              songdata
10187 BD0E              MDLADDR
10188 BD0E              modstart
10189 BD0E 00 00        BUFFER:			ds	2		; dlzka songu
10190 BD10              RELOC_BASE:
10191 BD10 00 00        I_SAMPLES:		ds	2		; adresa lookup tabulky samplov
10192 BD12 00 00        I_ORNAMENTS:	ds	2		; adresa lookup tabulky ornamentov
10193 BD14 00 00        I_PATTERNS:		ds	2		; adresa lookup tabulky patternov
10194 BD16 00 00        I_POSITIONS:	ds	2		; adresa definicii pozicii
10195 BD18 00 00        I_REPEAT:		ds	2		; ukazovatel na repeat poziciu
10196 BD1A 00 00        RELOC_ENDPTR:	ds	2		; tu je uz ukazovat na prvy sampel
10197 BD1C 00 00 00...  LFNNAME ds 262
10198 BE22              screen 			incbin	logo.bin
10199 C622
10200 C622
10201 C622 00 00 00...  esxError        ds      34
10202 C644              			  CSPECTMAP player.map
10203 C644
10204 C644                            savenex open "NextPlayer.nex",demo,24575
10205 C644
10206 C644                            savenex core 2,0,0
10207 C644                            ;SAVENEX SCREEN BMP "screen2.bmp"
10208 C644              			  savenex auto
10209 C644                            savenex close
10210 C644
# file closed: NextPlayer.asm
