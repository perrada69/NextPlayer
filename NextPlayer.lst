# file opened: NextPlayer.asm
   1  0000
   2  0000                            DEVICE ZXSPECTRUMNEXT
   3  0000              			  OPT reset --zxnext --syntax=abfw
   4  0000                            slot 3
   5  0000
   6  0000                            org #6000
   7  6000              CHARS         equ  15616-256
   8  6000              mystak        equ  24575         ;ar bi trary value picked to be be low
   9  6000                                              ;BFE0h and above 4000h
  10  6000              staksto       equ  24575         ;some where to put BA SIC's stack
  11  6000                                              ;pointer
  12  6000              bankm         equ  #5B5C         ;sys tem vari able that holds the
  13  6000                                              ;last value out put to 7FFDh
  14  6000              port1         equ  #7FFD         ;ad dress of ROM/RAM switch ing port
  15  6000                                              ;in I/O map
  16  6000              catbuff       equ  #8000         ;some where for DOS to put its catalog
  17  6000              dos_catalog   equ  #011E         ;the DOS routine to call
  18  6000 00 00 00...  filename 	  ds   15
  19  600F              typ 		  equ $-4
  20  600F              pocetpolozek	equ 231
  21  600F 00           virtmem			defb 0
  22  6010              maxlen			equ 128
  23  6010              maxline 		equ 37
  24  6010 00 00        save_allfiles	defw 0
  25  6012
  26  6012              ReadNextReg:
  27  6012                  ; reads nextreg in A into A (does modify currently selected NextReg on I/O port)
  28  6012 C5               push    bc
  29  6013 01 3B 24         ld      bc,#243B
  30  6016 ED 79            out     (c),a
  31  6018 04               inc     b       ; bc = TBBLUE_REGISTER_ACCESS_P_253B
  32  6019 ED 78            in      a,(c)   ; read desired NextReg state
  33  601B C1               pop     bc
  34  601C C9               ret
  35  601D
  36  601D FB           INPUT 	ei
  37  601E 22 37 60     		ld (INPOS+1),hl ;ulož adresu začátku pro další použití
  38  6021 21 00 5B     		ld hl,23296 ;do HL adresa editační oblasti
  39  6024 DD 44        		ld b,hx ;do B délka editační oblasti
  40  6026 36 20        IN1 	ld (hl),32 ;a nyní celou editační
  41  6028 23           		inc hl ;zónu vyplníme mezerami
  42  6029 10 FB        		djnz IN1 ;na konec editační zóny
  43  602B 70           		ld (hl),b ;přijde 0
  44  602C FD CB 01 AE  		res 5,(iy+1) ;signál není stisknuta klávesa
  45  6030 AF           		xor a ;nastav kurzor
  46  6031 32 40 60     		ld (CURSOR+1),a ;na začátek editační zóny
  47  6034 DD 44        IN2 	ld b,hx ;nyní celou editační zónu
  48  6036 21 00 00     INPOS 	ld hl,0 ;vytiskneme, nastav
  49  6039 22 10 61     		ld (PPOS+1),hl ;tiskovou pozici
  50  603C 21 00 5B     		ld hl,23296 ;začínáme od začátku
  51  603F 0E 00        CURSOR 	ld c,0 ;do C polohu kurzoru
  52  6041 7D           IN3 	ld a,l ;testuj spodní byte adresy
  53  6042 B9           		cp c ;v případe rovnosti
  54  6043 3E 3E        		ld a,">" ;dej do A kód kurzoru
  55  6045 CC 06 61     		call z,CHAR ;a vytiskni ho
  56  6048 7E           		ld a,(hl) ;vytiskni znak
  57  6049 CD 06 61     		call CHAR ;z editační zóny
  58  604C 23           		inc hl ;a posun se pro další
  59  604D 10 F2        		djnz IN3 ;opakuj se všemi znaky
  60  604F 7D           		ld a,l ;kurzor také může
  61  6050 B9           		cp c ;být až za posledním
  62  6051 3E BC        		ld a,"<"+128 ;znakem, pak bude
  63  6053 CC 06 61     		call z,CHAR ;na řádku vypadat jinak
  64  6056 CD B5 60     		call INKEY ;přečti si kód klávesy
  65  6059 FE 07        		cp 7 ;testuj EDIT (Caps Shift + 1)
  66  605B C8           		ret z ;a případně se vrať zpátky
  67  605C FE 0D        		cp 13 ;testuj ENTER a případné odskoč
  68  605E C8           		ret z  ;jp z,INPCLEAR ;na smazání řádku z obrazovky
  69  605F
  70  605F 21 34 60     		ld hl,IN2 ;na zásobník ulož adresu IN2, sem
  71  6062 E5           		push hl ;se bude nyní program vracet
  72  6063 21 40 60     		ld hl,CURSOR+1 ;do HL vlož adresu pozice kurzoru
  73  6066 FE 08        		cp 8 ;testuj kurzor doleva
  74  6068 28 24        		jr z,CURSLEFT ;odskoč
  75  606A FE 09        		cp 9 ;kurzor doprava
  76  606C 28 25        		jr z,CURSRGHT
  77  606E FE 0C        		cp 12 ;delete (správně BACKSPACE)
  78  6070 28 2E        		jr z,BCKSPACE
  79  6072 FE C7        		cp 199 ;znak <= (funkce DELETE)
  80  6074 28 23        		jr z,DELETE
  81  6076 FE 20        		cp 32 ;nyní zbývají
  82  6078 D8           		ret c ;obyčejné znaky,
  83  6079 FE 80        		cp 128 ;odfiltruj
  84  607B D0           		ret nc ;netisknutelné znaky
  85  607C 08           		ex af,af' ;a kód přesuň do A'
  86  607D 7E           		ld a,(hl) ;testuj, zda není kurzor
  87  607E DD BC        		cp hx ;na konci řádku,
  88  6080 D0           		ret nc ;když ano, tak se vrať
  89  6081 34           		inc (hl) ;posuň kurzor doprava
  90  6082 6E           		ld l,(hl) ;do HL vlož adresu,
  91  6083 2D           		dec l ;na kterou bude znak
  92  6084 26 5B        		ld h,23296/256 ;uložen
  93  6086 7E           INS 	ld a,(hl) ;přečti původní znak
  94  6087 B7           		or a ;a testuj konec řádku
  95  6088 C8           		ret z ;případně se vrať
  96  6089 08           		ex af,af' ;přehoď původní a nový znak
  97  608A 77           		ld (hl),a ;a nový zapiš, pro další znak
  98  608B 23           		inc hl ;bude novým znakem předchozí
  99  608C 18 F8        		jr INS ;znak, opakuj posun znaku až do konce
 100  608E 7E           CURSLEFT ld a,(hl) ;přečti polohu kurzoru
 101  608F B7           		or a ;a v případe, že je na levém okraji
 102  6090 C8           		ret z ;tak se vrať a nic nedělej
 103  6091 35           		dec (hl) ;posuň kurzor doleva a vrať se na IN2
 104  6092 C9           		ret
 105  6093 7E           CURSRGHT ld a,(hl) ;přečti polohu kurzoru
 106  6094 DD BC        		cp hx ;a když je na konci řádku
 107  6096 D0           		ret nc ;tak se vrať
 108  6097 34           		inc (hl) ;jinak posuň kurzor doprava a vrať se
 109  6098 C9           		ret ;vrať se na IN2
 110  6099 7E           DELETE 	ld a,(hl) ;na konci
 111  609A DD BC        		cp hx ;editační zóny
 112  609C C8           		ret z ;DELETE nepracuje
 113  609D 3C           		inc a ;jinak uprav polohu
 114  609E 18 04        		jr BCK2 ;a pokračuj společnou částí
 115  60A0 7E           BCKSPACE ld a,(hl) ;BACKSPACE naopak
 116  60A1 B7           		or a ;nepracuje na začátku
 117  60A2 C8           		ret z ;editační zóny
 118  60A3 35           		dec (hl) ;posuň kurzor vlevo
 119  60A4 6F           BCK2 	ld l,a ;společná část,
 120  60A5 26 5B        		ld h,23296/256 ;která zajišťuje
 121  60A7 5D           		ld e,l ;přesunutí následujících
 122  60A8 54           		ld d,h ;znaků na uvolněné místo
 123  60A9 1D           		dec e ;po smazaném znaku
 124  60AA
 125  60AA 7E           DEL2 	ld a,(hl) ;vlastní přesun
 126  60AB ED A0        		ldi ;je prováděn instrukcí
 127  60AD B7           		or a ;LDI dokud není přenesena 0,
 128  60AE 20 FA        		jr nz,DEL2 ;která signalizuje konec zóny
 129  60B0 EB           		ex de,hl ;na poslední pozici,
 130  60B1 2B           		dec hl ;která se nyní uvolnila,
 131  60B2 36 20        		ld (hl)," " ;je zapsána mezera
 132  60B4 C9           		ret ;návrat na IN2
 133  60B5
 134  60B5 76           INKEY 	halt
 135  60B6 AF           		xor  a
 136  60B7 32 DD 60              ld   (aLAST_KEY+1),a
 137  60BA FB           		ei
 138  60BB 76           		 halt
 139  60BC
 140  60BC              ahl0
 141  60BC CD 51 74     		 call KEYSCAN
 142  60BF
 143  60BF 7B           		 ld   a,e
 144  60C0 3C                    inc  a
 145  60C1 28 F2                 jr   z,INKEY
 146  60C3 7A                    ld   a,d
 147  60C4 21 82 74              ld   hl,SYMTAB
 148  60C7 FE 18                 cp   $18
 149  60C9 28 0A                 jr   z,aHLSM2
 150  60CB 21 AA 74              ld   hl,CAPSTAB
 151  60CE FE 27                 cp   $27
 152  60D0 28 03                 jr   z,aHLSM2
 153  60D2 21 D1 74              ld   hl,NORMTAB
 154  60D5 16 00        aHLSM2    ld   d,0
 155  60D7 19                    add  hl,de
 156  60D8 7E                    ld   a,(hl)
 157  60D9 B7                    or   a
 158  60DA 28 D9                 jr   z,INKEY
 159  60DC
 160  60DC 06 00        aLAST_KEY ld   b,0
 161  60DE B8                    cp   b
 162  60DF 28 05                 jr   z,aSEDI_KEY
 163  60E1
 164  60E1 06 03                 ld   b,3
 165  60E3 76           aLOOP_LST halt
 166  60E4 10 FD                 djnz aLOOP_LST
 167  60E6              aSEDI_KEY
 168  60E6 32 DD 60              ld   (aLAST_KEY+1),a
 169  60E9 F5           		push af
 170  60EA CD F9 74     		call beepk
 171  60ED F1           		pop af
 172  60EE C9           		ret
 173  60EF
 174  60EF ED 5B 37 60  INPCLEAR ld de,(INPOS+1) ;do DE pixelová pozice
 175  60F3 0E 08        		ld c,8 ;16 pixelových řádků na výšku
 176  60F5 DD 44        INPC2 	ld b,hx ;do B délka řádku
 177  60F7 04           		inc b ;plus 1 za kurzor
 178  60F8 AF           		xor a ;vynuluj A
 179  60F9 D5           		push de ;ulož adresu začátku řádku
 180  60FA 12           INPC3 	ld (de),a ;vymaž byty
 181  60FB 13           		inc de ;v pixelovém
 182  60FC 10 FC        		djnz INPC3 ;řádku
 183  60FE D1           		pop de ;obnov adresu počátku
 184  60FF
 185  60FF CD 9A 7A     		call DOWNDE ;a posuň se na další řádek
 186  6102 0D           		dec c ;odečti jedničku
 187  6103 20 F0        		jr nz,INPC2 ;a zbývají-li řádky, opakuj
 188  6105 C9           		ret
 189  6106
 190  6106 D9           CHAR 	exx
 191  6107 87           		add a,a
 192  6108 6F           		ld l,a
 193  6109 9F           		sbc a,a
 194  610A 4F           		ld c,a
 195  610B 26 0F        		ld h,15
 196  610D 29           		add hl,hl
 197  610E 29           		add hl,hl
 198  610F 11 00 40     PPOS 	ld de,16384
 199  6112 D5           		push de
 200  6113 06 08        		ld b,8
 201  6115 7E           CHAR2 	ld a,(hl)
 202  6116              		;rrca
 203  6116 B6           		or (hl)
 204  6117 A9           		xor c
 205  6118 12           		ld (de),a
 206  6119 CD 9A 7A     		call DOWNDE
 207  611C 23           		inc hl
 208  611D 10 F6        		djnz CHAR2
 209  611F D1           		pop de
 210  6120 1C           		inc e
 211  6121 7B           		ld a,e
 212  6122 E6 1F        		and 31
 213  6124 20 0C        		jr nz,CHAR3
 214  6126 1D           		dec e
 215  6127 7B           		ld a,e ; posun na další tiskovou pozici
 216  6128 E6 E0        		and %11100000
 217  612A 5F           		ld e,a
 218  612B 06 10        		ld b,16
 219  612D CD 9A 7A     CHAR4 	call DOWNDE
 220  6130 10 FB        		djnz CHAR4
 221  6132 ED 53 10 61  CHAR3 	ld (PPOS+1),de
 222  6136 D9           		exx
 223  6137 C9           		ret
 224  6138
 225  6138              ; DE .... vstup hledaneho retezce
 226  6138              ; HL .... vstup textu,kde budeme hledat
 227  6138              ; Výstup:
 228  6138              		; Z ... nalezeno
 229  6138              		; C .. nenalezeno
 230  6138 ED 53 63 61  search		ld (search0+1),de
 231  613C              search1
 232  613C
 233  613C 1A           			ld a,(de)
 234  613D FE 61        			cp "a"
 235  613F 38 08        			jr c,search_next
 236  6141 FE 7A        			cp "z"
 237  6143 30 04        			jr nc,search_next
 238  6145 B7           			or a
 239  6146 DE 20        			sbc a,32
 240  6148 12           			ld (de),a
 241  6149              search_next
 242  6149 7E           			ld a,(hl)
 243  614A FE 61        			cp "a"
 244  614C 38 08        			jr c,search_next2
 245  614E FE 7A        			cp "z"
 246  6150 30 04        			jr nc,search_next2
 247  6152 B7           			or a
 248  6153 DE 20        			sbc a,32
 249  6155 77           			ld (hl),a
 250  6156              search_next2
 251  6156
 252  6156 1A           			ld a,(de)
 253  6157 EE 20        			xor 32
 254  6159 C8           			ret z		;konec, nasli jsme retezec
 255  615A
 256  615A 7E           			ld a,(hl)
 257  615B B7           			or a
 258  615C 28 0E        			jr z,konec_textu
 259  615E
 260  615E 1A           			ld a,(de)
 261  615F              			; res 5,a
 262  615F              			; res 5,(hl)
 263  615F AE           			xor (hl)
 264  6160 28 06        			jr z,search_jo
 265  6162 11 00 00     search0		ld de,0
 266  6165 23           			inc hl
 267  6166 18 D4        			jr search1
 268  6168 23           search_jo	inc hl
 269  6169 13           			inc de
 270  616A 18 D0        			jr search1
 271  616C
 272  616C 3E 01        konec_textu ld a,1		;nastav nz - nic jsme nenasli
 273  616E B7           			or a
 274  616F C9           			ret
 275  6170
 276  6170              SF
 277  6170              searchfile
 278  6170 ED 53 80 61  			ld (ssearch0+1),de
 279  6174 1A           			ld a,(de)
 280  6175 B7           			or a
 281  6176 C8           			ret z		;konec, nasli jsme retezec
 282  6177
 283  6177 7E           			ld a,(hl)
 284  6178 B7           			or a
 285  6179 28 0E        			jr z,skonec_textu
 286  617B
 287  617B 1A           			ld a,(de)
 288  617C AE           			xor (hl)
 289  617D 28 06        			jr z,ssearch_jo
 290  617F 11 00 00     ssearch0		ld de,0
 291  6182 23           			inc hl
 292  6183 18 EB        			jr searchfile
 293  6185 23           ssearch_jo	inc hl
 294  6186 13           			inc de
 295  6187 18 E7        			jr searchfile
 296  6189
 297  6189
 298  6189 3E 01        skonec_textu ld a,1		;nastav nz - nic jsme nenasli
 299  618B B7           			or a
 300  618C C9           			ret
 301  618D
 302  618D
 303  618D
 304  618D
 305  618D
 306  618D
 307  618D
 308  618D
 309  618D
 310  618D              ; Porovnava dva reteze o delce 3 byty.
 311  618D              ; Vstup:
 312  618D              			; HL ... adresa prvniho retezce
 313  618D              			; DE ... adresa druheho retezce
 314  618D              ; Vystup:
 315  618D              			; Z ... souhlasí
 316  618D              			; NZ .. nesouhlasí
 317  618D              compare
 318  618D 1A           			ld a,(de)
 319  618E CB BE        			res 7,(hl)
 320  6190 AE           			xor (hl)
 321  6191 C0           			ret nz
 322  6192 23           			inc hl
 323  6193 13           			inc de
 324  6194 1A           			ld a,(de)
 325  6195 CB BE        			res 7,(hl)
 326  6197 AE           			xor (hl)
 327  6198 C0           			ret nz
 328  6199 23           			inc hl
 329  619A 13           			inc de
 330  619B 1A           			ld a,(de)
 331  619C CB BE        			res 7,(hl)
 332  619E AE           			xor (hl)
 333  619F C9           			ret
 334  61A0
 335  61A0              CountMemory
 336  61A0 11 AE 0B     			ld de,13*(pocetpolozek-1)
 337  61A3 21 00 80     Count11		ld hl,catbuff
 338  61A6 19           			add hl,de
 339  61A7 22 A4 61     			ld (Count11+1),hl
 340  61AA
 341  61AA C9           			ret
 342  61AB
 343  61AB 00 00        savehl		defw 0
 344  61AD 00 00        saveix		defw 0
 345  61AF              ESXDOS      MACRO service?
 345  61AF ~              push hl
 345  61AF ~              pop ix
 345  61AF ~              rst $08
 345  61AF ~              db service?
 345  61AF                ENDM    ; copies HL into IX
 346  61AF
 347  61AF              ; Read NextReg into A (does modify A, and NextReg selected on the I/O port)
 348  61AF              ; is not optimized for speed + restores BC
 349  61AF                  MACRO NEXTREG2A register?
 350  61AF ~                    ld     a,register?
 351  61AF ~                    call   ReadNextReg
 352  61AF                  ENDM
 353  61AF
 354  61AF 50 6C 65 61  txtWait		defb	"Please wait:",0
 354  61B3 73 65 20 77
 354  61B7 61 69 74 3A
 354  61BB 00
 355  61BC 4D 61 69 6E  txtShrek	defb	"Main program: Shrek/MB Maniax",0
 355  61C0 20 70 72 6F
 355  61C4 67 72 61 6D
 355  61C8 3A 20 53 68
 355  61CC 72 65 6B 2F
 355  61D0 4D 42 20 4D
 355  61D4 61 6E 69 61
 355  61D8 78 00
 356  61DA 41 59 20 70  txtBorik	defb 	"AY play rutines: mborik/SinDiKat",0
 356  61DE 6C 61 79 20
 356  61E2 72 75 74 69
 356  61E6 6E 65 73 3A
 356  61EA 20 6D 62 6F
 356  61EE 72 69 6B 2F
 356  61F2 53 69 6E 44
 356  61F6 69 4B 61 74
 356  61FA 00
 357  61FB 42 69 67 20  txtThanks	defb	"Big thanks: ped7g, z00m, Logout",0
 357  61FF 74 68 61 6E
 357  6203 6B 73 3A 20
 357  6207 70 65 64 37
 357  620B 67 2C 20 7A
 357  620F 30 30 6D 2C
 357  6213 20 4C 6F 67
 357  6217 6F 75 74 00
 358  621B 30 2E 35 00  txtVersion	defb 	"0.5",0
 359  621F F3           demo:       di
 360  6220
 361  6220              F_OPEN                      equ $9A
 362  6220              FA_READ                     equ $01
 363  6220              F_READ                      equ $9D
 364  6220              F_CLOSE                     equ $9B
 365  6220              M_GETERR                    equ $93
 366  6220              next_register_select equ $243b
 367  6220              nxr_peripheral2 equ $06
 368  6220
 369  6220
 370  6220 21 00 58     			ld hl,22528
 371  6223 11 01 58                 ld de,22529
 372  6226 3E 07        			ld a,7
 373  6228 77                       ld (hl),a
 374  6229 01 FF 02                 ld bc,767
 375  622C ED B0                    ldir
 376  622E 21 E2 B0     			ld hl,screen
 377  6231 11 00 40     			ld de,16384
 378  6234 01 00 08     			ld bc,2048
 379  6237 ED B0        			ldir
 380  6239 11 22 48     			ld de,18464+2
 381  623C 21 AF 61     			ld hl,txtWait
 382  623F CD AF 7A     			call print
 383  6242 21 42 48     			ld hl, 18496+2
 384  6245 01 1C 04     			ld   bc,4*256+28
 385  6248 3E 05        			ld   a,%00000101
 386  624A CD D2 76     			call RAMECEK
 387  624D
 388  624D 11 64 48     			ld de,18528+4
 389  6250 21 A4 6C     			ld hl,txtStart
 390  6253 CD AF 7A     			call print
 391  6256
 392  6256 11 43 50     			ld de,20544+3
 393  6259 21 BC 61     			ld hl,txtShrek
 394  625C CD AF 7A     			call print
 395  625F 11 63 50     			ld de,20576+3
 396  6262 21 DA 61     			ld hl,txtBorik
 397  6265 CD AF 7A     			call print
 398  6268 11 83 50     			ld de,20608+3
 399  626B 21 FB 61     			ld hl,txtThanks
 400  626E CD AF 7A     			call print
 401  6271
 402  6271 11 7C 40     			ld de,16480+28
 403  6274 21 1B 62     			ld hl,txtVersion
 404  6277 CD AF 7A     			call print
 405  627A
 406  627A 21 00 00     			ld hl,0
 407  627D 11 78 48     			ld de,18528+24
 408  6280 ED 53 FB 64  			ld (NUMPOS+1),de
 409  6284 CD C8 64     			call DEC16
 410  6287 00 14        			defw 20*256
 411  6289
 412  6289 21 4D 5A     			ld hl,22528+13 + 32*18
 413  628C 06 0F        			ld b,15
 414  628E 36 47        podbarvi	ld (hl),%01000111
 415  6290 23           			inc hl
 416  6291 10 FB        			djnz podbarvi
 417  6293
 418  6293 21 6F 5A     			ld hl,22528+15 + 32*19
 419  6296 06 0F        			ld b,15
 420  6298 36 47        podbarvi1	ld (hl),%01000111
 421  629A 23           			inc hl
 422  629B 10 FB        			djnz podbarvi1
 423  629D
 424  629D 21 8B 5A     			ld hl,22528+11 + 32*20
 425  62A0 06 0F        			ld b,15
 426  62A2 36 47        podbarvi2	ld (hl),%01000111
 427  62A4 23           			inc hl
 428  62A5 10 FB        			djnz podbarvi2
 429  62A7
 430  62A7 21 00 58     			ld hl,22528
 431  62AA 06 80        			ld b,32*4
 432  62AC 36 47        podbarvi3	ld (hl),%01000111
 433  62AE 23           			inc hl
 434  62AF 10 FB        			djnz podbarvi3
 435  62B1
 436  62B1 01 3B 12     			ld bc,$123b
 437  62B4                          ;nextreg #03,1
 438  62B4 ED 91 07 03  			nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 439  62B8
 440  62B8 CD 28 65     			call BUFF83
 441  62BB
 442  62BB ED 73 FF 5F              ld (staksto),sp   ;save BASIC's stack pointer
 443  62BF 01 FD 7F                 ld bc,port1       ;the horizontal ROM switch/RAM
 444  62C2                                              ;switch I/O ad dress
 445  62C2 3A 5C 5B                 ld a,(bankm)      ;sys tem vari able that holds cur rent
 446  62C5                                              ;switch state
 447  62C5 CB A7                    res 4,a           ;move right to left in hor i zon tal
 448  62C7                                              ;ROM switch (3 to 2)
 449  62C7
 450  62C7 F6 07                      or 7              ;switch in RAM page 7
 451  62C9 32 5C 5B                   ld (bankm),a      ;must keep sys tem vari able up to
 452  62CC                            	                  ;date (very im por tant)
 453  62CC ED 79                      out (c),a         ;make the switch
 454  62CE
 455  62CE 31 FF 5F     			  ld sp,mystak      ;make sure stack is above 4000h and
 456  62D1                                              ;be low BFE0h
 457  62D1 FB                         ei                ;in ter rupts can now be en abled
 458  62D2
 459  62D2 21 00 80                   ld hl,catbuff     ;some where for DOS to put the cata
 460  62D5                                              ;log
 461  62D5 11 01 80                   ld de,catbuff+1   ;
 462  62D8 01 00 04                   ld bc,1024        ;max i mum (for +3DOS) is ac tu ally
 463  62DB                                              ;64x13+13 = 845
 464  62DB 36 00                      ld (hl),0
 465  62DD ED B0                      ldir              ;make sure at least first en try is
 466  62DF 11 00 80                   ld de,catbuff     ;the lo ca tion to be filled with the
 467  62E2              NextDirItem
 468  62E2 06 E7                      ld b,pocetpolozek ;the num ber of en tries in the
 469  62E4                                              ;buffer
 470  62E4 0E 04                      ld c,%100            ;include sys tem files in the cata
 471  62E6 21 35 66                   ld hl,stardstar   ;the file name ("*.*")
 472  62E9 CD 1E 01                   call dos_catalog  ;call the DOS en try
 473  62EC
 474  62EC 22 AB 61                   ld (savehl),hl
 475  62EF DD 22 AD 61  			  ld (saveix),ix
 476  62F3 78           			  ld a,b
 477  62F4 FE E7        			  cp pocetpolozek
 478  62F6 F5           			  push af
 479  62F7
 480  62F7 2A D5 79     			  ld hl,(ALLFILES)
 481  62FA 58           			  ld e,b
 482  62FB 16 00        			  ld d,0
 483  62FD 19           			  add hl,de
 484  62FE 2B           			  dec hl
 485  62FF 22 D5 79     			  ld (ALLFILES),hl
 486  6302
 487  6302 E5           			push hl
 488  6303 D5           			push de
 489  6304 C5           			push bc
 490  6305
 491  6305
 492  6305 2A 17 65     			ld hl,(dirNum)
 493  6308 19           			add	hl,de
 494  6309 2B           			dec hl
 495  630A 22 17 65     			ld 	(dirNum),hl
 496  630D 11 78 48     			ld de,18528+24
 497  6310 ED 53 FB 64  			ld (NUMPOS+1),de
 498  6314 76           			halt
 499  6315 CD C8 64     			call DEC16
 500  6318 00 14        			defw 20*256
 501  631A C1           			pop bc
 502  631B D1           			pop de
 503  631C E1           			pop hl
 504  631D
 505  631D
 506  631D 3A D4 79     			  ld a,(FILES)
 507  6320 80           			  add a,b
 508  6321 3D           			  dec a
 509  6322 32 D4 79     			  ld (FILES),a
 510  6325 F1           			  pop af
 511  6326 38 15        			  jr c,cont
 512  6328              nezapisuj
 513  6328 78           			  ld a,b
 514  6329 B7           			  or a
 515  632A 28 11        			  jr z,cont
 516  632C
 517  632C 3A 0F 60     			  ld a,(virtmem)
 518  632F FE 04        			  cp 4
 519  6331 28 0A        			  jr z,cont
 520  6333
 521  6333 CD A0 61     			  call CountMemory
 522  6336 EB           			  ex de,hl
 523  6337 21 0F 60     			  ld hl,virtmem
 524  633A 34           			  inc (hl)
 525  633B 18 A5        			  jr NextDirItem
 526  633D              cont
 527  633D F5                         push af           ;save flags and pos si ble er ror num
 528  633E                                              ;ber re turned by DOS
 529  633E
 530  633E
 531  633E 2A 17 65     			ld hl,(dirNum)
 532  6341 11 78 48     			ld de,18528+24
 533  6344 ED 53 FB 64  			ld (NUMPOS+1),de
 534  6348 76           			halt
 535  6349 CD C8 64     			call DEC16
 536  634C 00 14        			defw 20*256
 537  634E
 538  634E
 539  634E E1                         pop hl
 540  634F 22 3B 66                   ld (dosret),hl    ;put it where it can be seen from
 541  6352                                              ; NextBASIC
 542  6352 48                         ld c,b            ;move num ber of files in cat a log to
 543  6353                                              ;low byte of BC
 544  6353 06 00                      ld b,0            ;this will be re turned in NextBASIC
 545  6355
 546  6355 F3                         di                ;about to ROM/RAM switch so be
 547  6356                                              ;care ful
 548  6356 C5                         push bc           ;save num ber of files
 549  6357 01 FD 7F                   ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 550  635A                                              ;switch
 551  635A 3A 5C 5B                   ld a,(bankm)      ;get cur rent switch state
 552  635D
 553  635D
 554  635D CB E7                      set 4,a           ;move left to right (ROM 2 to ROM
 555  635F                                              ;3)
 556  635F E6 F8                      and #F8           ;also want RAM page 0
 557  6361 32 5C 5B                   ld (bankm),a      ;up date the sys tem vari able (very
 558  6364                                              ;im por tant)
 559  6364 ED 79                      out (c),a         ;make the switch
 560  6366 C1                         pop bc            ;get back the saved num ber of files
 561  6367 0B                         dec bc
 562  6368
 563  6368 ED 7B FF 5F                ld sp,(staksto)   ;put NextBASIC's stack back
 564  636C
 565  636C CD 28 65     			 call BUFF83
 566  636F 21 0D 80     			 ld hl,catbuff+13
 567  6372 ED 5B D5 79  			 ld de,(ALLFILES)
 568  6376 D5           testovani	 push de
 569  6377 E5           			 push hl
 570  6378 DD E1        			 pop ix
 571  637A DD E5        			 push ix
 572  637C DD CB 07 7E  			 bit 7,(ix+7)
 573  6380
 574  6380 20 53        			 jr nz,souhlasi
 575  6382
 576  6382 11 08 00     			 ld de,8
 577  6385 19           			 add hl,de		;v HL je začátek přípony souboru
 578  6386
 579  6386 E5           			 push hl
 580  6387 11 97 73     			 ld de,PT2
 581  638A CD 8D 61     			 call compare
 582  638D E1           			 pop hl
 583  638E 28 45        			 jr z,souhlasi
 584  6390
 585  6390 E5           			 push hl
 586  6391 11 9A 73     			 ld de,PT3
 587  6394 CD 8D 61     			 call compare
 588  6397 E1           			 pop hl
 589  6398 28 3B        			 jr z,souhlasi
 590  639A
 591  639A 11 9D 73     			 ld de,SQT
 592  639D E5           			 push hl
 593  639E CD 8D 61     			 call compare
 594  63A1 E1           			 pop hl
 595  63A2 28 31        			 jr z,souhlasi
 596  63A4
 597  63A4 11 A0 73     			 ld de,STC
 598  63A7 E5           			 push hl
 599  63A8 CD 8D 61     			 call compare
 600  63AB E1           			 pop hl
 601  63AC 28 27        			 jr z,souhlasi
 602  63AE
 603  63AE 11 A3 73      			 ld de,STP
 604  63B1 E5           			 push hl
 605  63B2 CD 8D 61     			 call compare
 606  63B5 E1           			 pop hl
 607  63B6 28 1D        			 jr z,souhlasi
 608  63B8
 609  63B8 D1           			 pop de
 610  63B9 D5           			 push de		;v de mame zacatek jmena souboru
 611  63BA 62           			 ld h,d
 612  63BB 6B           			 ld l,e
 613  63BC ED 34 0D 00  			 add hl,13		;vynechana jedna polozka
 614  63C0 01 FC 3F     			 ld bc,1260*13
 615  63C3 ED B0        			 ldir
 616  63C5
 617  63C5 2A D5 79     			 ld hl,(ALLFILES)
 618  63C8 2B           			 dec hl
 619  63C9 22 D5 79     			 ld (ALLFILES),hl
 620  63CC E1           			 pop hl
 621  63CD D1           			 pop de
 622  63CE 1B           			 dec de
 623  63CF 7A           			 ld a,d
 624  63D0 B3           			 or e
 625  63D1 20 A3        			 jr nz,testovani
 626  63D3 18 0B        			 jr skon
 627  63D5              souhlasi
 628  63D5 E1           			 pop hl
 629  63D6 11 0D 00     			 ld de,13
 630  63D9 19           			 add hl,de
 631  63DA D1           			 pop de
 632  63DB 1B           			 dec de
 633  63DC 7A           			 ld a,d
 634  63DD B3           			 or e
 635  63DE 20 96        			 jr nz,testovani
 636  63E0              skon
 637  63E0
 638  63E0 2A D5 79     			ld hl,(ALLFILES)
 639  63E3 22 10 60     			ld (save_allfiles),hl
 640  63E6 11 84 48     			 ld de,18560+4
 641  63E9 21 8B 6C     			 ld hl,txtLFNinfo
 642  63EC CD AF 7A     			 call print
 643  63EF CD CE 6C     			 call getAllLFN
 644  63F2 CD FB 6D     			 call GETDIR
 645  63F5 21 00 40     			 ld hl,16384
 646  63F8 11 01 40     			 ld de,16385
 647  63FB 01 FF 17     			 ld bc,6143
 648  63FE AF           			 xor a
 649  63FF 77           			 ld (hl),a
 650  6400 ED B0        			 ldir
 651  6402
 652  6402 CD 39 65     			 call NOBUFF83
 653  6405 CD A4 77                  call kresli
 654  6408 CD 17 7A                  call INIROLL
 655  640B
 656  640B 21 0D 80     			 ld hl,catbuff+#d
 657  640E CD C5 78                  call WRFILES      ;vypis soubory
 658  6411 11 2F 48     			 ld de,18464+15
 659  6414 21 07 7F     			 ld hl,txtcurrentfile
 660  6417 CD AF 7A     			 call print
 661  641A
 662  641A 11 0F 48     			 ld de,18432+15
 663  641D 21 FC 7E     			 ld hl,txtallfiles
 664  6420 CD AF 7A     			 call print
 665  6423
 666  6423 CD 19 65     			call LFNWINDOW
 667  6426 CD B8 65     			call LFNPRINT
 668  6429 21 07 B9     			ld hl,LFNNAME + maxline
 669  642C 36 00        			ld (hl),0
 670  642E 21 E2 B8     			ld hl,LFNNAME
 671  6431 11 C2 50     			ld de,20672+2
 672  6434 CD AF 7A     			call print
 673  6437
 674  6437
 675  6437 11 4F 50     			ld de,20544+15
 676  643A 21 A8 6F     			ld hl,lfndir
 677  643D CD AF 7A     			call print
 678  6440 11 52 50     			ld de,20544+15+3
 679  6443 21 E7 6D     			ld hl,NAZEVADRESARE
 680  6446 CD AF 7A     			call print
 681  6449
 682  6449 ED 91 07 00              nextreg #07,0             ;3,5MHz
 683  644D
 684  644D ED 91 57 18  			nextreg $57,24		;Nastrankuj od C000 player
 685  6451              HLSMYC0
 686  6451 2A BD 75     		ld hl,(apos_all)
 687  6454 23           		inc hl
 688  6455 11 3A 48     		ld de,18464+15+11
 689  6458 ED 53 FB 64  		ld (NUMPOS+1),de
 690  645C CD C8 64     		call DEC16
 691  645F 00 14        		defw 20*256
 692  6461
 693  6461 2A D5 79     		ld hl,(ALLFILES)
 694  6464 11 1A 48     		ld de,18432+15+11
 695  6467 ED 53 FB 64  		ld (NUMPOS+1),de
 696  646B CD C8 64     		call DEC16
 697  646E 00 14        		defw 20*256
 698  6470
 699  6470 AF                    xor  a
 700  6471 32 A2 64              ld   (LAST_KEY+1),a
 701  6474 FB           		 ei
 702  6475 76           		 halt
 703  6476
 704  6476 3A A6 73     		 ld a,(endsong)
 705  6479 B7           		 or a
 706  647A 28 05        		 jr z,hl0
 707  647C 32 A2 64     		 ld (LAST_KEY+1),a
 708  647F 18 2A        		 jr SEDI_KEY
 709  6481              hl0
 710  6481 CD 51 74     		 call KEYSCAN
 711  6484
 712  6484 7B           		 ld   a,e
 713  6485 3C                    inc  a
 714  6486 28 C9                 jr   z,HLSMYC0
 715  6488 7A                    ld   a,d
 716  6489 21 82 74              ld   hl,SYMTAB
 717  648C FE 18                 cp   $18
 718  648E 28 0A                 jr   z,HLSM2
 719  6490 21 AA 74              ld   hl,CAPSTAB
 720  6493 FE 27                 cp   $27
 721  6495 28 03                 jr   z,HLSM2
 722  6497 21 D1 74              ld   hl,NORMTAB
 723  649A 16 00        HLSM2    ld   d,0
 724  649C 19                    add  hl,de
 725  649D 7E                    ld   a,(hl)
 726  649E B7                    or   a
 727  649F 28 B0                 jr   z,HLSMYC0
 728  64A1
 729  64A1 06 00        LAST_KEY ld   b,0
 730  64A3 B8                    cp   b
 731  64A4 28 05                 jr   z,SEDI_KEY
 732  64A6
 733  64A6 06 01                 ld   b,1
 734  64A8 76           LOOP_LST halt
 735  64A9 10 FD                 djnz LOOP_LST
 736  64AB
 737  64AB              SEDI_KEY
 738  64AB 32 A2 64              ld   (LAST_KEY+1),a
 739  64AE
 740  64AE
 741  64AE 32 3D 66     	     ld (KEY),a
 742  64B1
 743  64B1 CD F9 74     		call beepk
 744  64B4 CD 3E 66     		call CH_FILE
 745  64B7 18 98        		jr   HLSMYC0
 746  64B9
 747  64B9 FB                    ei
 748  64BA 18 FE        konec    jr konec
 749  64BC
 750  64BC
 751  64BC
 752  64BC C9                    ret
 753  64BD
 754  64BD
 755  64BD 00 00 00...  NUM      ds 11
 756  64C8 0E 20        DEC16    ld   c,' '
 757  64CA FD 21 BD 64  DEC16X   ld   iy,NUM
 758  64CE 11 F0 D8              ld   de,-10000
 759  64D1 CD 00 65              call BN1
 760  64D4 11 18 FC              ld   de,-1000
 761  64D7 CD 00 65              call BN1
 762  64DA 11 9C FF     DEC8_3   ld   de,-100
 763  64DD CD 00 65              call BN1
 764  64E0 1E F6                 ld   e,-10
 765  64E2 CD 00 65              call BN1
 766  64E5 1E FF                 ld   e,-1
 767  64E7 0E 30                 ld   c,'0'
 768  64E9 CD 00 65              call BN1
 769  64EC FD 36 00 00  DEC32SP  ld   (iy+0),0
 770  64F0 E3                    ex   (sp),hl
 771  64F1 5E                    ld   e,(hl)
 772  64F2 23                    inc  hl
 773  64F3 56                    ld   d,(hl)
 774  64F4 23                    inc  hl
 775  64F5 E3                    ex   (sp),hl
 776  64F6 EB                    ex   de,hl
 777  64F7 21 BD 64              ld   hl,NUM
 778  64FA 11 91 48     NUMPOS	 ld   de,18562+15
 779  64FD C3 AF 7A              jp   print
 780  6500
 781  6500 3E 2F        BN1      ld   a,'0'-1
 782  6502 19           BN4      add  hl,de
 783  6503 3C                    inc  a
 784  6504 38 FC                 jr   c,BN4
 785  6506 ED 52        BN2      sbc  hl,de
 786  6508 FE 30                 cp   '0'
 787  650A 28 02                 jr   z,BN3
 788  650C 01 30                 db 1,'0'
 789  650E 79           BN3      ld   a,c
 790  650F B7                    or   a
 791  6510 C8                    ret  z
 792  6511 FD 77 00              ld   (iy+0),a
 793  6514 FD 23                 inc  iy
 794  6516 C9                    ret
 795  6517
 796  6517 00 00        dirNum	 defw 0
 797  6519
 798  6519              LFNWINDOW
 799  6519 21 A0 50     		ld hl, 20640
 800  651C 01 20 03     		ld   bc,3*256+32
 801  651F 3E 07                ld   a,%00000111
 802  6521 CD D2 76     		call RAMECEK
 803  6524 C9           		ret
 804  6525
 805  6525              setspace
 806  6525 36 20        		ld (hl),32
 807  6527 C9           		ret
 808  6528
 809  6528
 810  6528
 811  6528              ;Nastránkuj buffer s daty adresáře
 812  6528              BUFF83
 813  6528 ED 91 54 14  			nextreg $54,20
 814  652C ED 91 55 15  			nextreg $55,21
 815  6530 ED 91 56 16  			nextreg $56,22
 816  6534 ED 91 57 17  			nextreg $57,23
 817  6538 C9           			ret
 818  6539
 819  6539              NOBUFF83
 820  6539 ED 91 54 04  			nextreg $54,04
 821  653D ED 91 55 05  			nextreg $55,05
 822  6541 ED 91 56 00  			nextreg $56,00
 823  6545 ED 91 57 01  			nextreg $57,01
 824  6549 C9           			ret
 825  654A
 826  654A
 827  654A              ; Input: HL = Dividend, C = Divisor, A = 0
 828  654A              ; Output: HL = Quotient, A = Remainder
 829  654A AF           deleno		xor a
 830  654B 06 10        			ld b,16
 831  654D              de
 832  654D 29           			add	hl,hl
 833  654E 17           			rla
 834  654F B9           			cp	c
 835  6550 38 02        			jr	c,de1
 836  6552 91           			sub	c
 837  6553 2C           			inc	l
 838  6554 10 F7        de1			djnz de
 839  6556 C9           			ret
 840  6557
 841  6557 00 00        addrlfn		dw 0
 842  6559
 843  6559              FINDLFN
 844  6559 B7           			or a
 845  655A 11 3F 00     			ld de,63
 846  655D ED 52        			sbc hl,de
 847  655F 19           			add hl,de
 848  6560 38 08        			jr c,prvni
 849  6562 0E 3F        			ld c,63
 850  6564 AF           			xor a
 851  6565 CD 4A 65     			call deleno
 852  6568 18 03        		    jr oddeleno
 853  656A 7D           prvni		ld a,l
 854  656B 2E 00        			ld l,0
 855  656D
 856  656D F5           oddeleno	push af
 857  656E 3E 18        			ld a,24
 858  6570 85           			add a,l
 859  6571 ED 92 57     			nextreg $57,a
 860  6574 C1           			pop bc
 861  6575 11 80 00     			ld de,maxlen
 862  6578 78           			ld a,b
 863  6579 B7           			or a
 864  657A 21 00 E0     			ld hl,$e000
 865  657D 28 03        			jr z,prvnizaznam
 866  657F              lll
 867  657F 19           			add hl,de
 868  6580 10 FD        			djnz lll
 869  6582
 870  6582              prvnizaznam
 871  6582 22 57 65     			ld (addrlfn),hl
 872  6585 11 E2 B8     			ld de,LFNNAME
 873  6588 06 80        			ld b,maxlen
 874  658A              popop
 875  658A 7E           			ld a,(hl)
 876  658B FE FF        			cp 255
 877  658D 28 05        			jr z,kon
 878  658F 12           			ld (de),a
 879  6590 23           			inc hl
 880  6591 13           			inc de
 881  6592 10 F6        			djnz popop
 882  6594              kon
 883  6594 21 E2 B8     			ld hl,LFNNAME
 884  6597 06 28        			ld b,40
 885  6599              F22222
 886  6599 7E           			ld a,(hl)
 887  659A FE FF        			cp 255
 888  659C CC 25 65     			call z,setspace
 889  659F 23           			inc hl
 890  65A0 10 F7        			djnz F22222
 891  65A2 21 E2 B8     lfnend		ld hl,LFNNAME
 892  65A5 21 DE 50     lfn_1		ld hl,28 + 20672+2
 893  65A8 22 A9 7A     			ld (maxpos),hl
 894  65AB 21 01 51     lfn_2		ld hl,63 + 20672+2
 895  65AE 22 AB 7A     			ld (maxpos2),hl
 896  65B1
 897  65B1 11 C2 50     lfnat		ld de,20672+2
 898  65B4 21 E2 B8     			ld hl,LFNNAME
 899  65B7 C9           			ret
 900  65B8
 901  65B8              LFNPRINT
 902  65B8 21 E2 B8     			ld hl,LFNNAME
 903  65BB 11 E3 B8     			ld de,LFNNAME + 1
 904  65BE 3E 20        			ld a,32
 905  65C0 77           			ld (hl),a
 906  65C1 01 A4 00     			ld bc,164
 907  65C4 ED B0        			ldir
 908  65C6              stop
 909  65C6 2A BD 75     			ld hl,(apos_all)
 910  65C9
 911  65C9 CD 59 65     			call FINDLFN
 912  65CC
 913  65CC
 914  65CC              			;call p6b
 915  65CC ED 91 57 01  			nextreg $57,01
 916  65D0 C9           			ret
 917  65D1
 918  65D1 00           by1			defb  %00000000
 919  65D2 7E           			defb  %01111110
 920  65D3 6A           			defb  %01101010
 921  65D4 56           			defb  %01010110
 922  65D5 6A           			defb  %01101010
 923  65D6 56           			defb  %01010110
 924  65D7 7E           			defb  %01111110
 925  65D8 00           			defb  %00000000
 926  65D9
 927  65D9 00           			defb  %00000000
 928  65DA 7E           			defb  %01111110
 929  65DB 6A           			defb  %01101010
 930  65DC 56           			defb  %01010110
 931  65DD 6A           			defb  %01101010
 932  65DE 56           			defb  %01010110
 933  65DF 7E           			defb  %01111110
 934  65E0 00           			defb  %00000000
 935  65E1
 936  65E1 00           			defb  %00000000
 937  65E2 7E           			defb  %01111110
 938  65E3 6A           			defb  %01101010
 939  65E4 56           			defb  %01010110
 940  65E5 6A           			defb  %01101010
 941  65E6 56           			defb  %01010110
 942  65E7 7E           			defb  %01111110
 943  65E8 00           			defb  %00000000
 944  65E9
 945  65E9 D5           pozadi		  push de
 946  65EA 06 08        			  ld b,8
 947  65EC C5           kr1			  push bc
 948  65ED D5           			  push de
 949  65EE 01 10 00     			  ld bc,16
 950  65F1 21 14 66     			  ld hl,byte16
 951  65F4 ED B0        			  ldir
 952  65F6 E1           			  pop hl
 953  65F7 CD A9 7B     			  call downhl
 954  65FA EB           			  ex de,hl
 955  65FB
 956  65FB C1           			  pop bc
 957  65FC 10 EE        			  djnz  kr1
 958  65FE
 959  65FE D1           			  pop de
 960  65FF 06 08        			  ld b,8
 961  6601 C5           kr2			  push bc
 962  6602 D5           			  push de
 963  6603 01 10 00     			  ld bc,16
 964  6606 21 33 66     			  ld hl,abyte16
 965  6609 ED B8        			  lddr
 966  660B E1           			  pop hl
 967  660C CD A9 7B     			  call downhl
 968  660F EB           			  ex de,hl
 969  6610
 970  6610 C1           			  pop bc
 971  6611 10 EE        			  djnz  kr2
 972  6613 C9           			  ret
 973  6614
 974  6614
 975  6614
 976  6614 FF           byte16	defb	%11111111
 977  6615 FE           byte15	defb	%11111110
 978  6616 FC           byte14	defb	%11111100
 979  6617 F8           byte13	defb	%11111000
 980  6618 F0           byte12	defb	%11110000
 981  6619 E1           byte11	defb	%11100001
 982  661A C3           byte10	defb	%11000011
 983  661B 87           byte9	defb	%10000111
 984  661C 1F           byte8	defb	%00011111
 985  661D 0F           byte7	defb	%00001111
 986  661E 07           byte6	defb	%00000111
 987  661F 07           byte5	defb	%00000111
 988  6620 03           byte4	defb	%00000011
 989  6621 01           byte3	defb	%00000001
 990  6622 01           byte2	defb	%00000001
 991  6623 00           byte1	defb	%00000000
 992  6624
 993  6624 00           abyte1	defb	%00000000
 994  6625 01           abyte2	defb	%00000001
 995  6626 01           abyte3	defb	%00000001
 996  6627 03           abyte4	defb	%00000011
 997  6628 07           abyte5	defb	%00000111
 998  6629 07           abyte6	defb	%00000111
 999  662A 0F           abyte7	defb	%00001111
1000  662B 1F           abyte8	defb	%00011111
1001  662C 87           abyte9	defb	%10000111
1002  662D C3           abyte10	defb	%11000011
1003  662E E1           abyte11	defb	%11100001
1004  662F F0           abyte12	defb	%11110000
1005  6630 F8           abyte13	defb	%11111000
1006  6631 FC           abyte14	defb	%11111100
1007  6632 FE           abyte15	defb	%11111110
1008  6633 FF           abyte16	defb	%11111111
1009  6634 00           outputdir	defb 0
1010  6635              stardstar:
1011  6635 2A 2E 3F 3F                defb "*.???",#FF
1011  6639 3F FF
1012  663B              dosret:
1013  663B 00 00                      defw 0
1014  663D
1015  663D 00           KEY      defb 0
1016  663E              CH_FILE
1017  663E
1018  663E 3A 3D 66              ld   a,(KEY)
1019  6641 FE 71                 cp   "q"
1020  6643 CA 12 75              jp   z,UP
1021  6646 FE 0B                 cp   11
1022  6648 CA 12 75              jp   z,UP
1023  664B FE 73        		 cp "s"
1024  664D CA C5 66     		 jp z,hledej
1025  6650 FE 72        		 cp "r"
1026  6652 CA 93 6D     		 jp z,reload
1027  6655 FE 61                 cp   "a"
1028  6657 CA 73 75              jp   z,DOWN
1029  665A FE 0A                 cp   10
1030  665C CA 73 75              jp   z,DOWN
1031  665F FE 09        		 cp 9
1032  6661 CA 18 6A     		 jp z,right
1033  6664 FE 08        		 cp 8
1034  6666 CA 8A 69     		 jp z,left
1035  6669 FE 0D                 cp   13
1036  666B CA 6E 71              jp   z,FIRE
1037  666E FE 20        		 cp 32
1038  6670 CA 6B 71     		 jp z,nextsong
1039  6673 C9                    ret
1040  6674 53 65 61 72  txtFilter defb "Search:           ",0
1040  6678 63 68 3A 20
1040  667C 20 20 20 20
1040  6680 20 20 20 20
1040  6684 20 20 00
1041  6687 00 00        savepoc defw 0
1042  6689 00 00        actadr	defw 0
1043  668B 00 00        h1		defw 0
1044  668D 53 65 61 72  txtFind defb "Search songs.",0
1044  6691 63 68 20 73
1044  6695 6F 6E 67 73
1044  6699 2E 00
1045  669B 4F 6E 6C 79  txtFind2 defb "Only chars, without spaces.",0
1045  669F 20 63 68 61
1045  66A3 72 73 2C 20
1045  66A7 77 69 74 68
1045  66AB 6F 75 74 20
1045  66AF 73 70 61 63
1045  66B3 65 73 2E 00
1046  66B7 46 6F 75 6E  txtFinded defb "Found:",0
1046  66BB 64 3A 00
1047  66BE 4C 65 66 74  txtLeft defb "Left: ",0
1047  66C2 3A 20 00
1048  66C5 CD 23 74     hledej	call savescr
1049  66C8 21 00 00     		ld hl,0
1050  66CB 22 57 67     		ld (nalezeno+1),hl
1051  66CE 21 00 00     		ld hl,0
1052  66D1 22 8B 67     		ld (pozice+1),hl
1053  66D4 2A D5 79     		ld hl,(ALLFILES)
1054  66D7 22 87 66     		ld (savepoc),hl
1055  66DA 21 0D 80     		ld hl,catbuff+#d
1056  66DD 22 89 66     		ld (actadr),hl
1057  66E0
1058  66E0 21 20 48     		ld   hl,18464
1059  66E3 01 20 08             ld   bc,8*256+32
1060  66E6 3E 07                ld   a,%00000111
1061  66E8 CD D2 76             call RAMECEK
1062  66EB
1063  66EB 11 41 48     		ld de,18496+1
1064  66EE 21 8D 66     		ld hl,txtFind
1065  66F1 CD AF 7A     		call print
1066  66F4
1067  66F4 11 61 48     		ld de,18528+1
1068  66F7 21 9B 66     		ld hl,txtFind2
1069  66FA CD AF 7A     		call print
1070  66FD
1071  66FD 21 00 00     		ld hl,0
1072  6700 22 8B 67     		ld (pozice+1),hl
1073  6703 22 8B 66     		ld (h1),hl
1074  6706
1075  6706 21 A1 59     		ld hl,13*32+22528+1
1076  6709 06 1D        		ld b,29
1077  670B 36 68        po		ld (hl),01101000b
1078  670D 23           		inc hl
1079  670E 10 FB        		djnz po
1080  6710
1081  6710 DD 26 1C     		ld hx,28 ;délka vstupu
1082  6713 21 A1 48     		ld hl,18592+1 ;adresa na obrazovce
1083  6716 CD 1D 60     		call INPUT ;volej vstupní podprogram
1084  6719 FE 07        		cp 7 ;testuj EDIT
1085  671B CA 05 69     		jp z,end_hledej
1086  671E 21 00 5B     		ld hl,23296
1087  6721 11 7C 66     		ld de,txtFilter + 8
1088  6724 01 0A 00     		ld bc,10
1089  6727 ED B0        		ldir
1090  6729 11 6F 50     		ld de,20576+15
1091  672C 21 74 66     		ld hl,txtFilter
1092  672F CD AF 7A     		call print
1093  6732
1094  6732
1095  6732 11 C1 48     		ld de,18624+1
1096  6735 21 B7 66     		ld hl,txtFinded
1097  6738 CD AF 7A     		call print
1098  673B
1099  673B 11 E1 48     		ld de,18656+1
1100  673E 21 BE 66     		ld hl,txtLeft
1101  6741 CD AF 7A     		call print
1102  6744
1103  6744              ssss
1104  6744 ED 91 07 03  			nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
1105  6748 CD 28 65     			call BUFF83
1106  674B 21 0D 80     			ld hl,catbuff+13; + 26 ;vynechej první dvě položky
1107  674E
1108  674E ED 5B D5 79  			ld de,(ALLFILES)
1109  6752 D5           htestovani	push de
1110  6753 E5           			push hl
1111  6754
1112  6754 E5           			push hl
1113  6755 D5           			push de
1114  6756
1115  6756 21 00 00     nalezeno	ld hl,0
1116  6759 11 C5 48     			ld de,18624+5	;pozice ve VideoRam
1117  675C ED 53 FB 64  			ld (NUMPOS+1),de
1118  6760
1119  6760 CD C8 64     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
1120  6763 00 14        			defw 20*256
1121  6765
1122  6765 2A 8B 66     			ld hl,(h1)
1123  6768 23           			inc hl
1124  6769 22 8B 66     			ld (h1),hl
1125  676C
1126  676C 2A D5 79     			ld hl,(ALLFILES)
1127  676F 11 E5 48     			ld de,18656+5	;pozice ve VideoRam
1128  6772 ED 53 FB 64  			ld (NUMPOS+1),de
1129  6776 CD C8 64     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
1130  6779 00 14        			defw 20*256
1131  677B
1132  677B
1133  677B 21 E2 B8     			ld hl,LFNNAME
1134  677E 11 E3 B8     			ld de,LFNNAME+1
1135  6781 AF           			xor  a
1136  6782 77           			ld (hl),a
1137  6783 01 80 00     			ld bc,128
1138  6786 ED B0        			ldir
1139  6788 D1           			pop de
1140  6789 E1           			pop hl
1141  678A 21 00 00     pozice		ld hl,0
1142  678D E5           			push hl
1143  678E CD 59 65     			call FINDLFN
1144  6791 E1           			pop hl
1145  6792 23           			inc hl
1146  6793 22 8B 67     			ld (pozice+1),hl
1147  6796 11 00 5B     			ld de,23296
1148  6799 21 E2 B8     			ld hl,LFNNAME
1149  679C CD 38 61     			call search
1150  679F 28 14        			jr z,hsouhlasi
1151  67A1              			; pop de
1152  67A1              			; push de		;v de mame zacatek jmena souboru
1153  67A1
1154  67A1              			; ld h,d
1155  67A1              			; ld l,e
1156  67A1              			; add hl,13		;vynechana jedna polozka
1157  67A1
1158  67A1              			; ld hl,(actadr)
1159  67A1              			; ex de,hl
1160  67A1
1161  67A1              			; ld bc,13	;1260*13
1162  67A1              			; ldir
1163  67A1
1164  67A1 2A D5 79     			ld hl,(ALLFILES)
1165  67A4 2B           			dec hl
1166  67A5 22 D5 79     			ld (ALLFILES),hl
1167  67A8 E1           			pop hl
1168  67A9 11 0D 00     			ld de,13
1169  67AC 19           			add hl,de
1170  67AD D1           			pop de
1171  67AE 1B           			dec de
1172  67AF 7A           			ld a,d
1173  67B0 B3           			or e
1174  67B1 20 9F        			jr nz,htestovani
1175  67B3 18 3D        			jr hkon
1176  67B5 2A 57 67     hsouhlasi	ld hl,(nalezeno+1)
1177  67B8 23           			inc hl
1178  67B9 22 57 67     			ld (nalezeno+1),hl
1179  67BC
1180  67BC 2A 89 66     			ld hl,(actadr)
1181  67BF 11 76 68     			ld de,vymenafile
1182  67C2 01 0D 00     			ld bc,13
1183  67C5 ED B0        			ldir				;ulož soubor, co bude vymazany
1184  67C7
1185  67C7 2A 89 66     			ld hl,(actadr)
1186  67CA D1           			pop de
1187  67CB D5           			push de
1188  67CC EB           			ex de,hl
1189  67CD 01 0D 00     			ld bc,13
1190  67D0 ED B0        			ldir			;nahrad
1191  67D2
1192  67D2 D1           			pop de
1193  67D3 D5           			push de
1194  67D4 21 76 68     			ld hl,vymenafile
1195  67D7 01 0D 00     			ld bc,13
1196  67DA ED B0        			ldir
1197  67DC
1198  67DC 2A 89 66     			ld hl,(actadr)
1199  67DF 11 0D 00     			ld de,13
1200  67E2 19           			add hl,de
1201  67E3 22 89 66     			ld (actadr),hl
1202  67E6
1203  67E6 E1           			 pop hl
1204  67E7 11 0D 00     			 ld de,13
1205  67EA 19           			 add hl,de
1206  67EB D1           			 pop de
1207  67EC 1B           			 dec de
1208  67ED 7A           			 ld a,d
1209  67EE B3           			 or e
1210  67EF C2 52 67     			 jp nz,htestovani
1211  67F2              hkon
1212  67F2 CD FB 6D     			 call GETDIR
1213  67F5 2A D5 79     			 ld hl,(ALLFILES)
1214  67F8
1215  67F8 7C           			 ld a,h
1216  67F9 B5           			 or l
1217  67FA CA 83 68     			 jp z,nula
1218  67FD 21 C5 48     			 ld hl,18624+5
1219  6800 22 08 6D     			 ld (lfnpos+1),hl
1220  6803 CD CE 6C     			 call getAllLFN
1221  6806 21 98 48     			 ld hl,18560+24
1222  6809 22 08 6D     			 ld (lfnpos+1),hl
1223  680C
1224  680C 21 00 00     			 ld hl,0
1225  680F 22 BD 75     			 ld (apos_all),hl
1226  6812 AF           			 xor a
1227  6813 32 13 75     			 ld (POS_F + 1),a
1228  6816
1229  6816
1230  6816 21 0D 80     			 ld hl,catbuff+#d
1231  6819 22 DB 78     		     ld (WRBUFF+1),hl
1232  681C CD A4 77     			 call kresli
1233  681F
1234  681F
1235  681F              			;call loadscr
1236  681F 21 20 40     		    ld   hl,16416
1237  6822 01 0E 14     		    ld   bc,20*256+14
1238  6825 3E 0F        		    ld   a,%00001111
1239  6827 CD D2 76     		    call RAMECEK
1240  682A CD 28 65     			 call BUFF83
1241  682D CD C5 78     			call WRFILES
1242  6830 11 2F 48     			ld de,18464+15
1243  6833 21 07 7F     			ld hl,txtcurrentfile
1244  6836 CD AF 7A     			call print
1245  6839
1246  6839 11 0F 48     			ld de,18432+15
1247  683C 21 FC 7E     			ld hl,txtallfiles
1248  683F CD AF 7A     			call print
1249  6842 11 6F 50     			ld de,20576+15
1250  6845 21 74 66     			ld hl,txtFilter
1251  6848 CD AF 7A     			call print
1252  684B              TISK
1253  684B 11 4F 50     			ld de,20544+15
1254  684E 21 A8 6F     			ld hl,lfndir
1255  6851 CD AF 7A     			call print
1256  6854 11 52 50     			ld de,20544+15+3
1257  6857 21 E7 6D     			ld hl,NAZEVADRESARE
1258  685A CD AF 7A     			call print
1259  685D
1260  685D CD 19 65     			call LFNWINDOW
1261  6860 CD B8 65     			call LFNPRINT
1262  6863 21 07 B9     			ld hl,LFNNAME + maxline
1263  6866 36 00        			ld (hl),0
1264  6868 21 E2 B8     			ld hl,LFNNAME
1265  686B 11 C2 50     			ld de,20672+2
1266  686E CD AF 7A     			call print
1267  6871
1268  6871
1269  6871 ED 91 07 00   			 nextreg #07,0			;3,5 MHz
1270  6875
1271  6875 C9           			 ret
1272  6876 00 00 00...  vymenafile	ds 13
1273  6883              nula
1274  6883 21 40 48             ld   hl,18496
1275  6886 01 20 06             ld   bc,6*256+32
1276  6889 3E 07                ld   a,%00000111
1277  688B CD D2 76             call RAMECEK
1278  688E
1279  688E
1280  688E 11 6A 48     		ld   de,18562+8-32
1281  6891 21 C2 68          	ld hl,nulatxt
1282  6894 CD AF 7A             call print
1283  6897
1284  6897              		; ld   de,18560+7
1285  6897                   	; ld hl,reloadtxt
1286  6897                      ; call print
1287  6897
1288  6897 11 C6 48     		ld   de,18624+6
1289  689A 21 EA 68          	ld hl,presstxt
1290  689D CD AF 7A             call print
1291  68A0
1292  68A0 2A 87 66     		ld hl,(savepoc)
1293  68A3 22 D5 79     		ld (ALLFILES),hl
1294  68A6 76           nula1	halt
1295  68A7 AF           		XOR A ;test keyboard
1296  68A8 DB FE        		IN A,(#FE)
1297  68AA 2F           		CPL
1298  68AB E6 0F        		AND 15
1299  68AD 28 F7        		JR Z,nula1
1300  68AF AF           		XOR A ;test keyboard
1301  68B0 DB FE        		IN A,(#FE)
1302  68B2 2F           		CPL
1303  68B3 E6 0F        		AND 15
1304  68B5 28 EF        		JR Z,nula1
1305  68B7
1306  68B7 CD 37 74     		call loadscr
1307  68BA ED 91 07 00  		nextreg #07,0			;3,5 MHz
1308  68BE C9           		ret
1309  68BF C3 93 6D     		jp reload
1310  68C2
1311  68C2 4E 6F 74 68  nulatxt defb "Nothing found!",0
1311  68C6 69 6E 67 20
1311  68CA 66 6F 75 6E
1311  68CE 64 21 00
1312  68D1 49 20 6D 75  reloadtxt defb "I must reload directory!",0
1312  68D5 73 74 20 72
1312  68D9 65 6C 6F 61
1312  68DD 64 20 64 69
1312  68E1 72 65 63 74
1312  68E5 6F 72 79 21
1312  68E9 00
1313  68EA 50 72 65 73  presstxt defb "Press any key to continue.",0
1313  68EE 73 20 61 6E
1313  68F2 79 20 6B 65
1313  68F6 79 20 74 6F
1313  68FA 20 63 6F 6E
1313  68FE 74 69 6E 75
1313  6902 65 2E 00
1314  6905 CD 37 74     end_hledej 	 call loadscr		;návrat pomocí klávesy EDIT
1315  6908 C9           			 ret
1316  6909 00 00 00...  templfn		ds	129
1317  698A              ;Posunutí o stránku výše - šipka doleva
1318  698A              left
1319  698A 2A BD 75     		ld hl,(apos_all)
1320  698D 7C           		ld a,h
1321  698E B5           		or l
1322  698F C8           		ret z  			;skončí, pokud jsme na nultém souboru
1323  6990
1324  6990 3A 13 75     		ld a,(POS_F+1)
1325  6993 B7           		or a
1326  6994 28 32        		jr z,next_page_left
1327  6996
1328  6996 3A 13 75     		ld a,(POS_F+1)
1329  6999 0E 0F                ld  c,%00001111
1330  699B CD D8 79             call KURZOR			;smaž kurzor
1331  699E
1332  699E 3A 13 75     		ld a,(POS_F+1)
1333  69A1 5F           		ld e,a
1334  69A2 16 00        		ld d,0
1335  69A4 2A BD 75     		ld hl,(apos_all)
1336  69A7 B7           		or a
1337  69A8 ED 52        		sbc hl,de
1338  69AA 22 BD 75     		ld (apos_all),hl
1339  69AD AF           		xor a
1340  69AE 32 13 75     		ld (POS_F+1),a
1341  69B1 0E 17                ld   c,%00010111
1342  69B3 CD D8 79             call KURZOR
1343  69B6 CD B8 65     		call LFNPRINT
1344  69B9 21 07 B9     		ld hl,LFNNAME + maxline
1345  69BC 36 00        		ld (hl),0
1346  69BE 21 E2 B8     		ld hl,LFNNAME
1347  69C1 11 C2 50     		ld de,20672+2
1348  69C4 CD AF 7A     		call print
1349  69C7
1350  69C7 C9           		ret
1351  69C8
1352  69C8
1353  69C8              next_page_left
1354  69C8
1355  69C8 2A BD 75     		ld hl,(apos_all)
1356  69CB 11 11 00     		ld de,17
1357  69CE B7           		or a
1358  69CF ED 52        		sbc hl,de
1359  69D1 38 24        		jr c,next_left1		;méně než 17
1360  69D3 22 BD 75     		ld (apos_all),hl
1361  69D6 06 0D        		ld b,13
1362  69D8 CD C2 6C     		call mull
1363  69DB 11 0D 80     		ld de,catbuff+13
1364  69DE 19           		add hl,de
1365  69DF 22 DB 78     		ld (WRBUFF+1),hl
1366  69E2 CD C5 78     		call WRFILES
1367  69E5 CD B8 65     		call LFNPRINT
1368  69E8 21 07 B9     		ld hl,LFNNAME + maxline
1369  69EB 36 00        		ld (hl),0
1370  69ED 21 E2 B8     		ld hl,LFNNAME
1371  69F0 11 C2 50     		ld de,20672+2
1372  69F3 CD AF 7A     		call print
1373  69F6
1374  69F6
1375  69F6 C9           		ret
1376  69F7              next_left1
1377  69F7 21 00 00     		ld hl,0
1378  69FA 22 BD 75     		ld (apos_all),hl
1379  69FD 21 0D 80     		ld hl,catbuff+13
1380  6A00 22 DB 78     		ld (WRBUFF+1),hl
1381  6A03 CD C5 78     		call WRFILES
1382  6A06 CD B8 65     		call LFNPRINT
1383  6A09 21 07 B9     		ld hl,LFNNAME + maxline
1384  6A0C 36 00        		ld (hl),0
1385  6A0E 21 E2 B8     		ld hl,LFNNAME
1386  6A11 11 C2 50     		ld de,20672+2
1387  6A14 CD AF 7A     		call print
1388  6A17
1389  6A17 C9           		ret
1390  6A18
1391  6A18              ; Posunutí o stránku níž - šipka doprava
1392  6A18              right
1393  6A18 2A D5 79     		ld hl,(ALLFILES)
1394  6A1B 2B           		dec hl
1395  6A1C
1396  6A1C 1E 11        		ld e,17
1397  6A1E 16 00        		ld d,0
1398  6A20 B7           		or a
1399  6A21 ED 52        		sbc hl,de
1400  6A23 19           		add hl,de
1401  6A24 DA 60 6C     		jp c,posledni
1402  6A27
1403  6A27 3A 13 75     		ld a,(POS_F+1)
1404  6A2A FE 11        		cp 17
1405  6A2C CA F8 6B     		jp z,next_page
1406  6A2F
1407  6A2F 3A 13 75     		ld  a,(POS_F+1)		;na konec stránky
1408  6A32 F5           		push af
1409  6A33 0E 0F                ld  c,%00001111
1410  6A35 CD D8 79             call KURZOR
1411  6A38 3E 11        		ld a,17
1412  6A3A 32 13 75     		ld (POS_F+1),a
1413  6A3D 2A BD 75     		ld hl,(apos_all)
1414  6A40 C1           		pop bc
1415  6A41 F5           		push af
1416  6A42 3E 11        		ld a,17
1417  6A44 B7           		or a
1418  6A45 98           		sbc a,b
1419  6A46 5F           		ld e,a
1420  6A47 16 00        		ld d,0
1421  6A49 19           		add hl,de
1422  6A4A 22 BD 75     		ld (apos_all),hl
1423  6A4D 0E 17                ld   c,%00010111
1424  6A4F F1           		pop af
1425  6A50 CD D8 79             call KURZOR
1426  6A53 CD B8 65     		call LFNPRINT
1427  6A56 21 07 B9     		ld hl,LFNNAME + maxline
1428  6A59 36 00        		ld (hl),0
1429  6A5B 21 E2 B8     		ld hl,LFNNAME
1430  6A5E 11 C2 50     		ld de,20672+2
1431  6A61 CD AF 7A     		call print
1432  6A64
1433  6A64 C9           		ret
1434  6A65
1435  6A65
1436  6A65              reload_dir
1437  6A65
1438  6A65 F3           			di
1439  6A66 CD 28 65     			call BUFF83
1440  6A69 21 00 80     			ld hl,#8000
1441  6A6C 11 01 80     			ld de,#8001
1442  6A6F 01 00 04     			ld bc,1024
1443  6A72 AF           			xor a
1444  6A73 77           			ld (hl),a
1445  6A74 ED B0        			ldir
1446  6A76
1447  6A76 01 FD 7F     			ld bc,port1       ;the horizontal ROM switch/RAM
1448  6A79                                              ;switch I/O ad dress
1449  6A79 3A 5C 5B                 ld a,(bankm)      ;sys tem vari able that holds cur rent
1450  6A7C                                              ;switch state
1451  6A7C CB A7                    res 4,a           ;move right to left in hor i zon tal
1452  6A7E                                              ;ROM switch (3 to 2)
1453  6A7E
1454  6A7E F6 07                      or 7              ;switch in RAM page 7
1455  6A80 32 5C 5B                   ld (bankm),a      ;must keep sys tem vari able up to
1456  6A83                            	                  ;date (very im por tant)
1457  6A83 ED 79                      out (c),a         ;make the switch
1458  6A85
1459  6A85                                             ;be low BFE0h
1460  6A85 FB                         ei                ;in ter rupts can now be en abled
1461  6A86
1462  6A86 21 00 80                   ld hl,catbuff     ;some where for DOS to put the cata
1463  6A89                                              ;log
1464  6A89 11 01 80                   ld de,catbuff+1   ;
1465  6A8C 01 00 04                   ld bc,1024        ;max i mum (for +3DOS) is ac tu ally
1466  6A8F                                              ;64x13+13 = 845
1467  6A8F 36 00                      ld (hl),0
1468  6A91 ED B0                      ldir              ;make sure at least first en try is
1469  6A93 11 00 80                   ld de,catbuff     ;the lo ca tion to be filled with the
1470  6A96              aNextDirItem
1471  6A96 06 E7                      ld b,pocetpolozek ;the num ber of en tries in the
1472  6A98                                              ;buffer
1473  6A98 0E 04                      ld c,%100            ;include sys tem files in the cata
1474  6A9A 21 35 66                   ld hl,stardstar   ;the file name ("*.*")
1475  6A9D CD 1E 01                   call dos_catalog  ;call the DOS en try
1476  6AA0              NEXT0
1477  6AA0 22 AB 61                   ld (savehl),hl
1478  6AA3 DD 22 AD 61  			  ld (saveix),ix
1479  6AA7 78           			  ld a,b
1480  6AA8 FE E7        			  cp pocetpolozek
1481  6AAA F5           			  push af
1482  6AAB
1483  6AAB 2A D5 79     			  ld hl,(ALLFILES)
1484  6AAE 58           			  ld e,b
1485  6AAF 16 00        			  ld d,0
1486  6AB1 19           			  add hl,de
1487  6AB2 2B           			  dec hl
1488  6AB3 22 D5 79     			  ld (ALLFILES),hl
1489  6AB6
1490  6AB6 E5           			push hl
1491  6AB7 D5           			push de
1492  6AB8 C5           			push bc
1493  6AB9
1494  6AB9
1495  6AB9 2A 17 65     			ld hl,(dirNum)
1496  6ABC 19           			add	hl,de
1497  6ABD 2B           			dec hl
1498  6ABE 22 17 65     			ld 	(dirNum),hl
1499  6AC1 11 78 48     			ld de,18528+24
1500  6AC4 ED 53 FB 64  			ld (NUMPOS+1),de
1501  6AC8
1502  6AC8 CD C8 64     			call DEC16
1503  6ACB 00 14        			defw 20*256
1504  6ACD C1           			pop bc
1505  6ACE D1           			pop de
1506  6ACF E1           			pop hl
1507  6AD0
1508  6AD0
1509  6AD0 3A D4 79     			  ld a,(FILES)
1510  6AD3 80           			  add a,b
1511  6AD4 3D           			  dec a
1512  6AD5 32 D4 79     			  ld (FILES),a
1513  6AD8 F1           			  pop af
1514  6AD9 38 15        			  jr c,acont
1515  6ADB
1516  6ADB 78           			  ld a,b
1517  6ADC B7           			  or a
1518  6ADD 28 11        			  jr z,acont
1519  6ADF
1520  6ADF 3A 0F 60     			  ld a,(virtmem)
1521  6AE2 FE 04        			  cp 4
1522  6AE4 28 0A        			  jr z,acont
1523  6AE6
1524  6AE6 CD A0 61     			  call CountMemory
1525  6AE9 EB           			  ex de,hl
1526  6AEA 21 0F 60     			ld hl,virtmem
1527  6AED 34           			inc (hl)
1528  6AEE 18 A6        			jr aNextDirItem
1529  6AF0              acont
1530  6AF0 F5                       push af
1531  6AF1
1532  6AF1 2A 17 65     			ld hl,(dirNum)
1533  6AF4 11 78 48     			ld de,18528+24
1534  6AF7 ED 53 FB 64  			ld (NUMPOS+1),de
1535  6AFB 76           			halt
1536  6AFC CD C8 64     			call DEC16
1537  6AFF 00 14        			defw 20*256
1538  6B01
1539  6B01 E1                         pop hl
1540  6B02 22 3B 66                   ld (dosret),hl    ;put it where it can be seen from
1541  6B05                                              ; NextBASIC
1542  6B05 48                         ld c,b            ;move num ber of files in cat a log to
1543  6B06                                              ;low byte of BC
1544  6B06 06 00                      ld b,0            ;this will be re turned in NextBASIC
1545  6B08
1546  6B08 F3                         di                ;about to ROM/RAM switch so be
1547  6B09                                              ;care ful
1548  6B09 C5                         push bc           ;save num ber of files
1549  6B0A 01 FD 7F                   ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
1550  6B0D                                              ;switch
1551  6B0D 3A 5C 5B                   ld a,(bankm)      ;get cur rent switch state
1552  6B10
1553  6B10
1554  6B10 CB E7                      set 4,a           ;move left to right (ROM 2 to ROM
1555  6B12                                              ;3)
1556  6B12 E6 F8                      and #F8           ;also want RAM page 0
1557  6B14 32 5C 5B                   ld (bankm),a      ;up date the sys tem vari able (very
1558  6B17                                              ;im por tant)
1559  6B17 ED 79                      out (c),a         ;make the switch
1560  6B19 C1                         pop bc            ;get back the saved num ber of files
1561  6B1A 0B                         dec bc
1562  6B1B
1563  6B1B
1564  6B1B
1565  6B1B CD 28 65     			 call BUFF83
1566  6B1E              JKJK
1567  6B1E 21 0D 80     			 ld hl,catbuff+13
1568  6B21 ED 5B D5 79  			 ld de,(ALLFILES)
1569  6B25 ED 53 10 60  			 ld (save_allfiles),de
1570  6B29              ;			 dec de
1571  6B29 D5           atestovani	 push de
1572  6B2A E5           			 push hl
1573  6B2B DD E1        			 pop ix
1574  6B2D DD E5        			 push ix
1575  6B2F DD CB 07 7E  			 bit 7,(ix+7)
1576  6B33              ;			 pop hl
1577  6B33 20 53        			 jr nz,asouhlasi
1578  6B35
1579  6B35 11 08 00     			 ld de,8
1580  6B38 19           			 add hl,de		;v HL je začátek přípony souboru
1581  6B39 E5           			 push hl
1582  6B3A 11 97 73     			 ld de,PT2
1583  6B3D CD 8D 61     			 call compare
1584  6B40 E1           			 pop hl
1585  6B41 28 45        			 jr z,asouhlasi
1586  6B43 E5           			 push hl
1587  6B44 11 9A 73     			 ld de,PT3
1588  6B47 CD 8D 61     			 call compare
1589  6B4A E1           			 pop hl
1590  6B4B 28 3B        			 jr z,asouhlasi
1591  6B4D 11 9D 73     			 ld de,SQT
1592  6B50 E5           			 push hl
1593  6B51 CD 8D 61     			 call compare
1594  6B54 E1           			 pop hl
1595  6B55 28 31        			 jr z,asouhlasi
1596  6B57
1597  6B57 11 A0 73     			 ld de,STC
1598  6B5A E5           			 push hl
1599  6B5B CD 8D 61     			 call compare
1600  6B5E E1           			 pop hl
1601  6B5F 28 27        			 jr z,asouhlasi
1602  6B61
1603  6B61 11 A3 73      			 ld de,STP
1604  6B64 E5           			 push hl
1605  6B65 CD 8D 61     			 call compare
1606  6B68 E1           			 pop hl
1607  6B69 28 1D        			 jr z,asouhlasi
1608  6B6B
1609  6B6B D1           			 pop de
1610  6B6C D5           			 push de		;v de mame zacatek jmena souboru
1611  6B6D 62           			 ld h,d
1612  6B6E 6B           			 ld l,e
1613  6B6F ED 34 0D 00  			 add hl,13		;vynechana jedna polozka
1614  6B73 01 36 2E     			 ld bc,910*13
1615  6B76 ED B0        			 ldir
1616  6B78
1617  6B78 2A D5 79     			 ld hl,(ALLFILES)
1618  6B7B 2B           			 dec hl
1619  6B7C 22 D5 79     			 ld (ALLFILES),hl
1620  6B7F E1           			 pop hl
1621  6B80 D1           			 pop de
1622  6B81 1B           			 dec de
1623  6B82 7A           			 ld a,d
1624  6B83 B3           			 or e
1625  6B84 20 A3        			 jr nz,atestovani
1626  6B86 18 0B        			 jr askon
1627  6B88              asouhlasi
1628  6B88 E1           			 pop hl
1629  6B89 11 0D 00     			 ld de,13
1630  6B8C 19           			 add hl,de
1631  6B8D D1           			 pop de
1632  6B8E 1B           			 dec de
1633  6B8F 7A           			 ld a,d
1634  6B90 B3           			 or e
1635  6B91 20 96        			 jr nz,atestovani
1636  6B93 FB           askon		ei
1637  6B94
1638  6B94 11 84 48     			 ld de,18560+4
1639  6B97 21 8B 6C     			 ld hl,txtLFNinfo
1640  6B9A CD AF 7A     			 call print
1641  6B9D CD CE 6C     			 call getAllLFN
1642  6BA0 CD FB 6D     			call GETDIR
1643  6BA3 21 00 40     			 ld hl,16384
1644  6BA6 11 01 40     			 ld de,16385
1645  6BA9 01 FF 17     			 ld bc,6143
1646  6BAC AF           			 xor a
1647  6BAD 77           			 ld (hl),a
1648  6BAE ED B0        			 ldir
1649  6BB0
1650  6BB0 CD 39 65     			 call NOBUFF83
1651  6BB3
1652  6BB3 CD A4 77                  call kresli
1653  6BB6
1654  6BB6 21 0D 80     			 ld hl,catbuff+#d
1655  6BB9 22 DB 78     		     ld (WRBUFF+1),hl
1656  6BBC
1657  6BBC CD C5 78                  call WRFILES      ;vypis soubory
1658  6BBF 11 2F 48     			 ld de,18464+15
1659  6BC2 21 07 7F     			 ld hl,txtcurrentfile
1660  6BC5 CD AF 7A     			 call print
1661  6BC8
1662  6BC8 11 0F 48     			 ld de,18432+15
1663  6BCB 21 FC 7E     			 ld hl,txtallfiles
1664  6BCE CD AF 7A     			 call print
1665  6BD1
1666  6BD1
1667  6BD1 11 4F 50     			ld de,20544+15
1668  6BD4 21 A8 6F     			ld hl,lfndir
1669  6BD7 CD AF 7A     			call print
1670  6BDA 11 52 50     			ld de,20544+15+3
1671  6BDD 21 E7 6D     			ld hl,NAZEVADRESARE
1672  6BE0 CD AF 7A     			call print
1673  6BE3
1674  6BE3
1675  6BE3 CD 19 65     			call LFNWINDOW
1676  6BE6 CD B8 65     			call LFNPRINT
1677  6BE9 21 07 B9     			ld hl,LFNNAME + maxline
1678  6BEC 36 00        			ld (hl),0
1679  6BEE 21 E2 B8     			ld hl,LFNNAME
1680  6BF1 11 C2 50     			ld de,20672+2
1681  6BF4 CD AF 7A     			call print
1682  6BF7
1683  6BF7 C9           		ret
1684  6BF8
1685  6BF8
1686  6BF8              next_page
1687  6BF8 2A BD 75     		ld hl,(apos_all)
1688  6BFB 23           		inc hl
1689  6BFC              		;test jestli už není víc souborů
1690  6BFC
1691  6BFC EB           		ex de,hl			;de ... aktualni pozice začátku výpisu
1692  6BFD 2A D5 79     		ld hl,(ALLFILES)	;hl ... pocet souboru
1693  6C00 D5           		push de
1694  6C01 11 12 00     		ld de,18			;odečti počet na jednu stránku
1695  6C04 B7           		or a
1696  6C05 ED 52        		sbc hl,de			;hl ... počet souborů - 18
1697  6C07 D1           		pop de				;de ... aktuální pozice
1698  6C08 B7           		or a
1699  6C09 ED 52        		sbc hl,de
1700  6C0B 30 10        		jr nc, next2
1701  6C0D 2A D5 79     		ld hl,(ALLFILES)
1702  6C10 B7           		or a
1703  6C11 11 11 00     		ld de,17
1704  6C14 ED 52        		sbc hl,de
1705  6C16 3E 01        		ld a,1
1706  6C18 32 5F 6C     		ld (maxfile),a
1707  6C1B 18 08        		jr next3
1708  6C1D              next2
1709  6C1D 2A BD 75     		ld hl,(apos_all)
1710  6C20 23           		inc hl
1711  6C21 AF           		xor a
1712  6C22 32 5F 6C     		ld (maxfile),a
1713  6C25              next3
1714  6C25 06 0D        		ld b,13
1715  6C27 CD C2 6C     		call mull
1716  6C2A 11 00 80     		ld de,catbuff ;+13
1717  6C2D 19           		add hl,de
1718  6C2E 22 DB 78     		ld (WRBUFF+1),hl
1719  6C31 CD C5 78     		call WRFILES
1720  6C34 3A 5F 6C     		ld a,(maxfile)
1721  6C37 B7           		or a
1722  6C38 20 0C        		jr nz,next4
1723  6C3A 2A BD 75     		ld hl,(apos_all)
1724  6C3D 11 11 00     		ld de,17
1725  6C40 19           		add hl,de
1726  6C41 22 BD 75     		ld (apos_all),hl
1727  6C44 18 07        		jr next5
1728  6C46 2A D5 79     next4	ld hl,(ALLFILES)
1729  6C49 2B           		dec hl
1730  6C4A 22 BD 75     		ld (apos_all),hl
1731  6C4D CD B8 65     next5	call LFNPRINT
1732  6C50 21 07 B9     		ld hl,LFNNAME + maxline
1733  6C53 36 00        		ld (hl),0
1734  6C55 21 E2 B8     		ld hl,LFNNAME
1735  6C58 11 C2 50     		ld de,20672+2
1736  6C5B CD AF 7A     		call print
1737  6C5E
1738  6C5E C9           		ret
1739  6C5F 00           maxfile	db 0
1740  6C60              posledni					;méně souborů než 17
1741  6C60 3A 13 75     	     ld  a,(POS_F+1)
1742  6C63 0E 0F                 ld  c,%00001111
1743  6C65 CD D8 79              call KURZOR
1744  6C68 2A D5 79     		 ld hl,(ALLFILES)
1745  6C6B 2B           		 dec hl
1746  6C6C 7D           		 ld a,l
1747  6C6D 32 13 75     		 ld (POS_F+1),a
1748  6C70
1749  6C70 22 BD 75     		 ld (apos_all),hl
1750  6C73 0E 17                 ld   c,%00010111
1751  6C75 CD D8 79              call KURZOR
1752  6C78 CD B8 65     		 call LFNPRINT
1753  6C7B 21 07 B9     		ld hl,LFNNAME + maxline
1754  6C7E 36 00        		ld (hl),0
1755  6C80 21 E2 B8     		ld hl,LFNNAME
1756  6C83 11 C2 50     		ld de,20672+2
1757  6C86 CD AF 7A     		call print
1758  6C89
1759  6C89 C9           		 ret
1760  6C8A
1761  6C8A
1762  6C8A              right1
1763  6C8A
1764  6C8A
1765  6C8A C9           		ret
1766  6C8B
1767  6C8B 47 65 74 74  txtLFNinfo defb "Getting LFN information:",0
1767  6C8F 69 6E 67 20
1767  6C93 4C 46 4E 20
1767  6C97 69 6E 66 6F
1767  6C9B 72 6D 61 74
1767  6C9F 69 6F 6E 3A
1767  6CA3 00
1768  6CA4 52 65 61 64  txtStart   defb "Reading files in directory:",0
1768  6CA8 69 6E 67 20
1768  6CAC 66 69 6C 65
1768  6CB0 73 20 69 6E
1768  6CB4 20 64 69 72
1768  6CB8 65 63 74 6F
1768  6CBC 72 79 3A 00
1769  6CC0              ;Nacte LFN vsech souboru nahranych v pameti
1770  6CC0
1771  6CC0 00 00        numLoop		defw 0
1772  6CC2
1773  6CC2
1774  6CC2
1775  6CC2              ; Násobení HL x B
1776  6CC2              ; Vysledek HL
1777  6CC2 55           mull		ld d,l		;vynásob spodní byty
1778  6CC3 58           			ld e,b		;
1779  6CC4 ED 30        			mul d,e		;vysledek je v de
1780  6CC6 EB           			ex de,hl	;vysledek je v hl
1781  6CC7 58           			ld e,b		;násobitel do e
1782  6CC8 ED 30        			mul d,e		;vynásob
1783  6CCA 7B           			ld a,e		;do akumulátoru hoď výsledek (spodní byte)
1784  6CCB 84           			add a,h
1785  6CCC 67           			ld h,a		;konečný výsledek je v HL
1786  6CCD C9           			ret
1787  6CCE
1788  6CCE              ; Tato rutina naplní banky ZX Next LFN jmény souborů,
1789  6CCE              ; o délce 128bytů.
1790  6CCE FB           getAllLFN	ei
1791  6CCF 21 00 00     			ld hl,0
1792  6CD2 22 C0 6C     			ld (numLoop),hl
1793  6CD5 21 00 E0     			ld hl,#e000
1794  6CD8 22 30 6D     			ld (InBuff+1),hl
1795  6CDB 3E 18        			ld a,24
1796  6CDD 32 2B 6D     			ld (Page+1),a
1797  6CE0 CD 23 74     			call savescr
1798  6CE3
1799  6CE3 CD 28 65     			call BUFF83
1800  6CE6 21 0D 80     			ld hl,catbuff+#d
1801  6CE9 11 84 6D     			ld de,bufftmp
1802  6CEC 01 0D 00     			ld bc,13
1803  6CEF ED B0        			ldir
1804  6CF1 CD 39 65     			call NOBUFF83
1805  6CF4
1806  6CF4 21 0D 80     			ld hl,catbuff+#d
1807  6CF7 22 82 6D     			ld (tmpname),hl
1808  6CFA ED 4B D5 79  			ld bc,(ALLFILES)
1809  6CFE C5           LFN1		push bc
1810  6CFF FB           			ei
1811  6D00
1812  6D00 2A C0 6C     			ld hl,(numLoop)
1813  6D03 23           			inc hl
1814  6D04 22 C0 6C     			ld 	(numLoop),hl
1815  6D07 11 98 48     lfnpos			ld de,18560+24	;pozice ve VideoRam
1816  6D0A ED 53 FB 64  			ld (NUMPOS+1),de
1817  6D0E CD C8 64     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
1818  6D11 00 14        			defw 20*256
1819  6D13 F3           			di				;zakaž přerušení, jinak bude problém, nemáme nastránkovanou ZX Rom
1820  6D14
1821  6D14 D9           			exx
1822  6D15              BFN
1823  6D15 11 84 6D     BufferName	ld de,bufftmp			;jmeno souboru
1824  6D18 21 35 66     			ld hl,stardstar
1825  6D1B DD 2A AB 61  			ld ix,(savehl)
1826  6D1F 01 E2 B8     			ld bc,LFNNAME
1827  6D22 D9           			exx
1828  6D23 0E 07        			ld c,7
1829  6D25 11 B7 01     			ld de,$01b7
1830  6D28 CF           			rst 8			;služba EsxDosu, která volá službu +3Dosu (zjištění LFN konkrétního souboru)
1831  6D29 94           			defb M_P3DOS
1832  6D2A 3E 18        Page		ld a,24
1833  6D2C ED 92 57     			nextreg $57,a	;nastrankuj stranku s volnymi daty
1834  6D2F
1835  6D2F 11 00 E0     InBuff		ld de,#e000		;ukazatel na pamet v bufferu
1836  6D32 21 E2 B8     			ld hl,LFNNAME	;buffer pro LFN
1837  6D35 01 80 00     			ld bc,maxlen		;ulož 64 bytů
1838  6D38 ED B0        			ldir
1839  6D3A
1840  6D3A CD 28 65     			call BUFF83
1841  6D3D 2A 82 6D     			ld hl,(tmpname)	;přesuň se na další položku v adresáři
1842  6D40 11 0D 00     			ld de,13
1843  6D43 19           			add hl,de
1844  6D44 22 82 6D     			ld (tmpname),hl	;a ulož adresu, kde se nachází
1845  6D47 11 84 6D     			ld de,bufftmp
1846  6D4A 01 0D 00     			ld bc,13
1847  6D4D ED B0        			ldir
1848  6D4F
1849  6D4F CD 39 65     			call NOBUFF83
1850  6D52
1851  6D52 3A 2B 6D     			ld a,(Page+1)
1852  6D55 ED 92 57     			nextreg $57,a
1853  6D58
1854  6D58 2A 30 6D     			ld hl,(InBuff+1)		;vypočti další adresu v bance ZX Next, kam budu ukládat
1855  6D5B 11 80 00     			ld de,maxlen
1856  6D5E 19           			add hl,de
1857  6D5F 22 30 6D     			ld (InBuff+1),hl
1858  6D62
1859  6D62 11 7F FF     			ld de,#FFFF-128
1860  6D65 B7           			or a
1861  6D66 ED 52        			sbc hl,de
1862  6D68 38 0A        			jr c,contin
1863  6D6A 21 2B 6D     			ld hl,Page+1
1864  6D6D 34           			inc (hl)
1865  6D6E 21 00 E0     			ld hl,#e000
1866  6D71 22 30 6D     			ld (InBuff+1),hl
1867  6D74 C1           contin		pop bc				;zopakuj to pro všechny soubory, které máme načtené...
1868  6D75 0B           			dec bc
1869  6D76 78           			ld a,b
1870  6D77 B1           			or c
1871  6D78 20 84        			jr nz,LFN1
1872  6D7A
1873  6D7A ED 91 57 01  			nextreg $57,1			;vráť zpátky stránku, kde se nachází data pro player
1874  6D7E CD 37 74     			call loadscr			;obnov obrazovku
1875  6D81 C9           			ret
1876  6D82 00 00        tmpname		ds 2
1877  6D84              BFT
1878  6D84 00 00 00...  bufftmp		ds 15
1879  6D93              M_P3DOS	equ $94
1880  6D93              reload
1881  6D93 ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
1882  6D97 21 42 48     		ld hl, 18496+2
1883  6D9A 01 1C 04     		ld   bc,4*256+28
1884  6D9D 3E 05        		ld   a,%00000101
1885  6D9F CD D2 76     		call RAMECEK
1886  6DA2
1887  6DA2 11 64 48     		ld de,18528+4
1888  6DA5 21 A4 6C     		ld hl,txtStart
1889  6DA8 CD AF 7A     		call print
1890  6DAB
1891  6DAB 21 00 00     		ld hl,0
1892  6DAE 22 D5 79     		ld (ALLFILES),hl
1893  6DB1 22 17 65     		ld (dirNum),hl
1894  6DB4 22 BD 75     		ld (apos_all),hl
1895  6DB7 AF           		xor a
1896  6DB8 32 13 75     		ld (POS_F+1),a
1897  6DBB 32 0F 60     		ld (virtmem),a
1898  6DBE 21 00 80     		ld hl,catbuff
1899  6DC1 22 A4 61     		ld (Count11+1),hl
1900  6DC4              		; ld hl,(save_allfiles)
1901  6DC4              		; ld (ALLFILES),hl
1902  6DC4 CD 65 6A     		call reload_dir
1903  6DC7              		; ld de,18560+4
1904  6DC7              			 ; ld hl,txtLFNinfo
1905  6DC7              			 ; call print
1906  6DC7              			 ; call getAllLFN
1907  6DC7
1908  6DC7              			 ; ld hl,16384
1909  6DC7              			 ; ld de,16385
1910  6DC7              			 ; ld bc,6143
1911  6DC7              			 ; xor a
1912  6DC7              			 ; ld (hl),a
1913  6DC7              			 ; ldir
1914  6DC7
1915  6DC7
1916  6DC7              			; call NOBUFF83
1917  6DC7                           ; call kresli
1918  6DC7
1919  6DC7              			 ; ld hl,catbuff+#d
1920  6DC7              		     ; ld (WRBUFF+1),hl
1921  6DC7
1922  6DC7                           ; call WRFILES      ;vypis soubory
1923  6DC7              			 ; ld de,18464+15
1924  6DC7              			 ; ld hl,txtcurrentfile
1925  6DC7              			 ; call print
1926  6DC7
1927  6DC7              			 ; ld de,18432+15
1928  6DC7              			 ; ld hl,txtallfiles
1929  6DC7              			 ; call print
1930  6DC7
1931  6DC7              			; call LFNWINDOW
1932  6DC7              			; call LFNPRINT
1933  6DC7              			; ld hl,LFNNAME + maxline
1934  6DC7              			; ld (hl),0
1935  6DC7              			; ld hl,LFNNAME
1936  6DC7              			; ld de,20672+2
1937  6DC7              			; call print
1938  6DC7
1939  6DC7 ED 91 07 00  		nextreg #07,0             ;3,5 Mhz
1940  6DCB C9           		ret
1941  6DCC 00 00 00...  DIRNAME	defs 13
1942  6DD9 FF           		defb 255
1943  6DDA 43 3A FF     DIRTMP  defb "C:",255
1944  6DDD 00 00 00...  		ds 10
1945  6DE7 00 00 00...  NAZEVADRESARE	ds 20
1946  6DFB              GETDIR
1947  6DFB 21 DA 6D     		ld hl,DIRTMP
1948  6DFE 11 D4 B0     		ld de,modstart
1949  6E01 01 04 00     		ld bc,4
1950  6E04 ED B0        		ldir
1951  6E06
1952  6E06 01 FD 7F     		ld bc,port1
1953  6E09 3A 5C 5B             ld a,(bankm)      ;sys tem vari able that holds cur rent
1954  6E0C CB A7                res 4,a           ;move right to left in hor i zon tal
1955  6E0E F6 07                or 7              ;switch in RAM page 7
1956  6E10 32 5C 5B             ld (bankm),a      ;must keep sys tem vari able up to
1957  6E13 ED 79                out (c),a         ;make the switch
1958  6E15
1959  6E15 3E 01        		ld a,1				;get path
1960  6E17 21 D4 B0     		ld hl,modstart
1961  6E1A CD B1 01     		call $01b1
1962  6E1D
1963  6E1D 38 04        		jr c,ok1
1964  6E1F 3E 02        EEEE	ld a,2
1965  6E21 D3 FE        		out (254),a
1966  6E23
1967  6E23 01 FD 7F     ok1		ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
1968  6E26 3A 5C 5B             ld a,(bankm)      ;get cur rent switch state
1969  6E29 CB E7                set 4,a           ;move left to right (ROM 2 to ROM
1970  6E2B E6 F8                and #F8           ;also want RAM page 0
1971  6E2D 32 5C 5B             ld (bankm),a      ;up date the sys tem vari able (very
1972  6E30 ED 79                out (c),a         ;make the switch
1973  6E32
1974  6E32 21 D4 B0     		ld hl,modstart
1975  6E35 01 00 04     		ld bc,1024
1976  6E38 3E FF        		ld a,#ff
1977  6E3A ED B1        		cpir
1978  6E3C              AAA
1979  6E3C 2B           		dec hl
1980  6E3D 2B           		dec hl
1981  6E3E 2B           		dec hl
1982  6E3F
1983  6E3F E5           		push hl
1984  6E40 21 D0 6F     		ld hl,DIRBUFF
1985  6E43 11 D1 6F     		ld de,DIRBUFF+1
1986  6E46 01 0D 00     		ld bc,13
1987  6E49 3E 20        		ld a,32
1988  6E4B 77           		ld (hl),a
1989  6E4C ED B0        		ldir
1990  6E4E E1           		pop hl
1991  6E4F
1992  6E4F
1993  6E4F 7E           pr1		ld a,(hl)
1994  6E50 FE 2F        		cp "/"
1995  6E52 28 08        		jr z,pr0
1996  6E54 FE 3A        		cp ":"
1997  6E56 CA AD 6F     		jp z,root
1998  6E59
1999  6E59 2B           		dec hl
2000  6E5A 18 F3        		jr pr1
2001  6E5C
2002  6E5C
2003  6E5C 23           pr0		inc hl
2004  6E5D
2005  6E5D 11 D0 6F     		ld de,DIRBUFF
2006  6E60 06 08        		ld b,8
2007  6E62              presun
2008  6E62 7E           		ld a,(hl)
2009  6E63 FE 2F        		cp "/"
2010  6E65 28 05        		jr z,prk
2011  6E67 12           		ld (de),a
2012  6E68 13           		inc de
2013  6E69 23           		inc hl
2014  6E6A 10 F6        		djnz presun
2015  6E6C
2016  6E6C              prk
2017  6E6C
2018  6E6C 21 D0 6F     		ld hl,DIRBUFF
2019  6E6F 01 07 00     		ld bc,7
2020  6E72 3E 2E        		ld a,"."
2021  6E74
2022  6E74 ED B1        		cpir
2023  6E76 20 1E        		jr nz,PRK2
2024  6E78 E5           		push hl
2025  6E79 11 D8 6F     		ld de,DIRBUFF+8
2026  6E7C 01 04 00     		ld bc,4
2027  6E7F ED B0        		ldir
2028  6E81              PRK0
2029  6E81 E1           		pop hl				;adresa s teckou v HL
2030  6E82 2B           		dec hl
2031  6E83 E5           		push hl
2032  6E84 EB           		ex de,hl			;je v DE
2033  6E85 21 D7 6F     		ld hl,DIRBUFF+7		;az kam
2034  6E88 B7           		or a
2035  6E89 ED 52        		sbc hl,de
2036  6E8B E5           		push hl
2037  6E8C C1           		pop bc				;počet bytu
2038  6E8D E1           		pop hl
2039  6E8E 54           		ld d,h
2040  6E8F 5D           		ld e,l
2041  6E90 13           		inc de
2042  6E91 3E 20        		ld a,32
2043  6E93 77           		ld (hl),a
2044  6E94 ED B0        		ldir
2045  6E96
2046  6E96              PRK2
2047  6E96 AF           		xor a
2048  6E97 21 DB 6F     		ld hl,DIRBUFF+11
2049  6E9A 77           		ld (hl),a
2050  6E9B 23           		inc hl
2051  6E9C 77           		ld (hl),a
2052  6E9D 23           		inc hl
2053  6E9E 77           		ld (hl),a
2054  6E9F 23           		inc hl
2055  6EA0 77           		ld (hl),a
2056  6EA1 21 D7 6F     		ld hl,DIRBUFF+7
2057  6EA4 CB FE        		set 7,(hl)
2058  6EA6
2059  6EA6 21 A5 6F     		ld hl,parrent
2060  6EA9 22 7D 6F     		ld (goto+1),hl
2061  6EAC              		;call gotodir
2062  6EAC
2063  6EAC 01 FD 7F     		ld bc,port1
2064  6EAF 3A 5C 5B             ld a,(bankm)
2065  6EB2 CB A7                res 4,a
2066  6EB4 F6 07                or 7
2067  6EB6 32 5C 5B             ld (bankm),a
2068  6EB9 ED 79                out (c),a
2069  6EBB
2070  6EBB AF           		xor a
2071  6EBC 21 A5 6F     		ld hl,parrent
2072  6EBF CD B1 01     		call $01b1				;skoc do nadrizeneho adresare
2073  6EC2
2074  6EC2 ED 91 54 16  		nextreg $54,22
2075  6EC6 ED 91 55 17  		nextreg $55,23
2076  6ECA 21 00 80     		ld hl,32768
2077  6ECD 22 D5 6E     		ld (FF+1),hl
2078  6ED0 AF           		xor a
2079  6ED1 32 0F 60     		ld (virtmem),a
2080  6ED4
2081  6ED4
2082  6ED4
2083  6ED4 11 00 80     FF		ld de,32768
2084  6ED7 06 E7                ld b,pocetpolozek
2085  6ED9 21 35 66             ld hl,stardstar
2086  6EDC 0E 04        		ld c,%100
2087  6EDE CD 1E 01     		call dos_catalog
2088  6EE1 3E E7        		ld a,pocetpolozek
2089  6EE3 A8           		xor b
2090  6EE4 20 15        		jr nz,PRK4
2091  6EE6 2A D5 6E     		ld hl,(FF+1)
2092  6EE9 11 BB 0B     		ld de,pocetpolozek*13
2093  6EEC 19           		add hl,de
2094  6EED 22 D5 6E     		ld (FF+1),hl
2095  6EF0 21 0F 60     		ld hl,virtmem
2096  6EF3 34           		inc (hl)
2097  6EF4 7E           		ld a,(hl)
2098  6EF5 EE 04        		xor 4
2099  6EF7 28 02        		jr z,PRK4
2100  6EF9 18 D9        		jr FF
2101  6EFB
2102  6EFB              PRK4
2103  6EFB 11 D0 6F     		ld de,DIRBUFF			;jmeno souboru
2104  6EFE 21 35 66     		ld hl,stardstar
2105  6F01 DD 2A AB 61  		ld ix,(savehl)
2106  6F05 01 E2 B8     		ld bc,LFNNAME
2107  6F08 CD B7 01     		call	$01b7
2108  6F0B
2109  6F0B              						;skoc zpatky do adresare
2110  6F0B 21 D7 6F     		ld hl,DIRBUFF+7
2111  6F0E CB BE        		res 7,(hl)
2112  6F10 3E FF        		ld a,255
2113  6F12 32 DB 6F     		ld (DIRBUFF+11),a
2114  6F15 21 D0 6F     		ld hl,DIRBUFF
2115  6F18 AF           		xor a
2116  6F19 CD B1 01     		call $01b1
2117  6F1C
2118  6F1C              		; ld hl,32768
2119  6F1C              		; ld (FF2+1),hl
2120  6F1C
2121  6F1C              ;FF2	ld de,32768
2122  6F1C                      ; ld b,pocetpolozek
2123  6F1C                      ; ld hl,stardstar
2124  6F1C              		; ld c,%101
2125  6F1C                      ; call dos_catalog  ;call the DOS en try
2126  6F1C              		; ld a,pocetpolozek
2127  6F1C              		; xor b
2128  6F1C              		; jr nz,PRK40
2129  6F1C              		; ld hl,(FF+1)
2130  6F1C              		; ld de,pocetpolozek*13
2131  6F1C              		; add hl,de
2132  6F1C              		; ld (FF2+1),hl
2133  6F1C              		; jr FF2
2134  6F1C              ; PRK40
2135  6F1C
2136  6F1C 01 FD 7F     		ld bc,port1
2137  6F1F 3A 5C 5B             ld a,(bankm)
2138  6F22 CB E7                set 4,a
2139  6F24 E6 F8                and #F8
2140  6F26 32 5C 5B             ld (bankm),a
2141  6F29 ED 79                out (c),a
2142  6F2B              PRK5
2143  6F2B 21 E2 B8     		ld hl,LFNNAME
2144  6F2E 01 80 00     		ld bc,128
2145  6F31 3E FF        		ld a,#ff
2146  6F33 ED B1        		cpir
2147  6F35 2B           		dec hl
2148  6F36 36 00        		ld (hl),0
2149  6F38 AF           		xor a
2150  6F39 32 F1 B8     		ld (LFNNAME+15),a
2151  6F3C 11 4F 50     		ld de,20544+15
2152  6F3F 21 A8 6F     		ld hl,lfndir
2153  6F42 CD AF 7A     		call print
2154  6F45 3E 20        		ld a,32
2155  6F47 32 E1 B8     		ld (LFNNAME-1),a
2156  6F4A 11 52 50     		ld de,20544+15+3
2157  6F4D 21 E1 B8     		ld hl,LFNNAME-1
2158  6F50              		;call print
2159  6F50
2160  6F50 21 E1 B8     		ld hl,LFNNAME-1
2161  6F53 11 E7 6D     		ld de,NAZEVADRESARE
2162  6F56 01 14 00     		ld bc,20
2163  6F59 ED B0        		ldir
2164  6F5B
2165  6F5B 21 D0 6F     		ld hl,DIRBUFF
2166  6F5E 22 7D 6F     		ld (goto+1),hl
2167  6F61 3E FF        		ld a,255
2168  6F63 32 DB 6F     		ld (DIRBUFF+11),a
2169  6F66 21 D7 6F     		ld hl,DIRBUFF+7
2170  6F69 CB BE        		res 7,(hl)
2171  6F6B              ;		call gotodir
2172  6F6B
2173  6F6B C9           		ret
2174  6F6C              GOTODIR
2175  6F6C              gotodir
2176  6F6C 01 FD 7F     		ld bc,port1
2177  6F6F 3A 5C 5B             ld a,(bankm)
2178  6F72 CB A7                res 4,a
2179  6F74 F6 07                or 7
2180  6F76 32 5C 5B             ld (bankm),a
2181  6F79 ED 79                out (c),a
2182  6F7B
2183  6F7B AF           		xor a
2184  6F7C 21 A5 6F     goto	ld hl,parrent
2185  6F7F CD B1 01     		call $01b1
2186  6F82
2187  6F82 38 04        		jr c,gok
2188  6F84 3E 02        		ld a,2
2189  6F86 D3 FE        		out (254),a
2190  6F88 01 FD 7F     gok		ld bc,port1
2191  6F8B 3A 5C 5B             ld a,(bankm)
2192  6F8E CB E7                set 4,a
2193  6F90 E6 F8                and #F8
2194  6F92 32 5C 5B             ld (bankm),a
2195  6F95 ED 79                out (c),a
2196  6F97 C9           		ret
2197  6F98
2198  6F98 41 7E 31 20  testpolozky defb "A~1    ",#a0,"POP",0,0
2198  6F9C 20 20 20 A0
2198  6FA0 50 4F 50 00
2198  6FA4 00
2199  6FA5
2200  6FA5 2E 2E FF     parrent 	defb 	"..",#ff
2201  6FA8
2202  6FA8 44 69 72 3A  lfndir		defb "Dir:", 0
2202  6FAC 00
2203  6FAD              root
2204  6FAD 3E 20        		ld a,32
2205  6FAF 32 E2 B8     		ld (LFNNAME),a
2206  6FB2 3E 2F        		ld a,"/"
2207  6FB4 32 E3 B8     		ld (LFNNAME+1),a
2208  6FB7 AF           		xor a
2209  6FB8 32 E4 B8     		ld (LFNNAME+2),a
2210  6FBB 11 4F 50     		ld de,20544+15
2211  6FBE 21 A8 6F     		ld hl,lfndir
2212  6FC1 CD AF 7A     		call print
2213  6FC4 21 E2 B8     		ld hl,LFNNAME
2214  6FC7 11 E7 6D     		ld de,NAZEVADRESARE
2215  6FCA 01 14 00     		ld bc,20
2216  6FCD ED B0        		ldir
2217  6FCF C9           		ret
2218  6FD0 00 00 00...  DIRBUFF	ds 15
2219  6FDF              CHANGEDIR
2220  6FDF ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
2221  6FE3
2222  6FE3
2223  6FE3 E5           		push hl
2224  6FE4 21 42 48     		ld hl, 18496+2
2225  6FE7 01 1C 04     		ld   bc,4*256+28
2226  6FEA 3E 05        		ld   a,%00000101
2227  6FEC CD D2 76     		call RAMECEK
2228  6FEF
2229  6FEF 11 64 48     		 ld de,18528+4
2230  6FF2 21 A4 6C     		 ld hl,txtStart
2231  6FF5 CD AF 7A     		 call print
2232  6FF8
2233  6FF8 21 00 00     		ld hl,0
2234  6FFB 22 D5 79     		ld (ALLFILES),hl
2235  6FFE 22 17 65     		ld (dirNum),hl
2236  7001 22 BD 75     		ld (apos_all),hl
2237  7004 AF           		xor a
2238  7005 32 13 75     		ld (POS_F+1),a
2239  7008 32 0F 60     		ld (virtmem),a
2240  700B 21 00 80     		ld hl,catbuff
2241  700E 22 A4 61     		ld (Count11+1),hl
2242  7011 21 00 00     		ld hl,0
2243  7014 22 D5 79     		ld (ALLFILES),hl
2244  7017
2245  7017 E1           		pop hl
2246  7018 CD 28 65     		call BUFF83
2247  701B DD 21 CC 6D  		ld ix,DIRNAME
2248  701F 06 0D        		ld b,13
2249  7021 7E           chngdir1 ld a,(hl)
2250  7022 CB BF        		res 7,a
2251  7024 B7           		or a
2252  7025 20 02        		jr nz,chng
2253  7027 3E 20        		ld a,32
2254  7029 DD 77 00     chng	ld (ix+0),a
2255  702C 23           		inc hl
2256  702D DD 23        		inc ix
2257  702F 10 F0        		djnz chngdir1
2258  7031              STOP
2259  7031
2260  7031 21 D7 6D     		ld hl,DIRNAME+11
2261  7034 7E           chng2	ld a,(hl)
2262  7035 FE 20        		cp 32
2263  7037 20 03        		jr nz,zap
2264  7039 2B           		dec hl
2265  703A 18 F8        		jr chng2
2266  703C 3E FF        zap		ld a,255
2267  703E 23           		inc hl
2268  703F 77           		ld (hl),a
2269  7040 01 FD 7F     		ld bc,port1
2270  7043 3A 5C 5B             ld a,(bankm)      ;sys tem vari able that holds cur rent
2271  7046 CB A7                res 4,a           ;move right to left in hor i zon tal
2272  7048 F6 07                or 7              ;switch in RAM page 7
2273  704A 32 5C 5B             ld (bankm),a      ;must keep sys tem vari able up to
2274  704D ED 79                out (c),a         ;make the switch
2275  704F
2276  704F AF           		xor a 			;change path
2277  7050 21 CC 6D     		ld hl,DIRNAME
2278  7053              AAAA
2279  7053 CD B1 01     		call $01b1
2280  7056
2281  7056 38 04        		jr c,ok
2282  7058 3E 02        ERROR	ld a,2
2283  705A D3 FE        		out (254),a
2284  705C
2285  705C 01 FD 7F     ok			ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
2286  705F 3A 5C 5B                 ld a,(bankm)      ;get cur rent switch state
2287  7062 CB E7                    set 4,a           ;move left to right (ROM 2 to ROM
2288  7064 E6 F8                    and #F8           ;also want RAM page 0
2289  7066 32 5C 5B                 ld (bankm),a      ;up date the sys tem vari able (very
2290  7069 ED 79                    out (c),a         ;make the switch
2291  706B CD 65 6A     			call reload_dir
2292  706E              ;			call GETDIR
2293  706E ED 91 07 00  			nextreg #07,0
2294  7072 C9           			ret
2295  7073 43 6F 6E 66  txtsetup	defb "Configuration",0
2295  7077 69 67 75 72
2295  707B 61 74 69 6F
2295  707F 6E 00
2296  7081 53 74 65 72  txtstereo	defb "Stereo:      ACB  /  ABC",0
2296  7085 65 6F 3A 20
2296  7089 20 20 20 20
2296  708D 20 41 43 42
2296  7091 20 20 2F 20
2296  7095 20 41 42 43
2296  7099 00
2297  709A 53 6F 75 6E  txtchip		defb "Sound chip:  AY   /   YM",0
2297  709E 64 20 63 68
2297  70A2 69 70 3A 20
2297  70A6 20 41 59 20
2297  70AA 20 20 2F 20
2297  70AE 20 20 59 4D
2297  70B2 00
2298  70B3
2299  70B3 43 6F 6E 74  txthelp0	defb "Controls:",0
2299  70B7 72 6F 6C 73
2299  70BB 3A 00
2300  70BD 42 72 65 61  txthelp1	defb "Break: stop play | Space: next song",0
2300  70C1 6B 3A 20 73
2300  70C5 74 6F 70 20
2300  70C9 70 6C 61 79
2300  70CD 20 7C 20 53
2300  70D1 70 61 63 65
2300  70D5 3A 20 6E 65
2300  70D9 78 74 20 73
2300  70DD 6F 6E 67 00
2301  70E1 20 20 41 3A  txthelp2	defb "  A: AY | Y: YM | C: ACB | B: ABC  ",0
2301  70E5 20 41 59 20
2301  70E9 7C 20 59 3A
2301  70ED 20 59 4D 20
2301  70F1 7C 20 43 3A
2301  70F5 20 41 43 42
2301  70F9 20 7C 20 42
2301  70FD 3A 20 41 42
2301  7101 43 20 20 00
2302  7105
2303  7105              vyrazni		equ 01000111b
2304  7105
2305  7105              showsetup
2306  7105              			NEXTREG2A 06
2306  7105 3E 06       >        ld     a,06
2306  7107 CD 12 60    >        call   ReadNextReg
2307  710A CB 47        			bit 0,a 		;AY
2308  710C 20 16        			jr nz,sAY
2309  710E
2310  710E
2311  710E 3E 47        			ld a,vyrazni
2312  7110 21 95 58     			ld hl,22528+32*4 + 21
2313  7113 77           			ld (hl),a
2314  7114 23           			inc hl
2315  7115 77           			ld (hl),a
2316  7116 23           			inc hl
2317  7117 77           			ld (hl),a
2318  7118
2319  7118 3E 01        			ld   a,%00000001
2320  711A 21 8F 58     			ld hl,22528+32*4 + 15
2321  711D 77           			ld (hl),a
2322  711E 23           			inc hl
2323  711F 77           			ld (hl),a
2324  7120 23           			inc hl
2325  7121 77           			ld (hl),a
2326  7122
2327  7122 18 14        			jr stereo
2328  7124              sAY
2329  7124 3E 01        			ld a,%00000001
2330  7126 21 95 58     			ld hl,22528+32*4 + 21
2331  7129 77           			ld (hl),a
2332  712A 23           			inc hl
2333  712B 77           			ld (hl),a
2334  712C 23           			inc hl
2335  712D 77           			ld (hl),a
2336  712E
2337  712E 3E 47        			ld   a,vyrazni
2338  7130 21 8F 58     			ld hl,22528+32*4 + 15
2339  7133 77           			ld (hl),a
2340  7134 23           			inc hl
2341  7135 77           			ld (hl),a
2342  7136 23           			inc hl
2343  7137 77           			ld (hl),a
2344  7138              stereo
2345  7138
2346  7138              			NEXTREG2A 08
2346  7138 3E 08       >        ld     a,08
2346  713A CD 12 60    >        call   ReadNextReg
2347  713D CB 6F        			bit 5,a
2348  713F 20 15        			jr nz,sACB
2349  7141 3E 47        			ld a,vyrazni
2350  7143 21 75 58     			ld hl,22528+32*3 + 21
2351  7146 77           			ld (hl),a
2352  7147 23           			inc hl
2353  7148 77           			ld (hl),a
2354  7149 23           			inc hl
2355  714A 77           			ld (hl),a
2356  714B
2357  714B 3E 01        			ld   a,%00000001
2358  714D 21 6F 58     			ld hl,22528+32*3 + 15
2359  7150 77           			ld (hl),a
2360  7151 23           			inc hl
2361  7152 77           			ld (hl),a
2362  7153 23           			inc hl
2363  7154 77           			ld (hl),a
2364  7155 C9           			ret
2365  7156
2366  7156              sACB
2367  7156 3E 01        			ld a,%00000001
2368  7158 21 75 58     			ld hl,22528+32*3 + 21
2369  715B 77           			ld (hl),a
2370  715C 23           			inc hl
2371  715D 77           			ld (hl),a
2372  715E 23           			inc hl
2373  715F 77           			ld (hl),a
2374  7160
2375  7160 3E 47        			ld   a,vyrazni
2376  7162 21 6F 58     			ld hl,22528+32*3 + 15
2377  7165 77           			ld (hl),a
2378  7166 23           			inc hl
2379  7167 77           			ld (hl),a
2380  7168 23           			inc hl
2381  7169 77           			ld (hl),a
2382  716A
2383  716A C9           			ret
2384  716B
2385  716B              ;Skok na další skladbu
2386  716B              nextsong
2387  716B CD 73 75     		 call DOWN
2388  716E
2389  716E              ;Stisk klávesy ENTER.
2390  716E              FIRE
2391  716E ED 91 07 03  		 nextreg #07,3
2392  7172 CD 23 74     		 call savescr
2393  7175 3A 13 75     		 ld a,(POS_F+1)
2394  7178 5F           		 ld e,a
2395  7179 16 00        		 ld d,0
2396  717B 2A BD 75     		ld hl,(apos_all)
2397  717E 19           		add hl,de
2398  717F 7D           		ld a,l
2399  7180 B4           		or h
2400  7181 21 0D 80      	    ld hl,catbuff+#D
2401  7184 28 11        		jr z,F1
2402  7186
2403  7186 2A BD 75     		ld hl,(apos_all)
2404  7189 44           		ld b,h
2405  718A 4D           		ld c,l
2406  718B
2407  718B 11 0D 00     		ld de,13
2408  718E 21 0D 80       	    ld hl,catbuff+#D
2409  7191 19           F0 		add hl,de
2410  7192 0B           		dec bc
2411  7193 79           		ld a,c
2412  7194 B0           		or b
2413  7195 20 FA        		jr nz,F0
2414  7197              F1
2415  7197 E5           		push hl
2416  7198 DD E1        		pop ix
2417  719A CD 28 65     		call BUFF83
2418  719D DD CB 07 7E  		bit 7,(ix+7)
2419  71A1
2420  71A1 C2 DF 6F     		jp nz,CHANGEDIR
2421  71A4 E5           		push hl
2422  71A5 21 40 48             ld   hl,18496
2423  71A8 01 20 07             ld   bc,7*256+32
2424  71AB 3E 07                ld   a,%00000111
2425  71AD CD D2 76             call RAMECEK
2426  71B0 21 00 50     		ld   hl,20480
2427  71B3 01 20 04             ld   bc,4*256+32
2428  71B6 3E 05                ld   a,%00000101
2429  71B8 CD D2 76             call RAMECEK
2430  71BB
2431  71BB 21 25 40     		ld   hl,16416+5
2432  71BE 01 16 05             ld   bc,5*256+22
2433  71C1 3E 07                ld   a,%00000111
2434  71C3 CD D2 76             call RAMECEK
2435  71C6
2436  71C6 21 C1 40     		ld   hl,16576+1
2437  71C9 01 1E 04             ld   bc,4*256+30
2438  71CC 3E 05                ld   a,%00000101
2439  71CE CD D2 76             call RAMECEK
2440  71D1
2441  71D1              		; ld de,16576+3
2442  71D1              		; ld hl,txthelp0
2443  71D1              		; call print
2444  71D1 11 E3 40     		ld de,16608+3
2445  71D4 21 BD 70     		ld hl,txthelp1
2446  71D7 CD AF 7A     		call print
2447  71DA 11 03 48     		ld de,18432+3
2448  71DD 21 E1 70     		ld hl,txthelp2
2449  71E0 CD AF 7A     		call print
2450  71E3
2451  71E3
2452  71E3
2453  71E3 21 E2 58     		ld hl,22528 + 32*7 + 2
2454  71E6 3E 07        		ld a,7
2455  71E8 77           		ld (hl),a
2456  71E9 23           		inc hl
2457  71EA 77           		ld (hl),a
2458  71EB 23           		inc hl
2459  71EC 77           		ld (hl),a
2460  71ED 23           		inc hl
2461  71EE 77           		ld (hl),a
2462  71EF 23           		inc hl
2463  71F0 77           		ld (hl),a
2464  71F1 23           		inc hl
2465  71F2 77           		ld (hl),a
2466  71F3 21 F1 58     		ld hl,22528 + 32*7 + 17
2467  71F6 3E 07        		ld a,7
2468  71F8 77           		ld (hl),a
2469  71F9 23           		inc hl
2470  71FA 77           		ld (hl),a
2471  71FB 23           		inc hl
2472  71FC 77           		ld (hl),a
2473  71FD 23           		inc hl
2474  71FE 77           		ld (hl),a
2475  71FF 23           		inc hl
2476  7200 77           		ld (hl),a
2477  7201
2478  7201 21 04 59     		ld hl,22528 + 32*8 + 4
2479  7204 3E 07        		ld a,7
2480  7206 77           		ld (hl),a
2481  7207 23           		inc hl
2482  7208 77           		ld (hl),a
2483  7209
2484  7209 21 0A 59     		ld hl,22528 + 32*8 + 10
2485  720C 3E 07        		ld a,7
2486  720E 77           		ld (hl),a
2487  720F 23           		inc hl
2488  7210 77           		ld (hl),a
2489  7211
2490  7211 21 10 59     		ld hl,22528 + 32*8 + 16
2491  7214 3E 07        		ld a,7
2492  7216 77           		ld (hl),a
2493  7217 23           		inc hl
2494  7218 77           		ld (hl),a
2495  7219
2496  7219 21 16 59     		ld hl,22528 + 32*8 + 22
2497  721C 3E 07        		ld a,7
2498  721E 77           		ld (hl),a
2499  721F 23           		inc hl
2500  7220 77           		ld (hl),a
2501  7221
2502  7221
2503  7221 11 46 40     		ld de,16448+6
2504  7224 21 73 70     		ld hl,txtsetup
2505  7227 CD AF 7A     		call print
2506  722A 21 46 58     		ld hl,22528+32*2 + 6
2507  722D 3E 05        		ld a,101b
2508  722F              		;ld a,255
2509  722F 77           		ld (hl),a
2510  7230 23           		inc hl
2511  7231 77           		ld (hl),a
2512  7232 23           		inc hl
2513  7233 77           		ld (hl),a
2514  7234 23           		inc hl
2515  7235 77           		ld (hl),a
2516  7236 23           		inc hl
2517  7237 77           		ld (hl),a
2518  7238 23           		inc hl
2519  7239 77           		ld (hl),a
2520  723A 23           		inc hl
2521  723B 77           		ld (hl),a
2522  723C 23           		inc hl
2523  723D 77           		ld (hl),a
2524  723E 23           		inc hl
2525  723F 77           		ld (hl),a
2526  7240 23           		inc hl
2527  7241 77           		ld (hl),a
2528  7242 11 66 40     		ld de,16480+6
2529  7245 21 81 70     		ld hl,txtstereo
2530  7248 CD AF 7A     		call print
2531  724B
2532  724B 11 86 40     		ld de,16512+6
2533  724E 21 9A 70     		ld hl,txtchip
2534  7251 CD AF 7A     		call print
2535  7254
2536  7254 CD 05 71     		call showsetup
2537  7257
2538  7257
2539  7257 21 41 5A     		ld hl,22528+32*18+1
2540  725A 54           		ld d,h
2541  725B 5D           		ld e,l
2542  725C 13           		inc de
2543  725D 3E 07        		ld a,7
2544  725F 77           		ld (hl),a
2545  7260 01 1C 00     		ld bc, 28
2546  7263 ED B0        		ldir
2547  7265
2548  7265
2549  7265                      ; ld   hl,18592+2
2550  7265              		; ld (lfnat+1),hl
2551  7265              		; ld hl,28 + 18592+2
2552  7265              		; ld (lfn_1 + 1),hl
2553  7265              		; ld hl,28 + 18624+21
2554  7265              		; ld (lfn_2 + 1),hl
2555  7265              		; ld hl,LFNNAME+128
2556  7265              		; ld (lfnend+1),hl
2557  7265              		; ld hl,4
2558  7265              		; ld (odskok+1),hl
2559  7265
2560  7265
2561  7265 CD B8 65     		call LFNPRINT
2562  7268
2563  7268 21 66 73     		ld hl,tmp
2564  726B 11 67 73     		ld de,tmp+1
2565  726E AF           		xor a
2566  726F 77           		ld (hl),a
2567  7270 01 30 00     		ld bc,48
2568  7273 ED B0        		ldir
2569  7275
2570  7275 21 E2 B8     		ld hl,LFNNAME
2571  7278 11 66 73     		ld de,tmp
2572  727B 01 25 00     		ld bc,maxline
2573  727E ED B0        		ldir
2574  7280
2575  7280 11 82 48     		ld de,18560+2
2576  7283 21 66 73     		ld hl,tmp
2577  7286 CD AF 7A     		call print
2578  7289              ;**************************
2579  7289 21 66 73     		ld hl,tmp
2580  728C 11 67 73     		ld de,tmp+1
2581  728F AF           		xor a
2582  7290 77           		ld (hl),a
2583  7291 01 30 00     		ld bc,48
2584  7294 ED B0        		ldir
2585  7296
2586  7296 21 07 B9     		ld hl,LFNNAME+maxline
2587  7299 11 66 73     		ld de,tmp
2588  729C 01 25 00     		ld bc,maxline
2589  729F ED B0        		ldir
2590  72A1
2591  72A1 11 A2 48     		ld de,18592+2
2592  72A4 21 66 73     		ld hl,tmp
2593  72A7 CD AF 7A     		call print
2594  72AA              ;****************************
2595  72AA 21 66 73     		ld hl,tmp
2596  72AD 11 67 73     		ld de,tmp+1
2597  72B0 AF           		xor a
2598  72B1 77           		ld (hl),a
2599  72B2 01 30 00     		ld bc,48
2600  72B5 ED B0        		ldir
2601  72B7
2602  72B7 21 2C B9     		ld hl,LFNNAME+maxline+maxline
2603  72BA 11 66 73     		ld de,tmp
2604  72BD 01 25 00     		ld bc,maxline
2605  72C0 ED B0        		ldir
2606  72C2
2607  72C2 11 C2 48     		ld de,18624+2
2608  72C5 21 66 73     		ld hl,tmp
2609  72C8 CD AF 7A     		call print
2610  72CB
2611  72CB
2612  72CB 21 81 59     		ld hl,12*32+22528+1
2613  72CE 11 82 59     		ld de,12*32+22528+2
2614  72D1 01 1D 00     		ld bc,29
2615  72D4 36 47        		ld (hl),%01000111
2616  72D6 ED B0        		ldir
2617  72D8 21 A1 59     		ld hl,13*32+22528+1
2618  72DB 11 A2 59     		ld de,13*32+22528+2
2619  72DE 01 1D 00     		ld bc,29
2620  72E1 36 47        		ld (hl),%01000111
2621  72E3 ED B0        		ldir
2622  72E5
2623  72E5 21 C1 59     		ld hl,14*32+22528+1
2624  72E8 11 C2 59     		ld de,14*32+22528+2
2625  72EB 01 1D 00     		ld bc,29
2626  72EE 36 47        		ld (hl),%01000111
2627  72F0 ED B0        		ldir
2628  72F2
2629  72F2
2630  72F2
2631  72F2 11 C2 50     		ld de,20672+2
2632  72F5 ED 53 B2 65  		ld (lfnat+1),de
2633  72F9 21 DE 50     		ld hl,28 + 20672+2
2634  72FC 22 A6 65     		ld (lfn_1 + 1),hl
2635  72FF 21 E3 50     		ld hl,33 + 20672+2
2636  7302 22 AC 65     		ld (lfn_2 + 1),hl
2637  7305 21 07 B9     		ld hl,LFNNAME+37
2638  7308 22 A3 65     		ld (lfnend+1),hl
2639  730B D1           		pop de				; v DE je nazev souboru
2640  730C CD 7A 79             call NOWRMOD
2641  730F
2642  730F 11 6B 48     		ld   de,18560+8-32+3
2643  7312 21 EE 7E          	ld hl,text
2644  7315
2645  7315 CD AF 7A             call print
2646  7318
2647  7318 CD C3 73     		call LOADFile
2648  731B
2649  731B ED 91 57 01  		nextreg $57,1
2650  731F
2651  731F 21 09 60     		ld hl,filename+9
2652  7322 11 97 73     		ld de,PT2
2653  7325 CD 8D 61     		call compare
2654  7328 CA EC 98     		jp z,playmusic
2655  732B
2656  732B 21 09 60     		ld hl,filename+9
2657  732E 11 9A 73     		ld de,PT3
2658  7331 CD 8D 61     		call compare
2659  7334 CA EC 98     		jp z,playmusic
2660  7337
2661  7337 21 09 60     		ld hl,filename+9
2662  733A 11 9D 73     		ld de,SQT
2663  733D CD 8D 61     		call compare
2664  7340 CA 39 92     		jp z,SQTPLAY
2665  7343
2666  7343 21 09 60     		ld hl,filename+9
2667  7346 11 A0 73     		ld de,STC
2668  7349 CD 8D 61     		call compare
2669  734C CA B1 90     		jp z,STCPLAY
2670  734F
2671  734F 21 09 60     		ld hl,filename+9
2672  7352 11 A3 73     		ld de,STP
2673  7355 CD 8D 61     		call compare
2674  7358 CA 62 91     		jp z,STPPLAY
2675  735B
2676  735B
2677  735B
2678  735B
2679  735B 3E 20        		ld a,32
2680  735D 21 A6 73     		ld hl,endsong
2681  7360 77           		ld (hl),a
2682  7361              ;		jp playmusic
2683  7361              navrat
2684  7361 76           		halt
2685  7362 CD 37 74     		call loadscr
2686  7365 C9                   ret
2687  7366 00 00 00...  tmp     ds 49
2688  7397 50 54 32     PT2 	defb "PT2"
2689  739A 50 54 33     PT3		defb "PT3"
2690  739D 53 51 54     SQT		defb "SQT"
2691  73A0 53 54 43     STC		defb "STC"
2692  73A3 53 54 50     STP		defb "STP"
2693  73A6 00           endsong	defb 0
2694  73A7 50 6C 61 73  Loading defb "Plase wait, loading file...",0
2694  73AB 65 20 77 61
2694  73AF 69 74 2C 20
2694  73B3 6C 6F 61 64
2694  73B7 69 6E 67 20
2694  73BB 66 69 6C 65
2694  73BF 2E 2E 2E 00
2695  73C3              ; Nahrání souboru pomocí EsxDos služeb. Rutina nemá žádný vstup,
2696  73C3              ; vše si zjišťuje z proměnných (na adrese filename je již připravený název souboru)
2697  73C3              LOADFile
2698  73C3 ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
2699  73C7 21 A0 50     		ld hl, 20640
2700  73CA 01 20 03     		ld   bc,3*256+32
2701  73CD 3E 02                ld   a,%00000010
2702  73CF CD D2 76     		call RAMECEK
2703  73D2
2704  73D2 11 C2 50     		ld de,20672+2
2705  73D5 21 A7 73     		ld hl,Loading
2706  73D8 CD AF 7A     		call print
2707  73DB 06 01        		ld      b,FA_READ
2708  73DD 3E 2A                ld      a,'*'
2709  73DF 21 00 60             ld      hl,filename
2710  73E2                      ESXDOS  F_OPEN
2710  73E2 E5          >  push hl
2710  73E3 DD E1       >  pop ix
2710  73E5 CF          >  rst $08
2710  73E6 9A          >  db F_OPEN
2711  73E7 32 05 74     		ld (fread+1),a
2712  73EA
2713  73EA 21 D4 B0             ld      hl,modstart
2714  73ED 01 20 56             ld      bc,22048
2715  73F0 CD 04 74             call    fread
2716  73F3 CD FB 73     		call 	fclose
2717  73F6 ED 91 07 00  		nextreg #07,0             ;28MHz - jen kvůli načítání (rychlost)
2718  73FA C9           		ret
2719  73FB              fclose
2720  73FB 3A 05 74             ld      a,(fread+1)
2721  73FE                      ESXDOS  F_CLOSE
2721  73FE E5          >  push hl
2721  73FF DD E1       >  pop ix
2721  7401 CF          >  rst $08
2721  7402 9B          >  db F_CLOSE
2722  7403 C9                   ret
2723  7404              fread:
2724  7404 3E 01                ld a,1
2725  7406                      ESXDOS  F_READ
2725  7406 E5          >  push hl
2725  7407 DD E1       >  pop ix
2725  7409 CF          >  rst $08
2725  740A 9D          >  db F_READ
2726  740B D0                   ret  nc
2727  740C
2728  740C
2729  740C              fileError:
2730  740C F5                   push    af
2731  740D E6 07                and     7
2732  740F D3 FE                out     (254),a
2733  7411 F1                   pop     af
2734  7412 06 01                ld      b,1
2735  7414 11 E8 B9             ld      de,esxError
2736  7417                      ESXDOS  M_GETERR
2736  7417 E5          >  push hl
2736  7418 DD E1       >  pop ix
2736  741A CF          >  rst $08
2736  741B 93          >  db M_GETERR
2737  741C 21 E8 B9             ld      hl,esxError
2738  741F C3 4B 74             jp      customErrorToBasic
2739  7422
2740  7422
2741  7422              switchLayer2Off:
2742  7422 C9                   ret
2743  7423
2744  7423
2745  7423              ;Uloží obrazovku do banky 19 ZX Next. Ukládají se spodní dvě třetiny obrazovky,
2746  7423              ;a celé atributy. Banka 19 se stránkuje od adresy $e000
2747  7423              savescr
2748  7423 ED 91 57 13  		nextreg $57,19				;Stránka na uložení VideoRam
2749  7427 21 00 40     		ld hl,16384
2750  742A 11 00 E0     		ld de,bufscr
2751  742D 01 00 1B     		ld bc,6912
2752  7430 ED B0        		ldir
2753  7432 ED 91 57 01  		nextreg $57,1				;Nastránkuj zpátky
2754  7436 C9           		ret
2755  7437
2756  7437              ;Obnovení spodních dvou třetin obrazovky z 19 stárnky ZX Next.
2757  7437              loadscr
2758  7437 ED 91 57 13  		nextreg $57,19
2759  743B 21 00 E0     		ld hl,bufscr
2760  743E 11 00 40     		ld de,16384
2761  7441 01 00 1B     		ld bc,6912
2762  7444 ED B0        		ldir
2763  7446 ED 91 57 01  		nextreg $57,1
2764  744A C9           		ret
2765  744B
2766  744B              customErrorToBasic: ; HL = message with |80 last char
2767  744B 3E 01        		ld a,1
2768  744D D3 FE        		out (254),a
2769  744F C9           		ret
2770  7450 00           keysound db 0				;key sound 0= yes,1= no, klavesnicove echo
2771  7451              ;KeyScan od Busyho z MRSu
2772  7451 2E 2F        KEYSCAN  ld   l,47			;testovani klavesnice
2773  7453 11 FF FF              ld   de,65535
2774  7456 01 FE FE              ld   bc,65278
2775  7459 ED 78        KEYLINE  in   a,(c)
2776  745B 2F                    cpl
2777  745C E6 1F                 and  31
2778  745E 28 0E                 jr   z,KEYDONE
2779  7460 67                    ld   h,a
2780  7461 7D                    ld   a,l
2781  7462 14           KEY3KEYS inc  d
2782  7463 C0                    ret  nz
2783  7464 D6 08        KEYBITS  sub  8
2784  7466 CB 3C                 srl  h
2785  7468 30 FA                 jr   nc,KEYBITS
2786  746A 53                    ld   d,e
2787  746B 5F                    ld   e,a
2788  746C 20 F4                 jr   nz,KEY3KEYS
2789  746E 2D           KEYDONE  dec  l
2790  746F CB 00                 rlc  b
2791  7471 38 E6                 jr   c,KEYLINE
2792  7473 7A                    ld   a,d
2793  7474 3C                    inc  a
2794  7475 C8                    ret  z
2795  7476 FE 28                 cp   40
2796  7478 C8                    ret  z
2797  7479 FE 19                 cp   25
2798  747B C8                    ret  z
2799  747C 7B                    ld   a,e
2800  747D 5A                    ld   e,d
2801  747E 57                    ld   d,a
2802  747F FE 18                 cp   24
2803  7481 C9                    ret
2804  7482
2805  7482 2A 5E 5B 26  SYMTAB   db "*^[&%>}/"
2805  7486 25 3E 7D 2F
2806  748A 2C 2D 5D 27           db ",-]'$<{?"
2806  748E 24 3C 7B 3F
2807  7492 2E 2B 7F 28           db ".+($"
2807  7496 24
2808  7497 C8                    db 200
2809  7498 2F 20                 db '/',' '
2810  749A 00                    db 0
2811  749B 3D 3B 29 40           db "=;)@"
2812  749F C9                    db 201
2813  74A0 7C 3A                 db "|:"
2814  74A2 20 0D 22              db 32,13,34
2815  74A5 5F 21                 db "_!"
2816  74A7 C7                    db 199
2817  74A8 7E 00                 db "~",0
2818  74AA
2819  74AA 42 48 59     CAPSTAB  db "BHY"
2820  74AD 0A 08                 db 10,8
2821  74AF 54 47 56              db "TGV"
2822  74B2 4E 4A 55              db "NJU"
2823  74B5 0B 05                 db 11,5
2824  74B7 52 46 43              db "RFC"
2825  74BA 4D 4B 49              db "MKI"
2826  74BD 09 04                 db 9,4
2827  74BF 45 44 58              db "EDX"
2828  74C2 02                    db 2
2829  74C3 4C 4F                 db "LO"
2830  74C5 0F 06                 db 15,6
2831  74C7 57 53 5A              db "WSZ"
2832  74CA 01 0D 50              db 1,13,"P"
2833  74CD 0C 07                 db 12,7
2834  74CF 51 41                 db "QA"
2835  74D1
2836  74D1 62 68 79 36  NORMTAB  db "bhy65tgv"
2836  74D5 35 74 67 76
2837  74D9 6E 6A 75 37           db "nju74rfc"
2837  74DD 34 72 66 63
2838  74E1 6D 6B 69 38           db "mki83edx"
2838  74E5 33 65 64 78
2839  74E9 00                    db 0
2840  74EA 6C 6F 39 32           db "lo92wsz"
2840  74EE 77 73 7A
2841  74F1 20 0D                 db 32,13
2842  74F3 70 30 31 71           db "p01qa"
2842  74F7 61
2843  74F8 00                    db 0
2844  74F9
2845  74F9 3A 50 74     beepk		ld a,(keysound)		;Busyho nahradni rutina,kratsi
2846  74FC B7           		or a
2847  74FD C0           		ret nz
2848  74FE 3A 11 75     		ld a,(BORDER)
2849  7501 5F           		ld e,a
2850  7502 06 10        		ld b,$10
2851  7504 80           		add a,b
2852  7505              ;		ld a,$10+border
2853  7505 D3 FE        		out ($fe),a
2854  7507 06 1C        		ld b,$1c
2855  7509 10 FE        beepk1		djnz beepk1
2856  750B 3E 08        		ld a,$08
2857  750D 83           		add a,e
2858  750E              ;		ld a,$08+border
2859  750E D3 FE        		out ($fe),a
2860  7510 C9           		ret
2861  7511 00           BORDER   db 0				;okraj
2862  7512
2863  7512              ;Pohyb nahoru - na pozici kurzoru se používa 16bitové číslo,
2864  7512              ;takže maximální počet souboru je omezen, ale prakticky se k
2865  7512              ;němu ani nepřiblížíme.
2866  7512              ;Při scrolování se vypisuje jen spodní řádek, jinak se volá
2867  7512              ;rutinka ROLLDOWN, která provede scroll o 8 pixelů dolů. Je to rychlejší,
2868  7512              ;než vypisovat všechny soubory znova.
2869  7512              UP
2870  7512 3E 00        POS_F    ld a,0
2871  7514 B7           		 or a
2872  7515 CA 4A 75     		 jp z,UP1
2873  7518 2A BD 75     		 ld hl,(apos_all)
2874  751B 7C           		 ld a,h
2875  751C B5                    or   l
2876  751D CA 4A 75              jp   z,UP1
2877  7520 0E 0F                 ld   c,%00001111
2878  7522 3A 13 75     		 ld a,(POS_F+1)
2879  7525 CD D8 79              call KURZOR
2880  7528 2A BD 75     		 ld hl,(apos_all)
2881  752B 2B                    dec  hl
2882  752C 22 BD 75              ld   (apos_all),hl
2883  752F
2884  752F 3D           		 dec a
2885  7530 32 13 75     		 ld (POS_F+1),a
2886  7533 0E 17                 ld   c,%00010111
2887  7535 CD D8 79              call KURZOR
2888  7538 CD B8 65     		 call LFNPRINT
2889  753B 21 07 B9      		ld hl,LFNNAME + maxline
2890  753E 36 00        		ld (hl),0
2891  7540 21 E2 B8     		ld hl,LFNNAME
2892  7543 11 C2 50     		ld de,20672+2
2893  7546 CD AF 7A     		call print
2894  7549
2895  7549 C9                    ret
2896  754A
2897  754A              UP1
2898  754A 3E 00        POS_ALL  ld   a,0
2899  754C                       ;or   a
2900  754C                       ;ret  z
2901  754C                       ;dec  a
2902  754C                       ;ld   (POS_ALL+1),a
2903  754C 2A BD 75     		 ld hl,(apos_all)
2904  754F 7D           		 ld a,l
2905  7550 B4           		 or h
2906  7551 C8           		 ret z
2907  7552 2B           		 dec hl
2908  7553 22 BD 75     		 ld (apos_all),hl
2909  7556 F5                    push af
2910  7557 CD 67 7A              call ROLLDOWN
2911  755A F1                    pop  af
2912  755B 21 41 40              ld   hl,16448+1
2913  755E CD F0 79              call PRN_F
2914  7561 CD B8 65     		 call LFNPRINT
2915  7564 21 07 B9     		ld hl,LFNNAME + maxline
2916  7567 36 00        		ld (hl),0
2917  7569 21 E2 B8     		ld hl,LFNNAME
2918  756C 11 C2 50     		ld de,20672+2
2919  756F CD AF 7A     		call print
2920  7572
2921  7572 C9                    ret
2922  7573              DOWN
2923  7573 2A D5 79     		ld hl,(ALLFILES)
2924  7576 2B           		dec hl
2925  7577
2926  7577 1E 11        		ld e,17
2927  7579 16 00        		ld d,0
2928  757B B7           		or a
2929  757C ED 52        		sbc hl,de
2930  757E 4D           		ld c,l
2931  757F DA 84 75     		jp c,D1
2932  7582 0E 11        		ld c,17
2933  7584
2934  7584              D1
2935  7584 3A 13 75              ld   a,(POS_F+1)
2936  7587 B9                    cp   c
2937  7588 CA BF 75              jp   z,DOWN1
2938  758B 5F           		 ld e,a
2939  758C 16 00        		 ld d,0
2940  758E 2A D5 79     		 ld hl,(ALLFILES)
2941  7591 2B           		 dec hl
2942  7592 B7           		 or a
2943  7593 ED 52        		 sbc hl,de
2944  7595 C8           		 ret z
2945  7596 0E 0F                 ld   c,%00001111
2946  7598 CD D8 79              call KURZOR
2947  759B
2948  759B 3C                    inc  a
2949  759C 32 13 75              ld   (POS_F+1),a
2950  759F 2A BD 75     		 ld hl,(apos_all)
2951  75A2 23           		 inc hl
2952  75A3 22 BD 75     		 ld (apos_all),hl
2953  75A6 0E 17                 ld   c,%00010111
2954  75A8 CD D8 79              call KURZOR
2955  75AB
2956  75AB CD B8 65     		 call LFNPRINT
2957  75AE 21 07 B9     		ld hl,LFNNAME + maxline
2958  75B1 36 00        		ld (hl),0
2959  75B3 21 E2 B8     		ld hl,LFNNAME
2960  75B6 11 C2 50     		ld de,20672+2
2961  75B9 CD AF 7A     		call print
2962  75BC
2963  75BC C9                    ret
2964  75BD
2965  75BD 00 00        apos_all defw 0
2966  75BF              DOWN1
2967  75BF 2A BD 75            	ld hl,(apos_all)
2968  75C2              		;dec hl
2969  75C2 EB           		ex de,hl
2970  75C3 2A D5 79     		ld hl,(ALLFILES)
2971  75C6 2B           		dec hl
2972  75C7 EB           		ex de,hl
2973  75C8 B7           		or a
2974  75C9 ED 52        		sbc hl,de
2975  75CB C8           		ret z			;maximum souboru
2976  75CC
2977  75CC 2A BD 75             ld hl,(apos_all)
2978  75CF              		;dec hl
2979  75CF EB           		ex de,hl
2980  75D0 2A D5 79     		ld hl,(ALLFILES)
2981  75D3 2B           		dec hl
2982  75D4 EB           		ex de,hl
2983  75D5 B7           		or a
2984  75D6 ED 52        		sbc hl,de
2985  75D8
2986  75D8 EB           		ex de,hl
2987  75D9 2A BD 75     		ld hl,(apos_all)
2988  75DC
2989  75DC B7           		or a
2990  75DD ED 52        		sbc hl,de
2991  75DF C8           		ret z
2992  75E0
2993  75E0 3A 4B 75              ld   a,(POS_ALL+1)
2994  75E3 3C                    inc  a
2995  75E4 32 4B 75              ld   (POS_ALL+1),a
2996  75E7 2A BD 75     		 ld hl,(apos_all)
2997  75EA 23           		 inc hl
2998  75EB 22 BD 75     		 ld (apos_all),hl
2999  75EE F5                    push af
3000  75EF CD 61 7A              call ROLLUP
3001  75F2 F1                    pop  af
3002  75F3 4F                    ld   c,a
3003  75F4 3A 13 75              ld   a,(POS_F+1)
3004  75F7 81                    add  a,c
3005  75F8 21 61 50              ld   hl,20576+1
3006  75FB CD F0 79              call PRN_F
3007  75FE CD B8 65     		 call LFNPRINT
3008  7601 21 07 B9     		ld hl,LFNNAME + maxline
3009  7604 36 00        		ld (hl),0
3010  7606 21 E2 B8     		ld hl,LFNNAME
3011  7609 11 C2 50     		ld de,20672+2
3012  760C CD AF 7A     		call print
3013  760F
3014  760F C9                    ret
3015  7610
3016  7610              ;Font na vykreslování rámečků
3017  7610              SPECFNT
3018  7610 00 7F                 defw 32512
3019  7612 7F 75                 defw 30079
3020  7614 60 70                 defw 28768
3021  7616 60 70                 defw 28768
3022  7618
3023  7618 00 FF                 defw 65280
3024  761A FF 55                 defw 22015
3025  761C 00 00                 defw 0
3026  761E 00 00                 defw 0
3027  7620
3028  7620 00 FE                 defw 65024
3029  7622 FE 56                 defw 22270
3030  7624 0E 06                 defw 1550
3031  7626 0E 06                 defw 1550
3032  7628
3033  7628 60 70                 defw 28768
3034  762A 60 70                 defw 28768
3035  762C 60 70                 defw 28768
3036  762E 60 70                 defw 28768
3037  7630
3038  7630 00 00                 defw 0
3039  7632 00 00                 defw 0
3040  7634 00 00                 defw 0
3041  7636 00 00                 defw 0
3042  7638
3043  7638 0E 06                 defw 1550
3044  763A 0E 06                 defw 1550
3045  763C 0E 06                 defw 1550
3046  763E 0E 06                 defw 1550
3047  7640
3048  7640 60 70                 defw 28768
3049  7642 6A 7F                 defw 32618
3050  7644 7F 75                 defw 30079
3051  7646 60 70                 defw 28768
3052  7648
3053  7648 00 00                 defw 0
3054  764A AA FF                 defw 65450
3055  764C FF 55                 defw 22015
3056  764E 00 00                 defw 0
3057  7650
3058  7650 0E 06                 defw 1550
3059  7652 AE FE                 defw 65198
3060  7654 FE 56                 defw 22270
3061  7656 0E 06                 defw 1550
3062  7658
3063  7658 60 70                 defw 28768
3064  765A 60 70                 defw 28768
3065  765C 6A 7F                 defw 32618
3066  765E 7F 00                 defw 127
3067  7660
3068  7660 00 00                 defw 0
3069  7662 00 00                 defw 0
3070  7664 AA FF                 defw 65450
3071  7666 FF 00                 defw 255
3072  7668
3073  7668 0E 06                 defw 1550
3074  766A 0E 06                 defw 1550
3075  766C AE FE                 defw 65198
3076  766E FE 00                 defw 254
3077  7670
3078  7670 00 55 00 55           defb 0,85,0,85,0,85,0
3078  7674 00 55 00
3079  7677 00                    defb 0
3080  7678
3081  7678              DOWNHL
3082  7678 24                    inc  h
3083  7679 7C                    ld   a,h
3084  767A E6 07                 and  7
3085  767C C0                    ret  nz
3086  767D 7D                    ld   a,l
3087  767E C6 20                 add  a,32
3088  7680 6F                    ld   l,a
3089  7681 7C                    ld   a,h
3090  7682 D8                    ret  c
3091  7683 D6 08                 sub  8
3092  7685 67                    ld   h,a
3093  7686 C9                    ret
3094  7687
3095  7687
3096  7687              DOWNH
3097  7687 7D                    ld   a,l
3098  7688 C6 20                 add  a,32
3099  768A 6F                    ld   l,a
3100  768B 7C                    ld   a,h
3101  768C D0                    ret  nc
3102  768D C6 08                 add  a,2048/256
3103  768F 67                    ld   h,a
3104  7690 C9                    ret
3105  7691
3106  7691              ;Rutinka na vypsání jednoho znaku 8bitovým fontem.
3107  7691              ; Vstup:
3108  7691              			; A ... znak
3109  7691              			; Pozice se určuje návěstím P_AT
3110  7691              PRINT
3111  7691 D9                    exx
3112  7692 6F                    ld   l,a
3113  7693 26 00                 ld   h,0
3114  7695 29                    add  hl,hl
3115  7696 29                    add  hl,hl
3116  7697 29                    add  hl,hl
3117  7698 01 00 3C     FNT      ld   bc,CHARS
3118  769B 09                    add  hl,bc
3119  769C 11 00 40     P_AT     ld   de,16384
3120  769F
3121  769F D5                    push de
3122  76A0 7E                    ld   a,(hl)
3123  76A1
3124  76A1 12                    ld   (de),a
3125  76A2 23                    inc  hl
3126  76A3 14                    inc  d
3127  76A4 7E                    ld   a,(hl)
3128  76A5 12                    ld   (de),a
3129  76A6 23                    inc  hl
3130  76A7 14                    inc  d
3131  76A8 7E                    ld   a,(hl)
3132  76A9 12                    ld   (de),a
3133  76AA 23                    inc  hl
3134  76AB 14                    inc  d
3135  76AC 7E                    ld   a,(hl)
3136  76AD 12                    ld   (de),a
3137  76AE 23                    inc  hl
3138  76AF 14                    inc  d
3139  76B0 7E                    ld   a,(hl)
3140  76B1 12                    ld   (de),a
3141  76B2 23                    inc  hl
3142  76B3 14                    inc  d
3143  76B4 7E                    ld   a,(hl)
3144  76B5 12                    ld   (de),a
3145  76B6 23                    inc  hl
3146  76B7 14                    inc  d
3147  76B8 7E                    ld   a,(hl)
3148  76B9 12                    ld   (de),a
3149  76BA 23                    inc  hl
3150  76BB 14                    inc  d
3151  76BC 7E                    ld   a,(hl)
3152  76BD 12                    ld   (de),a
3153  76BE D1                    pop  de
3154  76BF
3155  76BF 1C                    inc  e
3156  76C0 20 0A                 jr   nz,CHAR1B
3157  76C2 7A                    ld   a,d
3158  76C3 C6 08                 add  a,8
3159  76C5 57                    ld   d,a
3160  76C6 FE 58                 cp   88
3161  76C8 38 02                 jr   c,CHAR1B
3162  76CA 16 40                 ld   d,64
3163  76CC ED 53 9D 76  CHAR1B   ld   (P_AT+1),de
3164  76D0 D9                    exx
3165  76D1 C9                    ret
3166  76D2
3167  76D2              ; Vykreslení rámečku
3168  76D2              ; Vstup:
3169  76D2              				;hl=adrvrm
3170  76D2              				;bc,vyska * 256 + sirka
3171  76D2              				;a=barva
3172  76D2              RAMECEK
3173  76D2 F5                    push af
3174  76D3 E5                    push hl
3175  76D4 C5                    push bc
3176  76D5 22 9D 76              ld   (P_AT+1),hl
3177  76D8
3178  76D8 0D                    dec  c
3179  76D9 0D                    dec  c
3180  76DA E5                    push hl
3181  76DB 21 10 76              ld   hl,SPECFNT
3182  76DE 22 99 76              ld   (FNT+1),hl
3183  76E1 C5                    push bc
3184  76E2
3185  76E2 3E 00                 ld   a,0
3186  76E4 CD 91 76              call PRINT
3187  76E7 41                    ld   b,c
3188  76E8 3E 01        RAM1     ld   a,1
3189  76EA CD 91 76              call PRINT
3190  76ED 10 F9                 djnz RAM1
3191  76EF 3E 02                 ld   a,2
3192  76F1 CD 91 76              call PRINT
3193  76F4 C1                    pop  bc
3194  76F5 E1                    pop  hl
3195  76F6 05                    dec  b
3196  76F7 05                    dec  b
3197  76F8 CD 87 76              call DOWNH
3198  76FB 22 9D 76              ld   (P_AT+1),hl
3199  76FE              RAM3
3200  76FE E5                    push hl
3201  76FF C5                    push bc
3202  7700 3E 03                 ld   a,3
3203  7702 CD 91 76              call PRINT
3204  7705 41                    ld   b,c
3205  7706 3E 04        RAM2     ld   a,4
3206  7708 CD 91 76              call PRINT
3207  770B 10 F9                 djnz RAM2
3208  770D 3E 05                 ld   a,5
3209  770F CD 91 76              call PRINT
3210  7712 C1                    pop  bc
3211  7713 E1                    pop  hl
3212  7714 CD 87 76              call DOWNH
3213  7717 22 9D 76              ld   (P_AT+1),hl
3214  771A 10 E2                 djnz RAM3
3215  771C
3216  771C 3E 09                 ld   a,9
3217  771E CD 91 76              call PRINT
3218  7721 41                    ld   b,c
3219  7722 3E 0A        RAM4     ld   a,10
3220  7724 CD 91 76              call PRINT
3221  7727 10 F9                 djnz RAM4
3222  7729 3E 0B                 ld   a,11
3223  772B CD 91 76              call PRINT
3224  772E
3225  772E 21 00 3C              ld   hl,CHARS
3226  7731 22 99 76              ld   (FNT+1),hl
3227  7734
3228  7734 C1                    pop  bc
3229  7735 E1                    pop  hl
3230  7736 7C                    ld   a,h
3231  7737 D6 40                 sub  64
3232  7739 0F                    rrca
3233  773A 0F                    rrca
3234  773B 0F                    rrca
3235  773C E6 03                 and  3
3236  773E C6 58                 add  a,88
3237  7740 67                    ld   h,a
3238  7741
3239  7741 0D                    dec  c
3240  7742
3241  7742 F1                    pop  af
3242  7743
3243  7743
3244  7743 C5           ATRR     push bc
3245  7744 E5                    push hl
3246  7745 54                    ld   d,h
3247  7746 5D                    ld   e,l
3248  7747 1C                    inc  e
3249  7748 06 00                 ld   b,0
3250  774A 77                    ld   (hl),a
3251  774B ED B0                 ldir
3252  774D E1                    pop  hl
3253  774E 11 20 00              ld   de,32
3254  7751 19                    add  hl,de
3255  7752 C1                    pop  bc
3256  7753 10 EE                 djnz ATRR
3257  7755
3258  7755 C9                    ret
3259  7756
3260  7756 43 75 72 73  tcursor defb "Cursors: move",0
3260  775A 6F 72 73 3A
3260  775E 20 6D 6F 76
3260  7762 65 00
3261  7764 45 6E 74 65  tenter defb "Enter: play song",0
3261  7768 72 3A 20 70
3261  776C 6C 61 79 20
3261  7770 73 6F 6E 67
3261  7774 00
3262  7775 53 70 61 63  tspace defb "Space: play next",0
3262  7779 65 3A 20 70
3262  777D 6C 61 79 20
3262  7781 6E 65 78 74
3262  7785 00
3263  7786 53 3A 20 73  tsearch defb "S: search",0
3263  778A 65 61 72 63
3263  778E 68 00
3264  7790 52 3A 20 72  treload defb "R: reload directory",0
3264  7794 65 6C 6F 61
3264  7798 64 20 64 69
3264  779C 72 65 63 74
3264  77A0 6F 72 79 00
3265  77A4
3266  77A4              ; Nakreslí všechny okna potřebné pro NextPlayer
3267  77A4              kresli:
3268  77A4
3269  77A4
3270  77A4 21 20 40     		  ld   hl,16416
3271  77A7 01 0E 14     		  ld   bc,20*256+14
3272  77AA 3E 0F        		  ld   a,%00001111
3273  77AC CD D2 76     		  call RAMECEK
3274  77AF
3275  77AF 21 EE 40     		  ld   hl,16608+14
3276  77B2 01 12 0E     		  ld   bc,14*256+18
3277  77B5 3E 0F        		  ld   a,%00001111
3278  77B7 CD D2 76     		  call RAMECEK
3279  77BA
3280  77BA 21 2E 40     		  ld   hl,16416+14
3281  77BD 01 12 06     		  ld   bc,6*256+18
3282  77C0 3E 07        		  ld   a,%00000111
3283  77C2 CD D2 76     		  call RAMECEK
3284  77C5
3285  77C5
3286  77C5
3287  77C5
3288  77C5 21 01 40     		  ld   hl,16384+1
3289  77C8 11 A3 78     		  ld   de,TEXT1
3290  77CB CD BF 79     		  call TEXT
3291  77CE
3292  77CE 11 0E 40     		  ld   de,16384+ 14
3293  77D1 21 AE 78     		  ld   hl,nnext
3294  77D4 CD AF 7A     		  call print
3295  77D7 21 0E 58     		ld hl,22528+14
3296  77DA 3E 05        		ld a,5
3297  77DC 06 11        		ld b,17
3298  77DE 77           kk		ld (hl),a
3299  77DF 23           		inc hl
3300  77E0 10 FC        		djnz kk
3301  77E2
3302  77E2 21 4F 40              ld   hl,16448+15
3303  77E5 11 6C 78              ld   de,Versionn
3304  77E8 EB           		 ex de,hl
3305  77E9 CD AF 7A              call print
3306  77EC 21 6F 40              ld   hl,16480+15
3307  77EF 11 79 78              ld   de,Cursors
3308  77F2 EB                    ex de,hl
3309  77F3 CD AF 7A     		 call print
3310  77F6 21 8F 40              ld   hl,16512+15
3311  77F9 11 7B 78              ld   de,Play
3312  77FC EB                    ex de,hl
3313  77FD CD AF 7A     		 call print
3314  7800 21 AF 40              ld   hl,16544+15
3315  7803 11 8F 78              ld   de,NextPlay
3316  7806 EB                    ex de,hl
3317  7807 CD AF 7A     		 call print
3318  780A
3319  780A 21 6F 48              ld   hl,18528+15
3320  780D 11 56 77              ld   de,tcursor
3321  7810 EB                    ex de,hl
3322  7811 CD AF 7A     		 call print
3323  7814 21 8F 48              ld   hl,18560+15
3324  7817 11 64 77              ld   de,tenter
3325  781A EB                    ex de,hl
3326  781B CD AF 7A     		 call print
3327  781E 21 AF 48              ld   hl,18592+15
3328  7821 11 75 77              ld   de,tspace
3329  7824 EB                    ex de,hl
3330  7825 CD AF 7A     		 call print
3331  7828 21 CF 48              ld   hl,18624+15
3332  782B 11 86 77              ld   de,tsearch
3333  782E EB                    ex de,hl
3334  782F CD AF 7A     		 call print
3335  7832 21 EF 48              ld   hl,18656+15
3336  7835 11 90 77              ld   de,treload
3337  7838 EB                    ex de,hl
3338  7839 CD AF 7A     		 call print
3339  783C 3E 0D        		ld a,00001101b
3340  783E
3341  783E 21 6F 59     		ld hl,11*32+22528 + 15
3342  7841 06 0E        		ld b,14
3343  7843 77           		ld (hl),a
3344  7844 23           		inc hl
3345  7845 10 FC        		djnz $-2
3346  7847
3347  7847 21 8F 59     		ld hl,12*32+22528 + 15
3348  784A 06 0E        		ld b,14
3349  784C 77           		ld (hl),a
3350  784D 23           		inc hl
3351  784E 10 FC        		djnz $-2
3352  7850
3353  7850 21 AF 59     		ld hl,13*32+22528 + 15
3354  7853 06 0E        		ld b,14
3355  7855 77           		ld (hl),a
3356  7856 23           		inc hl
3357  7857 10 FC        		djnz $-2
3358  7859
3359  7859 21 CF 59     		ld hl,14*32+22528 + 15
3360  785C 06 0E        		ld b,14
3361  785E 77           		ld (hl),a
3362  785F 23           		inc hl
3363  7860 10 FC        		djnz $-2
3364  7862
3365  7862 21 EF 59     		ld hl,15*32+22528 + 15
3366  7865 06 0F        		ld b,15
3367  7867 77           		ld (hl),a
3368  7868 23           		inc hl
3369  7869 10 FC        		djnz $-2
3370  786B
3371  786B
3372  786B C9                         ret
3373  786C
3374  786C 56 65 72 73  Versionn  defb "Version: 0.5",0
3374  7870 69 6F 6E 3A
3374  7874 20 30 2E 35
3374  7878 00
3375  7879 20 00        Cursors defb " ",0
3376  787B 4D 61 69 6E  Play    defb "Main program: Shrek",0
3376  787F 20 70 72 6F
3376  7883 67 72 61 6D
3376  7887 3A 20 53 68
3376  788B 72 65 6B 00
3377  788F 41 59 20 72  NextPlay defb "AY routines: mborik",0
3377  7893 6F 75 74 69
3377  7897 6E 65 73 3A
3377  789B 20 6D 62 6F
3377  789F 72 69 6B 00
3378  78A3 4E 65 78 74  TEXT1    defb "NextPlayer",0
3378  78A7 50 6C 61 79
3378  78AB 65 72 00
3379  78AE
3380  78AE 20 20 66 6F  nnext    defb "  for ZX Spectrum Next",0
3380  78B2 72 20 5A 58
3380  78B6 20 53 70 65
3380  78BA 63 74 72 75
3380  78BE 6D 20 4E 65
3380  78C2 78 74 00
3381  78C5
3382  78C5
3383  78C5
3384  78C5              WRFILES
3385  78C5 CD 28 65     		 call BUFF83
3386  78C8 2A D5 79              ld   hl,(ALLFILES)
3387  78CB 7D           		 ld a,l
3388  78CC 11 12 00     		 ld de,18
3389  78CF B7                    or a
3390  78D0 ED 52        		 sbc hl,de
3391  78D2 38 02                 jr   c,WRF4
3392  78D4 3E 12                 ld   a,18
3393  78D6 47           WRF4     ld   b,a
3394  78D7 21 41 40              ld   hl,16448+1
3395  78DA 11 0D 80     WRBUFF   ld   de,catbuff+#D
3396  78DD
3397  78DD C5           WRF2     push bc
3398  78DE E5                    push hl
3399  78DF 22 9D 76              ld   (P_AT+1),hl
3400  78E2
3401  78E2 1A                    ld   a,(de)
3402  78E3 FE 20                 cp   32
3403  78E5 28 1A                 jr   z,ENDP
3404  78E7 CD 0D 79              call WRMOD
3405  78EA
3406  78EA 21 D7 79              ld   hl,POC
3407  78ED 34                    inc  (hl)
3408  78EE E1                    pop  hl
3409  78EF CD 87 76              call DOWNH
3410  78F2 C1                    pop  bc
3411  78F3 10 E8                 djnz WRF2
3412  78F5              E2
3413  78F5 3A 13 75              ld   a,(POS_F+1)
3414  78F8 0E 17                 ld   c,%00010111
3415  78FA CD D8 79              call KURZOR
3416  78FD CD 39 65     		 call NOBUFF83
3417  7900 C9                    ret
3418  7901
3419  7901 E1           ENDP     pop  hl
3420  7902 C1                    pop  bc
3421  7903 21 D7 79              ld   hl,POC
3422  7906 7E                    ld   a,(hl)
3423  7907 32 D4 79              ld   (FILES),a
3424  790A 18 E9                 jr   E2
3425  790C 00           dir		 defb 0
3426  790D              WRMOD
3427  790D
3428  790D
3429  790D
3430  790D              		 ;původni WRMOD
3431  790D D5           		 push de
3432  790E 21 07 00     		 ld hl,7
3433  7911 19           		 add hl,de
3434  7912 CB 7E        		 bit 7,(hl)
3435  7914 28 07        		 jr z,neni_adr
3436  7916 3E 01        		 ld a,1
3437  7918 32 0C 79     		 ld (dir),a
3438  791B 18 04        		 jr je_dir
3439  791D AF           neni_adr xor a
3440  791E 32 0C 79     		 ld (dir),a
3441  7921              je_dir
3442  7921 D1           		 pop de
3443  7922 DD 21 00 60  		 ld ix,filename
3444  7926 06 08                 ld   b,8
3445  7928 1A           WRF1     ld   a,(de)
3446  7929 B7                    or   a
3447  792A 28 30                 jr   z,WWR
3448  792C DD 77 00     		 ld (ix+0),a
3449  792F DD 23        		 inc ix
3450  7931 CB BF        		 res 7,a
3451  7933 CD 91 76              call PRINT
3452  7936 13                    inc  de
3453  7937 10 EF                 djnz WRF1
3454  7939 3A 0C 79     		 ld a,(dir)
3455  793C B7           		 or a
3456  793D 20 1F        		 jr nz,wwrdir
3457  793F 3E 2E        		 ld a,"."
3458  7941 DD 77 00     		 ld (ix+0),a
3459  7944 DD 23        		 inc ix
3460  7946 CD 91 76     		 call PRINT
3461  7949 06 03        		 ld b,3
3462  794B 1A           wrf2	 ld a,(de)
3463  794C CB BF        		 res 7,a
3464  794E DD 77 00     		 ld (ix+0),a
3465  7951 DD 23        		 inc ix
3466  7953
3467  7953 CD 91 76     		 call PRINT
3468  7956 13           		 inc de
3469  7957 10 F2        		 djnz wrf2
3470  7959 13           		 inc de
3471  795A 13           		 inc de
3472  795B C9                    ret
3473  795C              WWR
3474  795C 13                    inc  de
3475  795D C9                    ret
3476  795E
3477  795E              wwrdir
3478  795E D5           		push de
3479  795F 3E 20        		ld a,32
3480  7961 CD 91 76     		call PRINT
3481  7964 3E 44        		ld a,"D"
3482  7966 CD 91 76     		call PRINT
3483  7969 3E 49        		ld a,"I"
3484  796B CD 91 76     		call PRINT
3485  796E 3E 52        		ld a,"R"
3486  7970 CD 91 76     		call PRINT
3487  7973 D1           		pop de
3488  7974
3489  7974 13           		inc de
3490  7975 13           		inc de
3491  7976 13           		inc de
3492  7977 13           		inc de
3493  7978              		;inc de
3494  7978 13           		inc de
3495  7979 C9           		ret
3496  797A
3497  797A CD 28 65     NOWRMOD	 call BUFF83
3498  797D DD 21 00 60  		 ld ix,filename
3499  7981 06 08                 ld   b,8
3500  7983 1A           aWRF1     ld   a,(de)
3501  7984 B7                    or   a
3502  7985 28 22                 jr   z,aWWR
3503  7987 DD 77 00     		 ld (ix+0),a
3504  798A DD 23        		 inc ix
3505  798C                       ;call PRINT
3506  798C 13                    inc  de
3507  798D 10 F4                 djnz aWRF1
3508  798F 3E 2E        		 ld a,"."
3509  7991 DD 77 00     		 ld (ix+0),a
3510  7994 DD 23        		 inc ix
3511  7996
3512  7996              ;		 call PRINT
3513  7996 06 03        		 ld b,3
3514  7998 1A           awrf2	 ld a,(de)
3515  7999 CB BF        		 res 7,a
3516  799B DD 77 00     		 ld (ix+0),a
3517  799E DD 23        		 inc ix
3518  79A0
3519  79A0              ;		 call PRINT
3520  79A0 13           		 inc de
3521  79A1 10 F5        		 djnz awrf2
3522  79A3 13           		 inc de
3523  79A4 13           		 inc de
3524  79A5 CD 39 65              call NOBUFF83
3525  79A8 C9           		 ret
3526  79A9              aWWR
3527  79A9 13                    inc  de
3528  79AA CD 39 65     		 call NOBUFF83
3529  79AD C9                    ret
3530  79AE
3531  79AE
3532  79AE              S_TEXT
3533  79AE 01 10 76              ld   bc,SPECFNT
3534  79B1 ED 43 99 76           ld   (FNT+1),bc
3535  79B5 CD BF 79              call TEXT
3536  79B8 21 00 3C              ld   hl,CHARS
3537  79BB 22 99 76              ld   (FNT+1),hl
3538  79BE C9                    ret
3539  79BF              TEXT
3540  79BF 22 9D 76              ld   (P_AT+1),hl
3541  79C2 EB                    ex   de,hl
3542  79C3              TEX1
3543  79C3 7E                    ld   a,(hl)
3544  79C4 B7                    or   a
3545  79C5 C8                    ret  z
3546  79C6 CB 7F        		 bit 7,a
3547  79C8 CB BF        		 res 7,a
3548  79CA C2 91 76     		 jp nz,PRINT
3549  79CD CD 91 76              call PRINT
3550  79D0 23                    inc  hl
3551  79D1 18 F0                 jr   TEX1
3552  79D3 C9                    ret
3553  79D4 00           FILES    defb 0
3554  79D5 00 00        ALLFILES defb 0,0
3555  79D7 00           POC      defb 0
3556  79D8
3557  79D8              KURZOR
3558  79D8 F5                    push af
3559  79D9 87                    add  a,a
3560  79DA 87                    add  a,a
3561  79DB 87                    add  a,a
3562  79DC 6F                    ld   l,a
3563  79DD 26 00                 ld   h,0
3564  79DF 29                    add  hl,hl
3565  79E0 29                    add  hl,hl
3566  79E1 11 41 58              ld   de,22528+64+1
3567  79E4 19                    add  hl,de
3568  79E5 5D                    ld   e,l
3569  79E6 54                    ld   d,h
3570  79E7 13                    inc  de
3571  79E8 71                    ld   (hl),c
3572  79E9 01 0B 00              ld   bc,11
3573  79EC ED B0                 ldir
3574  79EE F1                    pop  af
3575  79EF C9                    ret
3576  79F0
3577  79F0              PRN_F
3578  79F0 CD 28 65     		 call BUFF83
3579  79F3 22 9D 76              ld   (P_AT+1),hl
3580  79F6 2A BD 75     		 ld hl,(apos_all)
3581  79F9
3582  79F9 7D           		 ld a,l
3583  79FA B4           		 or h
3584  79FB EB           		 ex de,hl
3585  79FC 21 0D 80     		 ld hl,catbuff+#d
3586  79FF 28 0E        		 jr z,F12
3587  7A01 21 00 80     		 ld hl,catbuff
3588  7A04 42           		 ld b,d
3589  7A05 4B           		 ld c,e
3590  7A06 11 0D 00     		 ld de,13
3591  7A09 19           F02      add hl,de
3592  7A0A
3593  7A0A 78           		 ld a,b
3594  7A0B B1           		 or c
3595  7A0C 0B           		 dec bc
3596  7A0D 20 FA        		 jr nz,F02
3597  7A0F              F12
3598  7A0F EB                    ex   de,hl
3599  7A10 CD 0D 79              call WRMOD
3600  7A13 CD 39 65     		 call NOBUFF83
3601  7A16 C9                    ret
3602  7A17
3603  7A17
3604  7A17 ED 91 57 12  INIROLL  nextreg $57,18
3605  7A1B 06 88                 ld   b,17*8
3606  7A1D 21 20 E2              ld   hl,UPDATA
3607  7A20              IR1
3608  7A20 11 61 40     INI1     ld   de,16480+1
3609  7A23 73                    ld   (hl),e
3610  7A24 23                    inc  hl
3611  7A25 72                    ld   (hl),d
3612  7A26 23                    inc  hl
3613  7A27 CD 9A 7A              call DOWNDE
3614  7A2A ED 53 21 7A           ld   (INI1+1),de
3615  7A2E
3616  7A2E 11 41 40     INI2     ld   de,16448+1
3617  7A31 73                    ld   (hl),e
3618  7A32 23                    inc  hl
3619  7A33 72                    ld   (hl),d
3620  7A34 23                    inc  hl
3621  7A35 CD 9A 7A              call DOWNDE
3622  7A38 ED 53 2F 7A           ld   (INI2+1),de
3623  7A3C 10 E2                 djnz IR1
3624  7A3E
3625  7A3E 06 88                 ld   b,17*8
3626  7A40 21 1F E2              ld   hl,UPDATA-1
3627  7A43              IR2
3628  7A43 11 61 40     INI12    ld   de,16480+1
3629  7A46 72                    ld   (hl),d
3630  7A47 2B                    dec  hl
3631  7A48 73                    ld   (hl),e
3632  7A49 2B                    dec  hl
3633  7A4A CD 9A 7A              call DOWNDE
3634  7A4D ED 53 44 7A           ld   (INI12+1),de
3635  7A51
3636  7A51 11 41 40     INI22    ld   de,16448+1
3637  7A54 72                    ld   (hl),d
3638  7A55 2B                    dec  hl
3639  7A56 73                    ld   (hl),e
3640  7A57 2B                    dec  hl
3641  7A58 CD 9A 7A              call DOWNDE
3642  7A5B ED 53 52 7A           ld   (INI22+1),de
3643  7A5F 10 E2                 djnz IR2
3644  7A61
3645  7A61              ROLLUP
3646  7A61
3647  7A61 21 20 E2              ld   hl,UPDATA
3648  7A64 C3 6A 7A              jp   ROLL
3649  7A67              ROLLDOWN
3650  7A67 21 00 E0              ld   hl,DOWNDATA
3651  7A6A ED 91 57 12  ROLL	 nextreg $57,18
3652  7A6E ED 73 93 7A           ld   (SP_ST+1),sp
3653  7A72 F9                    ld   sp,hl
3654  7A73 3E 88                 ld   a,8*17
3655  7A75              ROLL1
3656  7A75 E1                    pop  hl
3657  7A76 D1                    pop  de
3658  7A77
3659  7A77 ED A0                 ldi
3660  7A79 ED A0                 ldi
3661  7A7B ED A0                 ldi
3662  7A7D ED A0                 ldi
3663  7A7F ED A0                 ldi
3664  7A81 ED A0                 ldi
3665  7A83 ED A0                 ldi
3666  7A85 ED A0                 ldi
3667  7A87 ED A0                 ldi
3668  7A89 ED A0                 ldi
3669  7A8B ED A0                 ldi
3670  7A8D ED A0                 ldi
3671  7A8F
3672  7A8F 3D                    dec  a
3673  7A90 20 E3                 jr   nz,ROLL1
3674  7A92
3675  7A92 31 00 00     SP_ST    ld   sp,0
3676  7A95 ED 91 57 01  		 nextreg $57,1				;Stránka na uložení VideoRam
3677  7A99 C9                    ret
3678  7A9A
3679  7A9A              DOWNDE
3680  7A9A 14                    inc  d
3681  7A9B 7A                    ld   a,d
3682  7A9C E6 07                 and  7
3683  7A9E C0                    ret  nz
3684  7A9F 7B                    ld   a,e
3685  7AA0 C6 20                 add  a,32
3686  7AA2 5F                    ld   e,a
3687  7AA3 7A                    ld   a,d
3688  7AA4 D8                    ret  c
3689  7AA5 D6 08                 sub  8
3690  7AA7 57                    ld   d,a
3691  7AA8 C9                    ret
3692  7AA9 00 00        maxpos	defw 0
3693  7AAB 00 00        maxpos2 defw 0
3694  7AAD 00           pp		defb 0
3695  7AAE 00           pp_a	defb 0
3696  7AAF E5           print:	push hl
3697  7AB0 D5           		push de
3698  7AB1 21 37 00     		ld hl,55
3699  7AB4 19           		add hl,de
3700  7AB5
3701  7AB5 22 A9 7A     		ld (maxpos),hl
3702  7AB8 11 21 00     		ld de,33
3703  7ABB 19           		add hl,de
3704  7ABC 22 AB 7A     		ld (maxpos2),hl
3705  7ABF D1           		pop de
3706  7AC0 E1           		pop hl
3707  7AC1              ;		ld	de,printpos
3708  7AC1 ED 53 BF 7E  p6b		ld	(pos),de
3709  7AC5 AF           		xor	a
3710  7AC6 32 C1 7E     		ld	(roll),a
3711  7AC9
3712  7AC9              print1:
3713  7AC9 E5           		push hl
3714  7ACA 2A A9 7A     		ld hl,(maxpos)
3715  7ACD B7                   or a
3716  7ACE ED 5B BF 7E  		ld de,(pos)
3717  7AD2 ED 52        		sbc hl,de
3718  7AD4 20 07        		jr nz,pophl
3719  7AD6 21 08 00     odskok	ld hl,8
3720  7AD9 19           		add hl,de
3721  7ADA 22 BF 7E     		ld (pos),hl
3722  7ADD
3723  7ADD
3724  7ADD              pophl
3725  7ADD 2A BF 7E     		ld hl,(pos)
3726  7AE0 ED 5B AB 7A  		ld de,(maxpos2)
3727  7AE4 B7           		or a
3728  7AE5 ED 52        		sbc hl,de
3729  7AE7 20 02        		jr nz, pophl2
3730  7AE9 E1           		pop hl
3731  7AEA C9           		ret
3732  7AEB              pophl2
3733  7AEB E1           		pop hl
3734  7AEC E5           		push	hl
3735  7AED 7E           		ld	a,(hl)
3736  7AEE E6 7F        		and	127
3737  7AF0 B7           		or a
3738  7AF1 20 02        		jr nz,ppp1
3739  7AF3
3740  7AF3 3E 20        		ld a,32
3741  7AF5              ppp1
3742  7AF5 CD 23 7B     		call	ascii
3743  7AF8 3A C1 7E     		ld	a,(roll)
3744  7AFB 3C           		inc	a
3745  7AFC FE 01        		cp	1
3746  7AFE CC 1B 7B     		call	z,print2
3747  7B01 FE 02        		cp	2
3748  7B03 CC 1B 7B     		call	z,print2
3749  7B06 FE 04        		cp	4
3750  7B08 20 05        		jr	nz,print3
3751  7B0A 3E 00        		ld	a,0
3752  7B0C CD 1B 7B     		call	print2
3753  7B0F              print3:
3754  7B0F 32 C1 7E     		ld	(roll),a
3755  7B12 E1           		pop	hl
3756  7B13 E5           		push hl
3757  7B14 7E           		ld a,(hl)
3758  7B15 B7           		or a
3759  7B16 E1           		pop hl
3760  7B17 23           		inc	hl
3761  7B18 C8           		ret	z
3762  7B19 18 AE        		jr	print1
3763  7B1B
3764  7B1B              print2:
3765  7B1B 2A BF 7E     		ld	hl,(pos)
3766  7B1E 23           		inc	hl
3767  7B1F 22 BF 7E     		ld	(pos),hl
3768  7B22 C9           		ret
3769  7B23
3770  7B23              ascii:
3771  7B23 01 BF 7B     		ld	bc,font
3772  7B26 C5           		push	bc
3773  7B27 D6 20        		sub	32
3774  7B29 5F           		ld	e,a
3775  7B2A 16 00        		ld	d,0
3776  7B2C 06 08        		ld	b,8
3777  7B2E 21 00 00     		ld	hl,0
3778  7B31              x8:
3779  7B31 19           		add	hl,de
3780  7B32 10 FD        		djnz	x8
3781  7B34 C1           		pop	bc
3782  7B35 09           		add	hl,bc
3783  7B36 ED 5B BF 7E  		ld	de,(pos)
3784  7B3A EB           		ex	de,hl
3785  7B3B              asci0:
3786  7B3B 3A C1 7E     		ld	a,(roll)
3787  7B3E FE 03        		cp	3
3788  7B40 28 40        		jr	z,roll3
3789  7B42 FE 02        		cp	2
3790  7B44 28 1E        		jr	z,roll2
3791  7B46 FE 01        		cp	1
3792  7B48 28 04        		jr	z,roll1
3793  7B4A              roll0:
3794  7B4A CD 92 7B     		call	asci1
3795  7B4D C9           		ret
3796  7B4E
3797  7B4E              roll1:
3798  7B4E 06 08        		ld	b,8
3799  7B50              rol1_1:
3800  7B50 1A           		ld	a,(de)
3801  7B51 CB 27        		sla	a
3802  7B53 0E 00        		ld	c,0
3803  7B55 CB 11        		rl	c
3804  7B57 CB 27        		sla	a
3805  7B59 CB 11        		rl	c
3806  7B5B C5           		push	bc
3807  7B5C CD 9D 7B     		call	asci2
3808  7B5F C1           		pop	bc
3809  7B60 13           		inc	de
3810  7B61 10 ED        		djnz	rol1_1
3811  7B63 C9           		ret
3812  7B64
3813  7B64              roll2:
3814  7B64 06 08        		ld	b,8
3815  7B66              rol2_1:
3816  7B66 1A           		ld	a,(de)
3817  7B67 CB 27        		sla	a
3818  7B69 0E 00        		ld	c,0
3819  7B6B CB 11        		rl	c
3820  7B6D CB 27        		sla	a
3821  7B6F CB 11        		rl	c
3822  7B71 CB 27        		sla	a
3823  7B73 CB 11        		rl	c
3824  7B75 CB 27        		sla	a
3825  7B77 CB 11        		rl	c
3826  7B79 C5           		push	bc
3827  7B7A CD 9D 7B     		call	asci2
3828  7B7D C1           		pop	bc
3829  7B7E 13           		inc	de
3830  7B7F 10 E5        		djnz	rol2_1
3831  7B81 C9           		ret
3832  7B82
3833  7B82              roll3:
3834  7B82 06 08        		ld	b,8
3835  7B84              rol3_1:
3836  7B84 1A           		ld	a,(de)
3837  7B85 CB 3F        		srl	a
3838  7B87 CB 3F        		srl	a
3839  7B89 C5           		push	bc
3840  7B8A CD A7 7B     		call	asci3
3841  7B8D C1           		pop	bc
3842  7B8E 13           		inc	de
3843  7B8F 10 F3        		djnz	rol3_1
3844  7B91 C9           		ret
3845  7B92
3846  7B92              asci1:
3847  7B92 06 08        		ld	b,8
3848  7B94              asc1:
3849  7B94 1A           		ld	a,(de)
3850  7B95 77           		ld	(hl),a
3851  7B96 13           		inc	de
3852  7B97 CD A9 7B     		call	downhl
3853  7B9A 10 F8        		djnz	asc1
3854  7B9C C9           		ret
3855  7B9D
3856  7B9D              asci2:
3857  7B9D 77           		ld	(hl),a
3858  7B9E 79           		ld	a,c
3859  7B9F 2B           		dec	hl
3860  7BA0 B6           		or	(hl)
3861  7BA1 77           		ld	(hl),a
3862  7BA2 23           		inc	hl
3863  7BA3 CD A9 7B     		call	downhl
3864  7BA6 C9           		ret
3865  7BA7
3866  7BA7              asci3:
3867  7BA7 B6           		or	(hl)
3868  7BA8 77           		ld	(hl),a
3869  7BA9
3870  7BA9              downhl:
3871  7BA9 24           		inc	h
3872  7BAA 7C           		ld	a,h
3873  7BAB E6 07        		and	7
3874  7BAD C0           		ret	nz
3875  7BAE 7D           		ld	a,l
3876  7BAF C6 20        		add	a,32
3877  7BB1 6F           		ld	l,a
3878  7BB2 7C           		ld	a,h
3879  7BB3 38 03        		jr	c,down2
3880  7BB5 D6 08        		sub	8
3881  7BB7 67           		ld	h,a
3882  7BB8              down2:
3883  7BB8 FE 58        		cp	88
3884  7BBA D8           		ret	c
3885  7BBB 21 40 00     		ld	hl,64
3886  7BBE C9           		ret
3887  7BBF
3888  7BBF              ;5-bit font
3889  7BBF              font:
3890  7BBF 00 00 00 00  		db	$00, $00, $00, $00, $00, $00, $00, $00
3890  7BC3 00 00 00 00
3891  7BC7 00 20 20 20  		db	$00, $20, $20, $20, $20, $00, $20, $00
3891  7BCB 20 00 20 00
3892  7BCF 00 50 50 00  		db	$00, $50, $50, $00, $00, $00, $00, $00
3892  7BD3 00 00 00 00
3893  7BD7 00 50 F8 50  		db	$00, $50, $F8, $50, $50, $F8, $50, $00
3893  7BDB 50 F8 50 00
3894  7BDF 00 20 F8 A0  		db	$00, $20, $F8, $A0, $F8, $28, $F8, $20
3894  7BE3 F8 28 F8 20
3895  7BE7 00 40 A8 50  		db	$00, $40, $A8, $50, $20, $50, $A8, $10
3895  7BEB 20 50 A8 10
3896  7BEF 00 20 50 20  		db	$00, $20, $50, $20, $68, $90, $68, $00
3896  7BF3 68 90 68 00
3897  7BF7 00 10 20 00  		db	$00, $10, $20, $00, $00, $00, $00, $00
3897  7BFB 00 00 00 00
3898  7BFF 00 08 10 10  		db	$00, $08, $10, $10, $10, $10, $08, $00
3898  7C03 10 10 08 00
3899  7C07 00 40 20 20  		db	$00, $40, $20, $20, $20, $20, $40, $00
3899  7C0B 20 20 40 00
3900  7C0F 00 00 50 20  		db	$00, $00, $50, $20, $F8, $20, $50, $00
3900  7C13 F8 20 50 00
3901  7C17 00 00 20 20  		db	$00, $00, $20, $20, $F8, $20, $20, $00
3901  7C1B F8 20 20 00
3902  7C1F 00 00 00 00  		db	$00, $00, $00, $00, $00, $10, $10, $20
3902  7C23 00 10 10 20
3903  7C27 00 00 00 00  		db	$00, $00, $00, $00, $78, $00, $00, $00
3903  7C2B 78 00 00 00
3904  7C2F 00 00 00 00  		db	$00, $00, $00, $00, $00, $30, $30, $00
3904  7C33 00 30 30 00
3905  7C37 00 00 08 10  		db	$00, $00, $08, $10, $20, $40, $80, $00
3905  7C3B 20 40 80 00
3906  7C3F 00 70 98 A8  		db	$00, $70, $98, $A8, $A8, $C8, $70, $00
3906  7C43 A8 C8 70 00
3907  7C47 00 60 A0 20  		db	$00, $60, $A0, $20, $20, $20, $F8, $00
3907  7C4B 20 20 F8 00
3908  7C4F 00 70 88 08  		db	$00, $70, $88, $08, $70, $80, $F8, $00
3908  7C53 70 80 F8 00
3909  7C57 00 70 88 30  		db	$00, $70, $88, $30, $08, $88, $70, $00
3909  7C5B 08 88 70 00
3910  7C5F 00 10 30 50  		db	$00, $10, $30, $50, $90, $F8, $10, $00
3910  7C63 90 F8 10 00
3911  7C67 00 F8 80 F0  		db	$00, $F8, $80, $F0, $08, $88, $70, $00
3911  7C6B 08 88 70 00
3912  7C6F 00 70 80 F0  		db	$00, $70, $80, $F0, $88, $88, $70, $00
3912  7C73 88 88 70 00
3913  7C77 00 F8 08 10  		db	$00, $F8, $08, $10, $20, $40, $40, $00
3913  7C7B 20 40 40 00
3914  7C7F 00 70 88 70  		db	$00, $70, $88, $70, $88, $88, $70, $00
3914  7C83 88 88 70 00
3915  7C87 00 70 88 88  		db	$00, $70, $88, $88, $78, $08, $70, $00
3915  7C8B 78 08 70 00
3916  7C8F 00 00 00 20  		db	$00, $00, $00, $20, $00, $00, $20, $00
3916  7C93 00 00 20 00
3917  7C97 00 00 20 00  		db	$00, $00, $20, $00, $00, $20, $20, $40
3917  7C9B 00 20 20 40
3918  7C9F 00 00 08 10  		db	$00, $00, $08, $10, $20, $10, $08, $00
3918  7CA3 20 10 08 00
3919  7CA7 00 00 00 78  		db	$00, $00, $00, $78, $00, $78, $00, $00
3919  7CAB 00 78 00 00
3920  7CAF 00 00 20 10  		db	$00, $00, $20, $10, $08, $10, $20, $00
3920  7CB3 08 10 20 00
3921  7CB7 00 70 88 10  		db	$00, $70, $88, $10, $20, $00, $20, $00
3921  7CBB 20 00 20 00
3922  7CBF 00 70 08 68  		db	$00, $70, $08, $68, $A8, $A8, $70, $00
3922  7CC3 A8 A8 70 00
3923  7CC7 00 70 88 88  		db	$00, $70, $88, $88, $F8, $88, $88, $00
3923  7CCB F8 88 88 00
3924  7CCF 00 F0 88 F0  		db	$00, $F0, $88, $F0, $88, $88, $F0, $00
3924  7CD3 88 88 F0 00
3925  7CD7 00 70 88 80  		db	$00, $70, $88, $80, $80, $88, $70, $00
3925  7CDB 80 88 70 00
3926  7CDF 00 E0 90 88  		db	$00, $E0, $90, $88, $88, $90, $E0, $00
3926  7CE3 88 90 E0 00
3927  7CE7 00 F8 80 F0  		db	$00, $F8, $80, $F0, $80, $80, $F8, $00
3927  7CEB 80 80 F8 00
3928  7CEF 00 F8 80 F0  		db	$00, $F8, $80, $F0, $80, $80, $80, $00
3928  7CF3 80 80 80 00
3929  7CF7 00 70 88 80  		db	$00, $70, $88, $80, $B8, $88, $70, $00
3929  7CFB B8 88 70 00
3930  7CFF 00 88 88 F8  		db	$00, $88, $88, $F8, $88, $88, $88, $00
3930  7D03 88 88 88 00
3931  7D07 00 F8 20 20  		db	$00, $F8, $20, $20, $20, $20, $F8, $00
3931  7D0B 20 20 F8 00
3932  7D0F 00 08 08 08  		db	$00, $08, $08, $08, $88, $88, $70, $00
3932  7D13 88 88 70 00
3933  7D17 00 90 A0 C0  		db	$00, $90, $A0, $C0, $A0, $90, $88, $00
3933  7D1B A0 90 88 00
3934  7D1F 00 80 80 80  		db	$00, $80, $80, $80, $80, $80, $F8, $00
3934  7D23 80 80 F8 00
3935  7D27 00 88 D8 A8  		db	$00, $88, $D8, $A8, $88, $88, $88, $00
3935  7D2B 88 88 88 00
3936  7D2F 00 88 C8 A8  		db	$00, $88, $C8, $A8, $98, $88, $88, $00
3936  7D33 98 88 88 00
3937  7D37 00 70 88 88  		db	$00, $70, $88, $88, $88, $88, $70, $00
3937  7D3B 88 88 70 00
3938  7D3F 00 F0 88 88  		db	$00, $F0, $88, $88, $F0, $80, $80, $00
3938  7D43 F0 80 80 00
3939  7D47 00 70 88 88  		db	$00, $70, $88, $88, $A8, $98, $70, $00
3939  7D4B A8 98 70 00
3940  7D4F 00 F0 88 88  		db	$00, $F0, $88, $88, $F0, $90, $88, $00
3940  7D53 F0 90 88 00
3941  7D57 00 70 80 70  		db	$00, $70, $80, $70, $08, $88, $70, $00
3941  7D5B 08 88 70 00
3942  7D5F 00 F8 20 20  		db	$00, $F8, $20, $20, $20, $20, $20, $00
3942  7D63 20 20 20 00
3943  7D67 00 88 88 88  		db	$00, $88, $88, $88, $88, $88, $70, $00
3943  7D6B 88 88 70 00
3944  7D6F 00 88 88 88  		db	$00, $88, $88, $88, $88, $50, $20, $00
3944  7D73 88 50 20 00
3945  7D77 00 88 88 88  		db	$00, $88, $88, $88, $88, $A8, $50, $00
3945  7D7B 88 A8 50 00
3946  7D7F 00 88 50 20  		db	$00, $88, $50, $20, $20, $50, $88, $00
3946  7D83 20 50 88 00
3947  7D87 00 88 50 20  		db	$00, $88, $50, $20, $20, $20, $20, $00
3947  7D8B 20 20 20 00
3948  7D8F 00 F8 08 30  		db	$00, $F8, $08, $30, $40, $80, $F8, $00
3948  7D93 40 80 F8 00
3949  7D97 00 38 20 20  		db	$00, $38, $20, $20, $20, $20, $38, $00
3949  7D9B 20 20 38 00
3950  7D9F 00 00 80 40  		db	$00, $00, $80, $40, $20, $10, $08, $00
3950  7DA3 20 10 08 00
3951  7DA7 00 70 10 10  		db	$00, $70, $10, $10, $10, $10, $70, $00
3951  7DAB 10 10 70 00
3952  7DAF 00 20 70 A8  		db	$00, $20, $70, $A8, $20, $20, $20, $00
3952  7DB3 20 20 20 00
3953  7DB7 00 00 00 00  		db	$00, $00, $00, $00, $00, $00, $00, $FC
3953  7DBB 00 00 00 FC
3954  7DBF 00 30 48 E0  		db	$00, $30, $48, $E0, $40, $40, $F8, $00
3954  7DC3 40 40 F8 00
3955  7DC7 00 00 70 08  		db	$00, $00, $70, $08, $78, $88, $78, $00
3955  7DCB 78 88 78 00
3956  7DCF 00 80 80 F0  		db	$00, $80, $80, $F0, $88, $88, $F0, $00
3956  7DD3 88 88 F0 00
3957  7DD7 00 00 38 40  		db	$00, $00, $38, $40, $40, $40, $38, $00
3957  7DDB 40 40 38 00
3958  7DDF 00 08 08 78  		db	$00, $08, $08, $78, $88, $88, $78, $00
3958  7DE3 88 88 78 00
3959  7DE7 00 00 70 88  		db	$00, $00, $70, $88, $F0, $80, $78, $00
3959  7DEB F0 80 78 00
3960  7DEF 00 30 40 60  		db	$00, $30, $40, $60, $40, $40, $40, $00
3960  7DF3 40 40 40 00
3961  7DF7 00 00 78 88  		db	$00, $00, $78, $88, $88, $78, $08, $70
3961  7DFB 88 78 08 70
3962  7DFF 00 80 80 F0  		db	$00, $80, $80, $F0, $88, $88, $88, $00
3962  7E03 88 88 88 00
3963  7E07 00 20 00 60  		db	$00, $20, $00, $60, $20, $20, $70, $00
3963  7E0B 20 20 70 00
3964  7E0F 00 08 00 08  		db	$00, $08, $00, $08, $08, $08, $48, $30
3964  7E13 08 08 48 30
3965  7E17 00 40 50 60  		db	$00, $40, $50, $60, $60, $50, $48, $00
3965  7E1B 60 50 48 00
3966  7E1F 00 40 40 40  		db	$00, $40, $40, $40, $40, $40, $30, $00
3966  7E23 40 40 30 00
3967  7E27 00 00 D0 A8  		db	$00, $00, $D0, $A8, $A8, $A8, $A8, $00
3967  7E2B A8 A8 A8 00
3968  7E2F 00 00 F0 88  		db	$00, $00, $F0, $88, $88, $88, $88, $00
3968  7E33 88 88 88 00
3969  7E37 00 00 70 88  		db	$00, $00, $70, $88, $88, $88, $70, $00
3969  7E3B 88 88 70 00
3970  7E3F 00 00 F0 88  		db	$00, $00, $F0, $88, $88, $F0, $80, $80
3970  7E43 88 F0 80 80
3971  7E47 00 00 78 88  		db	$00, $00, $78, $88, $88, $78, $08, $08
3971  7E4B 88 78 08 08
3972  7E4F 00 00 38 40  		db	$00, $00, $38, $40, $40, $40, $40, $00
3972  7E53 40 40 40 00
3973  7E57 00 00 70 80  		db	$00, $00, $70, $80, $70, $08, $F0, $00
3973  7E5B 70 08 F0 00
3974  7E5F 00 20 70 20  		db	$00, $20, $70, $20, $20, $20, $18, $00
3974  7E63 20 20 18 00
3975  7E67 00 00 88 88  		db	$00, $00, $88, $88, $88, $88, $70, $00
3975  7E6B 88 88 70 00
3976  7E6F 00 00 88 88  		db	$00, $00, $88, $88, $50, $50, $20, $00
3976  7E73 50 50 20 00
3977  7E77 00 00 88 A8  		db	$00, $00, $88, $A8, $A8, $A8, $50, $00
3977  7E7B A8 A8 50 00
3978  7E7F 00 00 88 50  		db	$00, $00, $88, $50, $20, $50, $88, $00
3978  7E83 20 50 88 00
3979  7E87 00 00 88 88  		db	$00, $00, $88, $88, $88, $78, $08, $70
3979  7E8B 88 78 08 70
3980  7E8F 00 00 F8 10  		db	$00, $00, $F8, $10, $20, $40, $F8, $00
3980  7E93 20 40 F8 00
3981  7E97 00 38 20 C0  		db	$00, $38, $20, $C0, $20, $20, $38, $00
3981  7E9B 20 20 38 00
3982  7E9F 00 10 10 10  		db	$00, $10, $10, $10, $10, $10, $10, $00
3982  7EA3 10 10 10 00
3983  7EA7 00 E0 20 18  		db	$00, $E0, $20, $18, $20, $20, $E0, $00
3983  7EAB 20 20 E0 00
3984  7EAF 00 28 50 00  		db	$00, $28, $50, $00, $00, $00, $00, $00
3984  7EB3 00 00 00 00
3985  7EB7 00 78 84 B4  		db	$00, $78, $84, $B4, $B4, $84, $78, $00
3985  7EBB B4 84 78 00
3986  7EBF
3987  7EBF 00 00        pos:		dw	0
3988  7EC1 00           roll:		db	0
3989  7EC2 00 00 00...  txtbuf:		ds	44
3990  7EEE
3991  7EEE              text:
3992  7EEE 4E 6F 77 20  		db	"Now playing: ",0
3992  7EF2 70 6C 61 79
3992  7EF6 69 6E 67 3A
3992  7EFA 20 00
3993  7EFC 41 6C 6C 20  txtallfiles db "All files:",0
3993  7F00 66 69 6C 65
3993  7F04 73 3A 00
3994  7F07 50 6F 73 69  txtcurrentfile db "Position:",0
3994  7F0B 74 69 6F 6E
3994  7F0F 3A 00
3995  7F11
3996  7F11              DOWNDATA equ $e000
3997  7F11              UPDATA   equ DOWNDATA + 4*8*17
3998  7F11              bufscr equ $e000
3999  7F11              KKK
4000  7F11
4001  7F11              			org #9000
4002  9000 00 00 00...  txtbuff    ds 100
4003  9064
4004  9064              			module key
4005  9064
4006  9064              check
4007  9064              ahl0
4008  9064 CD 51 74     		 call KEYSCAN
4009  9067
4010  9067 7B           		 ld   a,e
4011  9068 3C                    inc  a
4012  9069 C8                    ret z
4013  906A 7A                    ld   a,d
4014  906B 21 82 74              ld   hl,SYMTAB
4015  906E FE 18                 cp   $18
4016  9070 28 0A                 jr   z,aHLSM2
4017  9072 21 AA 74              ld   hl,CAPSTAB
4018  9075 FE 27                 cp   $27
4019  9077 28 03                 jr   z,aHLSM2
4020  9079 21 D1 74              ld   hl,NORMTAB
4021  907C 16 00        aHLSM2    ld   d,0
4022  907E 19                    add  hl,de
4023  907F 7E                    ld   a,(hl)
4024  9080 B7                    or   a
4025  9081 C8                    ret z
4026  9082
4027  9082 06 00        aLAST_KEY ld   b,0
4028  9084 B8                    cp   b
4029  9085 28 00                 jr   z,aSEDI_KEY
4030  9087
4031  9087              aSEDI_KEY
4032  9087 32 83 90              ld   (aLAST_KEY+1),a
4033  908A F5           		push af
4034  908B              		;call beepk
4035  908B F1           		pop af
4036  908C C9           		ret
4037  908D              			endmodule
4038  908D
4039  908D
4040  908D              infosong
4041  908D E5           			push hl
4042  908E 21 00 90     			ld hl,txtbuff
4043  9091 11 01 90     			ld de,txtbuff+1
4044  9094 01 63 00     			ld bc,99
4045  9097 3E 20        			ld a,32
4046  9099 77           			ld (hl),a
4047  909A ED B0        			ldir
4048  909C E1           			pop hl
4049  909D
4050  909D 11 00 90     			ld de,txtbuff
4051  90A0 06 5A        			ld b,90
4052  90A2 7E           i1			ld a,(hl)
4053  90A3 FE 20        			cp 32
4054  90A5 D8           			ret c
4055  90A6 FE 80        			cp 128
4056  90A8 D0           			ret nc
4057  90A9 12           			ld (de),a
4058  90AA 13           			inc de
4059  90AB 23           			inc hl
4060  90AC 10 F4        			djnz i1
4061  90AE C9           			ret
4062  90AF
4063  90AF 00           pocitadlo	defb 0
4064  90B0 00           ACBhlas		defb 0
4065  90B1
4066  90B1 F3           STCPLAY	di
4067  90B2
4068  90B2 21 A0 50     			ld hl,20640
4069  90B5 11 D1 65     			ld de,by1
4070  90B8 06 18        			ld b,8*3
4071  90BA D5           sappp        push de
4072  90BB C5           			push bc
4073  90BC E5           			push hl
4074  90BD 06 20        			ld b,32
4075  90BF 1A           sappp0		ld a,(de)
4076  90C0 77           			ld (hl),a
4077  90C1 23           			inc hl
4078  90C2 10 FB        			djnz sappp0
4079  90C4 E1           			pop hl
4080  90C5 C1           			pop bc
4081  90C6 D1           			pop de
4082  90C7
4083  90C7 CD A9 7B     			call downhl
4084  90CA 13           			inc de
4085  90CB 10 ED        			djnz sappp
4086  90CD
4087  90CD
4088  90CD              			; ld de,18464+15
4089  90CD              			; ld hl,txtcurrentfile
4090  90CD              			; call print
4091  90CD
4092  90CD              			; ld de,18432+15
4093  90CD              			; ld hl,txtallfiles
4094  90CD              			; call print
4095  90CD
4096  90CD
4097  90CD              		; ld hl,(apos_all)
4098  90CD              		; inc hl
4099  90CD              		; ld de,18464+15+11
4100  90CD              		; ld (NUMPOS+1),de
4101  90CD              		; call DEC16
4102  90CD              		; defw 20*256
4103  90CD
4104  90CD              		; ld hl,(ALLFILES)
4105  90CD              		; ld de,18432+15+11
4106  90CD              		; ld (NUMPOS+1),de
4107  90CD              		; call DEC16
4108  90CD              		; defw 20*256
4109  90CD 3E 00        		ld a,0
4110  90CF 21 A6 73     		ld hl,endsong
4111  90D2 77           		ld (hl),a
4112  90D3
4113  90D3
4114  90D3
4115  90D3 21 DB B0     		ld hl,modstart + 7
4116  90D6 CD 8D 90     		call infosong
4117  90D9 21 00 90     		ld hl,txtbuff
4118  90DC AF           		xor a
4119  90DD 32 12 90     		ld (txtbuff+18),a
4120  90E0 11 21 50             ld de,20512+1
4121  90E3 CD AF 7A     		call print
4122  90E6
4123  90E6
4124  90E6 CD 88 A4     		call	stc.music_init
4125  90E9 FB           .sloop	ei
4126  90EA 76           		halt
4127  90EB
4128  90EB E5           		push hl
4129  90EC D5           		push de
4130  90ED C5           		push bc
4131  90EE
4132  90EE 21 B0 90     		ld hl,ACBhlas
4133  90F1 AF           		xor a
4134  90F2 77           		ld (hl),a
4135  90F3
4136  90F3 21 A0 5A     		 ld   hl,23200;Vymazání
4137  90F6 11 A1 5A              ld   de,23201;předešlého
4138  90F9 01 60 00              ld   bc,96   ;zobrazení.
4139  90FC 70                    ld   (hl),b
4140  90FD ED B0                 ldir
4141  90FF
4142  90FF 3E 08                 ld   a,8     ;A teď nové
4143  9101 21 B0 5A              ld   hl,23216;zobrazení.
4144  9104 11 AF 5A              ld   de,23215;Kanál A.
4145  9107 CD A8 98              call ATR
4146  910A
4147  910A 3E 0A                 ld   a,10    ;Kanál C.
4148  910C 21 D0 5A              ld   hl,23248
4149  910F 11 CF 5A              ld   de,23247
4150  9112 CD A8 98              call ATR
4151  9115
4152  9115 3E 09                 ld   a,9     ;Kanál B.
4153  9117 21 F0 5A              ld   hl,23280
4154  911A 11 EF 5A              ld   de,23279
4155  911D CD A8 98              call ATR
4156  9120
4157  9120
4158  9120 3A B0 90     		 ld a,(ACBhlas)
4159  9123 B7           		 or a
4160  9124 28 07        		 jr z,.s1
4161  9126 21 AF 90     		 ld hl,pocitadlo
4162  9129 AF           		 xor a
4163  912A 77           		 ld (hl),a
4164  912B 18 04        		 jr .s2
4165  912D 21 AF 90     .s1		 ld hl,pocitadlo
4166  9130 34           		 inc (hl)
4167  9131              .s2
4168  9131
4169  9131 CD CE 98     		call keysetup
4170  9134 C1           		pop bc
4171  9135 D1           		pop de
4172  9136 E1           		pop hl
4173  9137
4174  9137 CD 60 A5     		call	stc.music_play
4175  913A AF           		xor a
4176  913B 3A 1B 9A             ld a,(klavesa)
4177  913E FE 01                cp 1
4178  9140 28 18        		jr z,sakoneca
4179  9142 FE 20        		cp 32
4180  9144 28 0E        		jr z,.s3
4181  9146 3A AF 90     		ld a,(pocitadlo)
4182  9149 EE 64        		xor 100
4183  914B 28 07        		jr z,.s3
4184  914D 3A E2 A1     		ld a,(music_setup)
4185  9150 CB 7F        		bit 7,a
4186  9152 28 95        		jr z,.sloop
4187  9154
4188  9154 3E 20        .s3		ld a,32
4189  9156 21 A6 73     		ld hl,endsong
4190  9159 77           		ld (hl),a
4191  915A F5           sakoneca	push af
4192  915B
4193  915B CD 7E A1     		call music_mute
4194  915E F1           		pop af
4195  915F C3 61 73     		jp navrat
4196  9162
4197  9162
4198  9162
4199  9162 F3           STPPLAY		di
4200  9163
4201  9163 21 A0 50     			ld hl,20640
4202  9166 11 D1 65     			ld de,by1
4203  9169 06 18        			ld b,8*3
4204  916B D5           stappp        push de
4205  916C C5           			push bc
4206  916D E5           			push hl
4207  916E 06 20        			ld b,32
4208  9170 1A           stappp0		ld a,(de)
4209  9171 77           			ld (hl),a
4210  9172 23           			inc hl
4211  9173 10 FB        			djnz stappp0
4212  9175 E1           			pop hl
4213  9176 C1           			pop bc
4214  9177 D1           			pop de
4215  9178
4216  9178 CD A9 7B     			call downhl
4217  917B 13           			inc de
4218  917C 10 ED        			djnz stappp
4219  917E
4220  917E
4221  917E              			; ld de,18464+15
4222  917E              			; ld hl,txtcurrentfile
4223  917E              			; call print
4224  917E
4225  917E              			; ld de,18432+15
4226  917E              			; ld hl,txtallfiles
4227  917E              			; call print
4228  917E
4229  917E
4230  917E              		; ld hl,(apos_all)
4231  917E              		; inc hl
4232  917E              		; ld de,18464+15+11
4233  917E              		; ld (NUMPOS+1),de
4234  917E              		; call DEC16
4235  917E              		; defw 20*256
4236  917E
4237  917E              		; ld hl,(ALLFILES)
4238  917E              		; ld de,18432+15+11
4239  917E              		; ld (NUMPOS+1),de
4240  917E              		; call DEC16
4241  917E              		; defw 20*256
4242  917E 3E 00        		ld a,0
4243  9180 21 A6 73     		ld hl,endsong
4244  9183 77           		ld (hl),a
4245  9184
4246  9184
4247  9184
4248  9184 21 FA B0     		ld hl,modstart + 11 + 27
4249  9187 CD 8D 90     		call infosong
4250  918A 21 00 90     		ld hl,txtbuff
4251  918D AF           		xor a
4252  918E 32 50 90     		ld (txtbuff+80),a
4253  9191
4254  9191 21 66 73     		ld hl,tmp
4255  9194 11 67 73     		ld de,tmp+1
4256  9197 AF           		xor a
4257  9198 77           		ld (hl),a
4258  9199 01 30 00     		ld bc,48
4259  919C ED B0        		ldir
4260  919E
4261  919E 21 00 90     		ld hl,txtbuff
4262  91A1 11 66 73     		ld de,tmp
4263  91A4 01 19 00     		ld bc,25
4264  91A7 ED B0        		ldir
4265  91A9 21 66 73     		ld hl,tmp
4266  91AC 11 21 50             ld de,20512+1
4267  91AF CD AF 7A     		call print
4268  91B2
4269  91B2
4270  91B2
4271  91B2
4272  91B2
4273  91B2 CD 15 A9     		call	stp.music_init
4274  91B5 FB           .astloop	ei
4275  91B6 76           		halt
4276  91B7
4277  91B7 E5           		push hl
4278  91B8 D5           		push de
4279  91B9 C5           		push bc
4280  91BA
4281  91BA 21 B0 90     		ld hl,ACBhlas
4282  91BD AF           		xor a
4283  91BE 77           		ld (hl),a
4284  91BF
4285  91BF 21 A0 5A     		 ld   hl,23200;Vymazání
4286  91C2 11 A1 5A              ld   de,23201;předešlého
4287  91C5 01 60 00              ld   bc,96   ;zobrazení.
4288  91C8 70                    ld   (hl),b
4289  91C9 ED B0                 ldir
4290  91CB
4291  91CB 3E 08                 ld   a,8     ;A teď nové
4292  91CD 21 B0 5A              ld   hl,23216;zobrazení.
4293  91D0 11 AF 5A              ld   de,23215;Kanál A.
4294  91D3 CD A8 98              call ATR
4295  91D6
4296  91D6 3E 0A                 ld   a,10    ;Kanál C.
4297  91D8 21 D0 5A              ld   hl,23248
4298  91DB 11 CF 5A              ld   de,23247
4299  91DE CD A8 98              call ATR
4300  91E1
4301  91E1 3E 09                 ld   a,9     ;Kanál B.
4302  91E3 21 F0 5A              ld   hl,23280
4303  91E6 11 EF 5A              ld   de,23279
4304  91E9 CD A8 98              call ATR
4305  91EC CD CE 98      		 call keysetup
4306  91EF
4307  91EF 3A B0 90     		 ld a,(ACBhlas)
4308  91F2 B7           		 or a
4309  91F3 28 07        		 jr z,.st1
4310  91F5 21 AF 90     		 ld hl,pocitadlo
4311  91F8 AF           		 xor a
4312  91F9 77           		 ld (hl),a
4313  91FA 18 04        		 jr .st2
4314  91FC 21 AF 90     .st1		 ld hl,pocitadlo
4315  91FF 34           		 inc (hl)
4316  9200              .st2
4317  9200 C1           		pop bc
4318  9201 D1           		pop de
4319  9202 E1           		pop hl
4320  9203
4321  9203 CD 4C AA     		call	stp.music_play
4322  9206 AF           		xor a
4323  9207 3A 1B 9A             ld a,(klavesa)
4324  920A FE 01                cp	1
4325  920C 28 18        		jr z,stakoneca
4326  920E FE 20        		cp 32
4327  9210 28 0E        		jr z,.st3
4328  9212
4329  9212 3A AF 90     		ld a,(pocitadlo)
4330  9215 EE 64        		xor 100
4331  9217 28 07        		jr z,.st3
4332  9219 3A E2 A1     		ld a,(music_setup)
4333  921C CB 7F        		bit 7,a
4334  921E 28 95        		jr z,.astloop
4335  9220
4336  9220 3E 20        .st3		ld a,32
4337  9222 21 A6 73     		ld hl,endsong
4338  9225 77           		ld (hl),a
4339  9226 F5           stakoneca	push af
4340  9227
4341  9227 CD 53 A6     		call stc.music_mute
4342  922A F1           		pop af
4343  922B C3 61 73     		jp navrat
4344  922E
4345  922E
4346  922E 53 51 20 54  sqt_txt	defb "SQ Tracker", 0
4346  9232 72 61 63 6B
4346  9236 65 72 00
4347  9239 F3           SQTPLAY	di
4348  923A
4349  923A 21 A0 50     			ld hl,20640
4350  923D 11 D1 65     			ld de,by1
4351  9240 06 18        			ld b,8*3
4352  9242 D5           appp        push de
4353  9243 C5           			push bc
4354  9244 E5           			push hl
4355  9245 06 20        			ld b,32
4356  9247 1A           appp0		ld a,(de)
4357  9248 77           			ld (hl),a
4358  9249 23           			inc hl
4359  924A 10 FB        			djnz appp0
4360  924C E1           			pop hl
4361  924D C1           			pop bc
4362  924E D1           			pop de
4363  924F
4364  924F CD A9 7B     			call downhl
4365  9252 13           			inc de
4366  9253 10 ED        			djnz appp
4367  9255
4368  9255
4369  9255              			; ld de,18464+15
4370  9255              			; ld hl,txtcurrentfile
4371  9255              			; call print
4372  9255
4373  9255              			; ld de,18432+15
4374  9255              			; ld hl,txtallfiles
4375  9255              			; call print
4376  9255
4377  9255
4378  9255              		; ld hl,(apos_all)
4379  9255              		; inc hl
4380  9255              		; ld de,18464+15+11
4381  9255              		; ld (NUMPOS+1),de
4382  9255              		; call DEC16
4383  9255              		; defw 20*256
4384  9255
4385  9255              		; ld hl,(ALLFILES)
4386  9255              		; ld de,18432+15+11
4387  9255              		; ld (NUMPOS+1),de
4388  9255              		; call DEC16
4389  9255              		; defw 20*256
4390  9255 3E 00        		ld a,0
4391  9257 21 A6 73     		ld hl,endsong
4392  925A 77           		ld (hl),a
4393  925B
4394  925B 21 2E 92     		ld hl,sqt_txt
4395  925E 11 21 50             ld de,20512+1
4396  9261 CD AF 7A     		call print
4397  9264
4398  9264
4399  9264 CD E1 92     		call	SQ_INIT
4400  9267 FB           .loop	ei
4401  9268 76           		halt
4402  9269
4403  9269 E5           		push hl
4404  926A D5           		push de
4405  926B C5           		push bc
4406  926C 21 A0 5A     		 ld   hl,23200;Vymazání
4407  926F 11 A1 5A              ld   de,23201;předešlého
4408  9272 01 60 00              ld   bc,96   ;zobrazení.
4409  9275 70                    ld   (hl),b
4410  9276 ED B0                 ldir
4411  9278
4412  9278
4413  9278 AF           		 xor a
4414  9279 21 B0 90     		 ld hl,ACBhlas
4415  927C 77           		 ld (hl),a
4416  927D
4417  927D 3E 08                 ld   a,8     ;A teď nové
4418  927F 21 B0 5A              ld   hl,23216;zobrazení.
4419  9282 11 AF 5A              ld   de,23215;Kanál A.
4420  9285 CD A8 98              call ATR
4421  9288
4422  9288 3E 0A                 ld   a,10    ;Kanál C.
4423  928A 21 D0 5A              ld   hl,23248
4424  928D 11 CF 5A              ld   de,23247
4425  9290 CD A8 98              call ATR
4426  9293
4427  9293 3E 09                 ld   a,9     ;Kanál B.
4428  9295 21 F0 5A              ld   hl,23280
4429  9298 11 EF 5A              ld   de,23279
4430  929B CD A8 98              call ATR
4431  929E
4432  929E
4433  929E 3A B0 90     		 ld a,(ACBhlas)
4434  92A1 B7           		 or a
4435  92A2 28 07        		 jr z,.as1
4436  92A4 21 AF 90     		 ld hl,pocitadlo
4437  92A7 AF           		 xor a
4438  92A8 77           		 ld (hl),a
4439  92A9 18 04        		 jr .as2
4440  92AB 21 AF 90     .as1	 ld hl,pocitadlo
4441  92AE 34           		 inc (hl)
4442  92AF              .as2
4443  92AF
4444  92AF CD CE 98      		call keysetup
4445  92B2 C1           		pop bc
4446  92B3 D1           		pop de
4447  92B4 E1           		pop hl
4448  92B5
4449  92B5 CD 44 93     		call	SQ_PLAY
4450  92B8 AF           		xor a
4451  92B9 3A 1B 9A             ld a,(klavesa)
4452  92BC FE 01        		cp 1
4453  92BE 28 18        		jr z,akoneca
4454  92C0 FE 20        		cp 32
4455  92C2 28 0E        		jr z,.as3
4456  92C4
4457  92C4 3A AF 90     		ld a,(pocitadlo)
4458  92C7 EE 64        		xor 100
4459  92C9 28 07        		jr z,.as3
4460  92CB 3A E0 92     		ld a,(SQ_STATUS)
4461  92CE CB 7F        		bit 7,a
4462  92D0 28 95        		jr z,.loop
4463  92D2 3E 20        .as3	ld a,32
4464  92D4 21 A6 73     		ld hl,endsong
4465  92D7 77           		ld (hl),a
4466  92D8 F5           akoneca	push af
4467  92D9
4468  92D9 CD 7E A1     		call music_mute
4469  92DC F1           		pop af
4470  92DD C3 61 73     		jp navrat
4471  92E0              		;jr	.loop
4472  92E0
4473  92E0
4474  92E0              ; Povodny player generovany SQ-Linkerom doplneny o GLOBVOL,
4475  92E0              ; tj. moznost globalneho utlmenia ~ © 2009 mborik/RM-TEAM.
4476  92E0              ; Upravene na prehravanie SQT suborov, ktorym je potrebne
4477  92E0              ; na zaciatku relokovat absolutne adresy, dalej bol doplneny
4478  92E0              ; stavovy bajt podobny aky ma moj PT3 player, cize je mozne
4479  92E0              ; song neopakovat, alebo fadeoutovat © 2020 mborik/SinDiKat.
4480  92E0
4481  92E0              ; Stavovy bajt prehravaca:
4482  92E0              ; bit.0 nastav ak nechces ziaden looping
4483  92E0              ; bit.1 nastav ak chces, aby nastal postupny fadeout po par sekundach
4484  92E0              ; bit.7 sa nastavi vzdy, po odohrati vsetkych pozicii alebo po fadeoute
4485  92E0              ; ...v jednoduchosti:	2 - fadeout after loop
4486  92E0              ;			1 - no loop
4487  92E0              ;			0 - loop forever
4488  92E0 02           SQ_STATUS:	db	2
4489  92E1
4490  92E1              SQ_INIT:
4491  92E1 ED 5B D6 B0  		ld	de,(RELOC_BASE)		; nacitame prvy offset, z ktoreho
4492  92E5 21 DE B0     		ld	hl,BUFFER+10		; po odpocitani skutocnej adresy dat
4493  92E8 AF           		xor	a			; bez 10 bajtov ziskavame offset,
4494  92E9 ED 52        		sbc	hl,de			; ktorym musime relokovat vsetky
4495  92EB E5           		push	hl			; absolutne ukazovatele v datach muziky
4496  92EC ED 5B E0 B0  		ld	de,(RELOC_ENDPTR)
4497  92F0 19           		add	hl,de
4498  92F1 C1           		pop	bc
4499  92F2 2B           RELOCATOR:	dec	hl
4500  92F3 56           		ld	d,(hl)
4501  92F4 2B           		dec	hl
4502  92F5 5E           		ld	e,(hl)
4503  92F6 EB           		ex	de,hl
4504  92F7 09           		add	hl,bc
4505  92F8 EB           		ex	de,hl
4506  92F9 73           		ld	(hl),e
4507  92FA 23           		inc	hl
4508  92FB 72           		ld	(hl),d
4509  92FC 2B           		dec	hl
4510  92FD 7D           		ld	a,l
4511  92FE D6 D6        		sub	RELOC_BASE % 256
4512  9300 20 F0        		jr	nz,RELOCATOR
4513  9302 32 74 93      	    ld      (CHKFADEOUT+1),a
4514  9305 32 A4 93             ld      (GLOBVOL+1),a
4515  9308 3D           		dec	a
4516  9309 32 65 94     		ld	(SQ_REST+1),a		; resetujem detektor konca skladby
4517  930C 3E 02        		ld a,2
4518  930E 32 E0 92     		ld (SQ_STATUS),a
4519  9311 3E 08        		ld	a,8			; inicializacia prehravaca
4520  9313 32 4F 98     		ld	(CHNZ1),a
4521  9316 32 6C 98     		ld	(CHNZ2),a
4522  9319 32 89 98     		ld	(CHNZ3),a
4523  931C 01 01 01     		ld	bc,$0101
4524  931F CD D2 94     		call	SQ_REND1
4525  9322 2A DC B0     CHN_INIT: 	ld	hl,(I_POSITIONS)
4526  9325 DD 21 4F 98  		ld	ix,CHNZ1
4527  9329 CD 10 94     		call	SQ_I9
4528  932C CD 09 94     		call	SQ_I
4529  932F CD 09 94     		call	SQ_I
4530  9332 11 3F 07     SQ_STOP:	ld	de,#073F		; AY registre 7-12 nastav na uplne ticho
4531  9335 CD E1 93     CHN_INILOOP:	call	OUT1
4532  9338 1E 00        		ld	e,0
4533  933A 14           		inc	d
4534  933B 7A           		ld	a,d
4535  933C FE 0C        		cp	12
4536  933E 20 F5        		jr	nz,CHN_INILOOP
4537  9340 C9           		ret
4538  9341
4539  9341 34           SQ_DEADEND:	inc	(hl)			; prehravanie skoncilo, SQ_PLAY je mrtve
4540  9342 18 EE        		jr	SQ_STOP
4541  9344
4542  9344 21 A6 98     SQ_PLAY:	ld	hl,SQ_SYS
4543  9347 35           		dec	(hl)
4544  9348 20 29        		jr	nz,CHKFADEOUT
4545  934A 36 00        SQ_PLAYSPEED:	ld	(hl),0
4546  934C 23           		inc	hl
4547  934D 35           		dec	(hl)
4548  934E 7E           		ld	a,(hl)
4549  934F B7           		or	a
4550  9350 CC 64 94     		call	z,SQ_REST
4551  9353 FE 04        		cp	4
4552  9355 DC 09 94     		call	c,SQ_I
4553  9358
4554  9358 DD 21 4F 98  SQ_PP		ld	ix,CHNZ1
4555  935C 0E 24        		ld	c,36
4556  935E CD DC 94     		call	SQ_P
4557  9361 DD 21 6C 98  		ld	ix,CHNZ2
4558  9365 0E 12        		ld	c,18
4559  9367 CD DC 94     		call	SQ_P
4560  936A DD 21 89 98  		ld	ix,CHNZ3
4561  936E 0E 09        		ld	c,9
4562  9370 CD DC 94     		call	SQ_P
4563  9373
4564  9373 3E 00        CHKFADEOUT:	ld	a,0			; kontrola, ci fadeoutujeme
4565  9375 B7           		or	a
4566  9376 28 48        		jr	z,SQ_C
4567  9378 3A E0 92     		ld	a,(SQ_STATUS)
4568  937B CB 7F        		bit	7,a
4569  937D 20 C2        		jr	nz,SQ_DEADEND
4570  937F
4571  937F 3E 00        COUNTFADEOUT:	ld	a,0
4572  9381 3D           		dec	a
4573  9382 32 80 93     		ld	(COUNTFADEOUT+1),a
4574  9385 20 1C        		jr	nz,GLOBVOL
4575  9387 3A A4 93     		ld	a,(GLOBVOL+1)
4576  938A 3C           		inc	a
4577  938B FE 10        		cp	16
4578  938D 28 5C        		jr	z,RESETFADEOUT
4579  938F 32 A4 93     		ld	(GLOBVOL+1),a
4580  9392 3E 00        DIVFADEOUT:	ld	a,0
4581  9394 CB 3F        		srl	a
4582  9396 6F           		ld	l,a
4583  9397 CB 3D        		srl	l
4584  9399 85           		add	a,l
4585  939A 20 01        		jr	nz,DIVFADEOUT1
4586  939C 3C           		inc	a
4587  939D 32 80 93     DIVFADEOUT1:	ld	(COUNTFADEOUT+1),a
4588  93A0 32 93 93     		ld	(DIVFADEOUT+1),a
4589  93A3
4590  93A3 3E 00        GLOBVOL:	ld	a,0			; global attenuation
4591  93A5 32 5A 98     		ld	(CHNZ1+11),a		; pre vsetky kanaly
4592  93A8 32 77 98     		ld	(CHNZ2+11),a
4593  93AB 32 94 98     		ld	(CHNZ3+11),a
4594  93AE CB 5F        		bit	3,a			; dosiahla hodnota attenuation
4595  93B0 28 0E        		jr	z,SQ_C			; cislo vacsie ako 8?
4596  93B2 21 4F 98     		ld	hl,CHNZ1		; tak je nutne upravit sq-flagy,
4597  93B5 11 1D 00     		ld	de,CHZL 		; aby sa prestali prehravat hw obalky
4598  93B8 0E 03        		ld	c,3			; vo vsetkych troch kanaloch
4599  93BA CB 86        GLOBVOL1:	res	0,(hl)			; vynulovanim nulteho bytu
4600  93BC 19           		add	hl,de
4601  93BD 0D           		dec	c
4602  93BE 20 FA        		jr	nz,GLOBVOL1
4603  93C0
4604  93C0 AF           SQ_C:		xor	a			; vynuluje mixer register
4605  93C1 6F           		ld	l,a
4606  93C2 67           		ld	h,a
4607  93C3 22 D4 93     		ld	(SQ_N+1),hl
4608  93C6 DD 21 4F 98  		ld	ix,CHNZ1		; postupne prechadza kanalmi
4609  93CA CD A6 96     		call	SQ_R
4610  93CD CD A6 96     		call	SQ_R
4611  93D0 CD A6 96     		call	SQ_R
4612  93D3
4613  93D3 01 00 00     SQ_N:		ld	bc,0			; nastavenie mixer registra
4614  93D6 78           		ld	a,b			; B = sumove generatory pre ABC
4615  93D7 17           		rla				; C = tonove generatory pre ABC
4616  93D8 17           		rla
4617  93D9 17           		rla
4618  93DA B1           		or	c
4619  93DB 2F           		cpl				; potom sa bity komplementuju
4620  93DC F6 00        SQ_OFF: 	or	0
4621  93DE 5F           		ld	e,a
4622  93DF 16 07        		ld	d,7			; a posielaju na register 7 AY
4623  93E1 01 FD FF     OUT1:		ld	bc,$FFFD
4624  93E4 ED 51        		out	(c),d
4625  93E6 06 BF        		ld	b,$BF
4626  93E8 ED 59        		out	(c),e
4627  93EA C9           		ret
4628  93EB
4629  93EB 21 FF FF     RESETFADEOUT:	ld	hl,-1
4630  93EE 22 A6 98     		ld	(SQ_SYS),hl
4631  93F1 21 E0 92     		ld	hl,SQ_STATUS
4632  93F4 CB FE        		set	7,(hl)
4633  93F6 AF           		xor	a
4634  93F7 01           		db	1 ; ld bc,NN namiesto ld a,N
4635  93F8
4636  93F8 3E 30        ENABLEFADE:	ld	a,48
4637  93FA 21 74 93     FORCEFADE:	ld	hl,CHKFADEOUT+1
4638  93FD 34           		inc	(hl)
4639  93FE 32 80 93     		ld	(COUNTFADEOUT+1),a
4640  9401 32 93 93     		ld	(DIVFADEOUT+1),a
4641  9404 2F           		cpl
4642  9405 32 65 94     		ld	(SQ_REST+1),a
4643  9408 C9           		ret
4644  9409
4645  9409 21 00 00     SQ_I:		ld	hl,0
4646  940C DD 21 4F 98  SQ_I1:		ld	ix,CHNZ1
4647  9410 7E           SQ_I9:		ld	a,(hl)
4648  9411 B7           		or	a
4649  9412 20 06        		jr	nz,SQ_I3
4650  9414 32 65 94     		ld	(SQ_REST+1),a		; oznac, ze pri najblizsom patterne
4651  9417 2A DE B0     		ld	hl,(I_REPEAT)		; budeme testovat fadeout alebo noloop
4652  941A 46           SQ_I3:		ld	b,(hl)
4653  941B CB 10        		rl	b
4654  941D DD CB 00 AE  		res	5,(ix+0)
4655  9421 30 04        		jr	nc,SQ_I4
4656  9423 DD CB 00 EE  		set	5,(ix+0)
4657  9427 23           SQ_I4:		inc	hl
4658  9428 7E           		ld	a,(hl)
4659  9429 E6 0F        		and	15
4660  942B DD 77 1A     		ld	(ix+26),a
4661  942E 7E           		ld	a,(hl)
4662  942F E6 F0        		and	240
4663  9431 1F           		rra
4664  9432 1F           		rra
4665  9433 1F           		rra
4666  9434 1F           		rra
4667  9435 FE 09        		cp	9
4668  9437 38 03        		jr	c,ZBR
4669  9439 D6 09        		sub	9
4670  943B 2F           		cpl
4671  943C DD 77 18     ZBR:		ld	(ix+24),a
4672  943F 23           		inc	hl
4673  9440 22 0A 94     		ld	(SQ_I+1),hl
4674  9443 68           		ld	l,b
4675  9444 26 00        		ld	h,0
4676  9446 ED 5B DA B0  		ld	de,(I_PATTERNS)
4677  944A 19           		add	hl,de
4678  944B 5E           		ld	e,(hl)
4679  944C 23           		inc	hl
4680  944D 56           		ld	d,(hl)
4681  944E 13           		inc	de
4682  944F DD 73 16     		ld	(ix+22),e
4683  9452 DD 72 17     		ld	(ix+23),d
4684  9455 11 1D 00     		ld	de,CHZL
4685  9458 DD 19        		add	ix,de
4686  945A DD 22 0E 94  		ld	(SQ_I1+2),ix
4687  945E C9           		ret
4688  945F
4689  945F CD EB 93     SQ_NOFADE:	call	RESETFADEOUT
4690  9462 F1           		pop	af
4691  9463 C9           		ret
4692  9464
4693  9464 3E FF        SQ_REST:	ld	a,-1
4694  9466 B7           		or	a
4695  9467 20 0C        		jr	nz,SQ_REST0
4696  9469 3A E0 92     		ld	a,(SQ_STATUS)
4697  946C 0F           		rrca			; bit 0. nastaveny = koniec
4698  946D 38 F0        		jr	c,SQ_NOFADE
4699  946F 0F           		rrca			; bit 1. nastaveny = fadeout
4700  9470 30 03        		jr	nc,SQ_REST0
4701  9472 CD F8 93     		call	ENABLEFADE
4702  9475 3A 69 98     SQ_REST0:	ld	a,(CHNZ1+26)
4703  9478 32 5A 98     		ld	(CHNZ1+11),a
4704  947B 3A 86 98     		ld	a,(CHNZ2+26)
4705  947E 32 77 98     		ld	(CHNZ2+11),a
4706  9481 3A A3 98     		ld	a,(CHNZ3+26)
4707  9484 32 94 98     		ld	(CHNZ3+11),a
4708  9487 2A 65 98     		ld	hl,(CHNZ1+22)
4709  948A 2B           		dec	hl
4710  948B 46           		ld	b,(hl)
4711  948C 23           		inc	hl
4712  948D 22 61 98     		ld	(CHNZ1+18),hl
4713  9490 2A 82 98     		ld	hl,(CHNZ2+22)
4714  9493 22 7E 98     		ld	(CHNZ2+18),hl
4715  9496 2A 9F 98     		ld	hl,(CHNZ3+22)
4716  9499 22 9B 98     		ld	(CHNZ3+18),hl
4717  949C 2A 67 98     		ld	hl,(CHNZ1+24)
4718  949F 22 63 98     		ld	(CHNZ1+20),hl
4719  94A2 2A 84 98     		ld	hl,(CHNZ2+24)
4720  94A5 22 80 98     		ld	(CHNZ2+20),hl
4721  94A8 2A A1 98     		ld	hl,(CHNZ3+24)
4722  94AB 22 9D 98     		ld	(CHNZ3+20),hl
4723  94AE 2A 0A 94     		ld	hl,(SQ_I+1)
4724  94B1 4E           		ld	c,(hl)
4725  94B2 23           		inc	hl
4726  94B3 22 0A 94     		ld	(SQ_I+1),hl
4727  94B6 21 4F 98     		ld	hl,CHNZ1
4728  94B9 22 0E 94     		ld	(SQ_I1+2),hl
4729  94BC 3E 03        		ld	a,3
4730  94BE 16 00        		ld	d,0
4731  94C0 CB A6        SQ_REST1:	res	4,(hl)
4732  94C2 CB 6E        		bit	5,(hl)
4733  94C4 28 02        		jr	z,SQ_REST2
4734  94C6 CB E6        		set	4,(hl)
4735  94C8 1E 15        SQ_REST2:	ld	e,21
4736  94CA 19           		add	hl,de
4737  94CB 72           		ld	(hl),d
4738  94CC 1E 08        		ld	e,CHZL-21
4739  94CE 19           		add	hl,de
4740  94CF 3D           		dec	a
4741  94D0 20 EE        		jr	nz,SQ_REST1
4742  94D2 ED 43 A6 98  SQ_REND1:	ld	(SQ_SYS),bc
4743  94D6 79           		ld	a,c
4744  94D7 32 4B 93     SQ_REND2:	ld	(SQ_PLAYSPEED+1),a
4745  94DA 78           		ld	a,b
4746  94DB C9           		ret
4747  94DC
4748  94DC DD 7E 15     SQ_P:		ld	a,(ix+21)
4749  94DF B7           		or	a
4750  94E0 28 0A        		jr	z,Y01
4751  94E2 DD 35 15     		dec	(ix+21)
4752  94E5 DD CB 00 7E  		bit	7,(ix+0)
4753  94E9 20 3E        		jr	nz,Y33
4754  94EB C9           		ret
4755  94EC
4756  94EC DD 5E 12     Y01:		ld	e,(ix+18)
4757  94EF DD 56 13     		ld	d,(ix+19)
4758  94F2 DD CB 00 F6  		set	6,(ix+0)
4759  94F6 DD CB 00 BE  		res	7,(ix+0)
4760  94FA 1A           		ld	a,(de)
4761  94FB 13           		inc	de
4762  94FC CB 7F        		bit	7,a
4763  94FE 28 4D        		jr	z,Y02
4764  9500
4765  9500 DD 73 12     Y05:		ld	(ix+18),e
4766  9503 DD 72 13     		ld	(ix+19),d
4767  9506 47           		ld	b,a
4768  9507 CB 77        		bit	6,a
4769  9509 28 0C        		jr	z,Y60
4770  950B
4771  950B 1B           		dec	de
4772  950C DD 73 1B     		ld	(ix+27),e
4773  950F DD 72 1C     		ld	(ix+28),d
4774  9512 E6 1F        Y34:		and	31
4775  9514 C3 40 96     		jp	SQ_SMP
4776  9517
4777  9517 CB 6F        Y60:		bit	5,a
4778  9519 20 21        		jr	nz,Y06
4779  951B
4780  951B E6 0F        		and	15
4781  951D CB 60        		bit	4,b
4782  951F 28 02        		jr	z,Y07
4783  9521 ED 44        		neg
4784  9523 DD 86 0C     Y07:		add	a,(ix+12)
4785  9526 DD 77 0C     		ld	(ix+12),a
4786  9529 DD 5E 1B     Y33:		ld	e,(ix+27)
4787  952C DD 56 1C     		ld	d,(ix+28)
4788  952F DD CB 00 B6  		res	6,(ix+0)
4789  9533 1A           		ld	a,(de)
4790  9534 CB 7F        		bit	7,a
4791  9536 20 DA        		jr	nz,Y34
4792  9538 13           		inc	de
4793  9539 C3 1B 96     		jp	SMP_ORN
4794  953C
4795  953C E6 0F        Y06:		and	15
4796  953E DD 77 15     		ld	(ix+21),a
4797  9541 CB 60        		bit	4,b
4798  9543 C8           		ret	z
4799  9544 B7           		or	a
4800  9545 28 E2        		jr	z,Y33
4801  9547 DD CB 00 FE  		set	7,(ix+0)
4802  954B 18 DC        		jr	Y33
4803  954D
4804  954D FE 60        Y02:		cp	96
4805  954F DA 01 96     		jp	c,Y03
4806  9552 D6 60        		sub	96
4807  9554 FE 0F        		cp	15
4808  9556 38 11        		jr	c,Y04
4809  9558
4810  9558 21 DD 93     		ld	hl,SQ_OFF+1
4811  955B 47           		ld	b,a
4812  955C 7E           		ld	a,(hl)
4813  955D B1           		or	c
4814  955E 77           		ld	(hl),a
4815  955F DD CB 00 DE  		set	3,(ix+0)
4816  9563 78           		ld	a,b
4817  9564 D6 0F        		sub	15
4818  9566 CA 14 96     		jp	z,Z26
4819  9569
4820  9569 3D           Y04:		dec	a
4821  956A EB           		ex	de,hl
4822  956B 4E           		ld	c,(hl)
4823  956C 23           		inc	hl
4824  956D DD CB 00 76  		bit	6,(ix+0)
4825  9571 28 0A        		jr	z,Y69
4826  9573 DD 75 12     		ld	(ix+18),l
4827  9576 DD 74 13     		ld	(ix+19),h
4828  9579 DD CB 00 B6  		res	6,(ix+0)
4829  957D FE 08        Y69:		cp	8
4830  957F 38 11        		jr	c,Z38
4831  9581 DD CB 00 C6  		set	0,(ix+0)
4832  9585 69           		ld	l,c
4833  9586 5F           		ld	e,a
4834  9587 16 0D        		ld	d,13
4835  9589 CD E1 93     		call	OUT1
4836  958C 16 0B        		ld	d,11
4837  958E 5D           		ld	e,l
4838  958F C3 E1 93     		jp	OUT1
4839  9592
4840  9592 FE 06        Z38:		cp	6			; channel volume set
4841  9594 30 4F        		jr	nc,Z36
4842  9596 DD CB 00 66  		bit	4,(ix+0)
4843  959A C8           		ret	z
4844  959B B7           		or	a
4845  959C 20 07        		jr	nz,Z31
4846  959E 79           		ld	a,c
4847  959F E6 0F        SQ_V:		and	15
4848  95A1 DD 77 0B     		ld	(ix+11),a
4849  95A4 C9           		ret
4850  95A5
4851  95A5 3D           Z31:		dec	a			; channel volume slide
4852  95A6 20 06        		jr	nz,Z32
4853  95A8 79           		ld	a,c
4854  95A9 DD 86 0B     		add	a,(ix+11)
4855  95AC 18 F1        		jr	SQ_V
4856  95AE
4857  95AE 3D           Z32:		dec	a			; global volume set
4858  95AF 20 0B        		jr	nz,Z33
4859  95B1 79           		ld	a,c
4860  95B2 32 5A 98     		ld	(CHNZ1+11),a
4861  95B5 32 77 98     		ld	(CHNZ2+11),a
4862  95B8 32 94 98     		ld	(CHNZ3+11),a
4863  95BB C9           		ret
4864  95BC
4865  95BC 3D           Z33:		dec	a			; global volume slide
4866  95BD 20 11        		jr	nz,Z34
4867  95BF 06 03        		ld	b,3
4868  95C1 11 1D 00     		ld	de,CHZL
4869  95C4 21 5A 98     		ld	hl,CHNZ1+11
4870  95C7 7E           Z33_2:		ld	a,(hl)
4871  95C8 81           		add	a,c
4872  95C9 E6 0F        		and	15
4873  95CB 77           		ld	(hl),a
4874  95CC 19           		add	hl,de
4875  95CD 10 F8        		djnz	Z33_2
4876  95CF C9           		ret
4877  95D0
4878  95D0 21 A6 98     Z34:		ld	hl,SQ_SYS		; speed set
4879  95D3 3D           		dec	a
4880  95D4 20 0B        		jr	nz,Z35
4881  95D6 79           		ld	a,c
4882  95D7 E6 1F        SQ_S:		and	31
4883  95D9 20 02        		jr	nz,SQ_Z
4884  95DB 3E 20        		ld	a,32
4885  95DD 77           SQ_Z:		ld	(hl),a
4886  95DE C3 D7 94     		jp	SQ_REND2
4887  95E1
4888  95E1 7E           Z35:		ld	a,(hl)			; speed slide
4889  95E2 81           		add	a,c
4890  95E3 18 F2        		jr	SQ_S
4891  95E5
4892  95E5 D6 06        Z36:		sub	6
4893  95E7 06 00        		ld	b,0
4894  95E9 79           		ld	a,c
4895  95EA 48           		ld	c,b
4896  95EB 20 03        		jr	nz,Z37
4897  95ED 05           		dec	b
4898  95EE ED 44        		neg
4899  95F0 DD CB 00 D6  Z37:		set	2,(ix+0)
4900  95F4 DD 71 0D     		ld	(ix+13),c
4901  95F7 DD 71 0E     		ld	(ix+14),c
4902  95FA DD 77 0F     		ld	(ix+15),a
4903  95FD DD 70 10     		ld	(ix+16),b
4904  9600 C9           		ret
4905  9601
4906  9601 DD 77 0C     Y03:		ld	(ix+12),a
4907  9604 1B           		dec	de
4908  9605 DD 73 1B     		ld	(ix+27),e
4909  9608 DD 72 1C     		ld	(ix+28),d
4910  960B 13           		inc	de
4911  960C CD 1B 96     		call	SMP_ORN
4912  960F DD CB 00 76  		bit	6,(ix+0)
4913  9613 C8           		ret	z
4914  9614 DD 73 12     Z26:		ld	(ix+18),e
4915  9617 DD 72 13     		ld	(ix+19),d
4916  961A C9           		ret
4917  961B
4918  961B 1A           SMP_ORN:	ld	a,(de)
4919  961C 13           		inc	de
4920  961D CB 7F        		bit	7,a
4921  961F 28 1C        		jr	z,SMP_ORN9
4922  9621 47           		ld	b,a
4923  9622 1F           		rra
4924  9623 E6 1F        		and	31
4925  9625 C4 40 96     		call	nz,SQ_SMP
4926  9628 CB 70        		bit	6,b
4927  962A C8           		ret	z
4928  962B 1A           		ld	a,(de)
4929  962C E6 F0        		and	240
4930  962E CB 18        		rr	b
4931  9630 1F           		rra
4932  9631 1F           		rra
4933  9632 1F           		rra
4934  9633 CB 3F        		srl	a
4935  9635 C4 71 96     		call	nz,SQ_ORN
4936  9638 1A           		ld	a,(de)
4937  9639 13           		inc	de
4938  963A E6 0F        		and	15
4939  963C C8           		ret	z
4940  963D C3 69 95     SMP_ORN9:	jp	Y04
4941  9640
4942  9640 C5           SQ_SMP: 	push	bc
4943  9641 87           		add	a,a
4944  9642 4F           		ld	c,a
4945  9643 06 00        		ld	b,0
4946  9645 DD 7E 00     		ld	a,(ix+0)
4947  9648 E6 F0        		and	%11110000
4948  964A DD 77 00     		ld	(ix+0),a
4949  964D 2A D6 B0     		ld	hl,(I_SAMPLES)
4950  9650 09           		add	hl,bc
4951  9651 4E           		ld	c,(hl)
4952  9652 23           		inc	hl
4953  9653 46           		ld	b,(hl)
4954  9654 DD E5        		push	ix
4955  9656 E1           		pop	hl
4956  9657 23           		inc	hl
4957  9658 71           		ld	(hl),c
4958  9659 23           		inc	hl
4959  965A 70           		ld	(hl),b
4960  965B 03           		inc	bc
4961  965C 03           		inc	bc
4962  965D 23           		inc	hl
4963  965E 71           		ld	(hl),c
4964  965F 23           		inc	hl
4965  9660 70           		ld	(hl),b
4966  9661 23           		inc	hl
4967  9662 36 20        		ld	(hl),32
4968  9664 23           		inc	hl
4969  9665 22 7D 96     		ld	(SQ_NXT+1),hl
4970  9668 C1           		pop	bc
4971  9669 21 DD 93     		ld	hl,SQ_OFF+1
4972  966C 7E           		ld	a,(hl)
4973  966D B1           		or	c
4974  966E A9           		xor	c
4975  966F 77           		ld	(hl),a
4976  9670 C9           		ret
4977  9671
4978  9671 87           SQ_ORN: 	add	a,a
4979  9672 4F           		ld	c,a
4980  9673 06 00        		ld	b,0
4981  9675 2A D8 B0     		ld	hl,(I_ORNAMENTS)
4982  9678 09           		add	hl,bc
4983  9679 4E           		ld	c,(hl)
4984  967A 23           		inc	hl
4985  967B 46           		ld	b,(hl)
4986  967C 21 00 00     SQ_NXT: 	ld	hl,0
4987  967F 71           		ld	(hl),c
4988  9680 23           		inc	hl
4989  9681 70           		ld	(hl),b
4990  9682 23           		inc	hl
4991  9683 03           		inc	bc
4992  9684 03           		inc	bc
4993  9685 71           		ld	(hl),c
4994  9686 23           		inc	hl
4995  9687 70           		ld	(hl),b
4996  9688 23           		inc	hl
4997  9689 36 20        		ld	(hl),32
4998  968B DD CB 00 CE  		set	1,(ix+0)
4999  968F C9           		ret
5000  9690
5001  9690 21 D4 93     OUT2:		ld	hl,SQ_N+1		; podla carry nastavi v SQ_N
5002  9693 CB 16        		rl	(hl)			; tonovy generator, sumovy off
5003  9695 23           		inc	hl			; potom vytiahne cislo kanalu
5004  9696 CB 16        		rl	(hl)
5005  9698 DD 7E 11     		ld	a,(ix+17)
5006  969B C6 08        		add	a,8			; pripocita k nemu 8
5007  969D ED 79        		out	(c),a			; tj. volume registre AY
5008  969F 06 BF        		ld	b,$BF
5009  96A1 ED 59        		out	(c),e			; a posle hodnotu v E
5010  96A3 C3 BC 97     		jp	SQ_ZCH
5011  96A6
5012  96A6 DD 6E 03     SQ_R:		ld	l,(ix+3)
5013  96A9 DD 66 04     		ld	h,(ix+4)
5014  96AC 01 FD FF     		ld	bc,$FFFD
5015  96AF DD 56 00     		ld	d,(ix+0)
5016  96B2 1E 00        		ld	e,0
5017  96B4 CB 5A        		bit	3,d			; ak sa nema nic hrat, umlcat
5018  96B6 20 D8        		jr	nz,OUT2
5019  96B8 7E           		ld	a,(hl)
5020  96B9 E6 0F        		and	15
5021  96BB C2 C7 96     		jp	nz,SQ_R1
5022  96BE CB 42        		bit	0,d			; ak sa ma hrat obalka, nastav
5023  96C0 28 0B        		jr	z,SQ_R2
5024  96C2 1E 10        		ld	e,16
5025  96C4 C3 CD 96     		jp	SQ_R2
5026  96C7
5027  96C7 DD 96 0B     SQ_R1:		sub	(ix+11) 		; od hlasitosti z sa odpocita
5028  96CA 38 01        		jr	c,SQ_R2 		; global volume nastavenie
5029  96CC 5F           		ld	e,a
5030  96CD
5031  96CD DD 7E 11     SQ_R2:		ld	a,(ix+17)		; vytiahne sa cislo kanalu
5032  96D0 C6 08        		add	a,8			; pripocita sa 8 cim sa dostnem
5033  96D2 ED 79        		out	(c),a			; na registre hlasitosi AY
5034  96D4 06 BF        		ld	b,$BF
5035  96D6 ED 59        		out	(c),e
5036  96D8 7E           		ld	a,(hl)
5037  96D9 23           		inc	hl
5038  96DA E6 F0        		and	240			; vytiahujem sumove data
5039  96DC 1F           		rra
5040  96DD 1F           		rra
5041  96DE 1F           		rra
5042  96DF 16 06        		ld	d,6
5043  96E1 5E           		ld	e,(hl)
5044  96E2 CB 13        		rl	e
5045  96E4 CB 6E        		bit	5,(hl)			; zistujem, ci budeme sumiet
5046  96E6 28 0A        		jr	z,SQ_ZNN
5047  96E8 CE 00        		adc	a,0
5048  96EA 06 FF        		ld	b,$FF
5049  96EC ED 51        		out	(c),d
5050  96EE 06 BF        		ld	b,$BF
5051  96F0 ED 79        		out	(c),a
5052  96F2 7B           SQ_ZNN:		ld	a,e
5053  96F3 17           		rla
5054  96F4 EB           		ex	de,hl
5055  96F5 21 D4 93     		ld	hl,SQ_N+1		; nastavime v SQ_N stavy oboch
5056  96F8 CB 16        		rl	(hl)			; generatorov (sum/ton) pre ch.
5057  96FA 23           		inc	hl
5058  96FB 17           		rla
5059  96FC CB 16        		rl	(hl)
5060  96FE EB           		ex	de,hl
5061  96FF 7E           		ld	a,(hl)			; vypocitavanie frekvencie...
5062  9700 E6 1F        		and	31
5063  9702 57           		ld	d,a
5064  9703 23           		inc	hl
5065  9704 5E           		ld	e,(hl)
5066  9705 23           		inc	hl
5067  9706 D5           		push	de
5068  9707 16 00        		ld	d,0
5069  9709 DD 35 05     		dec	(ix+5)
5070  970C C2 2D 97     		jp	nz,FQ_2
5071  970F DD 6E 01     		ld	l,(ix+1)
5072  9712 DD 66 02     		ld	h,(ix+2)
5073  9715 7E           		ld	a,(hl)
5074  9716 23           		inc	hl
5075  9717 FE 20        		cp	32
5076  9719 4E           		ld	c,(hl)
5077  971A 23           		inc	hl
5078  971B 20 08        		jr	nz,FQ_1
5079  971D DD CB 00 DE  		set	3,(ix+0)
5080  9721 DD CB 00 8E  		res	1,(ix+0)
5081  9725 47           FQ_1:		ld	b,a
5082  9726 87           		add	a,a
5083  9727 80           		add	a,b
5084  9728 5F           		ld	e,a
5085  9729 19           		add	hl,de
5086  972A DD 71 05     		ld	(ix+5),c
5087  972D DD 75 03     FQ_2:		ld	(ix+3),l
5088  9730 DD 74 04     		ld	(ix+4),h
5089  9733 DD 7E 0C     		ld	a,(ix+12)
5090  9736 DD CB 00 4E  		bit	1,(ix+0)
5091  973A 28 2A        		jr	z,FQ_5
5092  973C DD 6E 08     		ld	l,(ix+8)
5093  973F DD 66 09     		ld	h,(ix+9)
5094  9742 86           		add	a,(hl)
5095  9743 23           		inc	hl
5096  9744 DD 35 0A     		dec	(ix+10)
5097  9747 C2 60 97     		jp	nz,FQ_4
5098  974A 08           		ex	af,af'
5099  974B DD 6E 06     		ld	l,(ix+6)
5100  974E DD 66 07     		ld	h,(ix+7)
5101  9751 7E           		ld	a,(hl)
5102  9752 23           		inc	hl
5103  9753 FE 20        		cp	32
5104  9755 58           		ld	e,b
5105  9756 28 02        		jr	z,FQ_3
5106  9758 4E           		ld	c,(hl)
5107  9759 5F           		ld	e,a
5108  975A 23           FQ_3:		inc	hl
5109  975B 19           		add	hl,de
5110  975C DD 71 0A     		ld	(ix+10),c
5111  975F 08           		ex	af,af'
5112  9760 DD 75 08     FQ_4:		ld	(ix+8),l
5113  9763 DD 74 09     		ld	(ix+9),h
5114  9766 DD 86 14     FQ_5:		add	a,(ix+20)
5115  9769 FE 2D        		cp	45
5116  976B 30 0B        		jr	nc,FQ_6
5117  976D 87           		add	a,a
5118  976E 5F           		ld	e,a
5119  976F 21 C2 97     		ld	hl,FRQ2
5120  9772 19           		add	hl,de
5121  9773 56           		ld	d,(hl)
5122  9774 23           		inc	hl
5123  9775 C3 7D 97     		jp	FQ_7
5124  9778
5125  9778 21 EF 97     FQ_6:		ld	hl,FRQ1-45
5126  977B 5F           		ld	e,a
5127  977C 19           		add	hl,de
5128  977D 5E           FQ_7:		ld	e,(hl)
5129  977E EB           		ex	de,hl
5130  977F D1           		pop	de			; ...frekvenciu mame,
5131  9780 CB 62        		bit	4,d			; bude este fine-tuning?
5132  9782 CB A2        		res	4,d
5133  9784 28 02        		jr	z,FQ_9
5134  9786 19           		add	hl,de
5135  9787 01           		db	1 ; ld bc,NN namiesto sbc hl,de
5136  9788 ED 52        FQ_9:		sbc	hl,de
5137  978A DD CB 00 56  		bit	2,(ix+0)
5138  978E 28 16        		jr	z,OUT9
5139  9790 DD 4E 0D     		ld	c,(ix+13)
5140  9793 DD 46 0E     		ld	b,(ix+14)
5141  9796 09           		add	hl,bc
5142  9797 EB           		ex	de,hl
5143  9798 DD 6E 0F     		ld	l,(ix+15)
5144  979B DD 66 10     		ld	h,(ix+16)
5145  979E 09           		add	hl,bc
5146  979F DD 75 0D     		ld	(ix+13),l
5147  97A2 DD 74 0E     		ld	(ix+14),h
5148  97A5 EB           		ex	de,hl
5149  97A6
5150  97A6 DD 7E 11     OUT9:		ld	a,(ix+17)		; vytiahi cislo kanalu
5151  97A9 87           		add	a,a			; vynasob dvoma
5152  97AA 01 FD FF     		ld	bc,$FFFD		; a naprogramuj freq tonu
5153  97AD ED 79        		out	(c),a
5154  97AF 06 BF        		ld	b,$BF
5155  97B1 ED 69        		out	(c),l
5156  97B3 3C           		inc	a
5157  97B4 06 FF        		ld	b,$FF
5158  97B6 ED 79        		out	(c),a
5159  97B8 06 BF        		ld	b,$BF
5160  97BA ED 61        		out	(c),h
5161  97BC 11 1D 00     SQ_ZCH: 	ld	de,CHZL 		; prejdi s IX na dalsi kanal
5162  97BF DD 19        		add	ix,de
5163  97C1 C9           		ret
5164  97C2
5165  97C2 0D 5D 0C 9C  FRQ2:		db	13,93,12,156
5166  97C6 0B E7 0B 3C  		db	11,231,11,60
5167  97CA 0A 9B 0A 02  		db	10,155,10,2,9,115
5167  97CE 09 73
5168  97D0 08 EB 08 6B  		db	8,235,8,107,7,242
5168  97D4 07 F2
5169  97D6 07 80 07 14  		db	7,128,7,20,6,174
5169  97DA 06 AE
5170  97DC 06 4E 05 F4  		db	6,78,5,244,5,158
5170  97E0 05 9E
5171  97E2 05 4F 05 01  		db	5,79,5,1,4,185
5171  97E6 04 B9
5172  97E8 04 75 04 35  		db	4,117,4,53,3,249
5172  97EC 03 F9
5173  97EE 03 C0 03 8A  		db	3,192,3,138,3,87
5173  97F2 03 57
5174  97F4 03 27 02 FA  		db	3,39,2,250,2,207
5174  97F8 02 CF
5175  97FA 02 A7 02 81  		db	2,167,2,129,2,93
5175  97FE 02 5D
5176  9800 02 3B 02 1B  		db	2,59,2,27,1,252
5176  9804 01 FC
5177  9806 01 E0 01 C5  		db	1,224,1,197,1,172
5177  980A 01 AC
5178  980C 01 94 01 7D  		db	1,148,1,125,1,104
5178  9810 01 68
5179  9812 01 53 01 40  		db	1,83,1,64
5180  9816 01 2E 01 1D  		db	1,46,1,29,1,13
5180  981A 01 0D
5181  981C
5182  981C FE F0 E2 D6  FRQ1:		db	254,240,226,214
5183  9820 CA BE B4 AA  		db	202,190,180,170
5184  9824 A0 97 8F 87  		db	160,151,143,135
5185  9828 7F 78 71 6B  		db	127,120,113,107
5186  982C 65 5F 5A 55  		db	101,95,90,85,80
5186  9830 50
5187  9831 4C 47 43 40  		db	76,71,67,64,60,57
5187  9835 3C 39
5188  9837 35 32 30 2D  		db	53,50,48,45,42,40
5188  983B 2A 28
5189  983D 26 24 22 20  		db	38,36,34,32,30,28
5189  9841 1E 1C
5190  9843 1B 19 18 16  		db	27,25,24,22,21,20
5190  9847 15 14
5191  9849 13 12 11 10  		db	19,18,17,16,15,14
5191  984D 0F 0E
5192  984F
5193  984F 00           CHNZ1:	db	0
5194  9850 00 00 00 00  		dw	0,0,0,0,0,0,0,0
5194  9854 00 00 00 00
5194  9858 00 00 00 00
5194  985C 00 00 00 00
5195  9860 02 00 00 00  		dw	2,0,0,0,0,0
5195  9864 00 00 00 00
5195  9868 00 00 00 00
5196  986C 00           CHNZ2:	db	0
5197  986D 00 00 00 00  		dw	0,0,0,0,0,0,0,0
5197  9871 00 00 00 00
5197  9875 00 00 00 00
5197  9879 00 00 00 00
5198  987D 01 00 00 00  		dw	1,0,0,0,0,0
5198  9881 00 00 00 00
5198  9885 00 00 00 00
5199  9889 00           CHNZ3:	db	0
5200  988A 00 00 00 00  		dw	0,0,0,0,0,0,0,0
5200  988E 00 00 00 00
5200  9892 00 00 00 00
5200  9896 00 00 00 00
5201  989A 00 00 00 00  		dw	0,0,0,0,0,0
5201  989E 00 00 00 00
5201  98A2 00 00 00 00
5202  98A6
5203  98A6 01 01        SQ_SYS: 	dw	#0101
5204  98A8
5205  98A8              CHZL:		equ	CHNZ2-CHNZ1	; offset medzi kanalmi
5206  98A8
5207  98A8
5208  98A8              ;universal pt2 and pt3 player for zx spectrum and msx
5209  98A8              ;(c)2004-2005 s.v.bulba <vorobey@mail.khstu.ru>
5210  98A8              ;http://bulba.at.kz
5211  98A8
5212  98A8              ;release number
5213  98A8              release equ "0"
5214  98A8
5215  98A8              ;conditional assembly
5216  98A8              ;1) version of rout (zx or msx standards)
5217  98A8              zx equ 1
5218  98A8              msx equ 0
5219  98A8              ;2) current position counter at (start+11)
5220  98A8              curposcounter equ 1
5221  98A8              ;3) allow channels allocation bits at (start+10)
5222  98A8              acbbac equ 1
5223  98A8              ;4) allow loop checking and disabling
5224  98A8              loopchecker equ 1
5225  98A8              ;5) insert official identificator
5226  98A8              id equ 1
5227  98A8
5228  98A8              ATR
5229  98A8 01 FD FF              ld   bc,AY   ;Přečtení hlasitosti
5230  98AB ED 79                 out  (c),a   ;z AY
5231  98AD ED 78                 in   a,(c)
5232  98AF E5           		 push hl
5233  98B0 F5           		 push af
5234  98B1 21 B0 90     		 ld hl,ACBhlas
5235  98B4 B6           		 or (hl)
5236  98B5 77           		 ld (hl),a
5237  98B6 F1           		 pop af
5238  98B7 E1           		 pop hl
5239  98B8              		;	out (254),a
5240  98B8 FE 10                 cp   16      ;Test překročení
5241  98BA 38 02                 jr  c,ATR3      ;maximální hlast.
5242  98BC 3E 0F        		 ld a,15
5243  98BE B7           ATR3     or   a
5244  98BF C8                    ret  z
5245  98C0 47                    ld   b,a     ;Uschování hlast.
5246  98C1 B7                    or a
5247  98C2 1F                    rra          ;Výpočet barvy
5248  98C3 38 02                 jr   c,ATR2  ;atributu.
5249  98C5 CB F7                 set  6,a     ;Nastavení jasu.
5250  98C7              ATR2
5251  98C7 77                    ld   (hl),a  ;Vykreslení
5252  98C8 12                    ld   (de),a  ;atributové čáry.
5253  98C9 23                    inc  hl      ;Opakuje se
5254  98CA 1B                    dec  de      ;tolikrát, kolik
5255  98CB 10 FA                 djnz ATR2    ;je hlasitost.
5256  98CD C9                    ret
5257  98CE
5258  98CE              AY       equ  65533
5259  98CE
5260  98CE
5261  98CE              keysetup
5262  98CE CD 64 90     		call key.check
5263  98D1
5264  98D1 32 1B 9A     		ld (klavesa),a
5265  98D4 FE 61        		cp "a"
5266  98D6 CC 03 9A     		call z,setAY
5267  98D9 FE 79        		cp "y"
5268  98DB CC 10 9A     		call z,setYM
5269  98DE FE 62        		cp "b"
5270  98E0 CC F8 99     		call z,ABC
5271  98E3 FE 63        		cp "c"
5272  98E5 CC ED 99     		call z,ACB
5273  98E8 CD 05 71     		call showsetup
5274  98EB C9           			ret
5275  98EC
5276  98EC              playmusic
5277  98EC
5278  98EC 21 A0 50     			 ld hl,20640
5279  98EF 11 D1 65     			 ld de,by1
5280  98F2 06 18        			 ld b,8*3
5281  98F4 D5           ppp          push de
5282  98F5 C5           			push bc
5283  98F6 E5           			push hl
5284  98F7 06 20        			ld b,32
5285  98F9 1A           ppp0		ld a,(de)
5286  98FA 77           			ld (hl),a
5287  98FB 23           			inc hl
5288  98FC 10 FB        			djnz ppp0
5289  98FE E1           			pop hl
5290  98FF C1           			pop bc
5291  9900 D1           			pop de
5292  9901
5293  9901 CD A9 7B     			call downhl
5294  9904 13           			inc de
5295  9905 10 ED        			djnz ppp
5296  9907
5297  9907
5298  9907
5299  9907              			; ld de,18464+15
5300  9907              			; ld hl,txtcurrentfile
5301  9907              			; call print
5302  9907
5303  9907              			; ld de,18432+15
5304  9907              			; ld hl,txtallfiles
5305  9907              			; call print
5306  9907
5307  9907
5308  9907              		; ld hl,(apos_all)
5309  9907              		; inc hl
5310  9907              		; ld de,18464+15+11
5311  9907              		; ld (NUMPOS+1),de
5312  9907              		; call DEC16
5313  9907              		; defw 20*256
5314  9907
5315  9907              		; ld hl,(ALLFILES)
5316  9907              		; ld de,18432+15+11
5317  9907              		; ld (NUMPOS+1),de
5318  9907              		; call DEC16
5319  9907              		; defw 20*256
5320  9907
5321  9907
5322  9907
5323  9907 AF           		xor a
5324  9908 32 A6 73     		ld (endsong),a
5325  990B 3A 0B 60     		ld a,(typ)
5326  990E FE 33        		cp "3"
5327  9910 20 04        		jr nz,pp0
5328  9912 3E 01                ld a,1 ;pt2,abc,looped
5329  9914 18 02        	    jr pp1
5330  9916              pp0
5331  9916 3E 02        		ld a,2
5332  9918              pp1
5333  9918 F5           		push af
5334  9919 FE 02        		cp 2
5335  991B 20 05        		jr nz,pt3
5336  991D 21 39 B1     		ld hl,modstart + 101
5337  9920 18 03        		jr pt2
5338  9922 21 F2 B0     pt3		ld hl,modstart + 30
5339  9925              pt2
5340  9925
5341  9925 CD 8D 90     		call infosong
5342  9928 21 00 90     		ld hl,txtbuff
5343  992B AF           		xor a
5344  992C 32 50 90     		ld (txtbuff+80),a
5345  992F
5346  992F 21 66 73     		ld hl,tmp
5347  9932 11 67 73     		ld de,tmp+1
5348  9935 AF           		xor a
5349  9936 77           		ld (hl),a
5350  9937 01 30 00     		ld bc,48
5351  993A ED B0        		ldir
5352  993C
5353  993C 21 00 90     		ld hl,txtbuff
5354  993F 11 66 73     		ld de,tmp
5355  9942 01 21 00     		ld bc,maxline-4
5356  9945 ED B0        		ldir
5357  9947 21 66 73     		ld hl,tmp
5358  994A 11 21 50             ld de,20512+1
5359  994D CD AF 7A     		call print
5360  9950
5361  9950 21 66 73     		ld hl,tmp
5362  9953 11 67 73     		ld de,tmp+1
5363  9956 AF           		xor a
5364  9957 77           		ld (hl),a
5365  9958 01 30 00     		ld bc,48
5366  995B ED B0        		ldir
5367  995D
5368  995D 21 21 90     		ld hl,txtbuff + maxline-4
5369  9960 11 66 73     		ld de,tmp
5370  9963 01 25 00     		ld bc,maxline
5371  9966 ED B0        		ldir
5372  9968 21 66 73     		ld hl,tmp
5373  996B 11 41 50             ld de,20512+1 + 32
5374  996E CD AF 7A     		call print
5375  9971
5376  9971
5377  9971
5378  9971
5379  9971 F1           		pop af
5380  9972
5381  9972 CD 1C 9A     		CALL music_init
5382  9975 FB           		EI
5383  9976 76           LOOP	HALT
5384  9977
5385  9977
5386  9977 E5           		push hl
5387  9978 D5           		push de
5388  9979 C5           		push bc
5389  997A
5390  997A
5391  997A
5392  997A 21 A0 5A     		 ld   hl,23200;Vymazání
5393  997D 11 A1 5A              ld   de,23201;předešlého
5394  9980 01 60 00              ld   bc,96   ;zobrazení.
5395  9983 70                    ld   (hl),b
5396  9984 ED B0                 ldir
5397  9986
5398  9986 AF           		 xor a
5399  9987 21 B0 90     		 ld hl,ACBhlas
5400  998A 77           		 ld (hl),a
5401  998B
5402  998B 3E 08                 ld   a,8     ;A teď nové
5403  998D 21 B0 5A              ld   hl,23216;zobrazení.
5404  9990 11 AF 5A              ld   de,23215;Kanál A.
5405  9993 CD A8 98              call ATR
5406  9996
5407  9996 3E 0A                 ld   a,10    ;Kanál C.
5408  9998 21 D0 5A              ld   hl,23248
5409  999B 11 CF 5A              ld   de,23247
5410  999E CD A8 98              call ATR
5411  99A1
5412  99A1 3E 09                 ld   a,9     ;Kanál B.
5413  99A3 21 F0 5A              ld   hl,23280
5414  99A6 11 EF 5A              ld   de,23279
5415  99A9 CD A8 98              call ATR
5416  99AC
5417  99AC 3A B0 90     		 ld a,(ACBhlas)
5418  99AF B7           		 or a
5419  99B0 28 07        		 jr z,.s1
5420  99B2 21 AF 90     		 ld hl,pocitadlo
5421  99B5 AF           		 xor a
5422  99B6 77           		 ld (hl),a
5423  99B7 18 04        		 jr .s2
5424  99B9 21 AF 90     .s1		 ld hl,pocitadlo
5425  99BC 34           		 inc (hl)
5426  99BD              .s2
5427  99BD
5428  99BD CD CE 98     		call keysetup
5429  99C0 C1           		pop bc
5430  99C1 D1           		pop de
5431  99C2 E1           		pop hl
5432  99C3
5433  99C3 CD 55 A0     		CALL music_play
5434  99C6 3A 1B 9A     		ld a,(klavesa)
5435  99C9 FE 01        		cp 1
5436  99CB 28 18        		jr z,koneca
5437  99CD FE 20        		cp 32
5438  99CF 28 0E        		jr z,.s3
5439  99D1 3A AF 90     		ld a,(pocitadlo)
5440  99D4 EE 64        		xor 100
5441  99D6 28 07        		jr z,.s3
5442  99D8
5443  99D8
5444  99D8 3A E2 A1     		ld a,(music_setup)
5445  99DB CB 7F        		bit 7,a
5446  99DD 28 97        		JR z,LOOP
5447  99DF 3E 20        .s3		ld a,32
5448  99E1 21 A6 73     		ld hl,endsong
5449  99E4 77           		ld (hl),a
5450  99E5 F5           koneca	push af
5451  99E6
5452  99E6 CD 7E A1     		call music_mute
5453  99E9 F1           		pop af
5454  99EA C3 61 73     		jp navrat
5455  99ED
5456  99ED
5457  99ED              ACB
5458  99ED              		NEXTREG2A 08
5458  99ED 3E 08       >        ld     a,08
5458  99EF CD 12 60    >        call   ReadNextReg
5459  99F2 F6 20        		or #20
5460  99F4 ED 92 08     		nextreg 08,a
5461  99F7
5462  99F7 C9           		ret
5463  99F8              ABC
5464  99F8              		NEXTREG2A 08
5464  99F8 3E 08       >        ld     a,08
5464  99FA CD 12 60    >        call   ReadNextReg
5465  99FD E6 DF        		and 0xDF
5466  99FF ED 92 08     		nextreg 08,a
5467  9A02
5468  9A02 C9           		ret
5469  9A03
5470  9A03              setAY
5471  9A03              		NEXTREG2A 06
5471  9A03 3E 06       >        ld     a,06
5471  9A05 CD 12 60    >        call   ReadNextReg
5472  9A08 E6 FC        		and #FC
5473  9A0A F6 01        		or #1
5474  9A0C ED 92 06     		nextreg 06,a
5475  9A0F C9           		ret
5476  9A10
5477  9A10              setYM
5478  9A10              		NEXTREG2A 06
5478  9A10 3E 06       >        ld     a,06
5478  9A12 CD 12 60    >        call   ReadNextReg
5479  9A15 E6 FC        		and #FC
5480  9A17 ED 92 06     		nextreg 06,a
5481  9A1A C9           		ret
5482  9A1B
5483  9A1B              KLAVESA
5484  9A1B 00           klavesa defb 0
5485  9A1C              tona    equ 0
5486  9A1C              tonb    equ 2
5487  9A1C              tonc    equ 4
5488  9A1C              noise   equ 6
5489  9A1C              mixer   equ 7
5490  9A1C              ampla   equ 8
5491  9A1C              amplb   equ 9
5492  9A1C              amplc   equ 10
5493  9A1C              env     equ 11
5494  9A1C              envtp   equ 13
5495  9A1C
5496  9A1C              ;       struct  chp
5497  9A1C              ;reset group
5498  9A1C              chp_psinor      equ 0
5499  9A1C              chp_psinsm      equ 1
5500  9A1C              chp_cramsl      equ 2
5501  9A1C              chp_crnssl      equ 3
5502  9A1C              chp_crensl      equ 4
5503  9A1C              chp_tslcnt      equ 5
5504  9A1C              chp_crtnsl      equ 6
5505  9A1C              chp_tnacc       equ 8
5506  9A1C              chp_conoff      equ 10
5507  9A1C              ;reset group
5508  9A1C
5509  9A1C              chp_onoffd      equ 11
5510  9A1C
5511  9A1C              ;ix for ptdecod here (+12)
5512  9A1C              chp_offond      equ 12
5513  9A1C              chp_ornptr      equ 13
5514  9A1C              chp_samptr      equ 15
5515  9A1C              chp_nntskp      equ 17
5516  9A1C              chp_note        equ 18
5517  9A1C              chp_sltont      equ 19
5518  9A1C              chp_env_en      equ 20
5519  9A1C              chp_flags       equ 21
5520  9A1C               ;enabled - 0,simplegliss - 2
5521  9A1C              chp_tnsldl      equ 22
5522  9A1C              chp_tslstp      equ 23
5523  9A1C              chp_tndelt      equ 25
5524  9A1C              chp_ntskcn      equ 27
5525  9A1C              chp_volume      equ 28
5526  9A1C              ;       ends
5527  9A1C              chp     equ 29
5528  9A1C
5529  9A1C              ;entry and other points
5530  9A1C              ;start initialize playing of module at mdladdr
5531  9A1C              ;start+3 initialization with module address in hl
5532  9A1C              ;start+5 play one quark
5533  9A1C              ;start+8 mute
5534  9A1C              ;start+10 setup and status flags
5535  9A1C              ;start+11 current position value (byte) (optional)
5536  9A1C              ;first 12 values of tone tables (packed)
5537  9A1C
5538  9A1C
5539  9A1C 21 D4 B0     music_init:	ld	hl,MDLADDR
5540  9A1F E5           music_init0:	push	hl
5541  9A20 01 40 00     		ld	bc,#40			; look for "by" identifier
5542  9A23 09           		add	hl,bc
5543  9A24 7E           		ld	a,(hl)
5544  9A25 FE 79        		cp	'y'
5545  9A27 2B           		dec	hl
5546  9A28 7E           		ld	a,(hl)
5547  9A29 E1           		pop	hl
5548  9A2A 28 09        		jr	z,pt3fmt_init
5549  9A2C FE 62        		cp	'b'
5550  9A2E 28 05        		jr	z,pt3fmt_init
5551  9A30 7E           		ld	a,(hl)			; and first byte of PT2 is delay
5552  9A31 B9           		cp	c				; compared to PT3 text identifier
5553  9A32 DA A8 9A     		jp	c,pt2fmt_init
5554  9A35
5555  9A35 CD 11 9C     pt3fmt_init	call	setmodaddr
5556  9A38 E5           		push	hl
5557  9A39 11 64 00     		ld	de,100
5558  9A3C 19           		add	hl,de
5559  9A3D 7E           		ld	a,(hl)
5560  9A3E 32 E6 A0     		ld	(delay),a
5561  9A41 E5           		push	hl
5562  9A42 DD E1        		pop	ix
5563  9A44 19           		add	hl,de
5564  9A45 22 7C A0     		ld	(CrPsPtr+1),hl
5565  9A48 DD 5E 02     		ld	e,(ix+2)
5566  9A4B 19           		add	hl,de
5567  9A4C 23           		inc	hl
5568  9A4D 22 87 A0     		ld	(LPosPtr+1),hl
5569  9A50 D1           		pop	de
5570  9A51 DD 6E 03     		ld	l,(ix+3)
5571  9A54 DD 66 04     		ld	h,(ix+4)
5572  9A57 19           		add	hl,de
5573  9A58 22 96 A0     		ld	(PatsPtr+1),hl
5574  9A5B 21 A9 00     		ld	hl,#A9
5575  9A5E 19           		add	hl,de
5576  9A5F 22 8E 9E     		ld	(OrnPtrs+1),hl
5577  9A62 21 69 00     		ld	hl,#69
5578  9A65 19           		add	hl,de
5579  9A66 22 A4 9E     		ld	(SamPtrs+1),hl
5580  9A69
5581  9A69 DD 7E A9     		ld	a,(ix-87)		; extract version number
5582  9A6C D6 30        		sub	'0'
5583  9A6E 38 04        		jr	c,l20
5584  9A70 FE 0A        		cp	10
5585  9A72 38 02        		jr	c,l21
5586  9A74 3E 06        l20:		ld	a,6
5587  9A76 32 E4 9D     l21:		ld	(Version+1),a
5588  9A79 F5           		push	af
5589  9A7A FE 04        		cp	4
5590  9A7C DD 7E FF     		ld	a,(ix-1) ; tone table number
5591  9A7F 17           		rla
5592  9A80 E6 07        		and	7
5593  9A82 F5           		push	af
5594  9A83
5595  9A83 21 18 1F     		ld	hl,#18 + ((smp_-SamCnv-2) << 8)	; jr smp_
5596  9A86 22 29 9F     		ld	(SamCnv),hl
5597  9A89 3E BA        		ld	a,#BA				; cp d
5598  9A8B 32 F4 9E     		ld	(OrnCP),a
5599  9A8E 32 20 9F     		ld	(SamCP),a
5600  9A91 3E 7B        		ld	a,#7B				; ld a,e
5601  9A93 32 F7 9E     		ld	(OrnLD),a
5602  9A96 32 23 9F     		ld	(SamLD),a
5603  9A99 3E 87        		ld	a,#87				; add a,a
5604  9A9B 32 1A 9F     		ld	(SamClc2),a
5605  9A9E 21 00 00     		ld	hl,0
5606  9AA1 11 33 A2     		ld	de,PT3_EmptySmpOrn
5607  9AA4 3E 3F        		ld	a,pt3pattdc-ptdecode-2
5608  9AA6 18 62        		jr	ptx_initcommon
5609  9AA8
5610  9AA8 32 E6 A0     pt2fmt_init:	ld	(delay),a
5611  9AAB E5           		push	hl
5612  9AAC E5           		push	hl
5613  9AAD E5           		push	hl
5614  9AAE 23           		inc	hl
5615  9AAF 23           		inc	hl
5616  9AB0 7E           		ld	a,(hl)
5617  9AB1 23           		inc	hl
5618  9AB2 22 A4 9E     		ld	(SamPtrs+1),hl
5619  9AB5 5E           		ld	e,(hl)
5620  9AB6 23           		inc	hl
5621  9AB7 56           		ld	d,(hl)
5622  9AB8 E1           		pop	hl
5623  9AB9 A7           		and	a
5624  9ABA ED 52        		sbc	hl,de
5625  9ABC CD 11 9C     		call	setmodaddr
5626  9ABF E1           		pop	hl
5627  9AC0 11 43 00     		ld	de,67
5628  9AC3 19           		add	hl,de
5629  9AC4 22 8E 9E     		ld	(OrnPtrs+1),hl
5630  9AC7 1E 20        		ld	e,32
5631  9AC9 19           		add	hl,de
5632  9ACA 4E           		ld	c,(hl)
5633  9ACB 23           		inc	hl
5634  9ACC 46           		ld	b,(hl)
5635  9ACD 1E 1E        		ld	e,30
5636  9ACF 19           		add	hl,de
5637  9AD0 22 7C A0     		ld	(CrPsPtr+1),hl
5638  9AD3 5F           		ld	e,a
5639  9AD4 23           		inc	hl
5640  9AD5
5641  9AD5 19           		add	hl,de
5642  9AD6 22 87 A0     		ld	(LPosPtr+1),hl
5643  9AD9 E1           		pop	hl
5644  9ADA 09           		add	hl,bc
5645  9ADB 22 96 A0     		ld	(PatsPtr+1),hl
5646  9ADE 3E 05        		ld	a,5
5647  9AE0 32 E4 9D     		ld	(Version+1),a
5648  9AE3 F5           		push	af
5649  9AE4 3E 02        		ld	a,2
5650  9AE6 F5           		push	af
5651  9AE7 21 CB 51     		ld	hl,$51CB			; bit 2,c
5652  9AEA 22 29 9F     		ld	(SamCnv),hl
5653  9AED 3E BB        		ld	a,$BB				; cp e
5654  9AEF 32 F4 9E     		ld	(OrnCP),a
5655  9AF2 32 20 9F     		ld	(SamCP),a
5656  9AF5 3E 7A        		ld	a,$7A				; ld a,d
5657  9AF7 32 F7 9E     		ld	(OrnLD),a
5658  9AFA 32 23 9F     		ld	(SamLD),a
5659  9AFD 3E 80        		ld	a,$80				; add a,b
5660  9AFF 32 1A 9F     		ld	(SamClc2),a
5661  9B02 21 87 86     		ld	hl,$8687			; add a,a,(hl)
5662  9B05 11 E7 A2     		ld	de,PT2_EmptySmpOrn
5663  9B08 3E 87        		ld	a,pt2pattdc-ptdecode-2
5664  9B0A
5665  9B0A 22 8F A0     ptx_initcommon:	ld	(PsCalc),hl
5666  9B0D 32 F0 9C     		ld	(ptdecode+1),a
5667  9B10 D5           		push	de
5668  9B11
5669  9B11              ; note table data depacker
5670  9B11 11 36 A2     		ld	de,T_PACK
5671  9B14 01 39 A3     		ld	bc,T1_+(2*49)-1
5672  9B17 1A           tp_0:		ld	a,(de)
5673  9B18 13           		inc	de
5674  9B19 FE 1E        		cp	15*2
5675  9B1B 30 06        		jr	nc,tp_1
5676  9B1D 67           		ld	h,a
5677  9B1E 1A           		ld	a,(de)
5678  9B1F 6F           		ld	l,a
5679  9B20 13           		inc	de
5680  9B21 18 07        		jr	tp_2
5681  9B23 D5           tp_1:		push	de
5682  9B24 16 00        		ld	d,0
5683  9B26 5F           		ld	e,a
5684  9B27 19           		add	hl,de
5685  9B28 19           		add	hl,de
5686  9B29 D1           		pop	de
5687  9B2A 7C           tp_2:		ld	a,h
5688  9B2B 02           		ld	(bc),a
5689  9B2C 0B           		dec	bc
5690  9B2D 7D           		ld	a,l
5691  9B2E 02           		ld	(bc),a
5692  9B2F 0B           		dec	bc
5693  9B30 D6 F0        		sub	low (#F8*2)
5694  9B32 20 E3        		jr	nz,tp_0
5695  9B34
5696  9B34 32 EB 9F     		ld	(GlobalAttn+1),a
5697  9B37 32 A0 A1     		ld	(chkfadeout+1),a
5698  9B3A 21 E2 A1     		ld	hl,music_setup
5699  9B3D CB BE        		res	7,(hl)
5700  9B3F
5701  9B3F 21 6B A2     		ld	hl,VARS
5702  9B42 77           		ld	(hl),a
5703  9B43 11 6C A2     		ld	de,VARS+1
5704  9B46 01 6C 00     		ld	bc,VAR0END-VARS-1
5705  9B49 ED B0        		ldir
5706  9B4B 23           		inc	hl
5707  9B4C 22 71 A0     		ld	(AdInPtA+1),hl		; ptr to zero
5708  9B4F 3C           		inc	a
5709  9B50 32 C2 A2     		ld	(DelyCnt),a
5710  9B53 21 01 F0     		ld	hl,#F001	; H - CHP.Volume, L - CHP.NtSkCn
5711  9B56 22 86 A2     		ld	(ChanA+CHP.NtSkCn),hl
5712  9B59 22 A3 A2     		ld	(ChanB+CHP.NtSkCn),hl
5713  9B5C 22 C0 A2     		ld	(ChanC+CHP.NtSkCn),hl
5714  9B5F E1           		pop	hl
5715  9B60 22 78 A2     		ld	(ChanA+CHP.OrnPtr),hl	; ornament 0 is "0,1,0"
5716  9B63 22 95 A2     		ld	(ChanB+CHP.OrnPtr),hl	; in all versions from
5717  9B66 22 B2 A2     		ld	(ChanC+CHP.OrnPtr),hl	; 3.xx to 3.6x and VTII
5718  9B69 F1           		pop	af
5719  9B6A
5720  9B6A              ;NoteTableCreator (c) Ivan Roshin
5721  9B6A              ;A - NoteTableNumber*2+VersionForNoteTable
5722  9B6A              ;	xx1b - 3.xx..3.4r
5723  9B6A              ;	xx0b - 3.4x..3.6x - VortexTracker II
5724  9B6A
5725  9B6A 21 E3 A1     		ld	hl,nt_data
5726  9B6D D5           		push	de
5727  9B6E 50           		ld	d,b
5728  9B6F 87           		add	a,a
5729  9B70 5F           		ld	e,a
5730  9B71 19           		add	hl,de
5731  9B72 5E           		ld	e,(hl)
5732  9B73 23           		inc	hl
5733  9B74 CB 3B        		srl	e
5734  9B76 9F           		sbc	a,a
5735  9B77 E6 A7        		and	#A7	; #00 (NOP) or #A7 (AND A)
5736  9B79 32 9F 9B     		ld	(l3),a
5737  9B7C EB           		ex	de,hl
5738  9B7D C1           		pop	bc	; bc = T1_
5739  9B7E 09           		add	hl,bc
5740  9B7F 1A           		ld	a,(de)
5741  9B80 C6 F3        		add	a,low T_
5742  9B82 4F           		ld	c,a
5743  9B83 CE A1        		adc	a,high T_
5744  9B85 91           		sub	c
5745  9B86 47           		ld	b,a
5746  9B87 C5           		push	bc
5747  9B88 11 C8 A3     		ld	de,NT_
5748  9B8B D5           		push	de
5749  9B8C 06 0C        		ld	b,12
5750  9B8E C5           l1:		push	bc
5751  9B8F 4E           		ld	c,(hl)
5752  9B90 23           		inc	hl
5753  9B91 E5           		push	hl
5754  9B92 46           		ld	b,(hl)
5755  9B93 D5           		push	de
5756  9B94 EB           		ex	de,hl
5757  9B95 11 17 00     		ld	de,#17
5758  9B98 DD 26 08     		ld	xh,8
5759  9B9B CB 38        l2:		srl	b
5760  9B9D CB 19        		rr	c
5761  9B9F 19           l3:		add	hl,de	; will be replaced by AND A or NOP apparently
5762  9BA0 79           		ld	a,c
5763  9BA1 8A           		adc	a,d
5764  9BA2 77           		ld	(hl),a
5765  9BA3 23           		inc	hl
5766  9BA4 78           		ld	a,b
5767  9BA5 8A           		adc	a,d
5768  9BA6 77           		ld	(hl),a
5769  9BA7 19           		add	hl,de
5770  9BA8 DD 25        		dec	xh
5771  9BAA 20 EF        		jr	nz,l2
5772  9BAC
5773  9BAC D1           		pop	de
5774  9BAD 13           		inc	de
5775  9BAE 13           		inc	de
5776  9BAF E1           		pop	hl
5777  9BB0 23           		inc	hl
5778  9BB1 C1           		pop	bc
5779  9BB2 10 DA        		djnz	l1
5780  9BB4
5781  9BB4 E1           		pop	hl
5782  9BB5 D1           		pop	de
5783  9BB6 7B           		ld	a,e
5784  9BB7 FE FF        		cp	low TCOLD_1
5785  9BB9 20 05        		jr	nz,corr_1
5786  9BBB 3E FD        		ld	a,#FD
5787  9BBD 32 F6 A3     		ld	(NT_+#002E),a
5788  9BC0 1A           corr_1:		ld	a,(de)
5789  9BC1 A7           		and	a
5790  9BC2 28 11        		jr	z,tc_exit
5791  9BC4 1F           		rra
5792  9BC5 F5           		push	af
5793  9BC6 87           		add	a,a
5794  9BC7 4F           		ld	c,a
5795  9BC8 09           		add	hl,bc
5796  9BC9 F1           		pop	af
5797  9BCA 30 02        		jr	nc,corr_2
5798  9BCC 35           		dec	(hl)
5799  9BCD 35           		dec	(hl)
5800  9BCE 34           corr_2:		inc	(hl)
5801  9BCF A7           		and	a
5802  9BD0 ED 42        		sbc	hl,bc
5803  9BD2 13           		inc	de
5804  9BD3 18 EB        		jr	corr_1
5805  9BD5 F1           tc_exit:	pop	af
5806  9BD6
5807  9BD6              ; VolTableCreator (c) Ivan Roshin
5808  9BD6              ; A - VersionForVolumeTable
5809  9BD6              ;	(0..4 - v3.xx .. v3.4x
5810  9BD6              ;	(5..  - v2.x, v3.5x .. v3.6x (VT2) .. v3.7)
5811  9BD6
5812  9BD6 FE 05        		cp	5
5813  9BD8 21 11 00     		ld	hl,17
5814  9BDB 54           		ld	d,h
5815  9BDC 5C           		ld	e,h
5816  9BDD 3E 17        		ld	a,#17
5817  9BDF 30 03        		jr	nc,m1
5818  9BE1 2D           		dec	l
5819  9BE2 5D           		ld	e,l
5820  9BE3 AF           		xor	a
5821  9BE4 32 F3 9B     m1:		ld	(m2),a
5822  9BE7 DD 21 D8 A2  		ld	ix,VT_+16
5823  9BEB 0E 10        		ld	c,16
5824  9BED E5           initloop2:	push	hl
5825  9BEE 19           		add	hl,de
5826  9BEF EB           		ex	de,hl
5827  9BF0 ED 62        		sbc	hl,hl
5828  9BF2 7D           initloop1:	ld	a,l
5829  9BF3 7D           m2:		ld	a,l
5830  9BF4 7C           		ld	a,h
5831  9BF5 CE 00        		adc	a,0
5832  9BF7 DD 77 00     		ld	(ix+0),a
5833  9BFA DD 23        		inc	ix
5834  9BFC 19           		add	hl,de
5835  9BFD 0C           		inc	c
5836  9BFE 79           		ld	a,c
5837  9BFF E6 0F        		and	15
5838  9C01 20 EF        		jr	nz,initloop1
5839  9C03 E1           		pop	hl
5840  9C04 7B           		ld	a,e
5841  9C05 FE 77        		cp	#77
5842  9C07 20 01        		jr	nz,m3
5843  9C09 1C           		inc	e
5844  9C0A 79           m3:		ld	a,c
5845  9C0B A7           		and	a
5846  9C0C 20 DF        		jr	nz,initloop2
5847  9C0E C3 4C A1     		jp	rout_a0
5848  9C11
5849  9C11 22 9A A0     setmodaddr:	ld	(modaddr+1),hl
5850  9C14 22 AB 9E     		ld	(mdaddr1+1),hl
5851  9C17 22 95 9E     		ld	(mdaddr2+1),hl
5852  9C1A C9           		ret
5853  9C1B
5854  9C1B              ; PT2 pattern decoder ---------------------------------------------------------
5855  9C1B CD 9F 9E     pd2_sam		call	setsam
5856  9C1E 18 5A        		jr	pd2_loop
5857  9C20
5858  9C20 DD 77 08     pd2_eoff	ld	(ix-12+CHP.Env_En),a
5859  9C23 18 55        		jr	pd2_loop
5860  9C25
5861  9C25 DD 36 08 10  pd2_env		ld	(ix-12+CHP.Env_En),16
5862  9C29 32 D5 A2     		ld	(AYREGS+AR_EnvTp),a
5863  9C2C 0A           		ld	a,(bc)
5864  9C2D 03           		inc	bc
5865  9C2E 6F           		ld	l,a
5866  9C2F 0A           		ld	a,(bc)
5867  9C30 03           		inc	bc
5868  9C31 67           		ld	h,a
5869  9C32 22 D6 A2     		ld	(EnvBase),hl
5870  9C35 18 43        		jr	pd2_loop
5871  9C37
5872  9C37 CD 86 9E     pd2_orn		call	setorn
5873  9C3A 18 3E        		jr	pd2_loop
5874  9C3C
5875  9C3C 3C           pd2_skip	inc	a
5876  9C3D DD 77 05     		ld	(ix-12+CHP.NNtSkp),a
5877  9C40 18 38        		jr	pd2_loop
5878  9C42
5879  9C42 0F           pd2_vol		rrca
5880  9C43 0F           		rrca
5881  9C44 0F           		rrca
5882  9C45 0F           		rrca
5883  9C46 DD 77 10     		ld	(ix-12+CHP.Volume),a
5884  9C49 18 2F        		jr	pd2_loop
5885  9C4B
5886  9C4B CD 61 9E     pd2_del		call	c_delay
5887  9C4E 18 2A        		jr	pd2_loop
5888  9C50
5889  9C50 DD CB 09 D6  pd2_glis	set	2,(ix-12+CHP.Flags)
5890  9C54 3C           		inc	a
5891  9C55 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
5892  9C58 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
5893  9C5B 0A           		ld	a,(bc)
5894  9C5C 03           		inc	bc
5895  9C5D DD 77 0B     		ld	(ix-12+CHP.TSlStp),a
5896  9C60 87           		add	a,a
5897  9C61 9F           		sbc	a,a
5898  9C62 DD 77 0C     		ld	(ix-12+CHP.TSlStp+1),a
5899  9C65 37           		scf
5900  9C66 18 11        		jr	pd2_loop2
5901  9C68
5902  9C68 DD CB 09 96  pd2_port:	res	2,(ix-12+CHP.Flags)
5903  9C6C 0A           		ld	a,(bc)
5904  9C6D 03           		inc	bc
5905  9C6E 03           		inc	bc		; ignoring precalc delta to right sound
5906  9C6F 03           		inc	bc
5907  9C70 37           		scf
5908  9C71 18 06        		jr	pd2_loop2
5909  9C73
5910  9C73 DD 77 F9     pd2_stop:	ld	(ix-12+CHP.TSlCnt),a
5911  9C76 18 02        		jr	pd2_loop
5912  9C78
5913  9C78 A7           pt2pattdc:	and	a
5914  9C79 08           pd2_loop2:	ex	af,af'
5915  9C7A 0A           pd2_loop:	ld	a,(bc)
5916  9C7B 03           		inc	bc
5917  9C7C C6 20        		add	a,$20
5918  9C7E 28 2F        		jr	z,pd2_rel
5919  9C80 38 99        		jr	c,pd2_sam
5920  9C82 C6 60        		add	a,96
5921  9C84 38 2E        		jr	c,pd2_note
5922  9C86 3C           		inc	a
5923  9C87 28 97        		jr	z,pd2_eoff
5924  9C89 C6 0F        		add	a,15
5925  9C8B CA 93 9D     		jp	z,pd_fin
5926  9C8E 38 95        		jr	c,pd2_env
5927  9C90 C6 10        		add	a,$10
5928  9C92 38 A3        		jr	c,pd2_orn
5929  9C94 C6 40        		add	a,$40
5930  9C96 38 A4        		jr	c,pd2_skip
5931  9C98 C6 10        		add	a,$10
5932  9C9A 38 A6        		jr	c,pd2_vol
5933  9C9C 3C           		inc	a
5934  9C9D 28 AC        		jr	z,pd2_del
5935  9C9F 3C           		inc	a
5936  9CA0 28 AE        		jr	z,pd2_glis
5937  9CA2 3C           		inc	a
5938  9CA3 28 C3        		jr	z,pd2_port
5939  9CA5 3C           		inc	a
5940  9CA6 28 CB        		jr	z,pd2_stop
5941  9CA8 0A           		ld	a,(bc)
5942  9CA9 03           		inc	bc
5943  9CAA DD 77 F7     		ld	(ix-12+CHP.CrNsSl),a
5944  9CAD 18 CB        		jr	pd2_loop
5945  9CAF
5946  9CAF DD 77 09     pd2_rel:	ld	(ix-12+CHP.Flags),a
5947  9CB2 18 2C        		jr	pd2_exit
5948  9CB4
5949  9CB4 6F           pd2_note:	ld	l,a
5950  9CB5 DD 7E 06     		ld	a,(ix-12+CHP.Note)
5951  9CB8 32 CD 9D     		ld	(PrNote+1),a
5952  9CBB DD 75 06     		ld	(ix-12+CHP.Note),l
5953  9CBE AF           		xor	a
5954  9CBF DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
5955  9CC2 DD CB 09 C6  		set	0,(ix-12+CHP.Flags)
5956  9CC6 08           		ex	af,af'
5957  9CC7 30 16        		jr	nc,pd2_noglis
5958  9CC9 DD CB 09 56  		bit	2,(ix-12+CHP.Flags)
5959  9CCD 20 0C        		jr	nz,pd2_noport
5960  9CCF 32 F3 9D     		ld	(LoStep+1),a
5961  9CD2 87           		add	a,a
5962  9CD3 9F           		sbc	a,a
5963  9CD4 08           		ex	af,af'
5964  9CD5 67           		ld	h,a
5965  9CD6 6F           		ld	l,a
5966  9CD7 3C           		inc	a
5967  9CD8 CD AE 9D     		call	setport
5968  9CDB DD 36 F9 01  pd2_noport:	ld	(ix-12+CHP.TSlCnt),1
5969  9CDF AF           pd2_noglis:	xor	a
5970  9CE0
5971  9CE0 DD 77 F5     pd2_exit:	ld	(ix-12+CHP.PsInSm),a
5972  9CE3 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
5973  9CE6 DD 77 FA     		ld	(ix-12+CHP.CrTnSl),a
5974  9CE9 DD 77 FB     		ld	(ix-12+CHP.CrTnSl+1),a
5975  9CEC C3 93 9D     		jp	pd_fin
5976  9CEF
5977  9CEF
5978  9CEF 18 3F        ptdecode:	jr	pt3pattdc		; patter decoder fork
5979  9CF1
5980  9CF1              ; PT3 pattern decoder ---------------------------------------------------------
5981  9CF1 DD 36 08 00  PD_OrSm:	ld	(ix-12+CHP.Env_En),0
5982  9CF5 CD 86 9E     		call	setorn
5983  9CF8 0A           pd_sam_:	ld	a,(bc)
5984  9CF9 03           		inc	bc
5985  9CFA 0F           		rrca
5986  9CFB CD 9F 9E     pd_sam:		call	setsam
5987  9CFE 18 3F        		jr	pd_loop
5988  9D00
5989  9D00 0F           pd_vol:		rrca
5990  9D01 0F           		rrca
5991  9D02 0F           		rrca
5992  9D03 0F           		rrca
5993  9D04 DD 77 10     		ld	(ix-12+CHP.Volume),a
5994  9D07 18 39        		jr	pd_lp2
5995  9D09
5996  9D09 DD 77 08     pd_eoff:	ld	(ix-12+CHP.Env_En),a
5997  9D0C DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
5998  9D0F 18 31        		jr	pd_lp2
5999  9D11
6000  9D11 3D           pd_SorE:	dec	a
6001  9D12 20 07        		jr	nz,pd_env
6002  9D14 0A           		ld	a,(bc)
6003  9D15 03           		inc	bc
6004  9D16 DD 77 05     		ld	(ix-12+CHP.NNtSkp),a
6005  9D19 18 27        		jr	pd_lp2
6006  9D1B
6007  9D1B CD 6A 9E     pd_env:		call	setenv
6008  9D1E 18 22        		jr	pd_lp2
6009  9D20
6010  9D20 CD 86 9E     pd_orn:		call	setorn
6011  9D23 18 1A        		jr	pd_loop
6012  9D25
6013  9D25 DD 77 08     pd_esam:	ld	(ix-12+CHP.Env_En),a
6014  9D28 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
6015  9D2B C4 6A 9E     		call	nz,setenv
6016  9D2E 18 C8        		jr	pd_sam_
6017  9D30
6018  9D30 DD 7E 06     pt3pattdc:	ld	a,(ix-12+CHP.Note)
6019  9D33 32 CD 9D     		ld	(PrNote+1),a
6020  9D36 DD 6E FA     		ld	l,(ix-12+CHP.CrTnSl)
6021  9D39 DD 66 FB     		ld	h,(ix-12+CHP.CrTnSl+1)
6022  9D3C 22 EA 9D     		ld	(PrSlide+1),hl
6023  9D3F
6024  9D3F 11 10 20     pd_loop:	ld	de,#2010
6025  9D42 0A           pd_lp2:		ld	a,(bc)
6026  9D43 03           		inc	bc
6027  9D44 83           		add	a,e
6028  9D45 38 AA        		jr	c,PD_OrSm
6029  9D47 82           		add	a,d
6030  9D48 28 49        		jr	z,pd_fin
6031  9D4A 38 AF        		jr	c,pd_sam
6032  9D4C 83           		add	a,e
6033  9D4D 28 25        		jr	z,pd_rel
6034  9D4F 38 AF        		jr	c,pd_vol
6035  9D51 83           		add	a,e
6036  9D52 28 B5        		jr	z,pd_eoff
6037  9D54 38 BB        		jr	c,pd_SorE
6038  9D56 C6 60        		add	a,#60
6039  9D58 38 20        		jr	c,pd_note
6040  9D5A 83           		add	a,e
6041  9D5B 38 C3        		jr	c,pd_orn
6042  9D5D 82           		add	a,d
6043  9D5E 38 0F        		jr	c,pd_nois
6044  9D60 83           		add	a,e
6045  9D61 38 C2        		jr	c,pd_esam
6046  9D63 87           		add	a,a
6047  9D64 5F           		ld	e,a
6048  9D65 21 D5 7D     		ld	hl,spccoms-#20E0
6049  9D68 19           		add	hl,de
6050  9D69 5E           		ld	e,(hl)
6051  9D6A 23           		inc	hl
6052  9D6B 56           		ld	d,(hl)
6053  9D6C D5           		push	de
6054  9D6D 18 D0        		jr	pd_loop
6055  9D6F
6056  9D6F 32 C6 A2     pd_nois:	ld	(Ns_base),a
6057  9D72 18 CE        		jr	pd_lp2
6058  9D74
6059  9D74 DD CB 09 86  pd_rel:		res	0,(ix-12+CHP.Flags)
6060  9D78 18 08        		jr	pd_res
6061  9D7A
6062  9D7A DD 77 06     pd_note:	ld	(ix-12+CHP.Note),a
6063  9D7D DD CB 09 C6  		set	0,(ix-12+CHP.Flags)
6064  9D81 AF           		xor	a
6065  9D82 ED 73 91 9D  pd_res:		ld	(pdsp_+1),sp
6066  9D86 DD F9        		ld	sp,ix
6067  9D88 67           		ld	h,a
6068  9D89 6F           		ld	l,a
6069  9D8A E5           		push	hl
6070  9D8B E5           		push	hl
6071  9D8C E5           		push	hl
6072  9D8D E5           		push	hl
6073  9D8E E5           		push	hl
6074  9D8F E5           		push	hl
6075  9D90 31 31 31     pdsp_:		ld	sp,#3131
6076  9D93 DD 7E 05     pd_fin:		ld	a,(ix-12+CHP.NNtSkp)
6077  9D96 DD 77 0F     		ld	(ix-12+CHP.NtSkCn),a
6078  9D99 C9           		ret
6079  9D9A
6080  9D9A 0A           c_portm:	ld	a,(bc)
6081  9D9B 03           		inc	bc
6082  9D9C 03           		inc	bc	; skip precalculated tone delta
6083  9D9D 03           		inc	bc	; (because cannot be right after pt3 compilation)
6084  9D9E 08           		ex	af,af'
6085  9D9F 0A           		ld	a,(bc)	; signed tone step
6086  9DA0 03           		inc	bc
6087  9DA1 32 F3 9D     		ld	(LoStep+1),a
6088  9DA4 0A           		ld	a,(bc)
6089  9DA5 03           		inc	bc
6090  9DA6 A7           		and	a
6091  9DA7 08           		ex	af,af'
6092  9DA8 DD 6E FA     		ld	l,(ix-12+CHP.CrTnSl)
6093  9DAB DD 66 FB     		ld	h,(ix-12+CHP.CrTnSl+1)
6094  9DAE
6095  9DAE              ; Set portamento variables
6096  9DAE              ; A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
6097  9DAE DD CB 09 96  setport		res	2,(ix-12+CHP.Flags)
6098  9DB2 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
6099  9DB5 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
6100  9DB8 E5           		push	hl
6101  9DB9 11 C8 A3     		ld	de,NT_
6102  9DBC DD 7E 06     		ld	a,(ix-12+CHP.Note)
6103  9DBF DD 77 07     		ld	(ix-12+CHP.SlToNt),a
6104  9DC2 87           		add	a,a
6105  9DC3 6F           		ld	l,a
6106  9DC4 26 00        		ld	h,0
6107  9DC6 19           		add	hl,de
6108  9DC7 7E           		ld	a,(hl)
6109  9DC8 23           		inc	hl
6110  9DC9 66           		ld	h,(hl)
6111  9DCA 6F           		ld	l,a
6112  9DCB E5           		push	hl
6113  9DCC 3E 3E        PrNote:		ld	a,#3E
6114  9DCE DD 77 06     		ld	(ix-12+CHP.Note),a
6115  9DD1 87           		add	a,a
6116  9DD2 6F           		ld	l,a
6117  9DD3 26 00        		ld	h,0
6118  9DD5 19           		add	hl,de
6119  9DD6 5E           		ld	e,(hl)
6120  9DD7 23           		inc	hl
6121  9DD8 56           		ld	d,(hl)
6122  9DD9 E1           		pop	hl
6123  9DDA ED 52        		sbc	hl,de
6124  9DDC DD 75 0D     		ld	(ix-12+CHP.TnDelt),l
6125  9DDF DD 74 0E     		ld	(ix-12+CHP.TnDelt+1),h
6126  9DE2 D1           		pop	de
6127  9DE3 3E 3E        Version:	ld	a,#3E
6128  9DE5 FE 06        		cp	6
6129  9DE7 38 09        		jr	c,LoStep	; old 3xxx for PT v3.5-
6130  9DE9 11 11 11     PrSlide:	ld	de,#1111
6131  9DEC DD 73 FA     		ld	(ix-12+CHP.CrTnSl),e
6132  9DEF DD 72 FB     		ld	(ix-12+CHP.CrTnSl+1),d
6133  9DF2 3E 00        LoStep:		ld	a,0		; signed tone step
6134  9DF4 08           		ex	af,af'
6135  9DF5 28 01        		jr	z,nosig
6136  9DF7 EB           		ex	de,hl
6137  9DF8 ED 52        nosig:		sbc	hl,de
6138  9DFA F2 02 9E     		jp	p,set_stp
6139  9DFD 2F           		cpl
6140  9DFE 08           		ex	af,af'
6141  9DFF ED 44        		neg
6142  9E01 08           		ex	af,af'
6143  9E02 DD 77 0C     set_stp:	ld	(ix-12+CHP.TSlStp+1),a
6144  9E05 08           		ex	af,af'
6145  9E06 DD 77 0B     		ld	(ix-12+CHP.TSlStp),a
6146  9E09 DD 36 FE 00  		ld	(ix-12+CHP.COnOff),0
6147  9E0D C9           		ret
6148  9E0E
6149  9E0E DD CB 09 D6  c_gliss:	set	2,(ix-12+CHP.Flags)
6150  9E12 0A           		ld	a,(bc)
6151  9E13 03           		inc	bc
6152  9E14 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
6153  9E17 A7           		and	a
6154  9E18 20 07        		jr	nz,gl36
6155  9E1A 3A E4 9D     		ld	a,(Version+1) ;AlCo PT3.7+
6156  9E1D FE 07        		cp	7
6157  9E1F 9F           		sbc	a,a
6158  9E20 3C           		inc	a
6159  9E21 DD 77 F9     gl36:		ld	(ix-12+CHP.TSlCnt),a
6160  9E24 0A           		ld	a,(bc)
6161  9E25 03           		inc	bc
6162  9E26 08           		ex	af,af'
6163  9E27 0A           		ld	a,(bc)
6164  9E28 03           		inc	bc
6165  9E29 18 D7        		jr	set_stp
6166  9E2B
6167  9E2B 0A           c_smpos:	ld	a,(bc)
6168  9E2C 03           		inc	bc
6169  9E2D DD 77 F5     		ld	(ix-12+CHP.PsInSm),a
6170  9E30 C9           		ret
6171  9E31
6172  9E31 0A           c_orpos:	ld	a,(bc)
6173  9E32 03           		inc	bc
6174  9E33 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
6175  9E36 C9           		ret
6176  9E37
6177  9E37 0A           c_vibrt:	ld	a,(bc)
6178  9E38 03           		inc	bc
6179  9E39 DD 77 FF     		ld	(ix-12+CHP.OnOffD),a
6180  9E3C DD 77 FE     		ld	(ix-12+CHP.COnOff),a
6181  9E3F 0A           		ld	a,(bc)
6182  9E40 03           		inc	bc
6183  9E41 DD 77 00     		ld	(ix-12+CHP.OffOnD),a
6184  9E44 AF           		xor	a
6185  9E45 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
6186  9E48 DD 77 FA     		ld	(ix-12+CHP.CrTnSl),a
6187  9E4B DD 77 FB     		ld	(ix-12+CHP.CrTnSl+1),a
6188  9E4E C9           		ret
6189  9E4F
6190  9E4F 0A           c_engls:	ld	a,(bc)
6191  9E50 03           		inc	bc
6192  9E51 32 42 A1     		ld	(Env_Del+1),a
6193  9E54 32 C5 A2     		ld	(CurEDel),a
6194  9E57 0A           		ld	a,(bc)
6195  9E58 03           		inc	bc
6196  9E59 6F           		ld	l,a
6197  9E5A 0A           		ld	a,(bc)
6198  9E5B 03           		inc	bc
6199  9E5C 67           		ld	h,a
6200  9E5D 22 45 A1     		ld	(ESldAdd+1),hl
6201  9E60 C9           		ret
6202  9E61
6203  9E61 0A           c_delay:	ld	a,(bc)
6204  9E62 03           		inc	bc
6205  9E63 32 E6 A0     		ld	(delay),a
6206  9E66 32 C2 A2     		ld	(DelyCnt),a ; bugfix by Lee_dC
6207  9E69 C9           		ret
6208  9E6A
6209  9E6A DD 73 08     setenv:		ld	(ix-12+CHP.Env_En),e
6210  9E6D 32 D5 A2     		ld	(AYREGS+AR_EnvTp),a
6211  9E70 0A           		ld	a,(bc)
6212  9E71 03           		inc	bc
6213  9E72 67           		ld	h,a
6214  9E73 0A           		ld	a,(bc)
6215  9E74 03           		inc	bc
6216  9E75 6F           		ld	l,a
6217  9E76 22 D6 A2     		ld	(EnvBase),hl
6218  9E79 AF           		xor	a
6219  9E7A DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
6220  9E7D 32 C5 A2     		ld	(CurEDel),a
6221  9E80 67           		ld	h,a
6222  9E81 6F           		ld	l,a
6223  9E82 22 C3 A2     		ld	(CurESld),hl
6224  9E85 C9           c_nop:		ret
6225  9E86
6226  9E86 87           setorn:		add	a,a
6227  9E87 5F           		ld	e,a
6228  9E88 16 00        		ld	d,0
6229  9E8A DD 72 F4     		ld	(ix-12+CHP.PsInOr),d
6230  9E8D 21 21 21     OrnPtrs:	ld	hl,#2121
6231  9E90 19           		add	hl,de
6232  9E91 5E           		ld	e,(hl)
6233  9E92 23           		inc	hl
6234  9E93 56           		ld	d,(hl)
6235  9E94 21 21 21     mdaddr2:	ld	hl,#2121
6236  9E97 19           		add	hl,de
6237  9E98 DD 75 01     		ld	(ix-12+CHP.OrnPtr),l
6238  9E9B DD 74 02     		ld	(ix-12+CHP.OrnPtr+1),h
6239  9E9E C9           		ret
6240  9E9F
6241  9E9F 87           setsam:		add	a,a
6242  9EA0 5F           		ld	e,a
6243  9EA1 16 00        		ld	d,0
6244  9EA3 21 21 21     SamPtrs:	ld	hl,#2121
6245  9EA6 19           		add	hl,de
6246  9EA7 5E           		ld	e,(hl)
6247  9EA8 23           		inc	hl
6248  9EA9 56           		ld	d,(hl)
6249  9EAA 21 21 21     mdaddr1:	ld	hl,#2121
6250  9EAD 19           		add	hl,de
6251  9EAE DD 75 03     		ld	(ix-12+CHP.SamPtr),l
6252  9EB1 DD 74 04     		ld	(ix-12+CHP.SamPtr+1),h
6253  9EB4 C9           		ret
6254  9EB5
6255  9EB5              ; all 16 addresses filled to protect from broken pt3 modules
6256  9EB5 85 9E        spccoms:	dw	c_nop
6257  9EB7 0E 9E        		dw	c_gliss
6258  9EB9 9A 9D        		dw	c_portm
6259  9EBB 2B 9E        		dw	c_smpos
6260  9EBD 31 9E        		dw	c_orpos
6261  9EBF 37 9E        		dw	c_vibrt
6262  9EC1 85 9E        		dw	c_nop
6263  9EC3 85 9E        		dw	c_nop
6264  9EC5 4F 9E        		dw	c_engls
6265  9EC7 61 9E        		dw	c_delay
6266  9EC9 85 9E        		dw	c_nop
6267  9ECB 85 9E        		dw	c_nop
6268  9ECD 85 9E        		dw	c_nop
6269  9ECF 85 9E        		dw	c_nop
6270  9ED1 85 9E        		dw	c_nop
6271  9ED3 85 9E        		dw	c_nop
6272  9ED5
6273  9ED5 AF           chregs:		xor	a
6274  9ED6 32 D2 A2     		ld	(Ampl),a
6275  9ED9 DD CB 15 46  		bit	0,(ix+CHP.Flags)
6276  9EDD E5           		push	hl
6277  9EDE CA 32 A0     		jp	z,ch_exit
6278  9EE1 ED 73 6F 9F  		ld	(csp_+1),sp
6279  9EE5 DD 6E 0D     		ld	l,(ix+CHP.OrnPtr)
6280  9EE8 DD 66 0E     		ld	h,(ix+CHP.OrnPtr+1)
6281  9EEB F9           		ld	sp,hl
6282  9EEC D1           		pop	de
6283  9EED 67           		ld	h,a
6284  9EEE DD 7E 00     		ld	a,(ix+CHP.PsInOr)
6285  9EF1 6F           		ld	l,a
6286  9EF2 39           		add	hl,sp
6287  9EF3 3C           		inc	a			; PT2	| PT3
6288  9EF4 BA           OrnCP:		cp	d			; cp e	| cp d
6289  9EF5 38 01        		jr	c,ch_orps
6290  9EF7 7B           OrnLD:		ld	a,e			; a,d	| a,e
6291  9EF8 DD 77 00     ch_orps:	ld	(ix+CHP.PsInOr),a
6292  9EFB DD 7E 12     		ld	a,(ix+CHP.Note)
6293  9EFE 86           		add	a,(hl)
6294  9EFF F2 03 9F     		jp	p,ch_ntp
6295  9F02 AF           		xor	a
6296  9F03 FE 60        ch_ntp:		cp	96
6297  9F05 38 02        		jr	c,ch_nok
6298  9F07 3E 5F        		ld	a,95
6299  9F09 87           ch_nok:		add	a,a
6300  9F0A 08           		ex	af,af'
6301  9F0B DD 6E 0F     		ld	l,(ix+CHP.SamPtr)
6302  9F0E DD 66 10     		ld	h,(ix+CHP.SamPtr+1)
6303  9F11 F9           		ld	sp,hl
6304  9F12 D1           		pop	de
6305  9F13 26 00        		ld	h,0
6306  9F15 DD 7E 01     		ld	a,(ix+CHP.PsInSm)
6307  9F18 47           		ld	b,a
6308  9F19 87           		add	a,a			; PT2	| PT3
6309  9F1A 87           SamClc2:	add	a,a			; a,b	| a,a
6310  9F1B 6F           		ld	l,a
6311  9F1C 39           		add	hl,sp
6312  9F1D F9           		ld	sp,hl
6313  9F1E 78           		ld	a,b
6314  9F1F 3C           		inc	a
6315  9F20 BA           SamCP:		cp	d			; cp e	| cp d
6316  9F21 38 01        		jr	c,ch_smps
6317  9F23 7B           SamLD:		ld	a,e			; a,d	| a,e
6318  9F24 DD 77 01     ch_smps:	ld	(ix+CHP.PsInSm),a
6319  9F27 C1           		pop	bc
6320  9F28 E1           		pop	hl
6321  9F29              						; PT2     | PT3
6322  9F29 18 1F        SamCnv:		jr	smp_			; bit 2,c | jr smp_
6323  9F2B
6324  9F2B 60           		ld	h,b			; Convert PT2 sample to PT3
6325  9F2C 20 06        		jr	nz,SamCnv1
6326  9F2E EB           		ex	de,hl
6327  9F2F A7           		and	a
6328  9F30 ED 62        		sbc	hl,hl
6329  9F32 ED 52        		sbc	hl,de
6330  9F34 51           SamCnv1:	ld	d,c
6331  9F35 CB 19        		rr	c
6332  9F37 9F           		sbc	a,a
6333  9F38 2F           		cpl
6334  9F39 E6 3E        		and	#3E
6335  9F3B CB 19        		rr	c
6336  9F3D CB 18        		rr	b
6337  9F3F A1           		and	c
6338  9F40 4F           		ld	c,a
6339  9F41 78           		ld	a,b
6340  9F42 1F           		rra
6341  9F43 1F           		rra
6342  9F44 CB 1A        		rr	d
6343  9F46 1F           		rra
6344  9F47 E6 9F        		and	#9F
6345  9F49 47           		ld	b,a
6346  9F4A
6347  9F4A DD 5E 08     smp_:		ld	e,(ix+CHP.TnAcc)
6348  9F4D DD 56 09     		ld	d,(ix+CHP.TnAcc+1)
6349  9F50 19           		add	hl,de
6350  9F51 CB 70        		bit	6,b
6351  9F53 28 06        		jr	z,ch_noac
6352  9F55 DD 75 08     		ld	(ix+CHP.TnAcc),l
6353  9F58 DD 74 09     		ld	(ix+CHP.TnAcc+1),h
6354  9F5B EB           ch_noac:	ex	de,hl
6355  9F5C 08           		ex	af,af'
6356  9F5D 6F           		ld	l,a
6357  9F5E 26 00        		ld	h,0
6358  9F60 31 C8 A3     		ld	sp,NT_
6359  9F63 39           		add	hl,sp
6360  9F64 F9           		ld	sp,hl
6361  9F65 E1           		pop	hl
6362  9F66 19           		add	hl,de
6363  9F67 DD 5E 06     		ld	e,(ix+CHP.CrTnSl)
6364  9F6A DD 56 07     		ld	d,(ix+CHP.CrTnSl+1)
6365  9F6D 19           		add	hl,de
6366  9F6E 31 31 31     csp_:		ld	sp,#3131
6367  9F71 E3           		ex	(sp),hl
6368  9F72 AF           		xor	a
6369  9F73 DD B6 05     		or	(ix+CHP.TSlCnt)
6370  9F76 28 3E        		jr	z,ch_amp
6371  9F78 DD 35 05     		dec	(ix+CHP.TSlCnt)
6372  9F7B 20 39        		jr	nz,ch_amp
6373  9F7D DD 7E 16     		ld	a,(ix+CHP.TnSlDl)
6374  9F80 DD 77 05     		ld	(ix+CHP.TSlCnt),a
6375  9F83 DD 6E 17     		ld	l,(ix+CHP.TSlStp)
6376  9F86 DD 66 18     		ld	h,(ix+CHP.TSlStp+1)
6377  9F89 7C           		ld	a,h
6378  9F8A 19           		add	hl,de
6379  9F8B DD 75 06     		ld	(ix+CHP.CrTnSl),l
6380  9F8E DD 74 07     		ld	(ix+CHP.CrTnSl+1),h
6381  9F91 DD CB 15 56  		bit	2,(ix+CHP.Flags)
6382  9F95 20 1F        		jr	nz,ch_amp
6383  9F97 DD 5E 19     		ld	e,(ix+CHP.TnDelt)
6384  9F9A DD 56 1A     		ld	d,(ix+CHP.TnDelt+1)
6385  9F9D A7           		and	a
6386  9F9E 28 01        		jr	z,ch_stpp
6387  9FA0 EB           		ex	de,hl
6388  9FA1 ED 52        ch_stpp:	sbc	hl,de
6389  9FA3 FA B6 9F     		jp	m,ch_amp
6390  9FA6 DD 7E 13     		ld	a,(ix+CHP.SlToNt)
6391  9FA9 DD 77 12     		ld	(ix+CHP.Note),a
6392  9FAC AF           		xor	a
6393  9FAD DD 77 05     		ld	(ix+CHP.TSlCnt),a
6394  9FB0 DD 77 06     		ld	(ix+CHP.CrTnSl),a
6395  9FB3 DD 77 07     		ld	(ix+CHP.CrTnSl+1),a
6396  9FB6 DD 7E 02     ch_amp:		ld	a,(ix+CHP.CrAmSl)
6397  9FB9 CB 79        		bit	7,c
6398  9FBB 28 13        		jr	z,ch_noam
6399  9FBD CB 71        		bit	6,c
6400  9FBF 28 07        		jr	z,ch_amin
6401  9FC1 FE 0F        		cp	15
6402  9FC3 28 0B        		jr	z,ch_noam
6403  9FC5 3C           		inc	a
6404  9FC6 18 05        		jr	ch_svam
6405  9FC8 FE F1        ch_amin:	cp	-15
6406  9FCA 28 04        		jr	z,ch_noam
6407  9FCC 3D           		dec	a
6408  9FCD DD 77 02     ch_svam:	ld	(ix+CHP.CrAmSl),a
6409  9FD0 6F           ch_noam:	ld	l,a
6410  9FD1 78           		ld	a,b
6411  9FD2 E6 0F        		and	15
6412  9FD4 85           		add	a,l
6413  9FD5 F2 D9 9F     		jp	p,ch_apos
6414  9FD8 AF           		xor	a
6415  9FD9 FE 10        ch_apos:	cp	16
6416  9FDB 38 02        		jr	c,ch_vol
6417  9FDD 3E 0F        		ld	a,15
6418  9FDF DD B6 1C     ch_vol:		or	(ix+CHP.Volume)
6419  9FE2 6F           		ld	l,a
6420  9FE3 26 00        		ld	h,0
6421  9FE5 11 C8 A2     		ld	de,VT_
6422  9FE8 19           		add	hl,de
6423  9FE9 5E           		ld	e,(hl)
6424  9FEA 3E 00        GlobalAttn:	ld	a,0		; GLOBAL ATTENUATION
6425  9FEC FE 08        		cp	8		; if value of attenuation is higher
6426  9FEE 38 02        		jr	c,ch_globvol	; then this value we will stop
6427  9FF0 CB C1        		set	0,c		; also envelopes (bit.0 in flags)...
6428  9FF2 93           ch_globvol:	sub	e
6429  9FF3 38 01        		jr	c,ch_env
6430  9FF5 AF           		xor	a
6431  9FF6 ED 44        ch_env:		neg
6432  9FF8 CB 41        		bit	0,c
6433  9FFA 20 03        		jr	nz,ch_noen
6434  9FFC DD B6 14     		or	(ix+CHP.Env_En)
6435  9FFF 32 D2 A2     ch_noen:	ld	(Ampl),a
6436  A002 CB 78        		bit	7,b
6437  A004 79           		ld	a,c
6438  A005 28 19        		jr	z,no_ensl
6439  A007 17           		rla
6440  A008 17           		rla
6441  A009 CB 2F        		sra	a
6442  A00B CB 2F        		sra	a
6443  A00D CB 2F        		sra	a
6444  A00F DD 86 04     		add	a,(ix+CHP.CrEnSl)
6445  A012 CB 68        		bit	5,b
6446  A014 28 03        		jr	z,no_enac
6447  A016 DD 77 04     		ld	(ix+CHP.CrEnSl),a
6448  A019 21 26 A1     no_enac:	ld	hl,AddToEn+1
6449  A01C 86           		add	a,(hl)
6450  A01D 77           		ld	(hl),a
6451  A01E 18 0E        		jr	ch_mix
6452  A020
6453  A020 1F           no_ensl:	rra
6454  A021 DD 86 03     		add	a,(ix+CHP.CrNsSl)
6455  A024 32 C7 A2     		ld	(AddToNs),a
6456  A027 CB 68        		bit	5,b
6457  A029 28 03        		jr	z,ch_mix
6458  A02B DD 77 03     		ld	(ix+CHP.CrNsSl),a
6459  A02E 78           ch_mix:		ld	a,b
6460  A02F 1F           		rra
6461  A030 E6 48        		and	#48
6462  A032 21 CF A2     ch_exit:	ld	hl,AYREGS+AR_Mixer
6463  A035 B6           		or	(hl)
6464  A036 0F           		rrca
6465  A037 77           		ld	(hl),a
6466  A038 E1           		pop	hl
6467  A039 AF           		xor	a
6468  A03A DD B6 0A     		or	(ix+CHP.COnOff)
6469  A03D C8           		ret	z
6470  A03E DD 35 0A     		dec	(ix+CHP.COnOff)
6471  A041 C0           		ret	nz
6472  A042 DD AE 15     		xor	(ix+CHP.Flags)
6473  A045 DD 77 15     		ld	(ix+CHP.Flags),a
6474  A048 1F           		rra
6475  A049 DD 7E 0B     		ld	a,(ix+CHP.OnOffD)
6476  A04C 38 03        		jr	c,ch_ondl
6477  A04E DD 7E 0C     		ld	a,(ix+CHP.OffOnD)
6478  A051 DD 77 0A     ch_ondl:	ld	(ix+CHP.COnOff),a
6479  A054 C9           		ret
6480  A055
6481  A055              ;------------------------------------------------------------------------------
6482  A055 AF           music_play:	xor	a
6483  A056 32 26 A1     		ld	(AddToEn+1),a
6484  A059 32 CF A2     		ld	(AYREGS+AR_Mixer),a
6485  A05C 3D           		dec	a
6486  A05D 32 D5 A2     		ld	(AYREGS+AR_EnvTp),a
6487  A060 21 C2 A2     		ld	hl,DelyCnt
6488  A063 35           		dec	(hl)
6489  A064 C2 EA A0     		jp	nz,pl2
6490  A067 CD 9F A1     		call	chkfadeout
6491  A06A 21 86 A2     		ld	hl,ChanA+CHP.NtSkCn
6492  A06D 35           		dec	(hl)
6493  A06E 20 4D        		jr	nz,pl1b
6494  A070 01 01 01     AdInPtA:	ld	bc,#0101
6495  A073 0A           		ld	a,(bc)
6496  A074 A7           		and	a
6497  A075 20 3B        		jr	nz,pl1a
6498  A077 57           		ld	d,a
6499  A078 32 C6 A2     		ld	(Ns_base),a
6500  A07B 21 21 21     CrPsPtr:	ld	hl,#2121
6501  A07E 23           		inc	hl
6502  A07F 7E           		ld	a,(hl)
6503  A080 3C           		inc	a
6504  A081 20 08        		jr	nz,plnlp
6505  A083 CD 69 A1     		call	checklp
6506  A086 21 21 21     LPosPtr:	ld	hl,#2121
6507  A089 7E           		ld	a,(hl)
6508  A08A 3C           		inc	a
6509  A08B 22 7C A0     plnlp:		ld	(CrPsPtr+1),hl
6510  A08E 3D           		dec	a			; PT2		PT3
6511  A08F 00           PsCalc:		nop				; add a,a	nop
6512  A090 00           		nop				; add a,(hl)	nop
6513  A091 87           		add	a,a
6514  A092 5F           		ld	e,a
6515  A093 CB 12        		rl	d
6516  A095 21 21 21     PatsPtr:	ld	hl,#2121
6517  A098 19           		add	hl,de
6518  A099 11 11 11     modaddr:	ld	de,#1111
6519  A09C ED 73 B0 A0  		ld	(psp_+1),sp
6520  A0A0 F9           		ld	sp,hl
6521  A0A1 E1           		pop	hl
6522  A0A2 19           		add	hl,de
6523  A0A3 44           		ld	b,h
6524  A0A4 4D           		ld	c,l
6525  A0A5 E1           		pop	hl
6526  A0A6 19           		add	hl,de
6527  A0A7 22 C8 A0     		ld	(AdInPtB+1),hl
6528  A0AA E1           		pop	hl
6529  A0AB 19           		add	hl,de
6530  A0AC 22 DC A0     		ld	(AdInPtC+1),hl
6531  A0AF 31 31 31     psp_:		ld	sp,#3131
6532  A0B2 DD 21 77 A2  pl1a:		ld	ix,ChanA+12
6533  A0B6 CD EF 9C     		call	ptdecode
6534  A0B9 ED 43 71 A0  		ld	(AdInPtA+1),bc
6535  A0BD
6536  A0BD 21 A3 A2     pl1b:		ld	hl,ChanB+CHP.NtSkCn
6537  A0C0 35           		dec	(hl)
6538  A0C1 20 0E        		jr	nz,pl1c
6539  A0C3 DD 21 94 A2  		ld	ix,ChanB+12
6540  A0C7 01 01 01     AdInPtB:	ld	bc,#0101
6541  A0CA CD EF 9C     		call	ptdecode
6542  A0CD ED 43 C8 A0  		ld	(AdInPtB+1),bc
6543  A0D1
6544  A0D1 21 C0 A2     pl1c:		ld	hl,ChanC+CHP.NtSkCn
6545  A0D4 35           		dec	(hl)
6546  A0D5 20 0E        		jr	nz,pl1d
6547  A0D7 DD 21 B1 A2  		ld	ix,ChanC+12
6548  A0DB 01 01 01     AdInPtC:	ld	bc,#0101
6549  A0DE CD EF 9C     		call	ptdecode
6550  A0E1 ED 43 DC A0  		ld	(AdInPtC+1),bc
6551  A0E5              delay:		equ	$+1
6552  A0E5 3E 3E        pl1d:		ld	a,#3E
6553  A0E7 32 C2 A2     		ld	(DelyCnt),a
6554  A0EA DD 21 6B A2  pl2:		ld	ix,ChanA
6555  A0EE 2A C8 A2     		ld	hl,(AYREGS+AR_TonA)
6556  A0F1 CD D5 9E     		call	chregs
6557  A0F4 22 C8 A2     		ld	(AYREGS+AR_TonA),hl
6558  A0F7
6559  A0F7 3A D2 A2     		ld	a,(Ampl)
6560  A0FA 32 D0 A2     		ld	(AYREGS+AR_AmplA),a
6561  A0FD DD 21 88 A2  		ld	ix,ChanB
6562  A101 2A CA A2     		ld	hl,(AYREGS+AR_TonB)
6563  A104 CD D5 9E     		call	chregs
6564  A107 22 CA A2     		ld	(AYREGS+AR_TonB),hl
6565  A10A
6566  A10A 3A D2 A2     		ld	a,(Ampl)
6567  A10D 32 D1 A2     		ld	(AYREGS+AR_AmplB),a
6568  A110 DD 21 A5 A2  		ld	ix,ChanC
6569  A114 2A CC A2     		ld	hl,(AYREGS+AR_TonC)
6570  A117 CD D5 9E     		call	chregs
6571  A11A 22 CC A2     		ld	(AYREGS+AR_TonC),hl
6572  A11D
6573  A11D 2A C6 A2     		ld	hl,(Ns_base) ; read together with AddToNs
6574  A120 7C           		ld	a,h
6575  A121 85           		add	a,l
6576  A122 32 CE A2     		ld	(AYREGS+AR_Noise),a
6577  A125
6578  A125 3E 3E        AddToEn:	ld	a,#3E
6579  A127 5F           		ld	e,a
6580  A128 87           		add	a,a
6581  A129 9F           		sbc	a,a
6582  A12A 57           		ld	d,a
6583  A12B 2A D6 A2     		ld	hl,(EnvBase)
6584  A12E 19           		add	hl,de
6585  A12F ED 5B C3 A2  		ld	de,(CurESld)
6586  A133 19           		add	hl,de
6587  A134 22 D3 A2     		ld	(AYREGS+AR_Env),hl
6588  A137
6589  A137 AF           		xor	a
6590  A138 21 C5 A2     		ld	hl,CurEDel
6591  A13B B6           		or	(hl)
6592  A13C 28 0E        		jr	z,rout_a0
6593  A13E 35           		dec	(hl)
6594  A13F 20 0A        		jr	nz,rout
6595  A141 3E 3E        Env_Del:	ld	a,#3E
6596  A143 77           		ld	(hl),a
6597  A144 21 21 21     ESldAdd:	ld	hl,#2121
6598  A147 19           		add	hl,de
6599  A148 22 C3 A2     		ld	(CurESld),hl
6600  A14B
6601  A14B AF           rout:		xor	a
6602  A14C 11 BF FF     rout_a0:	ld	de,#FFBF
6603  A14F 01 FD FF     		ld	bc,#FFFD
6604  A152 21 C8 A2     		ld	hl,AYREGS
6605  A155 ED 79        lout:		out	(c),a
6606  A157 43           		ld	b,e
6607  A158 ED A3        		outi
6608  A15A 42           		ld	b,d
6609  A15B 3C           		inc	a
6610  A15C FE 0D        		cp	#0D
6611  A15E 20 F5        		jr	nz,lout
6612  A160 ED 79        		out	(c),a
6613  A162 7E           		ld	a,(hl)
6614  A163 A7           		and	a
6615  A164 F8           		ret	m
6616  A165 43           		ld	b,e
6617  A166 ED 79        		out	(c),a
6618  A168 C9           		ret
6619  A169
6620  A169 21 E2 A1     checklp:	ld	hl,music_setup
6621  A16C CB 4E        		bit	1,(hl)
6622  A16E 20 19        		jr	nz,enablefade
6623  A170 CB 46        		bit	0,(hl)
6624  A172 C8           		ret	z
6625  A173
6626  A173 CB FE        noloop:		set	7,(hl)
6627  A175 E1           deadend:	pop	hl
6628  A176 21 C2 A2     		ld	hl,DelyCnt
6629  A179 34           		inc	(hl)
6630  A17A 21 86 A2     		ld	hl,ChanA+CHP.NtSkCn
6631  A17D 34           		inc	(hl)
6632  A17E
6633  A17E AF           music_mute:	xor	a
6634  A17F 67           		ld	h,a
6635  A180 6F           		ld	l,a
6636  A181 32 D0 A2     		ld	(AYREGS+AR_AmplA),a
6637  A184 22 D1 A2     		ld	(AYREGS+AR_AmplB),hl
6638  A187 18 C3        		jr	rout_a0
6639  A189
6640  A189 3E 30        enablefade:	ld	a,48
6641  A18B 21 A0 A1     forcefade:	ld	hl,chkfadeout+1
6642  A18E 34           		inc	(hl)
6643  A18F 2A 7C A0     		ld	hl,(CrPsPtr+1)
6644  A192 22 CE A1     		ld	(resetfadeout+1),hl
6645  A195 ED 43 D4 A1  		ld	(resetfadeout1+1),bc
6646  A199 32 AA A1     		ld	(countfadeout+1),a
6647  A19C 32 BC A1     		ld	(divfadeout+1),a
6648  A19F
6649  A19F 3E 00        chkfadeout:	ld	a,0
6650  A1A1 B7           		or	a
6651  A1A2 C8           		ret	z
6652  A1A3 3A E2 A1     		ld	a,(music_setup)
6653  A1A6 07           		rlca
6654  A1A7 38 CC        		jr	c,deadend
6655  A1A9 3E 3E        countfadeout:	ld	a,#3E
6656  A1AB 3D           		dec	a
6657  A1AC 32 AA A1     		ld	(countfadeout+1),a
6658  A1AF C0           		ret	nz
6659  A1B0 3A EB 9F     		ld	a,(GlobalAttn+1)
6660  A1B3 3C           		inc	a
6661  A1B4 FE 10        		cp	16
6662  A1B6 28 15        		jr	z,resetfadeout
6663  A1B8 32 EB 9F     		ld	(GlobalAttn+1),a
6664  A1BB 3E 3E        divfadeout:	ld	a,#3E
6665  A1BD CB 3F        		srl	a
6666  A1BF 6F           		ld	l,a
6667  A1C0 CB 3D        		srl	l
6668  A1C2 85           		add	a,l
6669  A1C3 20 01        		jr	nz,divfadeout1
6670  A1C5 3C           		inc	a
6671  A1C6 32 AA A1     divfadeout1:	ld	(countfadeout+1),a
6672  A1C9 32 BC A1     		ld	(divfadeout+1),a
6673  A1CC C9           		ret
6674  A1CD
6675  A1CD 21 21 21     resetfadeout:	ld	hl,#2121
6676  A1D0 22 7C A0     		ld	(CrPsPtr+1),hl
6677  A1D3 21 21 21     resetfadeout1:	ld	hl,#2121
6678  A1D6 22 71 A0     		ld	(AdInPtA+1),hl
6679  A1D9 AF           		xor	a
6680  A1DA 32 86 A2     		ld	(ChanA+CHP.NtSkCn),a
6681  A1DD 21 E2 A1     		ld	hl,music_setup
6682  A1E0 18 91        		jr	noloop
6683  A1E2
6684  A1E2
6685  A1E2              ; bit.0 if you want to play without looping
6686  A1E2              ; bit.1 if you play looped but fadeout after few seconds
6687  A1E2              ; bit.7 is set each time when loop is passed
6688  A1E2              ; ...or simplified:	2 - fadeout after loop
6689  A1E2              ;			1 - no loop
6690  A1E2              ;			0 - loop forever
6691  A1E2 02           music_setup:	db	2
6692  A1E3
6693  A1E3
6694  A1E3              ;------------------------------------------------------------------------------
6695  A1E3              ; note table data
6696  A1E3 64           nt_data:	db	(T_NEW_0-T1_)*2
6697  A1E4 2A           		db	TCNEW_0-T_
6698  A1E5 65           		db	(T_OLD_0-T1_)*2+1
6699  A1E6 00           		db	TCOLD_0-T_
6700  A1E7 01           		db	(T_NEW_1-T1_)*2+1
6701  A1E8 0C           		db	TCNEW_1-T_
6702  A1E9 01           		db	(T_OLD_1-T1_)*2+1
6703  A1EA 0C           		db	TCOLD_1-T_
6704  A1EB 94           		db	(T_NEW_2-T1_)*2
6705  A1EC 35           		db	TCNEW_2-T_
6706  A1ED 30           		db	(T_OLD_2-T1_)*2
6707  A1EE 0E           		db	TCOLD_2-T_
6708  A1EF 60           		db	(T_NEW_3-T1_)*2
6709  A1F0 20           		db	TCNEW_3-T_
6710  A1F1 60           		db	(T_OLD_3-T1_)*2
6711  A1F2 21           		db	TCOLD_3-T_
6712  A1F3              T_
6713  A1F3
6714  A1F3 01 05 09 0B  TCOLD_0		db	#00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
6714  A1F7 0D 0F 13 15
6715  A1FB 19 25 3D 00  		db	#18+1,#24+1,#3C+1,0
6716  A1FF 5D 00        TCOLD_1		db	#5C+1,0
6717  A201 31 37 4D 53  TCOLD_2		db	#30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
6717  A205 5F 71 82 8C
6717  A209 9C
6718  A20A 9E A0 A6 A8  		db	#9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
6718  A20E AA AC AE AE
6718  A212 00
6719  A213 57           TCNEW_3		db	#56+1
6720  A214 1F 23 25 29  TCOLD_3		db	#1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
6720  A218 2D 2F 33 BF
6720  A21C 00
6721  A21D 1D 21 23 27  TCNEW_0		db	#1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
6721  A221 2B 2D 31 55
6722  A225 BD BF 00     		db	#BC+1,#BE+1,0
6723  A228              TCNEW_1		equ	TCOLD_1
6724  A228 1B 21 25 29  TCNEW_2		db	#1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
6724  A22C 2B 3B 4D 5F
6725  A230 BB BD BF 00  		db	#BA+1,#BC+1,#BE+1,0
6726  A234
6727  A234              PT3_EmptySmpOrn	equ	$-1
6728  A234 01 00        		db	1,0 ;#90 ; delete #90 if you don't need default sample
6729  A236
6730  A236              PT2_EmptySmpOrn	equ	VT_+31 ; 1,0,0 sequence
6731  A236
6732  A236              ; first 12 values of tone tables (packed)
6733  A236 0D D8        T_PACK		db	high (#06EC*2), low (#06EC*2)
6734  A238 69           		db	#0755-#06EC
6735  A239 70           		db	#07C5-#0755
6736  A23A 76           		db	#083B-#07C5
6737  A23B 7D           		db	#08B8-#083B
6738  A23C 85           		db	#093D-#08B8
6739  A23D 8D           		db	#09CA-#093D
6740  A23E 95           		db	#0A5F-#09CA
6741  A23F 9D           		db	#0AFC-#0A5F
6742  A240 A8           		db	#0BA4-#0AFC
6743  A241 B1           		db	#0C55-#0BA4
6744  A242 BB           		db	#0D10-#0C55
6745  A243 0C DA        		db	high (#066D*2), low (#066D*2)
6746  A245 62           		db	#06CF-#066D
6747  A246 68           		db	#0737-#06CF
6748  A247 6D           		db	#07A4-#0737
6749  A248 75           		db	#0819-#07A4
6750  A249 7B           		db	#0894-#0819
6751  A24A 83           		db	#0917-#0894
6752  A24B 8A           		db	#09A1-#0917
6753  A24C 92           		db	#0A33-#09A1
6754  A24D 9C           		db	#0ACF-#0A33
6755  A24E A4           		db	#0B73-#0ACF
6756  A24F AF           		db	#0C22-#0B73
6757  A250 B8           		db	#0CDA-#0C22
6758  A251 0E 08        		db	high (#0704*2), low (#0704*2)
6759  A253 6A           		db	#076E-#0704
6760  A254 72           		db	#07E0-#076E
6761  A255 78           		db	#0858-#07E0
6762  A256 7E           		db	#08D6-#0858
6763  A257 86           		db	#095C-#08D6
6764  A258 90           		db	#09EC-#095C
6765  A259 96           		db	#0A82-#09EC
6766  A25A A0           		db	#0B22-#0A82
6767  A25B AA           		db	#0BCC-#0B22
6768  A25C B4           		db	#0C80-#0BCC
6769  A25D BE           		db	#0D3E-#0C80
6770  A25E 0F C0        		db	high (#07E0*2), low (#07E0*2)
6771  A260 78           		db	#0858-#07E0
6772  A261 88           		db	#08E0-#0858
6773  A262 80           		db	#0960-#08E0
6774  A263 90           		db	#09F0-#0960
6775  A264 98           		db	#0A88-#09F0
6776  A265 A0           		db	#0B28-#0A88
6777  A266 B0           		db	#0BD8-#0B28
6778  A267 A8           		db	#0C80-#0BD8
6779  A268 E0           		db	#0D60-#0C80
6780  A269 B0           		db	#0E10-#0D60
6781  A26A E8           		db	#0EF8-#0E10
6782  A26B
6783  A26B              ; channel data offsets
6784  A26B              	struct CHP
6785  A26B ~            PsInOr		byte
6786  A26B ~            PsInSm		byte
6787  A26B ~            CrAmSl		byte
6788  A26B ~            CrNsSl		byte
6789  A26B ~            CrEnSl		byte
6790  A26B ~            TSlCnt		byte
6791  A26B ~            CrTnSl		word
6792  A26B ~            TnAcc		word
6793  A26B ~            COnOff		byte
6794  A26B ~            OnOffD		byte
6795  A26B ~            OffOnD		byte	; IX for PTDECOD here (+12)
6796  A26B ~            OrnPtr		word
6797  A26B ~            SamPtr		word
6798  A26B ~            NNtSkp		byte
6799  A26B ~            Note		byte
6800  A26B ~            SlToNt		byte
6801  A26B ~            Env_En		byte
6802  A26B ~            Flags		byte
6803  A26B ~            TnSlDl		byte	; Enabled - 0, SimpleGliss - 2
6804  A26B ~            TSlStp		word
6805  A26B ~            TnDelt		word
6806  A26B ~            NtSkCn		byte
6807  A26B ~            Volume		byte
6808  A26B              	ends
6809  A26B
6810  A26B              AR_TonA		equ	0	; word 1
6811  A26B              AR_TonB		equ	2	; word 1
6812  A26B              AR_TonC		equ	4	; word 1
6813  A26B              AR_Noise	equ	6	; byte 1
6814  A26B              AR_Mixer	equ	7	; byte 1
6815  A26B              AR_AmplA	equ	8	; byte 1
6816  A26B              AR_AmplB	equ	9	; byte 1
6817  A26B              AR_AmplC	equ	10	; byte 1
6818  A26B              AR_Env		equ	11	; word 1
6819  A26B              AR_EnvTp	equ	13	; byte 1
6820  A26B              AR_Size		equ	14
6821  A26B
6822  A26B
6823  A26B              ;------------------------------------------------------------------------------
6824  A26B              ; variables are 541 bytes long
6825  A26B              VARS
6826  A26B 00 00 00...  ChanA		ds	29
6827  A288 00 00 00...  ChanB		ds	29
6828  A2A5 00 00 00...  ChanC		ds	29
6829  A2C2
6830  A2C2
6831  A2C2              ; GlobalVars
6832  A2C2 00           DelyCnt		db	0
6833  A2C3 00 00        CurESld		dw	0
6834  A2C5 00           CurEDel		db	0
6835  A2C6 00           Ns_base		db	0
6836  A2C7 00           AddToNs		db	0
6837  A2C8
6838  A2C8              AYREGS		equ	$
6839  A2C8              Ampl		equ	AYREGS+AR_AmplC
6840  A2C8
6841  A2C8 00 00 00...  VT_		ds	256		; Volume Table
6842  A3C8 00 00 00...  NT_		ds	192		; Note Table
6843  A488
6844  A488              EnvBase		equ	VT_+14
6845  A488              T1_		equ	VT_+16		; Tone tables data depacked here
6846  A488              T_OLD_1		equ	T1_
6847  A488              T_OLD_2		equ	T_OLD_1+24
6848  A488              T_OLD_3		equ	T_OLD_2+24
6849  A488              T_OLD_0		equ	T_OLD_3+2
6850  A488              T_NEW_0		equ	T_OLD_0
6851  A488              T_NEW_1		equ	T_OLD_1
6852  A488              T_NEW_2		equ	T_NEW_0+24
6853  A488              T_NEW_3		equ	T_OLD_3
6854  A488
6855  A488              VAR0END		equ	T1_		; init zeroes from VARS to VAR0END-1
6856  A488              VARSEND		equ	$
6857  A488
6858  A488
6859  A488
6860  A488              		module stc
6861  A488
6862  A488 21 D4 B0     music_init:	ld	hl,songdata
6863  A48B 7E           music_init0:	ld	a,(hl)
6864  A48C 32 1E A8     		ld	(speed),a
6865  A48F 22 03 A5     		ld	(module_addr+1),hl
6866  A492 23           		inc	hl
6867  A493 CD FD A4     		call	add_offset
6868  A496 1A           		ld	a,(de)
6869  A497 13           		inc	de
6870  A498 3C           		inc	a
6871  A499 32 20 A8     		ld	(song_length),a
6872  A49C ED 53 16 A8  		ld	(positions),de
6873  A4A0 CD FD A4     		call	add_offset
6874  A4A3 ED 53 18 A8  		ld	(ornaments),de
6875  A4A7 D5           		push	de
6876  A4A8 CD FD A4     		call	add_offset
6877  A4AB ED 53 1A A8  		ld	(patterns),de
6878  A4AF 21 1B 00     		ld	hl,HEADLEN
6879  A4B2 CD 02 A5     		call	module_addr
6880  A4B5 EB           		ex	de,hl
6881  A4B6 22 1C A8     		ld	(samples),hl
6882  A4B9 21 27 A8     		ld	hl,empty_pattern
6883  A4BC 22 21 A8     		ld	(chn1_pattptr),hl
6884  A4BF 23           		inc	hl
6885  A4C0 11 29 A8     		ld	de,CHN1+1
6886  A4C3 01 1F 00     		ld	bc,VARSLEN
6887  A4C6 70           		ld	(hl),b
6888  A4C7 ED B0        		ldir
6889  A4C9 E1           		pop	hl
6890  A4CA 01 21 00     		ld	bc,ORNALEN
6891  A4CD AF           		xor	a
6892  A4CE CD F8 A4     		call	scan_until
6893  A4D1 32 72 A7     		ld	(apply_volenv+1),a
6894  A4D4 32 E9 A7     		ld	(chkfadeout+1),a
6895  A4D7 3D           		dec	a
6896  A4D8 32 31 A8     		ld	(CHN1+CHP.SmpCnt),a
6897  A4DB 32 3B A8     		ld	(CHN2+CHP.SmpCnt),a
6898  A4DE 32 45 A8     		ld	(CHN3+CHP.SmpCnt),a
6899  A4E1 3E 01        		ld	a,1
6900  A4E3 32 1F A8     		ld	(tempo_cnt),a
6901  A4E6 23           		inc	hl
6902  A4E7 22 2F A8     		ld	(CHN1+CHP.OrnPtr),hl
6903  A4EA 22 39 A8     		ld	(CHN2+CHP.OrnPtr),hl
6904  A4ED 22 43 A8     		ld	(CHN3+CHP.OrnPtr),hl
6905  A4F0 21 E2 A1     		ld	hl,music_setup
6906  A4F3 CB BE        		res	7,(hl)
6907  A4F5 C3 53 A6     		jp	music_mute
6908  A4F8
6909  A4F8 BE           scan_until:	cp	(hl)
6910  A4F9 C8           		ret	z
6911  A4FA 09           		add	hl,bc
6912  A4FB 18 FB        		jr	scan_until
6913  A4FD
6914  A4FD 5E           add_offset:	ld	e,(hl)
6915  A4FE 23           		inc	hl
6916  A4FF 56           		ld	d,(hl)
6917  A500 23           		inc	hl
6918  A501 EB           		ex	de,hl
6919  A502 01 00 00     module_addr:	ld	bc,0
6920  A505 09           		add	hl,bc
6921  A506 EB           		ex	de,hl
6922  A507 C9           		ret
6923  A508
6924  A508 3A 46 A8     new_position:	ld	a,(current_pos)
6925  A50B 4F           		ld	c,a
6926  A50C 21 20 A8     		ld	hl,song_length
6927  A50F BE           		cp	(hl)
6928  A510 38 0F        		jr	c,.continue
6929  A512 21 E2 A1     		ld	hl,music_setup
6930  A515 CB 4E        		bit	1,(hl)
6931  A517 C4 DD A7     		call	nz,enablefade
6932  A51A CB 46        		bit	0,(hl)
6933  A51C C2 C5 A7     		jp	nz,noloop
6934  A51F AF           		xor	a
6935  A520 4F           		ld	c,a
6936  A521 3C           .continue:	inc	a
6937  A522 32 46 A8     		ld	(current_pos),a
6938  A525 69           		ld	l,c
6939  A526 26 00        		ld	h,0
6940  A528 29           		add	hl,hl
6941  A529 ED 5B 16 A8  		ld	de,(positions)
6942  A52D 19           		add	hl,de
6943  A52E 4E           		ld	c,(hl)
6944  A52F 23           		inc	hl
6945  A530 7E           		ld	a,(hl)
6946  A531 32 A7 A7     		ld	(get_frequency+1),a
6947  A534 79           		ld	a,c
6948  A535 2A 1A A8     		ld	hl,(patterns)
6949  A538 01 07 00     		ld	bc,PATTLEN
6950  A53B CD F8 A4     		call	scan_until
6951  A53E 23           		inc	hl
6952  A53F CD FD A4     		call	add_offset
6953  A542 ED 53 21 A8  		ld	(chn1_pattptr),de
6954  A546 CD FD A4     		call	add_offset
6955  A549 ED 53 23 A8  		ld	(chn2_pattptr),de
6956  A54D CD FD A4     		call	add_offset
6957  A550 ED 53 25 A8  		ld	(chn3_pattptr),de
6958  A554 C9           		ret
6959  A555
6960  A555 DD 35 04     adv_patt_step:	dec	(ix+CHP.PatStpCnt)
6961  A558 F0           		ret	p
6962  A559 DD 7E 01     		ld	a,(ix+CHP.PatStep)
6963  A55C DD 77 04     		ld	(ix+CHP.PatStpCnt),a
6964  A55F C9           		ret
6965  A560
6966  A560              ;------------------------------------------------------------------------------
6967  A560 3A 1F A8     music_play:	ld	a,(tempo_cnt)
6968  A563 3D           		dec	a
6969  A564 32 1F A8     		ld	(tempo_cnt),a
6970  A567 20 47        		jr	nz,playback
6971  A569 3A 1E A8     		ld	a,(speed)
6972  A56C 32 1F A8     		ld	(tempo_cnt),a
6973  A56F
6974  A56F DD 21 28 A8  .chn1:		ld	ix,CHN1
6975  A573 CD 55 A5     		call	adv_patt_step
6976  A576 F2 8A A5     		jp	p,.chn2
6977  A579 2A 21 A8     		ld	hl,(chn1_pattptr)
6978  A57C 7E           		ld	a,(hl)
6979  A57D 3C           		inc	a
6980  A57E CC 08 A5     		call	z,new_position
6981  A581 2A 21 A8     		ld	hl,(chn1_pattptr)
6982  A584 CD 95 A6     		call	read_pattern
6983  A587 22 21 A8     		ld	(chn1_pattptr),hl
6984  A58A
6985  A58A DD 21 32 A8  .chn2:		ld	ix,CHN2
6986  A58E CD 55 A5     		call	adv_patt_step
6987  A591 F2 9D A5     		jp	p,.chn3
6988  A594 2A 23 A8     		ld	hl,(chn2_pattptr)
6989  A597 CD 95 A6     		call	read_pattern
6990  A59A 22 23 A8     		ld	(chn2_pattptr),hl
6991  A59D
6992  A59D DD 21 3C A8  .chn3:		ld	ix,CHN3
6993  A5A1 CD 55 A5     		call	adv_patt_step
6994  A5A4 F2 B0 A5     		jp	p,playback
6995  A5A7 2A 25 A8     		ld	hl,(chn3_pattptr)
6996  A5AA CD 95 A6     		call	read_pattern
6997  A5AD 22 25 A8     		ld	(chn3_pattptr),hl
6998  A5B0
6999  A5B0              ;------------------------------------------------------------------------------
7000  A5B0 CD E8 A7     playback:	call	chkfadeout
7001  A5B3 DD 21 28 A8  		ld	ix,CHN1
7002  A5B7 CD FC A6     		call	adv_sample
7003  A5BA 79           		ld	a,c
7004  A5BB 32 9F A7     		ld	(sample_index+1),a
7005  A5BE CD 30 A7     		call	read_sample
7006  A5C1 79           		ld	a,c
7007  A5C2 B0           		or	b
7008  A5C3 0F           		rrca
7009  A5C4 32 4E A8     		ld	(AYREGS+AR.Mixer),a
7010  A5C7 DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
7011  A5CA 3C           		inc	a
7012  A5CB 28 09        		jr	z,.chn2
7013  A5CD CD 69 A7     		call	set_noise
7014  A5D0 CD 95 A7     		call	get_tone
7015  A5D3 22 47 A8     		ld	(AYREGS+AR.TonA),hl
7016  A5D6
7017  A5D6 21 4F A8     .chn2:		ld	hl,AYREGS+AR.AmplA
7018  A5D9 CD 71 A7     		call	apply_volenv
7019  A5DC DD 21 32 A8  		ld	ix,CHN2
7020  A5E0 CD FC A6     		call	adv_sample
7021  A5E3 DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
7022  A5E6 3C           		inc	a
7023  A5E7 28 18        		jr	z,.chn3
7024  A5E9 79           		ld	a,c
7025  A5EA 32 9F A7     		ld	(sample_index+1),a
7026  A5ED CD 30 A7     		call	read_sample
7027  A5F0 3A 4E A8     		ld	a,(AYREGS+AR.Mixer)
7028  A5F3 B1           		or	c
7029  A5F4 B0           		or	b
7030  A5F5 32 4E A8     		ld	(AYREGS+AR.Mixer),a
7031  A5F8 CD 69 A7     		call	set_noise
7032  A5FB CD 95 A7     		call	get_tone
7033  A5FE 22 49 A8     		ld	(AYREGS+AR.TonB),hl
7034  A601
7035  A601 21 50 A8     .chn3:		ld	hl,AYREGS+AR.AmplB
7036  A604 CD 71 A7     		call	apply_volenv
7037  A607 DD 21 3C A8  		ld	ix,CHN3
7038  A60B CD FC A6     		call	adv_sample
7039  A60E DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
7040  A611 3C           		inc	a
7041  A612 28 1C        		jr	z,.finish
7042  A614 79           		ld	a,c
7043  A615 32 9F A7     		ld	(sample_index+1),a
7044  A618 CD 30 A7     		call	read_sample
7045  A61B 3A 4E A8     		ld	a,(AYREGS+AR.Mixer)
7046  A61E CB 01        		rlc	c
7047  A620 CB 00        		rlc	b
7048  A622 B0           		or	b
7049  A623 B1           		or	c
7050  A624 32 4E A8     		ld	(AYREGS+AR.Mixer),a
7051  A627 CD 69 A7     		call	set_noise
7052  A62A CD 95 A7     		call	get_tone
7053  A62D 22 4B A8     		ld	(AYREGS+AR.TonC),hl
7054  A630
7055  A630 21 51 A8     .finish:	ld	hl,AYREGS+AR.AmplC
7056  A633 CD 71 A7     		call	apply_volenv
7057  A636
7058  A636 21 54 A8     outay:		ld	hl,AYREGS+AR.EnvSh
7059  A639 AF           		xor	a
7060  A63A B6           		or	(hl)
7061  A63B 3E 0D        		ld	a,AR.EnvSh
7062  A63D 20 05        		jr	nz,.fillregs
7063  A63F D6 03        		sub	3
7064  A641 2B           		dec	hl
7065  A642 2B           		dec	hl
7066  A643 2B           		dec	hl
7067  A644 01 FD FF     .fillregs:	ld	bc,#FFFD
7068  A647 ED 79        .loop:		out	(c),a
7069  A649 CB B0        		res	6,b
7070  A64B ED AB        		outd
7071  A64D CB F0        		set	6,b
7072  A64F 3D           		dec	a
7073  A650 F8           		ret	m
7074  A651 18 F4        		jr	.loop
7075  A653
7076  A653 21 47 A8     music_mute:	ld	hl,AYREGS
7077  A656 11 48 A8     		ld	de,AYREGS+1
7078  A659 01 07 00     		ld	bc,AR.Mixer
7079  A65C 70           		ld	(hl),b
7080  A65D ED B0        		ldir
7081  A65F 35           		dec	(hl)
7082  A660 2E 47        		ld	l,low AYREGS
7083  A662 0E 05        		ld	c,AR.EnvSh-AR.Mixer-1
7084  A664 ED B0        		ldir
7085  A666 EB           		ex	hl,de
7086  A667 3E 0D        		ld	a,AR.EnvSh
7087  A669 18 D9        		jr	outay.fillregs
7088  A66B
7089  A66B DD 77 03     c_note:		ld	(ix+CHP.Note),a
7090  A66E DD 36 02 00  		ld	(ix+CHP.SmpIndex),0
7091  A672 DD 36 09 20  		ld	(ix+CHP.SmpCnt),#20
7092  A676 23           c_empty:	inc	hl
7093  A677 C9           		ret
7094  A678
7095  A678 D6 60        c_sample:	sub	#60
7096  A67A E5           		push	hl
7097  A67B 01 63 00     		ld	bc,SAMPLEN
7098  A67E 2A 1C A8     		ld	hl,(samples)
7099  A681 CD F8 A4     		call	scan_until
7100  A684 23           		inc	hl
7101  A685 DD 75 05     		ld	(ix+CHP.SmpPtr),l
7102  A688 DD 74 06     		ld	(ix+CHP.SmpPtr+1),h
7103  A68B E1           		pop	hl
7104  A68C 23           		inc	hl
7105  A68D 18 06        		jr	read_pattern
7106  A68F
7107  A68F 23           c_rest:		inc	hl
7108  A690 DD 36 09 FF  c_norept:	ld	(ix+CHP.SmpCnt),-1
7109  A694 C9           		ret
7110  A695
7111  A695 7E           read_pattern:	ld	a,(hl)
7112  A696 FE 60        		cp	#60		; note
7113  A698 38 D1        		jr	c,c_note
7114  A69A FE 70        		cp	#70		; sample
7115  A69C 38 DA        		jr	c,c_sample
7116  A69E FE 80        		cp	#80		; ornament
7117  A6A0 38 1B        		jr	c,c_ornament
7118  A6A2 28 EB        		jr	z,c_rest	; rest
7119  A6A4 FE 81        		cp	#81		; empty
7120  A6A6 28 CE        		jr	z,c_empty
7121  A6A8 FE 82        		cp	#82		; ornament off
7122  A6AA 28 0F        		jr	z,c_ornoff
7123  A6AC FE 8F        		cp	#8F		; envelope
7124  A6AE 38 28        		jr	c,c_envelope
7125  A6B0 D6 A1        		sub	#A1		; speed
7126  A6B2 DD 77 04     		ld	(ix+CHP.PatStpCnt),a
7127  A6B5 DD 77 01     		ld	(ix+CHP.PatStep),a
7128  A6B8 23           		inc	hl
7129  A6B9 18 DA        		jr	read_pattern
7130  A6BB
7131  A6BB AF           c_ornoff:	xor	a
7132  A6BC 01           		db	1 ; ld bc,* (skip next instruction)
7133  A6BD D6 70        c_ornament:	sub	#70
7134  A6BF E5           c_ornament0:	push	hl
7135  A6C0 01 21 00     		ld	bc,ORNALEN
7136  A6C3 2A 18 A8     		ld	hl,(ornaments)
7137  A6C6 CD F8 A4     		call	scan_until
7138  A6C9 23           		inc	hl
7139  A6CA DD 75 07     		ld	(ix+CHP.OrnPtr),l
7140  A6CD DD 74 08     		ld	(ix+CHP.OrnPtr+1),h
7141  A6D0 DD 36 00 00  		ld	(ix+CHP.EnvState),0
7142  A6D4 E1           		pop	hl
7143  A6D5 23           		inc	hl
7144  A6D6 18 BD        		jr	read_pattern
7145  A6D8
7146  A6D8 D6 80        c_envelope:	sub	#80
7147  A6DA 32 54 A8     		ld	(AYREGS+AR.EnvSh),a
7148  A6DD 23           		inc	hl
7149  A6DE 7E           		ld	a,(hl)
7150  A6DF 23           		inc	hl
7151  A6E0 32 52 A8     		ld	(AYREGS+AR.Env),a
7152  A6E3 DD 36 00 01  		ld	(ix+CHP.EnvState),1
7153  A6E7 E5           		push	hl
7154  A6E8 AF           		xor	a
7155  A6E9 01 21 00     		ld	bc,ORNALEN
7156  A6EC 2A 18 A8     		ld	hl,(ornaments)
7157  A6EF CD F8 A4     		call	scan_until
7158  A6F2 23           		inc	hl
7159  A6F3 DD 75 07     		ld	(ix+CHP.OrnPtr),l
7160  A6F6 DD 74 08     		ld	(ix+CHP.OrnPtr+1),h
7161  A6F9 E1           		pop	hl
7162  A6FA 18 99        		jr	read_pattern
7163  A6FC
7164  A6FC DD 7E 09     adv_sample:	ld	a,(ix+CHP.SmpCnt)
7165  A6FF 3C           		inc	a
7166  A700 C8           		ret	z
7167  A701 3D           		dec	a
7168  A702 3D           		dec	a
7169  A703 DD 77 09     		ld	(ix+CHP.SmpCnt),a
7170  A706 F5           		push	af
7171  A707 DD 7E 02     		ld	a,(ix+CHP.SmpIndex)
7172  A70A 4F           		ld	c,a
7173  A70B 3C           		inc	a
7174  A70C E6 1F        		and	#1F
7175  A70E DD 77 02     		ld	(ix+CHP.SmpIndex),a
7176  A711 F1           		pop	af
7177  A712 C0           		ret	nz
7178  A713 DD 5E 05     		ld	e,(ix+CHP.SmpPtr)
7179  A716 DD 56 06     		ld	d,(ix+CHP.SmpPtr+1)
7180  A719 21 60 00     		ld	hl,#60	; offset to sample metadata
7181  A71C 19           		add	hl,de
7182  A71D 7E           		ld	a,(hl)
7183  A71E 3D           		dec	a
7184  A71F FA 90 A6     		jp	m,c_norept
7185  A722 4F           		ld	c,a	; repeat sample
7186  A723 3C           		inc	a
7187  A724 E6 1F        		and	#1F
7188  A726 DD 77 02     		ld	(ix+CHP.SmpIndex),a
7189  A729 23           		inc	hl
7190  A72A 7E           		ld	a,(hl)
7191  A72B 3C           		inc	a
7192  A72C DD 77 09     		ld	(ix+CHP.SmpCnt),a
7193  A72F C9           		ret
7194  A730
7195  A730 16 00        read_sample:	ld	d,0
7196  A732 5F           		ld	e,a
7197  A733 87           		add	a,a
7198  A734 83           		add	a,e
7199  A735 5F           		ld	e,a
7200  A736 DD 6E 05     		ld	l,(ix+CHP.SmpPtr)
7201  A739 DD 66 06     		ld	h,(ix+CHP.SmpPtr+1)
7202  A73C 19           		add	hl,de
7203  A73D 23           		inc	hl
7204  A73E 7E           		ld	a,(hl)
7205  A73F CB 7F        		bit	7,a
7206  A741 0E 10        		ld	c,#10
7207  A743 20 01        		jr	nz,.no_noise
7208  A745 4A           		ld	c,d
7209  A746 CB 77        .no_noise:	bit	6,a
7210  A748 06 02        		ld	b,2
7211  A74A 20 01        		jr	nz,.no_tone
7212  A74C 42           		ld	b,d
7213  A74D 23           .no_tone:	inc	hl
7214  A74E 5E           		ld	e,(hl)
7215  A74F 2B           		dec	hl
7216  A750 2B           		dec	hl
7217  A751 56           		ld	d,(hl)
7218  A752 6F           		ld	l,a
7219  A753 E6 1F        		and	#1F
7220  A755 67           		ld	h,a
7221  A756 7A           		ld	a,d
7222  A757 F5           		push	af
7223  A758 E6 F0        		and	#F0
7224  A75A 0F           		rrca
7225  A75B 0F           		rrca
7226  A75C 0F           		rrca
7227  A75D 0F           		rrca
7228  A75E 57           		ld	d,a
7229  A75F F1           		pop	af
7230  A760 E6 0F        		and	#0F
7231  A762 CB 6D        		bit	5,l
7232  A764 6F           		ld	l,a
7233  A765 C8           		ret	z
7234  A766 CB E2        		set	4,d
7235  A768 C9           		ret
7236  A769
7237  A769 79           set_noise:	ld	a,c
7238  A76A B7           		or	a
7239  A76B C0           		ret	nz
7240  A76C 7C           		ld	a,h
7241  A76D 32 4D A8     		ld	(AYREGS+AR.Noise),a
7242  A770 C9           		ret
7243  A771
7244  A771 1E 00        apply_volenv:	ld	e,0		; GLOBAL ATTENUATION
7245  A773 93           		sub	e
7246  A774 30 01        		jr	nc,.set
7247  A776 AF           		xor	a
7248  A777 77           .set		ld	(hl),a		; if value of attenuation is higher
7249  A778 CB 5F        		bit	3,a		; then 8 we will stop also envelopes...
7250  A77A C8           		ret	z
7251  A77B
7252  A77B DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
7253  A77E 3C           		inc	a
7254  A77F C8           		ret	z
7255  A780 DD 7E 00     		ld	a,(ix+CHP.EnvState)
7256  A783 B7           		or	a
7257  A784 C8           		ret	z
7258  A785 3D           		dec	a
7259  A786 20 06        		jr	nz,.resetshape
7260  A788 DD 36 00 02  		ld	(ix+CHP.EnvState),2
7261  A78C 18 04        		jr	.setenv
7262  A78E
7263  A78E AF           .resetshape:	xor	a
7264  A78F 32 54 A8     		ld	(AYREGS+AR.EnvSh),a
7265  A792 CB E6        .setenv:	set	4,(hl)
7266  A794 C9           		ret
7267  A795
7268  A795 7D           get_tone:	ld	a,l
7269  A796 F5           		push	af
7270  A797 D5           		push	de
7271  A798 DD 6E 07     		ld	l,(ix+CHP.OrnPtr)
7272  A79B DD 66 08     		ld	h,(ix+CHP.OrnPtr+1)
7273  A79E 11 00 00     sample_index:	ld	de,0
7274  A7A1 19           		add	hl,de
7275  A7A2 DD 7E 03     		ld	a,(ix+CHP.Note)
7276  A7A5 86           		add	a,(hl)
7277  A7A6
7278  A7A6 C6 00        get_frequency:	add	a,0
7279  A7A8 87           		add	a,a
7280  A7A9 5F           		ld	e,a
7281  A7AA 16 00        		ld	d,0
7282  A7AC 21 55 A8     		ld	hl,freqtable
7283  A7AF 19           		add	hl,de
7284  A7B0 5E           		ld	e,(hl)
7285  A7B1 23           		inc	hl
7286  A7B2 56           		ld	d,(hl)
7287  A7B3 EB           		ex	de,hl
7288  A7B4 D1           		pop	de
7289  A7B5 F1           		pop	af
7290  A7B6 CB 62        		bit	4,d
7291  A7B8 28 04        		jr	z,.negative
7292  A7BA CB A2        		res	4,d
7293  A7BC 19           		add	hl,de
7294  A7BD C9           		ret
7295  A7BE
7296  A7BE A7           .negative:	and	a
7297  A7BF ED 52        		sbc	hl,de
7298  A7C1 C9           		ret
7299  A7C2
7300  A7C2              ;------------------------------------------------------------------------------
7301  A7C2 21 E2 A1     resetfadeout:	ld	hl,music_setup
7302  A7C5 CB FE        noloop:		set	7,(hl)
7303  A7C7 CD 53 A6     		call	music_mute
7304  A7CA E1           deadend:	pop	hl
7305  A7CB AF           		xor	a
7306  A7CC 32 1F A8     		ld	(tempo_cnt),a
7307  A7CF 3D           		dec	a
7308  A7D0 32 31 A8     		ld	(CHN1+CHP.SmpCnt),a
7309  A7D3 32 3B A8     		ld	(CHN2+CHP.SmpCnt),a
7310  A7D6 32 45 A8     		ld	(CHN3+CHP.SmpCnt),a
7311  A7D9 32 E9 A7     		ld	(chkfadeout+1),a
7312  A7DC C9           		ret
7313  A7DD
7314  A7DD 3E 30        enablefade:	ld	a,48
7315  A7DF 32 E9 A7     forcefade:	ld	(chkfadeout+1),a
7316  A7E2 32 F3 A7     		ld	(countfadeout+1),a
7317  A7E5 32 05 A8     		ld	(divfadeout+1),a
7318  A7E8
7319  A7E8 3E 00        chkfadeout:	ld	a,0
7320  A7EA B7           		or	a
7321  A7EB C8           		ret	z
7322  A7EC 3A E2 A1     		ld	a,(music_setup)
7323  A7EF 07           		rlca
7324  A7F0 38 D8        		jr	c,deadend
7325  A7F2 3E 00        countfadeout:	ld	a,0
7326  A7F4 3D           		dec	a
7327  A7F5 32 F3 A7     		ld	(countfadeout+1),a
7328  A7F8 C0           		ret	nz
7329  A7F9 3A 72 A7     		ld	a,(apply_volenv+1)
7330  A7FC 3C           		inc	a
7331  A7FD FE 10        		cp	16
7332  A7FF 28 C1        		jr	z,resetfadeout
7333  A801 32 72 A7     		ld	(apply_volenv+1),a
7334  A804 3E 00        divfadeout:	ld	a,0
7335  A806 CB 3F        		srl	a
7336  A808 5F           		ld	e,a
7337  A809 CB 3B        		srl	e
7338  A80B 83           		add	a,e
7339  A80C 20 01        		jr	nz,divfadeout1
7340  A80E 3C           		inc	a
7341  A80F 32 F3 A7     divfadeout1:	ld	(countfadeout+1),a
7342  A812 32 05 A8     		ld	(divfadeout+1),a
7343  A815 C9           		ret
7344  A816
7345  A816              ;------------------------------------------------------------------------------
7346  A816 00 00        positions:	dw	0
7347  A818 00 00        ornaments:	dw	0
7348  A81A 00 00        patterns:	dw	0
7349  A81C 00 00        samples:	dw	0
7350  A81E 00           speed:		db	0
7351  A81F 00           tempo_cnt:	db	0
7352  A820 00           song_length:	db	0
7353  A821
7354  A821 27 A8        chn1_pattptr:	dw	empty_pattern
7355  A823 27 A8        chn2_pattptr:	dw	empty_pattern
7356  A825 27 A8        chn3_pattptr:	dw	empty_pattern
7357  A827 FF           empty_pattern:	db	#FF
7358  A828
7359  A828              VARS
7360  A828 00 00 00...  CHN1:		ds	10
7361  A832 00 00 00...  CHN2:		ds	10
7362  A83C 00 00 00...  CHN3:		ds	10
7363  A846
7364  A846 00           current_pos:	db	0
7365  A847              @VARSLEN = $ - VARS
7366  A847
7367  A847 00 00 00...  AYREGS:		ds	14
7368  A855
7369  A855              ;------------------------------------------------------------------------------
7370  A855 F8 0E 10 0E  freqtable:	dw	#0EF8, #0E10, #0D60, #0C80, #0BD8, #0B28, #0A88, #09F0
7370  A859 60 0D 80 0C
7370  A85D D8 0B 28 0B
7370  A861 88 0A F0 09
7371  A865 60 09 E0 08  		dw	#0960, #08E0, #0858, #07E0, #077C, #0708, #06B0, #0640
7371  A869 58 08 E0 07
7371  A86D 7C 07 08 07
7371  A871 B0 06 40 06
7372  A875 EC 05 94 05  		dw	#05EC, #0594, #0544, #04F8, #04B0, #0470, #042C, #03F0
7372  A879 44 05 F8 04
7372  A87D B0 04 70 04
7372  A881 2C 04 F0 03
7373  A885 BE 03 84 03  		dw	#03BE, #0384, #0358, #0320, #02F6, #02CA, #02A2, #027C
7373  A889 58 03 20 03
7373  A88D F6 02 CA 02
7373  A891 A2 02 7C 02
7374  A895 58 02 38 02  		dw	#0258, #0238, #0216, #01F8, #01DF, #01C2, #01AC, #0190
7374  A899 16 02 F8 01
7374  A89D DF 01 C2 01
7374  A8A1 AC 01 90 01
7375  A8A5 7B 01 65 01  		dw	#017B, #0165, #0151, #013E, #012C, #011C, #010B, #00FC
7375  A8A9 51 01 3E 01
7375  A8AD 2C 01 1C 01
7375  A8B1 0B 01 FC 00
7376  A8B5 EF 00 E1 00  		dw	#00EF, #00E1, #00D6, #00C8, #00BD, #00B2, #00A8, #009F
7376  A8B9 D6 00 C8 00
7376  A8BD BD 00 B2 00
7376  A8C1 A8 00 9F 00
7377  A8C5 96 00 8E 00  		dw	#0096, #008E, #0085, #007E, #0077, #0070, #006B, #0064
7377  A8C9 85 00 7E 00
7377  A8CD 77 00 70 00
7377  A8D1 6B 00 64 00
7378  A8D5 5E 00 59 00  		dw	#005E, #0059, #0054, #004F, #004B, #0047, #0042, #003F
7378  A8D9 54 00 4F 00
7378  A8DD 4B 00 47 00
7378  A8E1 42 00 3F 00
7379  A8E5 3B 00 38 00  		dw	#003B, #0038, #0035, #0032, #002F, #002C, #002A, #0027
7379  A8E9 35 00 32 00
7379  A8ED 2F 00 2C 00
7379  A8F1 2A 00 27 00
7380  A8F5 25 00 23 00  		dw	#0025, #0023, #0021, #001F, #001D, #001C, #001A, #0019
7380  A8F9 21 00 1F 00
7380  A8FD 1D 00 1C 00
7380  A901 1A 00 19 00
7381  A905 17 00 16 00  		dw	#0017, #0016, #0015, #0013, #0012, #0011, #0010, #000F
7381  A909 15 00 13 00
7381  A90D 12 00 11 00
7381  A911 10 00 0F 00
7382  A915
7383  A915
7384  A915              ;------------------------------------------------------------------------------
7385  A915              	struct AR	; AY Registers structure
7386  A915 ~            TonA		word	; 0
7387  A915 ~            TonB		word	; 2
7388  A915 ~            TonC		word	; 4
7389  A915 ~            Noise		byte	; 6
7390  A915 ~            Mixer		byte	; 7
7391  A915 ~            AmplA		byte	; 8
7392  A915 ~            AmplB		byte	; 9
7393  A915 ~            AmplC		byte	; 10
7394  A915 ~            Env		word	; 11
7395  A915 ~            EnvSh		byte	; 13
7396  A915              	ends
7397  A915
7398  A915              	struct CHP	; channel parameters structure
7399  A915 ~            EnvState	byte
7400  A915 ~            PatStep		byte
7401  A915 ~            SmpIndex	byte
7402  A915 ~            Note		byte
7403  A915 ~            PatStpCnt	byte
7404  A915 ~            SmpPtr		word
7405  A915 ~            OrnPtr		word
7406  A915 ~            SmpCnt		byte
7407  A915              	ends
7408  A915
7409  A915              @HEADLEN = 27	; file header length
7410  A915              @SAMPLEN = 99	; single sample length
7411  A915              @ORNALEN = 33	; single ornament length
7412  A915              @PATTLEN = 7	; single pattern record length
7413  A915
7414  A915
7415  A915
7416  A915              			endmodule
7417  A915
7418  A915              			module stp
7419  A915              @NULL = 0
7420  A915              ;------------------------------------------------------------------------------
7421  A915 21 D4 B0     music_init:		ld	hl,songdata
7422  A918 22 CD A9     music_init0:	ld	(module_addr+1),hl
7423  A91B 3E FC        		ld	a,#FC
7424  A91D 32 46 AE     		ld	(ChA.smppos+1),a
7425  A920 32 B8 AE     		ld	(ChB.smppos+1),a
7426  A923 32 2D AF     		ld	(ChC.smppos+1),a
7427  A926 7E           		ld	a,(hl)
7428  A927 23           		inc	hl
7429  A928 32 5F AA     		ld	(speed+1),a
7430  A92B CD C7 A9     		call	add_offset.de
7431  A92E 7E           		ld	a,(hl)
7432  A92F 32 14 AA     		ld	(song_length+1),a
7433  A932 23           		inc	hl
7434  A933 7E           		ld	a,(hl)
7435  A934 32 23 AA     		ld	(loop_position+1),a
7436  A937 23           		inc	hl
7437  A938 22 29 AA     		ld	(positions+1),hl
7438  A93B CD C6 A9     		call	add_offset
7439  A93E 22 31 AA     		ld	(patterns+1),hl
7440  A941 E5           		push	hl
7441  A942 CD C6 A9     		call	add_offset
7442  A945 22 DD AC     		ld	(ChA.ornoffs+1),hl
7443  A948 22 F6 AB     		ld	(ChB.ornoffs+1),hl
7444  A94B 22 11 AB     		ld	(ChC.ornoffs+1),hl
7445  A94E CD C6 A9     		call	add_offset
7446  A951 22 80 AC     		ld	(ChA.smpoffs+1),hl
7447  A954 22 99 AB     		ld	(ChB.smpoffs+1),hl
7448  A957 22 C4 AA     		ld	(ChC.smpoffs+1),hl
7449  A95A EB           		ex	de,hl
7450  A95B 7E           		ld	a,(hl)
7451  A95C 36 00        		ld	(hl),0
7452  A95E E1           		pop	hl
7453  A95F B7           		or	a
7454  A960 28 0D        		jr	z,.noreloc
7455  A962
7456  A962 CD C7 A9     .relocator:	call	add_offset.de
7457  A965 EB           		ex	de,hl
7458  A966 2B           		dec	hl
7459  A967 72           		ld	(hl),d
7460  A968 2B           		dec	hl
7461  A969 73           		ld	(hl),e
7462  A96A 23           		inc	hl
7463  A96B 23           		inc	hl
7464  A96C 3D           		dec	a
7465  A96D 20 F3        		jr	nz,.relocator
7466  A96F
7467  A96F 21 C2 B0     .noreloc:	ld	hl,empty_pattern
7468  A972 0E 03        		ld	c,3
7469  A974 22 20 AC     		ld	(ChA.datptr+1),hl
7470  A977 22 39 AB     		ld	(ChB.datptr+1),hl
7471  A97A 22 66 AA     		ld	(ChC.datptr+1),hl
7472  A97D 67           		ld	h,a
7473  A97E 6F           		ld	l,a
7474  A97F 22 80 AD     		ld	(ChA.Xportamnt+1),hl
7475  A982 22 3C AD     		ld	(ChB.Xportamnt+1),hl
7476  A985 22 7A AD     		ld	(ChA.Xpitch+1),hl
7477  A988 22 36 AD     		ld	(ChB.Xpitch+1),hl
7478  A98B 32 56 AA     		ld	(ChC.playback+2),a
7479  A98E
7480  A98E 32 D9 AD     		ld	(chkfadeout+1),a
7481  A991 32 EF AD     		ld	(apply_volume+1),a
7482  A994 32 70 AE     		ld	(ChA.attn+1),a
7483  A997 32 E2 AE     		ld	(ChB.attn+1),a
7484  A99A 32 57 AF     		ld	(ChC.attn+1),a
7485  A99D 3D           		dec	a
7486  A99E 32 11 AA     		ld	(current_pos+1),a
7487  A9A1 21 E2 A1     		ld	hl,music_setup
7488  A9A4 CB BE        		res	7,(hl)
7489  A9A6
7490  A9A6 AF           music_mute:	xor	a
7491  A9A7 32 95 AF     		ld	(AYREG_EnvSh+1),a
7492  A9AA 21 C7 B0     		ld	hl,AYREG_TonA
7493  A9AD 06 0D        		ld	b,#0D
7494  A9AF 77           .loopregs:	ld	(hl),a
7495  A9B0 23           		inc	hl
7496  A9B1 10 FC        		djnz	.loopregs
7497  A9B3 79           		ld	a,c
7498  A9B4 32 D2 B0     		ld	(tempocnt_0),a
7499  A9B7 01 FD FF     		ld	bc,#FFFD
7500  A9BA 3E 0C        		ld	a,#0C
7501  A9BC ED 79        		out	(c),a
7502  A9BE AF           		xor	a
7503  A9BF 06 BF        		ld	b,#BF
7504  A9C1 ED 79        		out	(c),a
7505  A9C3 C3 87 AF     		jp	outay
7506  A9C6
7507  A9C6 EB           add_offset	ex	de,hl
7508  A9C7 5E           .de		ld	e,(hl)
7509  A9C8 23           		inc	hl
7510  A9C9 56           		ld	d,(hl)
7511  A9CA 23           		inc	hl
7512  A9CB EB           		ex	de,hl
7513  A9CC 01 00 00     module_addr:	ld	bc,0
7514  A9CF 09           		add	hl,bc
7515  A9D0 C9           		ret
7516  A9D1
7517  A9D1              ; ---------------------------------------------------------------------------
7518  A9D1 21 E2 A1     resetfadeout:	ld	hl,music_setup
7519  A9D4 CB FE        noloop:		set	7,(hl)
7520  A9D6 AF           		xor	a
7521  A9D7 32 CD B0     		ld	(AYREG_AmplA),a
7522  A9DA 32 CE B0     		ld	(AYREG_AmplB),a
7523  A9DD 32 CF B0     		ld	(AYREG_AmplC),a
7524  A9E0 32 95 AF     		ld	(AYREG_EnvSh+1),a
7525  A9E3 3D           		dec	a
7526  A9E4 32 D2 B0     		ld	(tempocnt_0),a
7527  A9E7 32 D9 AD     		ld	(chkfadeout+1),a
7528  A9EA DD 2E 3F     		ld	xl,#3F
7529  A9ED C3 84 AF     		jp	retsp
7530  A9F0
7531  A9F0 3E 30        enablefade:	ld	a,48
7532  A9F2 32 D9 AD     forcefade:	ld	(chkfadeout+1),a
7533  A9F5 32 E5 AD     		ld	(countfadeout+1),a
7534  A9F8 32 18 AE     		ld	(divfadeout+1),a
7535  A9FB AF           		xor	a
7536  A9FC 32 EF AD     		ld	(apply_volume+1),a
7537  A9FF 18 21        		jr	loop_position
7538  AA01
7539  AA01              ; ---------------------------------------------------------------------------
7540  AA01 2A 39 AB     new_position:	ld	hl,(ChB.datptr+1)
7541  AA04 B6           		or	(hl)
7542  AA05 C2 D8 AD     		jp	nz,chkfadeout
7543  AA08 2A 66 AA     		ld	hl,(ChC.datptr+1)
7544  AA0B B6           		or	(hl)
7545  AA0C C2 D8 AD     		jp	nz,chkfadeout
7546  AA0F 47           		ld	b,a
7547  AA10 3E 00        current_pos:	ld	a,0
7548  AA12 3C           		inc	a
7549  AA13 FE 00        song_length:	cp	0
7550  AA15 20 0D        		jr	nz,song_continue
7551  AA17 21 E2 A1     		ld	hl,music_setup
7552  AA1A CB 4E        		bit	1,(hl)
7553  AA1C 20 D2        		jr	nz,enablefade
7554  AA1E CB 46        		bit	0,(hl)
7555  AA20 20 B2        		jr	nz,noloop
7556  AA22 3E 00        loop_position:	ld	a,0
7557  AA24 32 11 AA     song_continue:	ld	(current_pos+1),a
7558  AA27 4F           		ld	c,a
7559  AA28
7560  AA28 21 00 00     positions:	ld	hl,NULL
7561  AA2B 09           		add	hl,bc
7562  AA2C 09           		add	hl,bc
7563  AA2D 4E           		ld	c,(hl)
7564  AA2E 23           		inc	hl
7565  AA2F 7E           		ld	a,(hl)
7566  AA30
7567  AA30 21 00 00     patterns:	ld	hl,NULL
7568  AA33 09           		add	hl,bc
7569  AA34 F9           		ld	sp,hl
7570  AA35 E1           		pop	hl
7571  AA36 22 20 AC     		ld	(ChA.datptr+1),hl
7572  AA39 E1           		pop	hl
7573  AA3A 22 39 AB     		ld	(ChB.datptr+1),hl
7574  AA3D E1           		pop	hl
7575  AA3E 22 66 AA     		ld	(ChC.datptr+1),hl
7576  AA41 C6 60        		add	a,#60
7577  AA43 32 56 AA     		ld	(ChC.playback+2),a
7578  AA46 47           		ld	b,a
7579  AA47 0E F0        		ld	c,#F0
7580  AA49 C3 1F AC     		jp	ChA.datptr
7581  AA4C
7582  AA4C              ; ----------------------------------------------------------------------------
7583  AA4C F3           music_play:	di
7584  AA4D ED 73 85 AF  		ld	(retsp+1),sp
7585  AA51 16 00        		ld	d,0
7586  AA53 D9           		exx
7587  AA54 01 F0 60     ChC.playback:	ld	bc,#60F0
7588  AA57 21 D2 B0     		ld	hl,tempocnt_0
7589  AA5A 35           		dec	(hl)
7590  AA5B C2 2C AB     		jp	nz,ChB.playback
7591  AA5E 36 00        @speed:		ld	(hl),0
7592  AA60 23           		inc	hl
7593  AA61 35           		dec	(hl)
7594  AA62 F2 29 AD     		jp	p,ChB.Xsmpptr
7595  AA65 21 00 00     ChC.datptr:	ld	hl,NULL
7596  AA68 B6           		or	(hl)
7597  AA69 CA 29 AD     		jp	z,ChB.Xsmpptr
7598  AA6C 7E           ChC.readpatt:	ld	a,(hl)
7599  AA6D 23           		inc	hl
7600  AA6E FE C0        		cp	#C0
7601  AA70 38 0E        		jr	c,ChC.nocmd
7602  AA72 91           		sub	c
7603  AA73 30 38        		jr	nc,ChC.setvol
7604  AA75 91           		sub	c
7605  AA76 D2 21 AD     		jp	nc,ChC.nop
7606  AA79 91           		sub	c
7607  AA7A 30 39        		jr	nc,ChC.setrst
7608  AA7C 91           		sub	c
7609  AA7D C3 E3 AA     		jp	ChC.setenv
7610  AA80
7611  AA80 D6 80        ChC.nocmd:	sub	#80
7612  AA82 30 59        		jr	nc,ChC.setspd
7613  AA84 91           		sub	c
7614  AA85 D2 08 AB     		jp	nc,ChC.setorn
7615  AA88 99           		sbc	a,c
7616  AA89 30 35        		jr	nc,ChC.setsmp
7617  AA8B 80           		add	a,b
7618  AA8C 32 23 AF     		ld	(ChC.note+1),a
7619  AA8F 22 66 AA     		ld	(ChC.datptr+1),hl
7620  AA92 AF           		xor	a
7621  AA93 32 2D AF     		ld	(ChC.smppos+1),a
7622  AA96 32 11 AF     		ld	(ChC.ornpos+1),a
7623  AA99 6F           		ld	l,a
7624  AA9A 67           		ld	h,a
7625  AA9B 22 71 AF     		ld	(ChC.pitch+1),hl
7626  AA9E C3 24 AD     		jp	ChC.exit
7627  AAA1
7628  AAA1 7E           ChC.setport:	ld	a,(hl)
7629  AAA2 23           		inc	hl
7630  AAA3 32 74 AF     		ld	(ChC.portamnt+1),a
7631  AAA6 17           		rla
7632  AAA7 9F           		sbc	a,a
7633  AAA8 32 75 AF     		ld	(ChC.portamnt+2),a
7634  AAAB 18 BF        		jr	ChC.readpatt
7635  AAAD
7636  AAAD 28 F2        ChC.setvol:	jr	z,ChC.setport
7637  AAAF 3D           		dec	a
7638  AAB0 32 4B AF     		ld	(ChC.volume+1),a
7639  AAB3 18 B7        		jr	ChC.readpatt
7640  AAB5
7641  AAB5 3E FC        ChC.setrst:	ld	a,#FC
7642  AAB7 32 2D AF     		ld	(ChC.smppos+1),a
7643  AABA 22 66 AA     		ld	(ChC.datptr+1),hl
7644  AABD C3 24 AD     		jp	ChC.exit
7645  AAC0
7646  AAC0 87           ChC.setsmp:	add	a,a
7647  AAC1 D9           		exx
7648  AAC2 5F           		ld	e,a
7649  AAC3 21 00 00     ChC.smpoffs:	ld	hl,NULL
7650  AAC6 19           		add	hl,de
7651  AAC7 F9           		ld	sp,hl
7652  AAC8 E1           		pop	hl
7653  AAC9 7E           		ld	a,(hl)
7654  AACA 87           		add	a,a
7655  AACB 87           		add	a,a
7656  AACC 32 3E AF     		ld	(ChC.smploop+1),a
7657  AACF 23           		inc	hl
7658  AAD0 7E           		ld	a,(hl)
7659  AAD1 87           		add	a,a
7660  AAD2 87           		add	a,a
7661  AAD3 32 3A AF     		ld	(ChC.smplen+1),a
7662  AAD6 22 2F AF     		ld	(ChC.smpptr+1),hl
7663  AAD9 D9           		exx
7664  AADA C3 6C AA     		jp	ChC.readpatt
7665  AADD
7666  AADD 32 25 AD     ChC.setspd:	ld	(ChC.exit+1),a
7667  AAE0 C3 6C AA     		jp	ChC.readpatt
7668  AAE3
7669  AAE3 32 B2 AD     ChC.setenv:	ld	(env.shape+1),a
7670  AAE6 3E 1F        		ld	a,#1F
7671  AAE8 32 5D AF     		ld	(ChC.ampl+1),a
7672  AAEB 7E           		ld	a,(hl)
7673  AAEC 23           		inc	hl
7674  AAED 32 B7 AD     		ld	(env.period+1),a
7675  AAF0 11 BF B0     		ld	de,empty_orn
7676  AAF3 ED 53 14 AF  		ld	(ChC.ornptr+1),de
7677  AAF7 AF           		xor	a
7678  AAF8 32 1E AF     		ld	(ChC.ornloop+1),a
7679  AAFB 32 74 AF     		ld	(ChC.portamnt+1),a
7680  AAFE 32 75 AF     		ld	(ChC.portamnt+2),a
7681  AB01 3C           		inc	a
7682  AB02 32 1A AF     		ld	(ChC.ornlen+1),a
7683  AB05 C3 6C AA     		jp	ChC.readpatt
7684  AB08
7685  AB08 87           ChC.setorn:	add	a,a
7686  AB09 D9           		exx
7687  AB0A 5F           		ld	e,a
7688  AB0B 3E 0F        		ld	a,#0F
7689  AB0D 32 5D AF     		ld	(ChC.ampl+1),a
7690  AB10 21 00 00     ChC.ornoffs:	ld	hl,NULL
7691  AB13 19           		add	hl,de
7692  AB14 F9           		ld	sp,hl
7693  AB15 E1           		pop	hl
7694  AB16 7E           		ld	a,(hl)
7695  AB17 32 1E AF     		ld	(ChC.ornloop+1),a
7696  AB1A 23           		inc	hl
7697  AB1B 7E           		ld	a,(hl)
7698  AB1C 32 1A AF     		ld	(ChC.ornlen+1),a
7699  AB1F 23           		inc	hl
7700  AB20 22 14 AF     		ld	(ChC.ornptr+1),hl
7701  AB23 6A           		ld	l,d
7702  AB24 62           		ld	h,d
7703  AB25 22 74 AF     		ld	(ChC.portamnt+1),hl
7704  AB28 D9           		exx
7705  AB29 C3 6C AA     		jp	ChC.readpatt
7706  AB2C
7707  AB2C              ; ---------------------------------------------------------------------------
7708  AB2C 7E           ChB.playback:	ld	a,(hl)
7709  AB2D 3D           		dec	a
7710  AB2E C2 16 AC     		jp	nz,ChA.playback
7711  AB31 21 D0 B0     		ld	hl,tempocnt_2
7712  AB34 35           		dec	(hl)
7713  AB35 F2 D8 AD     		jp	p,chkfadeout
7714  AB38 21 00 00     ChB.datptr:	ld	hl,NULL
7715  AB3B B6           		or	(hl)
7716  AB3C CA D8 AD     		jp	z,chkfadeout
7717  AB3F 7E           ChB.readpatt:	ld	a,(hl)
7718  AB40 23           		inc	hl
7719  AB41 FE C0        		cp	#C0
7720  AB43 38 0C        		jr	c,ChB.nocmd
7721  AB45 91           		sub	c
7722  AB46 30 30        		jr	nc,ChB.setvol
7723  AB48 91           		sub	c
7724  AB49 30 35        		jr	nc,ChB.nop
7725  AB4B 91           		sub	c
7726  AB4C 30 3D        		jr	nc,ChB.setrst
7727  AB4E 91           		sub	c
7728  AB4F 18 65        		jr	ChB.setenv
7729  AB51
7730  AB51 D6 80        ChB.nocmd:	sub	#80
7731  AB53 30 5C        		jr	nc,ChB.setspd
7732  AB55 91           		sub	c
7733  AB56 D2 ED AB     		jp	nc,ChB.setorn
7734  AB59 99           		sbc	a,c
7735  AB5A 30 39        		jr	nc,ChB.setsmp
7736  AB5C 80           		add	a,b
7737  AB5D 32 60 AD     		ld	(ChB.Xnote+1),a
7738  AB60 22 39 AB     		ld	(ChB.datptr+1),hl
7739  AB63 AF           		xor	a
7740  AB64 32 65 AD     		ld	(ChB.Xsmppos+1),a
7741  AB67 6F           		ld	l,a
7742  AB68 67           		ld	h,a
7743  AB69 22 36 AD     		ld	(ChB.Xpitch+1),hl
7744  AB6C 3E 22        		ld	a,#22
7745  AB6E 32 38 AD     		ld	(ChB.Xinst1),a
7746  AB71 3E 32        		ld	a,#32
7747  AB73 32 C2 AD     		ld	(ChB.Xinst2),a
7748  AB76 18 0B        		jr	ChB.exit
7749  AB78
7750  AB78 28 66        ChB.setvol:	jr	z,ChB.setport
7751  AB7A 3D           		dec	a
7752  AB7B 32 56 AD     		ld	(ChB.Xvolume+1),a
7753  AB7E 18 BF        		jr	ChB.readpatt
7754  AB80
7755  AB80 22 39 AB     ChB.nop:	ld	(ChB.datptr+1),hl
7756  AB83 3E 00        ChB.exit:	ld	a,0
7757  AB85 32 D0 B0     		ld	(tempocnt_2),a
7758  AB88 C3 D8 AD     		jp	chkfadeout
7759  AB8B
7760  AB8B 3E FC        ChB.setrst:	ld	a,#FC
7761  AB8D 32 65 AD     		ld	(ChB.Xsmppos+1),a
7762  AB90 22 39 AB     		ld	(ChB.datptr+1),hl
7763  AB93 18 EE        		jr	ChB.exit
7764  AB95
7765  AB95 87           ChB.setsmp:	add	a,a
7766  AB96 D9           		exx
7767  AB97 5F           		ld	e,a
7768  AB98 21 00 00     ChB.smpoffs:	ld	hl,NULL
7769  AB9B 19           		add	hl,de
7770  AB9C F9           		ld	sp,hl
7771  AB9D E1           		pop	hl
7772  AB9E 7E           		ld	a,(hl)
7773  AB9F 87           		add	a,a
7774  ABA0 87           		add	a,a
7775  ABA1 32 51 AD     		ld	(ChB.Xsmploop+1),a
7776  ABA4 23           		inc	hl
7777  ABA5 7E           		ld	a,(hl)
7778  ABA6 87           		add	a,a
7779  ABA7 87           		add	a,a
7780  ABA8 32 47 AD     		ld	(ChB.Xsmplen+1),a
7781  ABAB 22 2A AD     		ld	(ChB.Xsmpptr+1),hl
7782  ABAE D9           		exx
7783  ABAF 18 8E        		jr	ChB.readpatt
7784  ABB1
7785  ABB1 32 84 AB     ChB.setspd:	ld	(ChB.exit+1),a
7786  ABB4 18 89        		jr	ChB.readpatt
7787  ABB6
7788  ABB6 32 B2 AD     ChB.setenv:	ld	(env.shape+1),a
7789  ABB9 3E 1F        		ld	a,#1F
7790  ABBB 32 5B AD     		ld	(ChB.Xampl+1),a
7791  ABBE 7E           		ld	a,(hl)
7792  ABBF 23           		inc	hl
7793  ABC0 32 B7 AD     		ld	(env.period+1),a
7794  ABC3 11 BF B0     		ld	de,empty_orn
7795  ABC6 ED 53 30 AD  		ld	(ChB.Xornptr+1),de
7796  ABCA 3E 22        		ld	a,#22
7797  ABCC 32 3E AD     		ld	(ChB.Xinst3),a
7798  ABCF AF           		xor	a
7799  ABD0 32 4C AD     		ld	(ChB.Xornloop+1),a
7800  ABD3 32 3C AD     		ld	(ChB.Xportamnt+1),a
7801  ABD6 32 3D AD     		ld	(ChB.Xportamnt+2),a
7802  ABD9 3C           		inc	a
7803  ABDA 32 42 AD     		ld	(ChB.Xornlen+1),a
7804  ABDD C3 3F AB     		jp	ChB.readpatt
7805  ABE0
7806  ABE0 7E           ChB.setport:	ld	a,(hl)
7807  ABE1 23           		inc	hl
7808  ABE2 32 3C AD     		ld	(ChB.Xportamnt+1),a
7809  ABE5 17           		rla
7810  ABE6 9F           		sbc	a,a
7811  ABE7 32 3D AD     		ld	(ChB.Xportamnt+2),a
7812  ABEA C3 3F AB     		jp	ChB.readpatt
7813  ABED
7814  ABED 87           ChB.setorn:	add	a,a
7815  ABEE D9           		exx
7816  ABEF 5F           		ld	e,a
7817  ABF0 3E 0F        		ld	a,#0F
7818  ABF2 32 5B AD     		ld	(ChB.Xampl+1),a
7819  ABF5 21 00 00     ChB.ornoffs:	ld	hl,NULL
7820  ABF8 19           		add	hl,de
7821  ABF9 F9           		ld	sp,hl
7822  ABFA E1           		pop	hl
7823  ABFB 7E           		ld	a,(hl)
7824  ABFC 32 4C AD     		ld	(ChB.Xornloop+1),a
7825  ABFF 23           		inc	hl
7826  AC00 7E           		ld	a,(hl)
7827  AC01 32 42 AD     		ld	(ChB.Xornlen+1),a
7828  AC04 23           		inc	hl
7829  AC05 22 30 AD     		ld	(ChB.Xornptr+1),hl
7830  AC08 6A           		ld	l,d
7831  AC09 62           		ld	h,d
7832  AC0A 22 3C AD     		ld	(ChB.Xportamnt+1),hl
7833  AC0D 3E 22        		ld	a,#22
7834  AC0F 32 3E AD     		ld	(ChB.Xinst3),a
7835  AC12 D9           		exx
7836  AC13 C3 3F AB     		jp	ChB.readpatt
7837  AC16
7838  AC16              ; ---------------------------------------------------------------------------
7839  AC16 3D           ChA.playback:	dec	a
7840  AC17 C2 D8 AD     		jp	nz,chkfadeout
7841  AC1A 2B           		dec	hl
7842  AC1B 35           		dec	(hl)
7843  AC1C F2 D8 AD     		jp	p,chkfadeout
7844  AC1F 21 00 00     ChA.datptr:	ld	hl,NULL
7845  AC22 B6           		or	(hl)
7846  AC23 CA 01 AA     		jp	z,new_position
7847  AC26 7E           ChA.readpatt:	ld	a,(hl)
7848  AC27 23           		inc	hl
7849  AC28 FE C0        		cp	#C0
7850  AC2A 38 0C        		jr	c,ChA.nocmd
7851  AC2C 91           		sub	c
7852  AC2D 30 30        		jr	nc,ChA.setvol
7853  AC2F 91           		sub	c
7854  AC30 30 35        		jr	nc,ChA.nop
7855  AC32 91           		sub	c
7856  AC33 30 3D        		jr	nc,ChA.setrst
7857  AC35 91           		sub	c
7858  AC36 18 65        		jr	ChA.setenv
7859  AC38
7860  AC38 D6 80        ChA.nocmd:	sub	#80
7861  AC3A 30 5C        		jr	nc,ChA.setspd
7862  AC3C 91           		sub	c
7863  AC3D D2 D4 AC     		jp	nc,ChA.setorn
7864  AC40 99           		sbc	a,c
7865  AC41 30 39        		jr	nc,ChA.setsmp
7866  AC43 80           		add	a,b
7867  AC44 32 A4 AD     		ld	(ChA.Xnote+1),a
7868  AC47 22 20 AC     		ld	(ChA.datptr+1),hl
7869  AC4A AF           		xor	a
7870  AC4B 32 A9 AD     		ld	(ChA.Xsmppos+1),a
7871  AC4E 6F           		ld	l,a
7872  AC4F 67           		ld	h,a
7873  AC50 22 7A AD     		ld	(ChA.Xpitch+1),hl
7874  AC53 3E 22        		ld	a,#22
7875  AC55 32 7C AD     		ld	(ChA.Xinst1),a
7876  AC58 3E 32        		ld	a,#32
7877  AC5A 32 BF AD     		ld	(ChA.Xinst2),a
7878  AC5D 18 0B        		jr	ChA.exit
7879  AC5F
7880  AC5F 28 66        ChA.setvol:	jr	z,ChA.setport
7881  AC61 3D           		dec	a
7882  AC62 32 9A AD     		ld	(ChA.Xvolume+1),a
7883  AC65 18 BF        		jr	ChA.readpatt
7884  AC67
7885  AC67 22 20 AC     ChA.nop:	ld	(ChA.datptr+1),hl
7886  AC6A 3E 00        ChA.exit:	ld	a,0
7887  AC6C 32 D1 B0     		ld	(tempocnt_1),a
7888  AC6F C3 D8 AD     		jp	chkfadeout
7889  AC72
7890  AC72 3E FC        ChA.setrst:	ld	a,#FC
7891  AC74 32 A9 AD     		ld	(ChA.Xsmppos+1),a
7892  AC77 22 20 AC     		ld	(ChA.datptr+1),hl
7893  AC7A 18 EE        		jr	ChA.exit
7894  AC7C
7895  AC7C 87           ChA.setsmp:	add	a,a
7896  AC7D D9           		exx
7897  AC7E 5F           		ld	e,a
7898  AC7F 21 00 00     ChA.smpoffs:	ld	hl,NULL
7899  AC82 19           		add	hl,de
7900  AC83 F9           		ld	sp,hl
7901  AC84 E1           		pop	hl
7902  AC85 7E           		ld	a,(hl)
7903  AC86 87           		add	a,a
7904  AC87 87           		add	a,a
7905  AC88 32 95 AD     		ld	(ChA.Xsmploop+1),a
7906  AC8B 23           		inc	hl
7907  AC8C 7E           		ld	a,(hl)
7908  AC8D 87           		add	a,a
7909  AC8E 87           		add	a,a
7910  AC8F 32 8B AD     		ld	(ChA.Xsmplen+1),a
7911  AC92 22 6E AD     		ld	(ChA.Xsmpptr+1),hl
7912  AC95 D9           		exx
7913  AC96 18 8E        		jr	ChA.readpatt
7914  AC98
7915  AC98 32 6B AC     ChA.setspd:	ld	(ChA.exit+1),a
7916  AC9B 18 89        		jr	ChA.readpatt
7917  AC9D
7918  AC9D 32 B2 AD     ChA.setenv:	ld	(env.shape+1),a
7919  ACA0 3E 1F        		ld	a,#1F
7920  ACA2 32 9F AD     		ld	(ChA.Xampl+1),a
7921  ACA5 7E           		ld	a,(hl)
7922  ACA6 23           		inc	hl
7923  ACA7 32 B7 AD     		ld	(env.period+1),a
7924  ACAA 11 BF B0     		ld	de,empty_orn
7925  ACAD ED 53 74 AD  		ld	(ChA.Xornptr+1),de
7926  ACB1 3E 22        		ld	a,#22
7927  ACB3 32 82 AD     		ld	(ChA.Xinst3),a
7928  ACB6 AF           		xor	a
7929  ACB7 32 90 AD     		ld	(ChA.Xornloop+1),a
7930  ACBA 32 80 AD     		ld	(ChA.Xportamnt+1),a
7931  ACBD 32 81 AD     		ld	(ChA.Xportamnt+2),a
7932  ACC0 3C           		inc	a
7933  ACC1 32 86 AD     		ld	(ChA.Xornlen+1),a
7934  ACC4 C3 26 AC     		jp	ChA.readpatt
7935  ACC7
7936  ACC7 7E           ChA.setport:	ld	a,(hl)
7937  ACC8 23           		inc	hl
7938  ACC9 32 80 AD     		ld	(ChA.Xportamnt+1),a
7939  ACCC 17           		rla
7940  ACCD 9F           		sbc	a,a
7941  ACCE 32 81 AD     		ld	(ChA.Xportamnt+2),a
7942  ACD1 C3 26 AC     		jp	ChA.readpatt
7943  ACD4
7944  ACD4 87           ChA.setorn:	add	a,a
7945  ACD5 D9           		exx
7946  ACD6 5F           		ld	e,a
7947  ACD7 3E 0F        		ld	a,#0F
7948  ACD9 32 9F AD     		ld	(ChA.Xampl+1),a
7949  ACDC 21 00 00     ChA.ornoffs:	ld	hl,NULL
7950  ACDF 19           		add	hl,de
7951  ACE0 F9           		ld	sp,hl
7952  ACE1 E1           		pop	hl
7953  ACE2 7E           		ld	a,(hl)
7954  ACE3 32 90 AD     		ld	(ChA.Xornloop+1),a
7955  ACE6 23           		inc	hl
7956  ACE7 7E           		ld	a,(hl)
7957  ACE8 32 86 AD     		ld	(ChA.Xornlen+1),a
7958  ACEB 23           		inc	hl
7959  ACEC 22 74 AD     		ld	(ChA.Xornptr+1),hl
7960  ACEF 6A           		ld	l,d
7961  ACF0 62           		ld	h,d
7962  ACF1 22 80 AD     		ld	(ChA.Xportamnt+1),hl
7963  ACF4 3E 22        		ld	a,#22
7964  ACF6 32 82 AD     		ld	(ChA.Xinst3),a
7965  ACF9 D9           		exx
7966  ACFA C3 26 AC     		jp	ChA.readpatt
7967  ACFD
7968  ACFD              ; ---------------------------------------------------------------------------
7969  ACFD AF           ChA.mute:	xor	a
7970  ACFE 32 CD B0     		ld	(AYREG_AmplA),a
7971  AD01 DD 2E 09     		ld	xl,9
7972  AD04 C3 9B AE     		jp	ChB.ornpos
7973  AD07
7974  AD07 AF           ChB.mute:	xor	a
7975  AD08 32 CE B0     		ld	(AYREG_AmplB),a
7976  AD0B DD 7D        		ld	a,xl
7977  AD0D F6 12        		or	#12
7978  AD0F DD 6F        		ld	xl,a
7979  AD11 C3 10 AF     		jp	ChC.ornpos
7980  AD14
7981  AD14 AF           ChC.mute:	xor	a
7982  AD15 32 CF B0     		ld	(AYREG_AmplC),a
7983  AD18 DD 7D        		ld	a,xl
7984  AD1A F6 24        		or	#24
7985  AD1C DD 6F        		ld	xl,a
7986  AD1E C3 84 AF     		jp	retsp
7987  AD21
7988  AD21              ; ---------------------------------------------------------------------------
7989  AD21 22 66 AA     ChC.nop:	ld	(ChC.datptr+1),hl
7990  AD24 3E 00        ChC.exit:	ld	a,0
7991  AD26 32 D3 B0     		ld	(pattstep_cnt),a
7992  AD29 21 00 00     ChB.Xsmpptr:	ld	hl,NULL
7993  AD2C 22 BA AE     		ld	(ChB.smpptr+1),hl
7994  AD2F 21 00 00     ChB.Xornptr:	ld	hl,NULL
7995  AD32 22 9F AE     		ld	(ChB.ornptr+1),hl
7996  AD35 21 00 00     ChB.Xpitch:	ld	hl,NULL
7997  AD38 22 FD AE     ChB.Xinst1:	ld	(ChB.pitch+1),hl
7998  AD3B 21 00 00     ChB.Xportamnt:	ld	hl,NULL
7999  AD3E 22 00 AF     ChB.Xinst3:	ld	(ChB.portamnt+1),hl
8000  AD41 3E 00        ChB.Xornlen:	ld	a,0
8001  AD43 32 A5 AE     		ld	(ChB.ornlen+1),a
8002  AD46 3E 00        ChB.Xsmplen:	ld	a,0
8003  AD48 32 C5 AE     		ld	(ChB.smplen+1),a
8004  AD4B 3E 00        ChB.Xornloop:	ld	a,0
8005  AD4D 32 A9 AE     		ld	(ChB.ornloop+1),a
8006  AD50 3E 00        ChB.Xsmploop:	ld	a,0
8007  AD52 32 C9 AE     		ld	(ChB.smploop+1),a
8008  AD55 3E 00        ChB.Xvolume:	ld	a,0
8009  AD57 32 D6 AE     		ld	(ChB.volume+1),a
8010  AD5A 3E 0F        ChB.Xampl:	ld	a,#0F
8011  AD5C 32 E8 AE     		ld	(ChB.ampl+1),a
8012  AD5F 3E 00        ChB.Xnote:	ld	a,0
8013  AD61 32 AE AE     		ld	(ChB.note+1),a
8014  AD64 3E 00        ChB.Xsmppos:	ld	a,0
8015  AD66 FE 01        		cp	1
8016  AD68 28 03        		jr	z,ChA.Xsmpptr
8017  AD6A 32 B8 AE     		ld	(ChB.smppos+1),a
8018  AD6D 21 00 00     ChA.Xsmpptr:	ld	hl,NULL
8019  AD70 22 48 AE     		ld	(ChA.smpptr+1),hl
8020  AD73 21 00 00     ChA.Xornptr:	ld	hl,NULL
8021  AD76 22 2D AE     		ld	(ChA.ornptr+1),hl
8022  AD79 21 00 00     ChA.Xpitch:	ld	hl,NULL
8023  AD7C 22 81 AE     ChA.Xinst1:	ld	(ChA.pitch+1),hl
8024  AD7F 21 00 00     ChA.Xportamnt:	ld	hl,NULL
8025  AD82 22 84 AE     ChA.Xinst3:	ld	(ChA.portamnt+1),hl
8026  AD85 3E 00        ChA.Xornlen:	ld	a,0
8027  AD87 32 33 AE     		ld	(ChA.ornlen+1),a
8028  AD8A 3E 00        ChA.Xsmplen:	ld	a,0
8029  AD8C 32 53 AE     		ld	(ChA.smplen+1),a
8030  AD8F 3E 00        ChA.Xornloop:	ld	a,0
8031  AD91 32 37 AE     		ld	(ChA.ornloop+1),a
8032  AD94 3E 00        ChA.Xsmploop:	ld	a,0
8033  AD96 32 57 AE     		ld	(ChA.smploop+1),a
8034  AD99 3E 00        ChA.Xvolume:	ld	a,0
8035  AD9B 32 64 AE     		ld	(ChA.volume+1),a
8036  AD9E 3E 0F        ChA.Xampl:	ld	a,#0F
8037  ADA0 32 76 AE     		ld	(ChA.ampl+1),a
8038  ADA3 3E 00        ChA.Xnote:	ld	a,0
8039  ADA5 32 3C AE     		ld	(ChA.note+1),a
8040  ADA8 3E 00        ChA.Xsmppos:	ld	a,0
8041  ADAA FE 01        		cp	1
8042  ADAC 28 03        		jr	z,env.shape
8043  ADAE 32 46 AE     		ld	(ChA.smppos+1),a
8044  ADB1 3E 00        env.shape:	ld	a,0
8045  ADB3 32 95 AF     		ld	(AYREG_EnvSh+1),a
8046  ADB6 3E 00        env.period:	ld	a,0
8047  ADB8 32 A3 AF     		ld	(AYREG_Env+1),a
8048  ADBB AF           		xor	a
8049  ADBC 32 B2 AD     		ld	(env.shape+1),a
8050  ADBF 32 2A AE     ChA.Xinst2:	ld	(ChA.ornpos+1),a
8051  ADC2 32 9C AE     ChB.Xinst2:	ld	(ChB.ornpos+1),a
8052  ADC5 3C           		inc	a
8053  ADC6 32 A9 AD     		ld	(ChA.Xsmppos+1),a
8054  ADC9 32 BF AD     		ld	(ChA.Xinst2),a
8055  ADCC 32 65 AD     		ld	(ChB.Xsmppos+1),a
8056  ADCF 32 C2 AD     		ld	(ChB.Xinst2),a
8057  ADD2 32 7C AD     		ld	(ChA.Xinst1),a
8058  ADD5 32 38 AD     		ld	(ChB.Xinst1),a
8059  ADD8
8060  ADD8              ; ---------------------------------------------------------------------------
8061  ADD8 3E 00        chkfadeout:	ld	a,0
8062  ADDA B7           		or	a
8063  ADDB 28 4C        		jr	z,ChA.ornpos
8064  ADDD 3A E2 A1     		ld	a,(music_setup)
8065  ADE0 07           		rlca
8066  ADE1 DA 84 AF     		jp	c,retsp
8067  ADE4 3E 00        countfadeout:	ld	a,0
8068  ADE6 3D           		dec	a
8069  ADE7 32 E5 AD     		ld	(countfadeout+1),a
8070  ADEA 20 3D        		jr	nz,ChA.ornpos
8071  ADEC 1E 10        		ld	e,16
8072  ADEE 3E 00        apply_volume:	ld	a,0
8073  ADF0 3C           		inc	a
8074  ADF1 BB           		cp	e
8075  ADF2 CA D1 A9     		jp	z,resetfadeout
8076  ADF5 32 EF AD     		ld	(apply_volume+1),a
8077  ADF8 32 70 AE     		ld	(ChA.attn+1),a
8078  ADFB 32 E2 AE     		ld	(ChB.attn+1),a
8079  ADFE 32 57 AF     		ld	(ChC.attn+1),a
8080  AE01 CB 5F        		bit	3,a			; if value of attenuation
8081  AE03 28 12        		jr	z,divfadeout		; hits the 8 we turn off
8082  AE05 AF           		xor	a			; also hw envelopes
8083  AE06 32 B2 AD     		ld	(env.shape+1),a
8084  AE09 32 95 AF     		ld	(AYREG_EnvSh+1),a
8085  AE0C 7B           		ld	a,e
8086  AE0D 3D           		dec	a
8087  AE0E 32 76 AE     		ld	(ChA.ampl+1),a
8088  AE11 32 E8 AE     		ld	(ChB.ampl+1),a
8089  AE14 32 5D AF     		ld	(ChC.ampl+1),a
8090  AE17 3E 00        divfadeout:	ld	a,0
8091  AE19 CB 3F        		srl	a
8092  AE1B 5F           		ld	e,a
8093  AE1C CB 3B        		srl	e
8094  AE1E 83           		add	a,e
8095  AE1F 20 01        		jr	nz,divfadeout1
8096  AE21 3C           		inc	a
8097  AE22 32 18 AE     divfadeout1:	ld	(divfadeout+1),a
8098  AE25 87           		add	a,a
8099  AE26 32 E5 AD     		ld	(countfadeout+1),a
8100  AE29
8101  AE29 11 00 00     ChA.ornpos:	ld	de,0
8102  AE2C 21 00 00     ChA.ornptr:	ld	hl,NULL
8103  AE2F 19           		add	hl,de
8104  AE30 1C           		inc	e
8105  AE31 7B           		ld	a,e
8106  AE32 FE 00        ChA.ornlen:	cp	0
8107  AE34 20 02        		jr	nz,ChA.readorn
8108  AE36 3E 00        ChA.ornloop:	ld	a,0
8109  AE38 32 2A AE     ChA.readorn:	ld	(ChA.ornpos+1),a
8110  AE3B 3E 00        ChA.note:	ld	a,0
8111  AE3D 86           		add	a,(hl)
8112  AE3E 87           		add	a,a
8113  AE3F 5F           		ld	e,a
8114  AE40 21 FF AF     		ld	hl,freqtable
8115  AE43 19           		add	hl,de
8116  AE44 F9           		ld	sp,hl
8117  AE45 3E 00        ChA.smppos:	ld	a,0
8118  AE47 21 00 00     ChA.smpptr:	ld	hl,NULL
8119  AE4A 3C           		inc	a
8120  AE4B FA FD AC     		jp	m,ChA.mute
8121  AE4E 5F           		ld	e,a
8122  AE4F 19           		add	hl,de
8123  AE50 C6 03        		add	a,3
8124  AE52 FE 00        ChA.smplen:	cp	0
8125  AE54 20 02        		jr	nz,ChA.readsmp
8126  AE56 3E 00        ChA.smploop:	ld	a,0
8127  AE58 32 46 AE     ChA.readsmp:	ld	(ChA.smppos+1),a
8128  AE5B C1           		pop	bc
8129  AE5C F9           		ld	sp,hl
8130  AE5D D1           		pop	de
8131  AE5E 26 00        		ld	h,0
8132  AE60 7B           		ld	a,e
8133  AE61 E6 0F        		and	#0F
8134  AE63 D6 00        ChA.volume:	sub	0
8135  AE65 6F           		ld	l,a
8136  AE66 3F           		ccf
8137  AE67 9F           		sbc	a,a
8138  AE68 A5           		and	l
8139  AE69 CB 3A        		srl	d
8140  AE6B 30 02        		jr	nc,ChA.attn
8141  AE6D CB E4        		set	4,h
8142  AE6F D6 00        ChA.attn:	sub	0
8143  AE71 30 01        		jr	nc,ChA.attnn
8144  AE73 AF           		xor	a
8145  AE74 B4           ChA.attnn:	or	h
8146  AE75 E6 00        ChA.ampl:	and	0
8147  AE77 32 CD B0     		ld	(AYREG_AmplA),a
8148  AE7A 7B           		ld	a,e
8149  AE7B 07           		rlca
8150  AE7C 38 02        		jr	c,ChA.pitch
8151  AE7E DD 62        		ld	xh,d
8152  AE80 21 00 00     ChA.pitch:	ld	hl,NULL
8153  AE83 11 00 00     ChA.portamnt:	ld	de,0
8154  AE86 19           		add	hl,de
8155  AE87 22 81 AE     		ld	(ChA.pitch+1),hl
8156  AE8A 09           		add	hl,bc
8157  AE8B C1           		pop	bc
8158  AE8C 09           		add	hl,bc
8159  AE8D 07           		rlca
8160  AE8E 07           		rlca
8161  AE8F 07           		rlca
8162  AE90 E6 0F        		and	#0F
8163  AE92 DD 6F        		ld	xl,a
8164  AE94 7C           		ld	a,h
8165  AE95 E6 0F        		and	#0F
8166  AE97 67           		ld	h,a
8167  AE98 22 C7 B0     		ld	(AYREG_TonA),hl
8168  AE9B
8169  AE9B 11 00 00     ChB.ornpos:	ld	de,0
8170  AE9E 21 00 00     ChB.ornptr:	ld	hl,NULL
8171  AEA1 19           		add	hl,de
8172  AEA2 1C           		inc	e
8173  AEA3 7B           		ld	a,e
8174  AEA4 FE 00        ChB.ornlen:	cp	0
8175  AEA6 20 02        		jr	nz,ChB.readorn
8176  AEA8 3E 00        ChB.ornloop:	ld	a,0
8177  AEAA 32 9C AE     ChB.readorn:	ld	(ChB.ornpos+1),a
8178  AEAD 3E 00        ChB.note:	ld	a,0
8179  AEAF 86           		add	a,(hl)
8180  AEB0 87           		add	a,a
8181  AEB1 5F           		ld	e,a
8182  AEB2 21 FF AF     		ld	hl,freqtable
8183  AEB5 19           		add	hl,de
8184  AEB6 F9           		ld	sp,hl
8185  AEB7 3E 00        ChB.smppos:	ld	a,NULL
8186  AEB9 21 00 00     ChB.smpptr:	ld	hl,NULL
8187  AEBC 3C           		inc	a
8188  AEBD FA 07 AD     		jp	m,ChB.mute
8189  AEC0 5F           		ld	e,a
8190  AEC1 19           		add	hl,de
8191  AEC2 C6 03        		add	a,3
8192  AEC4 FE 00        ChB.smplen:	cp	0
8193  AEC6 20 02        		jr	nz,ChB.readsmp
8194  AEC8 3E 00        ChB.smploop:	ld	a,0
8195  AECA 32 B8 AE     ChB.readsmp:	ld	(ChB.smppos+1),a
8196  AECD C1           		pop	bc
8197  AECE F9           		ld	sp,hl
8198  AECF D1           		pop	de
8199  AED0 26 00        		ld	h,0
8200  AED2 7B           		ld	a,e
8201  AED3 E6 0F        		and	#0F
8202  AED5 D6 00        ChB.volume:	sub	0
8203  AED7 6F           		ld	l,a
8204  AED8 3F           		ccf
8205  AED9 9F           		sbc	a,a
8206  AEDA A5           		and	l
8207  AEDB CB 3A        		srl	d
8208  AEDD 30 02        		jr	nc,ChB.attn
8209  AEDF CB E4        		set	4,h
8210  AEE1 D6 00        ChB.attn:	sub	0
8211  AEE3 30 01        		jr	nc,ChB.attnn
8212  AEE5 AF           		xor	a
8213  AEE6 B4           ChB.attnn:	or	h
8214  AEE7 E6 00        ChB.ampl:	and	0
8215  AEE9 32 CE B0     		ld	(AYREG_AmplB),a
8216  AEEC 7B           		ld	a,e
8217  AEED 0F           		rrca
8218  AEEE 0F           		rrca
8219  AEEF 0F           		rrca
8220  AEF0 E6 1E        		and	#1E
8221  AEF2 DD B5        		or	xl
8222  AEF4 DD 6F        		ld	xl,a
8223  AEF6 E6 10        		and	#10
8224  AEF8 20 02        		jr	nz,ChB.pitch
8225  AEFA DD 62        		ld	xh,d
8226  AEFC 21 00 00     ChB.pitch:	ld	hl,NULL
8227  AEFF 11 00 00     ChB.portamnt:	ld	de,0
8228  AF02 19           		add	hl,de
8229  AF03 22 FD AE     		ld	(ChB.pitch+1),hl
8230  AF06 09           		add	hl,bc
8231  AF07 C1           		pop	bc
8232  AF08 09           		add	hl,bc
8233  AF09 7C           		ld	a,h
8234  AF0A E6 0F        		and	#0F
8235  AF0C 67           		ld	h,a
8236  AF0D 22 C9 B0     		ld	(AYREG_TonB),hl
8237  AF10
8238  AF10 11 00 00     ChC.ornpos:	ld	de,0
8239  AF13 21 00 00     ChC.ornptr:	ld	hl,NULL
8240  AF16 19           		add	hl,de
8241  AF17 1C           		inc	e
8242  AF18 7B           		ld	a,e
8243  AF19 FE 00        ChC.ornlen:	cp	0
8244  AF1B 20 02        		jr	nz,ChC.readorn
8245  AF1D 3E 00        ChC.ornloop:	ld	a,0
8246  AF1F 32 11 AF     ChC.readorn:	ld	(ChC.ornpos+1),a
8247  AF22 3E 00        ChC.note:	ld	a,0
8248  AF24 86           		add	a,(hl)
8249  AF25 87           		add	a,a
8250  AF26 5F           		ld	e,a
8251  AF27 21 FF AF     		ld	hl,freqtable
8252  AF2A 19           		add	hl,de
8253  AF2B F9           		ld	sp,hl
8254  AF2C 3E 00        ChC.smppos:	ld	a,0
8255  AF2E 21 00 00     ChC.smpptr:	ld	hl,NULL
8256  AF31 3C           		inc	a
8257  AF32 FA 14 AD     		jp	m,ChC.mute
8258  AF35 5F           		ld	e,a
8259  AF36 19           		add	hl,de
8260  AF37 C6 03        		add	a,3
8261  AF39 FE 00        ChC.smplen:	cp	0
8262  AF3B 20 02        		jr	nz,ChC.readsmp
8263  AF3D 3E 00        ChC.smploop:	ld	a,0
8264  AF3F 32 2D AF     ChC.readsmp:	ld	(ChC.smppos+1),a
8265  AF42 C1           		pop	bc
8266  AF43 F9           		ld	sp,hl
8267  AF44 D1           		pop	de
8268  AF45 26 00        		ld	h,0
8269  AF47 7B           		ld	a,e
8270  AF48 E6 0F        		and	#0F
8271  AF4A D6 00        ChC.volume:	sub	0
8272  AF4C 6F           		ld	l,a
8273  AF4D 3F           		ccf
8274  AF4E 9F           		sbc	a,a
8275  AF4F A5           		and	l
8276  AF50 CB 3A        		srl	d
8277  AF52 30 02        		jr	nc,ChC.attn
8278  AF54 CB E4        		set	4,h
8279  AF56 D6 00        ChC.attn:	sub	0
8280  AF58 30 01        		jr	nc,ChC.attnn
8281  AF5A AF           		xor	a
8282  AF5B B4           ChC.attnn:	or	h
8283  AF5C E6 00        ChC.ampl:	and	0
8284  AF5E 32 CF B0     		ld	(AYREG_AmplC),a
8285  AF61 7B           		ld	a,e
8286  AF62 0F           		rrca
8287  AF63 0F           		rrca
8288  AF64 E6 3C        		and	#3C
8289  AF66 DD B5        		or	xl
8290  AF68 DD 6F        		ld	xl,a
8291  AF6A E6 20        		and	#20
8292  AF6C 20 02        		jr	nz,ChC.pitch
8293  AF6E DD 62        		ld	xh,d
8294  AF70 21 00 00     ChC.pitch:	ld	hl,NULL
8295  AF73 11 00 00     ChC.portamnt:	ld	de,0
8296  AF76 19           		add	hl,de
8297  AF77 22 71 AF     		ld	(ChC.pitch+1),hl
8298  AF7A 09           		add	hl,bc
8299  AF7B C1           		pop	bc
8300  AF7C 09           		add	hl,bc
8301  AF7D 7C           		ld	a,h
8302  AF7E E6 0F        		and	#0F
8303  AF80 67           		ld	h,a
8304  AF81 22 CB B0     		ld	(AYREG_TonC),hl
8305  AF84 31 00 00     @retsp:		ld	sp,0
8306  AF87
8307  AF87 21 CF B0     outay:		ld	hl,AYREG_AmplC
8308  AF8A 11 BF FF     		ld	de,#FFBF
8309  AF8D 01 FD FF     		ld	bc,#FFFD
8310  AF90 3E 0D        		ld	a,#0D
8311  AF92 ED 79        		out	(c),a
8312  AF94 3E 00        AYREG_EnvSh:	ld	a,0
8313  AF96 B7           		or	a
8314  AF97 28 0E        		jr	z,noenvelopes
8315  AF99 43           		ld	b,e
8316  AF9A ED 79        		out	(c),a
8317  AF9C
8318  AF9C 3E 0B        		ld	a,#0B
8319  AF9E 42           		ld	b,d
8320  AF9F ED 79        		out	(c),a
8321  AFA1 43           		ld	b,e
8322  AFA2 3E 00        AYREG_Env:	ld	a,0
8323  AFA4 ED 79        		out	(c),a
8324  AFA6 42           		ld	b,d
8325  AFA7
8326  AFA7 3E 0A        noenvelopes:	ld	a,#0A
8327  AFA9 ED 79        		out	(c),a
8328  AFAB 43           		ld	b,e
8329  AFAC ED AB        		outd
8330  AFAE 3D           		dec	a
8331  AFAF 42           		ld	b,d
8332  AFB0 ED 79        		out	(c),a
8333  AFB2 43           		ld	b,e
8334  AFB3 ED AB        		outd
8335  AFB5 3D           		dec	a
8336  AFB6 42           		ld	b,d
8337  AFB7 ED 79        		out	(c),a
8338  AFB9 43           		ld	b,e
8339  AFBA ED AB        		outd
8340  AFBC 3D           		dec	a
8341  AFBD 42           		ld	b,d
8342  AFBE ED 79        		out	(c),a
8343  AFC0 43           		ld	b,e
8344  AFC1 DD 7D        		ld	a,xl
8345  AFC3 ED 79        		out	(c),a
8346  AFC5 3E 06        		ld	a,6
8347  AFC7 42           		ld	b,d
8348  AFC8 ED 79        		out	(c),a
8349  AFCA 43           		ld	b,e
8350  AFCB DD 7C        		ld	a,xh
8351  AFCD ED 79        		out	(c),a
8352  AFCF 3E 05        		ld	a,5
8353  AFD1 42           		ld	b,d
8354  AFD2 ED 79        		out	(c),a
8355  AFD4 43           		ld	b,e
8356  AFD5 ED AB        		outd
8357  AFD7 3D           		dec	a
8358  AFD8 42           		ld	b,d
8359  AFD9 ED 79        		out	(c),a
8360  AFDB 43           		ld	b,e
8361  AFDC ED AB        		outd
8362  AFDE 3D           		dec	a
8363  AFDF 42           		ld	b,d
8364  AFE0 ED 79        		out	(c),a
8365  AFE2 43           		ld	b,e
8366  AFE3 ED AB        		outd
8367  AFE5 3D           		dec	a
8368  AFE6 42           		ld	b,d
8369  AFE7 ED 79        		out	(c),a
8370  AFE9 43           		ld	b,e
8371  AFEA ED AB        		outd
8372  AFEC 3D           		dec	a
8373  AFED 42           		ld	b,d
8374  AFEE ED 79        		out	(c),a
8375  AFF0 43           		ld	b,e
8376  AFF1 ED AB        		outd
8377  AFF3 3D           		dec	a
8378  AFF4 42           		ld	b,d
8379  AFF5 ED 79        		out	(c),a
8380  AFF7 43           		ld	b,e
8381  AFF8 ED AB        		outd
8382  AFFA 32 95 AF     		ld	(AYREG_EnvSh+1),a
8383  AFFD FB           		ei
8384  AFFE C9           		ret
8385  AFFF
8386  AFFF              ;------------------------------------------------------------------------------
8387  AFFF F8 0E 10 0E  freqtable	dw	#0EF8, #0E10, #0D60, #0C80, #0BD8, #0B28, #0A88, #09F0
8387  B003 60 0D 80 0C
8387  B007 D8 0B 28 0B
8387  B00B 88 0A F0 09
8388  B00F 60 09 E0 08  		dw	#0960, #08E0, #0858, #07E0, #077C, #0708, #06B0, #0640
8388  B013 58 08 E0 07
8388  B017 7C 07 08 07
8388  B01B B0 06 40 06
8389  B01F EC 05 94 05  		dw	#05EC, #0594, #0544, #04F8, #04B0, #0470, #042C, #03F0
8389  B023 44 05 F8 04
8389  B027 B0 04 70 04
8389  B02B 2C 04 F0 03
8390  B02F BE 03 84 03  		dw	#03BE, #0384, #0358, #0320, #02F6, #02CA, #02A2, #027C
8390  B033 58 03 20 03
8390  B037 F6 02 CA 02
8390  B03B A2 02 7C 02
8391  B03F 58 02 38 02  		dw	#0258, #0238, #0216, #01F8, #01DF, #01C2, #01AC, #0190
8391  B043 16 02 F8 01
8391  B047 DF 01 C2 01
8391  B04B AC 01 90 01
8392  B04F 7B 01 65 01  		dw	#017B, #0165, #0151, #013E, #012C, #011C, #010B, #00FC
8392  B053 51 01 3E 01
8392  B057 2C 01 1C 01
8392  B05B 0B 01 FC 00
8393  B05F EF 00 E1 00  		dw	#00EF, #00E1, #00D6, #00C8, #00BD, #00B2, #00A8, #009F
8393  B063 D6 00 C8 00
8393  B067 BD 00 B2 00
8393  B06B A8 00 9F 00
8394  B06F 96 00 8E 00  		dw	#0096, #008E, #0085, #007E, #0077, #0070, #006B, #0064
8394  B073 85 00 7E 00
8394  B077 77 00 70 00
8394  B07B 6B 00 64 00
8395  B07F 5E 00 59 00  		dw	#005E, #0059, #0054, #004F, #004B, #0047, #0042, #003F
8395  B083 54 00 4F 00
8395  B087 4B 00 47 00
8395  B08B 42 00 3F 00
8396  B08F 3B 00 38 00  		dw	#003B, #0038, #0035, #0032, #002F, #002C, #002A, #0027
8396  B093 35 00 32 00
8396  B097 2F 00 2C 00
8396  B09B 2A 00 27 00
8397  B09F 25 00 23 00  		dw	#0025, #0023, #0021, #001F, #001D, #001C, #001A, #0019
8397  B0A3 21 00 1F 00
8397  B0A7 1D 00 1C 00
8397  B0AB 1A 00 19 00
8398  B0AF 17 00 16 00  		dw	#0017, #0016, #0015, #0013, #0012, #0011, #0010, #000F
8398  B0B3 15 00 13 00
8398  B0B7 12 00 11 00
8398  B0BB 10 00 0F 00
8399  B0BF
8400  B0BF 00 00 00     empty_orn:	db	#00, #00, #00
8401  B0C2 70 80 F1 D0  empty_pattern:	db	#70, #80, #F1, #D0, #00
8401  B0C6 00
8402  B0C7
8403  B0C7 00 00        AYREG_TonA:	dw	0
8404  B0C9 00 00        AYREG_TonB:	dw	0
8405  B0CB 00 00        AYREG_TonC:	dw	0
8406  B0CD 00           AYREG_AmplA:	db	0
8407  B0CE 00           AYREG_AmplB:	db	0
8408  B0CF 00           AYREG_AmplC:	db	0
8409  B0D0 00           tempocnt_2:	db	0
8410  B0D1 00           tempocnt_1:	db	0
8411  B0D2 00           tempocnt_0:	db	0
8412  B0D3 00           pattstep_cnt:	db	0
8413  B0D4
8414  B0D4              ;-----------------------------------------------------------------------------
8415  B0D4
8416  B0D4              			endmodule
8417  B0D4
8418  B0D4
8419  B0D4              songdata
8420  B0D4              MDLADDR
8421  B0D4              modstart
8422  B0D4 00 00        BUFFER:			ds	2		; dlzka songu
8423  B0D6              RELOC_BASE:
8424  B0D6 00 00        I_SAMPLES:		ds	2		; adresa lookup tabulky samplov
8425  B0D8 00 00        I_ORNAMENTS:	ds	2		; adresa lookup tabulky ornamentov
8426  B0DA 00 00        I_PATTERNS:		ds	2		; adresa lookup tabulky patternov
8427  B0DC 00 00        I_POSITIONS:	ds	2		; adresa definicii pozicii
8428  B0DE 00 00        I_REPEAT:		ds	2		; ukazovatel na repeat poziciu
8429  B0E0 00 00        RELOC_ENDPTR:	ds	2		; tu je uz ukazovat na prvy sampel
8430  B0E2              screen 			incbin	logo.bin
8431  B8E2 00 00 00...  LFNNAME ds 262
8432  B9E8
8433  B9E8 00 00 00...  esxError        ds      34
8434  BA0A              			  CSPECTMAP player.map
8435  BA0A
8436  BA0A                            savenex open "NextPlayer.nex",demo,24575
8437  BA0A
8438  BA0A                            savenex core 2,0,0
8439  BA0A                            ;SAVENEX SCREEN BMP "screen2.bmp"
8440  BA0A              			  savenex auto
8441  BA0A                            savenex close
8442  BA0A
# file closed: NextPlayer.asm
