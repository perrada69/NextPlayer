# file opened: NextPlayer.asm
    1 0000
    2 0000                            DEVICE ZXSPECTRUMNEXT
    3 0000              			  ;OPT reset --zxnext --syntax=abfw
    4 0000                            slot 3
    5 0000
    6 0000                            org #6000
    7 6000              CHARS         equ  15616-256
    8 6000              mystak        equ  24575         ;ar bi trary value picked to be be low
    9 6000                                              ;BFE0h and above 4000h
   10 6000              staksto       equ  24575         ;some where to put BA SIC's stack
   11 6000                                              ;pointer
   12 6000              bankm         equ  #5B5C         ;sys tem vari able that holds the
   13 6000                                              ;last value out put to 7FFDh
   14 6000              port1         equ  #7FFD         ;ad dress of ROM/RAM switch ing port
   15 6000                                              ;in I/O map
   16 6000              catbuff       equ  #8000         ;some where for DOS to put its catalog
   17 6000              dos_catalog   equ  #011E         ;the DOS routine to call
   18 6000 00 00 00...  filename 	  ds   15
   19 600F              typ 		  equ $-4
   20 600F              pocetpolozek	equ 231
   21 600F 00           virtmem			defb 0
   22 6010              maxlen			equ 128
   23 6010              maxline 		equ 37
   24 6010 00 00        save_allfiles	defw 0
   25 6012
   26 6012              ReadNextReg:
   27 6012                  ; reads nextreg in A into A (does modify currently selected NextReg on I/O port)
   28 6012 C5               push    bc
   29 6013 01 3B 24         ld      bc,#243B
   30 6016 ED 79            out     (c),a
   31 6018 04               inc     b       ; bc = TBBLUE_REGISTER_ACCESS_P_253B
   32 6019 ED 78            in      a,(c)   ; read desired NextReg state
   33 601B C1               pop     bc
   34 601C C9               ret
   35 601D
   36 601D FB           INPUT 	ei
   37 601E 22 37 60     		ld (INPOS+1),hl ;ulož adresu začátku pro další použití
   38 6021 21 00 5B     		ld hl,23296 ;do HL adresa editační oblasti
   39 6024 DD 44        		ld b,hx ;do B délka editační oblasti
   40 6026 36 20        IN1 	ld (hl),32 ;a nyní celou editační
   41 6028 23           		inc hl ;zónu vyplníme mezerami
   42 6029 10 FB        		djnz IN1 ;na konec editační zóny
   43 602B 70           		ld (hl),b ;přijde 0
   44 602C FD CB 01 AE  		res 5,(iy+1) ;signál není stisknuta klávesa
   45 6030 AF           		xor a ;nastav kurzor
   46 6031 32 40 60     		ld (CURSOR+1),a ;na začátek editační zóny
   47 6034 DD 44        IN2 	ld b,hx ;nyní celou editační zónu
   48 6036 21 00 00     INPOS 	ld hl,0 ;vytiskneme, nastav
   49 6039 22 12 61     		ld (PPOS+1),hl ;tiskovou pozici
   50 603C 21 00 5B     		ld hl,23296 ;začínáme od začátku
   51 603F 0E 00        CURSOR 	ld c,0 ;do C polohu kurzoru
   52 6041 7D           IN3 	ld a,l ;testuj spodní byte adresy
   53 6042 B9           		cp c ;v případe rovnosti
   54 6043 3E 3E        		ld a,">" ;dej do A kód kurzoru
   55 6045 CC 08 61     		call z,CHAR ;a vytiskni ho
   56 6048 7E           		ld a,(hl) ;vytiskni znak
   57 6049 CD 08 61     		call CHAR ;z editační zóny
   58 604C 23           		inc hl ;a posun se pro další
   59 604D 10 F2        		djnz IN3 ;opakuj se všemi znaky
   60 604F 7D           		ld a,l ;kurzor také může
   61 6050 B9           		cp c ;být až za posledním
   62 6051 3E BC        		ld a,"<"+128 ;znakem, pak bude
   63 6053 CC 08 61     		call z,CHAR ;na řádku vypadat jinak
   64 6056 CD B7 60     		call INKEY ;přečti si kód klávesy
   65 6059 FE 07        		cp 7 ;testuj EDIT (Caps Shift + 1)
   66 605B C8           		ret z ;a případně se vrať zpátky
   67 605C FE 0D        		cp 13 ;testuj ENTER a případné odskoč
   68 605E C8           		ret z  ;jp z,INPCLEAR ;na smazání řádku z obrazovky
   69 605F
   70 605F 21 34 60     		ld hl,IN2 ;na zásobník ulož adresu IN2, sem
   71 6062 E5           		push hl ;se bude nyní program vracet
   72 6063 21 40 60     		ld hl,CURSOR+1 ;do HL vlož adresu pozice kurzoru
   73 6066 FE 08        		cp 8 ;testuj kurzor doleva
   74 6068 28 24        		jr z,CURSLEFT ;odskoč
   75 606A FE 09        		cp 9 ;kurzor doprava
   76 606C 28 25        		jr z,CURSRGHT
   77 606E FE 0C        		cp 12 ;delete (správně BACKSPACE)
   78 6070 28 2E        		jr z,BCKSPACE
   79 6072 FE C7        		cp 199 ;znak <= (funkce DELETE)
   80 6074 28 23        		jr z,DELETE
   81 6076 FE 20        		cp 32 ;nyní zbývají
   82 6078 D8           		ret c ;obyčejné znaky,
   83 6079 FE 80        		cp 128 ;odfiltruj
   84 607B D0           		ret nc ;netisknutelné znaky
   85 607C 08           		ex af,af' ;a kód přesuň do A'
   86 607D 7E           		ld a,(hl) ;testuj, zda není kurzor
   87 607E DD BC        		cp hx ;na konci řádku,
   88 6080 D0           		ret nc ;když ano, tak se vrať
   89 6081 34           		inc (hl) ;posuň kurzor doprava
   90 6082 6E           		ld l,(hl) ;do HL vlož adresu,
   91 6083 2D           		dec l ;na kterou bude znak
   92 6084 26 5B        		ld h,23296/256 ;uložen
   93 6086 7E           INS 	ld a,(hl) ;přečti původní znak
   94 6087 B7           		or a ;a testuj konec řádku
   95 6088 C8           		ret z ;případně se vrať
   96 6089 08           		ex af,af' ;přehoď původní a nový znak
   97 608A 77           		ld (hl),a ;a nový zapiš, pro další znak
   98 608B 23           		inc hl ;bude novým znakem předchozí
   99 608C 18 F8        		jr INS ;znak, opakuj posun znaku až do konce
  100 608E 7E           CURSLEFT ld a,(hl) ;přečti polohu kurzoru
  101 608F B7           		or a ;a v případe, že je na levém okraji
  102 6090 C8           		ret z ;tak se vrať a nic nedělej
  103 6091 35           		dec (hl) ;posuň kurzor doleva a vrať se na IN2
  104 6092 C9           		ret
  105 6093 7E           CURSRGHT ld a,(hl) ;přečti polohu kurzoru
  106 6094 DD BC        		cp hx ;a když je na konci řádku
  107 6096 D0           		ret nc ;tak se vrať
  108 6097 34           		inc (hl) ;jinak posuň kurzor doprava a vrať se
  109 6098 C9           		ret ;vrať se na IN2
  110 6099 7E           DELETE 	ld a,(hl) ;na konci
  111 609A DD BC        		cp hx ;editační zóny
  112 609C C8           		ret z ;DELETE nepracuje
  113 609D 3C           		inc a ;jinak uprav polohu
  114 609E 18 04        		jr BCK2 ;a pokračuj společnou částí
  115 60A0 7E           BCKSPACE ld a,(hl) ;BACKSPACE naopak
  116 60A1 B7           		or a ;nepracuje na začátku
  117 60A2 C8           		ret z ;editační zóny
  118 60A3 35           		dec (hl) ;posuň kurzor vlevo
  119 60A4 6F           BCK2 	ld l,a ;společná část,
  120 60A5 26 5B        		ld h,23296/256 ;která zajišťuje
  121 60A7 5D           		ld e,l ;přesunutí následujících
  122 60A8 54           		ld d,h ;znaků na uvolněné místo
  123 60A9 1D           		dec e ;po smazaném znaku
  124 60AA
  125 60AA 7E           DEL2 	ld a,(hl) ;vlastní přesun
  126 60AB ED A0        		ldi ;je prováděn instrukcí
  127 60AD B7           		or a ;LDI dokud není přenesena 0,
  128 60AE 20 FA        		jr nz,DEL2 ;která signalizuje konec zóny
  129 60B0 EB           		ex de,hl ;na poslední pozici,
  130 60B1 2B           		dec hl ;která se nyní uvolnila,
  131 60B2 36 20        		ld (hl)," " ;je zapsána mezera
  132 60B4 C9           		ret ;návrat na IN2
  133 60B5 00 00        delka_souboru	defw 0
  134 60B7 76           INKEY 	halt
  135 60B8 AF           		xor  a
  136 60B9 32 DF 60              ld   (aLAST_KEY+1),a
  137 60BC FB           		ei
  138 60BD 76           		 halt
  139 60BE
  140 60BE              ahl0
  141 60BE CD C7 74     		 call KEYSCAN
  142 60C1
  143 60C1 7B           		 ld   a,e
  144 60C2 3C                    inc  a
  145 60C3 28 F2                 jr   z,INKEY
  146 60C5 7A                    ld   a,d
  147 60C6 21 F8 74              ld   hl,SYMTAB
  148 60C9 FE 18                 cp   $18
  149 60CB 28 0A                 jr   z,aHLSM2
  150 60CD 21 20 75              ld   hl,CAPSTAB
  151 60D0 FE 27                 cp   $27
  152 60D2 28 03                 jr   z,aHLSM2
  153 60D4 21 47 75              ld   hl,NORMTAB
  154 60D7 16 00        aHLSM2    ld   d,0
  155 60D9 19                    add  hl,de
  156 60DA 7E                    ld   a,(hl)
  157 60DB B7                    or   a
  158 60DC 28 D9                 jr   z,INKEY
  159 60DE
  160 60DE 06 00        aLAST_KEY ld   b,0
  161 60E0 B8                    cp   b
  162 60E1 28 05                 jr   z,aSEDI_KEY
  163 60E3
  164 60E3 06 03                 ld   b,3
  165 60E5 76           aLOOP_LST halt
  166 60E6 10 FD                 djnz aLOOP_LST
  167 60E8              aSEDI_KEY
  168 60E8 32 DF 60              ld   (aLAST_KEY+1),a
  169 60EB F5           		push af
  170 60EC CD 6F 75     		call beepk
  171 60EF F1           		pop af
  172 60F0 C9           		ret
  173 60F1
  174 60F1 ED 5B 37 60  INPCLEAR ld de,(INPOS+1) ;do DE pixelová pozice
  175 60F5 0E 08        		ld c,8 ;16 pixelových řádků na výšku
  176 60F7 DD 44        INPC2 	ld b,hx ;do B délka řádku
  177 60F9 04           		inc b ;plus 1 za kurzor
  178 60FA AF           		xor a ;vynuluj A
  179 60FB D5           		push de ;ulož adresu začátku řádku
  180 60FC 12           INPC3 	ld (de),a ;vymaž byty
  181 60FD 13           		inc de ;v pixelovém
  182 60FE 10 FC        		djnz INPC3 ;řádku
  183 6100 D1           		pop de ;obnov adresu počátku
  184 6101
  185 6101 CD 11 7B     		call DOWNDE ;a posuň se na další řádek
  186 6104 0D           		dec c ;odečti jedničku
  187 6105 20 F0        		jr nz,INPC2 ;a zbývají-li řádky, opakuj
  188 6107 C9           		ret
  189 6108
  190 6108 D9           CHAR 	exx
  191 6109 87           		add a,a
  192 610A 6F           		ld l,a
  193 610B 9F           		sbc a,a
  194 610C 4F           		ld c,a
  195 610D 26 0F        		ld h,15
  196 610F 29           		add hl,hl
  197 6110 29           		add hl,hl
  198 6111 11 00 40     PPOS 	ld de,16384
  199 6114 D5           		push de
  200 6115 06 08        		ld b,8
  201 6117 7E           CHAR2 	ld a,(hl)
  202 6118              		;rrca
  203 6118 B6           		or (hl)
  204 6119 A9           		xor c
  205 611A 12           		ld (de),a
  206 611B CD 11 7B     		call DOWNDE
  207 611E 23           		inc hl
  208 611F 10 F6        		djnz CHAR2
  209 6121 D1           		pop de
  210 6122 1C           		inc e
  211 6123 7B           		ld a,e
  212 6124 E6 1F        		and 31
  213 6126 20 0C        		jr nz,CHAR3
  214 6128 1D           		dec e
  215 6129 7B           		ld a,e ; posun na další tiskovou pozici
  216 612A E6 E0        		and %11100000
  217 612C 5F           		ld e,a
  218 612D 06 10        		ld b,16
  219 612F CD 11 7B     CHAR4 	call DOWNDE
  220 6132 10 FB        		djnz CHAR4
  221 6134 ED 53 12 61  CHAR3 	ld (PPOS+1),de
  222 6138 D9           		exx
  223 6139 C9           		ret
  224 613A
  225 613A              ; DE .... vstup hledaneho retezce
  226 613A              ; HL .... vstup textu,kde budeme hledat
  227 613A              ; Výstup:
  228 613A              		; Z ... nalezeno
  229 613A              		; C .. nenalezeno
  230 613A ED 53 65 61  search		ld (search0+1),de
  231 613E              search1
  232 613E
  233 613E 1A           			ld a,(de)
  234 613F FE 61        			cp "a"
  235 6141 38 08        			jr c,search_next
  236 6143 FE 7A        			cp "z"
  237 6145 30 04        			jr nc,search_next
  238 6147 B7           			or a
  239 6148 DE 20        			sbc a,32
  240 614A 12           			ld (de),a
  241 614B              search_next
  242 614B 7E           			ld a,(hl)
  243 614C FE 61        			cp "a"
  244 614E 38 08        			jr c,search_next2
  245 6150 FE 7A        			cp "z"
  246 6152 30 04        			jr nc,search_next2
  247 6154 B7           			or a
  248 6155 DE 20        			sbc a,32
  249 6157 77           			ld (hl),a
  250 6158              search_next2
  251 6158
  252 6158 1A           			ld a,(de)
  253 6159 EE 20        			xor 32
  254 615B C8           			ret z		;konec, nasli jsme retezec
  255 615C
  256 615C 7E           			ld a,(hl)
  257 615D B7           			or a
  258 615E 28 0E        			jr z,konec_textu
  259 6160
  260 6160 1A           			ld a,(de)
  261 6161              			; res 5,a
  262 6161              			; res 5,(hl)
  263 6161 AE           			xor (hl)
  264 6162 28 06        			jr z,search_jo
  265 6164 11 00 00     search0		ld de,0
  266 6167 23           			inc hl
  267 6168 18 D4        			jr search1
  268 616A 23           search_jo	inc hl
  269 616B 13           			inc de
  270 616C 18 D0        			jr search1
  271 616E
  272 616E 3E 01        konec_textu ld a,1		;nastav nz - nic jsme nenasli
  273 6170 B7           			or a
  274 6171 C9           			ret
  275 6172
  276 6172              SF
  277 6172              searchfile
  278 6172 ED 53 82 61  			ld (ssearch0+1),de
  279 6176 1A           			ld a,(de)
  280 6177 B7           			or a
  281 6178 C8           			ret z		;konec, nasli jsme retezec
  282 6179
  283 6179 7E           			ld a,(hl)
  284 617A B7           			or a
  285 617B 28 0E        			jr z,skonec_textu
  286 617D
  287 617D 1A           			ld a,(de)
  288 617E AE           			xor (hl)
  289 617F 28 06        			jr z,ssearch_jo
  290 6181 11 00 00     ssearch0		ld de,0
  291 6184 23           			inc hl
  292 6185 18 EB        			jr searchfile
  293 6187 23           ssearch_jo	inc hl
  294 6188 13           			inc de
  295 6189 18 E7        			jr searchfile
  296 618B
  297 618B
  298 618B 3E 01        skonec_textu ld a,1		;nastav nz - nic jsme nenasli
  299 618D B7           			or a
  300 618E C9           			ret
  301 618F
  302 618F
  303 618F
  304 618F
  305 618F
  306 618F
  307 618F
  308 618F
  309 618F
  310 618F              ; Porovnava dva reteze o delce 3 byty.
  311 618F              ; Vstup:
  312 618F              			; HL ... adresa prvniho retezce
  313 618F              			; DE ... adresa druheho retezce
  314 618F              ; Vystup:
  315 618F              			; Z ... souhlasí
  316 618F              			; NZ .. nesouhlasí
  317 618F              compare
  318 618F 1A           			ld a,(de)
  319 6190 CB BE        			res 7,(hl)
  320 6192 AE           			xor (hl)
  321 6193 C0           			ret nz
  322 6194 23           			inc hl
  323 6195 13           			inc de
  324 6196 1A           			ld a,(de)
  325 6197 CB BE        			res 7,(hl)
  326 6199 AE           			xor (hl)
  327 619A C0           			ret nz
  328 619B 23           			inc hl
  329 619C 13           			inc de
  330 619D 1A           			ld a,(de)
  331 619E CB BE        			res 7,(hl)
  332 61A0 AE           			xor (hl)
  333 61A1 C9           			ret
  334 61A2
  335 61A2              CountMemory
  336 61A2 11 AE 0B     			ld de,13*(pocetpolozek-1)
  337 61A5 21 00 80     Count11		ld hl,catbuff
  338 61A8 19           			add hl,de
  339 61A9 22 A6 61     			ld (Count11+1),hl
  340 61AC
  341 61AC C9           			ret
  342 61AD
  343 61AD 00 00        savehl		defw 0
  344 61AF 00 00        saveix		defw 0
  345 61B1              ESXDOS      MACRO service?
  345 61B1 ~              push hl
  345 61B1 ~              pop ix
  345 61B1 ~              rst $08
  345 61B1 ~              db service?
  345 61B1                ENDM    ; copies HL into IX
  346 61B1
  347 61B1              ; Read NextReg into A (does modify A, and NextReg selected on the I/O port)
  348 61B1              ; is not optimized for speed + restores BC
  349 61B1                  MACRO NEXTREG2A register?
  350 61B1 ~                    ld     a,register?
  351 61B1 ~                    call   ReadNextReg
  352 61B1                  ENDM
  353 61B1
  354 61B1 50 6C 65 61  txtWait		defb	"Please wait:",0
  354 61B5 73 65 20 77
  354 61B9 61 69 74 3A
  354 61BD 00
  355 61BE 4D 61 69 6E  txtShrek	defb	"Main program: Shrek/MB Maniax",0
  355 61C2 20 70 72 6F
  355 61C6 67 72 61 6D
  355 61CA 3A 20 53 68
  355 61CE 72 65 6B 2F
  355 61D2 4D 42 20 4D
  355 61D6 61 6E 69 61
  355 61DA 78 00
  356 61DC 20 20 20 20  txtPress	defb 	"    Press any key to continue",0
  356 61E0 50 72 65 73
  356 61E4 73 20 61 6E
  356 61E8 79 20 6B 65
  356 61EC 79 20 74 6F
  356 61F0 20 63 6F 6E
  356 61F4 74 69 6E 75
  356 61F8 65 00
  357 61FA 41 59 20 70  txtBorik	defb 	"AY play rutines: mborik/SinDiKat",0
  357 61FE 6C 61 79 20
  357 6202 72 75 74 69
  357 6206 6E 65 73 3A
  357 620A 20 6D 62 6F
  357 620E 72 69 6B 2F
  357 6212 53 69 6E 44
  357 6216 69 4B 61 74
  357 621A 00
  358 621B 42 69 67 20  txtThanks	defb	"Big thanks: ped7g, z00m, Logout",0
  358 621F 74 68 61 6E
  358 6223 6B 73 3A 20
  358 6227 70 65 64 37
  358 622B 67 2C 20 7A
  358 622F 30 30 6D 2C
  358 6233 20 4C 6F 67
  358 6237 6F 75 74 00
  359 623B 30 2E 36 31  txtVersion	defb 	"0.61",0
  359 623F 00
  360 6240 F3           demo:       di
  361 6241
  362 6241              F_OPEN                      equ $9A
  363 6241              FA_READ                     equ $01
  364 6241              F_READ                      equ $9D
  365 6241              F_CLOSE                     equ $9B
  366 6241              M_GETERR                    equ $93
  367 6241              next_register_select equ $243b
  368 6241              nxr_peripheral2 equ $06
  369 6241
  370 6241
  371 6241 21 00 58     			ld hl,22528
  372 6244 11 01 58                 ld de,22529
  373 6247 3E 07        			ld a,7
  374 6249 77                       ld (hl),a
  375 624A 01 FF 02                 ld bc,767
  376 624D ED B0                    ldir
  377 624F 21 3A BE     			ld hl,screen
  378 6252 11 00 40     			ld de,16384
  379 6255 01 00 08     			ld bc,2048
  380 6258 ED B0        			ldir
  381 625A 11 22 48     			ld de,18464+2
  382 625D 21 B1 61     			ld hl,txtWait
  383 6260 CD 26 7B     			call print
  384 6263 21 42 48     			ld hl, 18496+2
  385 6266 01 1C 04     			ld   bc,4*256+28
  386 6269 3E 05        			ld   a,%00000101
  387 626B CD 48 77     			call RAMECEK
  388 626E
  389 626E 11 64 48     			ld de,18528+4
  390 6271 21 FE 6C     			ld hl,txtStart
  391 6274 CD 26 7B     			call print
  392 6277
  393 6277 11 43 50     			ld de,20544+3
  394 627A 21 BE 61     			ld hl,txtShrek
  395 627D CD 26 7B     			call print
  396 6280 11 63 50     			ld de,20576+3
  397 6283 21 FA 61     			ld hl,txtBorik
  398 6286 CD 26 7B     			call print
  399 6289 11 83 50     			ld de,20608+3
  400 628C 21 1B 62     			ld hl,txtThanks
  401 628F CD 26 7B     			call print
  402 6292
  403 6292 11 7C 40     			ld de,16480+28
  404 6295 21 3B 62     			ld hl,txtVersion
  405 6298 CD 26 7B     			call print
  406 629B
  407 629B 21 00 00     			ld hl,0
  408 629E 11 78 48     			ld de,18528+24
  409 62A1 ED 53 55 65  			ld (NUMPOS+1),de
  410 62A5 CD 22 65     			call DEC16
  411 62A8 00 14        			defw 20*256
  412 62AA
  413 62AA 21 4D 5A     			ld hl,22528+13 + 32*18
  414 62AD 06 0F        			ld b,15
  415 62AF 36 47        podbarvi	ld (hl),%01000111
  416 62B1 23           			inc hl
  417 62B2 10 FB        			djnz podbarvi
  418 62B4
  419 62B4 21 6F 5A     			ld hl,22528+15 + 32*19
  420 62B7 06 0F        			ld b,15
  421 62B9 36 47        podbarvi1	ld (hl),%01000111
  422 62BB 23           			inc hl
  423 62BC 10 FB        			djnz podbarvi1
  424 62BE
  425 62BE 21 8B 5A     			ld hl,22528+11 + 32*20
  426 62C1 06 0F        			ld b,15
  427 62C3 36 47        podbarvi2	ld (hl),%01000111
  428 62C5 23           			inc hl
  429 62C6 10 FB        			djnz podbarvi2
  430 62C8
  431 62C8 21 00 58     			ld hl,22528
  432 62CB 06 80        			ld b,32*4
  433 62CD 36 47        podbarvi3	ld (hl),%01000111
  434 62CF 23           			inc hl
  435 62D0 10 FB        			djnz podbarvi3
  436 62D2
  437 62D2 01 3B 12     			ld bc,$123b
  438 62D5                          ;nextreg #03,1
  439 62D5 ED 91 07 03  			nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
  440 62D9
  441 62D9 CD 82 65     			call BUFF83
  442 62DC
  443 62DC ED 73 FF 5F              ld (staksto),sp   ;save BASIC's stack pointer
  444 62E0 01 FD 7F                 ld bc,port1       ;the horizontal ROM switch/RAM
  445 62E3                                              ;switch I/O ad dress
  446 62E3 3A 5C 5B                 ld a,(bankm)      ;sys tem vari able that holds cur rent
  447 62E6                                              ;switch state
  448 62E6 CB A7                    res 4,a           ;move right to left in hor i zon tal
  449 62E8                                              ;ROM switch (3 to 2)
  450 62E8
  451 62E8 F6 07                      or 7              ;switch in RAM page 7
  452 62EA 32 5C 5B                   ld (bankm),a      ;must keep sys tem vari able up to
  453 62ED                            	                  ;date (very im por tant)
  454 62ED ED 79                      out (c),a         ;make the switch
  455 62EF
  456 62EF 31 FF 5F     			  ld sp,mystak      ;make sure stack is above 4000h and
  457 62F2                                              ;be low BFE0h
  458 62F2 FB                         ei                ;in ter rupts can now be en abled
  459 62F3
  460 62F3 21 00 80                   ld hl,catbuff     ;some where for DOS to put the cata
  461 62F6                                              ;log
  462 62F6 11 01 80                   ld de,catbuff+1   ;
  463 62F9 01 00 04                   ld bc,1024        ;max i mum (for +3DOS) is ac tu ally
  464 62FC                                              ;64x13+13 = 845
  465 62FC 36 00                      ld (hl),0
  466 62FE ED B0                      ldir              ;make sure at least first en try is
  467 6300 11 00 80                   ld de,catbuff     ;the lo ca tion to be filled with the
  468 6303              NextDirItem
  469 6303 06 E7                      ld b,pocetpolozek ;the num ber of en tries in the
  470 6305                                              ;buffer
  471 6305 0E 04                      ld c,%100            ;include sys tem files in the cata
  472 6307 21 8F 66                   ld hl,stardstar   ;the file name ("*.*")
  473 630A CD 1E 01                   call dos_catalog  ;call the DOS en try
  474 630D
  475 630D 22 AD 61                   ld (savehl),hl
  476 6310 DD 22 AF 61  			  ld (saveix),ix
  477 6314 78           			  ld a,b
  478 6315 FE E7        			  cp pocetpolozek
  479 6317 F5           			  push af
  480 6318
  481 6318 2A 4C 7A     			  ld hl,(ALLFILES)
  482 631B 58           			  ld e,b
  483 631C 16 00        			  ld d,0
  484 631E 19           			  add hl,de
  485 631F 2B           			  dec hl
  486 6320 22 4C 7A     			  ld (ALLFILES),hl
  487 6323
  488 6323 E5           			push hl
  489 6324 D5           			push de
  490 6325 C5           			push bc
  491 6326
  492 6326
  493 6326 2A 71 65     			ld hl,(dirNum)
  494 6329 19           			add	hl,de
  495 632A 2B           			dec hl
  496 632B 22 71 65     			ld 	(dirNum),hl
  497 632E 11 78 48     			ld de,18528+24
  498 6331 ED 53 55 65  			ld (NUMPOS+1),de
  499 6335 76           			halt
  500 6336 CD 22 65     			call DEC16
  501 6339 00 14        			defw 20*256
  502 633B C1           			pop bc
  503 633C D1           			pop de
  504 633D E1           			pop hl
  505 633E
  506 633E
  507 633E 3A 4B 7A     			  ld a,(FILES)
  508 6341 80           			  add a,b
  509 6342 3D           			  dec a
  510 6343 32 4B 7A     			  ld (FILES),a
  511 6346 F1           			  pop af
  512 6347 38 15        			  jr c,cont
  513 6349              nezapisuj
  514 6349 78           			  ld a,b
  515 634A B7           			  or a
  516 634B 28 11        			  jr z,cont
  517 634D
  518 634D 3A 0F 60     			  ld a,(virtmem)
  519 6350 FE 04        			  cp 4
  520 6352 28 0A        			  jr z,cont
  521 6354
  522 6354 CD A2 61     			  call CountMemory
  523 6357 EB           			  ex de,hl
  524 6358 21 0F 60     			  ld hl,virtmem
  525 635B 34           			  inc (hl)
  526 635C 18 A5        			  jr NextDirItem
  527 635E              cont
  528 635E F5                         push af           ;save flags and pos si ble er ror num
  529 635F                                              ;ber re turned by DOS
  530 635F
  531 635F
  532 635F 2A 71 65     			ld hl,(dirNum)
  533 6362 11 78 48     			ld de,18528+24
  534 6365 ED 53 55 65  			ld (NUMPOS+1),de
  535 6369 76           			halt
  536 636A CD 22 65     			call DEC16
  537 636D 00 14        			defw 20*256
  538 636F
  539 636F
  540 636F E1                         pop hl
  541 6370 22 95 66                   ld (dosret),hl    ;put it where it can be seen from
  542 6373                                              ; NextBASIC
  543 6373 48                         ld c,b            ;move num ber of files in cat a log to
  544 6374                                              ;low byte of BC
  545 6374 06 00                      ld b,0            ;this will be re turned in NextBASIC
  546 6376
  547 6376 F3                         di                ;about to ROM/RAM switch so be
  548 6377                                              ;care ful
  549 6377 C5                         push bc           ;save num ber of files
  550 6378 01 FD 7F                   ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
  551 637B                                              ;switch
  552 637B 3A 5C 5B                   ld a,(bankm)      ;get cur rent switch state
  553 637E
  554 637E
  555 637E CB E7                      set 4,a           ;move left to right (ROM 2 to ROM
  556 6380                                              ;3)
  557 6380 E6 F8                      and #F8           ;also want RAM page 0
  558 6382 32 5C 5B                   ld (bankm),a      ;up date the sys tem vari able (very
  559 6385                                              ;im por tant)
  560 6385 ED 79                      out (c),a         ;make the switch
  561 6387 C1                         pop bc            ;get back the saved num ber of files
  562 6388 0B                         dec bc
  563 6389
  564 6389 ED 7B FF 5F                ld sp,(staksto)   ;put NextBASIC's stack back
  565 638D
  566 638D CD 82 65     			 call BUFF83
  567 6390 21 0D 80     			 ld hl,catbuff+13
  568 6393 ED 5B 4C 7A  			 ld de,(ALLFILES)
  569 6397 D5           testovani	 push de
  570 6398 E5           			 push hl
  571 6399 DD E1        			 pop ix
  572 639B DD E5        			 push ix
  573 639D DD CB 07 7E  			 bit 7,(ix+7)
  574 63A1
  575 63A1 20 53        			 jr nz,souhlasi
  576 63A3
  577 63A3 11 08 00     			 ld de,8
  578 63A6 19           			 add hl,de		;v HL je začátek přípony souboru
  579 63A7
  580 63A7 E5           			 push hl
  581 63A8 11 F1 73     			 ld de,PT2
  582 63AB CD 8F 61     			 call compare
  583 63AE E1           			 pop hl
  584 63AF 28 45        			 jr z,souhlasi
  585 63B1
  586 63B1 E5           			 push hl
  587 63B2 11 F4 73     			 ld de,PT3
  588 63B5 CD 8F 61     			 call compare
  589 63B8 E1           			 pop hl
  590 63B9 28 3B        			 jr z,souhlasi
  591 63BB
  592 63BB 11 F7 73     			 ld de,SQT
  593 63BE E5           			 push hl
  594 63BF CD 8F 61     			 call compare
  595 63C2 E1           			 pop hl
  596 63C3 28 31        			 jr z,souhlasi
  597 63C5
  598 63C5 11 FA 73     			 ld de,STC
  599 63C8 E5           			 push hl
  600 63C9 CD 8F 61     			 call compare
  601 63CC E1           			 pop hl
  602 63CD 28 27        			 jr z,souhlasi
  603 63CF
  604 63CF 11 FD 73      			 ld de,STP
  605 63D2 E5           			 push hl
  606 63D3 CD 8F 61     			 call compare
  607 63D6 E1           			 pop hl
  608 63D7 28 1D        			 jr z,souhlasi
  609 63D9
  610 63D9 D1           			 pop de
  611 63DA D5           			 push de		;v de mame zacatek jmena souboru
  612 63DB 62           			 ld h,d
  613 63DC 6B           			 ld l,e
  614 63DD ED 34 0D 00  			 add hl,13		;vynechana jedna polozka
  615 63E1 01 FC 3F     			 ld bc,1260*13
  616 63E4 ED B0        			 ldir
  617 63E6
  618 63E6 2A 4C 7A     			 ld hl,(ALLFILES)
  619 63E9 2B           			 dec hl
  620 63EA 22 4C 7A     			 ld (ALLFILES),hl
  621 63ED E1           			 pop hl
  622 63EE D1           			 pop de
  623 63EF 1B           			 dec de
  624 63F0 7A           			 ld a,d
  625 63F1 B3           			 or e
  626 63F2 20 A3        			 jr nz,testovani
  627 63F4 18 0B        			 jr skon
  628 63F6              souhlasi
  629 63F6 E1           			 pop hl
  630 63F7 11 0D 00     			 ld de,13
  631 63FA 19           			 add hl,de
  632 63FB D1           			 pop de
  633 63FC 1B           			 dec de
  634 63FD 7A           			 ld a,d
  635 63FE B3           			 or e
  636 63FF 20 96        			 jr nz,testovani
  637 6401              skon
  638 6401
  639 6401 2A 4C 7A     			ld hl,(ALLFILES)
  640 6404 22 10 60     			ld (save_allfiles),hl
  641 6407 11 84 48     			 ld de,18560+4
  642 640A 21 E5 6C     			 ld hl,txtLFNinfo
  643 640D CD 26 7B     			 call print
  644 6410 CD 28 6D     			 call getAllLFN
  645 6413
  646 6413 2A 1A 6D     			ld 	hl,(numLoop)
  647 6416 11 98 48     			ld de,18560+24	;pozice ve VideoRam
  648 6419 ED 53 55 65  			ld (NUMPOS+1),de
  649 641D CD 22 65     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
  650 6420 00 14        			defw 20*256
  651 6422
  652 6422
  653 6422 11 C3 50     			ld de,20544+3+32+32 + 32 +32
  654 6425 21 DC 61     			ld hl,txtPress
  655 6428 CD 26 7B     			call print
  656 642B
  657 642B              cekej_na_klavesu
  658 642B
  659 642B 21 C0 5A     			ld hl,22528+(32*22)
  660 642E
  661 642E 06 20        			ld b,32
  662 6430 3E 00        brv			ld a,0
  663 6432 77           			ld (hl),a
  664 6433 23           			inc hl
  665 6434 10 FA        			djnz brv
  666 6436 3A 31 64     			ld a,(brv+1)
  667 6439 3C           			inc a
  668 643A FE 08        			cp 8
  669 643C 28 02        			jr z,nuluj_barvu
  670 643E
  671 643E 18 01        			jr nenuluj_barvu
  672 6440              nuluj_barvu
  673 6440 AF           			xor a
  674 6441
  675 6441              nenuluj_barvu
  676 6441 32 31 64     			ld (brv+1),a
  677 6444 AF           			xor a
  678 6445 DB FE        			in a,(254)
  679 6447 2F           			cpl
  680 6448 E6 1F        			and 31
  681 644A 28 DF        			jr z,cekej_na_klavesu
  682 644C
  683 644C CD 55 6E     			 call GETDIR
  684 644F
  685 644F 21 00 40     			 ld hl,16384
  686 6452 11 01 40     			 ld de,16385
  687 6455 01 FF 17     			 ld bc,6143
  688 6458 AF           			 xor a
  689 6459 77           			 ld (hl),a
  690 645A ED B0        			 ldir
  691 645C
  692 645C CD 93 65     			 call NOBUFF83
  693 645F CD 1A 78                  call kresli
  694 6462 CD 8E 7A                  call INIROLL
  695 6465
  696 6465 21 0D 80     			 ld hl,catbuff+#d
  697 6468 CD 3C 79                  call WRFILES      ;vypis soubory
  698 646B 11 2F 48     			 ld de,18464+15
  699 646E 21 7E 7F     			 ld hl,txtcurrentfile
  700 6471 CD 26 7B     			 call print
  701 6474
  702 6474 11 0F 48     			 ld de,18432+15
  703 6477 21 73 7F     			 ld hl,txtallfiles
  704 647A CD 26 7B     			 call print
  705 647D
  706 647D CD 73 65     			call LFNWINDOW
  707 6480 CD 12 66     			call LFNPRINT
  708 6483 21 59 BD     			ld hl,LFNNAME + maxline
  709 6486 36 00        			ld (hl),0
  710 6488 21 34 BD     			ld hl,LFNNAME
  711 648B 11 C2 50     			ld de,20672+2
  712 648E CD 26 7B     			call print
  713 6491
  714 6491
  715 6491 11 4F 50     			ld de,20544+15
  716 6494 21 02 70     			ld hl,lfndir
  717 6497 CD 26 7B     			call print
  718 649A 11 52 50     			ld de,20544+15+3
  719 649D 21 41 6E     			ld hl,NAZEVADRESARE
  720 64A0 CD 26 7B     			call print
  721 64A3
  722 64A3 ED 91 07 00              nextreg #07,0             ;3,5MHz
  723 64A7
  724 64A7 ED 91 57 18  			nextreg $57,24		;Nastrankuj od C000 player
  725 64AB              HLSMYC0
  726 64AB 2A 33 76     		ld hl,(apos_all)
  727 64AE 23           		inc hl
  728 64AF 11 3A 48     		ld de,18464+15+11
  729 64B2 ED 53 55 65  		ld (NUMPOS+1),de
  730 64B6 CD 22 65     		call DEC16
  731 64B9 00 14        		defw 20*256
  732 64BB
  733 64BB 2A 4C 7A     		ld hl,(ALLFILES)
  734 64BE 11 1A 48     		ld de,18432+15+11
  735 64C1 ED 53 55 65  		ld (NUMPOS+1),de
  736 64C5 CD 22 65     		call DEC16
  737 64C8 00 14        		defw 20*256
  738 64CA
  739 64CA AF                    xor  a
  740 64CB 32 FC 64              ld   (LAST_KEY+1),a
  741 64CE FB           		 ei
  742 64CF 76           		 halt
  743 64D0
  744 64D0 3A 00 74     		 ld a,(endsong)
  745 64D3 B7           		 or a
  746 64D4 28 05        		 jr z,hl0
  747 64D6 32 FC 64     		 ld (LAST_KEY+1),a
  748 64D9 18 2A        		 jr SEDI_KEY
  749 64DB              hl0
  750 64DB CD C7 74     		 call KEYSCAN
  751 64DE
  752 64DE 7B           		 ld   a,e
  753 64DF 3C                    inc  a
  754 64E0 28 C9                 jr   z,HLSMYC0
  755 64E2 7A                    ld   a,d
  756 64E3 21 F8 74              ld   hl,SYMTAB
  757 64E6 FE 18                 cp   $18
  758 64E8 28 0A                 jr   z,HLSM2
  759 64EA 21 20 75              ld   hl,CAPSTAB
  760 64ED FE 27                 cp   $27
  761 64EF 28 03                 jr   z,HLSM2
  762 64F1 21 47 75              ld   hl,NORMTAB
  763 64F4 16 00        HLSM2    ld   d,0
  764 64F6 19                    add  hl,de
  765 64F7 7E                    ld   a,(hl)
  766 64F8 B7                    or   a
  767 64F9 28 B0                 jr   z,HLSMYC0
  768 64FB
  769 64FB 06 00        LAST_KEY ld   b,0
  770 64FD B8                    cp   b
  771 64FE 28 05                 jr   z,SEDI_KEY
  772 6500
  773 6500 06 01                 ld   b,1
  774 6502 76           LOOP_LST halt
  775 6503 10 FD                 djnz LOOP_LST
  776 6505
  777 6505              SEDI_KEY
  778 6505 32 FC 64              ld   (LAST_KEY+1),a
  779 6508
  780 6508
  781 6508 32 97 66     	     ld (KEY),a
  782 650B
  783 650B CD 6F 75     		call beepk
  784 650E CD 98 66     		call CH_FILE
  785 6511 18 98        		jr   HLSMYC0
  786 6513
  787 6513 FB                    ei
  788 6514 18 FE        konec    jr konec
  789 6516
  790 6516
  791 6516
  792 6516 C9                    ret
  793 6517
  794 6517
  795 6517 00 00 00...  NUM      ds 11
  796 6522 0E 20        DEC16    ld   c,' '
  797 6524 FD 21 17 65  DEC16X   ld   iy,NUM
  798 6528 11 F0 D8              ld   de,-10000
  799 652B CD 5A 65              call BN1
  800 652E 11 18 FC              ld   de,-1000
  801 6531 CD 5A 65              call BN1
  802 6534 11 9C FF     DEC8_3   ld   de,-100
  803 6537 CD 5A 65              call BN1
  804 653A 1E F6                 ld   e,-10
  805 653C CD 5A 65              call BN1
  806 653F 1E FF                 ld   e,-1
  807 6541 0E 30                 ld   c,'0'
  808 6543 CD 5A 65              call BN1
  809 6546 FD 36 00 00  DEC32SP  ld   (iy+0),0
  810 654A E3                    ex   (sp),hl
  811 654B 5E                    ld   e,(hl)
  812 654C 23                    inc  hl
  813 654D 56                    ld   d,(hl)
  814 654E 23                    inc  hl
  815 654F E3                    ex   (sp),hl
  816 6550 EB                    ex   de,hl
  817 6551 21 17 65              ld   hl,NUM
  818 6554 11 91 48     NUMPOS	 ld   de,18562+15
  819 6557 C3 26 7B              jp   print
  820 655A
  821 655A 3E 2F        BN1      ld   a,'0'-1
  822 655C 19           BN4      add  hl,de
  823 655D 3C                    inc  a
  824 655E 38 FC                 jr   c,BN4
  825 6560 ED 52        BN2      sbc  hl,de
  826 6562 FE 30                 cp   '0'
  827 6564 28 02                 jr   z,BN3
  828 6566 01 30                 db 1,'0'
  829 6568 79           BN3      ld   a,c
  830 6569 B7                    or   a
  831 656A C8                    ret  z
  832 656B FD 77 00              ld   (iy+0),a
  833 656E FD 23                 inc  iy
  834 6570 C9                    ret
  835 6571
  836 6571 00 00        dirNum	 defw 0
  837 6573
  838 6573              LFNWINDOW
  839 6573 21 A0 50     		ld hl, 20640
  840 6576 01 20 03     		ld   bc,3*256+32
  841 6579 3E 07                ld   a,%00000111
  842 657B CD 48 77     		call RAMECEK
  843 657E C9           		ret
  844 657F
  845 657F              setspace
  846 657F 36 20        		ld (hl),32
  847 6581 C9           		ret
  848 6582
  849 6582
  850 6582
  851 6582              ;Nastránkuj buffer s daty adresáře
  852 6582              BUFF83
  853 6582 ED 91 54 14  			nextreg $54,20
  854 6586 ED 91 55 15  			nextreg $55,21
  855 658A ED 91 56 16  			nextreg $56,22
  856 658E ED 91 57 17  			nextreg $57,23
  857 6592 C9           			ret
  858 6593
  859 6593              NOBUFF83
  860 6593 ED 91 54 04  			nextreg $54,04
  861 6597 ED 91 55 05  			nextreg $55,05
  862 659B ED 91 56 00  			nextreg $56,00
  863 659F ED 91 57 01  			nextreg $57,01
  864 65A3 C9           			ret
  865 65A4
  866 65A4
  867 65A4              ; Input: HL = Dividend, C = Divisor, A = 0
  868 65A4              ; Output: HL = Quotient, A = Remainder
  869 65A4 AF           deleno		xor a
  870 65A5 06 10        			ld b,16
  871 65A7              de
  872 65A7 29           			add	hl,hl
  873 65A8 17           			rla
  874 65A9 B9           			cp	c
  875 65AA 38 02        			jr	c,de1
  876 65AC 91           			sub	c
  877 65AD 2C           			inc	l
  878 65AE 10 F7        de1			djnz de
  879 65B0 C9           			ret
  880 65B1
  881 65B1 00 00        addrlfn		dw 0
  882 65B3
  883 65B3              FINDLFN
  884 65B3 B7           			or a
  885 65B4 11 3F 00     			ld de,63
  886 65B7 ED 52        			sbc hl,de
  887 65B9 19           			add hl,de
  888 65BA 38 08        			jr c,prvni
  889 65BC 0E 3F        			ld c,63
  890 65BE AF           			xor a
  891 65BF CD A4 65     			call deleno
  892 65C2 18 03        		    jr oddeleno
  893 65C4 7D           prvni		ld a,l
  894 65C5 2E 00        			ld l,0
  895 65C7
  896 65C7 F5           oddeleno	push af
  897 65C8 3E 18        			ld a,24
  898 65CA 85           			add a,l
  899 65CB ED 92 57     			nextreg $57,a
  900 65CE C1           			pop bc
  901 65CF 11 80 00     			ld de,maxlen
  902 65D2 78           			ld a,b
  903 65D3 B7           			or a
  904 65D4 21 00 E0     			ld hl,$e000
  905 65D7 28 03        			jr z,prvnizaznam
  906 65D9              lll
  907 65D9 19           			add hl,de
  908 65DA 10 FD        			djnz lll
  909 65DC
  910 65DC              prvnizaznam
  911 65DC 22 B1 65     			ld (addrlfn),hl
  912 65DF 11 34 BD     			ld de,LFNNAME
  913 65E2 06 80        			ld b,maxlen
  914 65E4              popop
  915 65E4 7E           			ld a,(hl)
  916 65E5 FE FF        			cp 255
  917 65E7 28 05        			jr z,kon
  918 65E9 12           			ld (de),a
  919 65EA 23           			inc hl
  920 65EB 13           			inc de
  921 65EC 10 F6        			djnz popop
  922 65EE              kon
  923 65EE 21 34 BD     			ld hl,LFNNAME
  924 65F1 06 28        			ld b,40
  925 65F3              F22222
  926 65F3 7E           			ld a,(hl)
  927 65F4 FE FF        			cp 255
  928 65F6 CC 7F 65     			call z,setspace
  929 65F9 23           			inc hl
  930 65FA 10 F7        			djnz F22222
  931 65FC 21 34 BD     lfnend		ld hl,LFNNAME
  932 65FF 21 DE 50     lfn_1		ld hl,28 + 20672+2
  933 6602 22 20 7B     			ld (maxpos),hl
  934 6605 21 01 51     lfn_2		ld hl,63 + 20672+2
  935 6608 22 22 7B     			ld (maxpos2),hl
  936 660B
  937 660B 11 C2 50     lfnat		ld de,20672+2
  938 660E 21 34 BD     			ld hl,LFNNAME
  939 6611 C9           			ret
  940 6612
  941 6612              LFNPRINT
  942 6612 21 34 BD     			ld hl,LFNNAME
  943 6615 11 35 BD     			ld de,LFNNAME + 1
  944 6618 3E 20        			ld a,32
  945 661A 77           			ld (hl),a
  946 661B 01 A4 00     			ld bc,164
  947 661E ED B0        			ldir
  948 6620              stop
  949 6620 2A 33 76     			ld hl,(apos_all)
  950 6623
  951 6623 CD B3 65     			call FINDLFN
  952 6626
  953 6626
  954 6626              			;call p6b
  955 6626 ED 91 57 01  			nextreg $57,01
  956 662A C9           			ret
  957 662B
  958 662B 00           by1			defb  %00000000
  959 662C 7E           			defb  %01111110
  960 662D 6A           			defb  %01101010
  961 662E 56           			defb  %01010110
  962 662F 6A           			defb  %01101010
  963 6630 56           			defb  %01010110
  964 6631 7E           			defb  %01111110
  965 6632 00           			defb  %00000000
  966 6633
  967 6633 00           			defb  %00000000
  968 6634 7E           			defb  %01111110
  969 6635 6A           			defb  %01101010
  970 6636 56           			defb  %01010110
  971 6637 6A           			defb  %01101010
  972 6638 56           			defb  %01010110
  973 6639 7E           			defb  %01111110
  974 663A 00           			defb  %00000000
  975 663B
  976 663B 00           			defb  %00000000
  977 663C 7E           			defb  %01111110
  978 663D 6A           			defb  %01101010
  979 663E 56           			defb  %01010110
  980 663F 6A           			defb  %01101010
  981 6640 56           			defb  %01010110
  982 6641 7E           			defb  %01111110
  983 6642 00           			defb  %00000000
  984 6643
  985 6643 D5           pozadi		  push de
  986 6644 06 08        			  ld b,8
  987 6646 C5           kr1			  push bc
  988 6647 D5           			  push de
  989 6648 01 10 00     			  ld bc,16
  990 664B 21 6E 66     			  ld hl,byte16
  991 664E ED B0        			  ldir
  992 6650 E1           			  pop hl
  993 6651 CD 20 7C     			  call downhl
  994 6654 EB           			  ex de,hl
  995 6655
  996 6655 C1           			  pop bc
  997 6656 10 EE        			  djnz  kr1
  998 6658
  999 6658 D1           			  pop de
 1000 6659 06 08        			  ld b,8
 1001 665B C5           kr2			  push bc
 1002 665C D5           			  push de
 1003 665D 01 10 00     			  ld bc,16
 1004 6660 21 8D 66     			  ld hl,abyte16
 1005 6663 ED B8        			  lddr
 1006 6665 E1           			  pop hl
 1007 6666 CD 20 7C     			  call downhl
 1008 6669 EB           			  ex de,hl
 1009 666A
 1010 666A C1           			  pop bc
 1011 666B 10 EE        			  djnz  kr2
 1012 666D C9           			  ret
 1013 666E
 1014 666E
 1015 666E
 1016 666E FF           byte16	defb	%11111111
 1017 666F FE           byte15	defb	%11111110
 1018 6670 FC           byte14	defb	%11111100
 1019 6671 F8           byte13	defb	%11111000
 1020 6672 F0           byte12	defb	%11110000
 1021 6673 E1           byte11	defb	%11100001
 1022 6674 C3           byte10	defb	%11000011
 1023 6675 87           byte9	defb	%10000111
 1024 6676 1F           byte8	defb	%00011111
 1025 6677 0F           byte7	defb	%00001111
 1026 6678 07           byte6	defb	%00000111
 1027 6679 07           byte5	defb	%00000111
 1028 667A 03           byte4	defb	%00000011
 1029 667B 01           byte3	defb	%00000001
 1030 667C 01           byte2	defb	%00000001
 1031 667D 00           byte1	defb	%00000000
 1032 667E
 1033 667E 00           abyte1	defb	%00000000
 1034 667F 01           abyte2	defb	%00000001
 1035 6680 01           abyte3	defb	%00000001
 1036 6681 03           abyte4	defb	%00000011
 1037 6682 07           abyte5	defb	%00000111
 1038 6683 07           abyte6	defb	%00000111
 1039 6684 0F           abyte7	defb	%00001111
 1040 6685 1F           abyte8	defb	%00011111
 1041 6686 87           abyte9	defb	%10000111
 1042 6687 C3           abyte10	defb	%11000011
 1043 6688 E1           abyte11	defb	%11100001
 1044 6689 F0           abyte12	defb	%11110000
 1045 668A F8           abyte13	defb	%11111000
 1046 668B FC           abyte14	defb	%11111100
 1047 668C FE           abyte15	defb	%11111110
 1048 668D FF           abyte16	defb	%11111111
 1049 668E 00           outputdir	defb 0
 1050 668F              stardstar:
 1051 668F 2A 2E 3F 3F                defb "*.???",#FF
 1051 6693 3F FF
 1052 6695              dosret:
 1053 6695 00 00                      defw 0
 1054 6697
 1055 6697 00           KEY      defb 0
 1056 6698              CH_FILE
 1057 6698
 1058 6698 3A 97 66              ld   a,(KEY)
 1059 669B FE 71                 cp   "q"
 1060 669D CA 88 75              jp   z,UP
 1061 66A0 FE 0B                 cp   11
 1062 66A2 CA 88 75              jp   z,UP
 1063 66A5 FE 73        		 cp "s"
 1064 66A7 CA 1F 67     		 jp z,hledej
 1065 66AA FE 72        		 cp "r"
 1066 66AC CA ED 6D     		 jp z,reload
 1067 66AF FE 61                 cp   "a"
 1068 66B1 CA E9 75              jp   z,DOWN
 1069 66B4 FE 0A                 cp   10
 1070 66B6 CA E9 75              jp   z,DOWN
 1071 66B9 FE 09        		 cp 9
 1072 66BB CA 72 6A     		 jp z,right
 1073 66BE FE 08        		 cp 8
 1074 66C0 CA E4 69     		 jp z,left
 1075 66C3 FE 0D                 cp   13
 1076 66C5 CA C8 71              jp   z,FIRE
 1077 66C8 FE 20        		 cp 32
 1078 66CA CA C5 71     		 jp z,nextsong
 1079 66CD C9                    ret
 1080 66CE 53 65 61 72  txtFilter defb "Search:           ",0
 1080 66D2 63 68 3A 20
 1080 66D6 20 20 20 20
 1080 66DA 20 20 20 20
 1080 66DE 20 20 00
 1081 66E1 00 00        savepoc defw 0
 1082 66E3 00 00        actadr	defw 0
 1083 66E5 00 00        h1		defw 0
 1084 66E7 53 65 61 72  txtFind defb "Search songs.",0
 1084 66EB 63 68 20 73
 1084 66EF 6F 6E 67 73
 1084 66F3 2E 00
 1085 66F5 4F 6E 6C 79  txtFind2 defb "Only chars, without spaces.",0
 1085 66F9 20 63 68 61
 1085 66FD 72 73 2C 20
 1085 6701 77 69 74 68
 1085 6705 6F 75 74 20
 1085 6709 73 70 61 63
 1085 670D 65 73 2E 00
 1086 6711 46 6F 75 6E  txtFinded defb "Found:",0
 1086 6715 64 3A 00
 1087 6718 4C 65 66 74  txtLeft defb "Left: ",0
 1087 671C 3A 20 00
 1088 671F CD 99 74     hledej	call savescr
 1089 6722 21 00 00     		ld hl,0
 1090 6725 22 B1 67     		ld (nalezeno+1),hl
 1091 6728 21 00 00     		ld hl,0
 1092 672B 22 E5 67     		ld (pozice+1),hl
 1093 672E 2A 4C 7A     		ld hl,(ALLFILES)
 1094 6731 22 E1 66     		ld (savepoc),hl
 1095 6734 21 0D 80     		ld hl,catbuff+#d
 1096 6737 22 E3 66     		ld (actadr),hl
 1097 673A
 1098 673A 21 20 48     		ld   hl,18464
 1099 673D 01 20 08             ld   bc,8*256+32
 1100 6740 3E 07                ld   a,%00000111
 1101 6742 CD 48 77             call RAMECEK
 1102 6745
 1103 6745 11 41 48     		ld de,18496+1
 1104 6748 21 E7 66     		ld hl,txtFind
 1105 674B CD 26 7B     		call print
 1106 674E
 1107 674E 11 61 48     		ld de,18528+1
 1108 6751 21 F5 66     		ld hl,txtFind2
 1109 6754 CD 26 7B     		call print
 1110 6757
 1111 6757 21 00 00     		ld hl,0
 1112 675A 22 E5 67     		ld (pozice+1),hl
 1113 675D 22 E5 66     		ld (h1),hl
 1114 6760
 1115 6760 21 A1 59     		ld hl,13*32+22528+1
 1116 6763 06 1D        		ld b,29
 1117 6765 36 68        po		ld (hl),01101000b
 1118 6767 23           		inc hl
 1119 6768 10 FB        		djnz po
 1120 676A
 1121 676A DD 26 1C     		ld hx,28 ;délka vstupu
 1122 676D 21 A1 48     		ld hl,18592+1 ;adresa na obrazovce
 1123 6770 CD 1D 60     		call INPUT ;volej vstupní podprogram
 1124 6773 FE 07        		cp 7 ;testuj EDIT
 1125 6775 CA 5F 69     		jp z,end_hledej
 1126 6778 21 00 5B     		ld hl,23296
 1127 677B 11 D6 66     		ld de,txtFilter + 8
 1128 677E 01 0A 00     		ld bc,10
 1129 6781 ED B0        		ldir
 1130 6783 11 6F 50     		ld de,20576+15
 1131 6786 21 CE 66     		ld hl,txtFilter
 1132 6789 CD 26 7B     		call print
 1133 678C
 1134 678C
 1135 678C 11 C1 48     		ld de,18624+1
 1136 678F 21 11 67     		ld hl,txtFinded
 1137 6792 CD 26 7B     		call print
 1138 6795
 1139 6795 11 E1 48     		ld de,18656+1
 1140 6798 21 18 67     		ld hl,txtLeft
 1141 679B CD 26 7B     		call print
 1142 679E
 1143 679E              ssss
 1144 679E ED 91 07 03  			nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 1145 67A2 CD 82 65     			call BUFF83
 1146 67A5 21 0D 80     			ld hl,catbuff+13; + 26 ;vynechej první dvě položky
 1147 67A8
 1148 67A8 ED 5B 4C 7A  			ld de,(ALLFILES)
 1149 67AC D5           htestovani	push de
 1150 67AD E5           			push hl
 1151 67AE
 1152 67AE E5           			push hl
 1153 67AF D5           			push de
 1154 67B0
 1155 67B0 21 00 00     nalezeno	ld hl,0
 1156 67B3 11 C5 48     			ld de,18624+5	;pozice ve VideoRam
 1157 67B6 ED 53 55 65  			ld (NUMPOS+1),de
 1158 67BA
 1159 67BA CD 22 65     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
 1160 67BD 00 14        			defw 20*256
 1161 67BF
 1162 67BF 2A E5 66     			ld hl,(h1)
 1163 67C2 23           			inc hl
 1164 67C3 22 E5 66     			ld (h1),hl
 1165 67C6
 1166 67C6 2A 4C 7A     			ld hl,(ALLFILES)
 1167 67C9 11 E5 48     			ld de,18656+5	;pozice ve VideoRam
 1168 67CC ED 53 55 65  			ld (NUMPOS+1),de
 1169 67D0 CD 22 65     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
 1170 67D3 00 14        			defw 20*256
 1171 67D5
 1172 67D5
 1173 67D5 21 34 BD     			ld hl,LFNNAME
 1174 67D8 11 35 BD     			ld de,LFNNAME+1
 1175 67DB AF           			xor  a
 1176 67DC 77           			ld (hl),a
 1177 67DD 01 80 00     			ld bc,128
 1178 67E0 ED B0        			ldir
 1179 67E2 D1           			pop de
 1180 67E3 E1           			pop hl
 1181 67E4 21 00 00     pozice		ld hl,0
 1182 67E7 E5           			push hl
 1183 67E8 CD B3 65     			call FINDLFN
 1184 67EB E1           			pop hl
 1185 67EC 23           			inc hl
 1186 67ED 22 E5 67     			ld (pozice+1),hl
 1187 67F0 11 00 5B     			ld de,23296
 1188 67F3 21 34 BD     			ld hl,LFNNAME
 1189 67F6 CD 3A 61     			call search
 1190 67F9 28 14        			jr z,hsouhlasi
 1191 67FB              			; pop de
 1192 67FB              			; push de		;v de mame zacatek jmena souboru
 1193 67FB
 1194 67FB              			; ld h,d
 1195 67FB              			; ld l,e
 1196 67FB              			; add hl,13		;vynechana jedna polozka
 1197 67FB
 1198 67FB              			; ld hl,(actadr)
 1199 67FB              			; ex de,hl
 1200 67FB
 1201 67FB              			; ld bc,13	;1260*13
 1202 67FB              			; ldir
 1203 67FB
 1204 67FB 2A 4C 7A     			ld hl,(ALLFILES)
 1205 67FE 2B           			dec hl
 1206 67FF 22 4C 7A     			ld (ALLFILES),hl
 1207 6802 E1           			pop hl
 1208 6803 11 0D 00     			ld de,13
 1209 6806 19           			add hl,de
 1210 6807 D1           			pop de
 1211 6808 1B           			dec de
 1212 6809 7A           			ld a,d
 1213 680A B3           			or e
 1214 680B 20 9F        			jr nz,htestovani
 1215 680D 18 3D        			jr hkon
 1216 680F 2A B1 67     hsouhlasi	ld hl,(nalezeno+1)
 1217 6812 23           			inc hl
 1218 6813 22 B1 67     			ld (nalezeno+1),hl
 1219 6816
 1220 6816 2A E3 66     			ld hl,(actadr)
 1221 6819 11 D0 68     			ld de,vymenafile
 1222 681C 01 0D 00     			ld bc,13
 1223 681F ED B0        			ldir				;ulož soubor, co bude vymazany
 1224 6821
 1225 6821 2A E3 66     			ld hl,(actadr)
 1226 6824 D1           			pop de
 1227 6825 D5           			push de
 1228 6826 EB           			ex de,hl
 1229 6827 01 0D 00     			ld bc,13
 1230 682A ED B0        			ldir			;nahrad
 1231 682C
 1232 682C D1           			pop de
 1233 682D D5           			push de
 1234 682E 21 D0 68     			ld hl,vymenafile
 1235 6831 01 0D 00     			ld bc,13
 1236 6834 ED B0        			ldir
 1237 6836
 1238 6836 2A E3 66     			ld hl,(actadr)
 1239 6839 11 0D 00     			ld de,13
 1240 683C 19           			add hl,de
 1241 683D 22 E3 66     			ld (actadr),hl
 1242 6840
 1243 6840 E1           			 pop hl
 1244 6841 11 0D 00     			 ld de,13
 1245 6844 19           			 add hl,de
 1246 6845 D1           			 pop de
 1247 6846 1B           			 dec de
 1248 6847 7A           			 ld a,d
 1249 6848 B3           			 or e
 1250 6849 C2 AC 67     			 jp nz,htestovani
 1251 684C              hkon
 1252 684C CD 55 6E     			 call GETDIR
 1253 684F 2A 4C 7A     			 ld hl,(ALLFILES)
 1254 6852
 1255 6852 7C           			 ld a,h
 1256 6853 B5           			 or l
 1257 6854 CA DD 68     			 jp z,nula
 1258 6857 21 C5 48     			 ld hl,18624+5
 1259 685A 22 62 6D     			 ld (lfnpos+1),hl
 1260 685D CD 28 6D     			 call getAllLFN
 1261 6860 21 98 48     			 ld hl,18560+24
 1262 6863 22 62 6D     			 ld (lfnpos+1),hl
 1263 6866
 1264 6866 21 00 00     			 ld hl,0
 1265 6869 22 33 76     			 ld (apos_all),hl
 1266 686C AF           			 xor a
 1267 686D 32 89 75     			 ld (POS_F + 1),a
 1268 6870
 1269 6870
 1270 6870 21 0D 80     			 ld hl,catbuff+#d
 1271 6873 22 52 79     		     ld (WRBUFF+1),hl
 1272 6876 CD 1A 78     			 call kresli
 1273 6879
 1274 6879
 1275 6879              			;call loadscr
 1276 6879 21 20 40     		    ld   hl,16416
 1277 687C 01 0E 14     		    ld   bc,20*256+14
 1278 687F 3E 0F        		    ld   a,%00001111
 1279 6881 CD 48 77     		    call RAMECEK
 1280 6884 CD 82 65     			 call BUFF83
 1281 6887 CD 3C 79     			call WRFILES
 1282 688A 11 2F 48     			ld de,18464+15
 1283 688D 21 7E 7F     			ld hl,txtcurrentfile
 1284 6890 CD 26 7B     			call print
 1285 6893
 1286 6893 11 0F 48     			ld de,18432+15
 1287 6896 21 73 7F     			ld hl,txtallfiles
 1288 6899 CD 26 7B     			call print
 1289 689C 11 6F 50     			ld de,20576+15
 1290 689F 21 CE 66     			ld hl,txtFilter
 1291 68A2 CD 26 7B     			call print
 1292 68A5              TISK
 1293 68A5 11 4F 50     			ld de,20544+15
 1294 68A8 21 02 70     			ld hl,lfndir
 1295 68AB CD 26 7B     			call print
 1296 68AE 11 52 50     			ld de,20544+15+3
 1297 68B1 21 41 6E     			ld hl,NAZEVADRESARE
 1298 68B4 CD 26 7B     			call print
 1299 68B7
 1300 68B7 CD 73 65     			call LFNWINDOW
 1301 68BA CD 12 66     			call LFNPRINT
 1302 68BD 21 59 BD     			ld hl,LFNNAME + maxline
 1303 68C0 36 00        			ld (hl),0
 1304 68C2 21 34 BD     			ld hl,LFNNAME
 1305 68C5 11 C2 50     			ld de,20672+2
 1306 68C8 CD 26 7B     			call print
 1307 68CB
 1308 68CB
 1309 68CB ED 91 07 00   			 nextreg #07,0			;3,5 MHz
 1310 68CF
 1311 68CF C9           			 ret
 1312 68D0 00 00 00...  vymenafile	ds 13
 1313 68DD              nula
 1314 68DD 21 40 48             ld   hl,18496
 1315 68E0 01 20 06             ld   bc,6*256+32
 1316 68E3 3E 07                ld   a,%00000111
 1317 68E5 CD 48 77             call RAMECEK
 1318 68E8
 1319 68E8
 1320 68E8 11 6A 48     		ld   de,18562+8-32
 1321 68EB 21 1C 69          	ld hl,nulatxt
 1322 68EE CD 26 7B             call print
 1323 68F1
 1324 68F1              		; ld   de,18560+7
 1325 68F1                   	; ld hl,reloadtxt
 1326 68F1                      ; call print
 1327 68F1
 1328 68F1 11 C6 48     		ld   de,18624+6
 1329 68F4 21 44 69          	ld hl,presstxt
 1330 68F7 CD 26 7B             call print
 1331 68FA
 1332 68FA 2A E1 66     		ld hl,(savepoc)
 1333 68FD 22 4C 7A     		ld (ALLFILES),hl
 1334 6900 76           nula1	halt
 1335 6901 AF           		XOR A ;test keyboard
 1336 6902 DB FE        		IN A,(#FE)
 1337 6904 2F           		CPL
 1338 6905 E6 0F        		AND 15
 1339 6907 28 F7        		JR Z,nula1
 1340 6909 AF           		XOR A ;test keyboard
 1341 690A DB FE        		IN A,(#FE)
 1342 690C 2F           		CPL
 1343 690D E6 0F        		AND 15
 1344 690F 28 EF        		JR Z,nula1
 1345 6911
 1346 6911 CD AD 74     		call loadscr
 1347 6914 ED 91 07 00  		nextreg #07,0			;3,5 MHz
 1348 6918 C9           		ret
 1349 6919 C3 ED 6D     		jp reload
 1350 691C
 1351 691C 4E 6F 74 68  nulatxt defb "Nothing found!",0
 1351 6920 69 6E 67 20
 1351 6924 66 6F 75 6E
 1351 6928 64 21 00
 1352 692B 49 20 6D 75  reloadtxt defb "I must reload directory!",0
 1352 692F 73 74 20 72
 1352 6933 65 6C 6F 61
 1352 6937 64 20 64 69
 1352 693B 72 65 63 74
 1352 693F 6F 72 79 21
 1352 6943 00
 1353 6944 50 72 65 73  presstxt defb "Press any key to continue.",0
 1353 6948 73 20 61 6E
 1353 694C 79 20 6B 65
 1353 6950 79 20 74 6F
 1353 6954 20 63 6F 6E
 1353 6958 74 69 6E 75
 1353 695C 65 2E 00
 1354 695F CD AD 74     end_hledej 	 call loadscr		;návrat pomocí klávesy EDIT
 1355 6962 C9           			 ret
 1356 6963 00 00 00...  templfn		ds	129
 1357 69E4              ;Posunutí o stránku výše - šipka doleva
 1358 69E4              left
 1359 69E4 2A 33 76     		ld hl,(apos_all)
 1360 69E7 7C           		ld a,h
 1361 69E8 B5           		or l
 1362 69E9 C8           		ret z  			;skončí, pokud jsme na nultém souboru
 1363 69EA
 1364 69EA 3A 89 75     		ld a,(POS_F+1)
 1365 69ED B7           		or a
 1366 69EE 28 32        		jr z,next_page_left
 1367 69F0
 1368 69F0 3A 89 75     		ld a,(POS_F+1)
 1369 69F3 0E 0F                ld  c,%00001111
 1370 69F5 CD 4F 7A             call KURZOR			;smaž kurzor
 1371 69F8
 1372 69F8 3A 89 75     		ld a,(POS_F+1)
 1373 69FB 5F           		ld e,a
 1374 69FC 16 00        		ld d,0
 1375 69FE 2A 33 76     		ld hl,(apos_all)
 1376 6A01 B7           		or a
 1377 6A02 ED 52        		sbc hl,de
 1378 6A04 22 33 76     		ld (apos_all),hl
 1379 6A07 AF           		xor a
 1380 6A08 32 89 75     		ld (POS_F+1),a
 1381 6A0B 0E 17                ld   c,%00010111
 1382 6A0D CD 4F 7A             call KURZOR
 1383 6A10 CD 12 66     		call LFNPRINT
 1384 6A13 21 59 BD     		ld hl,LFNNAME + maxline
 1385 6A16 36 00        		ld (hl),0
 1386 6A18 21 34 BD     		ld hl,LFNNAME
 1387 6A1B 11 C2 50     		ld de,20672+2
 1388 6A1E CD 26 7B     		call print
 1389 6A21
 1390 6A21 C9           		ret
 1391 6A22
 1392 6A22
 1393 6A22              next_page_left
 1394 6A22
 1395 6A22 2A 33 76     		ld hl,(apos_all)
 1396 6A25 11 11 00     		ld de,17
 1397 6A28 B7           		or a
 1398 6A29 ED 52        		sbc hl,de
 1399 6A2B 38 24        		jr c,next_left1		;méně než 17
 1400 6A2D 22 33 76     		ld (apos_all),hl
 1401 6A30 06 0D        		ld b,13
 1402 6A32 CD 1C 6D     		call mull
 1403 6A35 11 0D 80     		ld de,catbuff+13
 1404 6A38 19           		add hl,de
 1405 6A39 22 52 79     		ld (WRBUFF+1),hl
 1406 6A3C CD 3C 79     		call WRFILES
 1407 6A3F CD 12 66     		call LFNPRINT
 1408 6A42 21 59 BD     		ld hl,LFNNAME + maxline
 1409 6A45 36 00        		ld (hl),0
 1410 6A47 21 34 BD     		ld hl,LFNNAME
 1411 6A4A 11 C2 50     		ld de,20672+2
 1412 6A4D CD 26 7B     		call print
 1413 6A50
 1414 6A50
 1415 6A50 C9           		ret
 1416 6A51              next_left1
 1417 6A51 21 00 00     		ld hl,0
 1418 6A54 22 33 76     		ld (apos_all),hl
 1419 6A57 21 0D 80     		ld hl,catbuff+13
 1420 6A5A 22 52 79     		ld (WRBUFF+1),hl
 1421 6A5D CD 3C 79     		call WRFILES
 1422 6A60 CD 12 66     		call LFNPRINT
 1423 6A63 21 59 BD     		ld hl,LFNNAME + maxline
 1424 6A66 36 00        		ld (hl),0
 1425 6A68 21 34 BD     		ld hl,LFNNAME
 1426 6A6B 11 C2 50     		ld de,20672+2
 1427 6A6E CD 26 7B     		call print
 1428 6A71
 1429 6A71 C9           		ret
 1430 6A72
 1431 6A72              ; Posunutí o stránku níž - šipka doprava
 1432 6A72              right
 1433 6A72 2A 4C 7A     		ld hl,(ALLFILES)
 1434 6A75 2B           		dec hl
 1435 6A76
 1436 6A76 1E 11        		ld e,17
 1437 6A78 16 00        		ld d,0
 1438 6A7A B7           		or a
 1439 6A7B ED 52        		sbc hl,de
 1440 6A7D 19           		add hl,de
 1441 6A7E DA BA 6C     		jp c,posledni
 1442 6A81
 1443 6A81 3A 89 75     		ld a,(POS_F+1)
 1444 6A84 FE 11        		cp 17
 1445 6A86 CA 52 6C     		jp z,next_page
 1446 6A89
 1447 6A89 3A 89 75     		ld  a,(POS_F+1)		;na konec stránky
 1448 6A8C F5           		push af
 1449 6A8D 0E 0F                ld  c,%00001111
 1450 6A8F CD 4F 7A             call KURZOR
 1451 6A92 3E 11        		ld a,17
 1452 6A94 32 89 75     		ld (POS_F+1),a
 1453 6A97 2A 33 76     		ld hl,(apos_all)
 1454 6A9A C1           		pop bc
 1455 6A9B F5           		push af
 1456 6A9C 3E 11        		ld a,17
 1457 6A9E B7           		or a
 1458 6A9F 98           		sbc a,b
 1459 6AA0 5F           		ld e,a
 1460 6AA1 16 00        		ld d,0
 1461 6AA3 19           		add hl,de
 1462 6AA4 22 33 76     		ld (apos_all),hl
 1463 6AA7 0E 17                ld   c,%00010111
 1464 6AA9 F1           		pop af
 1465 6AAA CD 4F 7A             call KURZOR
 1466 6AAD CD 12 66     		call LFNPRINT
 1467 6AB0 21 59 BD     		ld hl,LFNNAME + maxline
 1468 6AB3 36 00        		ld (hl),0
 1469 6AB5 21 34 BD     		ld hl,LFNNAME
 1470 6AB8 11 C2 50     		ld de,20672+2
 1471 6ABB CD 26 7B     		call print
 1472 6ABE
 1473 6ABE C9           		ret
 1474 6ABF
 1475 6ABF
 1476 6ABF              reload_dir
 1477 6ABF
 1478 6ABF F3           			di
 1479 6AC0 CD 82 65     			call BUFF83
 1480 6AC3 21 00 80     			ld hl,#8000
 1481 6AC6 11 01 80     			ld de,#8001
 1482 6AC9 01 00 04     			ld bc,1024
 1483 6ACC AF           			xor a
 1484 6ACD 77           			ld (hl),a
 1485 6ACE ED B0        			ldir
 1486 6AD0
 1487 6AD0 01 FD 7F     			ld bc,port1       ;the horizontal ROM switch/RAM
 1488 6AD3                                              ;switch I/O ad dress
 1489 6AD3 3A 5C 5B                 ld a,(bankm)      ;sys tem vari able that holds cur rent
 1490 6AD6                                              ;switch state
 1491 6AD6 CB A7                    res 4,a           ;move right to left in hor i zon tal
 1492 6AD8                                              ;ROM switch (3 to 2)
 1493 6AD8
 1494 6AD8 F6 07                      or 7              ;switch in RAM page 7
 1495 6ADA 32 5C 5B                   ld (bankm),a      ;must keep sys tem vari able up to
 1496 6ADD                            	                  ;date (very im por tant)
 1497 6ADD ED 79                      out (c),a         ;make the switch
 1498 6ADF
 1499 6ADF                                             ;be low BFE0h
 1500 6ADF FB                         ei                ;in ter rupts can now be en abled
 1501 6AE0
 1502 6AE0 21 00 80                   ld hl,catbuff     ;some where for DOS to put the cata
 1503 6AE3                                              ;log
 1504 6AE3 11 01 80                   ld de,catbuff+1   ;
 1505 6AE6 01 00 04                   ld bc,1024        ;max i mum (for +3DOS) is ac tu ally
 1506 6AE9                                              ;64x13+13 = 845
 1507 6AE9 36 00                      ld (hl),0
 1508 6AEB ED B0                      ldir              ;make sure at least first en try is
 1509 6AED 11 00 80                   ld de,catbuff     ;the lo ca tion to be filled with the
 1510 6AF0              aNextDirItem
 1511 6AF0 06 E7                      ld b,pocetpolozek ;the num ber of en tries in the
 1512 6AF2                                              ;buffer
 1513 6AF2 0E 04                      ld c,%100            ;include sys tem files in the cata
 1514 6AF4 21 8F 66                   ld hl,stardstar   ;the file name ("*.*")
 1515 6AF7 CD 1E 01                   call dos_catalog  ;call the DOS en try
 1516 6AFA              NEXT0
 1517 6AFA 22 AD 61                   ld (savehl),hl
 1518 6AFD DD 22 AF 61  			  ld (saveix),ix
 1519 6B01 78           			  ld a,b
 1520 6B02 FE E7        			  cp pocetpolozek
 1521 6B04 F5           			  push af
 1522 6B05
 1523 6B05 2A 4C 7A     			  ld hl,(ALLFILES)
 1524 6B08 58           			  ld e,b
 1525 6B09 16 00        			  ld d,0
 1526 6B0B 19           			  add hl,de
 1527 6B0C 2B           			  dec hl
 1528 6B0D 22 4C 7A     			  ld (ALLFILES),hl
 1529 6B10
 1530 6B10 E5           			push hl
 1531 6B11 D5           			push de
 1532 6B12 C5           			push bc
 1533 6B13
 1534 6B13
 1535 6B13 2A 71 65     			ld hl,(dirNum)
 1536 6B16 19           			add	hl,de
 1537 6B17 2B           			dec hl
 1538 6B18 22 71 65     			ld 	(dirNum),hl
 1539 6B1B 11 78 48     			ld de,18528+24
 1540 6B1E ED 53 55 65  			ld (NUMPOS+1),de
 1541 6B22
 1542 6B22 CD 22 65     			call DEC16
 1543 6B25 00 14        			defw 20*256
 1544 6B27 C1           			pop bc
 1545 6B28 D1           			pop de
 1546 6B29 E1           			pop hl
 1547 6B2A
 1548 6B2A
 1549 6B2A 3A 4B 7A     			  ld a,(FILES)
 1550 6B2D 80           			  add a,b
 1551 6B2E 3D           			  dec a
 1552 6B2F 32 4B 7A     			  ld (FILES),a
 1553 6B32 F1           			  pop af
 1554 6B33 38 15        			  jr c,acont
 1555 6B35
 1556 6B35 78           			  ld a,b
 1557 6B36 B7           			  or a
 1558 6B37 28 11        			  jr z,acont
 1559 6B39
 1560 6B39 3A 0F 60     			  ld a,(virtmem)
 1561 6B3C FE 04        			  cp 4
 1562 6B3E 28 0A        			  jr z,acont
 1563 6B40
 1564 6B40 CD A2 61     			  call CountMemory
 1565 6B43 EB           			  ex de,hl
 1566 6B44 21 0F 60     			ld hl,virtmem
 1567 6B47 34           			inc (hl)
 1568 6B48 18 A6        			jr aNextDirItem
 1569 6B4A              acont
 1570 6B4A F5                       push af
 1571 6B4B
 1572 6B4B 2A 71 65     			ld hl,(dirNum)
 1573 6B4E 11 78 48     			ld de,18528+24
 1574 6B51 ED 53 55 65  			ld (NUMPOS+1),de
 1575 6B55 76           			halt
 1576 6B56 CD 22 65     			call DEC16
 1577 6B59 00 14        			defw 20*256
 1578 6B5B
 1579 6B5B E1                         pop hl
 1580 6B5C 22 95 66                   ld (dosret),hl    ;put it where it can be seen from
 1581 6B5F                                              ; NextBASIC
 1582 6B5F 48                         ld c,b            ;move num ber of files in cat a log to
 1583 6B60                                              ;low byte of BC
 1584 6B60 06 00                      ld b,0            ;this will be re turned in NextBASIC
 1585 6B62
 1586 6B62 F3                         di                ;about to ROM/RAM switch so be
 1587 6B63                                              ;care ful
 1588 6B63 C5                         push bc           ;save num ber of files
 1589 6B64 01 FD 7F                   ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 1590 6B67                                              ;switch
 1591 6B67 3A 5C 5B                   ld a,(bankm)      ;get cur rent switch state
 1592 6B6A
 1593 6B6A
 1594 6B6A CB E7                      set 4,a           ;move left to right (ROM 2 to ROM
 1595 6B6C                                              ;3)
 1596 6B6C E6 F8                      and #F8           ;also want RAM page 0
 1597 6B6E 32 5C 5B                   ld (bankm),a      ;up date the sys tem vari able (very
 1598 6B71                                              ;im por tant)
 1599 6B71 ED 79                      out (c),a         ;make the switch
 1600 6B73 C1                         pop bc            ;get back the saved num ber of files
 1601 6B74 0B                         dec bc
 1602 6B75
 1603 6B75
 1604 6B75
 1605 6B75 CD 82 65     			 call BUFF83
 1606 6B78              JKJK
 1607 6B78 21 0D 80     			 ld hl,catbuff+13
 1608 6B7B ED 5B 4C 7A  			 ld de,(ALLFILES)
 1609 6B7F ED 53 10 60  			 ld (save_allfiles),de
 1610 6B83              ;			 dec de
 1611 6B83 D5           atestovani	 push de
 1612 6B84 E5           			 push hl
 1613 6B85 DD E1        			 pop ix
 1614 6B87 DD E5        			 push ix
 1615 6B89 DD CB 07 7E  			 bit 7,(ix+7)
 1616 6B8D              ;			 pop hl
 1617 6B8D 20 53        			 jr nz,asouhlasi
 1618 6B8F
 1619 6B8F 11 08 00     			 ld de,8
 1620 6B92 19           			 add hl,de		;v HL je začátek přípony souboru
 1621 6B93 E5           			 push hl
 1622 6B94 11 F1 73     			 ld de,PT2
 1623 6B97 CD 8F 61     			 call compare
 1624 6B9A E1           			 pop hl
 1625 6B9B 28 45        			 jr z,asouhlasi
 1626 6B9D E5           			 push hl
 1627 6B9E 11 F4 73     			 ld de,PT3
 1628 6BA1 CD 8F 61     			 call compare
 1629 6BA4 E1           			 pop hl
 1630 6BA5 28 3B        			 jr z,asouhlasi
 1631 6BA7 11 F7 73     			 ld de,SQT
 1632 6BAA E5           			 push hl
 1633 6BAB CD 8F 61     			 call compare
 1634 6BAE E1           			 pop hl
 1635 6BAF 28 31        			 jr z,asouhlasi
 1636 6BB1
 1637 6BB1 11 FA 73     			 ld de,STC
 1638 6BB4 E5           			 push hl
 1639 6BB5 CD 8F 61     			 call compare
 1640 6BB8 E1           			 pop hl
 1641 6BB9 28 27        			 jr z,asouhlasi
 1642 6BBB
 1643 6BBB 11 FD 73      			 ld de,STP
 1644 6BBE E5           			 push hl
 1645 6BBF CD 8F 61     			 call compare
 1646 6BC2 E1           			 pop hl
 1647 6BC3 28 1D        			 jr z,asouhlasi
 1648 6BC5
 1649 6BC5 D1           			 pop de
 1650 6BC6 D5           			 push de		;v de mame zacatek jmena souboru
 1651 6BC7 62           			 ld h,d
 1652 6BC8 6B           			 ld l,e
 1653 6BC9 ED 34 0D 00  			 add hl,13		;vynechana jedna polozka
 1654 6BCD 01 36 2E     			 ld bc,910*13
 1655 6BD0 ED B0        			 ldir
 1656 6BD2
 1657 6BD2 2A 4C 7A     			 ld hl,(ALLFILES)
 1658 6BD5 2B           			 dec hl
 1659 6BD6 22 4C 7A     			 ld (ALLFILES),hl
 1660 6BD9 E1           			 pop hl
 1661 6BDA D1           			 pop de
 1662 6BDB 1B           			 dec de
 1663 6BDC 7A           			 ld a,d
 1664 6BDD B3           			 or e
 1665 6BDE 20 A3        			 jr nz,atestovani
 1666 6BE0 18 0B        			 jr askon
 1667 6BE2              asouhlasi
 1668 6BE2 E1           			 pop hl
 1669 6BE3 11 0D 00     			 ld de,13
 1670 6BE6 19           			 add hl,de
 1671 6BE7 D1           			 pop de
 1672 6BE8 1B           			 dec de
 1673 6BE9 7A           			 ld a,d
 1674 6BEA B3           			 or e
 1675 6BEB 20 96        			 jr nz,atestovani
 1676 6BED FB           askon		ei
 1677 6BEE
 1678 6BEE 11 84 48     			 ld de,18560+4
 1679 6BF1 21 E5 6C     			 ld hl,txtLFNinfo
 1680 6BF4 CD 26 7B     			 call print
 1681 6BF7 CD 28 6D     			 call getAllLFN
 1682 6BFA CD 55 6E     			call GETDIR
 1683 6BFD 21 00 40     			 ld hl,16384
 1684 6C00 11 01 40     			 ld de,16385
 1685 6C03 01 FF 17     			 ld bc,6143
 1686 6C06 AF           			 xor a
 1687 6C07 77           			 ld (hl),a
 1688 6C08 ED B0        			 ldir
 1689 6C0A
 1690 6C0A CD 93 65     			 call NOBUFF83
 1691 6C0D
 1692 6C0D CD 1A 78                  call kresli
 1693 6C10
 1694 6C10 21 0D 80     			 ld hl,catbuff+#d
 1695 6C13 22 52 79     		     ld (WRBUFF+1),hl
 1696 6C16
 1697 6C16 CD 3C 79                  call WRFILES      ;vypis soubory
 1698 6C19 11 2F 48     			 ld de,18464+15
 1699 6C1C 21 7E 7F     			 ld hl,txtcurrentfile
 1700 6C1F CD 26 7B     			 call print
 1701 6C22
 1702 6C22 11 0F 48     			 ld de,18432+15
 1703 6C25 21 73 7F     			 ld hl,txtallfiles
 1704 6C28 CD 26 7B     			 call print
 1705 6C2B
 1706 6C2B
 1707 6C2B 11 4F 50     			ld de,20544+15
 1708 6C2E 21 02 70     			ld hl,lfndir
 1709 6C31 CD 26 7B     			call print
 1710 6C34 11 52 50     			ld de,20544+15+3
 1711 6C37 21 41 6E     			ld hl,NAZEVADRESARE
 1712 6C3A CD 26 7B     			call print
 1713 6C3D
 1714 6C3D
 1715 6C3D CD 73 65     			call LFNWINDOW
 1716 6C40 CD 12 66     			call LFNPRINT
 1717 6C43 21 59 BD     			ld hl,LFNNAME + maxline
 1718 6C46 36 00        			ld (hl),0
 1719 6C48 21 34 BD     			ld hl,LFNNAME
 1720 6C4B 11 C2 50     			ld de,20672+2
 1721 6C4E CD 26 7B     			call print
 1722 6C51
 1723 6C51 C9           		ret
 1724 6C52
 1725 6C52
 1726 6C52              next_page
 1727 6C52 2A 33 76     		ld hl,(apos_all)
 1728 6C55 23           		inc hl
 1729 6C56              		;test jestli už není víc souborů
 1730 6C56
 1731 6C56 EB           		ex de,hl			;de ... aktualni pozice začátku výpisu
 1732 6C57 2A 4C 7A     		ld hl,(ALLFILES)	;hl ... pocet souboru
 1733 6C5A D5           		push de
 1734 6C5B 11 12 00     		ld de,18			;odečti počet na jednu stránku
 1735 6C5E B7           		or a
 1736 6C5F ED 52        		sbc hl,de			;hl ... počet souborů - 18
 1737 6C61 D1           		pop de				;de ... aktuální pozice
 1738 6C62 B7           		or a
 1739 6C63 ED 52        		sbc hl,de
 1740 6C65 30 10        		jr nc, next2
 1741 6C67 2A 4C 7A     		ld hl,(ALLFILES)
 1742 6C6A B7           		or a
 1743 6C6B 11 11 00     		ld de,17
 1744 6C6E ED 52        		sbc hl,de
 1745 6C70 3E 01        		ld a,1
 1746 6C72 32 B9 6C     		ld (maxfile),a
 1747 6C75 18 08        		jr next3
 1748 6C77              next2
 1749 6C77 2A 33 76     		ld hl,(apos_all)
 1750 6C7A 23           		inc hl
 1751 6C7B AF           		xor a
 1752 6C7C 32 B9 6C     		ld (maxfile),a
 1753 6C7F              next3
 1754 6C7F 06 0D        		ld b,13
 1755 6C81 CD 1C 6D     		call mull
 1756 6C84 11 00 80     		ld de,catbuff ;+13
 1757 6C87 19           		add hl,de
 1758 6C88 22 52 79     		ld (WRBUFF+1),hl
 1759 6C8B CD 3C 79     		call WRFILES
 1760 6C8E 3A B9 6C     		ld a,(maxfile)
 1761 6C91 B7           		or a
 1762 6C92 20 0C        		jr nz,next4
 1763 6C94 2A 33 76     		ld hl,(apos_all)
 1764 6C97 11 11 00     		ld de,17
 1765 6C9A 19           		add hl,de
 1766 6C9B 22 33 76     		ld (apos_all),hl
 1767 6C9E 18 07        		jr next5
 1768 6CA0 2A 4C 7A     next4	ld hl,(ALLFILES)
 1769 6CA3 2B           		dec hl
 1770 6CA4 22 33 76     		ld (apos_all),hl
 1771 6CA7 CD 12 66     next5	call LFNPRINT
 1772 6CAA 21 59 BD     		ld hl,LFNNAME + maxline
 1773 6CAD 36 00        		ld (hl),0
 1774 6CAF 21 34 BD     		ld hl,LFNNAME
 1775 6CB2 11 C2 50     		ld de,20672+2
 1776 6CB5 CD 26 7B     		call print
 1777 6CB8
 1778 6CB8 C9           		ret
 1779 6CB9 00           maxfile	db 0
 1780 6CBA              posledni					;méně souborů než 17
 1781 6CBA 3A 89 75     	     ld  a,(POS_F+1)
 1782 6CBD 0E 0F                 ld  c,%00001111
 1783 6CBF CD 4F 7A              call KURZOR
 1784 6CC2 2A 4C 7A     		 ld hl,(ALLFILES)
 1785 6CC5 2B           		 dec hl
 1786 6CC6 7D           		 ld a,l
 1787 6CC7 32 89 75     		 ld (POS_F+1),a
 1788 6CCA
 1789 6CCA 22 33 76     		 ld (apos_all),hl
 1790 6CCD 0E 17                 ld   c,%00010111
 1791 6CCF CD 4F 7A              call KURZOR
 1792 6CD2 CD 12 66     		 call LFNPRINT
 1793 6CD5 21 59 BD     		ld hl,LFNNAME + maxline
 1794 6CD8 36 00        		ld (hl),0
 1795 6CDA 21 34 BD     		ld hl,LFNNAME
 1796 6CDD 11 C2 50     		ld de,20672+2
 1797 6CE0 CD 26 7B     		call print
 1798 6CE3
 1799 6CE3 C9           		 ret
 1800 6CE4
 1801 6CE4
 1802 6CE4              right1
 1803 6CE4
 1804 6CE4
 1805 6CE4 C9           		ret
 1806 6CE5
 1807 6CE5 47 65 74 74  txtLFNinfo defb "Getting LFN information:",0
 1807 6CE9 69 6E 67 20
 1807 6CED 4C 46 4E 20
 1807 6CF1 69 6E 66 6F
 1807 6CF5 72 6D 61 74
 1807 6CF9 69 6F 6E 3A
 1807 6CFD 00
 1808 6CFE 52 65 61 64  txtStart   defb "Reading files in directory:",0
 1808 6D02 69 6E 67 20
 1808 6D06 66 69 6C 65
 1808 6D0A 73 20 69 6E
 1808 6D0E 20 64 69 72
 1808 6D12 65 63 74 6F
 1808 6D16 72 79 3A 00
 1809 6D1A              ;Nacte LFN vsech souboru nahranych v pameti
 1810 6D1A
 1811 6D1A 00 00        numLoop		defw 0
 1812 6D1C
 1813 6D1C
 1814 6D1C
 1815 6D1C              ; Násobení HL x B
 1816 6D1C              ; Vysledek HL
 1817 6D1C 55           mull		ld d,l		;vynásob spodní byty
 1818 6D1D 58           			ld e,b		;
 1819 6D1E ED 30        			mul d,e		;vysledek je v de
 1820 6D20 EB           			ex de,hl	;vysledek je v hl
 1821 6D21 58           			ld e,b		;násobitel do e
 1822 6D22 ED 30        			mul d,e		;vynásob
 1823 6D24 7B           			ld a,e		;do akumulátoru hoď výsledek (spodní byte)
 1824 6D25 84           			add a,h
 1825 6D26 67           			ld h,a		;konečný výsledek je v HL
 1826 6D27 C9           			ret
 1827 6D28
 1828 6D28              ; Tato rutina naplní banky ZX Next LFN jmény souborů,
 1829 6D28              ; o délce 128bytů.
 1830 6D28 FB           getAllLFN	ei
 1831 6D29 21 00 00     			ld hl,0
 1832 6D2C 22 1A 6D     			ld (numLoop),hl
 1833 6D2F 21 00 E0     			ld hl,#e000
 1834 6D32 22 8A 6D     			ld (InBuff+1),hl
 1835 6D35 3E 18        			ld a,24
 1836 6D37 32 85 6D     			ld (Page+1),a
 1837 6D3A CD 99 74     			call savescr
 1838 6D3D
 1839 6D3D CD 82 65     			call BUFF83
 1840 6D40 21 0D 80     			ld hl,catbuff+#d
 1841 6D43 11 DE 6D     			ld de,bufftmp
 1842 6D46 01 0D 00     			ld bc,13
 1843 6D49 ED B0        			ldir
 1844 6D4B CD 93 65     			call NOBUFF83
 1845 6D4E
 1846 6D4E 21 0D 80     			ld hl,catbuff+#d
 1847 6D51 22 DC 6D     			ld (tmpname),hl
 1848 6D54 ED 4B 4C 7A  			ld bc,(ALLFILES)
 1849 6D58 C5           LFN1		push bc
 1850 6D59 FB           			ei
 1851 6D5A
 1852 6D5A 2A 1A 6D     			ld hl,(numLoop)
 1853 6D5D 23           			inc hl
 1854 6D5E 22 1A 6D     			ld 	(numLoop),hl
 1855 6D61 11 98 48     lfnpos			ld de,18560+24	;pozice ve VideoRam
 1856 6D64 ED 53 55 65  			ld (NUMPOS+1),de
 1857 6D68 CD 22 65     			call DEC16		;vypiš číso HL - jaký soubor právě spracováváme
 1858 6D6B 00 14        			defw 20*256
 1859 6D6D F3           			di				;zakaž přerušení, jinak bude problém, nemáme nastránkovanou ZX Rom
 1860 6D6E
 1861 6D6E D9           			exx
 1862 6D6F              BFN
 1863 6D6F 11 DE 6D     BufferName	ld de,bufftmp			;jmeno souboru
 1864 6D72 21 8F 66     			ld hl,stardstar
 1865 6D75 DD 2A AD 61  			ld ix,(savehl)
 1866 6D79 01 34 BD     			ld bc,LFNNAME
 1867 6D7C D9           			exx
 1868 6D7D 0E 07        			ld c,7
 1869 6D7F 11 B7 01     			ld de,$01b7
 1870 6D82 CF           			rst 8			;služba EsxDosu, která volá službu +3Dosu (zjištění LFN konkrétního souboru)
 1871 6D83 94           			defb M_P3DOS
 1872 6D84 3E 18        Page		ld a,24
 1873 6D86 ED 92 57     			nextreg $57,a	;nastrankuj stranku s volnymi daty
 1874 6D89
 1875 6D89 11 00 E0     InBuff		ld de,#e000		;ukazatel na pamet v bufferu
 1876 6D8C 21 34 BD     			ld hl,LFNNAME	;buffer pro LFN
 1877 6D8F 01 80 00     			ld bc,maxlen		;ulož 64 bytů
 1878 6D92 ED B0        			ldir
 1879 6D94
 1880 6D94 CD 82 65     			call BUFF83
 1881 6D97 2A DC 6D     			ld hl,(tmpname)	;přesuň se na další položku v adresáři
 1882 6D9A 11 0D 00     			ld de,13
 1883 6D9D 19           			add hl,de
 1884 6D9E 22 DC 6D     			ld (tmpname),hl	;a ulož adresu, kde se nachází
 1885 6DA1 11 DE 6D     			ld de,bufftmp
 1886 6DA4 01 0D 00     			ld bc,13
 1887 6DA7 ED B0        			ldir
 1888 6DA9
 1889 6DA9 CD 93 65     			call NOBUFF83
 1890 6DAC
 1891 6DAC 3A 85 6D     			ld a,(Page+1)
 1892 6DAF ED 92 57     			nextreg $57,a
 1893 6DB2
 1894 6DB2 2A 8A 6D     			ld hl,(InBuff+1)		;vypočti další adresu v bance ZX Next, kam budu ukládat
 1895 6DB5 11 80 00     			ld de,maxlen
 1896 6DB8 19           			add hl,de
 1897 6DB9 22 8A 6D     			ld (InBuff+1),hl
 1898 6DBC
 1899 6DBC 11 7F FF     			ld de,#FFFF-128
 1900 6DBF B7           			or a
 1901 6DC0 ED 52        			sbc hl,de
 1902 6DC2 38 0A        			jr c,contin
 1903 6DC4 21 85 6D     			ld hl,Page+1
 1904 6DC7 34           			inc (hl)
 1905 6DC8 21 00 E0     			ld hl,#e000
 1906 6DCB 22 8A 6D     			ld (InBuff+1),hl
 1907 6DCE C1           contin		pop bc				;zopakuj to pro všechny soubory, které máme načtené...
 1908 6DCF 0B           			dec bc
 1909 6DD0 78           			ld a,b
 1910 6DD1 B1           			or c
 1911 6DD2 20 84        			jr nz,LFN1
 1912 6DD4
 1913 6DD4 ED 91 57 01  			nextreg $57,1			;vráť zpátky stránku, kde se nachází data pro player
 1914 6DD8 CD AD 74     			call loadscr			;obnov obrazovku
 1915 6DDB C9           			ret
 1916 6DDC 00 00        tmpname		ds 2
 1917 6DDE              BFT
 1918 6DDE 00 00 00...  bufftmp		ds 15
 1919 6DED              M_P3DOS	equ $94
 1920 6DED              reload
 1921 6DED ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 1922 6DF1 21 42 48     		ld hl, 18496+2
 1923 6DF4 01 1C 04     		ld   bc,4*256+28
 1924 6DF7 3E 05        		ld   a,%00000101
 1925 6DF9 CD 48 77     		call RAMECEK
 1926 6DFC
 1927 6DFC 11 64 48     		ld de,18528+4
 1928 6DFF 21 FE 6C     		ld hl,txtStart
 1929 6E02 CD 26 7B     		call print
 1930 6E05
 1931 6E05 21 00 00     		ld hl,0
 1932 6E08 22 4C 7A     		ld (ALLFILES),hl
 1933 6E0B 22 71 65     		ld (dirNum),hl
 1934 6E0E 22 33 76     		ld (apos_all),hl
 1935 6E11 AF           		xor a
 1936 6E12 32 89 75     		ld (POS_F+1),a
 1937 6E15 32 0F 60     		ld (virtmem),a
 1938 6E18 21 00 80     		ld hl,catbuff
 1939 6E1B 22 A6 61     		ld (Count11+1),hl
 1940 6E1E              		; ld hl,(save_allfiles)
 1941 6E1E              		; ld (ALLFILES),hl
 1942 6E1E CD BF 6A     		call reload_dir
 1943 6E21              		; ld de,18560+4
 1944 6E21              			 ; ld hl,txtLFNinfo
 1945 6E21              			 ; call print
 1946 6E21              			 ; call getAllLFN
 1947 6E21
 1948 6E21              			 ; ld hl,16384
 1949 6E21              			 ; ld de,16385
 1950 6E21              			 ; ld bc,6143
 1951 6E21              			 ; xor a
 1952 6E21              			 ; ld (hl),a
 1953 6E21              			 ; ldir
 1954 6E21
 1955 6E21
 1956 6E21              			; call NOBUFF83
 1957 6E21                           ; call kresli
 1958 6E21
 1959 6E21              			 ; ld hl,catbuff+#d
 1960 6E21              		     ; ld (WRBUFF+1),hl
 1961 6E21
 1962 6E21                           ; call WRFILES      ;vypis soubory
 1963 6E21              			 ; ld de,18464+15
 1964 6E21              			 ; ld hl,txtcurrentfile
 1965 6E21              			 ; call print
 1966 6E21
 1967 6E21              			 ; ld de,18432+15
 1968 6E21              			 ; ld hl,txtallfiles
 1969 6E21              			 ; call print
 1970 6E21
 1971 6E21              			; call LFNWINDOW
 1972 6E21              			; call LFNPRINT
 1973 6E21              			; ld hl,LFNNAME + maxline
 1974 6E21              			; ld (hl),0
 1975 6E21              			; ld hl,LFNNAME
 1976 6E21              			; ld de,20672+2
 1977 6E21              			; call print
 1978 6E21
 1979 6E21 ED 91 07 00  		nextreg #07,0             ;3,5 Mhz
 1980 6E25 C9           		ret
 1981 6E26 00 00 00...  DIRNAME	defs 13
 1982 6E33 FF           		defb 255
 1983 6E34 43 3A FF     DIRTMP  defb "C:",255
 1984 6E37 00 00 00...  		ds 10
 1985 6E41 00 00 00...  NAZEVADRESARE	ds 20
 1986 6E55              GETDIR
 1987 6E55 21 34 6E     		ld hl,DIRTMP
 1988 6E58 11 26 BD     		ld de,modstart
 1989 6E5B 01 04 00     		ld bc,4
 1990 6E5E ED B0        		ldir
 1991 6E60
 1992 6E60 01 FD 7F     		ld bc,port1
 1993 6E63 3A 5C 5B             ld a,(bankm)      ;sys tem vari able that holds cur rent
 1994 6E66 CB A7                res 4,a           ;move right to left in hor i zon tal
 1995 6E68 F6 07                or 7              ;switch in RAM page 7
 1996 6E6A 32 5C 5B             ld (bankm),a      ;must keep sys tem vari able up to
 1997 6E6D ED 79                out (c),a         ;make the switch
 1998 6E6F
 1999 6E6F 3E 01        		ld a,1				;get path
 2000 6E71 21 26 BD     		ld hl,modstart
 2001 6E74 CD B1 01     		call $01b1
 2002 6E77
 2003 6E77 38 04        		jr c,ok1
 2004 6E79 3E 02        EEEE	ld a,2
 2005 6E7B D3 FE        		out (254),a
 2006 6E7D
 2007 6E7D 01 FD 7F     ok1		ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 2008 6E80 3A 5C 5B             ld a,(bankm)      ;get cur rent switch state
 2009 6E83 CB E7                set 4,a           ;move left to right (ROM 2 to ROM
 2010 6E85 E6 F8                and #F8           ;also want RAM page 0
 2011 6E87 32 5C 5B             ld (bankm),a      ;up date the sys tem vari able (very
 2012 6E8A ED 79                out (c),a         ;make the switch
 2013 6E8C
 2014 6E8C 21 26 BD     		ld hl,modstart
 2015 6E8F 01 00 04     		ld bc,1024
 2016 6E92 3E FF        		ld a,#ff
 2017 6E94 ED B1        		cpir
 2018 6E96              AAA
 2019 6E96 2B           		dec hl
 2020 6E97 2B           		dec hl
 2021 6E98 2B           		dec hl
 2022 6E99
 2023 6E99 E5           		push hl
 2024 6E9A 21 2A 70     		ld hl,DIRBUFF
 2025 6E9D 11 2B 70     		ld de,DIRBUFF+1
 2026 6EA0 01 0D 00     		ld bc,13
 2027 6EA3 3E 20        		ld a,32
 2028 6EA5 77           		ld (hl),a
 2029 6EA6 ED B0        		ldir
 2030 6EA8 E1           		pop hl
 2031 6EA9
 2032 6EA9
 2033 6EA9 7E           pr1		ld a,(hl)
 2034 6EAA FE 2F        		cp "/"
 2035 6EAC 28 08        		jr z,pr0
 2036 6EAE FE 3A        		cp ":"
 2037 6EB0 CA 07 70     		jp z,root
 2038 6EB3
 2039 6EB3 2B           		dec hl
 2040 6EB4 18 F3        		jr pr1
 2041 6EB6
 2042 6EB6
 2043 6EB6 23           pr0		inc hl
 2044 6EB7
 2045 6EB7 11 2A 70     		ld de,DIRBUFF
 2046 6EBA 06 08        		ld b,8
 2047 6EBC              presun
 2048 6EBC 7E           		ld a,(hl)
 2049 6EBD FE 2F        		cp "/"
 2050 6EBF 28 05        		jr z,prk
 2051 6EC1 12           		ld (de),a
 2052 6EC2 13           		inc de
 2053 6EC3 23           		inc hl
 2054 6EC4 10 F6        		djnz presun
 2055 6EC6
 2056 6EC6              prk
 2057 6EC6
 2058 6EC6 21 2A 70     		ld hl,DIRBUFF
 2059 6EC9 01 07 00     		ld bc,7
 2060 6ECC 3E 2E        		ld a,"."
 2061 6ECE
 2062 6ECE ED B1        		cpir
 2063 6ED0 20 1E        		jr nz,PRK2
 2064 6ED2 E5           		push hl
 2065 6ED3 11 32 70     		ld de,DIRBUFF+8
 2066 6ED6 01 04 00     		ld bc,4
 2067 6ED9 ED B0        		ldir
 2068 6EDB              PRK0
 2069 6EDB E1           		pop hl				;adresa s teckou v HL
 2070 6EDC 2B           		dec hl
 2071 6EDD E5           		push hl
 2072 6EDE EB           		ex de,hl			;je v DE
 2073 6EDF 21 31 70     		ld hl,DIRBUFF+7		;az kam
 2074 6EE2 B7           		or a
 2075 6EE3 ED 52        		sbc hl,de
 2076 6EE5 E5           		push hl
 2077 6EE6 C1           		pop bc				;počet bytu
 2078 6EE7 E1           		pop hl
 2079 6EE8 54           		ld d,h
 2080 6EE9 5D           		ld e,l
 2081 6EEA 13           		inc de
 2082 6EEB 3E 20        		ld a,32
 2083 6EED 77           		ld (hl),a
 2084 6EEE ED B0        		ldir
 2085 6EF0
 2086 6EF0              PRK2
 2087 6EF0 AF           		xor a
 2088 6EF1 21 35 70     		ld hl,DIRBUFF+11
 2089 6EF4 77           		ld (hl),a
 2090 6EF5 23           		inc hl
 2091 6EF6 77           		ld (hl),a
 2092 6EF7 23           		inc hl
 2093 6EF8 77           		ld (hl),a
 2094 6EF9 23           		inc hl
 2095 6EFA 77           		ld (hl),a
 2096 6EFB 21 31 70     		ld hl,DIRBUFF+7
 2097 6EFE CB FE        		set 7,(hl)
 2098 6F00
 2099 6F00 21 FF 6F     		ld hl,parrent
 2100 6F03 22 D7 6F     		ld (goto+1),hl
 2101 6F06              		;call gotodir
 2102 6F06
 2103 6F06 01 FD 7F     		ld bc,port1
 2104 6F09 3A 5C 5B             ld a,(bankm)
 2105 6F0C CB A7                res 4,a
 2106 6F0E F6 07                or 7
 2107 6F10 32 5C 5B             ld (bankm),a
 2108 6F13 ED 79                out (c),a
 2109 6F15
 2110 6F15 AF           		xor a
 2111 6F16 21 FF 6F     		ld hl,parrent
 2112 6F19 CD B1 01     		call $01b1				;skoc do nadrizeneho adresare
 2113 6F1C
 2114 6F1C ED 91 54 16  		nextreg $54,22
 2115 6F20 ED 91 55 17  		nextreg $55,23
 2116 6F24 21 00 80     		ld hl,32768
 2117 6F27 22 2F 6F     		ld (FF+1),hl
 2118 6F2A AF           		xor a
 2119 6F2B 32 0F 60     		ld (virtmem),a
 2120 6F2E
 2121 6F2E
 2122 6F2E
 2123 6F2E 11 00 80     FF		ld de,32768
 2124 6F31 06 E7                ld b,pocetpolozek
 2125 6F33 21 8F 66             ld hl,stardstar
 2126 6F36 0E 04        		ld c,%100
 2127 6F38 CD 1E 01     		call dos_catalog
 2128 6F3B 3E E7        		ld a,pocetpolozek
 2129 6F3D A8           		xor b
 2130 6F3E 20 15        		jr nz,PRK4
 2131 6F40 2A 2F 6F     		ld hl,(FF+1)
 2132 6F43 11 BB 0B     		ld de,pocetpolozek*13
 2133 6F46 19           		add hl,de
 2134 6F47 22 2F 6F     		ld (FF+1),hl
 2135 6F4A 21 0F 60     		ld hl,virtmem
 2136 6F4D 34           		inc (hl)
 2137 6F4E 7E           		ld a,(hl)
 2138 6F4F EE 04        		xor 4
 2139 6F51 28 02        		jr z,PRK4
 2140 6F53 18 D9        		jr FF
 2141 6F55
 2142 6F55              PRK4
 2143 6F55 11 2A 70     		ld de,DIRBUFF			;jmeno souboru
 2144 6F58 21 8F 66     		ld hl,stardstar
 2145 6F5B DD 2A AD 61  		ld ix,(savehl)
 2146 6F5F 01 34 BD     		ld bc,LFNNAME
 2147 6F62 CD B7 01     		call	$01b7
 2148 6F65
 2149 6F65              						;skoc zpatky do adresare
 2150 6F65 21 31 70     		ld hl,DIRBUFF+7
 2151 6F68 CB BE        		res 7,(hl)
 2152 6F6A 3E FF        		ld a,255
 2153 6F6C 32 35 70     		ld (DIRBUFF+11),a
 2154 6F6F 21 2A 70     		ld hl,DIRBUFF
 2155 6F72 AF           		xor a
 2156 6F73 CD B1 01     		call $01b1
 2157 6F76
 2158 6F76              		; ld hl,32768
 2159 6F76              		; ld (FF2+1),hl
 2160 6F76
 2161 6F76              ;FF2	ld de,32768
 2162 6F76                      ; ld b,pocetpolozek
 2163 6F76                      ; ld hl,stardstar
 2164 6F76              		; ld c,%101
 2165 6F76                      ; call dos_catalog  ;call the DOS en try
 2166 6F76              		; ld a,pocetpolozek
 2167 6F76              		; xor b
 2168 6F76              		; jr nz,PRK40
 2169 6F76              		; ld hl,(FF+1)
 2170 6F76              		; ld de,pocetpolozek*13
 2171 6F76              		; add hl,de
 2172 6F76              		; ld (FF2+1),hl
 2173 6F76              		; jr FF2
 2174 6F76              ; PRK40
 2175 6F76
 2176 6F76 01 FD 7F     		ld bc,port1
 2177 6F79 3A 5C 5B             ld a,(bankm)
 2178 6F7C CB E7                set 4,a
 2179 6F7E E6 F8                and #F8
 2180 6F80 32 5C 5B             ld (bankm),a
 2181 6F83 ED 79                out (c),a
 2182 6F85              PRK5
 2183 6F85 21 34 BD     		ld hl,LFNNAME
 2184 6F88 01 80 00     		ld bc,128
 2185 6F8B 3E FF        		ld a,#ff
 2186 6F8D ED B1        		cpir
 2187 6F8F 2B           		dec hl
 2188 6F90 36 00        		ld (hl),0
 2189 6F92 AF           		xor a
 2190 6F93 32 43 BD     		ld (LFNNAME+15),a
 2191 6F96 11 4F 50     		ld de,20544+15
 2192 6F99 21 02 70     		ld hl,lfndir
 2193 6F9C CD 26 7B     		call print
 2194 6F9F 3E 20        		ld a,32
 2195 6FA1 32 33 BD     		ld (LFNNAME-1),a
 2196 6FA4 11 52 50     		ld de,20544+15+3
 2197 6FA7 21 33 BD     		ld hl,LFNNAME-1
 2198 6FAA              		;call print
 2199 6FAA
 2200 6FAA 21 33 BD     		ld hl,LFNNAME-1
 2201 6FAD 11 41 6E     		ld de,NAZEVADRESARE
 2202 6FB0 01 14 00     		ld bc,20
 2203 6FB3 ED B0        		ldir
 2204 6FB5
 2205 6FB5 21 2A 70     		ld hl,DIRBUFF
 2206 6FB8 22 D7 6F     		ld (goto+1),hl
 2207 6FBB 3E FF        		ld a,255
 2208 6FBD 32 35 70     		ld (DIRBUFF+11),a
 2209 6FC0 21 31 70     		ld hl,DIRBUFF+7
 2210 6FC3 CB BE        		res 7,(hl)
 2211 6FC5              ;		call gotodir
 2212 6FC5
 2213 6FC5 C9           		ret
 2214 6FC6              GOTODIR
 2215 6FC6              gotodir
 2216 6FC6 01 FD 7F     		ld bc,port1
 2217 6FC9 3A 5C 5B             ld a,(bankm)
 2218 6FCC CB A7                res 4,a
 2219 6FCE F6 07                or 7
 2220 6FD0 32 5C 5B             ld (bankm),a
 2221 6FD3 ED 79                out (c),a
 2222 6FD5
 2223 6FD5 AF           		xor a
 2224 6FD6 21 FF 6F     goto	ld hl,parrent
 2225 6FD9 CD B1 01     		call $01b1
 2226 6FDC
 2227 6FDC 38 04        		jr c,gok
 2228 6FDE 3E 02        		ld a,2
 2229 6FE0 D3 FE        		out (254),a
 2230 6FE2 01 FD 7F     gok		ld bc,port1
 2231 6FE5 3A 5C 5B             ld a,(bankm)
 2232 6FE8 CB E7                set 4,a
 2233 6FEA E6 F8                and #F8
 2234 6FEC 32 5C 5B             ld (bankm),a
 2235 6FEF ED 79                out (c),a
 2236 6FF1 C9           		ret
 2237 6FF2
 2238 6FF2 41 7E 31 20  testpolozky defb "A~1    ",#a0,"POP",0,0
 2238 6FF6 20 20 20 A0
 2238 6FFA 50 4F 50 00
 2238 6FFE 00
 2239 6FFF
 2240 6FFF 2E 2E FF     parrent 	defb 	"..",#ff
 2241 7002
 2242 7002 44 69 72 3A  lfndir		defb "Dir:", 0
 2242 7006 00
 2243 7007              root
 2244 7007 3E 20        		ld a,32
 2245 7009 32 34 BD     		ld (LFNNAME),a
 2246 700C 3E 2F        		ld a,"/"
 2247 700E 32 35 BD     		ld (LFNNAME+1),a
 2248 7011 AF           		xor a
 2249 7012 32 36 BD     		ld (LFNNAME+2),a
 2250 7015 11 4F 50     		ld de,20544+15
 2251 7018 21 02 70     		ld hl,lfndir
 2252 701B CD 26 7B     		call print
 2253 701E 21 34 BD     		ld hl,LFNNAME
 2254 7021 11 41 6E     		ld de,NAZEVADRESARE
 2255 7024 01 14 00     		ld bc,20
 2256 7027 ED B0        		ldir
 2257 7029 C9           		ret
 2258 702A 00 00 00...  DIRBUFF	ds 15
 2259 7039              CHANGEDIR
 2260 7039 ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 2261 703D
 2262 703D
 2263 703D E5           		push hl
 2264 703E 21 42 48     		ld hl, 18496+2
 2265 7041 01 1C 04     		ld   bc,4*256+28
 2266 7044 3E 05        		ld   a,%00000101
 2267 7046 CD 48 77     		call RAMECEK
 2268 7049
 2269 7049 11 64 48     		 ld de,18528+4
 2270 704C 21 FE 6C     		 ld hl,txtStart
 2271 704F CD 26 7B     		 call print
 2272 7052
 2273 7052 21 00 00     		ld hl,0
 2274 7055 22 4C 7A     		ld (ALLFILES),hl
 2275 7058 22 71 65     		ld (dirNum),hl
 2276 705B 22 33 76     		ld (apos_all),hl
 2277 705E AF           		xor a
 2278 705F 32 89 75     		ld (POS_F+1),a
 2279 7062 32 0F 60     		ld (virtmem),a
 2280 7065 21 00 80     		ld hl,catbuff
 2281 7068 22 A6 61     		ld (Count11+1),hl
 2282 706B 21 00 00     		ld hl,0
 2283 706E 22 4C 7A     		ld (ALLFILES),hl
 2284 7071
 2285 7071 E1           		pop hl
 2286 7072 CD 82 65     		call BUFF83
 2287 7075 DD 21 26 6E  		ld ix,DIRNAME
 2288 7079 06 0D        		ld b,13
 2289 707B 7E           chngdir1 ld a,(hl)
 2290 707C CB BF        		res 7,a
 2291 707E B7           		or a
 2292 707F 20 02        		jr nz,chng
 2293 7081 3E 20        		ld a,32
 2294 7083 DD 77 00     chng	ld (ix+0),a
 2295 7086 23           		inc hl
 2296 7087 DD 23        		inc ix
 2297 7089 10 F0        		djnz chngdir1
 2298 708B              STOP
 2299 708B
 2300 708B 21 31 6E     		ld hl,DIRNAME+11
 2301 708E 7E           chng2	ld a,(hl)
 2302 708F FE 20        		cp 32
 2303 7091 20 03        		jr nz,zap
 2304 7093 2B           		dec hl
 2305 7094 18 F8        		jr chng2
 2306 7096 3E FF        zap		ld a,255
 2307 7098 23           		inc hl
 2308 7099 77           		ld (hl),a
 2309 709A 01 FD 7F     		ld bc,port1
 2310 709D 3A 5C 5B             ld a,(bankm)      ;sys tem vari able that holds cur rent
 2311 70A0 CB A7                res 4,a           ;move right to left in hor i zon tal
 2312 70A2 F6 07                or 7              ;switch in RAM page 7
 2313 70A4 32 5C 5B             ld (bankm),a      ;must keep sys tem vari able up to
 2314 70A7 ED 79                out (c),a         ;make the switch
 2315 70A9
 2316 70A9 AF           		xor a 			;change path
 2317 70AA 21 26 6E     		ld hl,DIRNAME
 2318 70AD              AAAA
 2319 70AD CD B1 01     		call $01b1
 2320 70B0
 2321 70B0 38 04        		jr c,ok
 2322 70B2 3E 02        ERROR	ld a,2
 2323 70B4 D3 FE        		out (254),a
 2324 70B6
 2325 70B6 01 FD 7F     ok			ld bc,port1       ;I/O ad dress of hor i zon tal ROM/RAM
 2326 70B9 3A 5C 5B                 ld a,(bankm)      ;get cur rent switch state
 2327 70BC CB E7                    set 4,a           ;move left to right (ROM 2 to ROM
 2328 70BE E6 F8                    and #F8           ;also want RAM page 0
 2329 70C0 32 5C 5B                 ld (bankm),a      ;up date the sys tem vari able (very
 2330 70C3 ED 79                    out (c),a         ;make the switch
 2331 70C5 CD BF 6A     			call reload_dir
 2332 70C8              ;			call GETDIR
 2333 70C8 ED 91 07 00  			nextreg #07,0
 2334 70CC C9           			ret
 2335 70CD 43 6F 6E 66  txtsetup	defb "Configuration",0
 2335 70D1 69 67 75 72
 2335 70D5 61 74 69 6F
 2335 70D9 6E 00
 2336 70DB 53 74 65 72  txtstereo	defb "Stereo:      ACB  /  ABC",0
 2336 70DF 65 6F 3A 20
 2336 70E3 20 20 20 20
 2336 70E7 20 41 43 42
 2336 70EB 20 20 2F 20
 2336 70EF 20 41 42 43
 2336 70F3 00
 2337 70F4 53 6F 75 6E  txtchip		defb "Sound chip:  AY   /   YM",0
 2337 70F8 64 20 63 68
 2337 70FC 69 70 3A 20
 2337 7100 20 41 59 20
 2337 7104 20 20 2F 20
 2337 7108 20 20 59 4D
 2337 710C 00
 2338 710D
 2339 710D 43 6F 6E 74  txthelp0	defb "Controls:",0
 2339 7111 72 6F 6C 73
 2339 7115 3A 00
 2340 7117 42 72 65 61  txthelp1	defb "Break: stop play | Space: next song",0
 2340 711B 6B 3A 20 73
 2340 711F 74 6F 70 20
 2340 7123 70 6C 61 79
 2340 7127 20 7C 20 53
 2340 712B 70 61 63 65
 2340 712F 3A 20 6E 65
 2340 7133 78 74 20 73
 2340 7137 6F 6E 67 00
 2341 713B 20 20 41 3A  txthelp2	defb "  A: AY | Y: YM | C: ACB | B: ABC  ",0
 2341 713F 20 41 59 20
 2341 7143 7C 20 59 3A
 2341 7147 20 59 4D 20
 2341 714B 7C 20 43 3A
 2341 714F 20 41 43 42
 2341 7153 20 7C 20 42
 2341 7157 3A 20 41 42
 2341 715B 43 20 20 00
 2342 715F
 2343 715F              vyrazni		equ 01000111b
 2344 715F
 2345 715F              showsetup
 2346 715F              			NEXTREG2A 06
 2346 715F 3E 06       >        ld     a,06
 2346 7161 CD 12 60    >        call   ReadNextReg
 2347 7164 CB 47        			bit 0,a 		;AY
 2348 7166 20 16        			jr nz,sAY
 2349 7168
 2350 7168
 2351 7168 3E 47        			ld a,vyrazni
 2352 716A 21 95 58     			ld hl,22528+32*4 + 21
 2353 716D 77           			ld (hl),a
 2354 716E 23           			inc hl
 2355 716F 77           			ld (hl),a
 2356 7170 23           			inc hl
 2357 7171 77           			ld (hl),a
 2358 7172
 2359 7172 3E 01        			ld   a,%00000001
 2360 7174 21 8F 58     			ld hl,22528+32*4 + 15
 2361 7177 77           			ld (hl),a
 2362 7178 23           			inc hl
 2363 7179 77           			ld (hl),a
 2364 717A 23           			inc hl
 2365 717B 77           			ld (hl),a
 2366 717C
 2367 717C 18 14        			jr stereo
 2368 717E              sAY
 2369 717E 3E 01        			ld a,%00000001
 2370 7180 21 95 58     			ld hl,22528+32*4 + 21
 2371 7183 77           			ld (hl),a
 2372 7184 23           			inc hl
 2373 7185 77           			ld (hl),a
 2374 7186 23           			inc hl
 2375 7187 77           			ld (hl),a
 2376 7188
 2377 7188 3E 47        			ld   a,vyrazni
 2378 718A 21 8F 58     			ld hl,22528+32*4 + 15
 2379 718D 77           			ld (hl),a
 2380 718E 23           			inc hl
 2381 718F 77           			ld (hl),a
 2382 7190 23           			inc hl
 2383 7191 77           			ld (hl),a
 2384 7192              stereo
 2385 7192
 2386 7192              			NEXTREG2A 08
 2386 7192 3E 08       >        ld     a,08
 2386 7194 CD 12 60    >        call   ReadNextReg
 2387 7197 CB 6F        			bit 5,a
 2388 7199 20 15        			jr nz,sACB
 2389 719B 3E 47        			ld a,vyrazni
 2390 719D 21 75 58     			ld hl,22528+32*3 + 21
 2391 71A0 77           			ld (hl),a
 2392 71A1 23           			inc hl
 2393 71A2 77           			ld (hl),a
 2394 71A3 23           			inc hl
 2395 71A4 77           			ld (hl),a
 2396 71A5
 2397 71A5 3E 01        			ld   a,%00000001
 2398 71A7 21 6F 58     			ld hl,22528+32*3 + 15
 2399 71AA 77           			ld (hl),a
 2400 71AB 23           			inc hl
 2401 71AC 77           			ld (hl),a
 2402 71AD 23           			inc hl
 2403 71AE 77           			ld (hl),a
 2404 71AF C9           			ret
 2405 71B0
 2406 71B0              sACB
 2407 71B0 3E 01        			ld a,%00000001
 2408 71B2 21 75 58     			ld hl,22528+32*3 + 21
 2409 71B5 77           			ld (hl),a
 2410 71B6 23           			inc hl
 2411 71B7 77           			ld (hl),a
 2412 71B8 23           			inc hl
 2413 71B9 77           			ld (hl),a
 2414 71BA
 2415 71BA 3E 47        			ld   a,vyrazni
 2416 71BC 21 6F 58     			ld hl,22528+32*3 + 15
 2417 71BF 77           			ld (hl),a
 2418 71C0 23           			inc hl
 2419 71C1 77           			ld (hl),a
 2420 71C2 23           			inc hl
 2421 71C3 77           			ld (hl),a
 2422 71C4
 2423 71C4 C9           			ret
 2424 71C5
 2425 71C5              ;Skok na další skladbu
 2426 71C5              nextsong
 2427 71C5 CD E9 75     		 call DOWN
 2428 71C8
 2429 71C8              ;Stisk klávesy ENTER.
 2430 71C8              FIRE
 2431 71C8 ED 91 07 03  		 nextreg #07,3
 2432 71CC CD 99 74     		 call savescr
 2433 71CF 3A 89 75     		 ld a,(POS_F+1)
 2434 71D2 5F           		 ld e,a
 2435 71D3 16 00        		 ld d,0
 2436 71D5 2A 33 76     		ld hl,(apos_all)
 2437 71D8 19           		add hl,de
 2438 71D9 7D           		ld a,l
 2439 71DA B4           		or h
 2440 71DB 21 0D 80      	    ld hl,catbuff+#D
 2441 71DE 28 11        		jr z,F1
 2442 71E0
 2443 71E0 2A 33 76     		ld hl,(apos_all)
 2444 71E3 44           		ld b,h
 2445 71E4 4D           		ld c,l
 2446 71E5
 2447 71E5 11 0D 00     		ld de,13
 2448 71E8 21 0D 80       	    ld hl,catbuff+#D
 2449 71EB 19           F0 		add hl,de
 2450 71EC 0B           		dec bc
 2451 71ED 79           		ld a,c
 2452 71EE B0           		or b
 2453 71EF 20 FA        		jr nz,F0
 2454 71F1              F1
 2455 71F1 E5           		push hl
 2456 71F2 DD E1        		pop ix
 2457 71F4 CD 82 65     		call BUFF83
 2458 71F7 DD CB 07 7E  		bit 7,(ix+7)
 2459 71FB
 2460 71FB C2 39 70     		jp nz,CHANGEDIR
 2461 71FE E5           		push hl
 2462 71FF 21 40 48             ld   hl,18496
 2463 7202 01 20 07             ld   bc,7*256+32
 2464 7205 3E 07                ld   a,%00000111
 2465 7207 CD 48 77             call RAMECEK
 2466 720A 21 00 50     		ld   hl,20480
 2467 720D 01 20 04             ld   bc,4*256+32
 2468 7210 3E 05                ld   a,%00000101
 2469 7212 CD 48 77             call RAMECEK
 2470 7215
 2471 7215 21 25 40     		ld   hl,16416+5
 2472 7218 01 16 05             ld   bc,5*256+22
 2473 721B 3E 07                ld   a,%00000111
 2474 721D CD 48 77             call RAMECEK
 2475 7220
 2476 7220 21 C1 40     		ld   hl,16576+1
 2477 7223 01 1E 04             ld   bc,4*256+30
 2478 7226 3E 05                ld   a,%00000101
 2479 7228 CD 48 77             call RAMECEK
 2480 722B
 2481 722B              		; ld de,16576+3
 2482 722B              		; ld hl,txthelp0
 2483 722B              		; call print
 2484 722B 11 E3 40     		ld de,16608+3
 2485 722E 21 17 71     		ld hl,txthelp1
 2486 7231 CD 26 7B     		call print
 2487 7234 11 03 48     		ld de,18432+3
 2488 7237 21 3B 71     		ld hl,txthelp2
 2489 723A CD 26 7B     		call print
 2490 723D
 2491 723D
 2492 723D
 2493 723D 21 E2 58     		ld hl,22528 + 32*7 + 2
 2494 7240 3E 07        		ld a,7
 2495 7242 77           		ld (hl),a
 2496 7243 23           		inc hl
 2497 7244 77           		ld (hl),a
 2498 7245 23           		inc hl
 2499 7246 77           		ld (hl),a
 2500 7247 23           		inc hl
 2501 7248 77           		ld (hl),a
 2502 7249 23           		inc hl
 2503 724A 77           		ld (hl),a
 2504 724B 23           		inc hl
 2505 724C 77           		ld (hl),a
 2506 724D 21 F1 58     		ld hl,22528 + 32*7 + 17
 2507 7250 3E 07        		ld a,7
 2508 7252 77           		ld (hl),a
 2509 7253 23           		inc hl
 2510 7254 77           		ld (hl),a
 2511 7255 23           		inc hl
 2512 7256 77           		ld (hl),a
 2513 7257 23           		inc hl
 2514 7258 77           		ld (hl),a
 2515 7259 23           		inc hl
 2516 725A 77           		ld (hl),a
 2517 725B
 2518 725B 21 04 59     		ld hl,22528 + 32*8 + 4
 2519 725E 3E 07        		ld a,7
 2520 7260 77           		ld (hl),a
 2521 7261 23           		inc hl
 2522 7262 77           		ld (hl),a
 2523 7263
 2524 7263 21 0A 59     		ld hl,22528 + 32*8 + 10
 2525 7266 3E 07        		ld a,7
 2526 7268 77           		ld (hl),a
 2527 7269 23           		inc hl
 2528 726A 77           		ld (hl),a
 2529 726B
 2530 726B 21 10 59     		ld hl,22528 + 32*8 + 16
 2531 726E 3E 07        		ld a,7
 2532 7270 77           		ld (hl),a
 2533 7271 23           		inc hl
 2534 7272 77           		ld (hl),a
 2535 7273
 2536 7273 21 16 59     		ld hl,22528 + 32*8 + 22
 2537 7276 3E 07        		ld a,7
 2538 7278 77           		ld (hl),a
 2539 7279 23           		inc hl
 2540 727A 77           		ld (hl),a
 2541 727B
 2542 727B
 2543 727B 11 46 40     		ld de,16448+6
 2544 727E 21 CD 70     		ld hl,txtsetup
 2545 7281 CD 26 7B     		call print
 2546 7284 21 46 58     		ld hl,22528+32*2 + 6
 2547 7287 3E 05        		ld a,101b
 2548 7289              		;ld a,255
 2549 7289 77           		ld (hl),a
 2550 728A 23           		inc hl
 2551 728B 77           		ld (hl),a
 2552 728C 23           		inc hl
 2553 728D 77           		ld (hl),a
 2554 728E 23           		inc hl
 2555 728F 77           		ld (hl),a
 2556 7290 23           		inc hl
 2557 7291 77           		ld (hl),a
 2558 7292 23           		inc hl
 2559 7293 77           		ld (hl),a
 2560 7294 23           		inc hl
 2561 7295 77           		ld (hl),a
 2562 7296 23           		inc hl
 2563 7297 77           		ld (hl),a
 2564 7298 23           		inc hl
 2565 7299 77           		ld (hl),a
 2566 729A 23           		inc hl
 2567 729B 77           		ld (hl),a
 2568 729C 11 66 40     		ld de,16480+6
 2569 729F 21 DB 70     		ld hl,txtstereo
 2570 72A2 CD 26 7B     		call print
 2571 72A5
 2572 72A5 11 86 40     		ld de,16512+6
 2573 72A8 21 F4 70     		ld hl,txtchip
 2574 72AB CD 26 7B     		call print
 2575 72AE
 2576 72AE CD 5F 71     		call showsetup
 2577 72B1
 2578 72B1
 2579 72B1 21 41 5A     		ld hl,22528+32*18+1
 2580 72B4 54           		ld d,h
 2581 72B5 5D           		ld e,l
 2582 72B6 13           		inc de
 2583 72B7 3E 07        		ld a,7
 2584 72B9 77           		ld (hl),a
 2585 72BA 01 1C 00     		ld bc, 28
 2586 72BD ED B0        		ldir
 2587 72BF
 2588 72BF
 2589 72BF                      ; ld   hl,18592+2
 2590 72BF              		; ld (lfnat+1),hl
 2591 72BF              		; ld hl,28 + 18592+2
 2592 72BF              		; ld (lfn_1 + 1),hl
 2593 72BF              		; ld hl,28 + 18624+21
 2594 72BF              		; ld (lfn_2 + 1),hl
 2595 72BF              		; ld hl,LFNNAME+128
 2596 72BF              		; ld (lfnend+1),hl
 2597 72BF              		; ld hl,4
 2598 72BF              		; ld (odskok+1),hl
 2599 72BF
 2600 72BF
 2601 72BF CD 12 66     		call LFNPRINT
 2602 72C2
 2603 72C2 21 C0 73     		ld hl,tmp
 2604 72C5 11 C1 73     		ld de,tmp+1
 2605 72C8 AF           		xor a
 2606 72C9 77           		ld (hl),a
 2607 72CA 01 30 00     		ld bc,48
 2608 72CD ED B0        		ldir
 2609 72CF
 2610 72CF 21 34 BD     		ld hl,LFNNAME
 2611 72D2 11 C0 73     		ld de,tmp
 2612 72D5 01 25 00     		ld bc,maxline
 2613 72D8 ED B0        		ldir
 2614 72DA
 2615 72DA 11 82 48     		ld de,18560+2
 2616 72DD 21 C0 73     		ld hl,tmp
 2617 72E0 CD 26 7B     		call print
 2618 72E3              ;**************************
 2619 72E3 21 C0 73     		ld hl,tmp
 2620 72E6 11 C1 73     		ld de,tmp+1
 2621 72E9 AF           		xor a
 2622 72EA 77           		ld (hl),a
 2623 72EB 01 30 00     		ld bc,48
 2624 72EE ED B0        		ldir
 2625 72F0
 2626 72F0 21 59 BD     		ld hl,LFNNAME+maxline
 2627 72F3 11 C0 73     		ld de,tmp
 2628 72F6 01 25 00     		ld bc,maxline
 2629 72F9 ED B0        		ldir
 2630 72FB
 2631 72FB 11 A2 48     		ld de,18592+2
 2632 72FE 21 C0 73     		ld hl,tmp
 2633 7301 CD 26 7B     		call print
 2634 7304              ;****************************
 2635 7304 21 C0 73     		ld hl,tmp
 2636 7307 11 C1 73     		ld de,tmp+1
 2637 730A AF           		xor a
 2638 730B 77           		ld (hl),a
 2639 730C 01 30 00     		ld bc,48
 2640 730F ED B0        		ldir
 2641 7311
 2642 7311 21 7E BD     		ld hl,LFNNAME+maxline+maxline
 2643 7314 11 C0 73     		ld de,tmp
 2644 7317 01 25 00     		ld bc,maxline
 2645 731A ED B0        		ldir
 2646 731C
 2647 731C 11 C2 48     		ld de,18624+2
 2648 731F 21 C0 73     		ld hl,tmp
 2649 7322 CD 26 7B     		call print
 2650 7325
 2651 7325
 2652 7325 21 81 59     		ld hl,12*32+22528+1
 2653 7328 11 82 59     		ld de,12*32+22528+2
 2654 732B 01 1D 00     		ld bc,29
 2655 732E 36 47        		ld (hl),%01000111
 2656 7330 ED B0        		ldir
 2657 7332 21 A1 59     		ld hl,13*32+22528+1
 2658 7335 11 A2 59     		ld de,13*32+22528+2
 2659 7338 01 1D 00     		ld bc,29
 2660 733B 36 47        		ld (hl),%01000111
 2661 733D ED B0        		ldir
 2662 733F
 2663 733F 21 C1 59     		ld hl,14*32+22528+1
 2664 7342 11 C2 59     		ld de,14*32+22528+2
 2665 7345 01 1D 00     		ld bc,29
 2666 7348 36 47        		ld (hl),%01000111
 2667 734A ED B0        		ldir
 2668 734C
 2669 734C
 2670 734C
 2671 734C 11 C2 50     		ld de,20672+2
 2672 734F ED 53 0C 66  		ld (lfnat+1),de
 2673 7353 21 DE 50     		ld hl,28 + 20672+2
 2674 7356 22 00 66     		ld (lfn_1 + 1),hl
 2675 7359 21 E3 50     		ld hl,33 + 20672+2
 2676 735C 22 06 66     		ld (lfn_2 + 1),hl
 2677 735F 21 59 BD     		ld hl,LFNNAME+37
 2678 7362 22 FD 65     		ld (lfnend+1),hl
 2679 7365 D1           		pop de				; v DE je nazev souboru
 2680 7366 CD F1 79             call NOWRMOD
 2681 7369
 2682 7369 11 6B 48     		ld   de,18560+8-32+3
 2683 736C 21 65 7F          	ld hl,text
 2684 736F
 2685 736F CD 26 7B             call print
 2686 7372
 2687 7372 CD 1D 74     		call LOADFile
 2688 7375
 2689 7375 ED 91 57 01  		nextreg $57,1
 2690 7379
 2691 7379 21 09 60     		ld hl,filename+9
 2692 737C 11 F1 73     		ld de,PT2
 2693 737F CD 8F 61     		call compare
 2694 7382 CA 04 99     		jp z,playmusic
 2695 7385
 2696 7385 21 09 60     		ld hl,filename+9
 2697 7388 11 F4 73     		ld de,PT3
 2698 738B CD 8F 61     		call compare
 2699 738E CA 04 99     		jp z,playmusic
 2700 7391
 2701 7391 21 09 60     		ld hl,filename+9
 2702 7394 11 F7 73     		ld de,SQT
 2703 7397 CD 8F 61     		call compare
 2704 739A CA 39 92     		jp z,SQTPLAY
 2705 739D
 2706 739D 21 09 60     		ld hl,filename+9
 2707 73A0 11 FA 73     		ld de,STC
 2708 73A3 CD 8F 61     		call compare
 2709 73A6 CA B1 90     		jp z,STCPLAY
 2710 73A9
 2711 73A9 21 09 60     		ld hl,filename+9
 2712 73AC 11 FD 73     		ld de,STP
 2713 73AF CD 8F 61     		call compare
 2714 73B2 CA 62 91     		jp z,STPPLAY
 2715 73B5
 2716 73B5
 2717 73B5
 2718 73B5
 2719 73B5 3E 20        		ld a,32
 2720 73B7 21 00 74     		ld hl,endsong
 2721 73BA 77           		ld (hl),a
 2722 73BB              ;		jp playmusic
 2723 73BB              navrat
 2724 73BB 76           		halt
 2725 73BC CD AD 74     		call loadscr
 2726 73BF C9                   ret
 2727 73C0 00 00 00...  tmp     ds 49
 2728 73F1 50 54 32     PT2 	defb "PT2"
 2729 73F4 50 54 33     PT3		defb "PT3"
 2730 73F7 53 51 54     SQT		defb "SQT"
 2731 73FA 53 54 43     STC		defb "STC"
 2732 73FD 53 54 50     STP		defb "STP"
 2733 7400 00           endsong	defb 0
 2734 7401 50 6C 61 73  Loading defb "Plase wait, loading file...",0
 2734 7405 65 20 77 61
 2734 7409 69 74 2C 20
 2734 740D 6C 6F 61 64
 2734 7411 69 6E 67 20
 2734 7415 66 69 6C 65
 2734 7419 2E 2E 2E 00
 2735 741D              ; Nahrání souboru pomocí EsxDos služeb. Rutina nemá žádný vstup,
 2736 741D              ; vše si zjišťuje z proměnných (na adrese filename je již připravený název souboru)
 2737 741D              LOADFile
 2738 741D ED 91 07 03  		nextreg #07,3             ;28MHz - jen kvůli načítání (rychlost)
 2739 7421 21 A0 50     		ld hl, 20640
 2740 7424 01 20 03     		ld   bc,3*256+32
 2741 7427 3E 02                ld   a,%00000010
 2742 7429 CD 48 77     		call RAMECEK
 2743 742C
 2744 742C 11 C2 50     		ld de,20672+2
 2745 742F 21 01 74     		ld hl,Loading
 2746 7432 CD 26 7B     		call print
 2747 7435 06 01        		ld      b,FA_READ
 2748 7437 3E 2A                ld      a,'*'
 2749 7439 21 00 60             ld      hl,filename
 2750 743C                      ESXDOS  F_OPEN
 2750 743C E5          >  push hl
 2750 743D DD E1       >  pop ix
 2750 743F CF          >  rst $08
 2750 7440 9A          >  db F_OPEN
 2751 7441 32 7B 74     		ld (fread+1),a
 2752 7444
 2753 7444 21 26 BD     		ld hl,modstart
 2754 7447 11 27 BD     		ld de,modstart+1
 2755 744A 01 20 56     		ld bc,22048
 2756 744D 3E FF        		ld a,255
 2757 744F 77           		ld (hl),a
 2758 7450 ED B0        		ldir
 2759 7452
 2760 7452
 2761 7452
 2762 7452 21 26 BD             ld      hl,modstart
 2763 7455 01 20 56             ld      bc,22048
 2764 7458 CD 7A 74             call    fread
 2765 745B CD 71 74     		call 	fclose
 2766 745E
 2767 745E
 2768 745E 21 8E FF     		ld hl,modstart + 17000
 2769 7461
 2770 7461              hledej_konec_souboru
 2771 7461 7E           		ld a,(hl)
 2772 7462 FE FF        		cp 255
 2773 7464 20 03        		jr nz,nasel
 2774 7466 2B           		dec hl
 2775 7467 18 F8        		jr hledej_konec_souboru
 2776 7469
 2777 7469 22 B5 60     nasel	ld (delka_souboru),hl
 2778 746C
 2779 746C ED 91 07 00  		nextreg #07,0             ;28MHz - jen kvůli načítání (rychlost)
 2780 7470 C9           		ret
 2781 7471              fclose
 2782 7471 3A 7B 74             ld      a,(fread+1)
 2783 7474                      ESXDOS  F_CLOSE
 2783 7474 E5          >  push hl
 2783 7475 DD E1       >  pop ix
 2783 7477 CF          >  rst $08
 2783 7478 9B          >  db F_CLOSE
 2784 7479 C9                   ret
 2785 747A              fread:
 2786 747A 3E 01                ld a,1
 2787 747C                      ESXDOS  F_READ
 2787 747C E5          >  push hl
 2787 747D DD E1       >  pop ix
 2787 747F CF          >  rst $08
 2787 7480 9D          >  db F_READ
 2788 7481 D0                   ret  nc
 2789 7482
 2790 7482
 2791 7482              fileError:
 2792 7482 F5                   push    af
 2793 7483 E6 07                and     7
 2794 7485 D3 FE                out     (254),a
 2795 7487 F1                   pop     af
 2796 7488 06 01                ld      b,1
 2797 748A 11 3A C6             ld      de,esxError
 2798 748D                      ESXDOS  M_GETERR
 2798 748D E5          >  push hl
 2798 748E DD E1       >  pop ix
 2798 7490 CF          >  rst $08
 2798 7491 93          >  db M_GETERR
 2799 7492 21 3A C6             ld      hl,esxError
 2800 7495 C3 C1 74             jp      customErrorToBasic
 2801 7498
 2802 7498
 2803 7498              switchLayer2Off:
 2804 7498 C9                   ret
 2805 7499
 2806 7499
 2807 7499              ;Uloží obrazovku do banky 19 ZX Next. Ukládají se spodní dvě třetiny obrazovky,
 2808 7499              ;a celé atributy. Banka 19 se stránkuje od adresy $e000
 2809 7499              savescr
 2810 7499 ED 91 57 13  		nextreg $57,19				;Stránka na uložení VideoRam
 2811 749D 21 00 40     		ld hl,16384
 2812 74A0 11 00 E0     		ld de,bufscr
 2813 74A3 01 00 1B     		ld bc,6912
 2814 74A6 ED B0        		ldir
 2815 74A8 ED 91 57 01  		nextreg $57,1				;Nastránkuj zpátky
 2816 74AC C9           		ret
 2817 74AD
 2818 74AD              ;Obnovení spodních dvou třetin obrazovky z 19 stárnky ZX Next.
 2819 74AD              loadscr
 2820 74AD ED 91 57 13  		nextreg $57,19
 2821 74B1 21 00 E0     		ld hl,bufscr
 2822 74B4 11 00 40     		ld de,16384
 2823 74B7 01 00 1B     		ld bc,6912
 2824 74BA ED B0        		ldir
 2825 74BC ED 91 57 01  		nextreg $57,1
 2826 74C0 C9           		ret
 2827 74C1
 2828 74C1              customErrorToBasic: ; HL = message with |80 last char
 2829 74C1 3E 01        		ld a,1
 2830 74C3 D3 FE        		out (254),a
 2831 74C5 C9           		ret
 2832 74C6 00           keysound db 0				;key sound 0= yes,1= no, klavesnicove echo
 2833 74C7              ;KeyScan od Busyho z MRSu
 2834 74C7 2E 2F        KEYSCAN  ld   l,47			;testovani klavesnice
 2835 74C9 11 FF FF              ld   de,65535
 2836 74CC 01 FE FE              ld   bc,65278
 2837 74CF ED 78        KEYLINE  in   a,(c)
 2838 74D1 2F                    cpl
 2839 74D2 E6 1F                 and  31
 2840 74D4 28 0E                 jr   z,KEYDONE
 2841 74D6 67                    ld   h,a
 2842 74D7 7D                    ld   a,l
 2843 74D8 14           KEY3KEYS inc  d
 2844 74D9 C0                    ret  nz
 2845 74DA D6 08        KEYBITS  sub  8
 2846 74DC CB 3C                 srl  h
 2847 74DE 30 FA                 jr   nc,KEYBITS
 2848 74E0 53                    ld   d,e
 2849 74E1 5F                    ld   e,a
 2850 74E2 20 F4                 jr   nz,KEY3KEYS
 2851 74E4 2D           KEYDONE  dec  l
 2852 74E5 CB 00                 rlc  b
 2853 74E7 38 E6                 jr   c,KEYLINE
 2854 74E9 7A                    ld   a,d
 2855 74EA 3C                    inc  a
 2856 74EB C8                    ret  z
 2857 74EC FE 28                 cp   40
 2858 74EE C8                    ret  z
 2859 74EF FE 19                 cp   25
 2860 74F1 C8                    ret  z
 2861 74F2 7B                    ld   a,e
 2862 74F3 5A                    ld   e,d
 2863 74F4 57                    ld   d,a
 2864 74F5 FE 18                 cp   24
 2865 74F7 C9                    ret
 2866 74F8
 2867 74F8 2A 5E 5B 26  SYMTAB   db "*^[&%>}/"
 2867 74FC 25 3E 7D 2F
 2868 7500 2C 2D 5D 27           db ",-]'$<{?"
 2868 7504 24 3C 7B 3F
 2869 7508 2E 2B 7F 28           db ".+($"
 2869 750C 24
 2870 750D C8                    db 200
 2871 750E 2F 20                 db '/',' '
 2872 7510 00                    db 0
 2873 7511 3D 3B 29 40           db "=;)@"
 2874 7515 C9                    db 201
 2875 7516 7C 3A                 db "|:"
 2876 7518 20 0D 22              db 32,13,34
 2877 751B 5F 21                 db "_!"
 2878 751D C7                    db 199
 2879 751E 7E 00                 db "~",0
 2880 7520
 2881 7520 42 48 59     CAPSTAB  db "BHY"
 2882 7523 0A 08                 db 10,8
 2883 7525 54 47 56              db "TGV"
 2884 7528 4E 4A 55              db "NJU"
 2885 752B 0B 05                 db 11,5
 2886 752D 52 46 43              db "RFC"
 2887 7530 4D 4B 49              db "MKI"
 2888 7533 09 04                 db 9,4
 2889 7535 45 44 58              db "EDX"
 2890 7538 02                    db 2
 2891 7539 4C 4F                 db "LO"
 2892 753B 0F 06                 db 15,6
 2893 753D 57 53 5A              db "WSZ"
 2894 7540 01 0D 50              db 1,13,"P"
 2895 7543 0C 07                 db 12,7
 2896 7545 51 41                 db "QA"
 2897 7547
 2898 7547 62 68 79 36  NORMTAB  db "bhy65tgv"
 2898 754B 35 74 67 76
 2899 754F 6E 6A 75 37           db "nju74rfc"
 2899 7553 34 72 66 63
 2900 7557 6D 6B 69 38           db "mki83edx"
 2900 755B 33 65 64 78
 2901 755F 00                    db 0
 2902 7560 6C 6F 39 32           db "lo92wsz"
 2902 7564 77 73 7A
 2903 7567 20 0D                 db 32,13
 2904 7569 70 30 31 71           db "p01qa"
 2904 756D 61
 2905 756E 00                    db 0
 2906 756F
 2907 756F 3A C6 74     beepk		ld a,(keysound)		;Busyho nahradni rutina,kratsi
 2908 7572 B7           		or a
 2909 7573 C0           		ret nz
 2910 7574 3A 87 75     		ld a,(BORDER)
 2911 7577 5F           		ld e,a
 2912 7578 06 10        		ld b,$10
 2913 757A 80           		add a,b
 2914 757B              ;		ld a,$10+border
 2915 757B D3 FE        		out ($fe),a
 2916 757D 06 1C        		ld b,$1c
 2917 757F 10 FE        beepk1		djnz beepk1
 2918 7581 3E 08        		ld a,$08
 2919 7583 83           		add a,e
 2920 7584              ;		ld a,$08+border
 2921 7584 D3 FE        		out ($fe),a
 2922 7586 C9           		ret
 2923 7587 00           BORDER   db 0				;okraj
 2924 7588
 2925 7588              ;Pohyb nahoru - na pozici kurzoru se používa 16bitové číslo,
 2926 7588              ;takže maximální počet souboru je omezen, ale prakticky se k
 2927 7588              ;němu ani nepřiblížíme.
 2928 7588              ;Při scrolování se vypisuje jen spodní řádek, jinak se volá
 2929 7588              ;rutinka ROLLDOWN, která provede scroll o 8 pixelů dolů. Je to rychlejší,
 2930 7588              ;než vypisovat všechny soubory znova.
 2931 7588              UP
 2932 7588 3E 00        POS_F    ld a,0
 2933 758A B7           		 or a
 2934 758B CA C0 75     		 jp z,UP1
 2935 758E 2A 33 76     		 ld hl,(apos_all)
 2936 7591 7C           		 ld a,h
 2937 7592 B5                    or   l
 2938 7593 CA C0 75              jp   z,UP1
 2939 7596 0E 0F                 ld   c,%00001111
 2940 7598 3A 89 75     		 ld a,(POS_F+1)
 2941 759B CD 4F 7A              call KURZOR
 2942 759E 2A 33 76     		 ld hl,(apos_all)
 2943 75A1 2B                    dec  hl
 2944 75A2 22 33 76              ld   (apos_all),hl
 2945 75A5
 2946 75A5 3D           		 dec a
 2947 75A6 32 89 75     		 ld (POS_F+1),a
 2948 75A9 0E 17                 ld   c,%00010111
 2949 75AB CD 4F 7A              call KURZOR
 2950 75AE CD 12 66     		 call LFNPRINT
 2951 75B1 21 59 BD      		ld hl,LFNNAME + maxline
 2952 75B4 36 00        		ld (hl),0
 2953 75B6 21 34 BD     		ld hl,LFNNAME
 2954 75B9 11 C2 50     		ld de,20672+2
 2955 75BC CD 26 7B     		call print
 2956 75BF
 2957 75BF C9                    ret
 2958 75C0
 2959 75C0              UP1
 2960 75C0 3E 00        POS_ALL  ld   a,0
 2961 75C2                       ;or   a
 2962 75C2                       ;ret  z
 2963 75C2                       ;dec  a
 2964 75C2                       ;ld   (POS_ALL+1),a
 2965 75C2 2A 33 76     		 ld hl,(apos_all)
 2966 75C5 7D           		 ld a,l
 2967 75C6 B4           		 or h
 2968 75C7 C8           		 ret z
 2969 75C8 2B           		 dec hl
 2970 75C9 22 33 76     		 ld (apos_all),hl
 2971 75CC F5                    push af
 2972 75CD CD DE 7A              call ROLLDOWN
 2973 75D0 F1                    pop  af
 2974 75D1 21 41 40              ld   hl,16448+1
 2975 75D4 CD 67 7A              call PRN_F
 2976 75D7 CD 12 66     		 call LFNPRINT
 2977 75DA 21 59 BD     		ld hl,LFNNAME + maxline
 2978 75DD 36 00        		ld (hl),0
 2979 75DF 21 34 BD     		ld hl,LFNNAME
 2980 75E2 11 C2 50     		ld de,20672+2
 2981 75E5 CD 26 7B     		call print
 2982 75E8
 2983 75E8 C9                    ret
 2984 75E9              DOWN
 2985 75E9 2A 4C 7A     		ld hl,(ALLFILES)
 2986 75EC 2B           		dec hl
 2987 75ED
 2988 75ED 1E 11        		ld e,17
 2989 75EF 16 00        		ld d,0
 2990 75F1 B7           		or a
 2991 75F2 ED 52        		sbc hl,de
 2992 75F4 4D           		ld c,l
 2993 75F5 DA FA 75     		jp c,D1
 2994 75F8 0E 11        		ld c,17
 2995 75FA
 2996 75FA              D1
 2997 75FA 3A 89 75              ld   a,(POS_F+1)
 2998 75FD B9                    cp   c
 2999 75FE CA 35 76              jp   z,DOWN1
 3000 7601 5F           		 ld e,a
 3001 7602 16 00        		 ld d,0
 3002 7604 2A 4C 7A     		 ld hl,(ALLFILES)
 3003 7607 2B           		 dec hl
 3004 7608 B7           		 or a
 3005 7609 ED 52        		 sbc hl,de
 3006 760B C8           		 ret z
 3007 760C 0E 0F                 ld   c,%00001111
 3008 760E CD 4F 7A              call KURZOR
 3009 7611
 3010 7611 3C                    inc  a
 3011 7612 32 89 75              ld   (POS_F+1),a
 3012 7615 2A 33 76     		 ld hl,(apos_all)
 3013 7618 23           		 inc hl
 3014 7619 22 33 76     		 ld (apos_all),hl
 3015 761C 0E 17                 ld   c,%00010111
 3016 761E CD 4F 7A              call KURZOR
 3017 7621
 3018 7621 CD 12 66     		 call LFNPRINT
 3019 7624 21 59 BD     		ld hl,LFNNAME + maxline
 3020 7627 36 00        		ld (hl),0
 3021 7629 21 34 BD     		ld hl,LFNNAME
 3022 762C 11 C2 50     		ld de,20672+2
 3023 762F CD 26 7B     		call print
 3024 7632
 3025 7632 C9                    ret
 3026 7633
 3027 7633 00 00        apos_all defw 0
 3028 7635              DOWN1
 3029 7635 2A 33 76            	ld hl,(apos_all)
 3030 7638              		;dec hl
 3031 7638 EB           		ex de,hl
 3032 7639 2A 4C 7A     		ld hl,(ALLFILES)
 3033 763C 2B           		dec hl
 3034 763D EB           		ex de,hl
 3035 763E B7           		or a
 3036 763F ED 52        		sbc hl,de
 3037 7641 C8           		ret z			;maximum souboru
 3038 7642
 3039 7642 2A 33 76             ld hl,(apos_all)
 3040 7645              		;dec hl
 3041 7645 EB           		ex de,hl
 3042 7646 2A 4C 7A     		ld hl,(ALLFILES)
 3043 7649 2B           		dec hl
 3044 764A EB           		ex de,hl
 3045 764B B7           		or a
 3046 764C ED 52        		sbc hl,de
 3047 764E
 3048 764E EB           		ex de,hl
 3049 764F 2A 33 76     		ld hl,(apos_all)
 3050 7652
 3051 7652 B7           		or a
 3052 7653 ED 52        		sbc hl,de
 3053 7655 C8           		ret z
 3054 7656
 3055 7656 3A C1 75              ld   a,(POS_ALL+1)
 3056 7659 3C                    inc  a
 3057 765A 32 C1 75              ld   (POS_ALL+1),a
 3058 765D 2A 33 76     		 ld hl,(apos_all)
 3059 7660 23           		 inc hl
 3060 7661 22 33 76     		 ld (apos_all),hl
 3061 7664 F5                    push af
 3062 7665 CD D8 7A              call ROLLUP
 3063 7668 F1                    pop  af
 3064 7669 4F                    ld   c,a
 3065 766A 3A 89 75              ld   a,(POS_F+1)
 3066 766D 81                    add  a,c
 3067 766E 21 61 50              ld   hl,20576+1
 3068 7671 CD 67 7A              call PRN_F
 3069 7674 CD 12 66     		 call LFNPRINT
 3070 7677 21 59 BD     		ld hl,LFNNAME + maxline
 3071 767A 36 00        		ld (hl),0
 3072 767C 21 34 BD     		ld hl,LFNNAME
 3073 767F 11 C2 50     		ld de,20672+2
 3074 7682 CD 26 7B     		call print
 3075 7685
 3076 7685 C9                    ret
 3077 7686
 3078 7686              ;Font na vykreslování rámečků
 3079 7686              SPECFNT
 3080 7686 00 7F                 defw 32512
 3081 7688 7F 75                 defw 30079
 3082 768A 60 70                 defw 28768
 3083 768C 60 70                 defw 28768
 3084 768E
 3085 768E 00 FF                 defw 65280
 3086 7690 FF 55                 defw 22015
 3087 7692 00 00                 defw 0
 3088 7694 00 00                 defw 0
 3089 7696
 3090 7696 00 FE                 defw 65024
 3091 7698 FE 56                 defw 22270
 3092 769A 0E 06                 defw 1550
 3093 769C 0E 06                 defw 1550
 3094 769E
 3095 769E 60 70                 defw 28768
 3096 76A0 60 70                 defw 28768
 3097 76A2 60 70                 defw 28768
 3098 76A4 60 70                 defw 28768
 3099 76A6
 3100 76A6 00 00                 defw 0
 3101 76A8 00 00                 defw 0
 3102 76AA 00 00                 defw 0
 3103 76AC 00 00                 defw 0
 3104 76AE
 3105 76AE 0E 06                 defw 1550
 3106 76B0 0E 06                 defw 1550
 3107 76B2 0E 06                 defw 1550
 3108 76B4 0E 06                 defw 1550
 3109 76B6
 3110 76B6 60 70                 defw 28768
 3111 76B8 6A 7F                 defw 32618
 3112 76BA 7F 75                 defw 30079
 3113 76BC 60 70                 defw 28768
 3114 76BE
 3115 76BE 00 00                 defw 0
 3116 76C0 AA FF                 defw 65450
 3117 76C2 FF 55                 defw 22015
 3118 76C4 00 00                 defw 0
 3119 76C6
 3120 76C6 0E 06                 defw 1550
 3121 76C8 AE FE                 defw 65198
 3122 76CA FE 56                 defw 22270
 3123 76CC 0E 06                 defw 1550
 3124 76CE
 3125 76CE 60 70                 defw 28768
 3126 76D0 60 70                 defw 28768
 3127 76D2 6A 7F                 defw 32618
 3128 76D4 7F 00                 defw 127
 3129 76D6
 3130 76D6 00 00                 defw 0
 3131 76D8 00 00                 defw 0
 3132 76DA AA FF                 defw 65450
 3133 76DC FF 00                 defw 255
 3134 76DE
 3135 76DE 0E 06                 defw 1550
 3136 76E0 0E 06                 defw 1550
 3137 76E2 AE FE                 defw 65198
 3138 76E4 FE 00                 defw 254
 3139 76E6
 3140 76E6 00 55 00 55           defb 0,85,0,85,0,85,0
 3140 76EA 00 55 00
 3141 76ED 00                    defb 0
 3142 76EE
 3143 76EE              DOWNHL
 3144 76EE 24                    inc  h
 3145 76EF 7C                    ld   a,h
 3146 76F0 E6 07                 and  7
 3147 76F2 C0                    ret  nz
 3148 76F3 7D                    ld   a,l
 3149 76F4 C6 20                 add  a,32
 3150 76F6 6F                    ld   l,a
 3151 76F7 7C                    ld   a,h
 3152 76F8 D8                    ret  c
 3153 76F9 D6 08                 sub  8
 3154 76FB 67                    ld   h,a
 3155 76FC C9                    ret
 3156 76FD
 3157 76FD
 3158 76FD              DOWNH
 3159 76FD 7D                    ld   a,l
 3160 76FE C6 20                 add  a,32
 3161 7700 6F                    ld   l,a
 3162 7701 7C                    ld   a,h
 3163 7702 D0                    ret  nc
 3164 7703 C6 08                 add  a,2048/256
 3165 7705 67                    ld   h,a
 3166 7706 C9                    ret
 3167 7707
 3168 7707              ;Rutinka na vypsání jednoho znaku 8bitovým fontem.
 3169 7707              ; Vstup:
 3170 7707              			; A ... znak
 3171 7707              			; Pozice se určuje návěstím P_AT
 3172 7707              PRINT
 3173 7707 D9                    exx
 3174 7708 6F                    ld   l,a
 3175 7709 26 00                 ld   h,0
 3176 770B 29                    add  hl,hl
 3177 770C 29                    add  hl,hl
 3178 770D 29                    add  hl,hl
 3179 770E 01 00 3C     FNT      ld   bc,CHARS
 3180 7711 09                    add  hl,bc
 3181 7712 11 00 40     P_AT     ld   de,16384
 3182 7715
 3183 7715 D5                    push de
 3184 7716 7E                    ld   a,(hl)
 3185 7717
 3186 7717 12                    ld   (de),a
 3187 7718 23                    inc  hl
 3188 7719 14                    inc  d
 3189 771A 7E                    ld   a,(hl)
 3190 771B 12                    ld   (de),a
 3191 771C 23                    inc  hl
 3192 771D 14                    inc  d
 3193 771E 7E                    ld   a,(hl)
 3194 771F 12                    ld   (de),a
 3195 7720 23                    inc  hl
 3196 7721 14                    inc  d
 3197 7722 7E                    ld   a,(hl)
 3198 7723 12                    ld   (de),a
 3199 7724 23                    inc  hl
 3200 7725 14                    inc  d
 3201 7726 7E                    ld   a,(hl)
 3202 7727 12                    ld   (de),a
 3203 7728 23                    inc  hl
 3204 7729 14                    inc  d
 3205 772A 7E                    ld   a,(hl)
 3206 772B 12                    ld   (de),a
 3207 772C 23                    inc  hl
 3208 772D 14                    inc  d
 3209 772E 7E                    ld   a,(hl)
 3210 772F 12                    ld   (de),a
 3211 7730 23                    inc  hl
 3212 7731 14                    inc  d
 3213 7732 7E                    ld   a,(hl)
 3214 7733 12                    ld   (de),a
 3215 7734 D1                    pop  de
 3216 7735
 3217 7735 1C                    inc  e
 3218 7736 20 0A                 jr   nz,CHAR1B
 3219 7738 7A                    ld   a,d
 3220 7739 C6 08                 add  a,8
 3221 773B 57                    ld   d,a
 3222 773C FE 58                 cp   88
 3223 773E 38 02                 jr   c,CHAR1B
 3224 7740 16 40                 ld   d,64
 3225 7742 ED 53 13 77  CHAR1B   ld   (P_AT+1),de
 3226 7746 D9                    exx
 3227 7747 C9                    ret
 3228 7748
 3229 7748              ; Vykreslení rámečku
 3230 7748              ; Vstup:
 3231 7748              				;hl=adrvrm
 3232 7748              				;bc,vyska * 256 + sirka
 3233 7748              				;a=barva
 3234 7748              RAMECEK
 3235 7748 F5                    push af
 3236 7749 E5                    push hl
 3237 774A C5                    push bc
 3238 774B 22 13 77              ld   (P_AT+1),hl
 3239 774E
 3240 774E 0D                    dec  c
 3241 774F 0D                    dec  c
 3242 7750 E5                    push hl
 3243 7751 21 86 76              ld   hl,SPECFNT
 3244 7754 22 0F 77              ld   (FNT+1),hl
 3245 7757 C5                    push bc
 3246 7758
 3247 7758 3E 00                 ld   a,0
 3248 775A CD 07 77              call PRINT
 3249 775D 41                    ld   b,c
 3250 775E 3E 01        RAM1     ld   a,1
 3251 7760 CD 07 77              call PRINT
 3252 7763 10 F9                 djnz RAM1
 3253 7765 3E 02                 ld   a,2
 3254 7767 CD 07 77              call PRINT
 3255 776A C1                    pop  bc
 3256 776B E1                    pop  hl
 3257 776C 05                    dec  b
 3258 776D 05                    dec  b
 3259 776E CD FD 76              call DOWNH
 3260 7771 22 13 77              ld   (P_AT+1),hl
 3261 7774              RAM3
 3262 7774 E5                    push hl
 3263 7775 C5                    push bc
 3264 7776 3E 03                 ld   a,3
 3265 7778 CD 07 77              call PRINT
 3266 777B 41                    ld   b,c
 3267 777C 3E 04        RAM2     ld   a,4
 3268 777E CD 07 77              call PRINT
 3269 7781 10 F9                 djnz RAM2
 3270 7783 3E 05                 ld   a,5
 3271 7785 CD 07 77              call PRINT
 3272 7788 C1                    pop  bc
 3273 7789 E1                    pop  hl
 3274 778A CD FD 76              call DOWNH
 3275 778D 22 13 77              ld   (P_AT+1),hl
 3276 7790 10 E2                 djnz RAM3
 3277 7792
 3278 7792 3E 09                 ld   a,9
 3279 7794 CD 07 77              call PRINT
 3280 7797 41                    ld   b,c
 3281 7798 3E 0A        RAM4     ld   a,10
 3282 779A CD 07 77              call PRINT
 3283 779D 10 F9                 djnz RAM4
 3284 779F 3E 0B                 ld   a,11
 3285 77A1 CD 07 77              call PRINT
 3286 77A4
 3287 77A4 21 00 3C              ld   hl,CHARS
 3288 77A7 22 0F 77              ld   (FNT+1),hl
 3289 77AA
 3290 77AA C1                    pop  bc
 3291 77AB E1                    pop  hl
 3292 77AC 7C                    ld   a,h
 3293 77AD D6 40                 sub  64
 3294 77AF 0F                    rrca
 3295 77B0 0F                    rrca
 3296 77B1 0F                    rrca
 3297 77B2 E6 03                 and  3
 3298 77B4 C6 58                 add  a,88
 3299 77B6 67                    ld   h,a
 3300 77B7
 3301 77B7 0D                    dec  c
 3302 77B8
 3303 77B8 F1                    pop  af
 3304 77B9
 3305 77B9
 3306 77B9 C5           ATRR     push bc
 3307 77BA E5                    push hl
 3308 77BB 54                    ld   d,h
 3309 77BC 5D                    ld   e,l
 3310 77BD 1C                    inc  e
 3311 77BE 06 00                 ld   b,0
 3312 77C0 77                    ld   (hl),a
 3313 77C1 ED B0                 ldir
 3314 77C3 E1                    pop  hl
 3315 77C4 11 20 00              ld   de,32
 3316 77C7 19                    add  hl,de
 3317 77C8 C1                    pop  bc
 3318 77C9 10 EE                 djnz ATRR
 3319 77CB
 3320 77CB C9                    ret
 3321 77CC
 3322 77CC 43 75 72 73  tcursor defb "Cursors: move",0
 3322 77D0 6F 72 73 3A
 3322 77D4 20 6D 6F 76
 3322 77D8 65 00
 3323 77DA 45 6E 74 65  tenter defb "Enter: play song",0
 3323 77DE 72 3A 20 70
 3323 77E2 6C 61 79 20
 3323 77E6 73 6F 6E 67
 3323 77EA 00
 3324 77EB 53 70 61 63  tspace defb "Space: play next",0
 3324 77EF 65 3A 20 70
 3324 77F3 6C 61 79 20
 3324 77F7 6E 65 78 74
 3324 77FB 00
 3325 77FC 53 3A 20 73  tsearch defb "S: search",0
 3325 7800 65 61 72 63
 3325 7804 68 00
 3326 7806 52 3A 20 72  treload defb "R: reload directory",0
 3326 780A 65 6C 6F 61
 3326 780E 64 20 64 69
 3326 7812 72 65 63 74
 3326 7816 6F 72 79 00
 3327 781A
 3328 781A              ; Nakreslí všechny okna potřebné pro NextPlayer
 3329 781A              kresli:
 3330 781A
 3331 781A
 3332 781A 21 20 40     		  ld   hl,16416
 3333 781D 01 0E 14     		  ld   bc,20*256+14
 3334 7820 3E 0F        		  ld   a,%00001111
 3335 7822 CD 48 77     		  call RAMECEK
 3336 7825
 3337 7825 21 EE 40     		  ld   hl,16608+14
 3338 7828 01 12 0E     		  ld   bc,14*256+18
 3339 782B 3E 0F        		  ld   a,%00001111
 3340 782D CD 48 77     		  call RAMECEK
 3341 7830
 3342 7830 21 2E 40     		  ld   hl,16416+14
 3343 7833 01 12 06     		  ld   bc,6*256+18
 3344 7836 3E 07        		  ld   a,%00000111
 3345 7838 CD 48 77     		  call RAMECEK
 3346 783B
 3347 783B
 3348 783B
 3349 783B
 3350 783B 21 01 40     		  ld   hl,16384+1
 3351 783E 11 1A 79     		  ld   de,TEXT1
 3352 7841 CD 36 7A     		  call TEXT
 3353 7844
 3354 7844 11 0E 40     		  ld   de,16384+ 14
 3355 7847 21 25 79     		  ld   hl,nnext
 3356 784A CD 26 7B     		  call print
 3357 784D 21 0E 58     		ld hl,22528+14
 3358 7850 3E 05        		ld a,5
 3359 7852 06 11        		ld b,17
 3360 7854 77           kk		ld (hl),a
 3361 7855 23           		inc hl
 3362 7856 10 FC        		djnz kk
 3363 7858
 3364 7858 21 4F 40              ld   hl,16448+15
 3365 785B 11 E2 78              ld   de,Versionn
 3366 785E EB           		 ex de,hl
 3367 785F CD 26 7B              call print
 3368 7862 21 6F 40              ld   hl,16480+15
 3369 7865 11 F0 78              ld   de,Cursors
 3370 7868 EB                    ex de,hl
 3371 7869 CD 26 7B     		 call print
 3372 786C 21 8F 40              ld   hl,16512+15
 3373 786F 11 F2 78              ld   de,Play
 3374 7872 EB                    ex de,hl
 3375 7873 CD 26 7B     		 call print
 3376 7876 21 AF 40              ld   hl,16544+15
 3377 7879 11 06 79              ld   de,NextPlay
 3378 787C EB                    ex de,hl
 3379 787D CD 26 7B     		 call print
 3380 7880
 3381 7880 21 6F 48              ld   hl,18528+15
 3382 7883 11 CC 77              ld   de,tcursor
 3383 7886 EB                    ex de,hl
 3384 7887 CD 26 7B     		 call print
 3385 788A 21 8F 48              ld   hl,18560+15
 3386 788D 11 DA 77              ld   de,tenter
 3387 7890 EB                    ex de,hl
 3388 7891 CD 26 7B     		 call print
 3389 7894 21 AF 48              ld   hl,18592+15
 3390 7897 11 EB 77              ld   de,tspace
 3391 789A EB                    ex de,hl
 3392 789B CD 26 7B     		 call print
 3393 789E 21 CF 48              ld   hl,18624+15
 3394 78A1 11 FC 77              ld   de,tsearch
 3395 78A4 EB                    ex de,hl
 3396 78A5 CD 26 7B     		 call print
 3397 78A8 21 EF 48              ld   hl,18656+15
 3398 78AB 11 06 78              ld   de,treload
 3399 78AE EB                    ex de,hl
 3400 78AF CD 26 7B     		 call print
 3401 78B2 3E 0D        		ld a,00001101b
 3402 78B4
 3403 78B4 21 6F 59     		ld hl,11*32+22528 + 15
 3404 78B7 06 0E        		ld b,14
 3405 78B9 77           		ld (hl),a
 3406 78BA 23           		inc hl
 3407 78BB 10 FC        		djnz $-2
 3408 78BD
 3409 78BD 21 8F 59     		ld hl,12*32+22528 + 15
 3410 78C0 06 0E        		ld b,14
 3411 78C2 77           		ld (hl),a
 3412 78C3 23           		inc hl
 3413 78C4 10 FC        		djnz $-2
 3414 78C6
 3415 78C6 21 AF 59     		ld hl,13*32+22528 + 15
 3416 78C9 06 0E        		ld b,14
 3417 78CB 77           		ld (hl),a
 3418 78CC 23           		inc hl
 3419 78CD 10 FC        		djnz $-2
 3420 78CF
 3421 78CF 21 CF 59     		ld hl,14*32+22528 + 15
 3422 78D2 06 0E        		ld b,14
 3423 78D4 77           		ld (hl),a
 3424 78D5 23           		inc hl
 3425 78D6 10 FC        		djnz $-2
 3426 78D8
 3427 78D8 21 EF 59     		ld hl,15*32+22528 + 15
 3428 78DB 06 0F        		ld b,15
 3429 78DD 77           		ld (hl),a
 3430 78DE 23           		inc hl
 3431 78DF 10 FC        		djnz $-2
 3432 78E1
 3433 78E1
 3434 78E1 C9                         ret
 3435 78E2
 3436 78E2 56 65 72 73  Versionn  defb "Version: 0.61",0
 3436 78E6 69 6F 6E 3A
 3436 78EA 20 30 2E 36
 3436 78EE 31 00
 3437 78F0 20 00        Cursors defb " ",0
 3438 78F2 4D 61 69 6E  Play    defb "Main program: Shrek",0
 3438 78F6 20 70 72 6F
 3438 78FA 67 72 61 6D
 3438 78FE 3A 20 53 68
 3438 7902 72 65 6B 00
 3439 7906 41 59 20 72  NextPlay defb "AY routines: mborik",0
 3439 790A 6F 75 74 69
 3439 790E 6E 65 73 3A
 3439 7912 20 6D 62 6F
 3439 7916 72 69 6B 00
 3440 791A 4E 65 78 74  TEXT1    defb "NextPlayer",0
 3440 791E 50 6C 61 79
 3440 7922 65 72 00
 3441 7925
 3442 7925 20 20 66 6F  nnext    defb "  for ZX Spectrum Next",0
 3442 7929 72 20 5A 58
 3442 792D 20 53 70 65
 3442 7931 63 74 72 75
 3442 7935 6D 20 4E 65
 3442 7939 78 74 00
 3443 793C
 3444 793C
 3445 793C
 3446 793C              WRFILES
 3447 793C CD 82 65     		 call BUFF83
 3448 793F 2A 4C 7A              ld   hl,(ALLFILES)
 3449 7942 7D           		 ld a,l
 3450 7943 11 12 00     		 ld de,18
 3451 7946 B7                    or a
 3452 7947 ED 52        		 sbc hl,de
 3453 7949 38 02                 jr   c,WRF4
 3454 794B 3E 12                 ld   a,18
 3455 794D 47           WRF4     ld   b,a
 3456 794E 21 41 40              ld   hl,16448+1
 3457 7951 11 0D 80     WRBUFF   ld   de,catbuff+#D
 3458 7954
 3459 7954 C5           WRF2     push bc
 3460 7955 E5                    push hl
 3461 7956 22 13 77              ld   (P_AT+1),hl
 3462 7959
 3463 7959 1A                    ld   a,(de)
 3464 795A FE 20                 cp   32
 3465 795C 28 1A                 jr   z,ENDP
 3466 795E CD 84 79              call WRMOD
 3467 7961
 3468 7961 21 4E 7A              ld   hl,POC
 3469 7964 34                    inc  (hl)
 3470 7965 E1                    pop  hl
 3471 7966 CD FD 76              call DOWNH
 3472 7969 C1                    pop  bc
 3473 796A 10 E8                 djnz WRF2
 3474 796C              E2
 3475 796C 3A 89 75              ld   a,(POS_F+1)
 3476 796F 0E 17                 ld   c,%00010111
 3477 7971 CD 4F 7A              call KURZOR
 3478 7974 CD 93 65     		 call NOBUFF83
 3479 7977 C9                    ret
 3480 7978
 3481 7978 E1           ENDP     pop  hl
 3482 7979 C1                    pop  bc
 3483 797A 21 4E 7A              ld   hl,POC
 3484 797D 7E                    ld   a,(hl)
 3485 797E 32 4B 7A              ld   (FILES),a
 3486 7981 18 E9                 jr   E2
 3487 7983 00           dir		 defb 0
 3488 7984              WRMOD
 3489 7984
 3490 7984
 3491 7984
 3492 7984              		 ;původni WRMOD
 3493 7984 D5           		 push de
 3494 7985 21 07 00     		 ld hl,7
 3495 7988 19           		 add hl,de
 3496 7989 CB 7E        		 bit 7,(hl)
 3497 798B 28 07        		 jr z,neni_adr
 3498 798D 3E 01        		 ld a,1
 3499 798F 32 83 79     		 ld (dir),a
 3500 7992 18 04        		 jr je_dir
 3501 7994 AF           neni_adr xor a
 3502 7995 32 83 79     		 ld (dir),a
 3503 7998              je_dir
 3504 7998 D1           		 pop de
 3505 7999 DD 21 00 60  		 ld ix,filename
 3506 799D 06 08                 ld   b,8
 3507 799F 1A           WRF1     ld   a,(de)
 3508 79A0 B7                    or   a
 3509 79A1 28 30                 jr   z,WWR
 3510 79A3 DD 77 00     		 ld (ix+0),a
 3511 79A6 DD 23        		 inc ix
 3512 79A8 CB BF        		 res 7,a
 3513 79AA CD 07 77              call PRINT
 3514 79AD 13                    inc  de
 3515 79AE 10 EF                 djnz WRF1
 3516 79B0 3A 83 79     		 ld a,(dir)
 3517 79B3 B7           		 or a
 3518 79B4 20 1F        		 jr nz,wwrdir
 3519 79B6 3E 2E        		 ld a,"."
 3520 79B8 DD 77 00     		 ld (ix+0),a
 3521 79BB DD 23        		 inc ix
 3522 79BD CD 07 77     		 call PRINT
 3523 79C0 06 03        		 ld b,3
 3524 79C2 1A           wrf2	 ld a,(de)
 3525 79C3 CB BF        		 res 7,a
 3526 79C5 DD 77 00     		 ld (ix+0),a
 3527 79C8 DD 23        		 inc ix
 3528 79CA
 3529 79CA CD 07 77     		 call PRINT
 3530 79CD 13           		 inc de
 3531 79CE 10 F2        		 djnz wrf2
 3532 79D0 13           		 inc de
 3533 79D1 13           		 inc de
 3534 79D2 C9                    ret
 3535 79D3              WWR
 3536 79D3 13                    inc  de
 3537 79D4 C9                    ret
 3538 79D5
 3539 79D5              wwrdir
 3540 79D5 D5           		push de
 3541 79D6 3E 20        		ld a,32
 3542 79D8 CD 07 77     		call PRINT
 3543 79DB 3E 44        		ld a,"D"
 3544 79DD CD 07 77     		call PRINT
 3545 79E0 3E 49        		ld a,"I"
 3546 79E2 CD 07 77     		call PRINT
 3547 79E5 3E 52        		ld a,"R"
 3548 79E7 CD 07 77     		call PRINT
 3549 79EA D1           		pop de
 3550 79EB
 3551 79EB 13           		inc de
 3552 79EC 13           		inc de
 3553 79ED 13           		inc de
 3554 79EE 13           		inc de
 3555 79EF              		;inc de
 3556 79EF 13           		inc de
 3557 79F0 C9           		ret
 3558 79F1
 3559 79F1 CD 82 65     NOWRMOD	 call BUFF83
 3560 79F4 DD 21 00 60  		 ld ix,filename
 3561 79F8 06 08                 ld   b,8
 3562 79FA 1A           aWRF1     ld   a,(de)
 3563 79FB B7                    or   a
 3564 79FC 28 22                 jr   z,aWWR
 3565 79FE DD 77 00     		 ld (ix+0),a
 3566 7A01 DD 23        		 inc ix
 3567 7A03                       ;call PRINT
 3568 7A03 13                    inc  de
 3569 7A04 10 F4                 djnz aWRF1
 3570 7A06 3E 2E        		 ld a,"."
 3571 7A08 DD 77 00     		 ld (ix+0),a
 3572 7A0B DD 23        		 inc ix
 3573 7A0D
 3574 7A0D              ;		 call PRINT
 3575 7A0D 06 03        		 ld b,3
 3576 7A0F 1A           awrf2	 ld a,(de)
 3577 7A10 CB BF        		 res 7,a
 3578 7A12 DD 77 00     		 ld (ix+0),a
 3579 7A15 DD 23        		 inc ix
 3580 7A17
 3581 7A17              ;		 call PRINT
 3582 7A17 13           		 inc de
 3583 7A18 10 F5        		 djnz awrf2
 3584 7A1A 13           		 inc de
 3585 7A1B 13           		 inc de
 3586 7A1C CD 93 65              call NOBUFF83
 3587 7A1F C9           		 ret
 3588 7A20              aWWR
 3589 7A20 13                    inc  de
 3590 7A21 CD 93 65     		 call NOBUFF83
 3591 7A24 C9                    ret
 3592 7A25
 3593 7A25
 3594 7A25              S_TEXT
 3595 7A25 01 86 76              ld   bc,SPECFNT
 3596 7A28 ED 43 0F 77           ld   (FNT+1),bc
 3597 7A2C CD 36 7A              call TEXT
 3598 7A2F 21 00 3C              ld   hl,CHARS
 3599 7A32 22 0F 77              ld   (FNT+1),hl
 3600 7A35 C9                    ret
 3601 7A36              TEXT
 3602 7A36 22 13 77              ld   (P_AT+1),hl
 3603 7A39 EB                    ex   de,hl
 3604 7A3A              TEX1
 3605 7A3A 7E                    ld   a,(hl)
 3606 7A3B B7                    or   a
 3607 7A3C C8                    ret  z
 3608 7A3D CB 7F        		 bit 7,a
 3609 7A3F CB BF        		 res 7,a
 3610 7A41 C2 07 77     		 jp nz,PRINT
 3611 7A44 CD 07 77              call PRINT
 3612 7A47 23                    inc  hl
 3613 7A48 18 F0                 jr   TEX1
 3614 7A4A C9                    ret
 3615 7A4B 00           FILES    defb 0
 3616 7A4C 00 00        ALLFILES defb 0,0
 3617 7A4E 00           POC      defb 0
 3618 7A4F
 3619 7A4F              KURZOR
 3620 7A4F F5                    push af
 3621 7A50 87                    add  a,a
 3622 7A51 87                    add  a,a
 3623 7A52 87                    add  a,a
 3624 7A53 6F                    ld   l,a
 3625 7A54 26 00                 ld   h,0
 3626 7A56 29                    add  hl,hl
 3627 7A57 29                    add  hl,hl
 3628 7A58 11 41 58              ld   de,22528+64+1
 3629 7A5B 19                    add  hl,de
 3630 7A5C 5D                    ld   e,l
 3631 7A5D 54                    ld   d,h
 3632 7A5E 13                    inc  de
 3633 7A5F 71                    ld   (hl),c
 3634 7A60 01 0B 00              ld   bc,11
 3635 7A63 ED B0                 ldir
 3636 7A65 F1                    pop  af
 3637 7A66 C9                    ret
 3638 7A67
 3639 7A67              PRN_F
 3640 7A67 CD 82 65     		 call BUFF83
 3641 7A6A 22 13 77              ld   (P_AT+1),hl
 3642 7A6D 2A 33 76     		 ld hl,(apos_all)
 3643 7A70
 3644 7A70 7D           		 ld a,l
 3645 7A71 B4           		 or h
 3646 7A72 EB           		 ex de,hl
 3647 7A73 21 0D 80     		 ld hl,catbuff+#d
 3648 7A76 28 0E        		 jr z,F12
 3649 7A78 21 00 80     		 ld hl,catbuff
 3650 7A7B 42           		 ld b,d
 3651 7A7C 4B           		 ld c,e
 3652 7A7D 11 0D 00     		 ld de,13
 3653 7A80 19           F02      add hl,de
 3654 7A81
 3655 7A81 78           		 ld a,b
 3656 7A82 B1           		 or c
 3657 7A83 0B           		 dec bc
 3658 7A84 20 FA        		 jr nz,F02
 3659 7A86              F12
 3660 7A86 EB                    ex   de,hl
 3661 7A87 CD 84 79              call WRMOD
 3662 7A8A CD 93 65     		 call NOBUFF83
 3663 7A8D C9                    ret
 3664 7A8E
 3665 7A8E
 3666 7A8E ED 91 57 12  INIROLL  nextreg $57,18
 3667 7A92 06 88                 ld   b,17*8
 3668 7A94 21 20 E2              ld   hl,UPDATA
 3669 7A97              IR1
 3670 7A97 11 61 40     INI1     ld   de,16480+1
 3671 7A9A 73                    ld   (hl),e
 3672 7A9B 23                    inc  hl
 3673 7A9C 72                    ld   (hl),d
 3674 7A9D 23                    inc  hl
 3675 7A9E CD 11 7B              call DOWNDE
 3676 7AA1 ED 53 98 7A           ld   (INI1+1),de
 3677 7AA5
 3678 7AA5 11 41 40     INI2     ld   de,16448+1
 3679 7AA8 73                    ld   (hl),e
 3680 7AA9 23                    inc  hl
 3681 7AAA 72                    ld   (hl),d
 3682 7AAB 23                    inc  hl
 3683 7AAC CD 11 7B              call DOWNDE
 3684 7AAF ED 53 A6 7A           ld   (INI2+1),de
 3685 7AB3 10 E2                 djnz IR1
 3686 7AB5
 3687 7AB5 06 88                 ld   b,17*8
 3688 7AB7 21 1F E2              ld   hl,UPDATA-1
 3689 7ABA              IR2
 3690 7ABA 11 61 40     INI12    ld   de,16480+1
 3691 7ABD 72                    ld   (hl),d
 3692 7ABE 2B                    dec  hl
 3693 7ABF 73                    ld   (hl),e
 3694 7AC0 2B                    dec  hl
 3695 7AC1 CD 11 7B              call DOWNDE
 3696 7AC4 ED 53 BB 7A           ld   (INI12+1),de
 3697 7AC8
 3698 7AC8 11 41 40     INI22    ld   de,16448+1
 3699 7ACB 72                    ld   (hl),d
 3700 7ACC 2B                    dec  hl
 3701 7ACD 73                    ld   (hl),e
 3702 7ACE 2B                    dec  hl
 3703 7ACF CD 11 7B              call DOWNDE
 3704 7AD2 ED 53 C9 7A           ld   (INI22+1),de
 3705 7AD6 10 E2                 djnz IR2
 3706 7AD8
 3707 7AD8              ROLLUP
 3708 7AD8
 3709 7AD8 21 20 E2              ld   hl,UPDATA
 3710 7ADB C3 E1 7A              jp   ROLL
 3711 7ADE              ROLLDOWN
 3712 7ADE 21 00 E0              ld   hl,DOWNDATA
 3713 7AE1 ED 91 57 12  ROLL	 nextreg $57,18
 3714 7AE5 ED 73 0A 7B           ld   (SP_ST+1),sp
 3715 7AE9 F9                    ld   sp,hl
 3716 7AEA 3E 88                 ld   a,8*17
 3717 7AEC              ROLL1
 3718 7AEC E1                    pop  hl
 3719 7AED D1                    pop  de
 3720 7AEE
 3721 7AEE ED A0                 ldi
 3722 7AF0 ED A0                 ldi
 3723 7AF2 ED A0                 ldi
 3724 7AF4 ED A0                 ldi
 3725 7AF6 ED A0                 ldi
 3726 7AF8 ED A0                 ldi
 3727 7AFA ED A0                 ldi
 3728 7AFC ED A0                 ldi
 3729 7AFE ED A0                 ldi
 3730 7B00 ED A0                 ldi
 3731 7B02 ED A0                 ldi
 3732 7B04 ED A0                 ldi
 3733 7B06
 3734 7B06 3D                    dec  a
 3735 7B07 20 E3                 jr   nz,ROLL1
 3736 7B09
 3737 7B09 31 00 00     SP_ST    ld   sp,0
 3738 7B0C ED 91 57 01  		 nextreg $57,1				;Stránka na uložení VideoRam
 3739 7B10 C9                    ret
 3740 7B11
 3741 7B11              DOWNDE
 3742 7B11 14                    inc  d
 3743 7B12 7A                    ld   a,d
 3744 7B13 E6 07                 and  7
 3745 7B15 C0                    ret  nz
 3746 7B16 7B                    ld   a,e
 3747 7B17 C6 20                 add  a,32
 3748 7B19 5F                    ld   e,a
 3749 7B1A 7A                    ld   a,d
 3750 7B1B D8                    ret  c
 3751 7B1C D6 08                 sub  8
 3752 7B1E 57                    ld   d,a
 3753 7B1F C9                    ret
 3754 7B20 00 00        maxpos	defw 0
 3755 7B22 00 00        maxpos2 defw 0
 3756 7B24 00           pp		defb 0
 3757 7B25 00           pp_a	defb 0
 3758 7B26 E5           print:	push hl
 3759 7B27 D5           		push de
 3760 7B28 21 37 00     		ld hl,55
 3761 7B2B 19           		add hl,de
 3762 7B2C
 3763 7B2C 22 20 7B     		ld (maxpos),hl
 3764 7B2F 11 21 00     		ld de,33
 3765 7B32 19           		add hl,de
 3766 7B33 22 22 7B     		ld (maxpos2),hl
 3767 7B36 D1           		pop de
 3768 7B37 E1           		pop hl
 3769 7B38              ;		ld	de,printpos
 3770 7B38 ED 53 36 7F  p6b		ld	(pos),de
 3771 7B3C AF           		xor	a
 3772 7B3D 32 38 7F     		ld	(roll),a
 3773 7B40
 3774 7B40              print1:
 3775 7B40 E5           		push hl
 3776 7B41 2A 20 7B     		ld hl,(maxpos)
 3777 7B44 B7                   or a
 3778 7B45 ED 5B 36 7F  		ld de,(pos)
 3779 7B49 ED 52        		sbc hl,de
 3780 7B4B 20 07        		jr nz,pophl
 3781 7B4D 21 08 00     odskok	ld hl,8
 3782 7B50 19           		add hl,de
 3783 7B51 22 36 7F     		ld (pos),hl
 3784 7B54
 3785 7B54
 3786 7B54              pophl
 3787 7B54 2A 36 7F     		ld hl,(pos)
 3788 7B57 ED 5B 22 7B  		ld de,(maxpos2)
 3789 7B5B B7           		or a
 3790 7B5C ED 52        		sbc hl,de
 3791 7B5E 20 02        		jr nz, pophl2
 3792 7B60 E1           		pop hl
 3793 7B61 C9           		ret
 3794 7B62              pophl2
 3795 7B62 E1           		pop hl
 3796 7B63 E5           		push	hl
 3797 7B64 7E           		ld	a,(hl)
 3798 7B65 E6 7F        		and	127
 3799 7B67 B7           		or a
 3800 7B68 20 02        		jr nz,ppp1
 3801 7B6A
 3802 7B6A 3E 20        		ld a,32
 3803 7B6C              ppp1
 3804 7B6C CD 9A 7B     		call	ascii
 3805 7B6F 3A 38 7F     		ld	a,(roll)
 3806 7B72 3C           		inc	a
 3807 7B73 FE 01        		cp	1
 3808 7B75 CC 92 7B     		call	z,print2
 3809 7B78 FE 02        		cp	2
 3810 7B7A CC 92 7B     		call	z,print2
 3811 7B7D FE 04        		cp	4
 3812 7B7F 20 05        		jr	nz,print3
 3813 7B81 3E 00        		ld	a,0
 3814 7B83 CD 92 7B     		call	print2
 3815 7B86              print3:
 3816 7B86 32 38 7F     		ld	(roll),a
 3817 7B89 E1           		pop	hl
 3818 7B8A E5           		push hl
 3819 7B8B 7E           		ld a,(hl)
 3820 7B8C B7           		or a
 3821 7B8D E1           		pop hl
 3822 7B8E 23           		inc	hl
 3823 7B8F C8           		ret	z
 3824 7B90 18 AE        		jr	print1
 3825 7B92
 3826 7B92              print2:
 3827 7B92 2A 36 7F     		ld	hl,(pos)
 3828 7B95 23           		inc	hl
 3829 7B96 22 36 7F     		ld	(pos),hl
 3830 7B99 C9           		ret
 3831 7B9A
 3832 7B9A              ascii:
 3833 7B9A 01 36 7C     		ld	bc,font
 3834 7B9D C5           		push	bc
 3835 7B9E D6 20        		sub	32
 3836 7BA0 5F           		ld	e,a
 3837 7BA1 16 00        		ld	d,0
 3838 7BA3 06 08        		ld	b,8
 3839 7BA5 21 00 00     		ld	hl,0
 3840 7BA8              x8:
 3841 7BA8 19           		add	hl,de
 3842 7BA9 10 FD        		djnz	x8
 3843 7BAB C1           		pop	bc
 3844 7BAC 09           		add	hl,bc
 3845 7BAD ED 5B 36 7F  		ld	de,(pos)
 3846 7BB1 EB           		ex	de,hl
 3847 7BB2              asci0:
 3848 7BB2 3A 38 7F     		ld	a,(roll)
 3849 7BB5 FE 03        		cp	3
 3850 7BB7 28 40        		jr	z,roll3
 3851 7BB9 FE 02        		cp	2
 3852 7BBB 28 1E        		jr	z,roll2
 3853 7BBD FE 01        		cp	1
 3854 7BBF 28 04        		jr	z,roll1
 3855 7BC1              roll0:
 3856 7BC1 CD 09 7C     		call	asci1
 3857 7BC4 C9           		ret
 3858 7BC5
 3859 7BC5              roll1:
 3860 7BC5 06 08        		ld	b,8
 3861 7BC7              rol1_1:
 3862 7BC7 1A           		ld	a,(de)
 3863 7BC8 CB 27        		sla	a
 3864 7BCA 0E 00        		ld	c,0
 3865 7BCC CB 11        		rl	c
 3866 7BCE CB 27        		sla	a
 3867 7BD0 CB 11        		rl	c
 3868 7BD2 C5           		push	bc
 3869 7BD3 CD 14 7C     		call	asci2
 3870 7BD6 C1           		pop	bc
 3871 7BD7 13           		inc	de
 3872 7BD8 10 ED        		djnz	rol1_1
 3873 7BDA C9           		ret
 3874 7BDB
 3875 7BDB              roll2:
 3876 7BDB 06 08        		ld	b,8
 3877 7BDD              rol2_1:
 3878 7BDD 1A           		ld	a,(de)
 3879 7BDE CB 27        		sla	a
 3880 7BE0 0E 00        		ld	c,0
 3881 7BE2 CB 11        		rl	c
 3882 7BE4 CB 27        		sla	a
 3883 7BE6 CB 11        		rl	c
 3884 7BE8 CB 27        		sla	a
 3885 7BEA CB 11        		rl	c
 3886 7BEC CB 27        		sla	a
 3887 7BEE CB 11        		rl	c
 3888 7BF0 C5           		push	bc
 3889 7BF1 CD 14 7C     		call	asci2
 3890 7BF4 C1           		pop	bc
 3891 7BF5 13           		inc	de
 3892 7BF6 10 E5        		djnz	rol2_1
 3893 7BF8 C9           		ret
 3894 7BF9
 3895 7BF9              roll3:
 3896 7BF9 06 08        		ld	b,8
 3897 7BFB              rol3_1:
 3898 7BFB 1A           		ld	a,(de)
 3899 7BFC CB 3F        		srl	a
 3900 7BFE CB 3F        		srl	a
 3901 7C00 C5           		push	bc
 3902 7C01 CD 1E 7C     		call	asci3
 3903 7C04 C1           		pop	bc
 3904 7C05 13           		inc	de
 3905 7C06 10 F3        		djnz	rol3_1
 3906 7C08 C9           		ret
 3907 7C09
 3908 7C09              asci1:
 3909 7C09 06 08        		ld	b,8
 3910 7C0B              asc1:
 3911 7C0B 1A           		ld	a,(de)
 3912 7C0C 77           		ld	(hl),a
 3913 7C0D 13           		inc	de
 3914 7C0E CD 20 7C     		call	downhl
 3915 7C11 10 F8        		djnz	asc1
 3916 7C13 C9           		ret
 3917 7C14
 3918 7C14              asci2:
 3919 7C14 77           		ld	(hl),a
 3920 7C15 79           		ld	a,c
 3921 7C16 2B           		dec	hl
 3922 7C17 B6           		or	(hl)
 3923 7C18 77           		ld	(hl),a
 3924 7C19 23           		inc	hl
 3925 7C1A CD 20 7C     		call	downhl
 3926 7C1D C9           		ret
 3927 7C1E
 3928 7C1E              asci3:
 3929 7C1E B6           		or	(hl)
 3930 7C1F 77           		ld	(hl),a
 3931 7C20
 3932 7C20              downhl:
 3933 7C20 24           		inc	h
 3934 7C21 7C           		ld	a,h
 3935 7C22 E6 07        		and	7
 3936 7C24 C0           		ret	nz
 3937 7C25 7D           		ld	a,l
 3938 7C26 C6 20        		add	a,32
 3939 7C28 6F           		ld	l,a
 3940 7C29 7C           		ld	a,h
 3941 7C2A 38 03        		jr	c,down2
 3942 7C2C D6 08        		sub	8
 3943 7C2E 67           		ld	h,a
 3944 7C2F              down2:
 3945 7C2F FE 58        		cp	88
 3946 7C31 D8           		ret	c
 3947 7C32 21 40 00     		ld	hl,64
 3948 7C35 C9           		ret
 3949 7C36
 3950 7C36              ;5-bit font
 3951 7C36              font:
 3952 7C36 00 00 00 00  		db	$00, $00, $00, $00, $00, $00, $00, $00
 3952 7C3A 00 00 00 00
 3953 7C3E 00 20 20 20  		db	$00, $20, $20, $20, $20, $00, $20, $00
 3953 7C42 20 00 20 00
 3954 7C46 00 50 50 00  		db	$00, $50, $50, $00, $00, $00, $00, $00
 3954 7C4A 00 00 00 00
 3955 7C4E 00 50 F8 50  		db	$00, $50, $F8, $50, $50, $F8, $50, $00
 3955 7C52 50 F8 50 00
 3956 7C56 00 20 F8 A0  		db	$00, $20, $F8, $A0, $F8, $28, $F8, $20
 3956 7C5A F8 28 F8 20
 3957 7C5E 00 40 A8 50  		db	$00, $40, $A8, $50, $20, $50, $A8, $10
 3957 7C62 20 50 A8 10
 3958 7C66 00 20 50 20  		db	$00, $20, $50, $20, $68, $90, $68, $00
 3958 7C6A 68 90 68 00
 3959 7C6E 00 10 20 00  		db	$00, $10, $20, $00, $00, $00, $00, $00
 3959 7C72 00 00 00 00
 3960 7C76 00 08 10 10  		db	$00, $08, $10, $10, $10, $10, $08, $00
 3960 7C7A 10 10 08 00
 3961 7C7E 00 40 20 20  		db	$00, $40, $20, $20, $20, $20, $40, $00
 3961 7C82 20 20 40 00
 3962 7C86 00 00 50 20  		db	$00, $00, $50, $20, $F8, $20, $50, $00
 3962 7C8A F8 20 50 00
 3963 7C8E 00 00 20 20  		db	$00, $00, $20, $20, $F8, $20, $20, $00
 3963 7C92 F8 20 20 00
 3964 7C96 00 00 00 00  		db	$00, $00, $00, $00, $00, $10, $10, $20
 3964 7C9A 00 10 10 20
 3965 7C9E 00 00 00 00  		db	$00, $00, $00, $00, $78, $00, $00, $00
 3965 7CA2 78 00 00 00
 3966 7CA6 00 00 00 00  		db	$00, $00, $00, $00, $00, $30, $30, $00
 3966 7CAA 00 30 30 00
 3967 7CAE 00 00 08 10  		db	$00, $00, $08, $10, $20, $40, $80, $00
 3967 7CB2 20 40 80 00
 3968 7CB6 00 70 98 A8  		db	$00, $70, $98, $A8, $A8, $C8, $70, $00
 3968 7CBA A8 C8 70 00
 3969 7CBE 00 60 A0 20  		db	$00, $60, $A0, $20, $20, $20, $F8, $00
 3969 7CC2 20 20 F8 00
 3970 7CC6 00 70 88 08  		db	$00, $70, $88, $08, $70, $80, $F8, $00
 3970 7CCA 70 80 F8 00
 3971 7CCE 00 70 88 30  		db	$00, $70, $88, $30, $08, $88, $70, $00
 3971 7CD2 08 88 70 00
 3972 7CD6 00 10 30 50  		db	$00, $10, $30, $50, $90, $F8, $10, $00
 3972 7CDA 90 F8 10 00
 3973 7CDE 00 F8 80 F0  		db	$00, $F8, $80, $F0, $08, $88, $70, $00
 3973 7CE2 08 88 70 00
 3974 7CE6 00 70 80 F0  		db	$00, $70, $80, $F0, $88, $88, $70, $00
 3974 7CEA 88 88 70 00
 3975 7CEE 00 F8 08 10  		db	$00, $F8, $08, $10, $20, $40, $40, $00
 3975 7CF2 20 40 40 00
 3976 7CF6 00 70 88 70  		db	$00, $70, $88, $70, $88, $88, $70, $00
 3976 7CFA 88 88 70 00
 3977 7CFE 00 70 88 88  		db	$00, $70, $88, $88, $78, $08, $70, $00
 3977 7D02 78 08 70 00
 3978 7D06 00 00 00 20  		db	$00, $00, $00, $20, $00, $00, $20, $00
 3978 7D0A 00 00 20 00
 3979 7D0E 00 00 20 00  		db	$00, $00, $20, $00, $00, $20, $20, $40
 3979 7D12 00 20 20 40
 3980 7D16 00 00 08 10  		db	$00, $00, $08, $10, $20, $10, $08, $00
 3980 7D1A 20 10 08 00
 3981 7D1E 00 00 00 78  		db	$00, $00, $00, $78, $00, $78, $00, $00
 3981 7D22 00 78 00 00
 3982 7D26 00 00 20 10  		db	$00, $00, $20, $10, $08, $10, $20, $00
 3982 7D2A 08 10 20 00
 3983 7D2E 00 70 88 10  		db	$00, $70, $88, $10, $20, $00, $20, $00
 3983 7D32 20 00 20 00
 3984 7D36 00 70 08 68  		db	$00, $70, $08, $68, $A8, $A8, $70, $00
 3984 7D3A A8 A8 70 00
 3985 7D3E 00 70 88 88  		db	$00, $70, $88, $88, $F8, $88, $88, $00
 3985 7D42 F8 88 88 00
 3986 7D46 00 F0 88 F0  		db	$00, $F0, $88, $F0, $88, $88, $F0, $00
 3986 7D4A 88 88 F0 00
 3987 7D4E 00 70 88 80  		db	$00, $70, $88, $80, $80, $88, $70, $00
 3987 7D52 80 88 70 00
 3988 7D56 00 E0 90 88  		db	$00, $E0, $90, $88, $88, $90, $E0, $00
 3988 7D5A 88 90 E0 00
 3989 7D5E 00 F8 80 F0  		db	$00, $F8, $80, $F0, $80, $80, $F8, $00
 3989 7D62 80 80 F8 00
 3990 7D66 00 F8 80 F0  		db	$00, $F8, $80, $F0, $80, $80, $80, $00
 3990 7D6A 80 80 80 00
 3991 7D6E 00 70 88 80  		db	$00, $70, $88, $80, $B8, $88, $70, $00
 3991 7D72 B8 88 70 00
 3992 7D76 00 88 88 F8  		db	$00, $88, $88, $F8, $88, $88, $88, $00
 3992 7D7A 88 88 88 00
 3993 7D7E 00 F8 20 20  		db	$00, $F8, $20, $20, $20, $20, $F8, $00
 3993 7D82 20 20 F8 00
 3994 7D86 00 08 08 08  		db	$00, $08, $08, $08, $88, $88, $70, $00
 3994 7D8A 88 88 70 00
 3995 7D8E 00 90 A0 C0  		db	$00, $90, $A0, $C0, $A0, $90, $88, $00
 3995 7D92 A0 90 88 00
 3996 7D96 00 80 80 80  		db	$00, $80, $80, $80, $80, $80, $F8, $00
 3996 7D9A 80 80 F8 00
 3997 7D9E 00 88 D8 A8  		db	$00, $88, $D8, $A8, $88, $88, $88, $00
 3997 7DA2 88 88 88 00
 3998 7DA6 00 88 C8 A8  		db	$00, $88, $C8, $A8, $98, $88, $88, $00
 3998 7DAA 98 88 88 00
 3999 7DAE 00 70 88 88  		db	$00, $70, $88, $88, $88, $88, $70, $00
 3999 7DB2 88 88 70 00
 4000 7DB6 00 F0 88 88  		db	$00, $F0, $88, $88, $F0, $80, $80, $00
 4000 7DBA F0 80 80 00
 4001 7DBE 00 70 88 88  		db	$00, $70, $88, $88, $A8, $98, $70, $00
 4001 7DC2 A8 98 70 00
 4002 7DC6 00 F0 88 88  		db	$00, $F0, $88, $88, $F0, $90, $88, $00
 4002 7DCA F0 90 88 00
 4003 7DCE 00 70 80 70  		db	$00, $70, $80, $70, $08, $88, $70, $00
 4003 7DD2 08 88 70 00
 4004 7DD6 00 F8 20 20  		db	$00, $F8, $20, $20, $20, $20, $20, $00
 4004 7DDA 20 20 20 00
 4005 7DDE 00 88 88 88  		db	$00, $88, $88, $88, $88, $88, $70, $00
 4005 7DE2 88 88 70 00
 4006 7DE6 00 88 88 88  		db	$00, $88, $88, $88, $88, $50, $20, $00
 4006 7DEA 88 50 20 00
 4007 7DEE 00 88 88 88  		db	$00, $88, $88, $88, $88, $A8, $50, $00
 4007 7DF2 88 A8 50 00
 4008 7DF6 00 88 50 20  		db	$00, $88, $50, $20, $20, $50, $88, $00
 4008 7DFA 20 50 88 00
 4009 7DFE 00 88 50 20  		db	$00, $88, $50, $20, $20, $20, $20, $00
 4009 7E02 20 20 20 00
 4010 7E06 00 F8 08 30  		db	$00, $F8, $08, $30, $40, $80, $F8, $00
 4010 7E0A 40 80 F8 00
 4011 7E0E 00 38 20 20  		db	$00, $38, $20, $20, $20, $20, $38, $00
 4011 7E12 20 20 38 00
 4012 7E16 00 00 80 40  		db	$00, $00, $80, $40, $20, $10, $08, $00
 4012 7E1A 20 10 08 00
 4013 7E1E 00 70 10 10  		db	$00, $70, $10, $10, $10, $10, $70, $00
 4013 7E22 10 10 70 00
 4014 7E26 00 20 70 A8  		db	$00, $20, $70, $A8, $20, $20, $20, $00
 4014 7E2A 20 20 20 00
 4015 7E2E 00 00 00 00  		db	$00, $00, $00, $00, $00, $00, $00, $FC
 4015 7E32 00 00 00 FC
 4016 7E36 00 30 48 E0  		db	$00, $30, $48, $E0, $40, $40, $F8, $00
 4016 7E3A 40 40 F8 00
 4017 7E3E 00 00 70 08  		db	$00, $00, $70, $08, $78, $88, $78, $00
 4017 7E42 78 88 78 00
 4018 7E46 00 80 80 F0  		db	$00, $80, $80, $F0, $88, $88, $F0, $00
 4018 7E4A 88 88 F0 00
 4019 7E4E 00 00 38 40  		db	$00, $00, $38, $40, $40, $40, $38, $00
 4019 7E52 40 40 38 00
 4020 7E56 00 08 08 78  		db	$00, $08, $08, $78, $88, $88, $78, $00
 4020 7E5A 88 88 78 00
 4021 7E5E 00 00 70 88  		db	$00, $00, $70, $88, $F0, $80, $78, $00
 4021 7E62 F0 80 78 00
 4022 7E66 00 30 40 60  		db	$00, $30, $40, $60, $40, $40, $40, $00
 4022 7E6A 40 40 40 00
 4023 7E6E 00 00 78 88  		db	$00, $00, $78, $88, $88, $78, $08, $70
 4023 7E72 88 78 08 70
 4024 7E76 00 80 80 F0  		db	$00, $80, $80, $F0, $88, $88, $88, $00
 4024 7E7A 88 88 88 00
 4025 7E7E 00 20 00 60  		db	$00, $20, $00, $60, $20, $20, $70, $00
 4025 7E82 20 20 70 00
 4026 7E86 00 08 00 08  		db	$00, $08, $00, $08, $08, $08, $48, $30
 4026 7E8A 08 08 48 30
 4027 7E8E 00 40 50 60  		db	$00, $40, $50, $60, $60, $50, $48, $00
 4027 7E92 60 50 48 00
 4028 7E96 00 40 40 40  		db	$00, $40, $40, $40, $40, $40, $30, $00
 4028 7E9A 40 40 30 00
 4029 7E9E 00 00 D0 A8  		db	$00, $00, $D0, $A8, $A8, $A8, $A8, $00
 4029 7EA2 A8 A8 A8 00
 4030 7EA6 00 00 F0 88  		db	$00, $00, $F0, $88, $88, $88, $88, $00
 4030 7EAA 88 88 88 00
 4031 7EAE 00 00 70 88  		db	$00, $00, $70, $88, $88, $88, $70, $00
 4031 7EB2 88 88 70 00
 4032 7EB6 00 00 F0 88  		db	$00, $00, $F0, $88, $88, $F0, $80, $80
 4032 7EBA 88 F0 80 80
 4033 7EBE 00 00 78 88  		db	$00, $00, $78, $88, $88, $78, $08, $08
 4033 7EC2 88 78 08 08
 4034 7EC6 00 00 38 40  		db	$00, $00, $38, $40, $40, $40, $40, $00
 4034 7ECA 40 40 40 00
 4035 7ECE 00 00 70 80  		db	$00, $00, $70, $80, $70, $08, $F0, $00
 4035 7ED2 70 08 F0 00
 4036 7ED6 00 20 70 20  		db	$00, $20, $70, $20, $20, $20, $18, $00
 4036 7EDA 20 20 18 00
 4037 7EDE 00 00 88 88  		db	$00, $00, $88, $88, $88, $88, $70, $00
 4037 7EE2 88 88 70 00
 4038 7EE6 00 00 88 88  		db	$00, $00, $88, $88, $50, $50, $20, $00
 4038 7EEA 50 50 20 00
 4039 7EEE 00 00 88 A8  		db	$00, $00, $88, $A8, $A8, $A8, $50, $00
 4039 7EF2 A8 A8 50 00
 4040 7EF6 00 00 88 50  		db	$00, $00, $88, $50, $20, $50, $88, $00
 4040 7EFA 20 50 88 00
 4041 7EFE 00 00 88 88  		db	$00, $00, $88, $88, $88, $78, $08, $70
 4041 7F02 88 78 08 70
 4042 7F06 00 00 F8 10  		db	$00, $00, $F8, $10, $20, $40, $F8, $00
 4042 7F0A 20 40 F8 00
 4043 7F0E 00 38 20 C0  		db	$00, $38, $20, $C0, $20, $20, $38, $00
 4043 7F12 20 20 38 00
 4044 7F16 00 10 10 10  		db	$00, $10, $10, $10, $10, $10, $10, $00
 4044 7F1A 10 10 10 00
 4045 7F1E 00 E0 20 18  		db	$00, $E0, $20, $18, $20, $20, $E0, $00
 4045 7F22 20 20 E0 00
 4046 7F26 00 28 50 00  		db	$00, $28, $50, $00, $00, $00, $00, $00
 4046 7F2A 00 00 00 00
 4047 7F2E 00 78 84 B4  		db	$00, $78, $84, $B4, $B4, $84, $78, $00
 4047 7F32 B4 84 78 00
 4048 7F36
 4049 7F36 00 00        pos:		dw	0
 4050 7F38 00           roll:		db	0
 4051 7F39 00 00 00...  txtbuf:		ds	44
 4052 7F65
 4053 7F65              text:
 4054 7F65 4E 6F 77 20  		db	"Now playing: ",0
 4054 7F69 70 6C 61 79
 4054 7F6D 69 6E 67 3A
 4054 7F71 20 00
 4055 7F73 41 6C 6C 20  txtallfiles db "All files:",0
 4055 7F77 66 69 6C 65
 4055 7F7B 73 3A 00
 4056 7F7E 50 6F 73 69  txtcurrentfile db "Position:",0
 4056 7F82 74 69 6F 6E
 4056 7F86 3A 00
 4057 7F88
 4058 7F88              DOWNDATA equ $e000
 4059 7F88              UPDATA   equ DOWNDATA + 4*8*17
 4060 7F88              bufscr equ $e000
 4061 7F88              KKK
 4062 7F88
 4063 7F88              			org #9000
 4064 9000 00 00 00...  txtbuff    ds 100
 4065 9064
 4066 9064              			module key
 4067 9064
 4068 9064              check
 4069 9064              ahl0
 4070 9064 CD C7 74     		 call KEYSCAN
 4071 9067
 4072 9067 7B           		 ld   a,e
 4073 9068 3C                    inc  a
 4074 9069 C8                    ret z
 4075 906A 7A                    ld   a,d
 4076 906B 21 F8 74              ld   hl,SYMTAB
 4077 906E FE 18                 cp   $18
 4078 9070 28 0A                 jr   z,aHLSM2
 4079 9072 21 20 75              ld   hl,CAPSTAB
 4080 9075 FE 27                 cp   $27
 4081 9077 28 03                 jr   z,aHLSM2
 4082 9079 21 47 75              ld   hl,NORMTAB
 4083 907C 16 00        aHLSM2    ld   d,0
 4084 907E 19                    add  hl,de
 4085 907F 7E                    ld   a,(hl)
 4086 9080 B7                    or   a
 4087 9081 C8                    ret z
 4088 9082
 4089 9082 06 00        aLAST_KEY ld   b,0
 4090 9084 B8                    cp   b
 4091 9085 28 00                 jr   z,aSEDI_KEY
 4092 9087
 4093 9087              aSEDI_KEY
 4094 9087 32 83 90              ld   (aLAST_KEY+1),a
 4095 908A F5           		push af
 4096 908B              		;call beepk
 4097 908B F1           		pop af
 4098 908C C9           		ret
 4099 908D              			endmodule
 4100 908D
 4101 908D
 4102 908D              infosong
 4103 908D E5           			push hl
 4104 908E 21 00 90     			ld hl,txtbuff
 4105 9091 11 01 90     			ld de,txtbuff+1
 4106 9094 01 63 00     			ld bc,99
 4107 9097 3E 20        			ld a,32
 4108 9099 77           			ld (hl),a
 4109 909A ED B0        			ldir
 4110 909C E1           			pop hl
 4111 909D
 4112 909D 11 00 90     			ld de,txtbuff
 4113 90A0 06 5A        			ld b,90
 4114 90A2 7E           i1			ld a,(hl)
 4115 90A3 FE 20        			cp 32
 4116 90A5 D8           			ret c
 4117 90A6 FE 80        			cp 128
 4118 90A8 D0           			ret nc
 4119 90A9 12           			ld (de),a
 4120 90AA 13           			inc de
 4121 90AB 23           			inc hl
 4122 90AC 10 F4        			djnz i1
 4123 90AE C9           			ret
 4124 90AF
 4125 90AF 00           pocitadlo	defb 0
 4126 90B0 00           ACBhlas		defb 0
 4127 90B1
 4128 90B1 F3           STCPLAY	di
 4129 90B2
 4130 90B2 21 A0 50     			ld hl,20640
 4131 90B5 11 2B 66     			ld de,by1
 4132 90B8 06 18        			ld b,8*3
 4133 90BA D5           sappp        push de
 4134 90BB C5           			push bc
 4135 90BC E5           			push hl
 4136 90BD 06 20        			ld b,32
 4137 90BF 1A           sappp0		ld a,(de)
 4138 90C0 77           			ld (hl),a
 4139 90C1 23           			inc hl
 4140 90C2 10 FB        			djnz sappp0
 4141 90C4 E1           			pop hl
 4142 90C5 C1           			pop bc
 4143 90C6 D1           			pop de
 4144 90C7
 4145 90C7 CD 20 7C     			call downhl
 4146 90CA 13           			inc de
 4147 90CB 10 ED        			djnz sappp
 4148 90CD
 4149 90CD
 4150 90CD              			; ld de,18464+15
 4151 90CD              			; ld hl,txtcurrentfile
 4152 90CD              			; call print
 4153 90CD
 4154 90CD              			; ld de,18432+15
 4155 90CD              			; ld hl,txtallfiles
 4156 90CD              			; call print
 4157 90CD
 4158 90CD
 4159 90CD              		; ld hl,(apos_all)
 4160 90CD              		; inc hl
 4161 90CD              		; ld de,18464+15+11
 4162 90CD              		; ld (NUMPOS+1),de
 4163 90CD              		; call DEC16
 4164 90CD              		; defw 20*256
 4165 90CD
 4166 90CD              		; ld hl,(ALLFILES)
 4167 90CD              		; ld de,18432+15+11
 4168 90CD              		; ld (NUMPOS+1),de
 4169 90CD              		; call DEC16
 4170 90CD              		; defw 20*256
 4171 90CD 3E 00        		ld a,0
 4172 90CF 21 00 74     		ld hl,endsong
 4173 90D2 77           		ld (hl),a
 4174 90D3
 4175 90D3
 4176 90D3
 4177 90D3 21 2D BD     		ld hl,modstart + 7
 4178 90D6 CD 8D 90     		call infosong
 4179 90D9 21 00 90     		ld hl,txtbuff
 4180 90DC AF           		xor a
 4181 90DD 32 12 90     		ld (txtbuff+18),a
 4182 90E0 11 21 50             ld de,20512+1
 4183 90E3 CD 26 7B     		call print
 4184 90E6
 4185 90E6
 4186 90E6 CD E4 A4     		call	stc.music_init
 4187 90E9 FB           .sloop	ei
 4188 90EA 76           		halt
 4189 90EB
 4190 90EB E5           		push hl
 4191 90EC D5           		push de
 4192 90ED C5           		push bc
 4193 90EE
 4194 90EE 21 B0 90     		ld hl,ACBhlas
 4195 90F1 AF           		xor a
 4196 90F2 77           		ld (hl),a
 4197 90F3
 4198 90F3 21 A0 5A     		 ld   hl,23200;Vymazání
 4199 90F6 11 A1 5A              ld   de,23201;předešlého
 4200 90F9 01 60 00              ld   bc,96   ;zobrazení.
 4201 90FC 70                    ld   (hl),b
 4202 90FD ED B0                 ldir
 4203 90FF
 4204 90FF 3E 08                 ld   a,8     ;A teď nové
 4205 9101 21 B0 5A              ld   hl,23216;zobrazení.
 4206 9104 11 AF 5A              ld   de,23215;Kanál A.
 4207 9107 CD A8 98              call ATR
 4208 910A
 4209 910A 3E 0A                 ld   a,10    ;Kanál C.
 4210 910C 21 D0 5A              ld   hl,23248
 4211 910F 11 CF 5A              ld   de,23247
 4212 9112 CD A8 98              call ATR
 4213 9115
 4214 9115 3E 09                 ld   a,9     ;Kanál B.
 4215 9117 21 F0 5A              ld   hl,23280
 4216 911A 11 EF 5A              ld   de,23279
 4217 911D CD A8 98              call ATR
 4218 9120
 4219 9120
 4220 9120 3A B0 90     		 ld a,(ACBhlas)
 4221 9123 B7           		 or a
 4222 9124 28 07        		 jr z,.s1
 4223 9126 21 AF 90     		 ld hl,pocitadlo
 4224 9129 AF           		 xor a
 4225 912A 77           		 ld (hl),a
 4226 912B 18 04        		 jr .s2
 4227 912D 21 AF 90     .s1		 ld hl,pocitadlo
 4228 9130 34           		 inc (hl)
 4229 9131              .s2
 4230 9131
 4231 9131 CD E6 98     		call keysetup
 4232 9134 C1           		pop bc
 4233 9135 D1           		pop de
 4234 9136 E1           		pop hl
 4235 9137
 4236 9137 CD BC A5     		call	stc.music_play
 4237 913A AF           		xor a
 4238 913B 3A 77 9A             ld a,(klavesa)
 4239 913E FE 01                cp 1
 4240 9140 28 18        		jr z,sakoneca
 4241 9142 FE 20        		cp 32
 4242 9144 28 0E        		jr z,.s3
 4243 9146 3A AF 90     		ld a,(pocitadlo)
 4244 9149 EE 64        		xor 100
 4245 914B 28 07        		jr z,.s3
 4246 914D 3A 3E A2     		ld a,(music_setup)
 4247 9150 CB 7F        		bit 7,a
 4248 9152 28 95        		jr z,.sloop
 4249 9154
 4250 9154 3E 20        .s3		ld a,32
 4251 9156 21 00 74     		ld hl,endsong
 4252 9159 77           		ld (hl),a
 4253 915A F5           sakoneca	push af
 4254 915B
 4255 915B CD DA A1     		call music_mute
 4256 915E F1           		pop af
 4257 915F C3 BB 73     		jp navrat
 4258 9162
 4259 9162
 4260 9162
 4261 9162 F3           STPPLAY		di
 4262 9163
 4263 9163 21 A0 50     			ld hl,20640
 4264 9166 11 2B 66     			ld de,by1
 4265 9169 06 18        			ld b,8*3
 4266 916B D5           stappp        push de
 4267 916C C5           			push bc
 4268 916D E5           			push hl
 4269 916E 06 20        			ld b,32
 4270 9170 1A           stappp0		ld a,(de)
 4271 9171 77           			ld (hl),a
 4272 9172 23           			inc hl
 4273 9173 10 FB        			djnz stappp0
 4274 9175 E1           			pop hl
 4275 9176 C1           			pop bc
 4276 9177 D1           			pop de
 4277 9178
 4278 9178 CD 20 7C     			call downhl
 4279 917B 13           			inc de
 4280 917C 10 ED        			djnz stappp
 4281 917E
 4282 917E
 4283 917E              			; ld de,18464+15
 4284 917E              			; ld hl,txtcurrentfile
 4285 917E              			; call print
 4286 917E
 4287 917E              			; ld de,18432+15
 4288 917E              			; ld hl,txtallfiles
 4289 917E              			; call print
 4290 917E
 4291 917E
 4292 917E              		; ld hl,(apos_all)
 4293 917E              		; inc hl
 4294 917E              		; ld de,18464+15+11
 4295 917E              		; ld (NUMPOS+1),de
 4296 917E              		; call DEC16
 4297 917E              		; defw 20*256
 4298 917E
 4299 917E              		; ld hl,(ALLFILES)
 4300 917E              		; ld de,18432+15+11
 4301 917E              		; ld (NUMPOS+1),de
 4302 917E              		; call DEC16
 4303 917E              		; defw 20*256
 4304 917E 3E 00        		ld a,0
 4305 9180 21 00 74     		ld hl,endsong
 4306 9183 77           		ld (hl),a
 4307 9184
 4308 9184
 4309 9184
 4310 9184 21 4C BD     		ld hl,modstart + 11 + 27
 4311 9187 CD 8D 90     		call infosong
 4312 918A 21 00 90     		ld hl,txtbuff
 4313 918D AF           		xor a
 4314 918E 32 50 90     		ld (txtbuff+80),a
 4315 9191
 4316 9191 21 C0 73     		ld hl,tmp
 4317 9194 11 C1 73     		ld de,tmp+1
 4318 9197 AF           		xor a
 4319 9198 77           		ld (hl),a
 4320 9199 01 30 00     		ld bc,48
 4321 919C ED B0        		ldir
 4322 919E
 4323 919E 21 00 90     		ld hl,txtbuff
 4324 91A1 11 C0 73     		ld de,tmp
 4325 91A4 01 19 00     		ld bc,25
 4326 91A7 ED B0        		ldir
 4327 91A9 21 C0 73     		ld hl,tmp
 4328 91AC 11 21 50             ld de,20512+1
 4329 91AF CD 26 7B     		call print
 4330 91B2
 4331 91B2
 4332 91B2
 4333 91B2
 4334 91B2
 4335 91B2 CD 67 B5     		call	stp.music_init
 4336 91B5 FB           .astloop	ei
 4337 91B6 76           		halt
 4338 91B7
 4339 91B7 E5           		push hl
 4340 91B8 D5           		push de
 4341 91B9 C5           		push bc
 4342 91BA
 4343 91BA 21 B0 90     		ld hl,ACBhlas
 4344 91BD AF           		xor a
 4345 91BE 77           		ld (hl),a
 4346 91BF
 4347 91BF 21 A0 5A     		 ld   hl,23200;Vymazání
 4348 91C2 11 A1 5A              ld   de,23201;předešlého
 4349 91C5 01 60 00              ld   bc,96   ;zobrazení.
 4350 91C8 70                    ld   (hl),b
 4351 91C9 ED B0                 ldir
 4352 91CB
 4353 91CB 3E 08                 ld   a,8     ;A teď nové
 4354 91CD 21 B0 5A              ld   hl,23216;zobrazení.
 4355 91D0 11 AF 5A              ld   de,23215;Kanál A.
 4356 91D3 CD A8 98              call ATR
 4357 91D6
 4358 91D6 3E 0A                 ld   a,10    ;Kanál C.
 4359 91D8 21 D0 5A              ld   hl,23248
 4360 91DB 11 CF 5A              ld   de,23247
 4361 91DE CD A8 98              call ATR
 4362 91E1
 4363 91E1 3E 09                 ld   a,9     ;Kanál B.
 4364 91E3 21 F0 5A              ld   hl,23280
 4365 91E6 11 EF 5A              ld   de,23279
 4366 91E9 CD A8 98              call ATR
 4367 91EC CD E6 98      		 call keysetup
 4368 91EF
 4369 91EF 3A B0 90     		 ld a,(ACBhlas)
 4370 91F2 B7           		 or a
 4371 91F3 28 07        		 jr z,.st1
 4372 91F5 21 AF 90     		 ld hl,pocitadlo
 4373 91F8 AF           		 xor a
 4374 91F9 77           		 ld (hl),a
 4375 91FA 18 04        		 jr .st2
 4376 91FC 21 AF 90     .st1		 ld hl,pocitadlo
 4377 91FF 34           		 inc (hl)
 4378 9200              .st2
 4379 9200 C1           		pop bc
 4380 9201 D1           		pop de
 4381 9202 E1           		pop hl
 4382 9203
 4383 9203 CD 9E B6     		call	stp.music_play
 4384 9206 AF           		xor a
 4385 9207 3A 77 9A             ld a,(klavesa)
 4386 920A FE 01                cp	1
 4387 920C 28 18        		jr z,stakoneca
 4388 920E FE 20        		cp 32
 4389 9210 28 0E        		jr z,.st3
 4390 9212
 4391 9212 3A AF 90     		ld a,(pocitadlo)
 4392 9215 EE 64        		xor 100
 4393 9217 28 07        		jr z,.st3
 4394 9219 3A 3E A2     		ld a,(music_setup)
 4395 921C CB 7F        		bit 7,a
 4396 921E 28 95        		jr z,.astloop
 4397 9220
 4398 9220 3E 20        .st3		ld a,32
 4399 9222 21 00 74     		ld hl,endsong
 4400 9225 77           		ld (hl),a
 4401 9226 F5           stakoneca	push af
 4402 9227
 4403 9227 CD AF A6     		call stc.music_mute
 4404 922A F1           		pop af
 4405 922B C3 BB 73     		jp navrat
 4406 922E
 4407 922E
 4408 922E 53 51 20 54  sqt_txt	defb "SQ Tracker", 0
 4408 9232 72 61 63 6B
 4408 9236 65 72 00
 4409 9239 F3           SQTPLAY	di
 4410 923A
 4411 923A 21 A0 50     			ld hl,20640
 4412 923D 11 2B 66     			ld de,by1
 4413 9240 06 18        			ld b,8*3
 4414 9242 D5           appp        push de
 4415 9243 C5           			push bc
 4416 9244 E5           			push hl
 4417 9245 06 20        			ld b,32
 4418 9247 1A           appp0		ld a,(de)
 4419 9248 77           			ld (hl),a
 4420 9249 23           			inc hl
 4421 924A 10 FB        			djnz appp0
 4422 924C E1           			pop hl
 4423 924D C1           			pop bc
 4424 924E D1           			pop de
 4425 924F
 4426 924F CD 20 7C     			call downhl
 4427 9252 13           			inc de
 4428 9253 10 ED        			djnz appp
 4429 9255
 4430 9255
 4431 9255              			; ld de,18464+15
 4432 9255              			; ld hl,txtcurrentfile
 4433 9255              			; call print
 4434 9255
 4435 9255              			; ld de,18432+15
 4436 9255              			; ld hl,txtallfiles
 4437 9255              			; call print
 4438 9255
 4439 9255
 4440 9255              		; ld hl,(apos_all)
 4441 9255              		; inc hl
 4442 9255              		; ld de,18464+15+11
 4443 9255              		; ld (NUMPOS+1),de
 4444 9255              		; call DEC16
 4445 9255              		; defw 20*256
 4446 9255
 4447 9255              		; ld hl,(ALLFILES)
 4448 9255              		; ld de,18432+15+11
 4449 9255              		; ld (NUMPOS+1),de
 4450 9255              		; call DEC16
 4451 9255              		; defw 20*256
 4452 9255 3E 00        		ld a,0
 4453 9257 21 00 74     		ld hl,endsong
 4454 925A 77           		ld (hl),a
 4455 925B
 4456 925B 21 2E 92     		ld hl,sqt_txt
 4457 925E 11 21 50             ld de,20512+1
 4458 9261 CD 26 7B     		call print
 4459 9264
 4460 9264
 4461 9264 CD E1 92     		call	SQ_INIT
 4462 9267 FB           .loop	ei
 4463 9268 76           		halt
 4464 9269
 4465 9269 E5           		push hl
 4466 926A D5           		push de
 4467 926B C5           		push bc
 4468 926C 21 A0 5A     		 ld   hl,23200;Vymazání
 4469 926F 11 A1 5A              ld   de,23201;předešlého
 4470 9272 01 60 00              ld   bc,96   ;zobrazení.
 4471 9275 70                    ld   (hl),b
 4472 9276 ED B0                 ldir
 4473 9278
 4474 9278
 4475 9278 AF           		 xor a
 4476 9279 21 B0 90     		 ld hl,ACBhlas
 4477 927C 77           		 ld (hl),a
 4478 927D
 4479 927D 3E 08                 ld   a,8     ;A teď nové
 4480 927F 21 B0 5A              ld   hl,23216;zobrazení.
 4481 9282 11 AF 5A              ld   de,23215;Kanál A.
 4482 9285 CD A8 98              call ATR
 4483 9288
 4484 9288 3E 0A                 ld   a,10    ;Kanál C.
 4485 928A 21 D0 5A              ld   hl,23248
 4486 928D 11 CF 5A              ld   de,23247
 4487 9290 CD A8 98              call ATR
 4488 9293
 4489 9293 3E 09                 ld   a,9     ;Kanál B.
 4490 9295 21 F0 5A              ld   hl,23280
 4491 9298 11 EF 5A              ld   de,23279
 4492 929B CD A8 98              call ATR
 4493 929E
 4494 929E
 4495 929E 3A B0 90     		 ld a,(ACBhlas)
 4496 92A1 B7           		 or a
 4497 92A2 28 07        		 jr z,.as1
 4498 92A4 21 AF 90     		 ld hl,pocitadlo
 4499 92A7 AF           		 xor a
 4500 92A8 77           		 ld (hl),a
 4501 92A9 18 04        		 jr .as2
 4502 92AB 21 AF 90     .as1	 ld hl,pocitadlo
 4503 92AE 34           		 inc (hl)
 4504 92AF              .as2
 4505 92AF
 4506 92AF CD E6 98      		call keysetup
 4507 92B2 C1           		pop bc
 4508 92B3 D1           		pop de
 4509 92B4 E1           		pop hl
 4510 92B5
 4511 92B5 CD 44 93     		call	SQ_PLAY
 4512 92B8 AF           		xor a
 4513 92B9 3A 77 9A             ld a,(klavesa)
 4514 92BC FE 01        		cp 1
 4515 92BE 28 18        		jr z,akoneca
 4516 92C0 FE 20        		cp 32
 4517 92C2 28 0E        		jr z,.as3
 4518 92C4
 4519 92C4 3A AF 90     		ld a,(pocitadlo)
 4520 92C7 EE 64        		xor 100
 4521 92C9 28 07        		jr z,.as3
 4522 92CB 3A E0 92     		ld a,(SQ_STATUS)
 4523 92CE CB 7F        		bit 7,a
 4524 92D0 28 95        		jr z,.loop
 4525 92D2 3E 20        .as3	ld a,32
 4526 92D4 21 00 74     		ld hl,endsong
 4527 92D7 77           		ld (hl),a
 4528 92D8 F5           akoneca	push af
 4529 92D9
 4530 92D9 CD DA A1     		call music_mute
 4531 92DC F1           		pop af
 4532 92DD C3 BB 73     		jp navrat
 4533 92E0              		;jr	.loop
 4534 92E0
 4535 92E0
 4536 92E0              ; Povodny player generovany SQ-Linkerom doplneny o GLOBVOL,
 4537 92E0              ; tj. moznost globalneho utlmenia ~ © 2009 mborik/RM-TEAM.
 4538 92E0              ; Upravene na prehravanie SQT suborov, ktorym je potrebne
 4539 92E0              ; na zaciatku relokovat absolutne adresy, dalej bol doplneny
 4540 92E0              ; stavovy bajt podobny aky ma moj PT3 player, cize je mozne
 4541 92E0              ; song neopakovat, alebo fadeoutovat © 2020 mborik/SinDiKat.
 4542 92E0
 4543 92E0              ; Stavovy bajt prehravaca:
 4544 92E0              ; bit.0 nastav ak nechces ziaden looping
 4545 92E0              ; bit.1 nastav ak chces, aby nastal postupny fadeout po par sekundach
 4546 92E0              ; bit.7 sa nastavi vzdy, po odohrati vsetkych pozicii alebo po fadeoute
 4547 92E0              ; ...v jednoduchosti:	2 - fadeout after loop
 4548 92E0              ;			1 - no loop
 4549 92E0              ;			0 - loop forever
 4550 92E0 02           SQ_STATUS:	db	2
 4551 92E1
 4552 92E1              SQ_INIT:
 4553 92E1 ED 5B 28 BD  		ld	de,(RELOC_BASE)		; nacitame prvy offset, z ktoreho
 4554 92E5 21 30 BD     		ld	hl,BUFFER+10		; po odpocitani skutocnej adresy dat
 4555 92E8 AF           		xor	a			; bez 10 bajtov ziskavame offset,
 4556 92E9 ED 52        		sbc	hl,de			; ktorym musime relokovat vsetky
 4557 92EB E5           		push	hl			; absolutne ukazovatele v datach muziky
 4558 92EC ED 5B 32 BD  		ld	de,(RELOC_ENDPTR)
 4559 92F0 19           		add	hl,de
 4560 92F1 C1           		pop	bc
 4561 92F2 2B           RELOCATOR:	dec	hl
 4562 92F3 56           		ld	d,(hl)
 4563 92F4 2B           		dec	hl
 4564 92F5 5E           		ld	e,(hl)
 4565 92F6 EB           		ex	de,hl
 4566 92F7 09           		add	hl,bc
 4567 92F8 EB           		ex	de,hl
 4568 92F9 73           		ld	(hl),e
 4569 92FA 23           		inc	hl
 4570 92FB 72           		ld	(hl),d
 4571 92FC 2B           		dec	hl
 4572 92FD 7D           		ld	a,l
 4573 92FE D6 28        		sub	RELOC_BASE % 256
 4574 9300 20 F0        		jr	nz,RELOCATOR
 4575 9302 32 74 93      	    ld      (CHKFADEOUT+1),a
 4576 9305 32 A4 93             ld      (GLOBVOL+1),a
 4577 9308 3D           		dec	a
 4578 9309 32 65 94     		ld	(SQ_REST+1),a		; resetujem detektor konca skladby
 4579 930C 3E 02        		ld a,2
 4580 930E 32 E0 92     		ld (SQ_STATUS),a
 4581 9311 3E 08        		ld	a,8			; inicializacia prehravaca
 4582 9313 32 4F 98     		ld	(CHNZ1),a
 4583 9316 32 6C 98     		ld	(CHNZ2),a
 4584 9319 32 89 98     		ld	(CHNZ3),a
 4585 931C 01 01 01     		ld	bc,$0101
 4586 931F CD D2 94     		call	SQ_REND1
 4587 9322 2A 2E BD     CHN_INIT: 	ld	hl,(I_POSITIONS)
 4588 9325 DD 21 4F 98  		ld	ix,CHNZ1
 4589 9329 CD 10 94     		call	SQ_I9
 4590 932C CD 09 94     		call	SQ_I
 4591 932F CD 09 94     		call	SQ_I
 4592 9332 11 3F 07     SQ_STOP:	ld	de,#073F		; AY registre 7-12 nastav na uplne ticho
 4593 9335 CD E1 93     CHN_INILOOP:	call	OUT1
 4594 9338 1E 00        		ld	e,0
 4595 933A 14           		inc	d
 4596 933B 7A           		ld	a,d
 4597 933C FE 0C        		cp	12
 4598 933E 20 F5        		jr	nz,CHN_INILOOP
 4599 9340 C9           		ret
 4600 9341
 4601 9341 34           SQ_DEADEND:	inc	(hl)			; prehravanie skoncilo, SQ_PLAY je mrtve
 4602 9342 18 EE        		jr	SQ_STOP
 4603 9344
 4604 9344 21 A6 98     SQ_PLAY:	ld	hl,SQ_SYS
 4605 9347 35           		dec	(hl)
 4606 9348 20 29        		jr	nz,CHKFADEOUT
 4607 934A 36 00        SQ_PLAYSPEED:	ld	(hl),0
 4608 934C 23           		inc	hl
 4609 934D 35           		dec	(hl)
 4610 934E 7E           		ld	a,(hl)
 4611 934F B7           		or	a
 4612 9350 CC 64 94     		call	z,SQ_REST
 4613 9353 FE 04        		cp	4
 4614 9355 DC 09 94     		call	c,SQ_I
 4615 9358
 4616 9358 DD 21 4F 98  SQ_PP		ld	ix,CHNZ1
 4617 935C 0E 24        		ld	c,36
 4618 935E CD DC 94     		call	SQ_P
 4619 9361 DD 21 6C 98  		ld	ix,CHNZ2
 4620 9365 0E 12        		ld	c,18
 4621 9367 CD DC 94     		call	SQ_P
 4622 936A DD 21 89 98  		ld	ix,CHNZ3
 4623 936E 0E 09        		ld	c,9
 4624 9370 CD DC 94     		call	SQ_P
 4625 9373
 4626 9373 3E 00        CHKFADEOUT:	ld	a,0			; kontrola, ci fadeoutujeme
 4627 9375 B7           		or	a
 4628 9376 28 48        		jr	z,SQ_C
 4629 9378 3A E0 92     		ld	a,(SQ_STATUS)
 4630 937B CB 7F        		bit	7,a
 4631 937D 20 C2        		jr	nz,SQ_DEADEND
 4632 937F
 4633 937F 3E 00        COUNTFADEOUT:	ld	a,0
 4634 9381 3D           		dec	a
 4635 9382 32 80 93     		ld	(COUNTFADEOUT+1),a
 4636 9385 20 1C        		jr	nz,GLOBVOL
 4637 9387 3A A4 93     		ld	a,(GLOBVOL+1)
 4638 938A 3C           		inc	a
 4639 938B FE 10        		cp	16
 4640 938D 28 5C        		jr	z,RESETFADEOUT
 4641 938F 32 A4 93     		ld	(GLOBVOL+1),a
 4642 9392 3E 00        DIVFADEOUT:	ld	a,0
 4643 9394 CB 3F        		srl	a
 4644 9396 6F           		ld	l,a
 4645 9397 CB 3D        		srl	l
 4646 9399 85           		add	a,l
 4647 939A 20 01        		jr	nz,DIVFADEOUT1
 4648 939C 3C           		inc	a
 4649 939D 32 80 93     DIVFADEOUT1:	ld	(COUNTFADEOUT+1),a
 4650 93A0 32 93 93     		ld	(DIVFADEOUT+1),a
 4651 93A3
 4652 93A3 3E 00        GLOBVOL:	ld	a,0			; global attenuation
 4653 93A5 32 5A 98     		ld	(CHNZ1+11),a		; pre vsetky kanaly
 4654 93A8 32 77 98     		ld	(CHNZ2+11),a
 4655 93AB 32 94 98     		ld	(CHNZ3+11),a
 4656 93AE CB 5F        		bit	3,a			; dosiahla hodnota attenuation
 4657 93B0 28 0E        		jr	z,SQ_C			; cislo vacsie ako 8?
 4658 93B2 21 4F 98     		ld	hl,CHNZ1		; tak je nutne upravit sq-flagy,
 4659 93B5 11 1D 00     		ld	de,CHZL 		; aby sa prestali prehravat hw obalky
 4660 93B8 0E 03        		ld	c,3			; vo vsetkych troch kanaloch
 4661 93BA CB 86        GLOBVOL1:	res	0,(hl)			; vynulovanim nulteho bytu
 4662 93BC 19           		add	hl,de
 4663 93BD 0D           		dec	c
 4664 93BE 20 FA        		jr	nz,GLOBVOL1
 4665 93C0
 4666 93C0 AF           SQ_C:		xor	a			; vynuluje mixer register
 4667 93C1 6F           		ld	l,a
 4668 93C2 67           		ld	h,a
 4669 93C3 22 D4 93     		ld	(SQ_N+1),hl
 4670 93C6 DD 21 4F 98  		ld	ix,CHNZ1		; postupne prechadza kanalmi
 4671 93CA CD A6 96     		call	SQ_R
 4672 93CD CD A6 96     		call	SQ_R
 4673 93D0 CD A6 96     		call	SQ_R
 4674 93D3
 4675 93D3 01 00 00     SQ_N:		ld	bc,0			; nastavenie mixer registra
 4676 93D6 78           		ld	a,b			; B = sumove generatory pre ABC
 4677 93D7 17           		rla				; C = tonove generatory pre ABC
 4678 93D8 17           		rla
 4679 93D9 17           		rla
 4680 93DA B1           		or	c
 4681 93DB 2F           		cpl				; potom sa bity komplementuju
 4682 93DC F6 00        SQ_OFF: 	or	0
 4683 93DE 5F           		ld	e,a
 4684 93DF 16 07        		ld	d,7			; a posielaju na register 7 AY
 4685 93E1 01 FD FF     OUT1:		ld	bc,$FFFD
 4686 93E4 ED 51        		out	(c),d
 4687 93E6 06 BF        		ld	b,$BF
 4688 93E8 ED 59        		out	(c),e
 4689 93EA C9           		ret
 4690 93EB
 4691 93EB 21 FF FF     RESETFADEOUT:	ld	hl,-1
 4692 93EE 22 A6 98     		ld	(SQ_SYS),hl
 4693 93F1 21 E0 92     		ld	hl,SQ_STATUS
 4694 93F4 CB FE        		set	7,(hl)
 4695 93F6 AF           		xor	a
 4696 93F7 01           		db	1 ; ld bc,NN namiesto ld a,N
 4697 93F8
 4698 93F8 3E 30        ENABLEFADE:	ld	a,48
 4699 93FA 21 74 93     FORCEFADE:	ld	hl,CHKFADEOUT+1
 4700 93FD 34           		inc	(hl)
 4701 93FE 32 80 93     		ld	(COUNTFADEOUT+1),a
 4702 9401 32 93 93     		ld	(DIVFADEOUT+1),a
 4703 9404 2F           		cpl
 4704 9405 32 65 94     		ld	(SQ_REST+1),a
 4705 9408 C9           		ret
 4706 9409
 4707 9409 21 00 00     SQ_I:		ld	hl,0
 4708 940C DD 21 4F 98  SQ_I1:		ld	ix,CHNZ1
 4709 9410 7E           SQ_I9:		ld	a,(hl)
 4710 9411 B7           		or	a
 4711 9412 20 06        		jr	nz,SQ_I3
 4712 9414 32 65 94     		ld	(SQ_REST+1),a		; oznac, ze pri najblizsom patterne
 4713 9417 2A 30 BD     		ld	hl,(I_REPEAT)		; budeme testovat fadeout alebo noloop
 4714 941A 46           SQ_I3:		ld	b,(hl)
 4715 941B CB 10        		rl	b
 4716 941D DD CB 00 AE  		res	5,(ix+0)
 4717 9421 30 04        		jr	nc,SQ_I4
 4718 9423 DD CB 00 EE  		set	5,(ix+0)
 4719 9427 23           SQ_I4:		inc	hl
 4720 9428 7E           		ld	a,(hl)
 4721 9429 E6 0F        		and	15
 4722 942B DD 77 1A     		ld	(ix+26),a
 4723 942E 7E           		ld	a,(hl)
 4724 942F E6 F0        		and	240
 4725 9431 1F           		rra
 4726 9432 1F           		rra
 4727 9433 1F           		rra
 4728 9434 1F           		rra
 4729 9435 FE 09        		cp	9
 4730 9437 38 03        		jr	c,ZBR
 4731 9439 D6 09        		sub	9
 4732 943B 2F           		cpl
 4733 943C DD 77 18     ZBR:		ld	(ix+24),a
 4734 943F 23           		inc	hl
 4735 9440 22 0A 94     		ld	(SQ_I+1),hl
 4736 9443 68           		ld	l,b
 4737 9444 26 00        		ld	h,0
 4738 9446 ED 5B 2C BD  		ld	de,(I_PATTERNS)
 4739 944A 19           		add	hl,de
 4740 944B 5E           		ld	e,(hl)
 4741 944C 23           		inc	hl
 4742 944D 56           		ld	d,(hl)
 4743 944E 13           		inc	de
 4744 944F DD 73 16     		ld	(ix+22),e
 4745 9452 DD 72 17     		ld	(ix+23),d
 4746 9455 11 1D 00     		ld	de,CHZL
 4747 9458 DD 19        		add	ix,de
 4748 945A DD 22 0E 94  		ld	(SQ_I1+2),ix
 4749 945E C9           		ret
 4750 945F
 4751 945F CD EB 93     SQ_NOFADE:	call	RESETFADEOUT
 4752 9462 F1           		pop	af
 4753 9463 C9           		ret
 4754 9464
 4755 9464 3E FF        SQ_REST:	ld	a,-1
 4756 9466 B7           		or	a
 4757 9467 20 0C        		jr	nz,SQ_REST0
 4758 9469 3A E0 92     		ld	a,(SQ_STATUS)
 4759 946C 0F           		rrca			; bit 0. nastaveny = koniec
 4760 946D 38 F0        		jr	c,SQ_NOFADE
 4761 946F 0F           		rrca			; bit 1. nastaveny = fadeout
 4762 9470 30 03        		jr	nc,SQ_REST0
 4763 9472 CD F8 93     		call	ENABLEFADE
 4764 9475 3A 69 98     SQ_REST0:	ld	a,(CHNZ1+26)
 4765 9478 32 5A 98     		ld	(CHNZ1+11),a
 4766 947B 3A 86 98     		ld	a,(CHNZ2+26)
 4767 947E 32 77 98     		ld	(CHNZ2+11),a
 4768 9481 3A A3 98     		ld	a,(CHNZ3+26)
 4769 9484 32 94 98     		ld	(CHNZ3+11),a
 4770 9487 2A 65 98     		ld	hl,(CHNZ1+22)
 4771 948A 2B           		dec	hl
 4772 948B 46           		ld	b,(hl)
 4773 948C 23           		inc	hl
 4774 948D 22 61 98     		ld	(CHNZ1+18),hl
 4775 9490 2A 82 98     		ld	hl,(CHNZ2+22)
 4776 9493 22 7E 98     		ld	(CHNZ2+18),hl
 4777 9496 2A 9F 98     		ld	hl,(CHNZ3+22)
 4778 9499 22 9B 98     		ld	(CHNZ3+18),hl
 4779 949C 2A 67 98     		ld	hl,(CHNZ1+24)
 4780 949F 22 63 98     		ld	(CHNZ1+20),hl
 4781 94A2 2A 84 98     		ld	hl,(CHNZ2+24)
 4782 94A5 22 80 98     		ld	(CHNZ2+20),hl
 4783 94A8 2A A1 98     		ld	hl,(CHNZ3+24)
 4784 94AB 22 9D 98     		ld	(CHNZ3+20),hl
 4785 94AE 2A 0A 94     		ld	hl,(SQ_I+1)
 4786 94B1 4E           		ld	c,(hl)
 4787 94B2 23           		inc	hl
 4788 94B3 22 0A 94     		ld	(SQ_I+1),hl
 4789 94B6 21 4F 98     		ld	hl,CHNZ1
 4790 94B9 22 0E 94     		ld	(SQ_I1+2),hl
 4791 94BC 3E 03        		ld	a,3
 4792 94BE 16 00        		ld	d,0
 4793 94C0 CB A6        SQ_REST1:	res	4,(hl)
 4794 94C2 CB 6E        		bit	5,(hl)
 4795 94C4 28 02        		jr	z,SQ_REST2
 4796 94C6 CB E6        		set	4,(hl)
 4797 94C8 1E 15        SQ_REST2:	ld	e,21
 4798 94CA 19           		add	hl,de
 4799 94CB 72           		ld	(hl),d
 4800 94CC 1E 08        		ld	e,CHZL-21
 4801 94CE 19           		add	hl,de
 4802 94CF 3D           		dec	a
 4803 94D0 20 EE        		jr	nz,SQ_REST1
 4804 94D2 ED 43 A6 98  SQ_REND1:	ld	(SQ_SYS),bc
 4805 94D6 79           		ld	a,c
 4806 94D7 32 4B 93     SQ_REND2:	ld	(SQ_PLAYSPEED+1),a
 4807 94DA 78           		ld	a,b
 4808 94DB C9           		ret
 4809 94DC
 4810 94DC DD 7E 15     SQ_P:		ld	a,(ix+21)
 4811 94DF B7           		or	a
 4812 94E0 28 0A        		jr	z,Y01
 4813 94E2 DD 35 15     		dec	(ix+21)
 4814 94E5 DD CB 00 7E  		bit	7,(ix+0)
 4815 94E9 20 3E        		jr	nz,Y33
 4816 94EB C9           		ret
 4817 94EC
 4818 94EC DD 5E 12     Y01:		ld	e,(ix+18)
 4819 94EF DD 56 13     		ld	d,(ix+19)
 4820 94F2 DD CB 00 F6  		set	6,(ix+0)
 4821 94F6 DD CB 00 BE  		res	7,(ix+0)
 4822 94FA 1A           		ld	a,(de)
 4823 94FB 13           		inc	de
 4824 94FC CB 7F        		bit	7,a
 4825 94FE 28 4D        		jr	z,Y02
 4826 9500
 4827 9500 DD 73 12     Y05:		ld	(ix+18),e
 4828 9503 DD 72 13     		ld	(ix+19),d
 4829 9506 47           		ld	b,a
 4830 9507 CB 77        		bit	6,a
 4831 9509 28 0C        		jr	z,Y60
 4832 950B
 4833 950B 1B           		dec	de
 4834 950C DD 73 1B     		ld	(ix+27),e
 4835 950F DD 72 1C     		ld	(ix+28),d
 4836 9512 E6 1F        Y34:		and	31
 4837 9514 C3 40 96     		jp	SQ_SMP
 4838 9517
 4839 9517 CB 6F        Y60:		bit	5,a
 4840 9519 20 21        		jr	nz,Y06
 4841 951B
 4842 951B E6 0F        		and	15
 4843 951D CB 60        		bit	4,b
 4844 951F 28 02        		jr	z,Y07
 4845 9521 ED 44        		neg
 4846 9523 DD 86 0C     Y07:		add	a,(ix+12)
 4847 9526 DD 77 0C     		ld	(ix+12),a
 4848 9529 DD 5E 1B     Y33:		ld	e,(ix+27)
 4849 952C DD 56 1C     		ld	d,(ix+28)
 4850 952F DD CB 00 B6  		res	6,(ix+0)
 4851 9533 1A           		ld	a,(de)
 4852 9534 CB 7F        		bit	7,a
 4853 9536 20 DA        		jr	nz,Y34
 4854 9538 13           		inc	de
 4855 9539 C3 1B 96     		jp	SMP_ORN
 4856 953C
 4857 953C E6 0F        Y06:		and	15
 4858 953E DD 77 15     		ld	(ix+21),a
 4859 9541 CB 60        		bit	4,b
 4860 9543 C8           		ret	z
 4861 9544 B7           		or	a
 4862 9545 28 E2        		jr	z,Y33
 4863 9547 DD CB 00 FE  		set	7,(ix+0)
 4864 954B 18 DC        		jr	Y33
 4865 954D
 4866 954D FE 60        Y02:		cp	96
 4867 954F DA 01 96     		jp	c,Y03
 4868 9552 D6 60        		sub	96
 4869 9554 FE 0F        		cp	15
 4870 9556 38 11        		jr	c,Y04
 4871 9558
 4872 9558 21 DD 93     		ld	hl,SQ_OFF+1
 4873 955B 47           		ld	b,a
 4874 955C 7E           		ld	a,(hl)
 4875 955D B1           		or	c
 4876 955E 77           		ld	(hl),a
 4877 955F DD CB 00 DE  		set	3,(ix+0)
 4878 9563 78           		ld	a,b
 4879 9564 D6 0F        		sub	15
 4880 9566 CA 14 96     		jp	z,Z26
 4881 9569
 4882 9569 3D           Y04:		dec	a
 4883 956A EB           		ex	de,hl
 4884 956B 4E           		ld	c,(hl)
 4885 956C 23           		inc	hl
 4886 956D DD CB 00 76  		bit	6,(ix+0)
 4887 9571 28 0A        		jr	z,Y69
 4888 9573 DD 75 12     		ld	(ix+18),l
 4889 9576 DD 74 13     		ld	(ix+19),h
 4890 9579 DD CB 00 B6  		res	6,(ix+0)
 4891 957D FE 08        Y69:		cp	8
 4892 957F 38 11        		jr	c,Z38
 4893 9581 DD CB 00 C6  		set	0,(ix+0)
 4894 9585 69           		ld	l,c
 4895 9586 5F           		ld	e,a
 4896 9587 16 0D        		ld	d,13
 4897 9589 CD E1 93     		call	OUT1
 4898 958C 16 0B        		ld	d,11
 4899 958E 5D           		ld	e,l
 4900 958F C3 E1 93     		jp	OUT1
 4901 9592
 4902 9592 FE 06        Z38:		cp	6			; channel volume set
 4903 9594 30 4F        		jr	nc,Z36
 4904 9596 DD CB 00 66  		bit	4,(ix+0)
 4905 959A C8           		ret	z
 4906 959B B7           		or	a
 4907 959C 20 07        		jr	nz,Z31
 4908 959E 79           		ld	a,c
 4909 959F E6 0F        SQ_V:		and	15
 4910 95A1 DD 77 0B     		ld	(ix+11),a
 4911 95A4 C9           		ret
 4912 95A5
 4913 95A5 3D           Z31:		dec	a			; channel volume slide
 4914 95A6 20 06        		jr	nz,Z32
 4915 95A8 79           		ld	a,c
 4916 95A9 DD 86 0B     		add	a,(ix+11)
 4917 95AC 18 F1        		jr	SQ_V
 4918 95AE
 4919 95AE 3D           Z32:		dec	a			; global volume set
 4920 95AF 20 0B        		jr	nz,Z33
 4921 95B1 79           		ld	a,c
 4922 95B2 32 5A 98     		ld	(CHNZ1+11),a
 4923 95B5 32 77 98     		ld	(CHNZ2+11),a
 4924 95B8 32 94 98     		ld	(CHNZ3+11),a
 4925 95BB C9           		ret
 4926 95BC
 4927 95BC 3D           Z33:		dec	a			; global volume slide
 4928 95BD 20 11        		jr	nz,Z34
 4929 95BF 06 03        		ld	b,3
 4930 95C1 11 1D 00     		ld	de,CHZL
 4931 95C4 21 5A 98     		ld	hl,CHNZ1+11
 4932 95C7 7E           Z33_2:		ld	a,(hl)
 4933 95C8 81           		add	a,c
 4934 95C9 E6 0F        		and	15
 4935 95CB 77           		ld	(hl),a
 4936 95CC 19           		add	hl,de
 4937 95CD 10 F8        		djnz	Z33_2
 4938 95CF C9           		ret
 4939 95D0
 4940 95D0 21 A6 98     Z34:		ld	hl,SQ_SYS		; speed set
 4941 95D3 3D           		dec	a
 4942 95D4 20 0B        		jr	nz,Z35
 4943 95D6 79           		ld	a,c
 4944 95D7 E6 1F        SQ_S:		and	31
 4945 95D9 20 02        		jr	nz,SQ_Z
 4946 95DB 3E 20        		ld	a,32
 4947 95DD 77           SQ_Z:		ld	(hl),a
 4948 95DE C3 D7 94     		jp	SQ_REND2
 4949 95E1
 4950 95E1 7E           Z35:		ld	a,(hl)			; speed slide
 4951 95E2 81           		add	a,c
 4952 95E3 18 F2        		jr	SQ_S
 4953 95E5
 4954 95E5 D6 06        Z36:		sub	6
 4955 95E7 06 00        		ld	b,0
 4956 95E9 79           		ld	a,c
 4957 95EA 48           		ld	c,b
 4958 95EB 20 03        		jr	nz,Z37
 4959 95ED 05           		dec	b
 4960 95EE ED 44        		neg
 4961 95F0 DD CB 00 D6  Z37:		set	2,(ix+0)
 4962 95F4 DD 71 0D     		ld	(ix+13),c
 4963 95F7 DD 71 0E     		ld	(ix+14),c
 4964 95FA DD 77 0F     		ld	(ix+15),a
 4965 95FD DD 70 10     		ld	(ix+16),b
 4966 9600 C9           		ret
 4967 9601
 4968 9601 DD 77 0C     Y03:		ld	(ix+12),a
 4969 9604 1B           		dec	de
 4970 9605 DD 73 1B     		ld	(ix+27),e
 4971 9608 DD 72 1C     		ld	(ix+28),d
 4972 960B 13           		inc	de
 4973 960C CD 1B 96     		call	SMP_ORN
 4974 960F DD CB 00 76  		bit	6,(ix+0)
 4975 9613 C8           		ret	z
 4976 9614 DD 73 12     Z26:		ld	(ix+18),e
 4977 9617 DD 72 13     		ld	(ix+19),d
 4978 961A C9           		ret
 4979 961B
 4980 961B 1A           SMP_ORN:	ld	a,(de)
 4981 961C 13           		inc	de
 4982 961D CB 7F        		bit	7,a
 4983 961F 28 1C        		jr	z,SMP_ORN9
 4984 9621 47           		ld	b,a
 4985 9622 1F           		rra
 4986 9623 E6 1F        		and	31
 4987 9625 C4 40 96     		call	nz,SQ_SMP
 4988 9628 CB 70        		bit	6,b
 4989 962A C8           		ret	z
 4990 962B 1A           		ld	a,(de)
 4991 962C E6 F0        		and	240
 4992 962E CB 18        		rr	b
 4993 9630 1F           		rra
 4994 9631 1F           		rra
 4995 9632 1F           		rra
 4996 9633 CB 3F        		srl	a
 4997 9635 C4 71 96     		call	nz,SQ_ORN
 4998 9638 1A           		ld	a,(de)
 4999 9639 13           		inc	de
 5000 963A E6 0F        		and	15
 5001 963C C8           		ret	z
 5002 963D C3 69 95     SMP_ORN9:	jp	Y04
 5003 9640
 5004 9640 C5           SQ_SMP: 	push	bc
 5005 9641 87           		add	a,a
 5006 9642 4F           		ld	c,a
 5007 9643 06 00        		ld	b,0
 5008 9645 DD 7E 00     		ld	a,(ix+0)
 5009 9648 E6 F0        		and	%11110000
 5010 964A DD 77 00     		ld	(ix+0),a
 5011 964D 2A 28 BD     		ld	hl,(I_SAMPLES)
 5012 9650 09           		add	hl,bc
 5013 9651 4E           		ld	c,(hl)
 5014 9652 23           		inc	hl
 5015 9653 46           		ld	b,(hl)
 5016 9654 DD E5        		push	ix
 5017 9656 E1           		pop	hl
 5018 9657 23           		inc	hl
 5019 9658 71           		ld	(hl),c
 5020 9659 23           		inc	hl
 5021 965A 70           		ld	(hl),b
 5022 965B 03           		inc	bc
 5023 965C 03           		inc	bc
 5024 965D 23           		inc	hl
 5025 965E 71           		ld	(hl),c
 5026 965F 23           		inc	hl
 5027 9660 70           		ld	(hl),b
 5028 9661 23           		inc	hl
 5029 9662 36 20        		ld	(hl),32
 5030 9664 23           		inc	hl
 5031 9665 22 7D 96     		ld	(SQ_NXT+1),hl
 5032 9668 C1           		pop	bc
 5033 9669 21 DD 93     		ld	hl,SQ_OFF+1
 5034 966C 7E           		ld	a,(hl)
 5035 966D B1           		or	c
 5036 966E A9           		xor	c
 5037 966F 77           		ld	(hl),a
 5038 9670 C9           		ret
 5039 9671
 5040 9671 87           SQ_ORN: 	add	a,a
 5041 9672 4F           		ld	c,a
 5042 9673 06 00        		ld	b,0
 5043 9675 2A 2A BD     		ld	hl,(I_ORNAMENTS)
 5044 9678 09           		add	hl,bc
 5045 9679 4E           		ld	c,(hl)
 5046 967A 23           		inc	hl
 5047 967B 46           		ld	b,(hl)
 5048 967C 21 00 00     SQ_NXT: 	ld	hl,0
 5049 967F 71           		ld	(hl),c
 5050 9680 23           		inc	hl
 5051 9681 70           		ld	(hl),b
 5052 9682 23           		inc	hl
 5053 9683 03           		inc	bc
 5054 9684 03           		inc	bc
 5055 9685 71           		ld	(hl),c
 5056 9686 23           		inc	hl
 5057 9687 70           		ld	(hl),b
 5058 9688 23           		inc	hl
 5059 9689 36 20        		ld	(hl),32
 5060 968B DD CB 00 CE  		set	1,(ix+0)
 5061 968F C9           		ret
 5062 9690
 5063 9690 21 D4 93     OUT2:		ld	hl,SQ_N+1		; podla carry nastavi v SQ_N
 5064 9693 CB 16        		rl	(hl)			; tonovy generator, sumovy off
 5065 9695 23           		inc	hl			; potom vytiahne cislo kanalu
 5066 9696 CB 16        		rl	(hl)
 5067 9698 DD 7E 11     		ld	a,(ix+17)
 5068 969B C6 08        		add	a,8			; pripocita k nemu 8
 5069 969D ED 79        		out	(c),a			; tj. volume registre AY
 5070 969F 06 BF        		ld	b,$BF
 5071 96A1 ED 59        		out	(c),e			; a posle hodnotu v E
 5072 96A3 C3 BC 97     		jp	SQ_ZCH
 5073 96A6
 5074 96A6 DD 6E 03     SQ_R:		ld	l,(ix+3)
 5075 96A9 DD 66 04     		ld	h,(ix+4)
 5076 96AC 01 FD FF     		ld	bc,$FFFD
 5077 96AF DD 56 00     		ld	d,(ix+0)
 5078 96B2 1E 00        		ld	e,0
 5079 96B4 CB 5A        		bit	3,d			; ak sa nema nic hrat, umlcat
 5080 96B6 20 D8        		jr	nz,OUT2
 5081 96B8 7E           		ld	a,(hl)
 5082 96B9 E6 0F        		and	15
 5083 96BB C2 C7 96     		jp	nz,SQ_R1
 5084 96BE CB 42        		bit	0,d			; ak sa ma hrat obalka, nastav
 5085 96C0 28 0B        		jr	z,SQ_R2
 5086 96C2 1E 10        		ld	e,16
 5087 96C4 C3 CD 96     		jp	SQ_R2
 5088 96C7
 5089 96C7 DD 96 0B     SQ_R1:		sub	(ix+11) 		; od hlasitosti z sa odpocita
 5090 96CA 38 01        		jr	c,SQ_R2 		; global volume nastavenie
 5091 96CC 5F           		ld	e,a
 5092 96CD
 5093 96CD DD 7E 11     SQ_R2:		ld	a,(ix+17)		; vytiahne sa cislo kanalu
 5094 96D0 C6 08        		add	a,8			; pripocita sa 8 cim sa dostnem
 5095 96D2 ED 79        		out	(c),a			; na registre hlasitosi AY
 5096 96D4 06 BF        		ld	b,$BF
 5097 96D6 ED 59        		out	(c),e
 5098 96D8 7E           		ld	a,(hl)
 5099 96D9 23           		inc	hl
 5100 96DA E6 F0        		and	240			; vytiahujem sumove data
 5101 96DC 1F           		rra
 5102 96DD 1F           		rra
 5103 96DE 1F           		rra
 5104 96DF 16 06        		ld	d,6
 5105 96E1 5E           		ld	e,(hl)
 5106 96E2 CB 13        		rl	e
 5107 96E4 CB 6E        		bit	5,(hl)			; zistujem, ci budeme sumiet
 5108 96E6 28 0A        		jr	z,SQ_ZNN
 5109 96E8 CE 00        		adc	a,0
 5110 96EA 06 FF        		ld	b,$FF
 5111 96EC ED 51        		out	(c),d
 5112 96EE 06 BF        		ld	b,$BF
 5113 96F0 ED 79        		out	(c),a
 5114 96F2 7B           SQ_ZNN:		ld	a,e
 5115 96F3 17           		rla
 5116 96F4 EB           		ex	de,hl
 5117 96F5 21 D4 93     		ld	hl,SQ_N+1		; nastavime v SQ_N stavy oboch
 5118 96F8 CB 16        		rl	(hl)			; generatorov (sum/ton) pre ch.
 5119 96FA 23           		inc	hl
 5120 96FB 17           		rla
 5121 96FC CB 16        		rl	(hl)
 5122 96FE EB           		ex	de,hl
 5123 96FF 7E           		ld	a,(hl)			; vypocitavanie frekvencie...
 5124 9700 E6 1F        		and	31
 5125 9702 57           		ld	d,a
 5126 9703 23           		inc	hl
 5127 9704 5E           		ld	e,(hl)
 5128 9705 23           		inc	hl
 5129 9706 D5           		push	de
 5130 9707 16 00        		ld	d,0
 5131 9709 DD 35 05     		dec	(ix+5)
 5132 970C C2 2D 97     		jp	nz,FQ_2
 5133 970F DD 6E 01     		ld	l,(ix+1)
 5134 9712 DD 66 02     		ld	h,(ix+2)
 5135 9715 7E           		ld	a,(hl)
 5136 9716 23           		inc	hl
 5137 9717 FE 20        		cp	32
 5138 9719 4E           		ld	c,(hl)
 5139 971A 23           		inc	hl
 5140 971B 20 08        		jr	nz,FQ_1
 5141 971D DD CB 00 DE  		set	3,(ix+0)
 5142 9721 DD CB 00 8E  		res	1,(ix+0)
 5143 9725 47           FQ_1:		ld	b,a
 5144 9726 87           		add	a,a
 5145 9727 80           		add	a,b
 5146 9728 5F           		ld	e,a
 5147 9729 19           		add	hl,de
 5148 972A DD 71 05     		ld	(ix+5),c
 5149 972D DD 75 03     FQ_2:		ld	(ix+3),l
 5150 9730 DD 74 04     		ld	(ix+4),h
 5151 9733 DD 7E 0C     		ld	a,(ix+12)
 5152 9736 DD CB 00 4E  		bit	1,(ix+0)
 5153 973A 28 2A        		jr	z,FQ_5
 5154 973C DD 6E 08     		ld	l,(ix+8)
 5155 973F DD 66 09     		ld	h,(ix+9)
 5156 9742 86           		add	a,(hl)
 5157 9743 23           		inc	hl
 5158 9744 DD 35 0A     		dec	(ix+10)
 5159 9747 C2 60 97     		jp	nz,FQ_4
 5160 974A 08           		ex	af,af'
 5161 974B DD 6E 06     		ld	l,(ix+6)
 5162 974E DD 66 07     		ld	h,(ix+7)
 5163 9751 7E           		ld	a,(hl)
 5164 9752 23           		inc	hl
 5165 9753 FE 20        		cp	32
 5166 9755 58           		ld	e,b
 5167 9756 28 02        		jr	z,FQ_3
 5168 9758 4E           		ld	c,(hl)
 5169 9759 5F           		ld	e,a
 5170 975A 23           FQ_3:		inc	hl
 5171 975B 19           		add	hl,de
 5172 975C DD 71 0A     		ld	(ix+10),c
 5173 975F 08           		ex	af,af'
 5174 9760 DD 75 08     FQ_4:		ld	(ix+8),l
 5175 9763 DD 74 09     		ld	(ix+9),h
 5176 9766 DD 86 14     FQ_5:		add	a,(ix+20)
 5177 9769 FE 2D        		cp	45
 5178 976B 30 0B        		jr	nc,FQ_6
 5179 976D 87           		add	a,a
 5180 976E 5F           		ld	e,a
 5181 976F 21 C2 97     		ld	hl,FRQ2
 5182 9772 19           		add	hl,de
 5183 9773 56           		ld	d,(hl)
 5184 9774 23           		inc	hl
 5185 9775 C3 7D 97     		jp	FQ_7
 5186 9778
 5187 9778 21 EF 97     FQ_6:		ld	hl,FRQ1-45
 5188 977B 5F           		ld	e,a
 5189 977C 19           		add	hl,de
 5190 977D 5E           FQ_7:		ld	e,(hl)
 5191 977E EB           		ex	de,hl
 5192 977F D1           		pop	de			; ...frekvenciu mame,
 5193 9780 CB 62        		bit	4,d			; bude este fine-tuning?
 5194 9782 CB A2        		res	4,d
 5195 9784 28 02        		jr	z,FQ_9
 5196 9786 19           		add	hl,de
 5197 9787 01           		db	1 ; ld bc,NN namiesto sbc hl,de
 5198 9788 ED 52        FQ_9:		sbc	hl,de
 5199 978A DD CB 00 56  		bit	2,(ix+0)
 5200 978E 28 16        		jr	z,OUT9
 5201 9790 DD 4E 0D     		ld	c,(ix+13)
 5202 9793 DD 46 0E     		ld	b,(ix+14)
 5203 9796 09           		add	hl,bc
 5204 9797 EB           		ex	de,hl
 5205 9798 DD 6E 0F     		ld	l,(ix+15)
 5206 979B DD 66 10     		ld	h,(ix+16)
 5207 979E 09           		add	hl,bc
 5208 979F DD 75 0D     		ld	(ix+13),l
 5209 97A2 DD 74 0E     		ld	(ix+14),h
 5210 97A5 EB           		ex	de,hl
 5211 97A6
 5212 97A6 DD 7E 11     OUT9:		ld	a,(ix+17)		; vytiahi cislo kanalu
 5213 97A9 87           		add	a,a			; vynasob dvoma
 5214 97AA 01 FD FF     		ld	bc,$FFFD		; a naprogramuj freq tonu
 5215 97AD ED 79        		out	(c),a
 5216 97AF 06 BF        		ld	b,$BF
 5217 97B1 ED 69        		out	(c),l
 5218 97B3 3C           		inc	a
 5219 97B4 06 FF        		ld	b,$FF
 5220 97B6 ED 79        		out	(c),a
 5221 97B8 06 BF        		ld	b,$BF
 5222 97BA ED 61        		out	(c),h
 5223 97BC 11 1D 00     SQ_ZCH: 	ld	de,CHZL 		; prejdi s IX na dalsi kanal
 5224 97BF DD 19        		add	ix,de
 5225 97C1 C9           		ret
 5226 97C2
 5227 97C2 0D 5D 0C 9C  FRQ2:		db	13,93,12,156
 5228 97C6 0B E7 0B 3C  		db	11,231,11,60
 5229 97CA 0A 9B 0A 02  		db	10,155,10,2,9,115
 5229 97CE 09 73
 5230 97D0 08 EB 08 6B  		db	8,235,8,107,7,242
 5230 97D4 07 F2
 5231 97D6 07 80 07 14  		db	7,128,7,20,6,174
 5231 97DA 06 AE
 5232 97DC 06 4E 05 F4  		db	6,78,5,244,5,158
 5232 97E0 05 9E
 5233 97E2 05 4F 05 01  		db	5,79,5,1,4,185
 5233 97E6 04 B9
 5234 97E8 04 75 04 35  		db	4,117,4,53,3,249
 5234 97EC 03 F9
 5235 97EE 03 C0 03 8A  		db	3,192,3,138,3,87
 5235 97F2 03 57
 5236 97F4 03 27 02 FA  		db	3,39,2,250,2,207
 5236 97F8 02 CF
 5237 97FA 02 A7 02 81  		db	2,167,2,129,2,93
 5237 97FE 02 5D
 5238 9800 02 3B 02 1B  		db	2,59,2,27,1,252
 5238 9804 01 FC
 5239 9806 01 E0 01 C5  		db	1,224,1,197,1,172
 5239 980A 01 AC
 5240 980C 01 94 01 7D  		db	1,148,1,125,1,104
 5240 9810 01 68
 5241 9812 01 53 01 40  		db	1,83,1,64
 5242 9816 01 2E 01 1D  		db	1,46,1,29,1,13
 5242 981A 01 0D
 5243 981C
 5244 981C FE F0 E2 D6  FRQ1:		db	254,240,226,214
 5245 9820 CA BE B4 AA  		db	202,190,180,170
 5246 9824 A0 97 8F 87  		db	160,151,143,135
 5247 9828 7F 78 71 6B  		db	127,120,113,107
 5248 982C 65 5F 5A 55  		db	101,95,90,85,80
 5248 9830 50
 5249 9831 4C 47 43 40  		db	76,71,67,64,60,57
 5249 9835 3C 39
 5250 9837 35 32 30 2D  		db	53,50,48,45,42,40
 5250 983B 2A 28
 5251 983D 26 24 22 20  		db	38,36,34,32,30,28
 5251 9841 1E 1C
 5252 9843 1B 19 18 16  		db	27,25,24,22,21,20
 5252 9847 15 14
 5253 9849 13 12 11 10  		db	19,18,17,16,15,14
 5253 984D 0F 0E
 5254 984F
 5255 984F 00           CHNZ1:	db	0
 5256 9850 00 00 00 00  		dw	0,0,0,0,0,0,0,0
 5256 9854 00 00 00 00
 5256 9858 00 00 00 00
 5256 985C 00 00 00 00
 5257 9860 02 00 00 00  		dw	2,0,0,0,0,0
 5257 9864 00 00 00 00
 5257 9868 00 00 00 00
 5258 986C 00           CHNZ2:	db	0
 5259 986D 00 00 00 00  		dw	0,0,0,0,0,0,0,0
 5259 9871 00 00 00 00
 5259 9875 00 00 00 00
 5259 9879 00 00 00 00
 5260 987D 01 00 00 00  		dw	1,0,0,0,0,0
 5260 9881 00 00 00 00
 5260 9885 00 00 00 00
 5261 9889 00           CHNZ3:	db	0
 5262 988A 00 00 00 00  		dw	0,0,0,0,0,0,0,0
 5262 988E 00 00 00 00
 5262 9892 00 00 00 00
 5262 9896 00 00 00 00
 5263 989A 00 00 00 00  		dw	0,0,0,0,0,0
 5263 989E 00 00 00 00
 5263 98A2 00 00 00 00
 5264 98A6
 5265 98A6 01 01        SQ_SYS: 	dw	#0101
 5266 98A8
 5267 98A8              CHZL:		equ	CHNZ2-CHNZ1	; offset medzi kanalmi
 5268 98A8
 5269 98A8
 5270 98A8              ;universal pt2 and pt3 player for zx spectrum and msx
 5271 98A8              ;(c)2004-2005 s.v.bulba <vorobey@mail.khstu.ru>
 5272 98A8              ;http://bulba.at.kz
 5273 98A8
 5274 98A8              ;release number
 5275 98A8              release equ "0"
 5276 98A8
 5277 98A8              ;conditional assembly
 5278 98A8              ;1) version of rout (zx or msx standards)
 5279 98A8              zx equ 1
 5280 98A8              msx equ 0
 5281 98A8              ;2) current position counter at (start+11)
 5282 98A8              curposcounter equ 1
 5283 98A8              ;3) allow channels allocation bits at (start+10)
 5284 98A8              acbbac equ 1
 5285 98A8              ;4) allow loop checking and disabling
 5286 98A8              loopchecker equ 1
 5287 98A8              ;5) insert official identificator
 5288 98A8              id equ 1
 5289 98A8
 5290 98A8              ATR
 5291 98A8 D5           		push de
 5292 98A9 32 B9 98     		ld (atr_kan+1),a
 5293 98AC 01 FD FF             ld   bc,AY   ;Přečtení hlasitosti
 5294 98AF ED 79                out  (c),a   ;z AY
 5295 98B1 ED 78                in   a,(c)
 5296 98B3 5F           		ld e,a
 5297 98B4
 5298 98B4 3E FE        		ld a,254		;přepnutí na druhou AY
 5299 98B6 ED 79        		out (c),a
 5300 98B8
 5301 98B8 3E 00        atr_kan	ld 	a,0
 5302 98BA ED 79                out  (c),a
 5303 98BC ED 78        		in   a,(c)
 5304 98BE 57           		ld d,a
 5305 98BF
 5306 98BF 3E FF        		ld a,255
 5307 98C1 ED 79        		out (c),a
 5308 98C3
 5309 98C3 7A           		ld a,d
 5310 98C4 83           		add a,e
 5311 98C5 1F           		rra
 5312 98C6
 5313 98C6 D1           		pop de
 5314 98C7 E5           		 push hl
 5315 98C8 F5           		 push af
 5316 98C9 21 B0 90     		 ld hl,ACBhlas
 5317 98CC B6           		 or (hl)
 5318 98CD 77           		 ld (hl),a
 5319 98CE F1           		 pop af
 5320 98CF E1           		 pop hl
 5321 98D0              		;	out (254),a
 5322 98D0 FE 10                 cp   16      ;Test překročení
 5323 98D2 38 02                 jr  c,ATR3      ;maximální hlast.
 5324 98D4 3E 0F        		 ld a,15
 5325 98D6 B7           ATR3     or   a
 5326 98D7 C8                    ret  z
 5327 98D8 47                    ld   b,a     ;Uschování hlast.
 5328 98D9 B7                    or a
 5329 98DA 1F                    rra          ;Výpočet barvy
 5330 98DB 38 02                 jr   c,ATR2  ;atributu.
 5331 98DD CB F7                 set  6,a     ;Nastavení jasu.
 5332 98DF              ATR2
 5333 98DF 77                    ld   (hl),a  ;Vykreslení
 5334 98E0 12                    ld   (de),a  ;atributové čáry.
 5335 98E1 23                    inc  hl      ;Opakuje se
 5336 98E2 1B                    dec  de      ;tolikrát, kolik
 5337 98E3 10 FA                 djnz ATR2    ;je hlasitost.
 5338 98E5 C9                    ret
 5339 98E6
 5340 98E6              AY       equ  65533
 5341 98E6
 5342 98E6
 5343 98E6              keysetup
 5344 98E6 CD 64 90     		call key.check
 5345 98E9
 5346 98E9 32 77 9A     		ld (klavesa),a
 5347 98EC FE 61        		cp "a"
 5348 98EE CC 5F 9A     		call z,setAY
 5349 98F1 FE 79        		cp "y"
 5350 98F3 CC 6C 9A     		call z,setYM
 5351 98F6 FE 62        		cp "b"
 5352 98F8 CC 54 9A     		call z,ABC
 5353 98FB FE 63        		cp "c"
 5354 98FD CC 49 9A     		call z,ACB
 5355 9900 CD 5F 71     		call showsetup
 5356 9903 C9           		ret
 5357 9904
 5358 9904              playmusic
 5359 9904 21 A0 50     			ld hl,20640
 5360 9907 11 2B 66     			ld de,by1
 5361 990A 06 18        			ld b,8*3
 5362 990C D5           ppp         push de
 5363 990D C5           			push bc
 5364 990E E5           			push hl
 5365 990F 06 20        			ld b,32
 5366 9911 1A           ppp0		ld a,(de)
 5367 9912 77           			ld (hl),a
 5368 9913 23           			inc hl
 5369 9914 10 FB        			djnz ppp0
 5370 9916 E1           			pop hl
 5371 9917 C1           			pop bc
 5372 9918 D1           			pop de
 5373 9919
 5374 9919 CD 20 7C     			call downhl
 5375 991C 13           			inc de
 5376 991D 10 ED        			djnz ppp
 5377 991F
 5378 991F
 5379 991F
 5380 991F              			; ld de,18464+15
 5381 991F              			; ld hl,txtcurrentfile
 5382 991F              			; call print
 5383 991F
 5384 991F              			; ld de,18432+15
 5385 991F              			; ld hl,txtallfiles
 5386 991F              			; call print
 5387 991F
 5388 991F
 5389 991F              		; ld hl,(apos_all)
 5390 991F              		; inc hl
 5391 991F              		; ld de,18464+15+11
 5392 991F              		; ld (NUMPOS+1),de
 5393 991F              		; call DEC16
 5394 991F              		; defw 20*256
 5395 991F
 5396 991F              		; ld hl,(ALLFILES)
 5397 991F              		; ld de,18432+15+11
 5398 991F              		; ld (NUMPOS+1),de
 5399 991F              		; call DEC16
 5400 991F              		; defw 20*256
 5401 991F
 5402 991F
 5403 991F
 5404 991F AF           		xor a
 5405 9920 32 00 74     		ld (endsong),a
 5406 9923 3A 0B 60     		ld a,(typ)
 5407 9926 FE 33        		cp "3"
 5408 9928 20 09        		jr nz,pp0
 5409 992A 3E 01        		ld a,%00000001
 5410 992C 32 7B A9     		ld (VTPL.SETUP),a
 5411 992F 3E 01                ld a,1 ;pt2,abc,looped
 5412 9931 18 07        	    jr pp1
 5413 9933              pp0
 5414 9933 3E 03        		ld a,%00000011
 5415 9935 32 7B A9     		ld (VTPL.SETUP),a
 5416 9938 3E 02        		ld a,2
 5417 993A              pp1
 5418 993A
 5419 993A F5           		push af
 5420 993B FE 02        		cp 2
 5421 993D 20 05        		jr nz,pt3
 5422 993F 21 8B BD     		ld hl,modstart + 101
 5423 9942 18 03        		jr pt2
 5424 9944 21 44 BD     pt3		ld hl,modstart + 30
 5425 9947              pt2
 5426 9947 CD 8D 90     		call infosong
 5427 994A 21 00 90     		ld hl,txtbuff
 5428 994D AF           		xor a
 5429 994E 32 50 90     		ld (txtbuff+80),a
 5430 9951
 5431 9951 21 C0 73     		ld hl,tmp
 5432 9954 11 C1 73     		ld de,tmp+1
 5433 9957 AF           		xor a
 5434 9958 77           		ld (hl),a
 5435 9959 01 30 00     		ld bc,48
 5436 995C ED B0        		ldir
 5437 995E
 5438 995E 21 00 90     		ld hl,txtbuff
 5439 9961 11 C0 73     		ld de,tmp
 5440 9964 01 21 00     		ld bc,maxline-4
 5441 9967 ED B0        		ldir
 5442 9969 21 C0 73     		ld hl,tmp
 5443 996C 11 21 50             ld de,20512+1
 5444 996F CD 26 7B     		call print
 5445 9972
 5446 9972 21 C0 73     		ld hl,tmp
 5447 9975 11 C1 73     		ld de,tmp+1
 5448 9978 AF           		xor a
 5449 9979 77           		ld (hl),a
 5450 997A 01 30 00     		ld bc,48
 5451 997D ED B0        		ldir
 5452 997F
 5453 997F 21 21 90     		ld hl,txtbuff + maxline-4
 5454 9982 11 C0 73     		ld de,tmp
 5455 9985 01 25 00     		ld bc,maxline
 5456 9988 ED B0        		ldir
 5457 998A 21 C0 73     		ld hl,tmp
 5458 998D 11 41 50             ld de,20512+1 + 32
 5459 9990 CD 26 7B     		call print
 5460 9993 F1           		pop af
 5461 9994
 5462 9994 2A B5 60     		ld hl,(delka_souboru)
 5463 9997              DELKA
 5464 9997 E5           		push hl
 5465 9998 7E           		ld a,(hl)
 5466 9999 FE 53        		cp "S"
 5467 999B 20 1C        		jr nz,normalni_pt3
 5468 999D 2B           		dec hl
 5469 999E 7E           		ld a,(hl)
 5470 999F FE 54        		cp "T"
 5471 99A1 20 16        		jr nz,normalni_pt3
 5472 99A3 2B           		dec hl
 5473 99A4 7E           		ld a,(hl)
 5474 99A5 FE 32        		cp "2"
 5475 99A7 20 10        		jr nz,normalni_pt3
 5476 99A9 2B           		dec hl
 5477 99AA 7E           		ld a,(hl)
 5478 99AB FE 30        		cp "0"
 5479 99AD 20 0A        		jr nz,normalni_pt3
 5480 99AF 3A 7B A9     		ld a,(VTPL.SETUP)
 5481 99B2 F6 10        		or %00010000
 5482 99B4 32 7B A9     		ld (VTPL.SETUP),a
 5483 99B7 18 02        		jr pokrvdet
 5484 99B9
 5485 99B9
 5486 99B9              normalni_pt3
 5487 99B9              		;ld (VTPL.SETUP),a
 5488 99B9 18 00        		jr pokrvdet
 5489 99BB              pokrvdet
 5490 99BB E1           		pop hl
 5491 99BC B7           		or a
 5492 99BD 11 0B 00     		ld de,11
 5493 99C0 ED 52        		sbc hl,de
 5494 99C2
 5495 99C2 7E           		ld a,(hl)
 5496 99C3 23           		inc hl
 5497 99C4 66           		ld h,(hl)
 5498 99C5 6F           		ld l,a
 5499 99C6
 5500 99C6 11 26 BD     		ld de,songdata
 5501 99C9 19           		add hl,de
 5502 99CA EB           		ex de,hl		;v DE máme druhou skladbu
 5503 99CB
 5504 99CB              		;CALL music_init
 5505 99CB
 5506 99CB 21 26 BD     		ld hl,songdata
 5507 99CE CD B2 A9     		call VTPL.INIT
 5508 99D1
 5509 99D1 FB           		EI
 5510 99D2 76           LOOP	HALT
 5511 99D3
 5512 99D3
 5513 99D3 E5           		push hl
 5514 99D4 D5           		push de
 5515 99D5 C5           		push bc
 5516 99D6
 5517 99D6 21 A0 5A     		 ld   hl,23200;Vymazání
 5518 99D9 11 A1 5A              ld   de,23201;předešlého
 5519 99DC 01 60 00              ld   bc,96   ;zobrazení.
 5520 99DF 70                    ld   (hl),b
 5521 99E0 ED B0                 ldir
 5522 99E2
 5523 99E2 AF           		 xor a
 5524 99E3 21 B0 90     		 ld hl,ACBhlas
 5525 99E6 77           		 ld (hl),a
 5526 99E7
 5527 99E7 3E 08                 ld   a,8     ;A teď nové
 5528 99E9 21 B0 5A              ld   hl,23216;zobrazení.
 5529 99EC 11 AF 5A              ld   de,23215;Kanál A.
 5530 99EF CD A8 98              call ATR
 5531 99F2
 5532 99F2 3E 0A                 ld   a,10    ;Kanál C.
 5533 99F4 21 D0 5A              ld   hl,23248
 5534 99F7 11 CF 5A              ld   de,23247
 5535 99FA CD A8 98              call ATR
 5536 99FD
 5537 99FD 3E 09                 ld   a,9     ;Kanál B.
 5538 99FF 21 F0 5A              ld   hl,23280
 5539 9A02 11 EF 5A              ld   de,23279
 5540 9A05 CD A8 98              call ATR
 5541 9A08
 5542 9A08 3A B0 90     		 ld a,(ACBhlas)
 5543 9A0B B7           		 or a
 5544 9A0C 28 07        		 jr z,.s1
 5545 9A0E 21 AF 90     		 ld hl,pocitadlo
 5546 9A11 AF           		 xor a
 5547 9A12 77           		 ld (hl),a
 5548 9A13 18 04        		 jr .s2
 5549 9A15 21 AF 90     .s1		 ld hl,pocitadlo
 5550 9A18 34           		 inc (hl)
 5551 9A19              .s2
 5552 9A19
 5553 9A19 CD E6 98     		call keysetup
 5554 9A1C C1           		pop bc
 5555 9A1D D1           		pop de
 5556 9A1E E1           		pop hl
 5557 9A1F
 5558 9A1F CD D5 B1     		CALL VTPL.PLAY
 5559 9A22 3A 77 9A     		ld a,(klavesa)
 5560 9A25 FE 01        		cp 1
 5561 9A27 28 18        		jr z,koneca
 5562 9A29 FE 20        		cp 32
 5563 9A2B 28 0E        		jr z,.s3
 5564 9A2D 3A AF 90     		ld a,(pocitadlo)
 5565 9A30 EE 64        		xor 100
 5566 9A32 28 07        		jr z,.s3
 5567 9A34
 5568 9A34 3A 3E A2     		ld a,(music_setup)
 5569 9A37 CB 7F        		bit 7,a
 5570 9A39 28 97        		JR z,LOOP
 5571 9A3B 3E 20        .s3		ld a,32
 5572 9A3D 21 00 74     		ld hl,endsong
 5573 9A40 77           		ld (hl),a
 5574 9A41 F5           koneca	push af
 5575 9A42
 5576 9A42 CD A0 A9     		call VTPL.MUTE
 5577 9A45 F1           		pop af
 5578 9A46 C3 BB 73     		jp navrat
 5579 9A49
 5580 9A49
 5581 9A49              ACB
 5582 9A49              		NEXTREG2A 08
 5582 9A49 3E 08       >        ld     a,08
 5582 9A4B CD 12 60    >        call   ReadNextReg
 5583 9A4E F6 20        		or #20
 5584 9A50 ED 92 08     		nextreg 08,a
 5585 9A53
 5586 9A53 C9           		ret
 5587 9A54              ABC
 5588 9A54              		NEXTREG2A 08
 5588 9A54 3E 08       >        ld     a,08
 5588 9A56 CD 12 60    >        call   ReadNextReg
 5589 9A59 E6 DF        		and 0xDF
 5590 9A5B ED 92 08     		nextreg 08,a
 5591 9A5E
 5592 9A5E C9           		ret
 5593 9A5F
 5594 9A5F              setAY
 5595 9A5F              		NEXTREG2A 06
 5595 9A5F 3E 06       >        ld     a,06
 5595 9A61 CD 12 60    >        call   ReadNextReg
 5596 9A64 E6 FC        		and #FC
 5597 9A66 F6 01        		or #1
 5598 9A68 ED 92 06     		nextreg 06,a
 5599 9A6B C9           		ret
 5600 9A6C
 5601 9A6C              setYM
 5602 9A6C              		NEXTREG2A 06
 5602 9A6C 3E 06       >        ld     a,06
 5602 9A6E CD 12 60    >        call   ReadNextReg
 5603 9A71 E6 FC        		and #FC
 5604 9A73 ED 92 06     		nextreg 06,a
 5605 9A76 C9           		ret
 5606 9A77
 5607 9A77              KLAVESA
 5608 9A77 00           klavesa defb 0
 5609 9A78              tona    equ 0
 5610 9A78              tonb    equ 2
 5611 9A78              tonc    equ 4
 5612 9A78              noise   equ 6
 5613 9A78              mixer   equ 7
 5614 9A78              ampla   equ 8
 5615 9A78              amplb   equ 9
 5616 9A78              amplc   equ 10
 5617 9A78              env     equ 11
 5618 9A78              envtp   equ 13
 5619 9A78
 5620 9A78              ;       struct  chp
 5621 9A78              ;reset group
 5622 9A78              chp_psinor      equ 0
 5623 9A78              chp_psinsm      equ 1
 5624 9A78              chp_cramsl      equ 2
 5625 9A78              chp_crnssl      equ 3
 5626 9A78              chp_crensl      equ 4
 5627 9A78              chp_tslcnt      equ 5
 5628 9A78              chp_crtnsl      equ 6
 5629 9A78              chp_tnacc       equ 8
 5630 9A78              chp_conoff      equ 10
 5631 9A78              ;reset group
 5632 9A78
 5633 9A78              chp_onoffd      equ 11
 5634 9A78
 5635 9A78              ;ix for ptdecod here (+12)
 5636 9A78              chp_offond      equ 12
 5637 9A78              chp_ornptr      equ 13
 5638 9A78              chp_samptr      equ 15
 5639 9A78              chp_nntskp      equ 17
 5640 9A78              chp_note        equ 18
 5641 9A78              chp_sltont      equ 19
 5642 9A78              chp_env_en      equ 20
 5643 9A78              chp_flags       equ 21
 5644 9A78               ;enabled - 0,simplegliss - 2
 5645 9A78              chp_tnsldl      equ 22
 5646 9A78              chp_tslstp      equ 23
 5647 9A78              chp_tndelt      equ 25
 5648 9A78              chp_ntskcn      equ 27
 5649 9A78              chp_volume      equ 28
 5650 9A78              ;       ends
 5651 9A78              chp     equ 29
 5652 9A78
 5653 9A78              ;entry and other points
 5654 9A78              ;start initialize playing of module at mdladdr
 5655 9A78              ;start+3 initialization with module address in hl
 5656 9A78              ;start+5 play one quark
 5657 9A78              ;start+8 mute
 5658 9A78              ;start+10 setup and status flags
 5659 9A78              ;start+11 current position value (byte) (optional)
 5660 9A78              ;first 12 values of tone tables (packed)
 5661 9A78
 5662 9A78
 5663 9A78 21 26 BD     music_init:	ld	hl,MDLADDR
 5664 9A7B E5           music_init0:	push	hl
 5665 9A7C 01 40 00     		ld	bc,#40			; look for "by" identifier
 5666 9A7F 09           		add	hl,bc
 5667 9A80 7E           		ld	a,(hl)
 5668 9A81 FE 79        		cp	'y'
 5669 9A83 2B           		dec	hl
 5670 9A84 7E           		ld	a,(hl)
 5671 9A85 E1           		pop	hl
 5672 9A86 28 09        		jr	z,pt3fmt_init
 5673 9A88 FE 62        		cp	'b'
 5674 9A8A 28 05        		jr	z,pt3fmt_init
 5675 9A8C 7E           		ld	a,(hl)			; and first byte of PT2 is delay
 5676 9A8D B9           		cp	c				; compared to PT3 text identifier
 5677 9A8E DA 04 9B     		jp	c,pt2fmt_init
 5678 9A91
 5679 9A91 CD 6D 9C     pt3fmt_init	call	setmodaddr
 5680 9A94 E5           		push	hl
 5681 9A95 11 64 00     		ld	de,100
 5682 9A98 19           		add	hl,de
 5683 9A99 7E           		ld	a,(hl)
 5684 9A9A 32 42 A1     		ld	(delay),a
 5685 9A9D E5           		push	hl
 5686 9A9E DD E1        		pop	ix
 5687 9AA0 19           		add	hl,de
 5688 9AA1 22 D8 A0     		ld	(CrPsPtr+1),hl
 5689 9AA4 DD 5E 02     		ld	e,(ix+2)
 5690 9AA7 19           		add	hl,de
 5691 9AA8 23           		inc	hl
 5692 9AA9 22 E3 A0     		ld	(LPosPtr+1),hl
 5693 9AAC D1           		pop	de
 5694 9AAD DD 6E 03     		ld	l,(ix+3)
 5695 9AB0 DD 66 04     		ld	h,(ix+4)
 5696 9AB3 19           		add	hl,de
 5697 9AB4 22 F2 A0     		ld	(PatsPtr+1),hl
 5698 9AB7 21 A9 00     		ld	hl,#A9
 5699 9ABA 19           		add	hl,de
 5700 9ABB 22 EA 9E     		ld	(OrnPtrs+1),hl
 5701 9ABE 21 69 00     		ld	hl,#69
 5702 9AC1 19           		add	hl,de
 5703 9AC2 22 00 9F     		ld	(SamPtrs+1),hl
 5704 9AC5
 5705 9AC5 DD 7E A9     		ld	a,(ix-87)		; extract version number
 5706 9AC8 D6 30        		sub	'0'
 5707 9ACA 38 04        		jr	c,l20
 5708 9ACC FE 0A        		cp	10
 5709 9ACE 38 02        		jr	c,l21
 5710 9AD0 3E 06        l20:		ld	a,6
 5711 9AD2 32 40 9E     l21:		ld	(Version+1),a
 5712 9AD5 F5           		push	af
 5713 9AD6 FE 04        		cp	4
 5714 9AD8 DD 7E FF     		ld	a,(ix-1) ; tone table number
 5715 9ADB 17           		rla
 5716 9ADC E6 07        		and	7
 5717 9ADE F5           		push	af
 5718 9ADF
 5719 9ADF 21 18 1F     		ld	hl,#18 + ((smp_-SamCnv-2) << 8)	; jr smp_
 5720 9AE2 22 85 9F     		ld	(SamCnv),hl
 5721 9AE5 3E BA        		ld	a,#BA				; cp d
 5722 9AE7 32 50 9F     		ld	(OrnCP),a
 5723 9AEA 32 7C 9F     		ld	(SamCP),a
 5724 9AED 3E 7B        		ld	a,#7B				; ld a,e
 5725 9AEF 32 53 9F     		ld	(OrnLD),a
 5726 9AF2 32 7F 9F     		ld	(SamLD),a
 5727 9AF5 3E 87        		ld	a,#87				; add a,a
 5728 9AF7 32 76 9F     		ld	(SamClc2),a
 5729 9AFA 21 00 00     		ld	hl,0
 5730 9AFD 11 8F A2     		ld	de,PT3_EmptySmpOrn
 5731 9B00 3E 3F        		ld	a,pt3pattdc-ptdecode-2
 5732 9B02 18 62        		jr	ptx_initcommon
 5733 9B04
 5734 9B04 32 42 A1     pt2fmt_init:	ld	(delay),a
 5735 9B07 E5           		push	hl
 5736 9B08 E5           		push	hl
 5737 9B09 E5           		push	hl
 5738 9B0A 23           		inc	hl
 5739 9B0B 23           		inc	hl
 5740 9B0C 7E           		ld	a,(hl)
 5741 9B0D 23           		inc	hl
 5742 9B0E 22 00 9F     		ld	(SamPtrs+1),hl
 5743 9B11 5E           		ld	e,(hl)
 5744 9B12 23           		inc	hl
 5745 9B13 56           		ld	d,(hl)
 5746 9B14 E1           		pop	hl
 5747 9B15 A7           		and	a
 5748 9B16 ED 52        		sbc	hl,de
 5749 9B18 CD 6D 9C     		call	setmodaddr
 5750 9B1B E1           		pop	hl
 5751 9B1C 11 43 00     		ld	de,67
 5752 9B1F 19           		add	hl,de
 5753 9B20 22 EA 9E     		ld	(OrnPtrs+1),hl
 5754 9B23 1E 20        		ld	e,32
 5755 9B25 19           		add	hl,de
 5756 9B26 4E           		ld	c,(hl)
 5757 9B27 23           		inc	hl
 5758 9B28 46           		ld	b,(hl)
 5759 9B29 1E 1E        		ld	e,30
 5760 9B2B 19           		add	hl,de
 5761 9B2C 22 D8 A0     		ld	(CrPsPtr+1),hl
 5762 9B2F 5F           		ld	e,a
 5763 9B30 23           		inc	hl
 5764 9B31
 5765 9B31 19           		add	hl,de
 5766 9B32 22 E3 A0     		ld	(LPosPtr+1),hl
 5767 9B35 E1           		pop	hl
 5768 9B36 09           		add	hl,bc
 5769 9B37 22 F2 A0     		ld	(PatsPtr+1),hl
 5770 9B3A 3E 05        		ld	a,5
 5771 9B3C 32 40 9E     		ld	(Version+1),a
 5772 9B3F F5           		push	af
 5773 9B40 3E 02        		ld	a,2
 5774 9B42 F5           		push	af
 5775 9B43 21 CB 51     		ld	hl,$51CB			; bit 2,c
 5776 9B46 22 85 9F     		ld	(SamCnv),hl
 5777 9B49 3E BB        		ld	a,$BB				; cp e
 5778 9B4B 32 50 9F     		ld	(OrnCP),a
 5779 9B4E 32 7C 9F     		ld	(SamCP),a
 5780 9B51 3E 7A        		ld	a,$7A				; ld a,d
 5781 9B53 32 53 9F     		ld	(OrnLD),a
 5782 9B56 32 7F 9F     		ld	(SamLD),a
 5783 9B59 3E 80        		ld	a,$80				; add a,b
 5784 9B5B 32 76 9F     		ld	(SamClc2),a
 5785 9B5E 21 87 86     		ld	hl,$8687			; add a,a,(hl)
 5786 9B61 11 43 A3     		ld	de,PT2_EmptySmpOrn
 5787 9B64 3E 87        		ld	a,pt2pattdc-ptdecode-2
 5788 9B66
 5789 9B66 22 EB A0     ptx_initcommon:	ld	(PsCalc),hl
 5790 9B69 32 4C 9D     		ld	(ptdecode+1),a
 5791 9B6C D5           		push	de
 5792 9B6D
 5793 9B6D              ; note table data depacker
 5794 9B6D 11 92 A2     		ld	de,T_PACK
 5795 9B70 01 95 A3     		ld	bc,T1_+(2*49)-1
 5796 9B73 1A           tp_0:		ld	a,(de)
 5797 9B74 13           		inc	de
 5798 9B75 FE 1E        		cp	15*2
 5799 9B77 30 06        		jr	nc,tp_1
 5800 9B79 67           		ld	h,a
 5801 9B7A 1A           		ld	a,(de)
 5802 9B7B 6F           		ld	l,a
 5803 9B7C 13           		inc	de
 5804 9B7D 18 07        		jr	tp_2
 5805 9B7F D5           tp_1:		push	de
 5806 9B80 16 00        		ld	d,0
 5807 9B82 5F           		ld	e,a
 5808 9B83 19           		add	hl,de
 5809 9B84 19           		add	hl,de
 5810 9B85 D1           		pop	de
 5811 9B86 7C           tp_2:		ld	a,h
 5812 9B87 02           		ld	(bc),a
 5813 9B88 0B           		dec	bc
 5814 9B89 7D           		ld	a,l
 5815 9B8A 02           		ld	(bc),a
 5816 9B8B 0B           		dec	bc
 5817 9B8C D6 F0        		sub	low (#F8*2)
 5818 9B8E 20 E3        		jr	nz,tp_0
 5819 9B90
 5820 9B90 32 47 A0     		ld	(GlobalAttn+1),a
 5821 9B93 32 FC A1     		ld	(chkfadeout+1),a
 5822 9B96 21 3E A2     		ld	hl,music_setup
 5823 9B99 CB BE        		res	7,(hl)
 5824 9B9B
 5825 9B9B 21 C7 A2     		ld	hl,VARS
 5826 9B9E 77           		ld	(hl),a
 5827 9B9F 11 C8 A2     		ld	de,VARS+1
 5828 9BA2 01 6C 00     		ld	bc,VAR0END-VARS-1
 5829 9BA5 ED B0        		ldir
 5830 9BA7 23           		inc	hl
 5831 9BA8 22 CD A0     		ld	(AdInPtA+1),hl		; ptr to zero
 5832 9BAB 3C           		inc	a
 5833 9BAC 32 1E A3     		ld	(DelyCnt),a
 5834 9BAF 21 01 F0     		ld	hl,#F001	; H - CHP.Volume, L - CHP.NtSkCn
 5835 9BB2 22 E2 A2     		ld	(ChanA+CHP.NtSkCn),hl
 5836 9BB5 22 FF A2     		ld	(ChanB+CHP.NtSkCn),hl
 5837 9BB8 22 1C A3     		ld	(ChanC+CHP.NtSkCn),hl
 5838 9BBB E1           		pop	hl
 5839 9BBC 22 D4 A2     		ld	(ChanA+CHP.OrnPtr),hl	; ornament 0 is "0,1,0"
 5840 9BBF 22 F1 A2     		ld	(ChanB+CHP.OrnPtr),hl	; in all versions from
 5841 9BC2 22 0E A3     		ld	(ChanC+CHP.OrnPtr),hl	; 3.xx to 3.6x and VTII
 5842 9BC5 F1           		pop	af
 5843 9BC6
 5844 9BC6              ;NoteTableCreator (c) Ivan Roshin
 5845 9BC6              ;A - NoteTableNumber*2+VersionForNoteTable
 5846 9BC6              ;	xx1b - 3.xx..3.4r
 5847 9BC6              ;	xx0b - 3.4x..3.6x - VortexTracker II
 5848 9BC6
 5849 9BC6 21 3F A2     		ld	hl,nt_data
 5850 9BC9 D5           		push	de
 5851 9BCA 50           		ld	d,b
 5852 9BCB 87           		add	a,a
 5853 9BCC 5F           		ld	e,a
 5854 9BCD 19           		add	hl,de
 5855 9BCE 5E           		ld	e,(hl)
 5856 9BCF 23           		inc	hl
 5857 9BD0 CB 3B        		srl	e
 5858 9BD2 9F           		sbc	a,a
 5859 9BD3 E6 A7        		and	#A7	; #00 (NOP) or #A7 (AND A)
 5860 9BD5 32 FB 9B     		ld	(l3),a
 5861 9BD8 EB           		ex	de,hl
 5862 9BD9 C1           		pop	bc	; bc = T1_
 5863 9BDA 09           		add	hl,bc
 5864 9BDB 1A           		ld	a,(de)
 5865 9BDC C6 4F        		add	a,low T_
 5866 9BDE 4F           		ld	c,a
 5867 9BDF CE A2        		adc	a,high T_
 5868 9BE1 91           		sub	c
 5869 9BE2 47           		ld	b,a
 5870 9BE3 C5           		push	bc
 5871 9BE4 11 24 A4     		ld	de,NT_
 5872 9BE7 D5           		push	de
 5873 9BE8 06 0C        		ld	b,12
 5874 9BEA C5           l1:		push	bc
 5875 9BEB 4E           		ld	c,(hl)
 5876 9BEC 23           		inc	hl
 5877 9BED E5           		push	hl
 5878 9BEE 46           		ld	b,(hl)
 5879 9BEF D5           		push	de
 5880 9BF0 EB           		ex	de,hl
 5881 9BF1 11 17 00     		ld	de,#17
 5882 9BF4 DD 26 08     		ld	xh,8
 5883 9BF7 CB 38        l2:		srl	b
 5884 9BF9 CB 19        		rr	c
 5885 9BFB 19           l3:		add	hl,de	; will be replaced by AND A or NOP apparently
 5886 9BFC 79           		ld	a,c
 5887 9BFD 8A           		adc	a,d
 5888 9BFE 77           		ld	(hl),a
 5889 9BFF 23           		inc	hl
 5890 9C00 78           		ld	a,b
 5891 9C01 8A           		adc	a,d
 5892 9C02 77           		ld	(hl),a
 5893 9C03 19           		add	hl,de
 5894 9C04 DD 25        		dec	xh
 5895 9C06 20 EF        		jr	nz,l2
 5896 9C08
 5897 9C08 D1           		pop	de
 5898 9C09 13           		inc	de
 5899 9C0A 13           		inc	de
 5900 9C0B E1           		pop	hl
 5901 9C0C 23           		inc	hl
 5902 9C0D C1           		pop	bc
 5903 9C0E 10 DA        		djnz	l1
 5904 9C10
 5905 9C10 E1           		pop	hl
 5906 9C11 D1           		pop	de
 5907 9C12 7B           		ld	a,e
 5908 9C13 FE 5B        		cp	low TCOLD_1
 5909 9C15 20 05        		jr	nz,corr_1
 5910 9C17 3E FD        		ld	a,#FD
 5911 9C19 32 52 A4     		ld	(NT_+#002E),a
 5912 9C1C 1A           corr_1:		ld	a,(de)
 5913 9C1D A7           		and	a
 5914 9C1E 28 11        		jr	z,tc_exit
 5915 9C20 1F           		rra
 5916 9C21 F5           		push	af
 5917 9C22 87           		add	a,a
 5918 9C23 4F           		ld	c,a
 5919 9C24 09           		add	hl,bc
 5920 9C25 F1           		pop	af
 5921 9C26 30 02        		jr	nc,corr_2
 5922 9C28 35           		dec	(hl)
 5923 9C29 35           		dec	(hl)
 5924 9C2A 34           corr_2:		inc	(hl)
 5925 9C2B A7           		and	a
 5926 9C2C ED 42        		sbc	hl,bc
 5927 9C2E 13           		inc	de
 5928 9C2F 18 EB        		jr	corr_1
 5929 9C31 F1           tc_exit:	pop	af
 5930 9C32
 5931 9C32              ; VolTableCreator (c) Ivan Roshin
 5932 9C32              ; A - VersionForVolumeTable
 5933 9C32              ;	(0..4 - v3.xx .. v3.4x
 5934 9C32              ;	(5..  - v2.x, v3.5x .. v3.6x (VT2) .. v3.7)
 5935 9C32
 5936 9C32 FE 05        		cp	5
 5937 9C34 21 11 00     		ld	hl,17
 5938 9C37 54           		ld	d,h
 5939 9C38 5C           		ld	e,h
 5940 9C39 3E 17        		ld	a,#17
 5941 9C3B 30 03        		jr	nc,m1
 5942 9C3D 2D           		dec	l
 5943 9C3E 5D           		ld	e,l
 5944 9C3F AF           		xor	a
 5945 9C40 32 4F 9C     m1:		ld	(m2),a
 5946 9C43 DD 21 34 A3  		ld	ix,VT_+16
 5947 9C47 0E 10        		ld	c,16
 5948 9C49 E5           initloop2:	push	hl
 5949 9C4A 19           		add	hl,de
 5950 9C4B EB           		ex	de,hl
 5951 9C4C ED 62        		sbc	hl,hl
 5952 9C4E 7D           initloop1:	ld	a,l
 5953 9C4F 7D           m2:		ld	a,l
 5954 9C50 7C           		ld	a,h
 5955 9C51 CE 00        		adc	a,0
 5956 9C53 DD 77 00     		ld	(ix+0),a
 5957 9C56 DD 23        		inc	ix
 5958 9C58 19           		add	hl,de
 5959 9C59 0C           		inc	c
 5960 9C5A 79           		ld	a,c
 5961 9C5B E6 0F        		and	15
 5962 9C5D 20 EF        		jr	nz,initloop1
 5963 9C5F E1           		pop	hl
 5964 9C60 7B           		ld	a,e
 5965 9C61 FE 77        		cp	#77
 5966 9C63 20 01        		jr	nz,m3
 5967 9C65 1C           		inc	e
 5968 9C66 79           m3:		ld	a,c
 5969 9C67 A7           		and	a
 5970 9C68 20 DF        		jr	nz,initloop2
 5971 9C6A C3 A8 A1     		jp	rout_a0
 5972 9C6D
 5973 9C6D 22 F6 A0     setmodaddr:	ld	(modaddr+1),hl
 5974 9C70 22 07 9F     		ld	(mdaddr1+1),hl
 5975 9C73 22 F1 9E     		ld	(mdaddr2+1),hl
 5976 9C76 C9           		ret
 5977 9C77
 5978 9C77              ; PT2 pattern decoder ---------------------------------------------------------
 5979 9C77 CD FB 9E     pd2_sam		call	setsam
 5980 9C7A 18 5A        		jr	pd2_loop
 5981 9C7C
 5982 9C7C DD 77 08     pd2_eoff	ld	(ix-12+CHP.Env_En),a
 5983 9C7F 18 55        		jr	pd2_loop
 5984 9C81
 5985 9C81 DD 36 08 10  pd2_env		ld	(ix-12+CHP.Env_En),16
 5986 9C85 32 31 A3     		ld	(AYREGS+AR_EnvTp),a
 5987 9C88 0A           		ld	a,(bc)
 5988 9C89 03           		inc	bc
 5989 9C8A 6F           		ld	l,a
 5990 9C8B 0A           		ld	a,(bc)
 5991 9C8C 03           		inc	bc
 5992 9C8D 67           		ld	h,a
 5993 9C8E 22 32 A3     		ld	(EnvBase),hl
 5994 9C91 18 43        		jr	pd2_loop
 5995 9C93
 5996 9C93 CD E2 9E     pd2_orn		call	setorn
 5997 9C96 18 3E        		jr	pd2_loop
 5998 9C98
 5999 9C98 3C           pd2_skip	inc	a
 6000 9C99 DD 77 05     		ld	(ix-12+CHP.NNtSkp),a
 6001 9C9C 18 38        		jr	pd2_loop
 6002 9C9E
 6003 9C9E 0F           pd2_vol		rrca
 6004 9C9F 0F           		rrca
 6005 9CA0 0F           		rrca
 6006 9CA1 0F           		rrca
 6007 9CA2 DD 77 10     		ld	(ix-12+CHP.Volume),a
 6008 9CA5 18 2F        		jr	pd2_loop
 6009 9CA7
 6010 9CA7 CD BD 9E     pd2_del		call	c_delay
 6011 9CAA 18 2A        		jr	pd2_loop
 6012 9CAC
 6013 9CAC DD CB 09 D6  pd2_glis	set	2,(ix-12+CHP.Flags)
 6014 9CB0 3C           		inc	a
 6015 9CB1 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
 6016 9CB4 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6017 9CB7 0A           		ld	a,(bc)
 6018 9CB8 03           		inc	bc
 6019 9CB9 DD 77 0B     		ld	(ix-12+CHP.TSlStp),a
 6020 9CBC 87           		add	a,a
 6021 9CBD 9F           		sbc	a,a
 6022 9CBE DD 77 0C     		ld	(ix-12+CHP.TSlStp+1),a
 6023 9CC1 37           		scf
 6024 9CC2 18 11        		jr	pd2_loop2
 6025 9CC4
 6026 9CC4 DD CB 09 96  pd2_port:	res	2,(ix-12+CHP.Flags)
 6027 9CC8 0A           		ld	a,(bc)
 6028 9CC9 03           		inc	bc
 6029 9CCA 03           		inc	bc		; ignoring precalc delta to right sound
 6030 9CCB 03           		inc	bc
 6031 9CCC 37           		scf
 6032 9CCD 18 06        		jr	pd2_loop2
 6033 9CCF
 6034 9CCF DD 77 F9     pd2_stop:	ld	(ix-12+CHP.TSlCnt),a
 6035 9CD2 18 02        		jr	pd2_loop
 6036 9CD4
 6037 9CD4 A7           pt2pattdc:	and	a
 6038 9CD5 08           pd2_loop2:	ex	af,af'
 6039 9CD6 0A           pd2_loop:	ld	a,(bc)
 6040 9CD7 03           		inc	bc
 6041 9CD8 C6 20        		add	a,$20
 6042 9CDA 28 2F        		jr	z,pd2_rel
 6043 9CDC 38 99        		jr	c,pd2_sam
 6044 9CDE C6 60        		add	a,96
 6045 9CE0 38 2E        		jr	c,pd2_note
 6046 9CE2 3C           		inc	a
 6047 9CE3 28 97        		jr	z,pd2_eoff
 6048 9CE5 C6 0F        		add	a,15
 6049 9CE7 CA EF 9D     		jp	z,pd_fin
 6050 9CEA 38 95        		jr	c,pd2_env
 6051 9CEC C6 10        		add	a,$10
 6052 9CEE 38 A3        		jr	c,pd2_orn
 6053 9CF0 C6 40        		add	a,$40
 6054 9CF2 38 A4        		jr	c,pd2_skip
 6055 9CF4 C6 10        		add	a,$10
 6056 9CF6 38 A6        		jr	c,pd2_vol
 6057 9CF8 3C           		inc	a
 6058 9CF9 28 AC        		jr	z,pd2_del
 6059 9CFB 3C           		inc	a
 6060 9CFC 28 AE        		jr	z,pd2_glis
 6061 9CFE 3C           		inc	a
 6062 9CFF 28 C3        		jr	z,pd2_port
 6063 9D01 3C           		inc	a
 6064 9D02 28 CB        		jr	z,pd2_stop
 6065 9D04 0A           		ld	a,(bc)
 6066 9D05 03           		inc	bc
 6067 9D06 DD 77 F7     		ld	(ix-12+CHP.CrNsSl),a
 6068 9D09 18 CB        		jr	pd2_loop
 6069 9D0B
 6070 9D0B DD 77 09     pd2_rel:	ld	(ix-12+CHP.Flags),a
 6071 9D0E 18 2C        		jr	pd2_exit
 6072 9D10
 6073 9D10 6F           pd2_note:	ld	l,a
 6074 9D11 DD 7E 06     		ld	a,(ix-12+CHP.Note)
 6075 9D14 32 29 9E     		ld	(PrNote+1),a
 6076 9D17 DD 75 06     		ld	(ix-12+CHP.Note),l
 6077 9D1A AF           		xor	a
 6078 9D1B DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6079 9D1E DD CB 09 C6  		set	0,(ix-12+CHP.Flags)
 6080 9D22 08           		ex	af,af'
 6081 9D23 30 16        		jr	nc,pd2_noglis
 6082 9D25 DD CB 09 56  		bit	2,(ix-12+CHP.Flags)
 6083 9D29 20 0C        		jr	nz,pd2_noport
 6084 9D2B 32 4F 9E     		ld	(LoStep+1),a
 6085 9D2E 87           		add	a,a
 6086 9D2F 9F           		sbc	a,a
 6087 9D30 08           		ex	af,af'
 6088 9D31 67           		ld	h,a
 6089 9D32 6F           		ld	l,a
 6090 9D33 3C           		inc	a
 6091 9D34 CD 0A 9E     		call	setport
 6092 9D37 DD 36 F9 01  pd2_noport:	ld	(ix-12+CHP.TSlCnt),1
 6093 9D3B AF           pd2_noglis:	xor	a
 6094 9D3C
 6095 9D3C DD 77 F5     pd2_exit:	ld	(ix-12+CHP.PsInSm),a
 6096 9D3F DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6097 9D42 DD 77 FA     		ld	(ix-12+CHP.CrTnSl),a
 6098 9D45 DD 77 FB     		ld	(ix-12+CHP.CrTnSl+1),a
 6099 9D48 C3 EF 9D     		jp	pd_fin
 6100 9D4B
 6101 9D4B
 6102 9D4B 18 3F        ptdecode:	jr	pt3pattdc		; patter decoder fork
 6103 9D4D
 6104 9D4D              ; PT3 pattern decoder ---------------------------------------------------------
 6105 9D4D DD 36 08 00  PD_OrSm:	ld	(ix-12+CHP.Env_En),0
 6106 9D51 CD E2 9E     		call	setorn
 6107 9D54 0A           pd_sam_:	ld	a,(bc)
 6108 9D55 03           		inc	bc
 6109 9D56 0F           		rrca
 6110 9D57 CD FB 9E     pd_sam:		call	setsam
 6111 9D5A 18 3F        		jr	pd_loop
 6112 9D5C
 6113 9D5C 0F           pd_vol:		rrca
 6114 9D5D 0F           		rrca
 6115 9D5E 0F           		rrca
 6116 9D5F 0F           		rrca
 6117 9D60 DD 77 10     		ld	(ix-12+CHP.Volume),a
 6118 9D63 18 39        		jr	pd_lp2
 6119 9D65
 6120 9D65 DD 77 08     pd_eoff:	ld	(ix-12+CHP.Env_En),a
 6121 9D68 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6122 9D6B 18 31        		jr	pd_lp2
 6123 9D6D
 6124 9D6D 3D           pd_SorE:	dec	a
 6125 9D6E 20 07        		jr	nz,pd_env
 6126 9D70 0A           		ld	a,(bc)
 6127 9D71 03           		inc	bc
 6128 9D72 DD 77 05     		ld	(ix-12+CHP.NNtSkp),a
 6129 9D75 18 27        		jr	pd_lp2
 6130 9D77
 6131 9D77 CD C6 9E     pd_env:		call	setenv
 6132 9D7A 18 22        		jr	pd_lp2
 6133 9D7C
 6134 9D7C CD E2 9E     pd_orn:		call	setorn
 6135 9D7F 18 1A        		jr	pd_loop
 6136 9D81
 6137 9D81 DD 77 08     pd_esam:	ld	(ix-12+CHP.Env_En),a
 6138 9D84 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6139 9D87 C4 C6 9E     		call	nz,setenv
 6140 9D8A 18 C8        		jr	pd_sam_
 6141 9D8C
 6142 9D8C DD 7E 06     pt3pattdc:	ld	a,(ix-12+CHP.Note)
 6143 9D8F 32 29 9E     		ld	(PrNote+1),a
 6144 9D92 DD 6E FA     		ld	l,(ix-12+CHP.CrTnSl)
 6145 9D95 DD 66 FB     		ld	h,(ix-12+CHP.CrTnSl+1)
 6146 9D98 22 46 9E     		ld	(PrSlide+1),hl
 6147 9D9B
 6148 9D9B 11 10 20     pd_loop:	ld	de,#2010
 6149 9D9E 0A           pd_lp2:		ld	a,(bc)
 6150 9D9F 03           		inc	bc
 6151 9DA0 83           		add	a,e
 6152 9DA1 38 AA        		jr	c,PD_OrSm
 6153 9DA3 82           		add	a,d
 6154 9DA4 28 49        		jr	z,pd_fin
 6155 9DA6 38 AF        		jr	c,pd_sam
 6156 9DA8 83           		add	a,e
 6157 9DA9 28 25        		jr	z,pd_rel
 6158 9DAB 38 AF        		jr	c,pd_vol
 6159 9DAD 83           		add	a,e
 6160 9DAE 28 B5        		jr	z,pd_eoff
 6161 9DB0 38 BB        		jr	c,pd_SorE
 6162 9DB2 C6 60        		add	a,#60
 6163 9DB4 38 20        		jr	c,pd_note
 6164 9DB6 83           		add	a,e
 6165 9DB7 38 C3        		jr	c,pd_orn
 6166 9DB9 82           		add	a,d
 6167 9DBA 38 0F        		jr	c,pd_nois
 6168 9DBC 83           		add	a,e
 6169 9DBD 38 C2        		jr	c,pd_esam
 6170 9DBF 87           		add	a,a
 6171 9DC0 5F           		ld	e,a
 6172 9DC1 21 31 7E     		ld	hl,spccoms-#20E0
 6173 9DC4 19           		add	hl,de
 6174 9DC5 5E           		ld	e,(hl)
 6175 9DC6 23           		inc	hl
 6176 9DC7 56           		ld	d,(hl)
 6177 9DC8 D5           		push	de
 6178 9DC9 18 D0        		jr	pd_loop
 6179 9DCB
 6180 9DCB 32 22 A3     pd_nois:	ld	(Ns_base),a
 6181 9DCE 18 CE        		jr	pd_lp2
 6182 9DD0
 6183 9DD0 DD CB 09 86  pd_rel:		res	0,(ix-12+CHP.Flags)
 6184 9DD4 18 08        		jr	pd_res
 6185 9DD6
 6186 9DD6 DD 77 06     pd_note:	ld	(ix-12+CHP.Note),a
 6187 9DD9 DD CB 09 C6  		set	0,(ix-12+CHP.Flags)
 6188 9DDD AF           		xor	a
 6189 9DDE ED 73 ED 9D  pd_res:		ld	(pdsp_+1),sp
 6190 9DE2 DD F9        		ld	sp,ix
 6191 9DE4 67           		ld	h,a
 6192 9DE5 6F           		ld	l,a
 6193 9DE6 E5           		push	hl
 6194 9DE7 E5           		push	hl
 6195 9DE8 E5           		push	hl
 6196 9DE9 E5           		push	hl
 6197 9DEA E5           		push	hl
 6198 9DEB E5           		push	hl
 6199 9DEC 31 31 31     pdsp_:		ld	sp,#3131
 6200 9DEF DD 7E 05     pd_fin:		ld	a,(ix-12+CHP.NNtSkp)
 6201 9DF2 DD 77 0F     		ld	(ix-12+CHP.NtSkCn),a
 6202 9DF5 C9           		ret
 6203 9DF6
 6204 9DF6 0A           c_portm:	ld	a,(bc)
 6205 9DF7 03           		inc	bc
 6206 9DF8 03           		inc	bc	; skip precalculated tone delta
 6207 9DF9 03           		inc	bc	; (because cannot be right after pt3 compilation)
 6208 9DFA 08           		ex	af,af'
 6209 9DFB 0A           		ld	a,(bc)	; signed tone step
 6210 9DFC 03           		inc	bc
 6211 9DFD 32 4F 9E     		ld	(LoStep+1),a
 6212 9E00 0A           		ld	a,(bc)
 6213 9E01 03           		inc	bc
 6214 9E02 A7           		and	a
 6215 9E03 08           		ex	af,af'
 6216 9E04 DD 6E FA     		ld	l,(ix-12+CHP.CrTnSl)
 6217 9E07 DD 66 FB     		ld	h,(ix-12+CHP.CrTnSl+1)
 6218 9E0A
 6219 9E0A              ; Set portamento variables
 6220 9E0A              ; A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 6221 9E0A DD CB 09 96  setport		res	2,(ix-12+CHP.Flags)
 6222 9E0E DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
 6223 9E11 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6224 9E14 E5           		push	hl
 6225 9E15 11 24 A4     		ld	de,NT_
 6226 9E18 DD 7E 06     		ld	a,(ix-12+CHP.Note)
 6227 9E1B DD 77 07     		ld	(ix-12+CHP.SlToNt),a
 6228 9E1E 87           		add	a,a
 6229 9E1F 6F           		ld	l,a
 6230 9E20 26 00        		ld	h,0
 6231 9E22 19           		add	hl,de
 6232 9E23 7E           		ld	a,(hl)
 6233 9E24 23           		inc	hl
 6234 9E25 66           		ld	h,(hl)
 6235 9E26 6F           		ld	l,a
 6236 9E27 E5           		push	hl
 6237 9E28 3E 3E        PrNote:		ld	a,#3E
 6238 9E2A DD 77 06     		ld	(ix-12+CHP.Note),a
 6239 9E2D 87           		add	a,a
 6240 9E2E 6F           		ld	l,a
 6241 9E2F 26 00        		ld	h,0
 6242 9E31 19           		add	hl,de
 6243 9E32 5E           		ld	e,(hl)
 6244 9E33 23           		inc	hl
 6245 9E34 56           		ld	d,(hl)
 6246 9E35 E1           		pop	hl
 6247 9E36 ED 52        		sbc	hl,de
 6248 9E38 DD 75 0D     		ld	(ix-12+CHP.TnDelt),l
 6249 9E3B DD 74 0E     		ld	(ix-12+CHP.TnDelt+1),h
 6250 9E3E D1           		pop	de
 6251 9E3F 3E 3E        Version:	ld	a,#3E
 6252 9E41 FE 06        		cp	6
 6253 9E43 38 09        		jr	c,LoStep	; old 3xxx for PT v3.5-
 6254 9E45 11 11 11     PrSlide:	ld	de,#1111
 6255 9E48 DD 73 FA     		ld	(ix-12+CHP.CrTnSl),e
 6256 9E4B DD 72 FB     		ld	(ix-12+CHP.CrTnSl+1),d
 6257 9E4E 3E 00        LoStep:		ld	a,0		; signed tone step
 6258 9E50 08           		ex	af,af'
 6259 9E51 28 01        		jr	z,nosig
 6260 9E53 EB           		ex	de,hl
 6261 9E54 ED 52        nosig:		sbc	hl,de
 6262 9E56 F2 5E 9E     		jp	p,set_stp
 6263 9E59 2F           		cpl
 6264 9E5A 08           		ex	af,af'
 6265 9E5B ED 44        		neg
 6266 9E5D 08           		ex	af,af'
 6267 9E5E DD 77 0C     set_stp:	ld	(ix-12+CHP.TSlStp+1),a
 6268 9E61 08           		ex	af,af'
 6269 9E62 DD 77 0B     		ld	(ix-12+CHP.TSlStp),a
 6270 9E65 DD 36 FE 00  		ld	(ix-12+CHP.COnOff),0
 6271 9E69 C9           		ret
 6272 9E6A
 6273 9E6A DD CB 09 D6  c_gliss:	set	2,(ix-12+CHP.Flags)
 6274 9E6E 0A           		ld	a,(bc)
 6275 9E6F 03           		inc	bc
 6276 9E70 DD 77 0A     		ld	(ix-12+CHP.TnSlDl),a
 6277 9E73 A7           		and	a
 6278 9E74 20 07        		jr	nz,gl36
 6279 9E76 3A 40 9E     		ld	a,(Version+1) ;AlCo PT3.7+
 6280 9E79 FE 07        		cp	7
 6281 9E7B 9F           		sbc	a,a
 6282 9E7C 3C           		inc	a
 6283 9E7D DD 77 F9     gl36:		ld	(ix-12+CHP.TSlCnt),a
 6284 9E80 0A           		ld	a,(bc)
 6285 9E81 03           		inc	bc
 6286 9E82 08           		ex	af,af'
 6287 9E83 0A           		ld	a,(bc)
 6288 9E84 03           		inc	bc
 6289 9E85 18 D7        		jr	set_stp
 6290 9E87
 6291 9E87 0A           c_smpos:	ld	a,(bc)
 6292 9E88 03           		inc	bc
 6293 9E89 DD 77 F5     		ld	(ix-12+CHP.PsInSm),a
 6294 9E8C C9           		ret
 6295 9E8D
 6296 9E8D 0A           c_orpos:	ld	a,(bc)
 6297 9E8E 03           		inc	bc
 6298 9E8F DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6299 9E92 C9           		ret
 6300 9E93
 6301 9E93 0A           c_vibrt:	ld	a,(bc)
 6302 9E94 03           		inc	bc
 6303 9E95 DD 77 FF     		ld	(ix-12+CHP.OnOffD),a
 6304 9E98 DD 77 FE     		ld	(ix-12+CHP.COnOff),a
 6305 9E9B 0A           		ld	a,(bc)
 6306 9E9C 03           		inc	bc
 6307 9E9D DD 77 00     		ld	(ix-12+CHP.OffOnD),a
 6308 9EA0 AF           		xor	a
 6309 9EA1 DD 77 F9     		ld	(ix-12+CHP.TSlCnt),a
 6310 9EA4 DD 77 FA     		ld	(ix-12+CHP.CrTnSl),a
 6311 9EA7 DD 77 FB     		ld	(ix-12+CHP.CrTnSl+1),a
 6312 9EAA C9           		ret
 6313 9EAB
 6314 9EAB 0A           c_engls:	ld	a,(bc)
 6315 9EAC 03           		inc	bc
 6316 9EAD 32 9E A1     		ld	(Env_Del+1),a
 6317 9EB0 32 21 A3     		ld	(CurEDel),a
 6318 9EB3 0A           		ld	a,(bc)
 6319 9EB4 03           		inc	bc
 6320 9EB5 6F           		ld	l,a
 6321 9EB6 0A           		ld	a,(bc)
 6322 9EB7 03           		inc	bc
 6323 9EB8 67           		ld	h,a
 6324 9EB9 22 A1 A1     		ld	(ESldAdd+1),hl
 6325 9EBC C9           		ret
 6326 9EBD
 6327 9EBD 0A           c_delay:	ld	a,(bc)
 6328 9EBE 03           		inc	bc
 6329 9EBF 32 42 A1     		ld	(delay),a
 6330 9EC2 32 1E A3     		ld	(DelyCnt),a ; bugfix by Lee_dC
 6331 9EC5 C9           		ret
 6332 9EC6
 6333 9EC6 DD 73 08     setenv:		ld	(ix-12+CHP.Env_En),e
 6334 9EC9 32 31 A3     		ld	(AYREGS+AR_EnvTp),a
 6335 9ECC 0A           		ld	a,(bc)
 6336 9ECD 03           		inc	bc
 6337 9ECE 67           		ld	h,a
 6338 9ECF 0A           		ld	a,(bc)
 6339 9ED0 03           		inc	bc
 6340 9ED1 6F           		ld	l,a
 6341 9ED2 22 32 A3     		ld	(EnvBase),hl
 6342 9ED5 AF           		xor	a
 6343 9ED6 DD 77 F4     		ld	(ix-12+CHP.PsInOr),a
 6344 9ED9 32 21 A3     		ld	(CurEDel),a
 6345 9EDC 67           		ld	h,a
 6346 9EDD 6F           		ld	l,a
 6347 9EDE 22 1F A3     		ld	(CurESld),hl
 6348 9EE1 C9           c_nop:		ret
 6349 9EE2
 6350 9EE2 87           setorn:		add	a,a
 6351 9EE3 5F           		ld	e,a
 6352 9EE4 16 00        		ld	d,0
 6353 9EE6 DD 72 F4     		ld	(ix-12+CHP.PsInOr),d
 6354 9EE9 21 21 21     OrnPtrs:	ld	hl,#2121
 6355 9EEC 19           		add	hl,de
 6356 9EED 5E           		ld	e,(hl)
 6357 9EEE 23           		inc	hl
 6358 9EEF 56           		ld	d,(hl)
 6359 9EF0 21 21 21     mdaddr2:	ld	hl,#2121
 6360 9EF3 19           		add	hl,de
 6361 9EF4 DD 75 01     		ld	(ix-12+CHP.OrnPtr),l
 6362 9EF7 DD 74 02     		ld	(ix-12+CHP.OrnPtr+1),h
 6363 9EFA C9           		ret
 6364 9EFB
 6365 9EFB 87           setsam:		add	a,a
 6366 9EFC 5F           		ld	e,a
 6367 9EFD 16 00        		ld	d,0
 6368 9EFF 21 21 21     SamPtrs:	ld	hl,#2121
 6369 9F02 19           		add	hl,de
 6370 9F03 5E           		ld	e,(hl)
 6371 9F04 23           		inc	hl
 6372 9F05 56           		ld	d,(hl)
 6373 9F06 21 21 21     mdaddr1:	ld	hl,#2121
 6374 9F09 19           		add	hl,de
 6375 9F0A DD 75 03     		ld	(ix-12+CHP.SamPtr),l
 6376 9F0D DD 74 04     		ld	(ix-12+CHP.SamPtr+1),h
 6377 9F10 C9           		ret
 6378 9F11
 6379 9F11              ; all 16 addresses filled to protect from broken pt3 modules
 6380 9F11 E1 9E        spccoms:	dw	c_nop
 6381 9F13 6A 9E        		dw	c_gliss
 6382 9F15 F6 9D        		dw	c_portm
 6383 9F17 87 9E        		dw	c_smpos
 6384 9F19 8D 9E        		dw	c_orpos
 6385 9F1B 93 9E        		dw	c_vibrt
 6386 9F1D E1 9E        		dw	c_nop
 6387 9F1F E1 9E        		dw	c_nop
 6388 9F21 AB 9E        		dw	c_engls
 6389 9F23 BD 9E        		dw	c_delay
 6390 9F25 E1 9E        		dw	c_nop
 6391 9F27 E1 9E        		dw	c_nop
 6392 9F29 E1 9E        		dw	c_nop
 6393 9F2B E1 9E        		dw	c_nop
 6394 9F2D E1 9E        		dw	c_nop
 6395 9F2F E1 9E        		dw	c_nop
 6396 9F31
 6397 9F31 AF           chregs:		xor	a
 6398 9F32 32 2E A3     		ld	(Ampl),a
 6399 9F35 DD CB 15 46  		bit	0,(ix+CHP.Flags)
 6400 9F39 E5           		push	hl
 6401 9F3A CA 8E A0     		jp	z,ch_exit
 6402 9F3D ED 73 CB 9F  		ld	(csp_+1),sp
 6403 9F41 DD 6E 0D     		ld	l,(ix+CHP.OrnPtr)
 6404 9F44 DD 66 0E     		ld	h,(ix+CHP.OrnPtr+1)
 6405 9F47 F9           		ld	sp,hl
 6406 9F48 D1           		pop	de
 6407 9F49 67           		ld	h,a
 6408 9F4A DD 7E 00     		ld	a,(ix+CHP.PsInOr)
 6409 9F4D 6F           		ld	l,a
 6410 9F4E 39           		add	hl,sp
 6411 9F4F 3C           		inc	a			; PT2	| PT3
 6412 9F50 BA           OrnCP:		cp	d			; cp e	| cp d
 6413 9F51 38 01        		jr	c,ch_orps
 6414 9F53 7B           OrnLD:		ld	a,e			; a,d	| a,e
 6415 9F54 DD 77 00     ch_orps:	ld	(ix+CHP.PsInOr),a
 6416 9F57 DD 7E 12     		ld	a,(ix+CHP.Note)
 6417 9F5A 86           		add	a,(hl)
 6418 9F5B F2 5F 9F     		jp	p,ch_ntp
 6419 9F5E AF           		xor	a
 6420 9F5F FE 60        ch_ntp:		cp	96
 6421 9F61 38 02        		jr	c,ch_nok
 6422 9F63 3E 5F        		ld	a,95
 6423 9F65 87           ch_nok:		add	a,a
 6424 9F66 08           		ex	af,af'
 6425 9F67 DD 6E 0F     		ld	l,(ix+CHP.SamPtr)
 6426 9F6A DD 66 10     		ld	h,(ix+CHP.SamPtr+1)
 6427 9F6D F9           		ld	sp,hl
 6428 9F6E D1           		pop	de
 6429 9F6F 26 00        		ld	h,0
 6430 9F71 DD 7E 01     		ld	a,(ix+CHP.PsInSm)
 6431 9F74 47           		ld	b,a
 6432 9F75 87           		add	a,a			; PT2	| PT3
 6433 9F76 87           SamClc2:	add	a,a			; a,b	| a,a
 6434 9F77 6F           		ld	l,a
 6435 9F78 39           		add	hl,sp
 6436 9F79 F9           		ld	sp,hl
 6437 9F7A 78           		ld	a,b
 6438 9F7B 3C           		inc	a
 6439 9F7C BA           SamCP:		cp	d			; cp e	| cp d
 6440 9F7D 38 01        		jr	c,ch_smps
 6441 9F7F 7B           SamLD:		ld	a,e			; a,d	| a,e
 6442 9F80 DD 77 01     ch_smps:	ld	(ix+CHP.PsInSm),a
 6443 9F83 C1           		pop	bc
 6444 9F84 E1           		pop	hl
 6445 9F85              						; PT2     | PT3
 6446 9F85 18 1F        SamCnv:		jr	smp_			; bit 2,c | jr smp_
 6447 9F87
 6448 9F87 60           		ld	h,b			; Convert PT2 sample to PT3
 6449 9F88 20 06        		jr	nz,SamCnv1
 6450 9F8A EB           		ex	de,hl
 6451 9F8B A7           		and	a
 6452 9F8C ED 62        		sbc	hl,hl
 6453 9F8E ED 52        		sbc	hl,de
 6454 9F90 51           SamCnv1:	ld	d,c
 6455 9F91 CB 19        		rr	c
 6456 9F93 9F           		sbc	a,a
 6457 9F94 2F           		cpl
 6458 9F95 E6 3E        		and	#3E
 6459 9F97 CB 19        		rr	c
 6460 9F99 CB 18        		rr	b
 6461 9F9B A1           		and	c
 6462 9F9C 4F           		ld	c,a
 6463 9F9D 78           		ld	a,b
 6464 9F9E 1F           		rra
 6465 9F9F 1F           		rra
 6466 9FA0 CB 1A        		rr	d
 6467 9FA2 1F           		rra
 6468 9FA3 E6 9F        		and	#9F
 6469 9FA5 47           		ld	b,a
 6470 9FA6
 6471 9FA6 DD 5E 08     smp_:		ld	e,(ix+CHP.TnAcc)
 6472 9FA9 DD 56 09     		ld	d,(ix+CHP.TnAcc+1)
 6473 9FAC 19           		add	hl,de
 6474 9FAD CB 70        		bit	6,b
 6475 9FAF 28 06        		jr	z,ch_noac
 6476 9FB1 DD 75 08     		ld	(ix+CHP.TnAcc),l
 6477 9FB4 DD 74 09     		ld	(ix+CHP.TnAcc+1),h
 6478 9FB7 EB           ch_noac:	ex	de,hl
 6479 9FB8 08           		ex	af,af'
 6480 9FB9 6F           		ld	l,a
 6481 9FBA 26 00        		ld	h,0
 6482 9FBC 31 24 A4     		ld	sp,NT_
 6483 9FBF 39           		add	hl,sp
 6484 9FC0 F9           		ld	sp,hl
 6485 9FC1 E1           		pop	hl
 6486 9FC2 19           		add	hl,de
 6487 9FC3 DD 5E 06     		ld	e,(ix+CHP.CrTnSl)
 6488 9FC6 DD 56 07     		ld	d,(ix+CHP.CrTnSl+1)
 6489 9FC9 19           		add	hl,de
 6490 9FCA 31 31 31     csp_:		ld	sp,#3131
 6491 9FCD E3           		ex	(sp),hl
 6492 9FCE AF           		xor	a
 6493 9FCF DD B6 05     		or	(ix+CHP.TSlCnt)
 6494 9FD2 28 3E        		jr	z,ch_amp
 6495 9FD4 DD 35 05     		dec	(ix+CHP.TSlCnt)
 6496 9FD7 20 39        		jr	nz,ch_amp
 6497 9FD9 DD 7E 16     		ld	a,(ix+CHP.TnSlDl)
 6498 9FDC DD 77 05     		ld	(ix+CHP.TSlCnt),a
 6499 9FDF DD 6E 17     		ld	l,(ix+CHP.TSlStp)
 6500 9FE2 DD 66 18     		ld	h,(ix+CHP.TSlStp+1)
 6501 9FE5 7C           		ld	a,h
 6502 9FE6 19           		add	hl,de
 6503 9FE7 DD 75 06     		ld	(ix+CHP.CrTnSl),l
 6504 9FEA DD 74 07     		ld	(ix+CHP.CrTnSl+1),h
 6505 9FED DD CB 15 56  		bit	2,(ix+CHP.Flags)
 6506 9FF1 20 1F        		jr	nz,ch_amp
 6507 9FF3 DD 5E 19     		ld	e,(ix+CHP.TnDelt)
 6508 9FF6 DD 56 1A     		ld	d,(ix+CHP.TnDelt+1)
 6509 9FF9 A7           		and	a
 6510 9FFA 28 01        		jr	z,ch_stpp
 6511 9FFC EB           		ex	de,hl
 6512 9FFD ED 52        ch_stpp:	sbc	hl,de
 6513 9FFF FA 12 A0     		jp	m,ch_amp
 6514 A002 DD 7E 13     		ld	a,(ix+CHP.SlToNt)
 6515 A005 DD 77 12     		ld	(ix+CHP.Note),a
 6516 A008 AF           		xor	a
 6517 A009 DD 77 05     		ld	(ix+CHP.TSlCnt),a
 6518 A00C DD 77 06     		ld	(ix+CHP.CrTnSl),a
 6519 A00F DD 77 07     		ld	(ix+CHP.CrTnSl+1),a
 6520 A012 DD 7E 02     ch_amp:		ld	a,(ix+CHP.CrAmSl)
 6521 A015 CB 79        		bit	7,c
 6522 A017 28 13        		jr	z,ch_noam
 6523 A019 CB 71        		bit	6,c
 6524 A01B 28 07        		jr	z,ch_amin
 6525 A01D FE 0F        		cp	15
 6526 A01F 28 0B        		jr	z,ch_noam
 6527 A021 3C           		inc	a
 6528 A022 18 05        		jr	ch_svam
 6529 A024 FE F1        ch_amin:	cp	-15
 6530 A026 28 04        		jr	z,ch_noam
 6531 A028 3D           		dec	a
 6532 A029 DD 77 02     ch_svam:	ld	(ix+CHP.CrAmSl),a
 6533 A02C 6F           ch_noam:	ld	l,a
 6534 A02D 78           		ld	a,b
 6535 A02E E6 0F        		and	15
 6536 A030 85           		add	a,l
 6537 A031 F2 35 A0     		jp	p,ch_apos
 6538 A034 AF           		xor	a
 6539 A035 FE 10        ch_apos:	cp	16
 6540 A037 38 02        		jr	c,ch_vol
 6541 A039 3E 0F        		ld	a,15
 6542 A03B DD B6 1C     ch_vol:		or	(ix+CHP.Volume)
 6543 A03E 6F           		ld	l,a
 6544 A03F 26 00        		ld	h,0
 6545 A041 11 24 A3     		ld	de,VT_
 6546 A044 19           		add	hl,de
 6547 A045 5E           		ld	e,(hl)
 6548 A046 3E 00        GlobalAttn:	ld	a,0		; GLOBAL ATTENUATION
 6549 A048 FE 08        		cp	8		; if value of attenuation is higher
 6550 A04A 38 02        		jr	c,ch_globvol	; then this value we will stop
 6551 A04C CB C1        		set	0,c		; also envelopes (bit.0 in flags)...
 6552 A04E 93           ch_globvol:	sub	e
 6553 A04F 38 01        		jr	c,ch_env
 6554 A051 AF           		xor	a
 6555 A052 ED 44        ch_env:		neg
 6556 A054 CB 41        		bit	0,c
 6557 A056 20 03        		jr	nz,ch_noen
 6558 A058 DD B6 14     		or	(ix+CHP.Env_En)
 6559 A05B 32 2E A3     ch_noen:	ld	(Ampl),a
 6560 A05E CB 78        		bit	7,b
 6561 A060 79           		ld	a,c
 6562 A061 28 19        		jr	z,no_ensl
 6563 A063 17           		rla
 6564 A064 17           		rla
 6565 A065 CB 2F        		sra	a
 6566 A067 CB 2F        		sra	a
 6567 A069 CB 2F        		sra	a
 6568 A06B DD 86 04     		add	a,(ix+CHP.CrEnSl)
 6569 A06E CB 68        		bit	5,b
 6570 A070 28 03        		jr	z,no_enac
 6571 A072 DD 77 04     		ld	(ix+CHP.CrEnSl),a
 6572 A075 21 82 A1     no_enac:	ld	hl,AddToEn+1
 6573 A078 86           		add	a,(hl)
 6574 A079 77           		ld	(hl),a
 6575 A07A 18 0E        		jr	ch_mix
 6576 A07C
 6577 A07C 1F           no_ensl:	rra
 6578 A07D DD 86 03     		add	a,(ix+CHP.CrNsSl)
 6579 A080 32 23 A3     		ld	(AddToNs),a
 6580 A083 CB 68        		bit	5,b
 6581 A085 28 03        		jr	z,ch_mix
 6582 A087 DD 77 03     		ld	(ix+CHP.CrNsSl),a
 6583 A08A 78           ch_mix:		ld	a,b
 6584 A08B 1F           		rra
 6585 A08C E6 48        		and	#48
 6586 A08E 21 2B A3     ch_exit:	ld	hl,AYREGS+AR_Mixer
 6587 A091 B6           		or	(hl)
 6588 A092 0F           		rrca
 6589 A093 77           		ld	(hl),a
 6590 A094 E1           		pop	hl
 6591 A095 AF           		xor	a
 6592 A096 DD B6 0A     		or	(ix+CHP.COnOff)
 6593 A099 C8           		ret	z
 6594 A09A DD 35 0A     		dec	(ix+CHP.COnOff)
 6595 A09D C0           		ret	nz
 6596 A09E DD AE 15     		xor	(ix+CHP.Flags)
 6597 A0A1 DD 77 15     		ld	(ix+CHP.Flags),a
 6598 A0A4 1F           		rra
 6599 A0A5 DD 7E 0B     		ld	a,(ix+CHP.OnOffD)
 6600 A0A8 38 03        		jr	c,ch_ondl
 6601 A0AA DD 7E 0C     		ld	a,(ix+CHP.OffOnD)
 6602 A0AD DD 77 0A     ch_ondl:	ld	(ix+CHP.COnOff),a
 6603 A0B0 C9           		ret
 6604 A0B1
 6605 A0B1              ;------------------------------------------------------------------------------
 6606 A0B1 AF           music_play:	xor	a
 6607 A0B2 32 82 A1     		ld	(AddToEn+1),a
 6608 A0B5 32 2B A3     		ld	(AYREGS+AR_Mixer),a
 6609 A0B8 3D           		dec	a
 6610 A0B9 32 31 A3     		ld	(AYREGS+AR_EnvTp),a
 6611 A0BC 21 1E A3     		ld	hl,DelyCnt
 6612 A0BF 35           		dec	(hl)
 6613 A0C0 C2 46 A1     		jp	nz,pl2
 6614 A0C3 CD FB A1     		call	chkfadeout
 6615 A0C6 21 E2 A2     		ld	hl,ChanA+CHP.NtSkCn
 6616 A0C9 35           		dec	(hl)
 6617 A0CA 20 4D        		jr	nz,pl1b
 6618 A0CC 01 01 01     AdInPtA:	ld	bc,#0101
 6619 A0CF 0A           		ld	a,(bc)
 6620 A0D0 A7           		and	a
 6621 A0D1 20 3B        		jr	nz,pl1a
 6622 A0D3 57           		ld	d,a
 6623 A0D4 32 22 A3     		ld	(Ns_base),a
 6624 A0D7 21 21 21     CrPsPtr:	ld	hl,#2121
 6625 A0DA 23           		inc	hl
 6626 A0DB 7E           		ld	a,(hl)
 6627 A0DC 3C           		inc	a
 6628 A0DD 20 08        		jr	nz,plnlp
 6629 A0DF CD C5 A1     		call	checklp
 6630 A0E2 21 21 21     LPosPtr:	ld	hl,#2121
 6631 A0E5 7E           		ld	a,(hl)
 6632 A0E6 3C           		inc	a
 6633 A0E7 22 D8 A0     plnlp:		ld	(CrPsPtr+1),hl
 6634 A0EA 3D           		dec	a			; PT2		PT3
 6635 A0EB 00           PsCalc:		nop				; add a,a	nop
 6636 A0EC 00           		nop				; add a,(hl)	nop
 6637 A0ED 87           		add	a,a
 6638 A0EE 5F           		ld	e,a
 6639 A0EF CB 12        		rl	d
 6640 A0F1 21 21 21     PatsPtr:	ld	hl,#2121
 6641 A0F4 19           		add	hl,de
 6642 A0F5 11 11 11     modaddr:	ld	de,#1111
 6643 A0F8 ED 73 0C A1  		ld	(psp_+1),sp
 6644 A0FC F9           		ld	sp,hl
 6645 A0FD E1           		pop	hl
 6646 A0FE 19           		add	hl,de
 6647 A0FF 44           		ld	b,h
 6648 A100 4D           		ld	c,l
 6649 A101 E1           		pop	hl
 6650 A102 19           		add	hl,de
 6651 A103 22 24 A1     		ld	(AdInPtB+1),hl
 6652 A106 E1           		pop	hl
 6653 A107 19           		add	hl,de
 6654 A108 22 38 A1     		ld	(AdInPtC+1),hl
 6655 A10B 31 31 31     psp_:		ld	sp,#3131
 6656 A10E DD 21 D3 A2  pl1a:		ld	ix,ChanA+12
 6657 A112 CD 4B 9D     		call	ptdecode
 6658 A115 ED 43 CD A0  		ld	(AdInPtA+1),bc
 6659 A119
 6660 A119 21 FF A2     pl1b:		ld	hl,ChanB+CHP.NtSkCn
 6661 A11C 35           		dec	(hl)
 6662 A11D 20 0E        		jr	nz,pl1c
 6663 A11F DD 21 F0 A2  		ld	ix,ChanB+12
 6664 A123 01 01 01     AdInPtB:	ld	bc,#0101
 6665 A126 CD 4B 9D     		call	ptdecode
 6666 A129 ED 43 24 A1  		ld	(AdInPtB+1),bc
 6667 A12D
 6668 A12D 21 1C A3     pl1c:		ld	hl,ChanC+CHP.NtSkCn
 6669 A130 35           		dec	(hl)
 6670 A131 20 0E        		jr	nz,pl1d
 6671 A133 DD 21 0D A3  		ld	ix,ChanC+12
 6672 A137 01 01 01     AdInPtC:	ld	bc,#0101
 6673 A13A CD 4B 9D     		call	ptdecode
 6674 A13D ED 43 38 A1  		ld	(AdInPtC+1),bc
 6675 A141              delay:		equ	$+1
 6676 A141 3E 3E        pl1d:		ld	a,#3E
 6677 A143 32 1E A3     		ld	(DelyCnt),a
 6678 A146 DD 21 C7 A2  pl2:		ld	ix,ChanA
 6679 A14A 2A 24 A3     		ld	hl,(AYREGS+AR_TonA)
 6680 A14D CD 31 9F     		call	chregs
 6681 A150 22 24 A3     		ld	(AYREGS+AR_TonA),hl
 6682 A153
 6683 A153 3A 2E A3     		ld	a,(Ampl)
 6684 A156 32 2C A3     		ld	(AYREGS+AR_AmplA),a
 6685 A159 DD 21 E4 A2  		ld	ix,ChanB
 6686 A15D 2A 26 A3     		ld	hl,(AYREGS+AR_TonB)
 6687 A160 CD 31 9F     		call	chregs
 6688 A163 22 26 A3     		ld	(AYREGS+AR_TonB),hl
 6689 A166
 6690 A166 3A 2E A3     		ld	a,(Ampl)
 6691 A169 32 2D A3     		ld	(AYREGS+AR_AmplB),a
 6692 A16C DD 21 01 A3  		ld	ix,ChanC
 6693 A170 2A 28 A3     		ld	hl,(AYREGS+AR_TonC)
 6694 A173 CD 31 9F     		call	chregs
 6695 A176 22 28 A3     		ld	(AYREGS+AR_TonC),hl
 6696 A179
 6697 A179 2A 22 A3     		ld	hl,(Ns_base) ; read together with AddToNs
 6698 A17C 7C           		ld	a,h
 6699 A17D 85           		add	a,l
 6700 A17E 32 2A A3     		ld	(AYREGS+AR_Noise),a
 6701 A181
 6702 A181 3E 3E        AddToEn:	ld	a,#3E
 6703 A183 5F           		ld	e,a
 6704 A184 87           		add	a,a
 6705 A185 9F           		sbc	a,a
 6706 A186 57           		ld	d,a
 6707 A187 2A 32 A3     		ld	hl,(EnvBase)
 6708 A18A 19           		add	hl,de
 6709 A18B ED 5B 1F A3  		ld	de,(CurESld)
 6710 A18F 19           		add	hl,de
 6711 A190 22 2F A3     		ld	(AYREGS+AR_Env),hl
 6712 A193
 6713 A193 AF           		xor	a
 6714 A194 21 21 A3     		ld	hl,CurEDel
 6715 A197 B6           		or	(hl)
 6716 A198 28 0E        		jr	z,rout_a0
 6717 A19A 35           		dec	(hl)
 6718 A19B 20 0A        		jr	nz,rout
 6719 A19D 3E 3E        Env_Del:	ld	a,#3E
 6720 A19F 77           		ld	(hl),a
 6721 A1A0 21 21 21     ESldAdd:	ld	hl,#2121
 6722 A1A3 19           		add	hl,de
 6723 A1A4 22 1F A3     		ld	(CurESld),hl
 6724 A1A7
 6725 A1A7 AF           rout:		xor	a
 6726 A1A8 11 BF FF     rout_a0:	ld	de,#FFBF
 6727 A1AB 01 FD FF     		ld	bc,#FFFD
 6728 A1AE 21 24 A3     		ld	hl,AYREGS
 6729 A1B1 ED 79        lout:		out	(c),a
 6730 A1B3 43           		ld	b,e
 6731 A1B4 ED A3        		outi
 6732 A1B6 42           		ld	b,d
 6733 A1B7 3C           		inc	a
 6734 A1B8 FE 0D        		cp	#0D
 6735 A1BA 20 F5        		jr	nz,lout
 6736 A1BC ED 79        		out	(c),a
 6737 A1BE 7E           		ld	a,(hl)
 6738 A1BF A7           		and	a
 6739 A1C0 F8           		ret	m
 6740 A1C1 43           		ld	b,e
 6741 A1C2 ED 79        		out	(c),a
 6742 A1C4 C9           		ret
 6743 A1C5
 6744 A1C5 21 3E A2     checklp:	ld	hl,music_setup
 6745 A1C8 CB 4E        		bit	1,(hl)
 6746 A1CA 20 19        		jr	nz,enablefade
 6747 A1CC CB 46        		bit	0,(hl)
 6748 A1CE C8           		ret	z
 6749 A1CF
 6750 A1CF CB FE        noloop:		set	7,(hl)
 6751 A1D1 E1           deadend:	pop	hl
 6752 A1D2 21 1E A3     		ld	hl,DelyCnt
 6753 A1D5 34           		inc	(hl)
 6754 A1D6 21 E2 A2     		ld	hl,ChanA+CHP.NtSkCn
 6755 A1D9 34           		inc	(hl)
 6756 A1DA
 6757 A1DA AF           music_mute:	xor	a
 6758 A1DB 67           		ld	h,a
 6759 A1DC 6F           		ld	l,a
 6760 A1DD 32 2C A3     		ld	(AYREGS+AR_AmplA),a
 6761 A1E0 22 2D A3     		ld	(AYREGS+AR_AmplB),hl
 6762 A1E3 18 C3        		jr	rout_a0
 6763 A1E5
 6764 A1E5 3E 30        enablefade:	ld	a,48
 6765 A1E7 21 FC A1     forcefade:	ld	hl,chkfadeout+1
 6766 A1EA 34           		inc	(hl)
 6767 A1EB 2A D8 A0     		ld	hl,(CrPsPtr+1)
 6768 A1EE 22 2A A2     		ld	(resetfadeout+1),hl
 6769 A1F1 ED 43 30 A2  		ld	(resetfadeout1+1),bc
 6770 A1F5 32 06 A2     		ld	(countfadeout+1),a
 6771 A1F8 32 18 A2     		ld	(divfadeout+1),a
 6772 A1FB
 6773 A1FB 3E 00        chkfadeout:	ld	a,0
 6774 A1FD B7           		or	a
 6775 A1FE C8           		ret	z
 6776 A1FF 3A 3E A2     		ld	a,(music_setup)
 6777 A202 07           		rlca
 6778 A203 38 CC        		jr	c,deadend
 6779 A205 3E 3E        countfadeout:	ld	a,#3E
 6780 A207 3D           		dec	a
 6781 A208 32 06 A2     		ld	(countfadeout+1),a
 6782 A20B C0           		ret	nz
 6783 A20C 3A 47 A0     		ld	a,(GlobalAttn+1)
 6784 A20F 3C           		inc	a
 6785 A210 FE 10        		cp	16
 6786 A212 28 15        		jr	z,resetfadeout
 6787 A214 32 47 A0     		ld	(GlobalAttn+1),a
 6788 A217 3E 3E        divfadeout:	ld	a,#3E
 6789 A219 CB 3F        		srl	a
 6790 A21B 6F           		ld	l,a
 6791 A21C CB 3D        		srl	l
 6792 A21E 85           		add	a,l
 6793 A21F 20 01        		jr	nz,divfadeout1
 6794 A221 3C           		inc	a
 6795 A222 32 06 A2     divfadeout1:	ld	(countfadeout+1),a
 6796 A225 32 18 A2     		ld	(divfadeout+1),a
 6797 A228 C9           		ret
 6798 A229
 6799 A229 21 21 21     resetfadeout:	ld	hl,#2121
 6800 A22C 22 D8 A0     		ld	(CrPsPtr+1),hl
 6801 A22F 21 21 21     resetfadeout1:	ld	hl,#2121
 6802 A232 22 CD A0     		ld	(AdInPtA+1),hl
 6803 A235 AF           		xor	a
 6804 A236 32 E2 A2     		ld	(ChanA+CHP.NtSkCn),a
 6805 A239 21 3E A2     		ld	hl,music_setup
 6806 A23C 18 91        		jr	noloop
 6807 A23E
 6808 A23E
 6809 A23E              ; bit.0 if you want to play without looping
 6810 A23E              ; bit.1 if you play looped but fadeout after few seconds
 6811 A23E              ; bit.7 is set each time when loop is passed
 6812 A23E              ; ...or simplified:	2 - fadeout after loop
 6813 A23E              ;			1 - no loop
 6814 A23E              ;			0 - loop forever
 6815 A23E 02           music_setup:	db	2
 6816 A23F
 6817 A23F
 6818 A23F              ;------------------------------------------------------------------------------
 6819 A23F              ; note table data
 6820 A23F 64           nt_data:	db	(T_NEW_0-T1_)*2
 6821 A240 2A           		db	TCNEW_0-T_
 6822 A241 65           		db	(T_OLD_0-T1_)*2+1
 6823 A242 00           		db	TCOLD_0-T_
 6824 A243 01           		db	(T_NEW_1-T1_)*2+1
 6825 A244 0C           		db	TCNEW_1-T_
 6826 A245 01           		db	(T_OLD_1-T1_)*2+1
 6827 A246 0C           		db	TCOLD_1-T_
 6828 A247 94           		db	(T_NEW_2-T1_)*2
 6829 A248 35           		db	TCNEW_2-T_
 6830 A249 30           		db	(T_OLD_2-T1_)*2
 6831 A24A 0E           		db	TCOLD_2-T_
 6832 A24B 60           		db	(T_NEW_3-T1_)*2
 6833 A24C 20           		db	TCNEW_3-T_
 6834 A24D 60           		db	(T_OLD_3-T1_)*2
 6835 A24E 21           		db	TCOLD_3-T_
 6836 A24F              T_
 6837 A24F
 6838 A24F 01 05 09 0B  TCOLD_0		db	#00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
 6838 A253 0D 0F 13 15
 6839 A257 19 25 3D 00  		db	#18+1,#24+1,#3C+1,0
 6840 A25B 5D 00        TCOLD_1		db	#5C+1,0
 6841 A25D 31 37 4D 53  TCOLD_2		db	#30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
 6841 A261 5F 71 82 8C
 6841 A265 9C
 6842 A266 9E A0 A6 A8  		db	#9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
 6842 A26A AA AC AE AE
 6842 A26E 00
 6843 A26F 57           TCNEW_3		db	#56+1
 6844 A270 1F 23 25 29  TCOLD_3		db	#1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
 6844 A274 2D 2F 33 BF
 6844 A278 00
 6845 A279 1D 21 23 27  TCNEW_0		db	#1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
 6845 A27D 2B 2D 31 55
 6846 A281 BD BF 00     		db	#BC+1,#BE+1,0
 6847 A284              TCNEW_1		equ	TCOLD_1
 6848 A284 1B 21 25 29  TCNEW_2		db	#1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
 6848 A288 2B 3B 4D 5F
 6849 A28C BB BD BF 00  		db	#BA+1,#BC+1,#BE+1,0
 6850 A290
 6851 A290              PT3_EmptySmpOrn	equ	$-1
 6852 A290 01 00        		db	1,0 ;#90 ; delete #90 if you don't need default sample
 6853 A292
 6854 A292              PT2_EmptySmpOrn	equ	VT_+31 ; 1,0,0 sequence
 6855 A292
 6856 A292              ; first 12 values of tone tables (packed)
 6857 A292 0D D8        T_PACK		db	high (#06EC*2), low (#06EC*2)
 6858 A294 69           		db	#0755-#06EC
 6859 A295 70           		db	#07C5-#0755
 6860 A296 76           		db	#083B-#07C5
 6861 A297 7D           		db	#08B8-#083B
 6862 A298 85           		db	#093D-#08B8
 6863 A299 8D           		db	#09CA-#093D
 6864 A29A 95           		db	#0A5F-#09CA
 6865 A29B 9D           		db	#0AFC-#0A5F
 6866 A29C A8           		db	#0BA4-#0AFC
 6867 A29D B1           		db	#0C55-#0BA4
 6868 A29E BB           		db	#0D10-#0C55
 6869 A29F 0C DA        		db	high (#066D*2), low (#066D*2)
 6870 A2A1 62           		db	#06CF-#066D
 6871 A2A2 68           		db	#0737-#06CF
 6872 A2A3 6D           		db	#07A4-#0737
 6873 A2A4 75           		db	#0819-#07A4
 6874 A2A5 7B           		db	#0894-#0819
 6875 A2A6 83           		db	#0917-#0894
 6876 A2A7 8A           		db	#09A1-#0917
 6877 A2A8 92           		db	#0A33-#09A1
 6878 A2A9 9C           		db	#0ACF-#0A33
 6879 A2AA A4           		db	#0B73-#0ACF
 6880 A2AB AF           		db	#0C22-#0B73
 6881 A2AC B8           		db	#0CDA-#0C22
 6882 A2AD 0E 08        		db	high (#0704*2), low (#0704*2)
 6883 A2AF 6A           		db	#076E-#0704
 6884 A2B0 72           		db	#07E0-#076E
 6885 A2B1 78           		db	#0858-#07E0
 6886 A2B2 7E           		db	#08D6-#0858
 6887 A2B3 86           		db	#095C-#08D6
 6888 A2B4 90           		db	#09EC-#095C
 6889 A2B5 96           		db	#0A82-#09EC
 6890 A2B6 A0           		db	#0B22-#0A82
 6891 A2B7 AA           		db	#0BCC-#0B22
 6892 A2B8 B4           		db	#0C80-#0BCC
 6893 A2B9 BE           		db	#0D3E-#0C80
 6894 A2BA 0F C0        		db	high (#07E0*2), low (#07E0*2)
 6895 A2BC 78           		db	#0858-#07E0
 6896 A2BD 88           		db	#08E0-#0858
 6897 A2BE 80           		db	#0960-#08E0
 6898 A2BF 90           		db	#09F0-#0960
 6899 A2C0 98           		db	#0A88-#09F0
 6900 A2C1 A0           		db	#0B28-#0A88
 6901 A2C2 B0           		db	#0BD8-#0B28
 6902 A2C3 A8           		db	#0C80-#0BD8
 6903 A2C4 E0           		db	#0D60-#0C80
 6904 A2C5 B0           		db	#0E10-#0D60
 6905 A2C6 E8           		db	#0EF8-#0E10
 6906 A2C7
 6907 A2C7              ; channel data offsets
 6908 A2C7              	struct CHP
 6909 A2C7 ~            PsInOr		byte
 6910 A2C7 ~            PsInSm		byte
 6911 A2C7 ~            CrAmSl		byte
 6912 A2C7 ~            CrNsSl		byte
 6913 A2C7 ~            CrEnSl		byte
 6914 A2C7 ~            TSlCnt		byte
 6915 A2C7 ~            CrTnSl		word
 6916 A2C7 ~            TnAcc		word
 6917 A2C7 ~            COnOff		byte
 6918 A2C7 ~            OnOffD		byte
 6919 A2C7 ~            OffOnD		byte	; IX for PTDECOD here (+12)
 6920 A2C7 ~            OrnPtr		word
 6921 A2C7 ~            SamPtr		word
 6922 A2C7 ~            NNtSkp		byte
 6923 A2C7 ~            Note		byte
 6924 A2C7 ~            SlToNt		byte
 6925 A2C7 ~            Env_En		byte
 6926 A2C7 ~            Flags		byte
 6927 A2C7 ~            TnSlDl		byte	; Enabled - 0, SimpleGliss - 2
 6928 A2C7 ~            TSlStp		word
 6929 A2C7 ~            TnDelt		word
 6930 A2C7 ~            NtSkCn		byte
 6931 A2C7 ~            Volume		byte
 6932 A2C7              	ends
 6933 A2C7
 6934 A2C7              AR_TonA		equ	0	; word 1
 6935 A2C7              AR_TonB		equ	2	; word 1
 6936 A2C7              AR_TonC		equ	4	; word 1
 6937 A2C7              AR_Noise	equ	6	; byte 1
 6938 A2C7              AR_Mixer	equ	7	; byte 1
 6939 A2C7              AR_AmplA	equ	8	; byte 1
 6940 A2C7              AR_AmplB	equ	9	; byte 1
 6941 A2C7              AR_AmplC	equ	10	; byte 1
 6942 A2C7              AR_Env		equ	11	; word 1
 6943 A2C7              AR_EnvTp	equ	13	; byte 1
 6944 A2C7              AR_Size		equ	14
 6945 A2C7
 6946 A2C7
 6947 A2C7              ;------------------------------------------------------------------------------
 6948 A2C7              ; variables are 541 bytes long
 6949 A2C7              VARS
 6950 A2C7 00 00 00...  ChanA		ds	29
 6951 A2E4 00 00 00...  ChanB		ds	29
 6952 A301 00 00 00...  ChanC		ds	29
 6953 A31E
 6954 A31E
 6955 A31E              ; GlobalVars
 6956 A31E 00           DelyCnt		db	0
 6957 A31F 00 00        CurESld		dw	0
 6958 A321 00           CurEDel		db	0
 6959 A322 00           Ns_base		db	0
 6960 A323 00           AddToNs		db	0
 6961 A324
 6962 A324              AYREGS		equ	$
 6963 A324              Ampl		equ	AYREGS+AR_AmplC
 6964 A324
 6965 A324 00 00 00...  VT_		ds	256		; Volume Table
 6966 A424 00 00 00...  NT_		ds	192		; Note Table
 6967 A4E4
 6968 A4E4              EnvBase		equ	VT_+14
 6969 A4E4              T1_		equ	VT_+16		; Tone tables data depacked here
 6970 A4E4              T_OLD_1		equ	T1_
 6971 A4E4              T_OLD_2		equ	T_OLD_1+24
 6972 A4E4              T_OLD_3		equ	T_OLD_2+24
 6973 A4E4              T_OLD_0		equ	T_OLD_3+2
 6974 A4E4              T_NEW_0		equ	T_OLD_0
 6975 A4E4              T_NEW_1		equ	T_OLD_1
 6976 A4E4              T_NEW_2		equ	T_NEW_0+24
 6977 A4E4              T_NEW_3		equ	T_OLD_3
 6978 A4E4
 6979 A4E4              VAR0END		equ	T1_		; init zeroes from VARS to VAR0END-1
 6980 A4E4              VARSEND		equ	$
 6981 A4E4
 6982 A4E4
 6983 A4E4
 6984 A4E4              		module stc
 6985 A4E4
 6986 A4E4 21 26 BD     music_init:	ld	hl,songdata
 6987 A4E7 7E           music_init0:	ld	a,(hl)
 6988 A4E8 32 7A A8     		ld	(speed),a
 6989 A4EB 22 5F A5     		ld	(module_addr+1),hl
 6990 A4EE 23           		inc	hl
 6991 A4EF CD 59 A5     		call	add_offset
 6992 A4F2 1A           		ld	a,(de)
 6993 A4F3 13           		inc	de
 6994 A4F4 3C           		inc	a
 6995 A4F5 32 7C A8     		ld	(song_length),a
 6996 A4F8 ED 53 72 A8  		ld	(positions),de
 6997 A4FC CD 59 A5     		call	add_offset
 6998 A4FF ED 53 74 A8  		ld	(ornaments),de
 6999 A503 D5           		push	de
 7000 A504 CD 59 A5     		call	add_offset
 7001 A507 ED 53 76 A8  		ld	(patterns),de
 7002 A50B 21 1B 00     		ld	hl,HEADLEN
 7003 A50E CD 5E A5     		call	module_addr
 7004 A511 EB           		ex	de,hl
 7005 A512 22 78 A8     		ld	(samples),hl
 7006 A515 21 83 A8     		ld	hl,empty_pattern
 7007 A518 22 7D A8     		ld	(chn1_pattptr),hl
 7008 A51B 23           		inc	hl
 7009 A51C 11 85 A8     		ld	de,CHN1+1
 7010 A51F 01 1F 00     		ld	bc,VARSLEN
 7011 A522 70           		ld	(hl),b
 7012 A523 ED B0        		ldir
 7013 A525 E1           		pop	hl
 7014 A526 01 21 00     		ld	bc,ORNALEN
 7015 A529 AF           		xor	a
 7016 A52A CD 54 A5     		call	scan_until
 7017 A52D 32 CE A7     		ld	(apply_volenv+1),a
 7018 A530 32 45 A8     		ld	(chkfadeout+1),a
 7019 A533 3D           		dec	a
 7020 A534 32 8D A8     		ld	(CHN1+CHP.SmpCnt),a
 7021 A537 32 97 A8     		ld	(CHN2+CHP.SmpCnt),a
 7022 A53A 32 A1 A8     		ld	(CHN3+CHP.SmpCnt),a
 7023 A53D 3E 01        		ld	a,1
 7024 A53F 32 7B A8     		ld	(tempo_cnt),a
 7025 A542 23           		inc	hl
 7026 A543 22 8B A8     		ld	(CHN1+CHP.OrnPtr),hl
 7027 A546 22 95 A8     		ld	(CHN2+CHP.OrnPtr),hl
 7028 A549 22 9F A8     		ld	(CHN3+CHP.OrnPtr),hl
 7029 A54C 21 3E A2     		ld	hl,music_setup
 7030 A54F CB BE        		res	7,(hl)
 7031 A551 C3 AF A6     		jp	music_mute
 7032 A554
 7033 A554 BE           scan_until:	cp	(hl)
 7034 A555 C8           		ret	z
 7035 A556 09           		add	hl,bc
 7036 A557 18 FB        		jr	scan_until
 7037 A559
 7038 A559 5E           add_offset:	ld	e,(hl)
 7039 A55A 23           		inc	hl
 7040 A55B 56           		ld	d,(hl)
 7041 A55C 23           		inc	hl
 7042 A55D EB           		ex	de,hl
 7043 A55E 01 00 00     module_addr:	ld	bc,0
 7044 A561 09           		add	hl,bc
 7045 A562 EB           		ex	de,hl
 7046 A563 C9           		ret
 7047 A564
 7048 A564 3A A2 A8     new_position:	ld	a,(current_pos)
 7049 A567 4F           		ld	c,a
 7050 A568 21 7C A8     		ld	hl,song_length
 7051 A56B BE           		cp	(hl)
 7052 A56C 38 0F        		jr	c,.continue
 7053 A56E 21 3E A2     		ld	hl,music_setup
 7054 A571 CB 4E        		bit	1,(hl)
 7055 A573 C4 39 A8     		call	nz,enablefade
 7056 A576 CB 46        		bit	0,(hl)
 7057 A578 C2 21 A8     		jp	nz,noloop
 7058 A57B AF           		xor	a
 7059 A57C 4F           		ld	c,a
 7060 A57D 3C           .continue:	inc	a
 7061 A57E 32 A2 A8     		ld	(current_pos),a
 7062 A581 69           		ld	l,c
 7063 A582 26 00        		ld	h,0
 7064 A584 29           		add	hl,hl
 7065 A585 ED 5B 72 A8  		ld	de,(positions)
 7066 A589 19           		add	hl,de
 7067 A58A 4E           		ld	c,(hl)
 7068 A58B 23           		inc	hl
 7069 A58C 7E           		ld	a,(hl)
 7070 A58D 32 03 A8     		ld	(get_frequency+1),a
 7071 A590 79           		ld	a,c
 7072 A591 2A 76 A8     		ld	hl,(patterns)
 7073 A594 01 07 00     		ld	bc,PATTLEN
 7074 A597 CD 54 A5     		call	scan_until
 7075 A59A 23           		inc	hl
 7076 A59B CD 59 A5     		call	add_offset
 7077 A59E ED 53 7D A8  		ld	(chn1_pattptr),de
 7078 A5A2 CD 59 A5     		call	add_offset
 7079 A5A5 ED 53 7F A8  		ld	(chn2_pattptr),de
 7080 A5A9 CD 59 A5     		call	add_offset
 7081 A5AC ED 53 81 A8  		ld	(chn3_pattptr),de
 7082 A5B0 C9           		ret
 7083 A5B1
 7084 A5B1 DD 35 04     adv_patt_step:	dec	(ix+CHP.PatStpCnt)
 7085 A5B4 F0           		ret	p
 7086 A5B5 DD 7E 01     		ld	a,(ix+CHP.PatStep)
 7087 A5B8 DD 77 04     		ld	(ix+CHP.PatStpCnt),a
 7088 A5BB C9           		ret
 7089 A5BC
 7090 A5BC              ;------------------------------------------------------------------------------
 7091 A5BC 3A 7B A8     music_play:	ld	a,(tempo_cnt)
 7092 A5BF 3D           		dec	a
 7093 A5C0 32 7B A8     		ld	(tempo_cnt),a
 7094 A5C3 20 47        		jr	nz,playback
 7095 A5C5 3A 7A A8     		ld	a,(speed)
 7096 A5C8 32 7B A8     		ld	(tempo_cnt),a
 7097 A5CB
 7098 A5CB DD 21 84 A8  .chn1:		ld	ix,CHN1
 7099 A5CF CD B1 A5     		call	adv_patt_step
 7100 A5D2 F2 E6 A5     		jp	p,.chn2
 7101 A5D5 2A 7D A8     		ld	hl,(chn1_pattptr)
 7102 A5D8 7E           		ld	a,(hl)
 7103 A5D9 3C           		inc	a
 7104 A5DA CC 64 A5     		call	z,new_position
 7105 A5DD 2A 7D A8     		ld	hl,(chn1_pattptr)
 7106 A5E0 CD F1 A6     		call	read_pattern
 7107 A5E3 22 7D A8     		ld	(chn1_pattptr),hl
 7108 A5E6
 7109 A5E6 DD 21 8E A8  .chn2:		ld	ix,CHN2
 7110 A5EA CD B1 A5     		call	adv_patt_step
 7111 A5ED F2 F9 A5     		jp	p,.chn3
 7112 A5F0 2A 7F A8     		ld	hl,(chn2_pattptr)
 7113 A5F3 CD F1 A6     		call	read_pattern
 7114 A5F6 22 7F A8     		ld	(chn2_pattptr),hl
 7115 A5F9
 7116 A5F9 DD 21 98 A8  .chn3:		ld	ix,CHN3
 7117 A5FD CD B1 A5     		call	adv_patt_step
 7118 A600 F2 0C A6     		jp	p,playback
 7119 A603 2A 81 A8     		ld	hl,(chn3_pattptr)
 7120 A606 CD F1 A6     		call	read_pattern
 7121 A609 22 81 A8     		ld	(chn3_pattptr),hl
 7122 A60C
 7123 A60C              ;------------------------------------------------------------------------------
 7124 A60C CD 44 A8     playback:	call	chkfadeout
 7125 A60F DD 21 84 A8  		ld	ix,CHN1
 7126 A613 CD 58 A7     		call	adv_sample
 7127 A616 79           		ld	a,c
 7128 A617 32 FB A7     		ld	(sample_index+1),a
 7129 A61A CD 8C A7     		call	read_sample
 7130 A61D 79           		ld	a,c
 7131 A61E B0           		or	b
 7132 A61F 0F           		rrca
 7133 A620 32 AA A8     		ld	(AYREGS+AR.Mixer),a
 7134 A623 DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7135 A626 3C           		inc	a
 7136 A627 28 09        		jr	z,.chn2
 7137 A629 CD C5 A7     		call	set_noise
 7138 A62C CD F1 A7     		call	get_tone
 7139 A62F 22 A3 A8     		ld	(AYREGS+AR.TonA),hl
 7140 A632
 7141 A632 21 AB A8     .chn2:		ld	hl,AYREGS+AR.AmplA
 7142 A635 CD CD A7     		call	apply_volenv
 7143 A638 DD 21 8E A8  		ld	ix,CHN2
 7144 A63C CD 58 A7     		call	adv_sample
 7145 A63F DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7146 A642 3C           		inc	a
 7147 A643 28 18        		jr	z,.chn3
 7148 A645 79           		ld	a,c
 7149 A646 32 FB A7     		ld	(sample_index+1),a
 7150 A649 CD 8C A7     		call	read_sample
 7151 A64C 3A AA A8     		ld	a,(AYREGS+AR.Mixer)
 7152 A64F B1           		or	c
 7153 A650 B0           		or	b
 7154 A651 32 AA A8     		ld	(AYREGS+AR.Mixer),a
 7155 A654 CD C5 A7     		call	set_noise
 7156 A657 CD F1 A7     		call	get_tone
 7157 A65A 22 A5 A8     		ld	(AYREGS+AR.TonB),hl
 7158 A65D
 7159 A65D 21 AC A8     .chn3:		ld	hl,AYREGS+AR.AmplB
 7160 A660 CD CD A7     		call	apply_volenv
 7161 A663 DD 21 98 A8  		ld	ix,CHN3
 7162 A667 CD 58 A7     		call	adv_sample
 7163 A66A DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7164 A66D 3C           		inc	a
 7165 A66E 28 1C        		jr	z,.finish
 7166 A670 79           		ld	a,c
 7167 A671 32 FB A7     		ld	(sample_index+1),a
 7168 A674 CD 8C A7     		call	read_sample
 7169 A677 3A AA A8     		ld	a,(AYREGS+AR.Mixer)
 7170 A67A CB 01        		rlc	c
 7171 A67C CB 00        		rlc	b
 7172 A67E B0           		or	b
 7173 A67F B1           		or	c
 7174 A680 32 AA A8     		ld	(AYREGS+AR.Mixer),a
 7175 A683 CD C5 A7     		call	set_noise
 7176 A686 CD F1 A7     		call	get_tone
 7177 A689 22 A7 A8     		ld	(AYREGS+AR.TonC),hl
 7178 A68C
 7179 A68C 21 AD A8     .finish:	ld	hl,AYREGS+AR.AmplC
 7180 A68F CD CD A7     		call	apply_volenv
 7181 A692
 7182 A692 21 B0 A8     outay:		ld	hl,AYREGS+AR.EnvSh
 7183 A695 AF           		xor	a
 7184 A696 B6           		or	(hl)
 7185 A697 3E 0D        		ld	a,AR.EnvSh
 7186 A699 20 05        		jr	nz,.fillregs
 7187 A69B D6 03        		sub	3
 7188 A69D 2B           		dec	hl
 7189 A69E 2B           		dec	hl
 7190 A69F 2B           		dec	hl
 7191 A6A0 01 FD FF     .fillregs:	ld	bc,#FFFD
 7192 A6A3 ED 79        .loop:		out	(c),a
 7193 A6A5 CB B0        		res	6,b
 7194 A6A7 ED AB        		outd
 7195 A6A9 CB F0        		set	6,b
 7196 A6AB 3D           		dec	a
 7197 A6AC F8           		ret	m
 7198 A6AD 18 F4        		jr	.loop
 7199 A6AF
 7200 A6AF 21 A3 A8     music_mute:	ld	hl,AYREGS
 7201 A6B2 11 A4 A8     		ld	de,AYREGS+1
 7202 A6B5 01 07 00     		ld	bc,AR.Mixer
 7203 A6B8 70           		ld	(hl),b
 7204 A6B9 ED B0        		ldir
 7205 A6BB 35           		dec	(hl)
 7206 A6BC 2E A3        		ld	l,low AYREGS
 7207 A6BE 0E 05        		ld	c,AR.EnvSh-AR.Mixer-1
 7208 A6C0 ED B0        		ldir
 7209 A6C2 EB           		ex	hl,de
 7210 A6C3 3E 0D        		ld	a,AR.EnvSh
 7211 A6C5 18 D9        		jr	outay.fillregs
 7212 A6C7
 7213 A6C7 DD 77 03     c_note:		ld	(ix+CHP.Note),a
 7214 A6CA DD 36 02 00  		ld	(ix+CHP.SmpIndex),0
 7215 A6CE DD 36 09 20  		ld	(ix+CHP.SmpCnt),#20
 7216 A6D2 23           c_empty:	inc	hl
 7217 A6D3 C9           		ret
 7218 A6D4
 7219 A6D4 D6 60        c_sample:	sub	#60
 7220 A6D6 E5           		push	hl
 7221 A6D7 01 63 00     		ld	bc,SAMPLEN
 7222 A6DA 2A 78 A8     		ld	hl,(samples)
 7223 A6DD CD 54 A5     		call	scan_until
 7224 A6E0 23           		inc	hl
 7225 A6E1 DD 75 05     		ld	(ix+CHP.SmpPtr),l
 7226 A6E4 DD 74 06     		ld	(ix+CHP.SmpPtr+1),h
 7227 A6E7 E1           		pop	hl
 7228 A6E8 23           		inc	hl
 7229 A6E9 18 06        		jr	read_pattern
 7230 A6EB
 7231 A6EB 23           c_rest:		inc	hl
 7232 A6EC DD 36 09 FF  c_norept:	ld	(ix+CHP.SmpCnt),-1
 7233 A6F0 C9           		ret
 7234 A6F1
 7235 A6F1 7E           read_pattern:	ld	a,(hl)
 7236 A6F2 FE 60        		cp	#60		; note
 7237 A6F4 38 D1        		jr	c,c_note
 7238 A6F6 FE 70        		cp	#70		; sample
 7239 A6F8 38 DA        		jr	c,c_sample
 7240 A6FA FE 80        		cp	#80		; ornament
 7241 A6FC 38 1B        		jr	c,c_ornament
 7242 A6FE 28 EB        		jr	z,c_rest	; rest
 7243 A700 FE 81        		cp	#81		; empty
 7244 A702 28 CE        		jr	z,c_empty
 7245 A704 FE 82        		cp	#82		; ornament off
 7246 A706 28 0F        		jr	z,c_ornoff
 7247 A708 FE 8F        		cp	#8F		; envelope
 7248 A70A 38 28        		jr	c,c_envelope
 7249 A70C D6 A1        		sub	#A1		; speed
 7250 A70E DD 77 04     		ld	(ix+CHP.PatStpCnt),a
 7251 A711 DD 77 01     		ld	(ix+CHP.PatStep),a
 7252 A714 23           		inc	hl
 7253 A715 18 DA        		jr	read_pattern
 7254 A717
 7255 A717 AF           c_ornoff:	xor	a
 7256 A718 01           		db	1 ; ld bc,* (skip next instruction)
 7257 A719 D6 70        c_ornament:	sub	#70
 7258 A71B E5           c_ornament0:	push	hl
 7259 A71C 01 21 00     		ld	bc,ORNALEN
 7260 A71F 2A 74 A8     		ld	hl,(ornaments)
 7261 A722 CD 54 A5     		call	scan_until
 7262 A725 23           		inc	hl
 7263 A726 DD 75 07     		ld	(ix+CHP.OrnPtr),l
 7264 A729 DD 74 08     		ld	(ix+CHP.OrnPtr+1),h
 7265 A72C DD 36 00 00  		ld	(ix+CHP.EnvState),0
 7266 A730 E1           		pop	hl
 7267 A731 23           		inc	hl
 7268 A732 18 BD        		jr	read_pattern
 7269 A734
 7270 A734 D6 80        c_envelope:	sub	#80
 7271 A736 32 B0 A8     		ld	(AYREGS+AR.EnvSh),a
 7272 A739 23           		inc	hl
 7273 A73A 7E           		ld	a,(hl)
 7274 A73B 23           		inc	hl
 7275 A73C 32 AE A8     		ld	(AYREGS+AR.Env),a
 7276 A73F DD 36 00 01  		ld	(ix+CHP.EnvState),1
 7277 A743 E5           		push	hl
 7278 A744 AF           		xor	a
 7279 A745 01 21 00     		ld	bc,ORNALEN
 7280 A748 2A 74 A8     		ld	hl,(ornaments)
 7281 A74B CD 54 A5     		call	scan_until
 7282 A74E 23           		inc	hl
 7283 A74F DD 75 07     		ld	(ix+CHP.OrnPtr),l
 7284 A752 DD 74 08     		ld	(ix+CHP.OrnPtr+1),h
 7285 A755 E1           		pop	hl
 7286 A756 18 99        		jr	read_pattern
 7287 A758
 7288 A758 DD 7E 09     adv_sample:	ld	a,(ix+CHP.SmpCnt)
 7289 A75B 3C           		inc	a
 7290 A75C C8           		ret	z
 7291 A75D 3D           		dec	a
 7292 A75E 3D           		dec	a
 7293 A75F DD 77 09     		ld	(ix+CHP.SmpCnt),a
 7294 A762 F5           		push	af
 7295 A763 DD 7E 02     		ld	a,(ix+CHP.SmpIndex)
 7296 A766 4F           		ld	c,a
 7297 A767 3C           		inc	a
 7298 A768 E6 1F        		and	#1F
 7299 A76A DD 77 02     		ld	(ix+CHP.SmpIndex),a
 7300 A76D F1           		pop	af
 7301 A76E C0           		ret	nz
 7302 A76F DD 5E 05     		ld	e,(ix+CHP.SmpPtr)
 7303 A772 DD 56 06     		ld	d,(ix+CHP.SmpPtr+1)
 7304 A775 21 60 00     		ld	hl,#60	; offset to sample metadata
 7305 A778 19           		add	hl,de
 7306 A779 7E           		ld	a,(hl)
 7307 A77A 3D           		dec	a
 7308 A77B FA EC A6     		jp	m,c_norept
 7309 A77E 4F           		ld	c,a	; repeat sample
 7310 A77F 3C           		inc	a
 7311 A780 E6 1F        		and	#1F
 7312 A782 DD 77 02     		ld	(ix+CHP.SmpIndex),a
 7313 A785 23           		inc	hl
 7314 A786 7E           		ld	a,(hl)
 7315 A787 3C           		inc	a
 7316 A788 DD 77 09     		ld	(ix+CHP.SmpCnt),a
 7317 A78B C9           		ret
 7318 A78C
 7319 A78C 16 00        read_sample:	ld	d,0
 7320 A78E 5F           		ld	e,a
 7321 A78F 87           		add	a,a
 7322 A790 83           		add	a,e
 7323 A791 5F           		ld	e,a
 7324 A792 DD 6E 05     		ld	l,(ix+CHP.SmpPtr)
 7325 A795 DD 66 06     		ld	h,(ix+CHP.SmpPtr+1)
 7326 A798 19           		add	hl,de
 7327 A799 23           		inc	hl
 7328 A79A 7E           		ld	a,(hl)
 7329 A79B CB 7F        		bit	7,a
 7330 A79D 0E 10        		ld	c,#10
 7331 A79F 20 01        		jr	nz,.no_noise
 7332 A7A1 4A           		ld	c,d
 7333 A7A2 CB 77        .no_noise:	bit	6,a
 7334 A7A4 06 02        		ld	b,2
 7335 A7A6 20 01        		jr	nz,.no_tone
 7336 A7A8 42           		ld	b,d
 7337 A7A9 23           .no_tone:	inc	hl
 7338 A7AA 5E           		ld	e,(hl)
 7339 A7AB 2B           		dec	hl
 7340 A7AC 2B           		dec	hl
 7341 A7AD 56           		ld	d,(hl)
 7342 A7AE 6F           		ld	l,a
 7343 A7AF E6 1F        		and	#1F
 7344 A7B1 67           		ld	h,a
 7345 A7B2 7A           		ld	a,d
 7346 A7B3 F5           		push	af
 7347 A7B4 E6 F0        		and	#F0
 7348 A7B6 0F           		rrca
 7349 A7B7 0F           		rrca
 7350 A7B8 0F           		rrca
 7351 A7B9 0F           		rrca
 7352 A7BA 57           		ld	d,a
 7353 A7BB F1           		pop	af
 7354 A7BC E6 0F        		and	#0F
 7355 A7BE CB 6D        		bit	5,l
 7356 A7C0 6F           		ld	l,a
 7357 A7C1 C8           		ret	z
 7358 A7C2 CB E2        		set	4,d
 7359 A7C4 C9           		ret
 7360 A7C5
 7361 A7C5 79           set_noise:	ld	a,c
 7362 A7C6 B7           		or	a
 7363 A7C7 C0           		ret	nz
 7364 A7C8 7C           		ld	a,h
 7365 A7C9 32 A9 A8     		ld	(AYREGS+AR.Noise),a
 7366 A7CC C9           		ret
 7367 A7CD
 7368 A7CD 1E 00        apply_volenv:	ld	e,0		; GLOBAL ATTENUATION
 7369 A7CF 93           		sub	e
 7370 A7D0 30 01        		jr	nc,.set
 7371 A7D2 AF           		xor	a
 7372 A7D3 77           .set		ld	(hl),a		; if value of attenuation is higher
 7373 A7D4 CB 5F        		bit	3,a		; then 8 we will stop also envelopes...
 7374 A7D6 C8           		ret	z
 7375 A7D7
 7376 A7D7 DD 7E 09     		ld	a,(ix+CHP.SmpCnt)
 7377 A7DA 3C           		inc	a
 7378 A7DB C8           		ret	z
 7379 A7DC DD 7E 00     		ld	a,(ix+CHP.EnvState)
 7380 A7DF B7           		or	a
 7381 A7E0 C8           		ret	z
 7382 A7E1 3D           		dec	a
 7383 A7E2 20 06        		jr	nz,.resetshape
 7384 A7E4 DD 36 00 02  		ld	(ix+CHP.EnvState),2
 7385 A7E8 18 04        		jr	.setenv
 7386 A7EA
 7387 A7EA AF           .resetshape:	xor	a
 7388 A7EB 32 B0 A8     		ld	(AYREGS+AR.EnvSh),a
 7389 A7EE CB E6        .setenv:	set	4,(hl)
 7390 A7F0 C9           		ret
 7391 A7F1
 7392 A7F1 7D           get_tone:	ld	a,l
 7393 A7F2 F5           		push	af
 7394 A7F3 D5           		push	de
 7395 A7F4 DD 6E 07     		ld	l,(ix+CHP.OrnPtr)
 7396 A7F7 DD 66 08     		ld	h,(ix+CHP.OrnPtr+1)
 7397 A7FA 11 00 00     sample_index:	ld	de,0
 7398 A7FD 19           		add	hl,de
 7399 A7FE DD 7E 03     		ld	a,(ix+CHP.Note)
 7400 A801 86           		add	a,(hl)
 7401 A802
 7402 A802 C6 00        get_frequency:	add	a,0
 7403 A804 87           		add	a,a
 7404 A805 5F           		ld	e,a
 7405 A806 16 00        		ld	d,0
 7406 A808 21 B1 A8     		ld	hl,freqtable
 7407 A80B 19           		add	hl,de
 7408 A80C 5E           		ld	e,(hl)
 7409 A80D 23           		inc	hl
 7410 A80E 56           		ld	d,(hl)
 7411 A80F EB           		ex	de,hl
 7412 A810 D1           		pop	de
 7413 A811 F1           		pop	af
 7414 A812 CB 62        		bit	4,d
 7415 A814 28 04        		jr	z,.negative
 7416 A816 CB A2        		res	4,d
 7417 A818 19           		add	hl,de
 7418 A819 C9           		ret
 7419 A81A
 7420 A81A A7           .negative:	and	a
 7421 A81B ED 52        		sbc	hl,de
 7422 A81D C9           		ret
 7423 A81E
 7424 A81E              ;------------------------------------------------------------------------------
 7425 A81E 21 3E A2     resetfadeout:	ld	hl,music_setup
 7426 A821 CB FE        noloop:		set	7,(hl)
 7427 A823 CD AF A6     		call	music_mute
 7428 A826 E1           deadend:	pop	hl
 7429 A827 AF           		xor	a
 7430 A828 32 7B A8     		ld	(tempo_cnt),a
 7431 A82B 3D           		dec	a
 7432 A82C 32 8D A8     		ld	(CHN1+CHP.SmpCnt),a
 7433 A82F 32 97 A8     		ld	(CHN2+CHP.SmpCnt),a
 7434 A832 32 A1 A8     		ld	(CHN3+CHP.SmpCnt),a
 7435 A835 32 45 A8     		ld	(chkfadeout+1),a
 7436 A838 C9           		ret
 7437 A839
 7438 A839 3E 30        enablefade:	ld	a,48
 7439 A83B 32 45 A8     forcefade:	ld	(chkfadeout+1),a
 7440 A83E 32 4F A8     		ld	(countfadeout+1),a
 7441 A841 32 61 A8     		ld	(divfadeout+1),a
 7442 A844
 7443 A844 3E 00        chkfadeout:	ld	a,0
 7444 A846 B7           		or	a
 7445 A847 C8           		ret	z
 7446 A848 3A 3E A2     		ld	a,(music_setup)
 7447 A84B 07           		rlca
 7448 A84C 38 D8        		jr	c,deadend
 7449 A84E 3E 00        countfadeout:	ld	a,0
 7450 A850 3D           		dec	a
 7451 A851 32 4F A8     		ld	(countfadeout+1),a
 7452 A854 C0           		ret	nz
 7453 A855 3A CE A7     		ld	a,(apply_volenv+1)
 7454 A858 3C           		inc	a
 7455 A859 FE 10        		cp	16
 7456 A85B 28 C1        		jr	z,resetfadeout
 7457 A85D 32 CE A7     		ld	(apply_volenv+1),a
 7458 A860 3E 00        divfadeout:	ld	a,0
 7459 A862 CB 3F        		srl	a
 7460 A864 5F           		ld	e,a
 7461 A865 CB 3B        		srl	e
 7462 A867 83           		add	a,e
 7463 A868 20 01        		jr	nz,divfadeout1
 7464 A86A 3C           		inc	a
 7465 A86B 32 4F A8     divfadeout1:	ld	(countfadeout+1),a
 7466 A86E 32 61 A8     		ld	(divfadeout+1),a
 7467 A871 C9           		ret
 7468 A872
 7469 A872              ;------------------------------------------------------------------------------
 7470 A872 00 00        positions:	dw	0
 7471 A874 00 00        ornaments:	dw	0
 7472 A876 00 00        patterns:	dw	0
 7473 A878 00 00        samples:	dw	0
 7474 A87A 00           speed:		db	0
 7475 A87B 00           tempo_cnt:	db	0
 7476 A87C 00           song_length:	db	0
 7477 A87D
 7478 A87D 83 A8        chn1_pattptr:	dw	empty_pattern
 7479 A87F 83 A8        chn2_pattptr:	dw	empty_pattern
 7480 A881 83 A8        chn3_pattptr:	dw	empty_pattern
 7481 A883 FF           empty_pattern:	db	#FF
 7482 A884
 7483 A884              VARS
 7484 A884 00 00 00...  CHN1:		ds	10
 7485 A88E 00 00 00...  CHN2:		ds	10
 7486 A898 00 00 00...  CHN3:		ds	10
 7487 A8A2
 7488 A8A2 00           current_pos:	db	0
 7489 A8A3              @VARSLEN = $ - VARS
 7490 A8A3
 7491 A8A3 00 00 00...  AYREGS:		ds	14
 7492 A8B1
 7493 A8B1              ;------------------------------------------------------------------------------
 7494 A8B1 F8 0E 10 0E  freqtable:	dw	#0EF8, #0E10, #0D60, #0C80, #0BD8, #0B28, #0A88, #09F0
 7494 A8B5 60 0D 80 0C
 7494 A8B9 D8 0B 28 0B
 7494 A8BD 88 0A F0 09
 7495 A8C1 60 09 E0 08  		dw	#0960, #08E0, #0858, #07E0, #077C, #0708, #06B0, #0640
 7495 A8C5 58 08 E0 07
 7495 A8C9 7C 07 08 07
 7495 A8CD B0 06 40 06
 7496 A8D1 EC 05 94 05  		dw	#05EC, #0594, #0544, #04F8, #04B0, #0470, #042C, #03F0
 7496 A8D5 44 05 F8 04
 7496 A8D9 B0 04 70 04
 7496 A8DD 2C 04 F0 03
 7497 A8E1 BE 03 84 03  		dw	#03BE, #0384, #0358, #0320, #02F6, #02CA, #02A2, #027C
 7497 A8E5 58 03 20 03
 7497 A8E9 F6 02 CA 02
 7497 A8ED A2 02 7C 02
 7498 A8F1 58 02 38 02  		dw	#0258, #0238, #0216, #01F8, #01DF, #01C2, #01AC, #0190
 7498 A8F5 16 02 F8 01
 7498 A8F9 DF 01 C2 01
 7498 A8FD AC 01 90 01
 7499 A901 7B 01 65 01  		dw	#017B, #0165, #0151, #013E, #012C, #011C, #010B, #00FC
 7499 A905 51 01 3E 01
 7499 A909 2C 01 1C 01
 7499 A90D 0B 01 FC 00
 7500 A911 EF 00 E1 00  		dw	#00EF, #00E1, #00D6, #00C8, #00BD, #00B2, #00A8, #009F
 7500 A915 D6 00 C8 00
 7500 A919 BD 00 B2 00
 7500 A91D A8 00 9F 00
 7501 A921 96 00 8E 00  		dw	#0096, #008E, #0085, #007E, #0077, #0070, #006B, #0064
 7501 A925 85 00 7E 00
 7501 A929 77 00 70 00
 7501 A92D 6B 00 64 00
 7502 A931 5E 00 59 00  		dw	#005E, #0059, #0054, #004F, #004B, #0047, #0042, #003F
 7502 A935 54 00 4F 00
 7502 A939 4B 00 47 00
 7502 A93D 42 00 3F 00
 7503 A941 3B 00 38 00  		dw	#003B, #0038, #0035, #0032, #002F, #002C, #002A, #0027
 7503 A945 35 00 32 00
 7503 A949 2F 00 2C 00
 7503 A94D 2A 00 27 00
 7504 A951 25 00 23 00  		dw	#0025, #0023, #0021, #001F, #001D, #001C, #001A, #0019
 7504 A955 21 00 1F 00
 7504 A959 1D 00 1C 00
 7504 A95D 1A 00 19 00
 7505 A961 17 00 16 00  		dw	#0017, #0016, #0015, #0013, #0012, #0011, #0010, #000F
 7505 A965 15 00 13 00
 7505 A969 12 00 11 00
 7505 A96D 10 00 0F 00
 7506 A971
 7507 A971
 7508 A971              ;------------------------------------------------------------------------------
 7509 A971              	struct AR	; AY Registers structure
 7510 A971 ~            TonA		word	; 0
 7511 A971 ~            TonB		word	; 2
 7512 A971 ~            TonC		word	; 4
 7513 A971 ~            Noise		byte	; 6
 7514 A971 ~            Mixer		byte	; 7
 7515 A971 ~            AmplA		byte	; 8
 7516 A971 ~            AmplB		byte	; 9
 7517 A971 ~            AmplC		byte	; 10
 7518 A971 ~            Env		word	; 11
 7519 A971 ~            EnvSh		byte	; 13
 7520 A971              	ends
 7521 A971
 7522 A971              	struct CHP	; channel parameters structure
 7523 A971 ~            EnvState	byte
 7524 A971 ~            PatStep		byte
 7525 A971 ~            SmpIndex	byte
 7526 A971 ~            Note		byte
 7527 A971 ~            PatStpCnt	byte
 7528 A971 ~            SmpPtr		word
 7529 A971 ~            OrnPtr		word
 7530 A971 ~            SmpCnt		byte
 7531 A971              	ends
 7532 A971
 7533 A971              @HEADLEN = 27	; file header length
 7534 A971              @SAMPLEN = 99	; single sample length
 7535 A971              @ORNALEN = 33	; single ornament length
 7536 A971              @PATTLEN = 7	; single pattern record length
 7537 A971
 7538 A971
 7539 A971
 7540 A971              			endmodule
 7541 A971
 7542 A971
 7543 A971              ;***************************
 7544 A971              ;***************************
 7545 A971              ;***************************
 7546 A971              ;***************************
 7547 A971              ;***************************
 7548 A971              ;***************************
 7549 A971              ;***************************
 7550 A971              ;***************************
 7551 A971              ;***************************
 7552 A971              ;***************************
 7553 A971              ;***************************
 7554 A971              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
 7555 A971              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
 7556 A971              ;Specially for AlCo
 7557 A971              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
 7558 A971              	MODULE VTPL
 7559 A971              ;Release number
 7560 A971              Release EQU "0"
 7561 A971              ;Conditional assembly
 7562 A971              ;1) Current position counters at (Vars1+0) and (Vars2+0)
 7563 A971              CurPosCounter=0
 7564 A971              ;2) Allow channels allocation bits at (START+10)
 7565 A971              ACBBAC=0
 7566 A971              ;3) Allow loop checking and disabling
 7567 A971              LoopChecker=1
 7568 A971              ;4) Insert official identificator
 7569 A971              Id=0
 7570 A971              ;5) Set IY for correct return to ZX Basic
 7571 A971              Basic=1
 7572 A971
 7573 A971              ;Features
 7574 A971              ;--------
 7575 A971              ;-Can be compiled at any address (i.e. no need rounding ORG
 7576 A971              ; address).
 7577 A971              ;-Variables (VARS) can be located at any address (not only after
 7578 A971              ; code block).
 7579 A971              ;-INIT subprogram checks PT3-module version and rightly
 7580 A971              ; generates both note and volume tables outside of code block
 7581 A971              ; (in VARS).
 7582 A971              ;-Two portamento (spc. command 3xxx) algorithms (depending of
 7583 A971              ; PT3 module version).
 7584 A971              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
 7585 A971              ; and higher).
 7586 A971              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
 7587 A971              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
 7588 A971              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
 7589 A971              ;-See also notes at the end of this source code.
 7590 A971
 7591 A971              ;Limitations
 7592 A971              ;-----------
 7593 A971              ;-Can run in RAM only (self-modified code is used).
 7594 A971              ;-PT2 position list must be end by #FF marker only.
 7595 A971
 7596 A971              ;Warning!!! PLAY subprogram can crash if no module are loaded
 7597 A971              ;into RAM or INIT subprogram was not called before.
 7598 A971
 7599 A971              ;Call MUTE or INIT one more time to mute sound after stopping
 7600 A971              ;playing
 7601 A971
 7602 A971              ;Test codes (commented)
 7603 A971              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
 7604 A971              ;	LD (START+10),A
 7605 A971              ;	LD HL,#8000 ;Mod1
 7606 A971              ;	LD DE,#A000 ;Mod2 (optional)
 7607 A971              ;	CALL START+3
 7608 A971              ;	EI
 7609 A971              ;_LP	HALT
 7610 A971              ;	CALL START+5
 7611 A971              ;	XOR A
 7612 A971              ;	IN A,(#FE)
 7613 A971              ;	CPL
 7614 A971              ;	AND 15
 7615 A971              ;	JR Z,_LP
 7616 A971              ;	JR START+8
 7617 A971
 7618 A971              TonA	EQU 0
 7619 A971              TonB	EQU 2
 7620 A971              TonC	EQU 4
 7621 A971              Noise	EQU 6
 7622 A971              Mixer	EQU 7
 7623 A971              AmplA	EQU 8
 7624 A971              AmplB	EQU 9
 7625 A971              AmplC	EQU 10
 7626 A971              Env	EQU 11
 7627 A971              EnvTp	EQU 13
 7628 A971
 7629 A971              ;Entry and other points
 7630 A971              ;START initialize playing of modules at MDLADDR (single module)
 7631 A971              ;START+3 initialization with module address in HL and DE (TS)
 7632 A971              ;START+5 play one quark
 7633 A971              ;START+8 mute
 7634 A971              ;START+10 setup and status flags
 7635 A971
 7636 A971              START:
 7637 A971 21 26 BD     	LD HL,songdata ;DE - address of 2nd module for TS
 7638 A974 18 3C        	JR INIT
 7639 A976 C3 D5 B1     	JP PLAY
 7640 A979 18 25        	JR MUTE
 7641 A97B 10           SETUP	DB %00010000 ;set bit0, if you want to play without looping
 7642 A97C              	     ;(optional);
 7643 A97C              	     ;set bit1 for PT2 and reset for PT3 before
 7644 A97C              	     ;calling INIT;
 7645 A97C              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
 7646 A97C              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
 7647 A97C              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
 7648 A97C              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
 7649 A97C              	     ;documented and must be converted to new standard.
 7650 A97C              	     ;bit6 is set each time, when loop point of 2nd TS
 7651 A97C              	     ;module is passed (optional).
 7652 A97C              	     ;bit7 is set each time, when loop point of 1st TS
 7653 A97C              	     ;or of single module is passed (optional).
 7654 A97C
 7655 A97C              ;Identifier
 7656 A97C              	IF Id
 7657 A97C ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 7658 A97C              	ENDIF
 7659 A97C
 7660 A97C              	IF LoopChecker
 7661 A97C 21 7B A9     CHECKLP	LD HL,SETUP
 7662 A97F FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 7663 A983 28 04        	JR Z,CHL1
 7664 A985 CB F6        	SET 6,(HL)
 7665 A987 18 02        	JR CHL2
 7666 A989 CB FE        CHL1	SET 7,(HL)
 7667 A98B CB 46        CHL2	BIT 0,(HL)
 7668 A98D C8           	RET Z
 7669 A98E E1           	POP HL
 7670 A98F FD 34 09     	INC (IY-100+VRS.DelyCnt)
 7671 A992 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 7672 A995 AF           	XOR A
 7673 A996 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 7674 A999 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 7675 A99C FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 7676 A99F C9           	RET
 7677 A9A0              	ENDIF
 7678 A9A0
 7679 A9A0 AF           MUTE: XOR A
 7680 A9A1 67           	LD H,A
 7681 A9A2 6F           	LD L,A
 7682 A9A3 32 2A B3     	LD (VARS1+VRS.AYREGS+AmplA),A
 7683 A9A6 22 2B B3     	LD (VARS1+VRS.AYREGS+AmplB),HL
 7684 A9A9 32 B1 B3     	LD (VARS2+VRS.AYREGS+AmplA),A
 7685 A9AC 22 B2 B3     	LD (VARS2+VRS.AYREGS+AmplB),HL
 7686 A9AF C3 ED B1     	JP ROUT
 7687 A9B2
 7688 A9B2              INIT:
 7689 A9B2              ;HL - AddressOfModule
 7690 A9B2              ;DE - AddresOf2ndModule
 7691 A9B2 D5           	PUSH DE
 7692 A9B3 E5           	PUSH HL
 7693 A9B4 21 A8 B2     	LD HL,VARS
 7694 A9B7 36 00        	LD (HL),0
 7695 A9B9 11 A9 B2     	LD DE,VARS+1
 7696 A9BC 01 0E 01     	LD BC,VAR0END-VARS-1
 7697 A9BF ED B0        	LDIR
 7698 A9C1 23           	INC HL
 7699 A9C2 22 0B B3     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 7700 A9C5 22 92 B3     	LD (VARS2+VRS.AdInPtA),HL
 7701 A9C8
 7702 A9C8 E1           	POP HL
 7703 A9C9 FD 21 0D B3  	LD IY,VARS1+100
 7704 A9CD 3A 7B A9     	LD A,(START+10)
 7705 A9D0 E6 02        	AND 2
 7706 A9D2 C2 5B AA     	JP NZ,I_PT2
 7707 A9D5
 7708 A9D5 CD A8 AB     	CALL INITPT3
 7709 A9D8 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 7710 A9DB 22 7B AF     	LD (SamCnv),HL
 7711 A9DE 3E BA        	LD A,#BA
 7712 A9E0 32 46 AF     	LD (OrnCP),A
 7713 A9E3 32 72 AF     	LD (SamCP),A
 7714 A9E6 3E 7B        	LD A,#7B
 7715 A9E8 32 49 AF     	LD (OrnLD),A
 7716 A9EB 32 75 AF     	LD (SamLD),A
 7717 A9EE 3E 87        	LD A,#87
 7718 A9F0 32 6C AF     	LD (SamClc2),A
 7719 A9F3 E1           	POP HL
 7720 A9F4              	;Use version and ton table of 1st module
 7721 A9F4 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 7722 A9F7 D6 30        	SUB #30
 7723 A9F9 38 04        	JR C,L20
 7724 A9FB FE 0A        	CP 10
 7725 A9FD 38 02        	JR C,L21
 7726 A9FF 3E 06        L20	LD A,6
 7727 AA01 32 19 AE     L21	LD (Version),A
 7728 AA04 F5           	PUSH AF ;VolTable version
 7729 AA05 FE 04        	CP 4
 7730 AA07 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 7731 AA0A 17           	RLA
 7732 AA0B E6 07        	AND 7
 7733 AA0D F5           	PUSH AF ;NoteTable number
 7734 AA0E
 7735 AA0E FD 21 94 B3  	LD IY,VARS2+100
 7736 AA12 3A 7B A9     	LD A,(START+10)
 7737 AA15 E6 30        	AND 48
 7738 AA17 28 37        	JR Z,NOTS
 7739 AA19 FE 10        	CP 16
 7740 AA1B 28 27        	JR Z,TwoPT3s
 7741 AA1D 3A 19 AE     	LD A,(Version)
 7742 AA20 FE 07        	CP 7
 7743 AA22 38 2C        	JR C,NOTS
 7744 AA24 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 7745 AA27 FE 20        	CP #20
 7746 AA29 28 25        	JR Z,NOTS
 7747 AA2B 21 A9 B2     	LD HL,VARS1
 7748 AA2E 11 30 B3     	LD DE,VARS2
 7749 AA31 01 87 00     	LD BC,VRS
 7750 AA34 ED B0        	LDIR
 7751 AA36 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 7752 AA3A 4F           	LD C,A
 7753 AA3B 87           	ADD A,A
 7754 AA3C 81           	ADD A,C
 7755 AA3D D6 02        	SUB 2
 7756 AA3F 32 E0 B0     	LD (TSSub),A
 7757 AA42 18 03        	JR AlCoTS_
 7758 AA44 CD A8 AB     TwoPT3s	CALL INITPT3
 7759 AA47 3E 01        AlCoTS_	LD A,1
 7760 AA49 32 A8 B2     	LD (is_ts),A
 7761 AA4C FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 7762 AA50
 7763 AA50 01 65 AD     NOTS	LD BC,PT3PD
 7764 AA53 21 00 00     	LD HL,0
 7765 AA56 11 70 B2     	LD DE,PT3EMPTYORN
 7766 AA59 18 48        	JR INITCOMMON
 7767 AA5B
 7768 AA5B CD E0 AB     I_PT2	CALL INITPT2
 7769 AA5E 21 CB 51     	LD HL,#51CB
 7770 AA61 22 7B AF     	LD (SamCnv),HL
 7771 AA64 3E BB        	LD A,#BB
 7772 AA66 32 46 AF     	LD (OrnCP),A
 7773 AA69 32 72 AF     	LD (SamCP),A
 7774 AA6C 3E 7A        	LD A,#7A
 7775 AA6E 32 49 AF     	LD (OrnLD),A
 7776 AA71 32 75 AF     	LD (SamLD),A
 7777 AA74 3E 80        	LD A,#80
 7778 AA76 32 6C AF     	LD (SamClc2),A
 7779 AA79 E1           	POP HL
 7780 AA7A 3E 05        	LD A,5
 7781 AA7C 32 19 AE     	LD (Version),A
 7782 AA7F F5           	PUSH AF
 7783 AA80 3E 02        	LD A,2
 7784 AA82 F5           	PUSH AF
 7785 AA83
 7786 AA83 3A 7B A9     	LD A,(START+10)
 7787 AA86 E6 30        	AND 48
 7788 AA88 28 10        	JR Z,NOTS2
 7789 AA8A
 7790 AA8A FD 21 94 B3  	LD IY,VARS2+100
 7791 AA8E 3E 01        	LD A,1
 7792 AA90 32 A8 B2     	LD (is_ts),A
 7793 AA93 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 7794 AA97 CD E0 AB     	CALL INITPT2
 7795 AA9A
 7796 AA9A 01 9F AC     NOTS2	LD BC,PT2PD
 7797 AA9D 21 87 86     	LD HL,#8687
 7798 AAA0 11 C6 B3     	LD DE,PT2EMPTYORN
 7799 AAA3
 7800 AAA3              INITCOMMON
 7801 AAA3
 7802 AAA3              	IF Basic
 7803 AAA3 FD 21 3A 5C  	LD IY,#5C3A
 7804 AAA7              	ENDIF
 7805 AAA7
 7806 AAA7 ED 43 50 AC  	LD (PTDEC),BC
 7807 AAAB 22 E2 B0     	LD (PsCalc),HL
 7808 AAAE D5           	PUSH DE
 7809 AAAF
 7810 AAAF              ;note table data depacker
 7811 AAAF              ;(c) Ivan Roshin
 7812 AAAF 11 73 B2     	LD DE,T_PACK
 7813 AAB2 01 18 B4     	LD BC,T1_+(2*49)-1
 7814 AAB5 1A           TP_0	LD A,(DE)
 7815 AAB6 13           	INC DE
 7816 AAB7 FE 1E        	CP 15*2
 7817 AAB9 30 06        	JR NC,TP_1
 7818 AABB 67           	LD H,A
 7819 AABC 1A           	LD A,(DE)
 7820 AABD 6F           	LD L,A
 7821 AABE 13           	INC DE
 7822 AABF 18 07        	JR TP_2
 7823 AAC1 D5           TP_1	PUSH DE
 7824 AAC2 16 00        	LD D,0
 7825 AAC4 5F           	LD E,A
 7826 AAC5 19           	ADD HL,DE
 7827 AAC6 19           	ADD HL,DE
 7828 AAC7 D1           	POP DE
 7829 AAC8 7C           TP_2	LD A,H
 7830 AAC9 02           	LD (BC),A
 7831 AACA 0B           	DEC BC
 7832 AACB 7D           	LD A,L
 7833 AACC 02           	LD (BC),A
 7834 AACD 0B           	DEC BC
NextPlayer.asm(7835): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 7835 AACE D6 F0        	SUB #F8*2
 7836 AAD0 20 E3        	JR NZ,TP_0
 7837 AAD2
 7838 AAD2 3C           	INC A
 7839 AAD3 32 16 B3     	LD (VARS1+VRS.DelyCnt),A
 7840 AAD6 32 9D B3     	LD (VARS2+VRS.DelyCnt),A
 7841 AAD9 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 7842 AADC 22 C7 B2     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 7843 AADF 22 E4 B2     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 7844 AAE2 22 01 B3     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 7845 AAE5 22 4E B3     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 7846 AAE8 22 6B B3     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 7847 AAEB 22 88 B3     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 7848 AAEE E1           	POP HL
 7849 AAEF 22 B9 B2     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 7850 AAF2 22 D6 B2     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 7851 AAF5 22 F3 B2     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 7852 AAF8 22 40 B3     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 7853 AAFB 22 5D B3     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 7854 AAFE 22 7A B3     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 7855 AB01
 7856 AB01 F1           	POP AF
 7857 AB02
 7858 AB02              ;NoteTableCreator (c) Ivan Roshin
 7859 AB02              ;A - NoteTableNumber*2+VersionForNoteTable
 7860 AB02              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 7861 AB02
 7862 AB02 21 20 B2     	LD HL,NT_DATA
 7863 AB05 16 00        	LD D,0
 7864 AB07 87           	ADD A,A
 7865 AB08 5F           	LD E,A
 7866 AB09 19           	ADD HL,DE
 7867 AB0A 5E           	LD E,(HL)
 7868 AB0B 23           	INC HL
 7869 AB0C CB 3B        	SRL E
 7870 AB0E 9F           	SBC A,A
 7871 AB0F E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 7872 AB11 32 39 AB     	LD (L3),A
 7873 AB14 EB           	EX DE,HL
 7874 AB15 01 B7 B3     	LD BC,T1_
 7875 AB18 09           	ADD HL,BC
 7876 AB19
 7877 AB19 1A           	LD A,(DE)
NextPlayer.asm(7878): warning: value 0xB230 is truncated to 8bit value: 0x30
 7878 AB1A C6 30        	ADD A,T_
 7879 AB1C 4F           	LD C,A
 7880 AB1D CE B2        	ADC A,T_/256
 7881 AB1F 91           	SUB C
 7882 AB20 47           	LD B,A
 7883 AB21 C5           	PUSH BC
 7884 AB22 11 A7 B4     	LD DE,NT_
 7885 AB25 D5           	PUSH DE
 7886 AB26
 7887 AB26 06 0C        	LD B,12
 7888 AB28 C5           L1	PUSH BC
 7889 AB29 4E           	LD C,(HL)
 7890 AB2A 23           	INC HL
 7891 AB2B E5           	PUSH HL
 7892 AB2C 46           	LD B,(HL)
 7893 AB2D
 7894 AB2D D5           	PUSH DE
 7895 AB2E EB           	EX DE,HL
 7896 AB2F 11 17 00     	LD DE,23
 7897 AB32 DD 26 08     	LD IXH,8
 7898 AB35
 7899 AB35 CB 38        L2	SRL B
 7900 AB37 CB 19        	RR C
 7901 AB39 19           L3	DB #19	;AND A or NOP
 7902 AB3A 79           	LD A,C
 7903 AB3B 8A           	ADC A,D	;=ADC 0
 7904 AB3C 77           	LD (HL),A
 7905 AB3D 23           	INC HL
 7906 AB3E 78           	LD A,B
 7907 AB3F 8A           	ADC A,D
 7908 AB40 77           	LD (HL),A
 7909 AB41 19           	ADD HL,DE
 7910 AB42 DD 25        	DEC IXH
 7911 AB44 20 EF        	JR NZ,L2
 7912 AB46
 7913 AB46 D1           	POP DE
 7914 AB47 13           	INC DE
 7915 AB48 13           	INC DE
 7916 AB49 E1           	POP HL
 7917 AB4A 23           	INC HL
 7918 AB4B C1           	POP BC
 7919 AB4C 10 DA        	DJNZ L1
 7920 AB4E
 7921 AB4E E1           	POP HL
 7922 AB4F D1           	POP DE
 7923 AB50
 7924 AB50 7B           	LD A,E
NextPlayer.asm(7925): warning: value 0xB23C is truncated to 8bit value: 0x3C
 7925 AB51 FE 3C        	CP TCOLD_1
 7926 AB53 20 05        	JR NZ,CORR_1
 7927 AB55 3E FD        	LD A,#FD
 7928 AB57 32 D5 B4     	LD (NT_+#2E),A
 7929 AB5A
 7930 AB5A 1A           CORR_1	LD A,(DE)
 7931 AB5B A7           	AND A
 7932 AB5C 28 11        	JR Z,TC_EXIT
 7933 AB5E 1F           	RRA
 7934 AB5F F5           	PUSH AF
 7935 AB60 87           	ADD A,A
 7936 AB61 4F           	LD C,A
 7937 AB62 09           	ADD HL,BC
 7938 AB63 F1           	POP AF
 7939 AB64 30 02        	JR NC,CORR_2
 7940 AB66 35           	DEC (HL)
 7941 AB67 35           	DEC (HL)
 7942 AB68 34           CORR_2	INC (HL)
 7943 AB69 A7           	AND A
 7944 AB6A ED 42        	SBC HL,BC
 7945 AB6C 13           	INC DE
 7946 AB6D 18 EB        	JR CORR_1
 7947 AB6F
 7948 AB6F              TC_EXIT
 7949 AB6F
 7950 AB6F F1           	POP AF
 7951 AB70
 7952 AB70              ;VolTableCreator (c) Ivan Roshin
 7953 AB70              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 7954 AB70              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 7955 AB70
 7956 AB70 FE 05        	CP 5
 7957 AB72 21 11 00     	LD HL,#11
 7958 AB75 54           	LD D,H
 7959 AB76 5C           	LD E,H
 7960 AB77 3E 17        	LD A,#17
 7961 AB79 30 03        	JR NC,M1
 7962 AB7B 2D           	DEC L
 7963 AB7C 5D           	LD E,L
 7964 AB7D AF           	XOR A
 7965 AB7E 32 8F AB     M1      LD (M2),A
 7966 AB81
 7967 AB81 DD 21 B7 B3  	LD IX,VT_+16
 7968 AB85
 7969 AB85 0E 0F        	LD C,#F
 7970 AB87 E5           INITV2  PUSH HL
 7971 AB88
 7972 AB88 19           	ADD HL,DE
 7973 AB89 EB           	EX DE,HL
 7974 AB8A ED 62        	SBC HL,HL
 7975 AB8C
 7976 AB8C 06 10        	LD B,#10
 7977 AB8E 7D           INITV1  LD A,L
 7978 AB8F 7D           M2      DB #7D
 7979 AB90 7C           	LD A,H
 7980 AB91 CE 00        	ADC A,0
 7981 AB93 DD 77 00     	LD (IX),A
 7982 AB96 DD 23        	INC IX
 7983 AB98 19           	ADD HL,DE
 7984 AB99 10 F3        	DJNZ INITV1
 7985 AB9B
 7986 AB9B E1           	POP HL
 7987 AB9C 7B           	LD A,E
 7988 AB9D FE 77        	CP #77
 7989 AB9F 20 01        	JR NZ,M3
 7990 ABA1 1C           	INC E
 7991 ABA2 0D           M3      DEC C
 7992 ABA3 20 E2        	JR NZ,INITV2
 7993 ABA5
 7994 ABA5 C3 ED B1     	JP ROUT
 7995 ABA8
 7996 ABA8 CD 1B AC     INITPT3	CALL SETMDAD
 7997 ABAB E5           	PUSH HL
 7998 ABAC 11 64 00     	LD DE,100
 7999 ABAF 19           	ADD HL,DE
 8000 ABB0 7E           	LD A,(HL)
 8001 ABB1 FD 77 08     	LD (IY-100+VRS.Delay),A
 8002 ABB4 E5           	PUSH HL
 8003 ABB5 DD E1        	POP IX
 8004 ABB7 19           	ADD HL,DE
 8005 ABB8 CD 29 AC     	CALL SETCPPT
 8006 ABBB DD 5E 02     	LD E,(IX+102-100)
 8007 ABBE 23           	INC HL
 8008 ABBF
 8009 ABBF              	IF CurPosCounter
 8010 ABBF ~            	LD (IY-100+VRS.PosSub),L
 8011 ABBF              	ENDIF
 8012 ABBF
 8013 ABBF 19           	ADD HL,DE
 8014 ABC0 CD 30 AC     	CALL SETLPPT
 8015 ABC3 D1           	POP DE
 8016 ABC4 DD 6E 03     	LD L,(IX+103-100)
 8017 ABC7 DD 66 04     	LD H,(IX+104-100)
 8018 ABCA 19           	ADD HL,DE
 8019 ABCB CD 14 AC     	CALL SETPTPT
 8020 ABCE 21 A9 00     	LD HL,169
 8021 ABD1 19           	ADD HL,DE
 8022 ABD2 CD 22 AC     	CALL SETORPT
 8023 ABD5 21 69 00     	LD HL,105
 8024 ABD8 19           	ADD HL,DE
 8025 ABD9
 8026 ABD9 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 8027 ABDC FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 8028 ABDF C9           	RET
 8029 ABE0
 8030 ABE0 7E           INITPT2	LD A,(HL)
 8031 ABE1 FD 77 08     	LD (IY-100+VRS.Delay),A
 8032 ABE4 E5           	PUSH HL
 8033 ABE5 E5           	PUSH HL
 8034 ABE6 E5           	PUSH HL
 8035 ABE7 23           	INC HL
 8036 ABE8 23           	INC HL
 8037 ABE9 7E           	LD A,(HL)
 8038 ABEA 23           	INC HL
 8039 ABEB CD D9 AB     	CALL SETSMPT
 8040 ABEE 5E           	LD E,(HL)
 8041 ABEF 23           	INC HL
 8042 ABF0 56           	LD D,(HL)
 8043 ABF1 E1           	POP HL
 8044 ABF2 A7           	AND A
 8045 ABF3 ED 52        	SBC HL,DE
 8046 ABF5 CD 1B AC     	CALL SETMDAD
 8047 ABF8 E1           	POP HL
 8048 ABF9 11 43 00     	LD DE,67
 8049 ABFC 19           	ADD HL,DE
 8050 ABFD CD 22 AC     	CALL SETORPT
 8051 AC00 1E 20        	LD E,32
 8052 AC02 19           	ADD HL,DE
 8053 AC03 4E           	LD C,(HL)
 8054 AC04 23           	INC HL
 8055 AC05 46           	LD B,(HL)
 8056 AC06 1E 1E        	LD E,30
 8057 AC08 19           	ADD HL,DE
 8058 AC09 CD 29 AC     	CALL SETCPPT
 8059 AC0C 5F           	LD E,A
 8060 AC0D 23           	INC HL
 8061 AC0E
 8062 AC0E              	IF CurPosCounter
 8063 AC0E ~            	LD (IY-100+VRS.PosSub),L
 8064 AC0E              	ENDIF
 8065 AC0E
 8066 AC0E 19           	ADD HL,DE
 8067 AC0F CD 30 AC     	CALL SETLPPT
 8068 AC12 E1           	POP HL
 8069 AC13 09           	ADD HL,BC
 8070 AC14
 8071 AC14 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 8072 AC17 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 8073 AC1A C9           	RET
 8074 AC1B
 8075 AC1B FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 8076 AC1E FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 8077 AC21 C9           	RET
 8078 AC22
 8079 AC22 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 8080 AC25 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 8081 AC28 C9           	RET
 8082 AC29
 8083 AC29 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 8084 AC2C FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 8085 AC2F C9           	RET
 8086 AC30
 8087 AC30 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 8088 AC33 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 8089 AC36 C9           	RET
 8090 AC37
 8091 AC37 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 8092 AC3A FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 8093 AC3D C9           	RET
 8094 AC3E
 8095 AC3E FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 8096 AC41 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 8097 AC44 C9           	RET
 8098 AC45
 8099 AC45 FD E5        GETIX	PUSH IY
 8100 AC47 DD E1        	POP IX
 8101 AC49 DD 19        	ADD IX,DE
 8102 AC4B C9           	RET
 8103 AC4C
 8104 AC4C CD 45 AC     PTDECOD CALL GETIX
 8105 AC4F              PTDEC	EQU $+1
 8106 AC4F C3 C3 C3     	JP #C3C3
 8107 AC52
 8108 AC52              ;PT2 pattern decoder
 8109 AC52 CD E8 AE     PD2_SAM	CALL SETSAM
 8110 AC55 18 4A        	JR PD2_LOOP
 8111 AC57
 8112 AC57 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 8113 AC5A 18 45        	JR PD2_LOOP
 8114 AC5C
 8115 AC5C DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 8116 AC60 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 8117 AC63 0A           	LD A,(BC)
 8118 AC64 03           	INC BC
 8119 AC65 6F           	LD L,A
 8120 AC66 0A           	LD A,(BC)
 8121 AC67 03           	INC BC
 8122 AC68 67           	LD H,A
 8123 AC69 CD 37 AC     	CALL SETENBS
 8124 AC6C 18 33        	JR PD2_LOOP
 8125 AC6E
 8126 AC6E CD C9 AE     PD2_ORN	CALL SETORN
 8127 AC71 18 2E        	JR PD2_LOOP
 8128 AC73
 8129 AC73 3C           PD2_SKIP INC A
 8130 AC74 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 8131 AC77 18 28        	JR PD2_LOOP
 8132 AC79
 8133 AC79 0F           PD2_VOL	RRCA
 8134 AC7A 0F           	RRCA
 8135 AC7B 0F           	RRCA
 8136 AC7C 0F           	RRCA
 8137 AC7D DD 77 10     	LD (IX-12+CHP.Volume),A
 8138 AC80 18 1F        	JR PD2_LOOP
 8139 AC82
 8140 AC82 CD 99 AE     PD2_DEL	CALL C_DELAY
 8141 AC85 18 1A        	JR PD2_LOOP
 8142 AC87
 8143 AC87 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 8144 AC8B 3C           	INC A
 8145 AC8C DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 8146 AC8F DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8147 AC92 0A           	LD A,(BC)
 8148 AC93 03           	INC BC
 8149 AC94 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 8150 AC97 87           	ADD A,A
 8151 AC98 9F           	SBC A,A
 8152 AC99 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 8153 AC9C 37           	SCF
 8154 AC9D 18 01        	JR PD2_LP2
 8155 AC9F
 8156 AC9F A7           PT2PD	AND A
 8157 ACA0
 8158 ACA0 08           PD2_LP2	EX AF,AF'
 8159 ACA1
 8160 ACA1 0A           PD2_LOOP LD A,(BC)
 8161 ACA2 03           	INC BC
 8162 ACA3 C6 20        	ADD A,#20
 8163 ACA5 28 3F        	JR Z,PD2_REL
 8164 ACA7 38 A9        	JR C,PD2_SAM
 8165 ACA9 C6 60        	ADD A,96
 8166 ACAB 38 3E        	JR C,PD2_NOTE
 8167 ACAD 3C           	INC A
 8168 ACAE 28 A7        	JR Z,PD2_EOff
 8169 ACB0 C6 0F        	ADD A,15
 8170 ACB2 CA C8 AD     	JP Z,PD_FIN
 8171 ACB5 38 A5        	JR C,PD2_ENV
 8172 ACB7 C6 10        	ADD A,#10
 8173 ACB9 38 B3        	JR C,PD2_ORN
 8174 ACBB C6 40        	ADD A,#40
 8175 ACBD 38 B4        	JR C,PD2_SKIP
 8176 ACBF C6 10        	ADD A,#10
 8177 ACC1 38 B6        	JR C,PD2_VOL
 8178 ACC3 3C           	INC A
 8179 ACC4 28 BC        	JR Z,PD2_DEL
 8180 ACC6 3C           	INC A
 8181 ACC7 28 BE        	JR Z,PD2_GLIS
 8182 ACC9 3C           	INC A
 8183 ACCA 28 0A        	JR Z,PD2_PORT
 8184 ACCC 3C           	INC A
 8185 ACCD 28 12        	JR Z,PD2_STOP
 8186 ACCF 0A           	LD A,(BC)
 8187 ACD0 03           	INC BC
 8188 ACD1 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 8189 ACD4 18 CB        	JR PD2_LOOP
 8190 ACD6
 8191 ACD6 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 8192 ACDA 0A           	LD A,(BC)
 8193 ACDB 03           	INC BC
 8194 ACDC 03           	INC BC ;ignoring precalc delta to right sound
 8195 ACDD 03           	INC BC
 8196 ACDE 37           	SCF
 8197 ACDF 18 BF        	JR PD2_LP2
 8198 ACE1
 8199 ACE1 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 8200 ACE4 18 BB        	JR PD2_LOOP
 8201 ACE6
 8202 ACE6 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 8203 ACE9 18 2C        	JR PD2_EXIT
 8204 ACEB
 8205 ACEB 6F           PD2_NOTE LD L,A
 8206 ACEC DD 7E 06     	LD A,(IX-12+CHP.Note)
 8207 ACEF 32 02 AE     	LD (PrNote+1),A
 8208 ACF2 DD 75 06     	LD (IX-12+CHP.Note),L
 8209 ACF5 AF           	XOR A
 8210 ACF6 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8211 ACF9 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 8212 ACFD 08           	EX AF,AF'
 8213 ACFE 30 16        	JR NC,NOGLIS2
 8214 AD00 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 8215 AD04 20 0C        	JR NZ,NOPORT2
 8216 AD06 32 28 AE     	LD (LoStep),A
 8217 AD09 87           	ADD A,A
 8218 AD0A 9F           	SBC A,A
 8219 AD0B 08           	EX AF,AF'
 8220 AD0C 67           	LD H,A
 8221 AD0D 6F           	LD L,A
 8222 AD0E 3C           	INC A
 8223 AD0F CD E3 AD     	CALL SETPORT
 8224 AD12 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 8225 AD16 AF           NOGLIS2	XOR A
 8226 AD17
 8227 AD17
 8228 AD17 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 8229 AD1A DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8230 AD1D DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 8231 AD20 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 8232 AD23 C3 C8 AD     	JP PD_FIN
 8233 AD26
 8234 AD26              ;PT3 pattern decoder
 8235 AD26 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 8236 AD2A CD C9 AE     	CALL SETORN
 8237 AD2D 0A           PD_SAM_	LD A,(BC)
 8238 AD2E 03           	INC BC
 8239 AD2F 0F           	RRCA
 8240 AD30
 8241 AD30 CD E8 AE     PD_SAM	CALL SETSAM
 8242 AD33 18 3F        	JR PD_LOOP
 8243 AD35
 8244 AD35 0F           PD_VOL	RRCA
 8245 AD36 0F           	RRCA
 8246 AD37 0F           	RRCA
 8247 AD38 0F           	RRCA
 8248 AD39 DD 77 10     	LD (IX-12+CHP.Volume),A
 8249 AD3C 18 39        	JR PD_LP2
 8250 AD3E
 8251 AD3E DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 8252 AD41 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8253 AD44 18 31        	JR PD_LP2
 8254 AD46
 8255 AD46 3D           PD_SorE	DEC A
 8256 AD47 20 07        	JR NZ,PD_ENV
 8257 AD49 0A           	LD A,(BC)
 8258 AD4A 03           	INC BC
 8259 AD4B DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 8260 AD4E 18 27        	JR PD_LP2
 8261 AD50
 8262 AD50 CD AE AE     PD_ENV	CALL SETENV
 8263 AD53 18 22        	JR PD_LP2
 8264 AD55
 8265 AD55 CD C9 AE     PD_ORN	CALL SETORN
 8266 AD58 18 1A        	JR PD_LOOP
 8267 AD5A
 8268 AD5A DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 8269 AD5D DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8270 AD60 C4 AE AE     	CALL NZ,SETENV
 8271 AD63 18 C8        	JR PD_SAM_
 8272 AD65
 8273 AD65 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 8274 AD68 32 02 AE     	LD (PrNote+1),A
 8275 AD6B DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 8276 AD6E DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 8277 AD71 22 1F AE     	LD (PrSlide+1),HL
 8278 AD74
 8279 AD74 11 10 20     PD_LOOP	LD DE,#2010
 8280 AD77 0A           PD_LP2	LD A,(BC)
 8281 AD78 03           	INC BC
 8282 AD79 83           	ADD A,E
 8283 AD7A 38 AA        	JR C,PD_OrSm
 8284 AD7C 82           	ADD A,D
 8285 AD7D 28 49        	JR Z,PD_FIN
 8286 AD7F 38 AF        	JR C,PD_SAM
 8287 AD81 83           	ADD A,E
 8288 AD82 28 25        	JR Z,PD_REL
 8289 AD84 38 AF        	JR C,PD_VOL
 8290 AD86 83           	ADD A,E
 8291 AD87 28 B5        	JR Z,PD_EOff
 8292 AD89 38 BB        	JR C,PD_SorE
 8293 AD8B C6 60        	ADD A,96
 8294 AD8D 38 20        	JR C,PD_NOTE
 8295 AD8F 83           	ADD A,E
 8296 AD90 38 C3        	JR C,PD_ORN
 8297 AD92 82           	ADD A,D
 8298 AD93 38 0F        	JR C,PD_NOIS
 8299 AD95 83           	ADD A,E
 8300 AD96 38 C2        	JR C,PD_ESAM
 8301 AD98 87           	ADD A,A
 8302 AD99 5F           	LD E,A
NextPlayer.asm(8303): warning: value 0x18E24 is truncated to 16bit value: 0x8E24
 8303 AD9A 21 24 8E     	LD HL,SPCCOMS+#FF20-#2000
 8304 AD9D 19           	ADD HL,DE
 8305 AD9E 5E           	LD E,(HL)
 8306 AD9F 23           	INC HL
 8307 ADA0 56           	LD D,(HL)
 8308 ADA1 D5           	PUSH DE
 8309 ADA2 18 D0        	JR PD_LOOP
 8310 ADA4
 8311 ADA4 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 8312 ADA7 18 CE        	JR PD_LP2
 8313 ADA9
 8314 ADA9 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 8315 ADAD 18 08        	JR PD_RES
 8316 ADAF
 8317 ADAF DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 8318 ADB2 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 8319 ADB6 AF           	XOR A
 8320 ADB7
 8321 ADB7 ED 73 C6 AD  PD_RES	LD (PDSP_+1),SP
 8322 ADBB DD F9        	LD SP,IX
 8323 ADBD 67           	LD H,A
 8324 ADBE 6F           	LD L,A
 8325 ADBF E5           	PUSH HL
 8326 ADC0 E5           	PUSH HL
 8327 ADC1 E5           	PUSH HL
 8328 ADC2 E5           	PUSH HL
 8329 ADC3 E5           	PUSH HL
 8330 ADC4 E5           	PUSH HL
 8331 ADC5 31 31 31     PDSP_	LD SP,#3131
 8332 ADC8
 8333 ADC8 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 8334 ADCB DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 8335 ADCE C9           	RET
 8336 ADCF
 8337 ADCF 0A           C_PORTM LD A,(BC)
 8338 ADD0 03           	INC BC
 8339 ADD1              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 8340 ADD1              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 8341 ADD1 03           	INC BC
 8342 ADD2 03           	INC BC
 8343 ADD3 08           	EX AF,AF'
 8344 ADD4 0A           	LD A,(BC) ;SIGNED TONE STEP
 8345 ADD5 03           	INC BC
 8346 ADD6 32 28 AE     	LD (LoStep),A
 8347 ADD9 0A           	LD A,(BC)
 8348 ADDA 03           	INC BC
 8349 ADDB A7           	AND A
 8350 ADDC 08           	EX AF,AF'
 8351 ADDD DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 8352 ADE0 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 8353 ADE3
 8354 ADE3              ;Set portamento variables
 8355 ADE3              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 8356 ADE3
 8357 ADE3 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 8358 ADE7 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 8359 ADEA DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8360 ADED E5           	PUSH HL
 8361 ADEE 11 A7 B4     	LD DE,NT_
 8362 ADF1 DD 7E 06     	LD A,(IX-12+CHP.Note)
 8363 ADF4 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 8364 ADF7 87           	ADD A,A
 8365 ADF8 6F           	LD L,A
 8366 ADF9 26 00        	LD H,0
 8367 ADFB 19           	ADD HL,DE
 8368 ADFC 7E           	LD A,(HL)
 8369 ADFD 23           	INC HL
 8370 ADFE 66           	LD H,(HL)
 8371 ADFF 6F           	LD L,A
 8372 AE00 E5           	PUSH HL
 8373 AE01 3E 3E        PrNote	LD A,#3E
 8374 AE03 DD 77 06     	LD (IX-12+CHP.Note),A
 8375 AE06 87           	ADD A,A
 8376 AE07 6F           	LD L,A
 8377 AE08 26 00        	LD H,0
 8378 AE0A 19           	ADD HL,DE
 8379 AE0B 5E           	LD E,(HL)
 8380 AE0C 23           	INC HL
 8381 AE0D 56           	LD D,(HL)
 8382 AE0E E1           	POP HL
 8383 AE0F ED 52        	SBC HL,DE
 8384 AE11 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 8385 AE14 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 8386 AE17 D1           	POP DE
 8387 AE18              Version EQU $+1
 8388 AE18 3E 3E        	LD A,#3E
 8389 AE1A FE 06        	CP 6
 8390 AE1C 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 8391 AE1E 11 11 11     PrSlide	LD DE,#1111
 8392 AE21 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 8393 AE24 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 8394 AE27              LoStep	EQU $+1
 8395 AE27 3E 3E        OLDPRTM	LD A,#3E
 8396 AE29 08           	EX AF,AF'
 8397 AE2A 28 01        	JR Z,NOSIG
 8398 AE2C EB           	EX DE,HL
 8399 AE2D ED 52        NOSIG	SBC HL,DE
 8400 AE2F F2 37 AE     	JP P,SET_STP
 8401 AE32 2F           	CPL
 8402 AE33 08           	EX AF,AF'
 8403 AE34 ED 44        	NEG
 8404 AE36 08           	EX AF,AF'
 8405 AE37 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 8406 AE3A 08           	EX AF,AF'
 8407 AE3B DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 8408 AE3E DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 8409 AE42 C9           	RET
 8410 AE43
 8411 AE43 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 8412 AE47 0A           	LD A,(BC)
 8413 AE48 03           	INC BC
 8414 AE49 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 8415 AE4C A7           	AND A
 8416 AE4D 20 07        	JR NZ,GL36
 8417 AE4F 3A 19 AE     	LD A,(Version) ;AlCo PT3.7+
 8418 AE52 FE 07        	CP 7
 8419 AE54 9F           	SBC A,A
 8420 AE55 3C           	INC A
 8421 AE56 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 8422 AE59 0A           	LD A,(BC)
 8423 AE5A 03           	INC BC
 8424 AE5B 08           	EX AF,AF'
 8425 AE5C 0A           	LD A,(BC)
 8426 AE5D 03           	INC BC
 8427 AE5E 18 D7        	JR SET_STP
 8428 AE60
 8429 AE60 0A           C_SMPOS	LD A,(BC)
 8430 AE61 03           	INC BC
 8431 AE62 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 8432 AE65 C9           	RET
 8433 AE66
 8434 AE66 0A           C_ORPOS	LD A,(BC)
 8435 AE67 03           	INC BC
 8436 AE68 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8437 AE6B C9           	RET
 8438 AE6C
 8439 AE6C 0A           C_VIBRT	LD A,(BC)
 8440 AE6D 03           	INC BC
 8441 AE6E DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 8442 AE71 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 8443 AE74 0A           	LD A,(BC)
 8444 AE75 03           	INC BC
 8445 AE76 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 8446 AE79 AF           	XOR A
 8447 AE7A DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 8448 AE7D DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 8449 AE80 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 8450 AE83 C9           	RET
 8451 AE84
 8452 AE84 0A           C_ENGLS	LD A,(BC)
 8453 AE85 03           	INC BC
 8454 AE86 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 8455 AE89 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 8456 AE8C 0A           	LD A,(BC)
 8457 AE8D 03           	INC BC
 8458 AE8E 6F           	LD L,A
 8459 AE8F 0A           	LD A,(BC)
 8460 AE90 03           	INC BC
 8461 AE91 67           	LD H,A
 8462 AE92 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 8463 AE95 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 8464 AE98 C9           	RET
 8465 AE99
 8466 AE99 0A           C_DELAY	LD A,(BC)
 8467 AE9A 03           	INC BC
 8468 AE9B FD 77 08     	LD (IY-100+VRS.Delay),A
 8469 AE9E 21 32 B3     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 8470 AEA1 CB 4E        	BIT 1,(HL)
 8471 AEA3 C8           	RET Z
 8472 AEA4 32 15 B3     	LD (VARS1+VRS.Delay),A
 8473 AEA7 32 16 B3     	LD (VARS1+VRS.DelyCnt),A
 8474 AEAA 32 9C B3     	LD (VARS2+VRS.Delay),A
 8475 AEAD C9           	RET
 8476 AEAE
 8477 AEAE DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 8478 AEB1 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 8479 AEB4 0A           	LD A,(BC)
 8480 AEB5 03           	INC BC
 8481 AEB6 67           	LD H,A
 8482 AEB7 0A           	LD A,(BC)
 8483 AEB8 03           	INC BC
 8484 AEB9 6F           	LD L,A
 8485 AEBA CD 37 AC     	CALL SETENBS
 8486 AEBD AF           	XOR A
 8487 AEBE DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 8488 AEC1 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 8489 AEC4 67           	LD H,A
 8490 AEC5 6F           	LD L,A
 8491 AEC6 C3 3E AC     	JP SETESLD
 8492 AEC9
 8493 AEC9 87           SETORN	ADD A,A
 8494 AECA 5F           	LD E,A
 8495 AECB 16 00        	LD D,0
 8496 AECD DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 8497 AED0 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 8498 AED3 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 8499 AED6 19           	ADD HL,DE
 8500 AED7 5E           	LD E,(HL)
 8501 AED8 23           	INC HL
 8502 AED9 56           	LD D,(HL)
 8503 AEDA FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 8504 AEDD FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 8505 AEE0 19           	ADD HL,DE
 8506 AEE1 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 8507 AEE4 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 8508 AEE7 C9           C_NOP	RET
 8509 AEE8
 8510 AEE8 87           SETSAM	ADD A,A
 8511 AEE9 5F           	LD E,A
 8512 AEEA 16 00        	LD D,0
 8513 AEEC FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 8514 AEEF FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 8515 AEF2 19           	ADD HL,DE
 8516 AEF3 5E           	LD E,(HL)
 8517 AEF4 23           	INC HL
 8518 AEF5 56           	LD D,(HL)
 8519 AEF6 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 8520 AEF9 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 8521 AEFC 19           	ADD HL,DE
 8522 AEFD DD 75 03     	LD (IX-12+CHP.SamPtr),L
 8523 AF00 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 8524 AF03 C9           	RET
 8525 AF04
 8526 AF04              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 8527 AF04 E7 AE        SPCCOMS DW C_NOP
 8528 AF06 43 AE        	DW C_GLISS
 8529 AF08 CF AD        	DW C_PORTM
 8530 AF0A 60 AE        	DW C_SMPOS
 8531 AF0C 66 AE        	DW C_ORPOS
 8532 AF0E 6C AE        	DW C_VIBRT
 8533 AF10 E7 AE        	DW C_NOP
 8534 AF12 E7 AE        	DW C_NOP
 8535 AF14 84 AE        	DW C_ENGLS
 8536 AF16 99 AE        	DW C_DELAY
 8537 AF18 E7 AE        	DW C_NOP
 8538 AF1A E7 AE        	DW C_NOP
 8539 AF1C E7 AE        	DW C_NOP
 8540 AF1E E7 AE        	DW C_NOP
 8541 AF20 E7 AE        	DW C_NOP
 8542 AF22 E7 AE        	DW C_NOP
 8543 AF24
 8544 AF24 CD 45 AC     CHREGS	CALL GETIX
 8545 AF27 AF           	XOR A
 8546 AF28 32 64 B1     	LD (Ampl),A
 8547 AF2B DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 8548 AF2F E5           	PUSH HL
 8549 AF30 CA 77 B0     	JP Z,CH_EXIT
 8550 AF33 ED 73 C1 AF  	LD (CSP_+1),SP
 8551 AF37 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 8552 AF3A DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
 8553 AF3D F9           	LD SP,HL
 8554 AF3E D1           	POP DE
 8555 AF3F 67           	LD H,A
 8556 AF40 DD 7E 00     	LD A,(IX+CHP.PsInOr)
 8557 AF43 6F           	LD L,A
 8558 AF44 39           	ADD HL,SP
 8559 AF45 3C           	INC A
 8560 AF46              		;PT2	PT3
 8561 AF46 3C           OrnCP	INC A	;CP E	CP D
 8562 AF47 38 01        	JR C,CH_ORPS
 8563 AF49 01           OrnLD	DB 1	;LD A,D	LD A,E
 8564 AF4A DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
 8565 AF4D DD 7E 12     	LD A,(IX+CHP.Note)
 8566 AF50 86           	ADD A,(HL)
 8567 AF51 F2 55 AF     	JP P,CH_NTP
 8568 AF54 AF           	XOR A
 8569 AF55 FE 60        CH_NTP	CP 96
 8570 AF57 38 02        	JR C,CH_NOK
 8571 AF59 3E 5F        	LD A,95
 8572 AF5B 87           CH_NOK	ADD A,A
 8573 AF5C 08           	EX AF,AF'
 8574 AF5D DD 6E 0F     	LD L,(IX+CHP.SamPtr)
 8575 AF60 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
 8576 AF63 F9           	LD SP,HL
 8577 AF64 D1           	POP DE
 8578 AF65 26 00        	LD H,0
 8579 AF67 DD 7E 01     	LD A,(IX+CHP.PsInSm)
 8580 AF6A 47           	LD B,A
 8581 AF6B 87           	ADD A,A
 8582 AF6C 87           SamClc2	ADD A,A ;or ADD A,B for PT2
 8583 AF6D 6F           	LD L,A
 8584 AF6E 39           	ADD HL,SP
 8585 AF6F F9           	LD SP,HL
 8586 AF70 78           	LD A,B
 8587 AF71 3C           	INC A
 8588 AF72              		;PT2	PT3
 8589 AF72 3C           SamCP	INC A	;CP E	CP D
 8590 AF73 38 01        	JR C,CH_SMPS
 8591 AF75 01           SamLD	DB 1	;LD A,D	LD A,E
 8592 AF76 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
 8593 AF79 C1           	POP BC
 8594 AF7A E1           	POP HL
 8595 AF7B
 8596 AF7B              ;Convert PT2 sample to PT3
 8597 AF7B              		;PT2		PT3
 8598 AF7B E1           SamCnv	POP HL  ;BIT 2,C	JR e_
 8599 AF7C E1           	POP HL
 8600 AF7D 60           	LD H,B
 8601 AF7E 20 06        	JR NZ,$+8
 8602 AF80 EB           	EX DE,HL
 8603 AF81 A7           	AND A
 8604 AF82 ED 62        	SBC HL,HL
 8605 AF84 ED 52        	SBC HL,DE
 8606 AF86 51           	LD D,C
 8607 AF87 CB 19        	RR C
 8608 AF89 9F           	SBC A,A
 8609 AF8A 2F           	CPL
 8610 AF8B E6 3E        	AND #3E
 8611 AF8D CB 19        	RR C
 8612 AF8F CB 18        	RR B
 8613 AF91 A1           	AND C
 8614 AF92 4F           	LD C,A
 8615 AF93 78           	LD A,B
 8616 AF94 1F           	RRA
 8617 AF95 1F           	RRA
 8618 AF96 CB 1A        	RR D
 8619 AF98 1F           	RRA
 8620 AF99 E6 9F        	AND #9F
 8621 AF9B 47           	LD B,A
 8622 AF9C
 8623 AF9C DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
 8624 AF9F DD 56 09     	LD D,(IX+CHP.TnAcc+1)
 8625 AFA2 19           	ADD HL,DE
 8626 AFA3 CB 70        	BIT 6,B
 8627 AFA5 28 06        	JR Z,CH_NOAC
 8628 AFA7 DD 75 08     	LD (IX+CHP.TnAcc),L
 8629 AFAA DD 74 09     	LD (IX+CHP.TnAcc+1),H
 8630 AFAD EB           CH_NOAC EX DE,HL
 8631 AFAE 08           	EX AF,AF'
NextPlayer.asm(8632): warning: value 0xB4A7 is truncated to 8bit value: 0xA7
 8632 AFAF C6 A7        	ADD A,NT_
 8633 AFB1 6F           	LD L,A
 8634 AFB2 CE B4        	ADC A,NT_/256
 8635 AFB4 95           	SUB L
 8636 AFB5 67           	LD H,A
 8637 AFB6 F9           	LD SP,HL
 8638 AFB7 E1           	POP HL
 8639 AFB8 19           	ADD HL,DE
 8640 AFB9 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
 8641 AFBC DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
 8642 AFBF 19           	ADD HL,DE
 8643 AFC0 31 31 31     CSP_	LD SP,#3131
 8644 AFC3 E3           	EX (SP),HL
 8645 AFC4 AF           	XOR A
 8646 AFC5 DD B6 05     	OR (IX+CHP.TSlCnt)
 8647 AFC8 28 3E        	JR Z,CH_AMP
 8648 AFCA DD 35 05     	DEC (IX+CHP.TSlCnt)
 8649 AFCD 20 39        	JR NZ,CH_AMP
 8650 AFCF DD 7E 16     	LD A,(IX+CHP.TnSlDl)
 8651 AFD2 DD 77 05     	LD (IX+CHP.TSlCnt),A
 8652 AFD5 DD 6E 17     	LD L,(IX+CHP.TSlStp)
 8653 AFD8 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
 8654 AFDB 7C           	LD A,H
 8655 AFDC 19           	ADD HL,DE
 8656 AFDD DD 75 06     	LD (IX+CHP.CrTnSl),L
 8657 AFE0 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
 8658 AFE3 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
 8659 AFE7 20 1F        	JR NZ,CH_AMP
 8660 AFE9 DD 5E 19     	LD E,(IX+CHP.TnDelt)
 8661 AFEC DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
 8662 AFEF A7           	AND A
 8663 AFF0 28 01        	JR Z,CH_STPP
 8664 AFF2 EB           	EX DE,HL
 8665 AFF3 ED 52        CH_STPP SBC HL,DE
 8666 AFF5 FA 08 B0     	JP M,CH_AMP
 8667 AFF8 DD 7E 13     	LD A,(IX+CHP.SlToNt)
 8668 AFFB DD 77 12     	LD (IX+CHP.Note),A
 8669 AFFE AF           	XOR A
 8670 AFFF DD 77 05     	LD (IX+CHP.TSlCnt),A
 8671 B002 DD 77 06     	LD (IX+CHP.CrTnSl),A
 8672 B005 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
 8673 B008 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
 8674 B00B CB 79        	BIT 7,C
 8675 B00D 28 13        	JR Z,CH_NOAM
 8676 B00F CB 71        	BIT 6,C
 8677 B011 28 07        	JR Z,CH_AMIN
 8678 B013 FE 0F        	CP 15
 8679 B015 28 0B        	JR Z,CH_NOAM
 8680 B017 3C           	INC A
 8681 B018 18 05        	JR CH_SVAM
 8682 B01A FE F1        CH_AMIN	CP -15
 8683 B01C 28 04        	JR Z,CH_NOAM
 8684 B01E 3D           	DEC A
 8685 B01F DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
 8686 B022 6F           CH_NOAM	LD L,A
 8687 B023 78           	LD A,B
 8688 B024 E6 0F        	AND 15
 8689 B026 85           	ADD A,L
 8690 B027 F2 2B B0     	JP P,CH_APOS
 8691 B02A AF           	XOR A
 8692 B02B FE 10        CH_APOS	CP 16
 8693 B02D 38 02        	JR C,CH_VOL
 8694 B02F 3E 0F        	LD A,15
 8695 B031 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
NextPlayer.asm(8696): warning: value 0xB3A7 is truncated to 8bit value: 0xA7
 8696 B034 C6 A7        	ADD A,VT_
 8697 B036 6F           	LD L,A
 8698 B037 CE B3        	ADC A,VT_/256
 8699 B039 95           	SUB L
 8700 B03A 67           	LD H,A
 8701 B03B 7E           	LD A,(HL)
 8702 B03C CB 41        CH_ENV	BIT 0,C
 8703 B03E 20 03        	JR NZ,CH_NOEN
 8704 B040 DD B6 14     	OR (IX+CHP.Env_En)
 8705 B043 32 64 B1     CH_NOEN	LD (Ampl),A
 8706 B046 CB 78        	BIT 7,B
 8707 B048 79           	LD A,C
 8708 B049 28 1A        	JR Z,NO_ENSL
 8709 B04B 17           	RLA
 8710 B04C 17           	RLA
 8711 B04D CB 2F        	SRA A
 8712 B04F CB 2F        	SRA A
 8713 B051 CB 2F        	SRA A
 8714 B053 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
 8715 B056 CB 68        	BIT 5,B
 8716 B058 28 03        	JR Z,NO_ENAC
 8717 B05A DD 77 04     	LD (IX+CHP.CrEnSl),A
 8718 B05D FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
 8719 B060 FD 77 12     	LD (IY-100+VRS.AddToEn),A
 8720 B063 18 0E        	JR CH_MIX
 8721 B065 1F           NO_ENSL RRA
 8722 B066 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
 8723 B069 FD 77 11     	LD (IY-100+VRS.AddToNs),A
 8724 B06C CB 68        	BIT 5,B
 8725 B06E 28 03        	JR Z,CH_MIX
 8726 B070 DD 77 03     	LD (IX+CHP.CrNsSl),A
 8727 B073 78           CH_MIX	LD A,B
 8728 B074 1F           	RRA
 8729 B075 E6 48        	AND #48
 8730 B077 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
 8731 B07A 0F           	RRCA
 8732 B07B FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
 8733 B07E E1           	POP HL
 8734 B07F AF           	XOR A
 8735 B080 DD B6 0A     	OR (IX+CHP.COnOff)
 8736 B083 C8           	RET Z
 8737 B084 DD 35 0A     	DEC (IX+CHP.COnOff)
 8738 B087 C0           	RET NZ
 8739 B088 DD AE 15     	XOR (IX+CHP.Flags)
 8740 B08B DD 77 15     	LD (IX+CHP.Flags),A
 8741 B08E 1F           	RRA
 8742 B08F DD 7E 0B     	LD A,(IX+CHP.OnOffD)
 8743 B092 38 03        	JR C,CH_ONDL
 8744 B094 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
 8745 B097 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
 8746 B09A C9           	RET
 8747 B09B
 8748 B09B AF           PLAY_	XOR A
 8749 B09C FD 77 12     	LD (IY-100+VRS.AddToEn),A
 8750 B09F FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
 8751 B0A2 3D           	DEC A
 8752 B0A3 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 8753 B0A6 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
 8754 B0A9 C2 51 B1     	JP NZ,PL2
 8755 B0AC FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
 8756 B0AF 20 6C        	JR NZ,PL1B
 8757 B0B1 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
 8758 B0B4 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
 8759 B0B7 0A           	LD A,(BC)
 8760 B0B8 A7           	AND A
 8761 B0B9 20 56        	JR NZ,PL1A
 8762 B0BB 57           	LD D,A
 8763 B0BC FD 77 10     	LD (IY-100+VRS.Ns_Base),A
 8764 B0BF FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
 8765 B0C2 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
 8766 B0C5 23           	INC HL
 8767 B0C6 7E           	LD A,(HL)
 8768 B0C7 3C           	INC A
 8769 B0C8 20 0B        	JR NZ,PLNLP
 8770 B0CA
 8771 B0CA              	IF LoopChecker
 8772 B0CA CD 7C A9     	CALL CHECKLP
 8773 B0CD              	ENDIF
 8774 B0CD
 8775 B0CD FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
 8776 B0D0 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
 8777 B0D3 7E           	LD A,(HL)
 8778 B0D4 3C           	INC A
 8779 B0D5 CD 29 AC     PLNLP	CALL SETCPPT
 8780 B0D8 3D           	DEC A
 8781 B0D9 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
 8782 B0DD 28 03        	JR Z,NoAlCo
 8783 B0DF              TSSub	EQU $+1
 8784 B0DF D6 D6        	SUB #D6
 8785 B0E1 2F           	CPL
 8786 B0E2              NoAlCo
 8787 B0E2              		;PT2		PT3
 8788 B0E2 3D           PsCalc	DEC A	;ADD A,A	NOP
 8789 B0E3 3D           	DEC A	;ADD A,(HL)	NOP
 8790 B0E4 87           	ADD A,A
 8791 B0E5 5F           	LD E,A
 8792 B0E6 CB 12        	RL D
 8793 B0E8
 8794 B0E8              	IF CurPosCounter
 8795 B0E8 ~            	LD A,L
 8796 B0E8 ~            	SUB (IY-100+VRS.PosSub)
 8797 B0E8 ~            	LD (IY-100+VRS.CurPos),A
 8798 B0E8              	ENDIF
 8799 B0E8
 8800 B0E8 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
 8801 B0EB FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
 8802 B0EE 19           	ADD HL,DE
 8803 B0EF FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
 8804 B0F2 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
 8805 B0F5 ED 73 0F B1  	LD (PSP_+1),SP
 8806 B0F9 F9           	LD SP,HL
 8807 B0FA E1           	POP HL
 8808 B0FB 19           	ADD HL,DE
 8809 B0FC 44           	LD B,H
 8810 B0FD 4D           	LD C,L
 8811 B0FE E1           	POP HL
 8812 B0FF 19           	ADD HL,DE
 8813 B100 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
 8814 B103 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
 8815 B106 E1           	POP HL
 8816 B107 19           	ADD HL,DE
 8817 B108 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
 8818 B10B FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
 8819 B10E 31 31 31     PSP_	LD SP,#3131
 8820 B111 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
 8821 B114 CD 4C AC     	CALL PTDECOD
 8822 B117 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
 8823 B11A FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
 8824 B11D
 8825 B11D FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
 8826 B120 20 12        	JR NZ,PL1C
 8827 B122 11 C8 FF     	LD DE,VRS.ChanB+12-100
 8828 B125 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
 8829 B128 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
 8830 B12B CD 4C AC     	CALL PTDECOD
 8831 B12E FD 71 00     	LD (IY-100+VRS.AdInPtB),C
 8832 B131 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
 8833 B134
 8834 B134 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
 8835 B137 20 12        	JR NZ,PL1D
 8836 B139 11 E5 FF     	LD DE,VRS.ChanC+12-100
 8837 B13C FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
 8838 B13F FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
 8839 B142 CD 4C AC     	CALL PTDECOD
 8840 B145 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
 8841 B148 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
 8842 B14B
 8843 B14B FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
 8844 B14E FD 77 09     	LD (IY-100+VRS.DelyCnt),A
 8845 B151
 8846 B151 11 9F FF     PL2	LD DE,VRS.ChanA-100
 8847 B154 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
 8848 B157 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
 8849 B15A CD 24 AF     	CALL CHREGS
 8850 B15D FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
 8851 B160 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
 8852 B163              Ampl	EQU $+1
 8853 B163 3E 3E        	LD A,#3E
 8854 B165 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 8855 B168 11 BC FF     	LD DE,VRS.ChanB-100
 8856 B16B FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
 8857 B16E FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
 8858 B171 CD 24 AF     	CALL CHREGS
 8859 B174 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
 8860 B177 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
 8861 B17A 3A 64 B1     	LD A,(Ampl)
 8862 B17D FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 8863 B180 11 D9 FF     	LD DE,VRS.ChanC-100
 8864 B183 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
 8865 B186 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
 8866 B189 CD 24 AF     	CALL CHREGS
 8867 B18C FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
 8868 B18F FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
 8869 B192 3A 64 B1     	LD A,(Ampl)
 8870 B195 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 8871 B198
 8872 B198 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
 8873 B19B FD 86 11     	ADD (IY-100+VRS.AddToNs)
 8874 B19E FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
 8875 B1A1
 8876 B1A1 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
 8877 B1A4 5F           	LD E,A
 8878 B1A5 87           	ADD A,A
 8879 B1A6 9F           	SBC A,A
 8880 B1A7 57           	LD D,A
 8881 B1A8 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
 8882 B1AB FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
 8883 B1AE 19           	ADD HL,DE
 8884 B1AF FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
 8885 B1B2 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
 8886 B1B5 19           	ADD HL,DE
 8887 B1B6 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
 8888 B1B9 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
 8889 B1BC
 8890 B1BC AF           	XOR A
 8891 B1BD FD B6 0F     	OR (IY-100+VRS.CurEDel)
 8892 B1C0 C8           	RET Z
 8893 B1C1 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
 8894 B1C4 C0           	RET NZ
 8895 B1C5 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
 8896 B1C8 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 8897 B1CB FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
 8898 B1CE FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
 8899 B1D1 19           	ADD HL,DE
 8900 B1D2 C3 3E AC     	JP SETESLD
 8901 B1D5
 8902 B1D5 FD 21 0D B3  PLAY    LD IY,VARS1+100
 8903 B1D9 CD 9B B0     	CALL PLAY_
 8904 B1DC 3A A8 B2     	LD A,(is_ts)
 8905 B1DF A7           	AND A
 8906 B1E0 28 07        	JR Z,PL_nts
 8907 B1E2 FD 21 94 B3  	LD IY,VARS2+100
 8908 B1E6 CD 9B B0     	CALL PLAY_
 8909 B1E9              PL_nts
 8910 B1E9              	IF Basic
 8911 B1E9 FD 21 3A 5C  	LD IY,#5C3A
 8912 B1ED              	ENDIF
 8913 B1ED
 8914 B1ED 01 FD FF     ROUT	LD BC,#FFFD
 8915 B1F0 3A A8 B2     	LD A,(is_ts)
 8916 B1F3 A7           	AND A
 8917 B1F4 28 02        	JR Z,r_nts ;keep old standard
 8918 B1F6 ED 41        	OUT (C),B
 8919 B1F8 08           r_nts	EX AF,AF'
 8920 B1F9
 8921 B1F9              	IF ACBBAC
 8922 B1F9 ~            	LD IX,VARS1+VRS.AYREGS
 8923 B1F9              	ELSE
 8924 B1F9 21 22 B3     	LD HL,VARS1+VRS.AYREGS
 8925 B1FC              	ENDIF
 8926 B1FC
 8927 B1FC CD 08 B2     	CALL ROUT_
 8928 B1FF 08           	EX AF,AF'
 8929 B200 C8           	RET Z
 8930 B201 42           	LD B,D
 8931 B202 2F           	CPL
 8932 B203 ED 79        	OUT (C),A
 8933 B205
 8934 B205              	IF ACBBAC
 8935 B205 ~            	LD IX,VARS2+VRS.AYREGS
 8936 B205              	ELSE
 8937 B205 21 A9 B3     	LD HL,VARS2+VRS.AYREGS
 8938 B208              	ENDIF
 8939 B208
 8940 B208              ROUT_
 8941 B208              	IF ACBBAC
 8942 B208 ~            	LD A,(SETUP)
 8943 B208 ~            	AND 12
 8944 B208 ~            	JR Z,ABC
 8945 B208 ~            	ADD A,CHTABLE
 8946 B208 ~            	LD E,A
 8947 B208 ~            	ADC A,CHTABLE/256
 8948 B208 ~            	SUB E
 8949 B208 ~            	LD D,A
 8950 B208 ~            	LD B,0
 8951 B208 ~            	PUSH IX
 8952 B208 ~            	POP HL
 8953 B208 ~            	LD A,(DE)
 8954 B208 ~            	INC DE
 8955 B208 ~            	LD C,A
 8956 B208 ~            	ADD HL,BC
 8957 B208 ~            	LD A,(IX+TonB)
 8958 B208 ~            	LD C,(HL)
 8959 B208 ~            	LD (IX+TonB),C
 8960 B208 ~            	LD (HL),A
 8961 B208 ~            	INC HL
 8962 B208 ~            	LD A,(IX+TonB+1)
 8963 B208 ~            	LD C,(HL)
 8964 B208 ~            	LD (IX+TonB+1),C
 8965 B208 ~            	LD (HL),A
 8966 B208 ~            	LD A,(DE)
 8967 B208 ~            	INC DE
 8968 B208 ~            	LD C,A
 8969 B208 ~            	ADD HL,BC
 8970 B208 ~            	LD A,(IX+AmplB)
 8971 B208 ~            	LD C,(HL)
 8972 B208 ~            	LD (IX+AmplB),C
 8973 B208 ~            	LD (HL),A
 8974 B208 ~            	LD A,(DE)
 8975 B208 ~            	INC DE
 8976 B208 ~            	LD (RxCA1),A
 8977 B208 ~            	XOR 8
 8978 B208 ~            	LD (RxCA2),A
 8979 B208 ~            	LD A,(DE)
 8980 B208 ~            	AND (IX+Mixer)
 8981 B208 ~            	LD E,A
 8982 B208 ~            	LD A,(IX+Mixer)
 8983 B208 ~            RxCA1	DB #E6
 8984 B208 ~            	AND %010010
 8985 B208 ~            	OR E
 8986 B208 ~            	LD E,A
 8987 B208 ~            	LD A,(IX+Mixer)
 8988 B208 ~            	AND %010010
 8989 B208 ~            RxCA2	OR E
 8990 B208 ~            	OR E
 8991 B208 ~            	LD (IX+Mixer),A
 8992 B208 ~            ABC
 8993 B208              	ENDIF
 8994 B208
 8995 B208 AF           	XOR A
 8996 B209 11 BF FF     	LD DE,#FFBF
 8997 B20C
 8998 B20C              	IF ACBBAC
 8999 B20C ~            	LD BC,#FFFD
 9000 B20C ~            	PUSH IX
 9001 B20C ~            	POP HL
 9002 B20C              	ENDIF
 9003 B20C
 9004 B20C ED 79        LOUT	OUT (C),A
 9005 B20E 43           	LD B,E
 9006 B20F ED A3        	OUTI
 9007 B211 42           	LD B,D
 9008 B212 3C           	INC A
 9009 B213 FE 0D        	CP 13
 9010 B215 20 F5        	JR NZ,LOUT
 9011 B217 ED 79        	OUT (C),A
 9012 B219 7E           	LD A,(HL)
 9013 B21A A7           	AND A
 9014 B21B F8           	RET M
 9015 B21C 43           	LD B,E
 9016 B21D ED 79        	OUT (C),A
 9017 B21F C9           	RET
 9018 B220
 9019 B220              	IF ACBBAC
 9020 B220 ~            CHTABLE	EQU $-4
 9021 B220 ~            	DB 4,5,15,%001001,0,7,7,%100100
 9022 B220              	ENDIF
 9023 B220
 9024 B220 64           NT_DATA	DB (T_NEW_0-T1_)*2
 9025 B221 2A           	DB TCNEW_0-T_
 9026 B222 65           	DB (T_OLD_0-T1_)*2+1
 9027 B223 00           	DB TCOLD_0-T_
 9028 B224 01           	DB (T_NEW_1-T1_)*2+1
 9029 B225 0C           	DB TCNEW_1-T_
 9030 B226 01           	DB (T_OLD_1-T1_)*2+1
 9031 B227 0C           	DB TCOLD_1-T_
 9032 B228 94           	DB (T_NEW_2-T1_)*2
 9033 B229 35           	DB TCNEW_2-T_
 9034 B22A 30           	DB (T_OLD_2-T1_)*2
 9035 B22B 0E           	DB TCOLD_2-T_
 9036 B22C 60           	DB (T_NEW_3-T1_)*2
 9037 B22D 20           	DB TCNEW_3-T_
 9038 B22E 60           	DB (T_OLD_3-T1_)*2
 9039 B22F 21           	DB TCOLD_3-T_
 9040 B230
 9041 B230              T_
 9042 B230
 9043 B230 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
 9043 B234 0D 0F 13 15
 9044 B238 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
 9045 B23C 5D 00        TCOLD_1	DB #5C+1,0
 9046 B23E 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
 9046 B242 5F 71 82 8C
 9046 B246 9C
 9047 B247 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
 9047 B24B AA AC AE AE
 9047 B24F 00
 9048 B250 57           TCNEW_3	DB #56+1
 9049 B251 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
 9049 B255 2D 2F 33 BF
 9049 B259 00
 9050 B25A 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
 9050 B25E 2B 2D 31 55
 9051 B262 BD BF 00     	DB #BC+1,#BE+1,0
 9052 B265              TCNEW_1 EQU TCOLD_1
 9053 B265 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
 9053 B269 2B 3B 4D 5F
 9054 B26D BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
 9055 B271
 9056 B271              PT3EMPTYORN EQU $-1
 9057 B271 01 00        	DB 1,0
 9058 B273
 9059 B273              ;first 12 values of tone tables (packed)
 9060 B273
NextPlayer.asm(9061): warning: value 0xDD8 is truncated to 8bit value: 0xD8
 9061 B273 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
 9062 B275 69           	DB #0755-#06EC
 9063 B276 70           	DB #07C5-#0755
 9064 B277 76           	DB #083B-#07C5
 9065 B278 7D           	DB #08B8-#083B
 9066 B279 85           	DB #093D-#08B8
 9067 B27A 8D           	DB #09CA-#093D
 9068 B27B 95           	DB #0A5F-#09CA
 9069 B27C 9D           	DB #0AFC-#0A5F
 9070 B27D A8           	DB #0BA4-#0AFC
 9071 B27E B1           	DB #0C55-#0BA4
 9072 B27F BB           	DB #0D10-#0C55
NextPlayer.asm(9073): warning: value 0xCDA is truncated to 8bit value: 0xDA
 9073 B280 0C DA        	DB #066D*2/256,#066D*2
 9074 B282 62           	DB #06CF-#066D
 9075 B283 68           	DB #0737-#06CF
 9076 B284 6D           	DB #07A4-#0737
 9077 B285 75           	DB #0819-#07A4
 9078 B286 7B           	DB #0894-#0819
 9079 B287 83           	DB #0917-#0894
 9080 B288 8A           	DB #09A1-#0917
 9081 B289 92           	DB #0A33-#09A1
 9082 B28A 9C           	DB #0ACF-#0A33
 9083 B28B A4           	DB #0B73-#0ACF
 9084 B28C AF           	DB #0C22-#0B73
 9085 B28D B8           	DB #0CDA-#0C22
NextPlayer.asm(9086): warning: value 0xE08 is truncated to 8bit value: 0x08
 9086 B28E 0E 08        	DB #0704*2/256,#0704*2
 9087 B290 6A           	DB #076E-#0704
 9088 B291 72           	DB #07E0-#076E
 9089 B292 78           	DB #0858-#07E0
 9090 B293 7E           	DB #08D6-#0858
 9091 B294 86           	DB #095C-#08D6
 9092 B295 90           	DB #09EC-#095C
 9093 B296 96           	DB #0A82-#09EC
 9094 B297 A0           	DB #0B22-#0A82
 9095 B298 AA           	DB #0BCC-#0B22
 9096 B299 B4           	DB #0C80-#0BCC
 9097 B29A BE           	DB #0D3E-#0C80
NextPlayer.asm(9098): warning: value 0xFC0 is truncated to 8bit value: 0xC0
 9098 B29B 0F C0        	DB #07E0*2/256,#07E0*2
 9099 B29D 78           	DB #0858-#07E0
 9100 B29E 88           	DB #08E0-#0858
 9101 B29F 80           	DB #0960-#08E0
 9102 B2A0 90           	DB #09F0-#0960
 9103 B2A1 98           	DB #0A88-#09F0
 9104 B2A2 A0           	DB #0B28-#0A88
 9105 B2A3 B0           	DB #0BD8-#0B28
 9106 B2A4 A8           	DB #0C80-#0BD8
 9107 B2A5 E0           	DB #0D60-#0C80
 9108 B2A6 B0           	DB #0E10-#0D60
 9109 B2A7 E8           	DB #0EF8-#0E10
 9110 B2A8
 9111 B2A8              ;vars from here can be stripped
 9112 B2A8              ;you can move VARS to any other address
 9113 B2A8
 9114 B2A8              VARS
 9115 B2A8
 9116 B2A8 00           is_ts	DB 0
 9117 B2A9
 9118 B2A9              ;ChannelsVars
 9119 B2A9              	STRUCT	CHP
 9120 B2A9 ~            ;reset group
 9121 B2A9 ~            PsInOr	DB 0
 9122 B2A9 ~            PsInSm	DB 0
 9123 B2A9 ~            CrAmSl	DB 0
 9124 B2A9 ~            CrNsSl	DB 0
 9125 B2A9 ~            CrEnSl	DB 0
 9126 B2A9 ~            TSlCnt	DB 0
 9127 B2A9 ~            CrTnSl	DW 0
 9128 B2A9 ~            TnAcc	DW 0
 9129 B2A9 ~            COnOff	DB 0
 9130 B2A9 ~            ;reset group
 9131 B2A9 ~
 9132 B2A9 ~            OnOffD	DB 0
 9133 B2A9 ~
 9134 B2A9 ~            ;IX for PTDECOD here (+12)
 9135 B2A9 ~            OffOnD	DB 0
 9136 B2A9 ~            OrnPtr	DW 0
 9137 B2A9 ~            SamPtr	DW 0
 9138 B2A9 ~            NNtSkp	DB 0
 9139 B2A9 ~            Note	DB 0
 9140 B2A9 ~            SlToNt	DB 0
 9141 B2A9 ~            Env_En	DB 0
 9142 B2A9 ~            Flags	DB 0
 9143 B2A9 ~             ;Enabled - 0, SimpleGliss - 2
 9144 B2A9 ~            TnSlDl	DB 0
 9145 B2A9 ~            TSlStp	DW 0
 9146 B2A9 ~            TnDelt	DW 0
 9147 B2A9 ~            NtSkCn	DB 0
 9148 B2A9 ~            Volume	DB 0
 9149 B2A9              	ENDS
 9150 B2A9
 9151 B2A9              	STRUCT	VRS
 9152 B2A9 ~
 9153 B2A9 ~            ;IF not works in STRUCT in SjASM :(
 9154 B2A9 ~            ;	IF CurPosCounter
 9155 B2A9 ~            CurPos	DB 0
 9156 B2A9 ~            PosSub	DB 0
 9157 B2A9 ~            ;	ENDIF
 9158 B2A9 ~
 9159 B2A9 ~            ModNum	DB 0 ;bit0: ChipNum
 9160 B2A9 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
 9161 B2A9 ~
 9162 B2A9 ~            ChanA	DS CHP
 9163 B2A9 ~            ChanB	DS CHP
 9164 B2A9 ~            ChanC	DS CHP
 9165 B2A9 ~
 9166 B2A9 ~            ;GlobalVars
 9167 B2A9 ~            MODADDR	DW 0
 9168 B2A9 ~            OrnPtrs	DW 0
 9169 B2A9 ~            SamPtrs	DW 0
 9170 B2A9 ~            PatsPtr	DW 0
 9171 B2A9 ~            AdInPtA	DW 0
 9172 B2A9 ~            AdInPtB	DW 0
 9173 B2A9 ~            AdInPtC	DW 0
 9174 B2A9 ~            CrPsPtr	DW 0
 9175 B2A9 ~            LPosPtr	DW 0
 9176 B2A9 ~            Delay	DB 0
 9177 B2A9 ~            DelyCnt	DB 0
 9178 B2A9 ~            ESldAdd	DW 0
 9179 B2A9 ~            CurESld	DW 0
 9180 B2A9 ~            Env_Del	DB 0
 9181 B2A9 ~            CurEDel	DB 0
 9182 B2A9 ~            Ns_Base	DB 0
 9183 B2A9 ~            AddToNs	DB 0
 9184 B2A9 ~            AddToEn	DB 0
 9185 B2A9 ~            EnvBase	DW 0
 9186 B2A9 ~            AYREGS	DS 14
 9187 B2A9              	ENDS
 9188 B2A9
 9189 B2A9 00 00 00...  VARS1	DS VRS
 9190 B330 00 00 00...  VARS2	DS VRS
 9191 B3B7
 9192 B3B7              VT_	EQU $-16
 9193 B3B7 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
 9194 B4A7
 9195 B4A7              T1_	EQU VT_+16 ;Tone tables data depacked here
 9196 B4A7
 9197 B4A7              T_OLD_1	EQU T1_
 9198 B4A7              T_OLD_2	EQU T_OLD_1+24
 9199 B4A7              T_OLD_3	EQU T_OLD_2+24
 9200 B4A7              T_OLD_0	EQU T_OLD_3+2
 9201 B4A7              T_NEW_0	EQU T_OLD_0
 9202 B4A7              T_NEW_1	EQU T_OLD_1
 9203 B4A7              T_NEW_2	EQU T_NEW_0+24
 9204 B4A7              T_NEW_3	EQU T_OLD_3
 9205 B4A7
 9206 B4A7              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
 9207 B4A7
 9208 B4A7 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
 9209 B567
 9210 B567              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
 9211 B567
 9212 B567              VARSEND EQU $
 9213 B567
 9214 B567              MDLADDR EQU songdata
 9215 B567
 9216 B567              ;Release 0 steps:
 9217 B567              ;04/21/2007
 9218 B567              ;Works start (PTxPlay adaptation); first beta.
 9219 B567              ;04/22/2007
 9220 B567              ;Job finished; beta-testing.
 9221 B567              ;04/23/2007
 9222 B567              ;PT v3.7 TS mode corrected (after AlCo remarks).
 9223 B567              ;04/29/2007
 9224 B567              ;Added 1.XX and 2.XX special commands interpretation for PT3
 9225 B567              ;modules of v3.7+.
 9226 B567
 9227 B567              ;Size (minimal build for ZX Spectrum):
 9228 B567              ;Code block #908 bytes
 9229 B567              ;Variables #2BF bytes (can be stripped)
 9230 B567              ;Total size #908+#2BF=#BC7 (3015) bytes
 9231 B567              	ENDMODULE
 9232 B567              ;***************************
 9233 B567              ;***************************
 9234 B567              ;***************************
 9235 B567              ;***************************
 9236 B567              ;***************************
 9237 B567              ;***************************
 9238 B567              ;***************************
 9239 B567              ;***************************
 9240 B567              ;***************************
 9241 B567              ;***************************
 9242 B567
 9243 B567
 9244 B567              			module stp
 9245 B567              @NULL = 0
 9246 B567              ;------------------------------------------------------------------------------
 9247 B567 21 26 BD     music_init:		ld	hl,songdata
 9248 B56A 22 1F B6     music_init0:	ld	(module_addr+1),hl
 9249 B56D 3E FC        		ld	a,#FC
 9250 B56F 32 98 BA     		ld	(ChA.smppos+1),a
 9251 B572 32 0A BB     		ld	(ChB.smppos+1),a
 9252 B575 32 7F BB     		ld	(ChC.smppos+1),a
 9253 B578 7E           		ld	a,(hl)
 9254 B579 23           		inc	hl
 9255 B57A 32 B1 B6     		ld	(speed+1),a
 9256 B57D CD 19 B6     		call	add_offset.de
 9257 B580 7E           		ld	a,(hl)
 9258 B581 32 66 B6     		ld	(song_length+1),a
 9259 B584 23           		inc	hl
 9260 B585 7E           		ld	a,(hl)
 9261 B586 32 75 B6     		ld	(loop_position+1),a
 9262 B589 23           		inc	hl
 9263 B58A 22 7B B6     		ld	(positions+1),hl
 9264 B58D CD 18 B6     		call	add_offset
 9265 B590 22 83 B6     		ld	(patterns+1),hl
 9266 B593 E5           		push	hl
 9267 B594 CD 18 B6     		call	add_offset
 9268 B597 22 2F B9     		ld	(ChA.ornoffs+1),hl
 9269 B59A 22 48 B8     		ld	(ChB.ornoffs+1),hl
 9270 B59D 22 63 B7     		ld	(ChC.ornoffs+1),hl
 9271 B5A0 CD 18 B6     		call	add_offset
 9272 B5A3 22 D2 B8     		ld	(ChA.smpoffs+1),hl
 9273 B5A6 22 EB B7     		ld	(ChB.smpoffs+1),hl
 9274 B5A9 22 16 B7     		ld	(ChC.smpoffs+1),hl
 9275 B5AC EB           		ex	de,hl
 9276 B5AD 7E           		ld	a,(hl)
 9277 B5AE 36 00        		ld	(hl),0
 9278 B5B0 E1           		pop	hl
 9279 B5B1 B7           		or	a
 9280 B5B2 28 0D        		jr	z,.noreloc
 9281 B5B4
 9282 B5B4 CD 19 B6     .relocator:	call	add_offset.de
 9283 B5B7 EB           		ex	de,hl
 9284 B5B8 2B           		dec	hl
 9285 B5B9 72           		ld	(hl),d
 9286 B5BA 2B           		dec	hl
 9287 B5BB 73           		ld	(hl),e
 9288 B5BC 23           		inc	hl
 9289 B5BD 23           		inc	hl
 9290 B5BE 3D           		dec	a
 9291 B5BF 20 F3        		jr	nz,.relocator
 9292 B5C1
 9293 B5C1 21 14 BD     .noreloc:	ld	hl,empty_pattern
 9294 B5C4 0E 03        		ld	c,3
 9295 B5C6 22 72 B8     		ld	(ChA.datptr+1),hl
 9296 B5C9 22 8B B7     		ld	(ChB.datptr+1),hl
 9297 B5CC 22 B8 B6     		ld	(ChC.datptr+1),hl
 9298 B5CF 67           		ld	h,a
 9299 B5D0 6F           		ld	l,a
 9300 B5D1 22 D2 B9     		ld	(ChA.Xportamnt+1),hl
 9301 B5D4 22 8E B9     		ld	(ChB.Xportamnt+1),hl
 9302 B5D7 22 CC B9     		ld	(ChA.Xpitch+1),hl
 9303 B5DA 22 88 B9     		ld	(ChB.Xpitch+1),hl
 9304 B5DD 32 A8 B6     		ld	(ChC.playback+2),a
 9305 B5E0
 9306 B5E0 32 2B BA     		ld	(chkfadeout+1),a
 9307 B5E3 32 41 BA     		ld	(apply_volume+1),a
 9308 B5E6 32 C2 BA     		ld	(ChA.attn+1),a
 9309 B5E9 32 34 BB     		ld	(ChB.attn+1),a
 9310 B5EC 32 A9 BB     		ld	(ChC.attn+1),a
 9311 B5EF 3D           		dec	a
 9312 B5F0 32 63 B6     		ld	(current_pos+1),a
 9313 B5F3 21 3E A2     		ld	hl,music_setup
 9314 B5F6 CB BE        		res	7,(hl)
 9315 B5F8
 9316 B5F8 AF           music_mute:	xor	a
 9317 B5F9 32 E7 BB     		ld	(AYREG_EnvSh+1),a
 9318 B5FC 21 19 BD     		ld	hl,AYREG_TonA
 9319 B5FF 06 0D        		ld	b,#0D
 9320 B601 77           .loopregs:	ld	(hl),a
 9321 B602 23           		inc	hl
 9322 B603 10 FC        		djnz	.loopregs
 9323 B605 79           		ld	a,c
 9324 B606 32 24 BD     		ld	(tempocnt_0),a
 9325 B609 01 FD FF     		ld	bc,#FFFD
 9326 B60C 3E 0C        		ld	a,#0C
 9327 B60E ED 79        		out	(c),a
 9328 B610 AF           		xor	a
 9329 B611 06 BF        		ld	b,#BF
 9330 B613 ED 79        		out	(c),a
 9331 B615 C3 D9 BB     		jp	outay
 9332 B618
 9333 B618 EB           add_offset	ex	de,hl
 9334 B619 5E           .de		ld	e,(hl)
 9335 B61A 23           		inc	hl
 9336 B61B 56           		ld	d,(hl)
 9337 B61C 23           		inc	hl
 9338 B61D EB           		ex	de,hl
 9339 B61E 01 00 00     module_addr:	ld	bc,0
 9340 B621 09           		add	hl,bc
 9341 B622 C9           		ret
 9342 B623
 9343 B623              ; ---------------------------------------------------------------------------
 9344 B623 21 3E A2     resetfadeout:	ld	hl,music_setup
 9345 B626 CB FE        noloop:		set	7,(hl)
 9346 B628 AF           		xor	a
 9347 B629 32 1F BD     		ld	(AYREG_AmplA),a
 9348 B62C 32 20 BD     		ld	(AYREG_AmplB),a
 9349 B62F 32 21 BD     		ld	(AYREG_AmplC),a
 9350 B632 32 E7 BB     		ld	(AYREG_EnvSh+1),a
 9351 B635 3D           		dec	a
 9352 B636 32 24 BD     		ld	(tempocnt_0),a
 9353 B639 32 2B BA     		ld	(chkfadeout+1),a
 9354 B63C DD 2E 3F     		ld	xl,#3F
 9355 B63F C3 D6 BB     		jp	retsp
 9356 B642
 9357 B642 3E 30        enablefade:	ld	a,48
 9358 B644 32 2B BA     forcefade:	ld	(chkfadeout+1),a
 9359 B647 32 37 BA     		ld	(countfadeout+1),a
 9360 B64A 32 6A BA     		ld	(divfadeout+1),a
 9361 B64D AF           		xor	a
 9362 B64E 32 41 BA     		ld	(apply_volume+1),a
 9363 B651 18 21        		jr	loop_position
 9364 B653
 9365 B653              ; ---------------------------------------------------------------------------
 9366 B653 2A 8B B7     new_position:	ld	hl,(ChB.datptr+1)
 9367 B656 B6           		or	(hl)
 9368 B657 C2 2A BA     		jp	nz,chkfadeout
 9369 B65A 2A B8 B6     		ld	hl,(ChC.datptr+1)
 9370 B65D B6           		or	(hl)
 9371 B65E C2 2A BA     		jp	nz,chkfadeout
 9372 B661 47           		ld	b,a
 9373 B662 3E 00        current_pos:	ld	a,0
 9374 B664 3C           		inc	a
 9375 B665 FE 00        song_length:	cp	0
 9376 B667 20 0D        		jr	nz,song_continue
 9377 B669 21 3E A2     		ld	hl,music_setup
 9378 B66C CB 4E        		bit	1,(hl)
 9379 B66E 20 D2        		jr	nz,enablefade
 9380 B670 CB 46        		bit	0,(hl)
 9381 B672 20 B2        		jr	nz,noloop
 9382 B674 3E 00        loop_position:	ld	a,0
 9383 B676 32 63 B6     song_continue:	ld	(current_pos+1),a
 9384 B679 4F           		ld	c,a
 9385 B67A
 9386 B67A 21 00 00     positions:	ld	hl,NULL
 9387 B67D 09           		add	hl,bc
 9388 B67E 09           		add	hl,bc
 9389 B67F 4E           		ld	c,(hl)
 9390 B680 23           		inc	hl
 9391 B681 7E           		ld	a,(hl)
 9392 B682
 9393 B682 21 00 00     patterns:	ld	hl,NULL
 9394 B685 09           		add	hl,bc
 9395 B686 F9           		ld	sp,hl
 9396 B687 E1           		pop	hl
 9397 B688 22 72 B8     		ld	(ChA.datptr+1),hl
 9398 B68B E1           		pop	hl
 9399 B68C 22 8B B7     		ld	(ChB.datptr+1),hl
 9400 B68F E1           		pop	hl
 9401 B690 22 B8 B6     		ld	(ChC.datptr+1),hl
 9402 B693 C6 60        		add	a,#60
 9403 B695 32 A8 B6     		ld	(ChC.playback+2),a
 9404 B698 47           		ld	b,a
 9405 B699 0E F0        		ld	c,#F0
 9406 B69B C3 71 B8     		jp	ChA.datptr
 9407 B69E
 9408 B69E              ; ----------------------------------------------------------------------------
 9409 B69E F3           music_play:	di
 9410 B69F ED 73 D7 BB  		ld	(retsp+1),sp
 9411 B6A3 16 00        		ld	d,0
 9412 B6A5 D9           		exx
 9413 B6A6 01 F0 60     ChC.playback:	ld	bc,#60F0
 9414 B6A9 21 24 BD     		ld	hl,tempocnt_0
 9415 B6AC 35           		dec	(hl)
 9416 B6AD C2 7E B7     		jp	nz,ChB.playback
 9417 B6B0 36 00        @speed:		ld	(hl),0
 9418 B6B2 23           		inc	hl
 9419 B6B3 35           		dec	(hl)
 9420 B6B4 F2 7B B9     		jp	p,ChB.Xsmpptr
 9421 B6B7 21 00 00     ChC.datptr:	ld	hl,NULL
 9422 B6BA B6           		or	(hl)
 9423 B6BB CA 7B B9     		jp	z,ChB.Xsmpptr
 9424 B6BE 7E           ChC.readpatt:	ld	a,(hl)
 9425 B6BF 23           		inc	hl
 9426 B6C0 FE C0        		cp	#C0
 9427 B6C2 38 0E        		jr	c,ChC.nocmd
 9428 B6C4 91           		sub	c
 9429 B6C5 30 38        		jr	nc,ChC.setvol
 9430 B6C7 91           		sub	c
 9431 B6C8 D2 73 B9     		jp	nc,ChC.nop
 9432 B6CB 91           		sub	c
 9433 B6CC 30 39        		jr	nc,ChC.setrst
 9434 B6CE 91           		sub	c
 9435 B6CF C3 35 B7     		jp	ChC.setenv
 9436 B6D2
 9437 B6D2 D6 80        ChC.nocmd:	sub	#80
 9438 B6D4 30 59        		jr	nc,ChC.setspd
 9439 B6D6 91           		sub	c
 9440 B6D7 D2 5A B7     		jp	nc,ChC.setorn
 9441 B6DA 99           		sbc	a,c
 9442 B6DB 30 35        		jr	nc,ChC.setsmp
 9443 B6DD 80           		add	a,b
 9444 B6DE 32 75 BB     		ld	(ChC.note+1),a
 9445 B6E1 22 B8 B6     		ld	(ChC.datptr+1),hl
 9446 B6E4 AF           		xor	a
 9447 B6E5 32 7F BB     		ld	(ChC.smppos+1),a
 9448 B6E8 32 63 BB     		ld	(ChC.ornpos+1),a
 9449 B6EB 6F           		ld	l,a
 9450 B6EC 67           		ld	h,a
 9451 B6ED 22 C3 BB     		ld	(ChC.pitch+1),hl
 9452 B6F0 C3 76 B9     		jp	ChC.exit
 9453 B6F3
 9454 B6F3 7E           ChC.setport:	ld	a,(hl)
 9455 B6F4 23           		inc	hl
 9456 B6F5 32 C6 BB     		ld	(ChC.portamnt+1),a
 9457 B6F8 17           		rla
 9458 B6F9 9F           		sbc	a,a
 9459 B6FA 32 C7 BB     		ld	(ChC.portamnt+2),a
 9460 B6FD 18 BF        		jr	ChC.readpatt
 9461 B6FF
 9462 B6FF 28 F2        ChC.setvol:	jr	z,ChC.setport
 9463 B701 3D           		dec	a
 9464 B702 32 9D BB     		ld	(ChC.volume+1),a
 9465 B705 18 B7        		jr	ChC.readpatt
 9466 B707
 9467 B707 3E FC        ChC.setrst:	ld	a,#FC
 9468 B709 32 7F BB     		ld	(ChC.smppos+1),a
 9469 B70C 22 B8 B6     		ld	(ChC.datptr+1),hl
 9470 B70F C3 76 B9     		jp	ChC.exit
 9471 B712
 9472 B712 87           ChC.setsmp:	add	a,a
 9473 B713 D9           		exx
 9474 B714 5F           		ld	e,a
 9475 B715 21 00 00     ChC.smpoffs:	ld	hl,NULL
 9476 B718 19           		add	hl,de
 9477 B719 F9           		ld	sp,hl
 9478 B71A E1           		pop	hl
 9479 B71B 7E           		ld	a,(hl)
 9480 B71C 87           		add	a,a
 9481 B71D 87           		add	a,a
 9482 B71E 32 90 BB     		ld	(ChC.smploop+1),a
 9483 B721 23           		inc	hl
 9484 B722 7E           		ld	a,(hl)
 9485 B723 87           		add	a,a
 9486 B724 87           		add	a,a
 9487 B725 32 8C BB     		ld	(ChC.smplen+1),a
 9488 B728 22 81 BB     		ld	(ChC.smpptr+1),hl
 9489 B72B D9           		exx
 9490 B72C C3 BE B6     		jp	ChC.readpatt
 9491 B72F
 9492 B72F 32 77 B9     ChC.setspd:	ld	(ChC.exit+1),a
 9493 B732 C3 BE B6     		jp	ChC.readpatt
 9494 B735
 9495 B735 32 04 BA     ChC.setenv:	ld	(env.shape+1),a
 9496 B738 3E 1F        		ld	a,#1F
 9497 B73A 32 AF BB     		ld	(ChC.ampl+1),a
 9498 B73D 7E           		ld	a,(hl)
 9499 B73E 23           		inc	hl
 9500 B73F 32 09 BA     		ld	(env.period+1),a
 9501 B742 11 11 BD     		ld	de,empty_orn
 9502 B745 ED 53 66 BB  		ld	(ChC.ornptr+1),de
 9503 B749 AF           		xor	a
 9504 B74A 32 70 BB     		ld	(ChC.ornloop+1),a
 9505 B74D 32 C6 BB     		ld	(ChC.portamnt+1),a
 9506 B750 32 C7 BB     		ld	(ChC.portamnt+2),a
 9507 B753 3C           		inc	a
 9508 B754 32 6C BB     		ld	(ChC.ornlen+1),a
 9509 B757 C3 BE B6     		jp	ChC.readpatt
 9510 B75A
 9511 B75A 87           ChC.setorn:	add	a,a
 9512 B75B D9           		exx
 9513 B75C 5F           		ld	e,a
 9514 B75D 3E 0F        		ld	a,#0F
 9515 B75F 32 AF BB     		ld	(ChC.ampl+1),a
 9516 B762 21 00 00     ChC.ornoffs:	ld	hl,NULL
 9517 B765 19           		add	hl,de
 9518 B766 F9           		ld	sp,hl
 9519 B767 E1           		pop	hl
 9520 B768 7E           		ld	a,(hl)
 9521 B769 32 70 BB     		ld	(ChC.ornloop+1),a
 9522 B76C 23           		inc	hl
 9523 B76D 7E           		ld	a,(hl)
 9524 B76E 32 6C BB     		ld	(ChC.ornlen+1),a
 9525 B771 23           		inc	hl
 9526 B772 22 66 BB     		ld	(ChC.ornptr+1),hl
 9527 B775 6A           		ld	l,d
 9528 B776 62           		ld	h,d
 9529 B777 22 C6 BB     		ld	(ChC.portamnt+1),hl
 9530 B77A D9           		exx
 9531 B77B C3 BE B6     		jp	ChC.readpatt
 9532 B77E
 9533 B77E              ; ---------------------------------------------------------------------------
 9534 B77E 7E           ChB.playback:	ld	a,(hl)
 9535 B77F 3D           		dec	a
 9536 B780 C2 68 B8     		jp	nz,ChA.playback
 9537 B783 21 22 BD     		ld	hl,tempocnt_2
 9538 B786 35           		dec	(hl)
 9539 B787 F2 2A BA     		jp	p,chkfadeout
 9540 B78A 21 00 00     ChB.datptr:	ld	hl,NULL
 9541 B78D B6           		or	(hl)
 9542 B78E CA 2A BA     		jp	z,chkfadeout
 9543 B791 7E           ChB.readpatt:	ld	a,(hl)
 9544 B792 23           		inc	hl
 9545 B793 FE C0        		cp	#C0
 9546 B795 38 0C        		jr	c,ChB.nocmd
 9547 B797 91           		sub	c
 9548 B798 30 30        		jr	nc,ChB.setvol
 9549 B79A 91           		sub	c
 9550 B79B 30 35        		jr	nc,ChB.nop
 9551 B79D 91           		sub	c
 9552 B79E 30 3D        		jr	nc,ChB.setrst
 9553 B7A0 91           		sub	c
 9554 B7A1 18 65        		jr	ChB.setenv
 9555 B7A3
 9556 B7A3 D6 80        ChB.nocmd:	sub	#80
 9557 B7A5 30 5C        		jr	nc,ChB.setspd
 9558 B7A7 91           		sub	c
 9559 B7A8 D2 3F B8     		jp	nc,ChB.setorn
 9560 B7AB 99           		sbc	a,c
 9561 B7AC 30 39        		jr	nc,ChB.setsmp
 9562 B7AE 80           		add	a,b
 9563 B7AF 32 B2 B9     		ld	(ChB.Xnote+1),a
 9564 B7B2 22 8B B7     		ld	(ChB.datptr+1),hl
 9565 B7B5 AF           		xor	a
 9566 B7B6 32 B7 B9     		ld	(ChB.Xsmppos+1),a
 9567 B7B9 6F           		ld	l,a
 9568 B7BA 67           		ld	h,a
 9569 B7BB 22 88 B9     		ld	(ChB.Xpitch+1),hl
 9570 B7BE 3E 22        		ld	a,#22
 9571 B7C0 32 8A B9     		ld	(ChB.Xinst1),a
 9572 B7C3 3E 32        		ld	a,#32
 9573 B7C5 32 14 BA     		ld	(ChB.Xinst2),a
 9574 B7C8 18 0B        		jr	ChB.exit
 9575 B7CA
 9576 B7CA 28 66        ChB.setvol:	jr	z,ChB.setport
 9577 B7CC 3D           		dec	a
 9578 B7CD 32 A8 B9     		ld	(ChB.Xvolume+1),a
 9579 B7D0 18 BF        		jr	ChB.readpatt
 9580 B7D2
 9581 B7D2 22 8B B7     ChB.nop:	ld	(ChB.datptr+1),hl
 9582 B7D5 3E 00        ChB.exit:	ld	a,0
 9583 B7D7 32 22 BD     		ld	(tempocnt_2),a
 9584 B7DA C3 2A BA     		jp	chkfadeout
 9585 B7DD
 9586 B7DD 3E FC        ChB.setrst:	ld	a,#FC
 9587 B7DF 32 B7 B9     		ld	(ChB.Xsmppos+1),a
 9588 B7E2 22 8B B7     		ld	(ChB.datptr+1),hl
 9589 B7E5 18 EE        		jr	ChB.exit
 9590 B7E7
 9591 B7E7 87           ChB.setsmp:	add	a,a
 9592 B7E8 D9           		exx
 9593 B7E9 5F           		ld	e,a
 9594 B7EA 21 00 00     ChB.smpoffs:	ld	hl,NULL
 9595 B7ED 19           		add	hl,de
 9596 B7EE F9           		ld	sp,hl
 9597 B7EF E1           		pop	hl
 9598 B7F0 7E           		ld	a,(hl)
 9599 B7F1 87           		add	a,a
 9600 B7F2 87           		add	a,a
 9601 B7F3 32 A3 B9     		ld	(ChB.Xsmploop+1),a
 9602 B7F6 23           		inc	hl
 9603 B7F7 7E           		ld	a,(hl)
 9604 B7F8 87           		add	a,a
 9605 B7F9 87           		add	a,a
 9606 B7FA 32 99 B9     		ld	(ChB.Xsmplen+1),a
 9607 B7FD 22 7C B9     		ld	(ChB.Xsmpptr+1),hl
 9608 B800 D9           		exx
 9609 B801 18 8E        		jr	ChB.readpatt
 9610 B803
 9611 B803 32 D6 B7     ChB.setspd:	ld	(ChB.exit+1),a
 9612 B806 18 89        		jr	ChB.readpatt
 9613 B808
 9614 B808 32 04 BA     ChB.setenv:	ld	(env.shape+1),a
 9615 B80B 3E 1F        		ld	a,#1F
 9616 B80D 32 AD B9     		ld	(ChB.Xampl+1),a
 9617 B810 7E           		ld	a,(hl)
 9618 B811 23           		inc	hl
 9619 B812 32 09 BA     		ld	(env.period+1),a
 9620 B815 11 11 BD     		ld	de,empty_orn
 9621 B818 ED 53 82 B9  		ld	(ChB.Xornptr+1),de
 9622 B81C 3E 22        		ld	a,#22
 9623 B81E 32 90 B9     		ld	(ChB.Xinst3),a
 9624 B821 AF           		xor	a
 9625 B822 32 9E B9     		ld	(ChB.Xornloop+1),a
 9626 B825 32 8E B9     		ld	(ChB.Xportamnt+1),a
 9627 B828 32 8F B9     		ld	(ChB.Xportamnt+2),a
 9628 B82B 3C           		inc	a
 9629 B82C 32 94 B9     		ld	(ChB.Xornlen+1),a
 9630 B82F C3 91 B7     		jp	ChB.readpatt
 9631 B832
 9632 B832 7E           ChB.setport:	ld	a,(hl)
 9633 B833 23           		inc	hl
 9634 B834 32 8E B9     		ld	(ChB.Xportamnt+1),a
 9635 B837 17           		rla
 9636 B838 9F           		sbc	a,a
 9637 B839 32 8F B9     		ld	(ChB.Xportamnt+2),a
 9638 B83C C3 91 B7     		jp	ChB.readpatt
 9639 B83F
 9640 B83F 87           ChB.setorn:	add	a,a
 9641 B840 D9           		exx
 9642 B841 5F           		ld	e,a
 9643 B842 3E 0F        		ld	a,#0F
 9644 B844 32 AD B9     		ld	(ChB.Xampl+1),a
 9645 B847 21 00 00     ChB.ornoffs:	ld	hl,NULL
 9646 B84A 19           		add	hl,de
 9647 B84B F9           		ld	sp,hl
 9648 B84C E1           		pop	hl
 9649 B84D 7E           		ld	a,(hl)
 9650 B84E 32 9E B9     		ld	(ChB.Xornloop+1),a
 9651 B851 23           		inc	hl
 9652 B852 7E           		ld	a,(hl)
 9653 B853 32 94 B9     		ld	(ChB.Xornlen+1),a
 9654 B856 23           		inc	hl
 9655 B857 22 82 B9     		ld	(ChB.Xornptr+1),hl
 9656 B85A 6A           		ld	l,d
 9657 B85B 62           		ld	h,d
 9658 B85C 22 8E B9     		ld	(ChB.Xportamnt+1),hl
 9659 B85F 3E 22        		ld	a,#22
 9660 B861 32 90 B9     		ld	(ChB.Xinst3),a
 9661 B864 D9           		exx
 9662 B865 C3 91 B7     		jp	ChB.readpatt
 9663 B868
 9664 B868              ; ---------------------------------------------------------------------------
 9665 B868 3D           ChA.playback:	dec	a
 9666 B869 C2 2A BA     		jp	nz,chkfadeout
 9667 B86C 2B           		dec	hl
 9668 B86D 35           		dec	(hl)
 9669 B86E F2 2A BA     		jp	p,chkfadeout
 9670 B871 21 00 00     ChA.datptr:	ld	hl,NULL
 9671 B874 B6           		or	(hl)
 9672 B875 CA 53 B6     		jp	z,new_position
 9673 B878 7E           ChA.readpatt:	ld	a,(hl)
 9674 B879 23           		inc	hl
 9675 B87A FE C0        		cp	#C0
 9676 B87C 38 0C        		jr	c,ChA.nocmd
 9677 B87E 91           		sub	c
 9678 B87F 30 30        		jr	nc,ChA.setvol
 9679 B881 91           		sub	c
 9680 B882 30 35        		jr	nc,ChA.nop
 9681 B884 91           		sub	c
 9682 B885 30 3D        		jr	nc,ChA.setrst
 9683 B887 91           		sub	c
 9684 B888 18 65        		jr	ChA.setenv
 9685 B88A
 9686 B88A D6 80        ChA.nocmd:	sub	#80
 9687 B88C 30 5C        		jr	nc,ChA.setspd
 9688 B88E 91           		sub	c
 9689 B88F D2 26 B9     		jp	nc,ChA.setorn
 9690 B892 99           		sbc	a,c
 9691 B893 30 39        		jr	nc,ChA.setsmp
 9692 B895 80           		add	a,b
 9693 B896 32 F6 B9     		ld	(ChA.Xnote+1),a
 9694 B899 22 72 B8     		ld	(ChA.datptr+1),hl
 9695 B89C AF           		xor	a
 9696 B89D 32 FB B9     		ld	(ChA.Xsmppos+1),a
 9697 B8A0 6F           		ld	l,a
 9698 B8A1 67           		ld	h,a
 9699 B8A2 22 CC B9     		ld	(ChA.Xpitch+1),hl
 9700 B8A5 3E 22        		ld	a,#22
 9701 B8A7 32 CE B9     		ld	(ChA.Xinst1),a
 9702 B8AA 3E 32        		ld	a,#32
 9703 B8AC 32 11 BA     		ld	(ChA.Xinst2),a
 9704 B8AF 18 0B        		jr	ChA.exit
 9705 B8B1
 9706 B8B1 28 66        ChA.setvol:	jr	z,ChA.setport
 9707 B8B3 3D           		dec	a
 9708 B8B4 32 EC B9     		ld	(ChA.Xvolume+1),a
 9709 B8B7 18 BF        		jr	ChA.readpatt
 9710 B8B9
 9711 B8B9 22 72 B8     ChA.nop:	ld	(ChA.datptr+1),hl
 9712 B8BC 3E 00        ChA.exit:	ld	a,0
 9713 B8BE 32 23 BD     		ld	(tempocnt_1),a
 9714 B8C1 C3 2A BA     		jp	chkfadeout
 9715 B8C4
 9716 B8C4 3E FC        ChA.setrst:	ld	a,#FC
 9717 B8C6 32 FB B9     		ld	(ChA.Xsmppos+1),a
 9718 B8C9 22 72 B8     		ld	(ChA.datptr+1),hl
 9719 B8CC 18 EE        		jr	ChA.exit
 9720 B8CE
 9721 B8CE 87           ChA.setsmp:	add	a,a
 9722 B8CF D9           		exx
 9723 B8D0 5F           		ld	e,a
 9724 B8D1 21 00 00     ChA.smpoffs:	ld	hl,NULL
 9725 B8D4 19           		add	hl,de
 9726 B8D5 F9           		ld	sp,hl
 9727 B8D6 E1           		pop	hl
 9728 B8D7 7E           		ld	a,(hl)
 9729 B8D8 87           		add	a,a
 9730 B8D9 87           		add	a,a
 9731 B8DA 32 E7 B9     		ld	(ChA.Xsmploop+1),a
 9732 B8DD 23           		inc	hl
 9733 B8DE 7E           		ld	a,(hl)
 9734 B8DF 87           		add	a,a
 9735 B8E0 87           		add	a,a
 9736 B8E1 32 DD B9     		ld	(ChA.Xsmplen+1),a
 9737 B8E4 22 C0 B9     		ld	(ChA.Xsmpptr+1),hl
 9738 B8E7 D9           		exx
 9739 B8E8 18 8E        		jr	ChA.readpatt
 9740 B8EA
 9741 B8EA 32 BD B8     ChA.setspd:	ld	(ChA.exit+1),a
 9742 B8ED 18 89        		jr	ChA.readpatt
 9743 B8EF
 9744 B8EF 32 04 BA     ChA.setenv:	ld	(env.shape+1),a
 9745 B8F2 3E 1F        		ld	a,#1F
 9746 B8F4 32 F1 B9     		ld	(ChA.Xampl+1),a
 9747 B8F7 7E           		ld	a,(hl)
 9748 B8F8 23           		inc	hl
 9749 B8F9 32 09 BA     		ld	(env.period+1),a
 9750 B8FC 11 11 BD     		ld	de,empty_orn
 9751 B8FF ED 53 C6 B9  		ld	(ChA.Xornptr+1),de
 9752 B903 3E 22        		ld	a,#22
 9753 B905 32 D4 B9     		ld	(ChA.Xinst3),a
 9754 B908 AF           		xor	a
 9755 B909 32 E2 B9     		ld	(ChA.Xornloop+1),a
 9756 B90C 32 D2 B9     		ld	(ChA.Xportamnt+1),a
 9757 B90F 32 D3 B9     		ld	(ChA.Xportamnt+2),a
 9758 B912 3C           		inc	a
 9759 B913 32 D8 B9     		ld	(ChA.Xornlen+1),a
 9760 B916 C3 78 B8     		jp	ChA.readpatt
 9761 B919
 9762 B919 7E           ChA.setport:	ld	a,(hl)
 9763 B91A 23           		inc	hl
 9764 B91B 32 D2 B9     		ld	(ChA.Xportamnt+1),a
 9765 B91E 17           		rla
 9766 B91F 9F           		sbc	a,a
 9767 B920 32 D3 B9     		ld	(ChA.Xportamnt+2),a
 9768 B923 C3 78 B8     		jp	ChA.readpatt
 9769 B926
 9770 B926 87           ChA.setorn:	add	a,a
 9771 B927 D9           		exx
 9772 B928 5F           		ld	e,a
 9773 B929 3E 0F        		ld	a,#0F
 9774 B92B 32 F1 B9     		ld	(ChA.Xampl+1),a
 9775 B92E 21 00 00     ChA.ornoffs:	ld	hl,NULL
 9776 B931 19           		add	hl,de
 9777 B932 F9           		ld	sp,hl
 9778 B933 E1           		pop	hl
 9779 B934 7E           		ld	a,(hl)
 9780 B935 32 E2 B9     		ld	(ChA.Xornloop+1),a
 9781 B938 23           		inc	hl
 9782 B939 7E           		ld	a,(hl)
 9783 B93A 32 D8 B9     		ld	(ChA.Xornlen+1),a
 9784 B93D 23           		inc	hl
 9785 B93E 22 C6 B9     		ld	(ChA.Xornptr+1),hl
 9786 B941 6A           		ld	l,d
 9787 B942 62           		ld	h,d
 9788 B943 22 D2 B9     		ld	(ChA.Xportamnt+1),hl
 9789 B946 3E 22        		ld	a,#22
 9790 B948 32 D4 B9     		ld	(ChA.Xinst3),a
 9791 B94B D9           		exx
 9792 B94C C3 78 B8     		jp	ChA.readpatt
 9793 B94F
 9794 B94F              ; ---------------------------------------------------------------------------
 9795 B94F AF           ChA.mute:	xor	a
 9796 B950 32 1F BD     		ld	(AYREG_AmplA),a
 9797 B953 DD 2E 09     		ld	xl,9
 9798 B956 C3 ED BA     		jp	ChB.ornpos
 9799 B959
 9800 B959 AF           ChB.mute:	xor	a
 9801 B95A 32 20 BD     		ld	(AYREG_AmplB),a
 9802 B95D DD 7D        		ld	a,xl
 9803 B95F F6 12        		or	#12
 9804 B961 DD 6F        		ld	xl,a
 9805 B963 C3 62 BB     		jp	ChC.ornpos
 9806 B966
 9807 B966 AF           ChC.mute:	xor	a
 9808 B967 32 21 BD     		ld	(AYREG_AmplC),a
 9809 B96A DD 7D        		ld	a,xl
 9810 B96C F6 24        		or	#24
 9811 B96E DD 6F        		ld	xl,a
 9812 B970 C3 D6 BB     		jp	retsp
 9813 B973
 9814 B973              ; ---------------------------------------------------------------------------
 9815 B973 22 B8 B6     ChC.nop:	ld	(ChC.datptr+1),hl
 9816 B976 3E 00        ChC.exit:	ld	a,0
 9817 B978 32 25 BD     		ld	(pattstep_cnt),a
 9818 B97B 21 00 00     ChB.Xsmpptr:	ld	hl,NULL
 9819 B97E 22 0C BB     		ld	(ChB.smpptr+1),hl
 9820 B981 21 00 00     ChB.Xornptr:	ld	hl,NULL
 9821 B984 22 F1 BA     		ld	(ChB.ornptr+1),hl
 9822 B987 21 00 00     ChB.Xpitch:	ld	hl,NULL
 9823 B98A 22 4F BB     ChB.Xinst1:	ld	(ChB.pitch+1),hl
 9824 B98D 21 00 00     ChB.Xportamnt:	ld	hl,NULL
 9825 B990 22 52 BB     ChB.Xinst3:	ld	(ChB.portamnt+1),hl
 9826 B993 3E 00        ChB.Xornlen:	ld	a,0
 9827 B995 32 F7 BA     		ld	(ChB.ornlen+1),a
 9828 B998 3E 00        ChB.Xsmplen:	ld	a,0
 9829 B99A 32 17 BB     		ld	(ChB.smplen+1),a
 9830 B99D 3E 00        ChB.Xornloop:	ld	a,0
 9831 B99F 32 FB BA     		ld	(ChB.ornloop+1),a
 9832 B9A2 3E 00        ChB.Xsmploop:	ld	a,0
 9833 B9A4 32 1B BB     		ld	(ChB.smploop+1),a
 9834 B9A7 3E 00        ChB.Xvolume:	ld	a,0
 9835 B9A9 32 28 BB     		ld	(ChB.volume+1),a
 9836 B9AC 3E 0F        ChB.Xampl:	ld	a,#0F
 9837 B9AE 32 3A BB     		ld	(ChB.ampl+1),a
 9838 B9B1 3E 00        ChB.Xnote:	ld	a,0
 9839 B9B3 32 00 BB     		ld	(ChB.note+1),a
 9840 B9B6 3E 00        ChB.Xsmppos:	ld	a,0
 9841 B9B8 FE 01        		cp	1
 9842 B9BA 28 03        		jr	z,ChA.Xsmpptr
 9843 B9BC 32 0A BB     		ld	(ChB.smppos+1),a
 9844 B9BF 21 00 00     ChA.Xsmpptr:	ld	hl,NULL
 9845 B9C2 22 9A BA     		ld	(ChA.smpptr+1),hl
 9846 B9C5 21 00 00     ChA.Xornptr:	ld	hl,NULL
 9847 B9C8 22 7F BA     		ld	(ChA.ornptr+1),hl
 9848 B9CB 21 00 00     ChA.Xpitch:	ld	hl,NULL
 9849 B9CE 22 D3 BA     ChA.Xinst1:	ld	(ChA.pitch+1),hl
 9850 B9D1 21 00 00     ChA.Xportamnt:	ld	hl,NULL
 9851 B9D4 22 D6 BA     ChA.Xinst3:	ld	(ChA.portamnt+1),hl
 9852 B9D7 3E 00        ChA.Xornlen:	ld	a,0
 9853 B9D9 32 85 BA     		ld	(ChA.ornlen+1),a
 9854 B9DC 3E 00        ChA.Xsmplen:	ld	a,0
 9855 B9DE 32 A5 BA     		ld	(ChA.smplen+1),a
 9856 B9E1 3E 00        ChA.Xornloop:	ld	a,0
 9857 B9E3 32 89 BA     		ld	(ChA.ornloop+1),a
 9858 B9E6 3E 00        ChA.Xsmploop:	ld	a,0
 9859 B9E8 32 A9 BA     		ld	(ChA.smploop+1),a
 9860 B9EB 3E 00        ChA.Xvolume:	ld	a,0
 9861 B9ED 32 B6 BA     		ld	(ChA.volume+1),a
 9862 B9F0 3E 0F        ChA.Xampl:	ld	a,#0F
 9863 B9F2 32 C8 BA     		ld	(ChA.ampl+1),a
 9864 B9F5 3E 00        ChA.Xnote:	ld	a,0
 9865 B9F7 32 8E BA     		ld	(ChA.note+1),a
 9866 B9FA 3E 00        ChA.Xsmppos:	ld	a,0
 9867 B9FC FE 01        		cp	1
 9868 B9FE 28 03        		jr	z,env.shape
 9869 BA00 32 98 BA     		ld	(ChA.smppos+1),a
 9870 BA03 3E 00        env.shape:	ld	a,0
 9871 BA05 32 E7 BB     		ld	(AYREG_EnvSh+1),a
 9872 BA08 3E 00        env.period:	ld	a,0
 9873 BA0A 32 F5 BB     		ld	(AYREG_Env+1),a
 9874 BA0D AF           		xor	a
 9875 BA0E 32 04 BA     		ld	(env.shape+1),a
 9876 BA11 32 7C BA     ChA.Xinst2:	ld	(ChA.ornpos+1),a
 9877 BA14 32 EE BA     ChB.Xinst2:	ld	(ChB.ornpos+1),a
 9878 BA17 3C           		inc	a
 9879 BA18 32 FB B9     		ld	(ChA.Xsmppos+1),a
 9880 BA1B 32 11 BA     		ld	(ChA.Xinst2),a
 9881 BA1E 32 B7 B9     		ld	(ChB.Xsmppos+1),a
 9882 BA21 32 14 BA     		ld	(ChB.Xinst2),a
 9883 BA24 32 CE B9     		ld	(ChA.Xinst1),a
 9884 BA27 32 8A B9     		ld	(ChB.Xinst1),a
 9885 BA2A
 9886 BA2A              ; ---------------------------------------------------------------------------
 9887 BA2A 3E 00        chkfadeout:	ld	a,0
 9888 BA2C B7           		or	a
 9889 BA2D 28 4C        		jr	z,ChA.ornpos
 9890 BA2F 3A 3E A2     		ld	a,(music_setup)
 9891 BA32 07           		rlca
 9892 BA33 DA D6 BB     		jp	c,retsp
 9893 BA36 3E 00        countfadeout:	ld	a,0
 9894 BA38 3D           		dec	a
 9895 BA39 32 37 BA     		ld	(countfadeout+1),a
 9896 BA3C 20 3D        		jr	nz,ChA.ornpos
 9897 BA3E 1E 10        		ld	e,16
 9898 BA40 3E 00        apply_volume:	ld	a,0
 9899 BA42 3C           		inc	a
 9900 BA43 BB           		cp	e
 9901 BA44 CA 23 B6     		jp	z,resetfadeout
 9902 BA47 32 41 BA     		ld	(apply_volume+1),a
 9903 BA4A 32 C2 BA     		ld	(ChA.attn+1),a
 9904 BA4D 32 34 BB     		ld	(ChB.attn+1),a
 9905 BA50 32 A9 BB     		ld	(ChC.attn+1),a
 9906 BA53 CB 5F        		bit	3,a			; if value of attenuation
 9907 BA55 28 12        		jr	z,divfadeout		; hits the 8 we turn off
 9908 BA57 AF           		xor	a			; also hw envelopes
 9909 BA58 32 04 BA     		ld	(env.shape+1),a
 9910 BA5B 32 E7 BB     		ld	(AYREG_EnvSh+1),a
 9911 BA5E 7B           		ld	a,e
 9912 BA5F 3D           		dec	a
 9913 BA60 32 C8 BA     		ld	(ChA.ampl+1),a
 9914 BA63 32 3A BB     		ld	(ChB.ampl+1),a
 9915 BA66 32 AF BB     		ld	(ChC.ampl+1),a
 9916 BA69 3E 00        divfadeout:	ld	a,0
 9917 BA6B CB 3F        		srl	a
 9918 BA6D 5F           		ld	e,a
 9919 BA6E CB 3B        		srl	e
 9920 BA70 83           		add	a,e
 9921 BA71 20 01        		jr	nz,divfadeout1
 9922 BA73 3C           		inc	a
 9923 BA74 32 6A BA     divfadeout1:	ld	(divfadeout+1),a
 9924 BA77 87           		add	a,a
 9925 BA78 32 37 BA     		ld	(countfadeout+1),a
 9926 BA7B
 9927 BA7B 11 00 00     ChA.ornpos:	ld	de,0
 9928 BA7E 21 00 00     ChA.ornptr:	ld	hl,NULL
 9929 BA81 19           		add	hl,de
 9930 BA82 1C           		inc	e
 9931 BA83 7B           		ld	a,e
 9932 BA84 FE 00        ChA.ornlen:	cp	0
 9933 BA86 20 02        		jr	nz,ChA.readorn
 9934 BA88 3E 00        ChA.ornloop:	ld	a,0
 9935 BA8A 32 7C BA     ChA.readorn:	ld	(ChA.ornpos+1),a
 9936 BA8D 3E 00        ChA.note:	ld	a,0
 9937 BA8F 86           		add	a,(hl)
 9938 BA90 87           		add	a,a
 9939 BA91 5F           		ld	e,a
 9940 BA92 21 51 BC     		ld	hl,freqtable
 9941 BA95 19           		add	hl,de
 9942 BA96 F9           		ld	sp,hl
 9943 BA97 3E 00        ChA.smppos:	ld	a,0
 9944 BA99 21 00 00     ChA.smpptr:	ld	hl,NULL
 9945 BA9C 3C           		inc	a
 9946 BA9D FA 4F B9     		jp	m,ChA.mute
 9947 BAA0 5F           		ld	e,a
 9948 BAA1 19           		add	hl,de
 9949 BAA2 C6 03        		add	a,3
 9950 BAA4 FE 00        ChA.smplen:	cp	0
 9951 BAA6 20 02        		jr	nz,ChA.readsmp
 9952 BAA8 3E 00        ChA.smploop:	ld	a,0
 9953 BAAA 32 98 BA     ChA.readsmp:	ld	(ChA.smppos+1),a
 9954 BAAD C1           		pop	bc
 9955 BAAE F9           		ld	sp,hl
 9956 BAAF D1           		pop	de
 9957 BAB0 26 00        		ld	h,0
 9958 BAB2 7B           		ld	a,e
 9959 BAB3 E6 0F        		and	#0F
 9960 BAB5 D6 00        ChA.volume:	sub	0
 9961 BAB7 6F           		ld	l,a
 9962 BAB8 3F           		ccf
 9963 BAB9 9F           		sbc	a,a
 9964 BABA A5           		and	l
 9965 BABB CB 3A        		srl	d
 9966 BABD 30 02        		jr	nc,ChA.attn
 9967 BABF CB E4        		set	4,h
 9968 BAC1 D6 00        ChA.attn:	sub	0
 9969 BAC3 30 01        		jr	nc,ChA.attnn
 9970 BAC5 AF           		xor	a
 9971 BAC6 B4           ChA.attnn:	or	h
 9972 BAC7 E6 00        ChA.ampl:	and	0
 9973 BAC9 32 1F BD     		ld	(AYREG_AmplA),a
 9974 BACC 7B           		ld	a,e
 9975 BACD 07           		rlca
 9976 BACE 38 02        		jr	c,ChA.pitch
 9977 BAD0 DD 62        		ld	xh,d
 9978 BAD2 21 00 00     ChA.pitch:	ld	hl,NULL
 9979 BAD5 11 00 00     ChA.portamnt:	ld	de,0
 9980 BAD8 19           		add	hl,de
 9981 BAD9 22 D3 BA     		ld	(ChA.pitch+1),hl
 9982 BADC 09           		add	hl,bc
 9983 BADD C1           		pop	bc
 9984 BADE 09           		add	hl,bc
 9985 BADF 07           		rlca
 9986 BAE0 07           		rlca
 9987 BAE1 07           		rlca
 9988 BAE2 E6 0F        		and	#0F
 9989 BAE4 DD 6F        		ld	xl,a
 9990 BAE6 7C           		ld	a,h
 9991 BAE7 E6 0F        		and	#0F
 9992 BAE9 67           		ld	h,a
 9993 BAEA 22 19 BD     		ld	(AYREG_TonA),hl
 9994 BAED
 9995 BAED 11 00 00     ChB.ornpos:	ld	de,0
 9996 BAF0 21 00 00     ChB.ornptr:	ld	hl,NULL
 9997 BAF3 19           		add	hl,de
 9998 BAF4 1C           		inc	e
 9999 BAF5 7B           		ld	a,e
10000 BAF6 FE 00        ChB.ornlen:	cp	0
10001 BAF8 20 02        		jr	nz,ChB.readorn
10002 BAFA 3E 00        ChB.ornloop:	ld	a,0
10003 BAFC 32 EE BA     ChB.readorn:	ld	(ChB.ornpos+1),a
10004 BAFF 3E 00        ChB.note:	ld	a,0
10005 BB01 86           		add	a,(hl)
10006 BB02 87           		add	a,a
10007 BB03 5F           		ld	e,a
10008 BB04 21 51 BC     		ld	hl,freqtable
10009 BB07 19           		add	hl,de
10010 BB08 F9           		ld	sp,hl
10011 BB09 3E 00        ChB.smppos:	ld	a,NULL
10012 BB0B 21 00 00     ChB.smpptr:	ld	hl,NULL
10013 BB0E 3C           		inc	a
10014 BB0F FA 59 B9     		jp	m,ChB.mute
10015 BB12 5F           		ld	e,a
10016 BB13 19           		add	hl,de
10017 BB14 C6 03        		add	a,3
10018 BB16 FE 00        ChB.smplen:	cp	0
10019 BB18 20 02        		jr	nz,ChB.readsmp
10020 BB1A 3E 00        ChB.smploop:	ld	a,0
10021 BB1C 32 0A BB     ChB.readsmp:	ld	(ChB.smppos+1),a
10022 BB1F C1           		pop	bc
10023 BB20 F9           		ld	sp,hl
10024 BB21 D1           		pop	de
10025 BB22 26 00        		ld	h,0
10026 BB24 7B           		ld	a,e
10027 BB25 E6 0F        		and	#0F
10028 BB27 D6 00        ChB.volume:	sub	0
10029 BB29 6F           		ld	l,a
10030 BB2A 3F           		ccf
10031 BB2B 9F           		sbc	a,a
10032 BB2C A5           		and	l
10033 BB2D CB 3A        		srl	d
10034 BB2F 30 02        		jr	nc,ChB.attn
10035 BB31 CB E4        		set	4,h
10036 BB33 D6 00        ChB.attn:	sub	0
10037 BB35 30 01        		jr	nc,ChB.attnn
10038 BB37 AF           		xor	a
10039 BB38 B4           ChB.attnn:	or	h
10040 BB39 E6 00        ChB.ampl:	and	0
10041 BB3B 32 20 BD     		ld	(AYREG_AmplB),a
10042 BB3E 7B           		ld	a,e
10043 BB3F 0F           		rrca
10044 BB40 0F           		rrca
10045 BB41 0F           		rrca
10046 BB42 E6 1E        		and	#1E
10047 BB44 DD B5        		or	xl
10048 BB46 DD 6F        		ld	xl,a
10049 BB48 E6 10        		and	#10
10050 BB4A 20 02        		jr	nz,ChB.pitch
10051 BB4C DD 62        		ld	xh,d
10052 BB4E 21 00 00     ChB.pitch:	ld	hl,NULL
10053 BB51 11 00 00     ChB.portamnt:	ld	de,0
10054 BB54 19           		add	hl,de
10055 BB55 22 4F BB     		ld	(ChB.pitch+1),hl
10056 BB58 09           		add	hl,bc
10057 BB59 C1           		pop	bc
10058 BB5A 09           		add	hl,bc
10059 BB5B 7C           		ld	a,h
10060 BB5C E6 0F        		and	#0F
10061 BB5E 67           		ld	h,a
10062 BB5F 22 1B BD     		ld	(AYREG_TonB),hl
10063 BB62
10064 BB62 11 00 00     ChC.ornpos:	ld	de,0
10065 BB65 21 00 00     ChC.ornptr:	ld	hl,NULL
10066 BB68 19           		add	hl,de
10067 BB69 1C           		inc	e
10068 BB6A 7B           		ld	a,e
10069 BB6B FE 00        ChC.ornlen:	cp	0
10070 BB6D 20 02        		jr	nz,ChC.readorn
10071 BB6F 3E 00        ChC.ornloop:	ld	a,0
10072 BB71 32 63 BB     ChC.readorn:	ld	(ChC.ornpos+1),a
10073 BB74 3E 00        ChC.note:	ld	a,0
10074 BB76 86           		add	a,(hl)
10075 BB77 87           		add	a,a
10076 BB78 5F           		ld	e,a
10077 BB79 21 51 BC     		ld	hl,freqtable
10078 BB7C 19           		add	hl,de
10079 BB7D F9           		ld	sp,hl
10080 BB7E 3E 00        ChC.smppos:	ld	a,0
10081 BB80 21 00 00     ChC.smpptr:	ld	hl,NULL
10082 BB83 3C           		inc	a
10083 BB84 FA 66 B9     		jp	m,ChC.mute
10084 BB87 5F           		ld	e,a
10085 BB88 19           		add	hl,de
10086 BB89 C6 03        		add	a,3
10087 BB8B FE 00        ChC.smplen:	cp	0
10088 BB8D 20 02        		jr	nz,ChC.readsmp
10089 BB8F 3E 00        ChC.smploop:	ld	a,0
10090 BB91 32 7F BB     ChC.readsmp:	ld	(ChC.smppos+1),a
10091 BB94 C1           		pop	bc
10092 BB95 F9           		ld	sp,hl
10093 BB96 D1           		pop	de
10094 BB97 26 00        		ld	h,0
10095 BB99 7B           		ld	a,e
10096 BB9A E6 0F        		and	#0F
10097 BB9C D6 00        ChC.volume:	sub	0
10098 BB9E 6F           		ld	l,a
10099 BB9F 3F           		ccf
10100 BBA0 9F           		sbc	a,a
10101 BBA1 A5           		and	l
10102 BBA2 CB 3A        		srl	d
10103 BBA4 30 02        		jr	nc,ChC.attn
10104 BBA6 CB E4        		set	4,h
10105 BBA8 D6 00        ChC.attn:	sub	0
10106 BBAA 30 01        		jr	nc,ChC.attnn
10107 BBAC AF           		xor	a
10108 BBAD B4           ChC.attnn:	or	h
10109 BBAE E6 00        ChC.ampl:	and	0
10110 BBB0 32 21 BD     		ld	(AYREG_AmplC),a
10111 BBB3 7B           		ld	a,e
10112 BBB4 0F           		rrca
10113 BBB5 0F           		rrca
10114 BBB6 E6 3C        		and	#3C
10115 BBB8 DD B5        		or	xl
10116 BBBA DD 6F        		ld	xl,a
10117 BBBC E6 20        		and	#20
10118 BBBE 20 02        		jr	nz,ChC.pitch
10119 BBC0 DD 62        		ld	xh,d
10120 BBC2 21 00 00     ChC.pitch:	ld	hl,NULL
10121 BBC5 11 00 00     ChC.portamnt:	ld	de,0
10122 BBC8 19           		add	hl,de
10123 BBC9 22 C3 BB     		ld	(ChC.pitch+1),hl
10124 BBCC 09           		add	hl,bc
10125 BBCD C1           		pop	bc
10126 BBCE 09           		add	hl,bc
10127 BBCF 7C           		ld	a,h
10128 BBD0 E6 0F        		and	#0F
10129 BBD2 67           		ld	h,a
10130 BBD3 22 1D BD     		ld	(AYREG_TonC),hl
10131 BBD6 31 00 00     @retsp:		ld	sp,0
10132 BBD9
10133 BBD9 21 21 BD     outay:		ld	hl,AYREG_AmplC
10134 BBDC 11 BF FF     		ld	de,#FFBF
10135 BBDF 01 FD FF     		ld	bc,#FFFD
10136 BBE2 3E 0D        		ld	a,#0D
10137 BBE4 ED 79        		out	(c),a
10138 BBE6 3E 00        AYREG_EnvSh:	ld	a,0
10139 BBE8 B7           		or	a
10140 BBE9 28 0E        		jr	z,noenvelopes
10141 BBEB 43           		ld	b,e
10142 BBEC ED 79        		out	(c),a
10143 BBEE
10144 BBEE 3E 0B        		ld	a,#0B
10145 BBF0 42           		ld	b,d
10146 BBF1 ED 79        		out	(c),a
10147 BBF3 43           		ld	b,e
10148 BBF4 3E 00        AYREG_Env:	ld	a,0
10149 BBF6 ED 79        		out	(c),a
10150 BBF8 42           		ld	b,d
10151 BBF9
10152 BBF9 3E 0A        noenvelopes:	ld	a,#0A
10153 BBFB ED 79        		out	(c),a
10154 BBFD 43           		ld	b,e
10155 BBFE ED AB        		outd
10156 BC00 3D           		dec	a
10157 BC01 42           		ld	b,d
10158 BC02 ED 79        		out	(c),a
10159 BC04 43           		ld	b,e
10160 BC05 ED AB        		outd
10161 BC07 3D           		dec	a
10162 BC08 42           		ld	b,d
10163 BC09 ED 79        		out	(c),a
10164 BC0B 43           		ld	b,e
10165 BC0C ED AB        		outd
10166 BC0E 3D           		dec	a
10167 BC0F 42           		ld	b,d
10168 BC10 ED 79        		out	(c),a
10169 BC12 43           		ld	b,e
10170 BC13 DD 7D        		ld	a,xl
10171 BC15 ED 79        		out	(c),a
10172 BC17 3E 06        		ld	a,6
10173 BC19 42           		ld	b,d
10174 BC1A ED 79        		out	(c),a
10175 BC1C 43           		ld	b,e
10176 BC1D DD 7C        		ld	a,xh
10177 BC1F ED 79        		out	(c),a
10178 BC21 3E 05        		ld	a,5
10179 BC23 42           		ld	b,d
10180 BC24 ED 79        		out	(c),a
10181 BC26 43           		ld	b,e
10182 BC27 ED AB        		outd
10183 BC29 3D           		dec	a
10184 BC2A 42           		ld	b,d
10185 BC2B ED 79        		out	(c),a
10186 BC2D 43           		ld	b,e
10187 BC2E ED AB        		outd
10188 BC30 3D           		dec	a
10189 BC31 42           		ld	b,d
10190 BC32 ED 79        		out	(c),a
10191 BC34 43           		ld	b,e
10192 BC35 ED AB        		outd
10193 BC37 3D           		dec	a
10194 BC38 42           		ld	b,d
10195 BC39 ED 79        		out	(c),a
10196 BC3B 43           		ld	b,e
10197 BC3C ED AB        		outd
10198 BC3E 3D           		dec	a
10199 BC3F 42           		ld	b,d
10200 BC40 ED 79        		out	(c),a
10201 BC42 43           		ld	b,e
10202 BC43 ED AB        		outd
10203 BC45 3D           		dec	a
10204 BC46 42           		ld	b,d
10205 BC47 ED 79        		out	(c),a
10206 BC49 43           		ld	b,e
10207 BC4A ED AB        		outd
10208 BC4C 32 E7 BB     		ld	(AYREG_EnvSh+1),a
10209 BC4F FB           		ei
10210 BC50 C9           		ret
10211 BC51
10212 BC51              ;------------------------------------------------------------------------------
10213 BC51 F8 0E 10 0E  freqtable	dw	#0EF8, #0E10, #0D60, #0C80, #0BD8, #0B28, #0A88, #09F0
10213 BC55 60 0D 80 0C
10213 BC59 D8 0B 28 0B
10213 BC5D 88 0A F0 09
10214 BC61 60 09 E0 08  		dw	#0960, #08E0, #0858, #07E0, #077C, #0708, #06B0, #0640
10214 BC65 58 08 E0 07
10214 BC69 7C 07 08 07
10214 BC6D B0 06 40 06
10215 BC71 EC 05 94 05  		dw	#05EC, #0594, #0544, #04F8, #04B0, #0470, #042C, #03F0
10215 BC75 44 05 F8 04
10215 BC79 B0 04 70 04
10215 BC7D 2C 04 F0 03
10216 BC81 BE 03 84 03  		dw	#03BE, #0384, #0358, #0320, #02F6, #02CA, #02A2, #027C
10216 BC85 58 03 20 03
10216 BC89 F6 02 CA 02
10216 BC8D A2 02 7C 02
10217 BC91 58 02 38 02  		dw	#0258, #0238, #0216, #01F8, #01DF, #01C2, #01AC, #0190
10217 BC95 16 02 F8 01
10217 BC99 DF 01 C2 01
10217 BC9D AC 01 90 01
10218 BCA1 7B 01 65 01  		dw	#017B, #0165, #0151, #013E, #012C, #011C, #010B, #00FC
10218 BCA5 51 01 3E 01
10218 BCA9 2C 01 1C 01
10218 BCAD 0B 01 FC 00
10219 BCB1 EF 00 E1 00  		dw	#00EF, #00E1, #00D6, #00C8, #00BD, #00B2, #00A8, #009F
10219 BCB5 D6 00 C8 00
10219 BCB9 BD 00 B2 00
10219 BCBD A8 00 9F 00
10220 BCC1 96 00 8E 00  		dw	#0096, #008E, #0085, #007E, #0077, #0070, #006B, #0064
10220 BCC5 85 00 7E 00
10220 BCC9 77 00 70 00
10220 BCCD 6B 00 64 00
10221 BCD1 5E 00 59 00  		dw	#005E, #0059, #0054, #004F, #004B, #0047, #0042, #003F
10221 BCD5 54 00 4F 00
10221 BCD9 4B 00 47 00
10221 BCDD 42 00 3F 00
10222 BCE1 3B 00 38 00  		dw	#003B, #0038, #0035, #0032, #002F, #002C, #002A, #0027
10222 BCE5 35 00 32 00
10222 BCE9 2F 00 2C 00
10222 BCED 2A 00 27 00
10223 BCF1 25 00 23 00  		dw	#0025, #0023, #0021, #001F, #001D, #001C, #001A, #0019
10223 BCF5 21 00 1F 00
10223 BCF9 1D 00 1C 00
10223 BCFD 1A 00 19 00
10224 BD01 17 00 16 00  		dw	#0017, #0016, #0015, #0013, #0012, #0011, #0010, #000F
10224 BD05 15 00 13 00
10224 BD09 12 00 11 00
10224 BD0D 10 00 0F 00
10225 BD11
10226 BD11 00 00 00     empty_orn:	db	#00, #00, #00
10227 BD14 70 80 F1 D0  empty_pattern:	db	#70, #80, #F1, #D0, #00
10227 BD18 00
10228 BD19
10229 BD19 00 00        AYREG_TonA:	dw	0
10230 BD1B 00 00        AYREG_TonB:	dw	0
10231 BD1D 00 00        AYREG_TonC:	dw	0
10232 BD1F 00           AYREG_AmplA:	db	0
10233 BD20 00           AYREG_AmplB:	db	0
10234 BD21 00           AYREG_AmplC:	db	0
10235 BD22 00           tempocnt_2:	db	0
10236 BD23 00           tempocnt_1:	db	0
10237 BD24 00           tempocnt_0:	db	0
10238 BD25 00           pattstep_cnt:	db	0
10239 BD26
10240 BD26              ;-----------------------------------------------------------------------------
10241 BD26
10242 BD26              			endmodule
10243 BD26
10244 BD26
10245 BD26              songdata
10246 BD26              MDLADDR
10247 BD26              modstart
10248 BD26 00 00        BUFFER:			ds	2		; dlzka songu
10249 BD28              RELOC_BASE:
10250 BD28 00 00        I_SAMPLES:		ds	2		; adresa lookup tabulky samplov
10251 BD2A 00 00        I_ORNAMENTS:	ds	2		; adresa lookup tabulky ornamentov
10252 BD2C 00 00        I_PATTERNS:		ds	2		; adresa lookup tabulky patternov
10253 BD2E 00 00        I_POSITIONS:	ds	2		; adresa definicii pozicii
10254 BD30 00 00        I_REPEAT:		ds	2		; ukazovatel na repeat poziciu
10255 BD32 00 00        RELOC_ENDPTR:	ds	2		; tu je uz ukazovat na prvy sampel
10256 BD34 00 00 00...  LFNNAME ds 262
10257 BE3A              screen 			incbin	logo.bin
10258 C63A
10259 C63A
10260 C63A 00 00 00...  esxError        ds      34
10261 C65C              			  CSPECTMAP player.map
10262 C65C
10263 C65C                            savenex open "NextPlayer.nex",demo,24575
10264 C65C
10265 C65C                            savenex core 2,0,0
10266 C65C                            ;SAVENEX SCREEN BMP "screen2.bmp"
10267 C65C              			  savenex auto
10268 C65C                            savenex close
10269 C65C
# file closed: NextPlayer.asm
